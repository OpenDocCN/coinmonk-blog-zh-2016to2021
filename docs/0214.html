<html>
<head>
<title>Optimizing your Solidity contract’s gas usage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化您的固体合同的天然气使用</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/optimizing-your-solidity-contracts-gas-usage-9d65334db6c7?source=collection_archive---------0-----------------------#2018-04-05">https://medium.com/coinmonks/optimizing-your-solidity-contracts-gas-usage-9d65334db6c7?source=collection_archive---------0-----------------------#2018-04-05</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="fe ff iq"><img src="../Images/5ba8c57a6ac656605c24974d87504d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*Xf80vW2fN74fk63v-qC4lg.png"/></div></figure><p id="d52b" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">以太坊社区的人都知道，<em class="jv">气</em>是智能合约执行的必要之恶。如果指定得太少，您的事务可能无法及时得到处理，或者在处理智能合约操作的过程中死亡。也就是说，一个聪明的合同不应该对用户委托给他们的有价值的资源贪得无厌。正是出于这个原因，我们将研究调整和优化我们的合同，以尽量减少所需的天然气量。</p><blockquote class="jw"><p id="fe46" class="jx jy ht bd jz ka kb kc kd ke kf ju ek translated"><a class="ae kg" href="https://coincodecap.com/category/blockchain-node-and-api" rel="noopener ugc nofollow" target="_blank">发现并评估最佳区块链api和节点产品</a></p></blockquote><h2 id="cdb0" class="kh ki ht bd kj kk kl km kn ko kp kq kr ji ks kt ku jm kv kw kx jq ky kz la lb dt translated">作为用户使用气体</h2><p id="6674" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">在以太坊中指定气体量时，需要考虑两个因素。第一个是<strong class="iz hu">汽油限量</strong>或<strong class="iz hu"> </strong>放入你的智能合约油箱的总<em class="jv">加仑</em>汽油。请注意，这个数量实际上只影响智能合约执行本身，并且必须足以满足智能合约所需的所有资源。否则，你会得到一个<em class="jv"> Out of Gas </em>异常。像<em class="jv"> MetaMask </em>这样的工具会尝试对这个值做出最好的猜测，并且在一个不拥挤的以太网上或多或少是正确的。关键的一点是，任何未使用的气体将返回给你。</p><p id="b333" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu">即</strong>。你设置了30万的汽油限额，交易只需要20万——30万不会向你收费。汽油限额是你愿意花多少钱，而不是T21有多少钱。</p><p id="35cc" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">用于发送交易的与气体消耗相关的第二个参数是<strong class="iz hu">气体价格</strong>。该金额通常用<strong class="iz hu">gwei</strong>(<strong class="iz hu">Wei</strong>)表示，并且不影响交易的执行或智能合约交互，而是影响交易被添加到块的速度。用汽车的燃料来类比，这个价格就是你支付的燃料价格。如果您支付更高的汽油价格，您的交易将更快地添加到区块中，从而加快交易的处理速度。用今天的术语来说，20 gwei是一个平均支付价格，意味着你的交易将会很快得到处理。50 gwei的价格将使您几乎立即处理，而5 gwei的价格将需要几分钟。根据你要写的dApp的类型，汽油价格是一个强大的特性。像<a class="ae kg" href="https://ethgasstation.info" rel="noopener ugc nofollow" target="_blank">https://eth gastation . info</a>这样的地方可以帮助你了解当前的网络负载以及相应的与气价相关的等待时间。</p><figure class="li lj lk ll fq iu fe ff paragraph-image"><div class="fe ff lh"><img src="../Images/059ebf569c19db238cf2afa832680e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*mMPi7_yi-H3wbQ-3pm28_g.png"/></div><figcaption class="lm ln fg fe ff lo lp bd b be z ek"><strong class="bd lq">MetaMask Transaction(See Gas Limit and Gas Price)</strong></figcaption></figure></div><div class="ab cl lr ls hb lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hm hn ho hp hq"><h2 id="b209" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated">作为开发人员使用气体</h2><p id="6ce1" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">作为开发商，你根本不担心<strong class="iz hu">天然气价格</strong>，但你希望你的智能合同<strong class="iz hu">天然气限制</strong>落在你特定dApp的合理成本基础内。例如，如果您正在创建一个智能合同来处理价值100万美元的eth的托管，您可能不关心5美元的汽油限额。然而，如果你在做一个每篇帖子5美元的社交平台，你会很快让你的用户破产。您需要设计您的智能合约来适应您的使用案例，因为现在以太坊的处理能力和存储非常昂贵。</p><p id="ad9f" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">在区块链上发送和执行以太坊交易有两个主要的相关成本。</p><ul class=""><li id="6c6b" class="md me ht iz b ja jb je jf ji mf jm mg jq mh ju mi mj mk ml dt translated">执行成本</li><li id="944c" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">交易成本</li></ul><p id="48a9" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu">注:</strong>由于<em class="jv">执行成本</em>包含在<em class="jv">交易成本中，因此</em>在大多数情况下，当提到交易的gas限额时，我们指的是<em class="jv">交易成本</em>。</p><p id="cc08" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu">执行成本</strong>主要与全局变量的存储以及用于计算和局部变量操作的处理能力有关。所以，一个简单的总结将是，<em class="jv">所有与合同的内部存储和操纵相关的成本。</em></p><p id="e9ac" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu">交易成本</strong>包括前面所说的<strong class="iz hu">执行成本</strong>和向区块链发送数据的成本。这些变量包括:</p><ul class=""><li id="eeb8" class="md me ht iz b ja jb je jf ji mf jm mg jq mh ju mi mj mk ml dt translated">基本交易成本(普通)~21，000英镑</li><li id="7a39" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">合同部署(第一次)~32，000</li><li id="7367" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">0字节输入的交易输入成本(通用)～4，非0字节输入的交易输入成本为64</li><li id="69db" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">合同发起的交易每笔花费约32，000英镑</li></ul><p id="aeec" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">所有这些因素都会导致你的油费快速增加。以下是开发或调整合同时的一些主要考虑事项:</p><h2 id="fefb" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated">合同规模</h2><p id="68ab" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">您的合同的总规模将在所有与之互动的tx成本中发挥作用。如果你能够将合同分解成更小的独立合同，这将减少用户互动时的燃气成本。例如，如果你有一个支持汽车和摩托车租赁的dApp好的设计会建议你签订一个单独的合同并共享公共部分。然而，如果摩托车市场不景气，没有人租用摩托车，汽车租赁用户为未使用代码的合同膨胀付费是没有意义的。将合同分别分解为汽车和摩托车合同可能是有意义的。</p><h2 id="8d4f" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated">全局变量(存储)</h2><p id="9809" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">全局变量存储或持久化在区块链的契约状态中。就交易的天然气而言，这可能是最昂贵的操作。因此，为存储的全局变量使用最小的内存是非常必要的。这在所有语言中都是一个很好的编程实践，但在像以太坊区块链这样的受限环境中尤其重要。这种情况的一个例子是使用昂贵的type <em class="jv"> string </em>当你可以使用一个uint来表示一些东西的时候。</p><pre class="li lj lk ll fq mr ms mt mu aw mv dt"><span id="7e05" class="kh ki ht ms b fv mw mx l my mz">string STATUS = ‘unknown status’; //This is really expensive<br/>uint STATUS = 0; //This is a lot cheaper</span></pre><p id="7429" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">注意:重要的是要认识到一个uint == uint256。此外，不管出于什么原因，uint256比uint8需要更少的气体来储存。因此，如果您试图优化您应该优化的数据类型，只需认识到这一点。</p><p id="8638" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">尽可能多地移除结构中的重复。如果结构中有存储相同值的成员变量，则在不牺牲安全性的情况下，尽可能移除重复的成员变量。</p><pre class="li lj lk ll fq mr ms mt mu aw mv dt"><span id="aaae" class="kh ki ht ms b fv mw mx l my mz">struct Game {<br/> uint256 betAmount;<br/> uint outcome;<br/> uint status;<br/> JediBet originator;<br/> JediBet taker;<br/> }<br/> <br/> JediBet orig; // There is no reason to have these global vars<br/> JediBet take; // when they are already in the Game struct</span></pre></div><div class="ab cl lr ls hb lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hm hn ho hp hq"><h2 id="5039" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated">调整合同</h2><p id="6aa5" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">我们现在来看看我们在<a class="ae kg" href="https://remix.ethereum.org" rel="noopener ugc nofollow" target="_blank">混音</a>中的<a class="ae kg" href="https://github.com/cipherzzz/JediBetDapp/blob/cebf2937c33831814deaa3d4571b435416a6b14d/contracts/Bet.sol" rel="noopener ugc nofollow" target="_blank"> Bet.sol合约</a>。在你的浏览器中打开Remix，创建一个新的合同，然后从这里粘贴代码<a class="ae kg" href="https://github.com/cipherzzz/JediBetDapp/blob/cebf2937c33831814deaa3d4571b435416a6b14d/contracts/Bet.sol" rel="noopener ugc nofollow" target="_blank"/>。将光标放在第142行——在<em class="jv"> generateBetOutcome </em>方法处，并查看编辑器的右上角。你会看到一个气泵图标和一个估计的气体，如下所示。</p><figure class="li lj lk ll fq iu fe ff paragraph-image"><div class="fe ff na"><img src="../Images/4dd7589a1aa01a4c1d70a001e7d9374f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*utN0krBvSHD_-iWs4OxyiQ.png"/></div><figcaption class="lm ln fg fe ff lo lp bd b be z ek">How to check estimated execution gas cost for a method</figcaption></figure><p id="5c8a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">这个工具对于快速查看方法调用的估计gas非常有用，但它只是一个估计。对于像这样的私有方法，您无法调用它，也无法从调试日志中查看gas的使用情况。</p><p id="91c8" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">如果您想查看执行成本的更接近的估计，您可以将其公开，并直接从remix调用它。请注意，这与Remix IDE的估计成本相差甚远，但根据合同执行时的状态，这可能会有所不同。</p><figure class="li lj lk ll fq iu fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/2c2025dd91cd3b3ee705db46e68e11a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*dXo3jTguQGqiI1Vvd756eg.png"/></div></figure><p id="2d53" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">以下是Solidity的一些运营成本，供您在调整合同时参考。</p><pre class="li lj lk ll fq mr ms mt mu aw mv dt"><span id="ea08" class="kh ki ht ms b fv mw mx l my mz">Operation         Gas           Description<br/><br/>ADD/SUB           3             Arithmetic operation<br/>MUL/DIV           5             Arithmetic operation<br/>ADDMOD/MULMOD     8             Arithmetic operation<br/>AND/OR/XOR        3             Bitwise logic operation<br/>LT/GT/SLT/SGT/EQ  3             Comparison operation<br/>POP               2             Stack operation <br/>PUSH/DUP/SWAP     3             Stack operation<br/>MLOAD/MSTORE      3             Memory operation<br/>JUMP              8             Unconditional jump<br/>JUMPI             10            Conditional jump<br/>SLOAD             200           Storage operation<br/>SSTORE            5,000/20,000  Storage operation<br/>BALANCE           400           Get balance of an account<br/>CREATE            32,000        Create a new account using CREATE<br/>CALL              25,000        Create a new account using CALL</span></pre></div><div class="ab cl lr ls hb lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hm hn ho hp hq"><h2 id="7236" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated">摘要</h2><p id="8156" class="pw-post-body-paragraph ix iy ht iz b ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq lg js jt ju hm dt translated">调整契约不是一门精确的科学，但它是安全性、良好的编码实践和成本之间的平衡。针对性能和安全性优化代码对于大多数开发人员来说是一个新概念，不这样做的破坏性影响现在才被理解。希望这篇文章在理解和优化天然气<strong class="iz hu">执行</strong>和<strong class="iz hu">交易</strong>成本方面对你有所帮助。</p><h2 id="531c" class="kh ki ht bd kj kk ly km kn ko lz kq kr ji ma kt ku jm mb kw kx jq mc kz la lb dt translated"><strong class="ak">还有，读</strong></h2><ul class=""><li id="f48c" class="md me ht iz b ja lc je ld ji nc jm nd jq ne ju mi mj mk ml dt translated"><a class="ae kg" rel="noopener" href="/coinmonks/defi-future-10-promising-projects-in-the-defi-world-ff2b697ab006">顶级DeFi项目</a></li><li id="0bc7" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated"><a class="ae kg" rel="noopener" href="/coinmonks/whats-the-best-crypto-trading-bot-in-2020-top-8-bitcoin-trading-bot-c16adeb13317">最佳加密交易机器人</a></li><li id="51e2" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">最好的比特币<a class="ae kg" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069?source=friends_link&amp;sk=324dd9ff8556ab578d71e7ad7658ad7c">硬件钱包</a></li><li id="69bb" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">最好的<a class="ae kg" rel="noopener" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b">加密税务软件</a></li><li id="7c4f" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated"><a class="ae kg" rel="noopener" href="/coinmonks/the-best-crypto-trading-platforms-in-2020-the-definitive-guide-updated-c72f8b874555">最佳加密交易平台</a></li><li id="3524" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated"><a class="ae kg" rel="noopener" href="/coinmonks/best-wallets-to-use-uniswap-e91a6385d9e8">unis WAP最佳钱包</a></li><li id="a1cf" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated"><a class="ae kg" href="https://blog.coincodecap.com/bitsgap-review" rel="noopener ugc nofollow" target="_blank">bits gap review</a>——一个轻松赚钱的加密交易机器人</li><li id="2401" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">为专业人士设计的加密交易机器人</li><li id="eb27" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">Bitmex的<a class="ae kg" rel="noopener" href="/coinmonks/the-idiots-guide-to-margin-trading-on-bitmex-dbbd7742c6fc?source=friends_link&amp;sk=7bfa99d2a181142510c8442c8ddb0786">保证金交易指南</a></li><li id="aaab" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">加密摇摆交易的权威指南</li><li id="cfc6" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated"><a class="ae kg" rel="noopener" href="/coinmonks/bitmex-advanced-margin-trading-guide-2270c195ce25?source=friends_link&amp;sk=1d986cca731f5084b9a2db4a4bc4a7ad"> Bitmex高级保证金交易指南</a></li><li id="6e2e" class="md me ht iz b ja mm je mn ji mo jm mp jq mq ju mi mj mk ml dt translated">开发人员的最佳加密API</li></ul><blockquote class="jw"><p id="b751" class="jx jy ht bd jz ka nf ng nh ni nj ju ek translated"><a class="ae kg" href="https://coincodecap.com?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nl nm nn no np iu fe ff paragraph-image"><a href="https://coincodecap.com?utm_source=coinmonks"><div class="fe ff nk"><img src="../Images/160ce73bd06d46c2250251e7d5969f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*BoDnKUyK8p4hitHAJZ5Pdw.png"/></div></a></figure></div></div>    
</body>
</html>