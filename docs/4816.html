<html>
<head>
<title>Uniswap V3 Explained — Concentrated Liquidity, Impermanent Loss, Slippage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap V3解释-集中流动性，非永久性损失，滑脱</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/uniswap-v3-explained-concentrated-liquidity-impermanent-loss-slippage-529cf16c3509?source=collection_archive---------1-----------------------#2021-06-21">https://medium.com/coinmonks/uniswap-v3-explained-concentrated-liquidity-impermanent-loss-slippage-529cf16c3509?source=collection_archive---------1-----------------------#2021-06-21</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/03269fcef0840587e04fbd8b095371b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7a-_bRUIBNdPk9TxPEJvw.png"/></div></div></figure><p id="6141" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Uniswap协议是一种ETH本机智能合同系统，支持对ERC20 &lt;&gt; ERC20和ERC20 &lt;&gt; ETH进行交换。</p><p id="7c66" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Uniswap使用自动做市商(AMM)算法来执行交易。用户以成对的令牌提供流动性，以创建流动性池。通过将提供的令牌放入池中并从池中取出请求的令牌来执行交易。互换费用适用于分配给流动性提供者(LPs)的ask令牌金额。</p><p id="e050" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae jz" href="https://uniswap.org/blog/uniswap-v3/" rel="noopener ugc nofollow" target="_blank"> Uniswap V3 </a>是引入了集中流动性和许多其他概念的协议的最新版本。在V3中，根据提供流动性的风险，有几个可用的费用级别。这些费用在游泳池的2个代币中收取，不会再投资到游泳池中。</p><p id="493a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">UNI是Uniswap协议的治理令牌。UNI令牌持有者将来可能有资格享受<a class="ae jz" href="https://docs.uniswap.org/concepts/V3-overview/fees#protocol-fees" rel="noopener ugc nofollow" target="_blank">协议费</a>。当前方案费用为0%。UNI令牌持有者可以更改协议费用。</p><h1 id="eab6" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">集中流动性</h1><p id="1655" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">Uniswap V3使用的是<a class="ae jz" href="https://docs.uniswap.org/concepts/V3-overview/concentrated-liquidity" rel="noopener ugc nofollow" target="_blank">集中流动性</a>做市商(CLMM)，这是一种比标准不变产品做市商(CPMM)算法更有效的市场标记算法。</p><p id="5342" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">池中有2个令牌令牌0和令牌1。令牌0的价格(P)以令牌1表示。例如，在UNI &lt;&gt; ETH池中，每1个条目100个UNI。</p><p id="e8e8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在CLMM中，LPs必须选择一个他们提供流动性的价格范围。如果价格P超出了某个池的范围，它就会变得不活跃，并使用已更改价格范围内的下一个可用池来执行交换。</p><p id="9f53" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在CLMM中，资金池跟踪资金池中价格 (P)和流动性(L)的<a class="ae jz" href="https://uniswap.org/whitepaper-v3.pdf" rel="noopener ugc nofollow" target="_blank">平方根。计算交换中接收的令牌量不需要池中的令牌量。</a></p><p id="2004" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下面是定义代币数量、价格和流动性之间关系的公式。</p><pre class="ld le lf lg fq lh li lj lk aw ll dt"><span id="fcc2" class="lm kb ht li b fv ln lo l lp lq"># x is the amount of token0, y is the amount of token1<br/># price of token0 in terms of token1<br/>P = y / x<br/><br/># liquidity is the geometric mean of the amount of tokens<br/>L = sqrt(x*y)</span></pre><p id="4f34" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在V3中，流动性被定义为给定平方根p变化的令牌1数量变化。基于这一概念，下面的V3公式被用来计算您可以获得的令牌数量。</p><pre class="ld le lf lg fq lh li lj lk aw ll dt"><span id="8edb" class="lm kb ht li b fv ln lo l lp lq">Δy = Δ(√P) * L <br/>Δx = Δ(1/√P) * L</span></pre><p id="9f27" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">以上公式用于计算每个相邻刻度的价格变动。刻度是一个整数，用下面的公式表示价格。</p><pre class="ld le lf lg fq lh li lj lk aw ll dt"><span id="e9f7" class="lm kb ht li b fv ln lo l lp lq">P = 1.0001^i<br/>sqrt(P) = 1.0001^(i/2)<br/>i = log(sqrt(P)) * 2 / log(1.0001)</span></pre><p id="a553" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">每个刻度线与相邻刻度线相距0.1%。如果完全交换的价格变动超过了相邻的分笔成交点，则在从一个分笔成交点移动到另一个分笔成交点的分步功能中执行交换，直到所有的代币都被交换。</p><p id="5351" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">对于两个相邻分笔成交点内的价格变动，CLMM遵循常数乘积公式。CLMM是常数乘积公式的变体。</p><p id="d9a7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下面是我写的一个脚本，用来模拟使用集中流动性公式的互换。我忽略了交换中的申请费。仅实施了令牌1到令牌0的交换。</p><figure class="ld le lf lg fq iu"><div class="bz el l di"><div class="lr ls l"/></div></figure><p id="c88b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在V3中，流动性池被表示为NFT，因为每个池彼此不同。基于互换的价格影响，单个互换可能从一个池转移到另一个池。</p><p id="d1ba" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">与标准的常数乘积算法相比，集中流动性非常高效。CLMM在池的价格范围内使用池中的全部流动性。但是CPMM将流动性从0分散到无穷大。这是因为CLMM有不同的公式来计算池的新状态。</p><h1 id="93ae" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">价格影响</h1><p id="32d7" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">当对池进行交换时，池中的令牌比率会发生变化。令牌池中令牌的比率是令牌0相对于令牌1的价格(P)。</p><p id="9365" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在交换开始时，投票的比例是100:1。但是，当与1ETH交换时，您将不会获得100UNI，因为池的比率会发生变化。这被称为互换的<a class="ae jz" href="https://docs.uniswap.org/concepts/introduction/swaps#price-impact" rel="noopener ugc nofollow" target="_blank">价格影响</a>。</p><p id="e24f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们以UNI &lt;&gt; ETH流动性池为例。当前比率为100单位/1小时。我们将使用CPMM的V2公式，因为计算要容易得多，但V3的概念仍然相同。</p><pre class="ld le lf lg fq lh li lj lk aw ll dt"><span id="6e95" class="lm kb ht li b fv ln lo l lp lq"># x and y are number of tokens<br/># x_uni = 10000, y_eth = 100<br/>x_uni * y_eth = k<br/>(x_uni - recieve) * (y_eth + deposit) = k<br/>(10000 - receive) * (100 + 1) = 10000 * 100<br/>receive = 10000 - (10000 * 100 / 101)<br/>receive = 99.0099</span></pre><p id="3764" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在上面的计算中，您可以看到第1个ETH有99.0099个UNI令牌。令牌池中的令牌比率已发生变化，但令牌数量的乘积仍保持不变。</p><h1 id="bb24" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">滑动</h1><p id="d95b" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">具有较高gas的交易可以在具有较低费用的交易之前执行。不可能预测事务将在哪个时间点执行。在事务广播和执行之间，池的状态可能已经改变。资金池状态的改变可能会导致掉期价格与预期价格大相径庭。这种价格变化被认为是<a class="ae jz" href="https://docs.uniswap.org/concepts/introduction/swaps#slippage" rel="noopener ugc nofollow" target="_blank">滑点</a>。</p><h1 id="4e2a" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">非永久性损失</h1><p id="5dc1" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">流动性提供者通过提供流动性来承担风险。池中代币的比例将根据当前市场价格不断变化。套利者将与资金池交易，以使资金池令牌比率(价格)与更大市场的比率相匹配。这种投资组合的再平衡对有限合伙人来说是有风险的，因为当他们决定撤回资金时，比率可能会非常偏向已经失去价值的代币。</p><p id="2d93" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们举个例子来看看这一点。下面的例子使用V2 CPMM，因为它有一个简单的公式，但概念也适用于V3。</p><p id="d45a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">爱丽丝和鲍勃决定资助BTC游泳池。我们将看到流动性池在不同时间的状态。使用两个等式计算池的状态。</p><pre class="ld le lf lg fq lh li lj lk aw ll dt"><span id="0e69" class="lm kb ht li b fv ln lo l lp lq"># token_x and token_y are number of tokens<br/># k is the constant product and r is the ratio of tokens<br/>token_x * token_y = k<br/>token_x / token_y = r<br/># substituting the value of token_y<br/>token_x^2 / r = k<br/>token_x = √(k*r)<br/>token_y = √(k/r)</span></pre><p id="419d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">token_x = BTC，token_y =瑞士</p><p id="654a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">在T0 </strong> <br/> r = 1/10 <br/>初始池状态= 900 BTC + 9000 ETH <br/>爱丽丝存入100 BTC + 1000 ETH <br/>最终池状态= 1000 BTC + 10000 ETH <br/>爱丽丝是池的10%所有者</p><p id="7a4b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">在T1 </strong> <br/> r = 1/8 <br/>初始池状态= 1118 BTC + 8944 ETH <br/>鲍勃存款80 BTC + 640 ETH <br/>最终池状态= 1198 BTC + 9584 ETH <br/>鲍勃拥有总池的6.67%<br/>爱丽丝现在拥有池的9.33%</p><p id="08a8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">在T2 </strong> <br/> r = 1/5 <br/>初始池状态= 1515.36 BTC + 7576.8 ETH</p><p id="38f2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">爱丽丝决定退出资金池<br/>爱丽丝将获得资金池的9.33%，即141.38 BTC + 706.91 ETH。按现行汇率相当于282.76 BTC。如果爱丽丝持有代币而不是添加到池中，那么她将拥有100 BTC + 1000以太币，按照当前的汇率相当于300 BTC。所以爱丽丝损失了17.24 BTC。</p><p id="22f8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">最终池状态= 1373.98 BTC + 6869.89瑞士法郎</p><p id="2216" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Bob现在拥有资金池的7.356%，并决定将资金留在资金池中。</p><p id="267d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">在T3 </strong> <br/> r = 1:8 <br/>初始资金池状态= 1086.22 BTC + 8689.76 ETH <br/>鲍勃决定从资金池中提取资金<br/>鲍勃将获得资金池的7.356%，即79.9 BTC + 639.218 ETH。按照目前的汇率，这相当于159.8 BTC(考虑到十进制误差，这160等于159.8)。如果Bob没有在池中存款，他将拥有80 BTC + 640瑞士法郎，按照当前汇率，这相当于160 BTC。这里我们看到Bob没有损失任何价值，因为池的比率与他存放代币时相同。</p><p id="50e8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这就是它被称为非永久性损失的原因。如果该池的比率与您存放代币时的比率相同，则没有损失。</p><p id="0efb" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">有限合伙人从每笔交易中获得交易费。如果有限合伙人收取的交易费用大于非永久性损失，那么有限合伙人可以从资金池中提取资金并获利。</p><blockquote class="lt"><p id="a268" class="lu lv ht bd lw lx ly lz ma mb mc jy ek translated">加入Coinmonks电报频道，了解加密交易和投资</p></blockquote><h2 id="3e0c" class="lm kb ht bd kc md me mf kg mg mh mi kk jm mj mk ko jq ml mm ks ju mn mo kw mp dt translated">另外，阅读</h2><ul class=""><li id="6c6b" class="mq mr ht jd b je ky ji kz jm ms jq mt ju mu jy mv mw mx my dt translated"><a class="ae jz" href="https://blog.coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">电网交易机器人</a></li><li id="a408" class="mq mr ht jd b je mz ji na jm nb jq nc ju nd jy mv mw mx my dt translated"><a class="ae jz" href="https://blog.coincodecap.com/best-crypto-trading-bots" rel="noopener ugc nofollow" target="_blank">密码交易机器人</a></li><li id="06fb" class="mq mr ht jd b je mz ji na jm nb jq nc ju nd jy mv mw mx my dt translated"><a class="ae jz" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">密码本交易平台</a></li></ul></div></div>    
</body>
</html>