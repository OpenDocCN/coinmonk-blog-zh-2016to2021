<html>
<head>
<title>Missing return value bug — At least 130 tokens affected</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">缺少返回值错误—至少130个令牌受到影响</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca?source=collection_archive---------0-----------------------#2018-06-05">https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca?source=collection_archive---------0-----------------------#2018-06-05</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="c157" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">TL；dr由于最近的Solidity更新，许多ERC20令牌合同中出现了一个严重的错误。</p><p id="862a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> ERC基础知识</strong></p><p id="8444" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">ERC20标准是以太坊平台上最常见的令牌标准。ERC20被定义为一个接口，该接口指定了智能合约中必须实现哪些功能和事件才能符合ERC20。目前，这些措施如下:</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="76b4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">ERC 20合约的传递函数应该返回什么？</strong></p><p id="c323" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在ERC20的开发过程中，曾就ERC20合约传递函数的正确返回值进行了长时间的讨论。在这次讨论中基本上有两个阵营。一方认为，如果传递不允许调用契约中的错误处理，那么传递函数应该返回false。另一方声称，在无法确保安全的情况下，ERC20应恢复交易。这个问题从未真正解决，这两种行为现在都被认为是符合ERC20的。最常见的行为是失败时的恢复，特别是因为OpenZeppelin通过这种方式实现了ERC20令牌。</p><p id="513f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">所有这些与我想要描述的实际bug没有什么关系，但是可能有助于提供一些上下文。</p><p id="2661" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">臭虫</strong></p><p id="3ba0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">事实证明，很大一部分ERC20令牌在传递函数的返回值方面表现出另一种方式。</p><p id="a05a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这些令牌契约的传递函数(姑且称之为BadTokens)不返回任何东西。他们遵循的接口如下所示:</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="fcba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">该接口不符合ERC20标准，这意味着实现该接口的契约不是ERC20令牌。</p><p id="fcab" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">拥有令牌标准的一个要点是，使其他智能合约能够通过一个公共接口与许多不同的令牌合约进行交互。有许多不同的合同使用ERC20令牌的这一功能。分散交易所可以发送代币，众卖合约可以接受ERC20代币作为支付等等。现在有趣的问题是，如果一个期望ERC20接口的契约试图与一个不符合ERC20的BadToken交互，会发生什么？</p><p id="9781" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们来看看这个场景:</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="04d1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在Solidity中，函数选择器是从它的函数名和输入参数的类型中派生出来的。</p><pre class="jo jp jq jr fq jv jw jx jy aw jz dt"><span id="c6b4" class="ka kb ht jw b fv kc kd l ke kf">selector = bytes4(sha3(“transfer()”))</span></pre><p id="4421" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">函数的返回值不是函数选择器的一部分。所以一个没有返回值的函数<em class="kg">transfer()</em><em class="kg"/>和一个<em class="kg"> </em>函数<em class="kg">transfer()returns(bool)</em>有相同的函数选择器，但它们仍然不同。如果你愿意尝试</p><pre class="jo jp jq jr fq jv jw jx jy aw jz dt"><span id="7ec4" class="ka kb ht jw b fv kc kd l ke kf">contract BadToken is Token {                      <br/>   function transfer() {}         <br/>}</span></pre><p id="ef52" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">由于缺少返回值，编译器不会接受transfer()函数作为令牌接口的实现。所以GoodToken是Token接口的实现，BadToken不是。</p><p id="7fe8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我们称它为“无论如何”,会发生什么？</p><p id="9b39" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">调用契约向BadToken发送外部调用，bad token处理调用，进行传输，并且不返回布尔返回值。调用契约现在在内存中查找返回值，但是由于令牌没有写入返回值，所以它会将在该内存位置找到的任何内容作为外部调用的返回值。</p><p id="03cd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这已经很糟糕了:将一些恰好在内存槽中的数据作为返回值不是一个好主意。</p><p id="1b63" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">纯属巧合，这个问题在过去没有出现，因为调用者期望返回值的内存槽与存储调用的函数选择器的内存槽重叠。这被EVM解释为返回值“true”。因此，由于运气好，EVM表现得像程序员希望它表现的那样。</p><p id="bdea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但对于较新的智能合约来说，情况并非如此。</p><p id="5c8c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">什么变了？</strong></p><p id="193b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">自从去年10月拜占庭硬分叉之后，EVM有了一个新的操作码，叫做<em class="kg"> RETURNDATASIZE。</em>这个操作码存储(顾名思义)外部调用返回数据的大小。这是一个非常有用的操作码，因为它允许在函数调用中返回动态大小的数组。</p><p id="80ba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Solidity 0.4.22更新中采用了这个操作码(当设置为默认的后拜占庭模式时)。现在，代码在外部调用后检查返回值的大小，并在返回数据比预期短时恢复事务。这比从某个内存插槽中读取数据要安全得多。但是这种新行为对我们的BadTokens来说是个大问题。</p><p id="2d3b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">谁受影响。</strong></p><p id="9b26" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了了解这个问题有多普遍，我拿出了Etherdelta上列出的ERC20令牌列表，并检查了它们在Etherscan上验证的API。因此，我找到了130个受影响的象征性合同。</p><p id="7189" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这份名单上有一些名人:</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="097a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">名单上最大的标志(按市值计算)是:</p><p id="ab12" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">币安币1.587.146.847美元<br/>奥米塞戈币1.127.641.627美元</strong></p><p id="774e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是这个列表中也有很多中小型代币。</p><p id="3036" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">有什么风险？</strong></p><p id="231d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如上所述，最大的风险是，用solc ≥ 0.4.22编译的智能合约(它需要一个ERC20接口)将无法与我们的BadTokens进行交互。这可能意味着发送到这种合同的令牌将永远卡在那里，即使该合同具有转移ERC20令牌的功能。在许多不同的场景中，处理ERC20令牌的契约都会遇到这个bug。一个例子是，你将不能使用分散的交易所，它与solc ≥ 0.4.22的合同与你的BadToken一起编译。</p><p id="55f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">怎么会这样？</strong></p><p id="c29f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个问题显然是令牌合约中的一个bug。坚固性的改变只是把这个错误暴露出来。有这么多BadTokens的一个原因是OpenZeppelin在他们的框架中实现了错误的接口。在2017年3月17日和2017年7月13日之间，接口出错:</p><p id="6230" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae kh" href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/52120a8c428de5e34f157b7eaed16d38f3029e66/contracts/token/ERC20Basic.sol" rel="noopener ugc nofollow" target="_blank">https://github . com/open zeppelin/open zeppelin-solidity/blob/52120 A8 c 428 de 5 e 34 f 157 b 7 ea ed 16d 38 f 3029 e 66/contracts/token/ERC 20 basic . sol</a></p><p id="3330" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，大多数BadTokens使用了ERC20接口的有缺陷的OpenZeppelin实现。</p><p id="4659" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">那么现在怎么办？</strong></p><p id="97f3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有两种方法可以修复这个bug，我认为这两种方法需要并行处理。</p><p id="1f65" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一方面，受影响的令牌合同的团队需要修改他们的合同。这可以通过重新部署令牌合约或通过更新合约来完成，如果令牌合约具有更新编程到其中的合约的某种能力的话。</p><p id="7b34" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">另一种可能性是用一个调用坏的传递函数并返回好的传递函数的契约来包装令牌契约。对于这种包装器有不同的提议。例如</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="a6f6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">另一方面，正在编写处理ERC20令牌的合同的开发人员需要了解这个bug，这样他们就可以预测BadTokens的意外行为并处理它们。这可以通过期待BadERC20接口并在调用后检查返回数据来确定我们调用的是GoodToken还是BadToken来实现。</p><figure class="jo jp jq jr fq js"><div class="bz el l di"><div class="jt ju l"/></div></figure><p id="d4c8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">结论</strong></p><p id="35d8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我认为目前没有理由恐慌，因为分散交易所和其他大合约的更新周期相当长。然而，这个错误需要尽快修复。</p><p id="e1f2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">关于这个问题，还有一篇来自<a class="ki kj gr" href="https://medium.com/u/8c4229f925b6?source=post_page-----d67bf08521ca--------------------------------" rel="noopener" target="_blank"> Christian </a>的内容丰富的文章。<a class="ae kh" rel="noopener" href="/@chris_77367/explaining-unexpected-reverts-starting-with-solidity-0-4-22-3ada6e82308c">https://medium . com/@ Chris _ 77367/explaining-unexpected-revotes-starting-with-solidity-0-4-22-3 ada 6e 82308 c</a></p><p id="560f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可以在github上看到这个问题:<a class="ae kh" href="https://github.com/ethereum/solidity/issues/4116" rel="noopener ugc nofollow" target="_blank">https://github.com/ethereum/solidity/issues/4116</a></p><p id="c027" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">感谢克里斯蒂安、热拉尔和伊娃对本文的帮助</p><p id="e4bb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">关于卢卡斯-柏林</strong></p><p id="c248" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我是一名驻柏林的solidity开发人员和审计员。我也是sicos.io的CTO和Solidity Berlin meetup的组织者。(www.solidity.berlin)</p><blockquote class="kk"><p id="8c87" class="kl km ht bd kn ko kp kq kr ks kt jn ek translated">加入Coinmonks <a class="ae kh" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae kh" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>获取每日<a class="ae kh" href="http://coincodecap.com/" rel="noopener ugc nofollow" target="_blank">加密新闻</a></p></blockquote><h2 id="15d6" class="ka kb ht bd ku kv kw kx ky kz la lb lc jb ld le lf jf lg lh li jj lj lk ll lm dt translated">另外，阅读</h2><ul class=""><li id="20fb" class="ln lo ht is b it lp ix lq jb lr jf ls jj lt jn lu lv lw lx dt translated"><a class="ae kh" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a> | <a class="ae kh" rel="noopener" href="/coinmonks/crypto-tax-software-ed4b4810e338">加密税务软件</a></li><li id="723e" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">网格交易</a> | <a class="ae kh" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069">加密硬件钱包</a></li><li id="874f" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="http://Top 4 Telegram Channels for Crypto Traders" rel="noopener ugc nofollow" target="_blank">密码电报信号</a> | <a class="ae kh" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="f33b" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" rel="noopener" href="/coinmonks/crypto-exchange-dd2f9d6f3769">最佳加密交易所</a> | <a class="ae kh" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度最佳加密交易所</a></li><li id="47a8" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">开发人员的最佳加密API</li><li id="6f41" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/nft-marketplaces" rel="noopener ugc nofollow" target="_blank">NFT十大市场造币集锦</a></li><li id="f72f" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/ascendex-staking" rel="noopener ugc nofollow" target="_blank">AscendEx Staking</a>|<a class="ae kh" href="https://coincodecap.com/bot-ocean-review" rel="noopener ugc nofollow" target="_blank">Bot Ocean Review</a>|<a class="ae kh" href="https://coincodecap.com/bitcoin-wallets-india" rel="noopener ugc nofollow" target="_blank">最佳比特币钱包</a></li><li id="15e5" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/bitget-review" rel="noopener ugc nofollow" target="_blank"> Bitget评论</a>|<a class="ae kh" href="https://coincodecap.com/gemini-vs-blockfi" rel="noopener ugc nofollow" target="_blank">Gemini vs block fi</a>|<a class="ae kh" href="https://coincodecap.com/okex-futures-trading" rel="noopener ugc nofollow" target="_blank">OKEx期货交易</a></li><li id="c009" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/crypto-trading-bots-in-the-us" rel="noopener ugc nofollow" target="_blank">美国最佳加密交易机器人</a> | <a class="ae kh" href="https://coincodecap.com/changelly-review" rel="noopener ugc nofollow" target="_blank">经常性评论</a></li><li id="7716" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" href="https://coincodecap.com/crypto-arbitrage-in-india" rel="noopener ugc nofollow" target="_blank">在印度利用加密套利赚取被动收入</a></li><li id="b359" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">最佳<a class="ae kh" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">密码借贷平台</a></li><li id="3c98" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated"><a class="ae kh" rel="noopener" href="/coinmonks/free-crypto-signals-48b25e61a8da">免费加密信号</a> | <a class="ae kh" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a></li><li id="9487" class="ln lo ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">杠杆代币的终极指南</li></ul></div></div>    
</body>
</html>