<html>
<head>
<title>Simplified code of Bitcoin Lightning Network part2 — Spend Breach Remedy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">比特币闪电网络简化代码第二部分——消费违约补救</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-part2-spend-breach-remedy-997de8a21f29?source=collection_archive---------9-----------------------#2018-10-06">https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-part2-spend-breach-remedy-997de8a21f29?source=collection_archive---------9-----------------------#2018-10-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="891c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">雷电网络的基本概念很简单。为了进一步理解，参考<a class="ae jo" href="https://lightning.network/lightning-network-paper.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a>，将lightning网络交易流程表示为javascript代码。</p><p id="e05a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是第二篇解释闪电网络流程的文章。这一次，我将解释如何采取违约补救措施，这与白皮书中的图9相对应。</p><p id="866b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Github上的代码:<a class="ae jo" href="https://github.com/tak1827/lightning-network-tx-flow/tree/spend-BR" rel="noopener ugc nofollow" target="_blank">闪电网tx流</a></p><p id="2624" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">前置:<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5">比特币闪电网简码——消费可撤销交割</a></p><p id="84c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下一篇:<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-part3-spend-htlc-execution-revocable-delivery-49991e3cfe34">比特币闪电网络简化代码第三部分——消费HTLC执行可撤销交割</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/7ae82c3987bda0d258f2a70f6b90b5ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rsDYC2gvN7Ob7H6qNFLOog.png"/></div></div></figure></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="ac42" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">采取违约补救措施的10个步骤</h2><p id="e326" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">由于重复的解释，我跳过了第4步。所以想了解请参考<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5">之前的博文</a>。</p><ol class=""><li id="9a21" class="li lj ht is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq dt translated"><em class="lr">多签名资助</em></li><li id="d7fe" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建立C1a和C1b(无标志)</em></li><li id="40fd" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建RD1a和RD1b </em></li><li id="f5aa" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">C1a和C1b交换签名</em></li><li id="044f" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建立C2a和C2b(无标志)</em></li><li id="5de4" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated">建造RD2a和RD2b </li><li id="1cd0" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">C2a和C2b的交换签名</em></li><li id="2423" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造BR1a和BR1b </em></li><li id="c54d" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">花C1b </em></li><li id="bdeb" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">花BR1b </em></li></ol></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="ccac" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 5。构建C2a和C2b(无标志)</em></h2><p id="1465" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">结构与C1a相同。请注意，2个输入也与C1a相同，因为C1a在这一刻还没有花费。该交易更新了Alice和Bob之间比特币余额。对于比特币Mainnet来说，只有最终输出才是重要的。如果爱丽丝花了C2a，比特币主网无法感知C1a的存在。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="743b" class="ki kj ht lz b fv md me l mf mg">let C2a = new Transaction(<br/>  [<br/>    new TxIn( // This is same as C1a<br/>      fTxAH, <br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    ),<br/>    new TxIn( // This is same as C1a<br/>      fTxBH, <br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      40000000, <br/>      { <br/>        type: 'RSMS',<br/>        pubKeyHash: [ <br/>          getPubKeyHash(AliceKeys[4]), <br/>          getPubKeyHash(BobKeys[4]) <br/>        ]<br/>      }<br/>    ),<br/>    new TxOut(<br/>      60000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(BobKeys[4])<br/>      }<br/>    )<br/>  ]<br/>)</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="5f50" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 6。构建RD2a和RD2b </em></h2><p id="b428" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">RD2a和RD2b的建造过程与RD1a和RD1b几乎相同。所以让我跳过。请参考<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5">上一篇博文</a>中的RD1a和RD2b构建部分。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="b8fe" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 7。C2a和C2b的交换签名</em></h2><p id="fcc8" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">和C1a部分一样，Alice把C2a交给Bob，让他签字。现在爱丽丝和鲍勃可以花C2a和C2b了。如果爱丽丝意外地花掉了C1a，她会失去所有BTC，所以爱丽丝可以安全地取消C1a。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="e315" class="ki kj ht lz b fv md me l mf mg">// Alice hand over C2a to Bob, and let him sign<br/>C2a = signTx(C2a, BobKeys[1]);</span></pre><p id="1093" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">同样的，鲍勃让爱丽丝签了C2b。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="e5a4" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 8。构建BR1a和BR1b </em></h2><p id="5f06" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">爱丽丝建造BR1a并签名，然后将BR1a交给鲍勃。请注意，BR1a的输出是给Bob的。本来，这个输出就是属于爱丽丝的。</p><p id="835a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果Alice不与Bob合作并且她花费C1a，即使C2a和C2b已经交换了，Alice因为她的违约而失去所有BTC。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="eb55" class="ki kj ht lz b fv md me l mf mg">let BR1a = new Transaction(<br/>  [<br/>    new TxIn(<br/>      '', // Keep empty because C1a have not yet spent<br/>      0, <br/>      { <br/>        type: 'BR',<br/>        sig: [ <br/>          getPubKeyHash(AliceKeys[2]), <br/>          getPubKeyHash(BobKeys[2]) <br/>        ],<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(BobKeys[3]) // For Bob<br/>      }<br/>    )<br/>  ]<br/>)</span><span id="0203" class="ki kj ht lz b fv mh me l mf mg">// Alice hand over signed BR1a to Bob. This output is for Bob<br/>BR1a = signTx(BR1a, AliceKeys[2]);</span></pre><p id="a259" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Json格式BR scriptSig如下。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="f162" class="ki kj ht lz b fv md me l mf mg">scriptSig = { <br/>  type: 'BR',<br/>  sig: [ <br/>    {<br/>     signature: signature, <br/>     pubKey: pubKey1 <br/>    },<br/>    {<br/>     signature: signature, <br/>     pubKey: pubKey2<br/>    }<br/>  ],<br/>}</span></pre><p id="0327" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">同样，鲍勃把烧焦的BR1b交给爱丽丝。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="b633" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 9。花费C1b </em></h2><p id="2e01" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">Bob意外花了C1b。不幸的是，他永远失去了整个BTC。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="290d" class="ki kj ht lz b fv md me l mf mg">// Sign by himself(Bob)<br/>C1b = signTx(C1b, BobKeys[1]);</span><span id="5b54" class="ki kj ht lz b fv mh me l mf mg">// Validate transaction<br/>validateTx(C1b, Blocks);</span><span id="109b" class="ki kj ht lz b fv mh me l mf mg">// Mine block as adding transactions<br/>Blocks = mineBlock(Blocks, createNewBlock([C1b], Blocks));</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="4cf5" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">10.花费10亿英镑</h2><p id="b395" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">爱丽丝可以立刻花掉BR1b，没有任何时间锁定。请注意，如果时间锁过期，Bob可以使用RD1b。所以，爱丽丝早点花BR1b比较好。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="a874" class="ki kj ht lz b fv md me l mf mg">// Set C1b transaction hash<br/>BR1b.txIns[0].txPrev = calculateTxHash(C1b);</span><span id="d687" class="ki kj ht lz b fv mh me l mf mg">// Inherently, this BTC is for Bob, but now belong to Alice.<br/>// Bob lose for his breach.<br/>BR1b = signTx(BR1b, AliceKeys[2]);</span><span id="79c9" class="ki kj ht lz b fv mh me l mf mg">validateTx(BR1b, Blocks);</span><span id="c7bc" class="ki kj ht lz b fv mh me l mf mg">Blocks.push( createNewBlock([BR1a], Blocks) );</span></pre><blockquote class="mi"><p id="eadd" class="mj mk ht bd ml mm mn mo mp mq mr jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mt mu mv mw mx ju fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ms"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>