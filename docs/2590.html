<html>
<head>
<title>Create a Decentralized Database using Tangle and IPFS for beginners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为初学者使用Tangle和IPFS创建一个分散的数据库</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/create-a-database-using-tangle-and-ipfs-for-beginners-5cd5228ba830?source=collection_archive---------2-----------------------#2019-12-17">https://medium.com/coinmonks/create-a-database-using-tangle-and-ipfs-for-beginners-5cd5228ba830?source=collection_archive---------2-----------------------#2019-12-17</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="8b7a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在本教程中，我将为分散式应用程序创建一个数据库系统，为此我将使用<a class="ae jo" href="https://docs.iota.org/docs/client-libraries/0.1/mam/introduction/overview" rel="noopener ugc nofollow" target="_blank"> MAM </a>通信协议，对于存储，我将使用<a class="ae jo" href="https://ipfs.io/" rel="noopener ugc nofollow" target="_blank"> IPFS </a>。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/2f1d645861cac006ca7a3b7eb6212d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/1*uAyDc4FmblxhrDP1bJZWHA.png"/></div></figure><p id="20d5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你不熟悉MAM，只需创建一个<a class="ae jo" href="https://ecosystem.iota.org/tutorials/iota-tutorial-18" rel="noopener ugc nofollow" target="_blank">默克尔树</a>来保存哈希值。在我们使用<a class="ae jo" rel="noopener" href="/coinmonks/iota-mam-eloquently-explained-d7505863b413"> Restricted MAM </a>的情况下，根的散列能够使用side-key访问所有其他散列。因此，IPFS将上传文件，然后返回的散列将被保存在MAM。</p><h1 id="ee8f" class="jx jy ht bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated"><strong class="ak">数据库将如何工作</strong></h1><p id="c53d" class="pw-post-body-paragraph iq ir ht is b it kv iv iw ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn hm dt translated">当然，我们的数据库将采用JSON格式。</p><p id="b85e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">1-将JSON数据上传到IPFS，并获取返回的散列以供以后访问文件。</p><p id="dde7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2-使用MAM restricted发送IPFS。</p><p id="0738" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">获取数据:-</p><p id="e7ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">1-使用mama restricted获取数据，并获取上传的IPFS哈希。</p><p id="f27f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2-获取IPFS的散列以获得上传的JSON数据。</p><h1 id="869a" class="jx jy ht bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">让我们开始编码吧</h1><p id="c96d" class="pw-post-body-paragraph iq ir ht is b it kv iv iw ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn hm dt translated">上传数据的IPFS代码。在此检查文档<a class="ae jo" href="https://github.com/ipfs/interface-js-ipfs-core/blob/master/SPEC/FILES.md#add" rel="noopener ugc nofollow" target="_blank">上的功能。</a></p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="7df9" class="lf jy ht lb b fv lg lh l li lj">/*Don't forget to write npm install --save ipfs-http-client*/</span><span id="5790" class="lf jy ht lb b fv lk lh l li lj">const ipfsLibrary = require(‘ipfs-http-client’)<br/>const ipfs = new ipfsLibrary({ host: ‘ipfs.infura.io’, port: 5001, protocol: ‘https’ })</span><span id="27da" class="lf jy ht lb b fv lk lh l li lj">const add = async (data) =&gt;{</span><span id="ff89" class="lf jy ht lb b fv lk lh l li lj">const hash = await ipfs.add(JSON.stringify(data))</span><span id="8314" class="lf jy ht lb b fv lk lh l li lj">return hash[0].path</span><span id="fbb3" class="lf jy ht lb b fv lk lh l li lj">}</span><span id="4ae2" class="lf jy ht lb b fv lk lh l li lj">module.exports = {<br/>execute : add<br/>}</span></pre><p id="bc72" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">IPFS代码获取数据文件上的cat.js检查函数<a class="ae jo" href="https://github.com/ipfs/interface-js-ipfs-core/blob/master/SPEC/FILES.md#cat" rel="noopener ugc nofollow" target="_blank">此处</a></p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="58e1" class="lf jy ht lb b fv lg lh l li lj">const ipfsLibrary = require('ipfs-http-client')</span><span id="f568" class="lf jy ht lb b fv lk lh l li lj">const ipfs = new ipfsLibrary({ host: 'ipfs.infura.io', port: 5001, protocol: 'https' })</span><span id="b62d" class="lf jy ht lb b fv lk lh l li lj">const cat = async (hash) =&gt;{</span><span id="afd4" class="lf jy ht lb b fv lk lh l li lj">const content = await ipfs.cat(hash)</span><span id="6159" class="lf jy ht lb b fv lk lh l li lj">console.log("read hash =",hash)</span><span id="f7bb" class="lf jy ht lb b fv lk lh l li lj">return content.toString()</span><span id="acc9" class="lf jy ht lb b fv lk lh l li lj">}</span><span id="6d89" class="lf jy ht lb b fv lk lh l li lj">module.exports = {<br/>execute : cat<br/>}</span></pre><p id="b7f8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">妈妈密码</p><p id="e7a8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于MAM代码，我们将创建4个文件:-</p><p id="cb30" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">1-IotaGlobale.js:添加两个push和fetch函数中使用的所有全局变量</p><p id="83d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2-pushData.js:上传到MAM</p><p id="998f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">3-fetchRoot.js:从MAM获取数据</p><p id="4b8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">4-mangeMam.js:合并上面的3个文件</p><p id="424b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">` IotaGlobale.js` <strong class="is hu">重要提示！</strong>我花了三天时间解决了默克尔树的重复问题。默克尔树的状态必须保持全局，否则每次调用该函数时，您之前的所有数据都将丢失。</p><p id="5358" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">IotaGlobale.js:</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="819a" class="lf jy ht lb b fv lg lh l li lj">/*On this file we will add all globale variables we will need to use*/<br/>const iotaLibrary = require(‘@iota/core’)<br/>const Converter = require(‘@iota/converter’)</span><span id="5776" class="lf jy ht lb b fv lk lh l li lj">const Mam = require(‘@iota/mam’)</span><span id="288f" class="lf jy ht lb b fv lk lh l li lj">const seed = ‘XGIVJKNUIDKDVAXGRK9SFXYFVOLEHSJOIZVROT9DUAMYUUXPPBZWYQWJNEYPVKOMKR9SNRYSZXUHDFKNB’</span><span id="6162" class="lf jy ht lb b fv lk lh l li lj">// Define the depth that the node will use for tip selection</span><span id="45f4" class="lf jy ht lb b fv lk lh l li lj">const depth = 3;</span><span id="7160" class="lf jy ht lb b fv lk lh l li lj">// Define the minimum weight magnitude for the Devnet</span><span id="fe9a" class="lf jy ht lb b fv lk lh l li lj">const minimumWeightMagnitude = 9;</span><span id="d2ff" class="lf jy ht lb b fv lk lh l li lj">//MAM</span><span id="0395" class="lf jy ht lb b fv lk lh l li lj">const providerLink = ‘https://nodes.devnet.iota.org:443'</span><span id="3488" class="lf jy ht lb b fv lk lh l li lj">const sideKey = ‘DONTSHARETHISPASSWORD’</span><span id="4973" class="lf jy ht lb b fv lk lh l li lj">let mamState = Mam.init(providerLink)</span><span id="74ab" class="lf jy ht lb b fv lk lh l li lj">mamState = Mam.changeMode(mamState, ‘restricted’, sideKey)</span><span id="2b60" class="lf jy ht lb b fv lk lh l li lj">const iota =iotaLibrary.composeAPI({</span><span id="b6bd" class="lf jy ht lb b fv lk lh l li lj">provider: providerLink</span><span id="a5b4" class="lf jy ht lb b fv lk lh l li lj">})</span><span id="16a2" class="lf jy ht lb b fv lk lh l li lj">//Modified functions</span><span id="c2ec" class="lf jy ht lb b fv lk lh l li lj">const lengthModifier = (str) =&gt;{ return str.substring( str.lastIndexOf(“{“),str.lastIndexOf(“}”)+1) }</span><span id="e8d1" class="lf jy ht lb b fv lk lh l li lj">module.exports = {</span><span id="6201" class="lf jy ht lb b fv lk lh l li lj">iotaLibrary : iotaLibrary ,</span><span id="53de" class="lf jy ht lb b fv lk lh l li lj">converter : Converter ,</span><span id="2c33" class="lf jy ht lb b fv lk lh l li lj">provider:providerLink,</span><span id="f9d8" class="lf jy ht lb b fv lk lh l li lj">depth:depth,</span><span id="2d12" class="lf jy ht lb b fv lk lh l li lj">minimumWeightMagnitude:minimumWeightMagnitude,</span><span id="fea4" class="lf jy ht lb b fv lk lh l li lj">Mam : Mam ,</span><span id="9695" class="lf jy ht lb b fv lk lh l li lj">mamState:mamState,</span><span id="9543" class="lf jy ht lb b fv lk lh l li lj">seed : seed ,</span><span id="fa7a" class="lf jy ht lb b fv lk lh l li lj">sideKey:sideKey,</span><span id="e20a" class="lf jy ht lb b fv lk lh l li lj">lengthModifier:lengthModifier,</span><span id="b167" class="lf jy ht lb b fv lk lh l li lj">iota : iota</span><span id="fc94" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="1040" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将数据上传到MAM 'pushData.js '</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="46c2" class="lf jy ht lb b fv lg lh l li lj">const Mam = require('@iota/mam')<br/>const { asciiToTrytes, trytesToAscii } = require('@iota/converter')<br/>const iotaGlobal = require('./IotaGlobal')<br/>const pushData = async(_secretKey,_provider,packet) =&gt;{<br/>const trytes = asciiToTrytes(JSON.stringify(packet))<br/>const message = Mam.create(iotaGlobal.mamState, trytes)//Important to update the state<br/>// Save new mamState<br/>iotaGlobal.mamState = message.state<br/>// Attach the payload<br/>await Mam.attach(message.payload, message.address, 3, 9)<br/>return message.root<br/>}<br/>module.exports ={<br/>execute:pushData</span><span id="7daa" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="ec8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从MAM 'fetchRoot.js '获取数据</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="495f" class="lf jy ht lb b fv lg lh l li lj">const iotaGlobal = require('./IotaGlobal')</span><span id="32d0" class="lf jy ht lb b fv lk lh l li lj">const { asciiToTrytes, trytesToAscii } = require('@iota/converter')</span><span id="bb2b" class="lf jy ht lb b fv lk lh l li lj">const fetchRoot = async(_root)=&gt;{</span><span id="e178" class="lf jy ht lb b fv lk lh l li lj">const resp = await  iotaGlobal.Mam.fetch(_root, 'restricted', iotaGlobal.sideKey)</span><span id="9701" class="lf jy ht lb b fv lk lh l li lj">const tryteMessages = resp.messages</span><span id="835d" class="lf jy ht lb b fv lk lh l li lj">const asciiMessages = []</span><span id="6791" class="lf jy ht lb b fv lk lh l li lj">for (let index = 0; index &lt; tryteMessages.length; index++) {</span><span id="9270" class="lf jy ht lb b fv lk lh l li lj">asciiMessages.push(iotaGlobal.converter.trytesToAscii(tryteMessages[index]))</span><span id="1c0c" class="lf jy ht lb b fv lk lh l li lj">}</span><span id="4a4b" class="lf jy ht lb b fv lk lh l li lj">return asciiMessages</span><span id="f4d8" class="lf jy ht lb b fv lk lh l li lj">}</span><span id="0ecb" class="lf jy ht lb b fv lk lh l li lj">module.exports = {</span><span id="4261" class="lf jy ht lb b fv lk lh l li lj">execute:fetchRoot</span><span id="24cd" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="1012" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">manageMam.js</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="fe12" class="lf jy ht lb b fv lg lh l li lj">//import fetch and push data to MAM functions<br/>const fetchRoot = require('./fetchRoot')<br/>const sendData = require('./pushData')<br/>const send = async(data) =&gt;{</span><span id="cc71" class="lf jy ht lb b fv lk lh l li lj">const root = await sendData.execute(data)</span><span id="9812" class="lf jy ht lb b fv lk lh l li lj">return root</span><span id="127a" class="lf jy ht lb b fv lk lh l li lj">}</span><span id="485d" class="lf jy ht lb b fv lk lh l li lj">const fetch = async(root) =&gt;{</span><span id="59f3" class="lf jy ht lb b fv lk lh l li lj">const data = await fetchRoot.execute(root)</span><span id="9891" class="lf jy ht lb b fv lk lh l li lj">return data</span><span id="a261" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="93da" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您可以在此查看受限MAM <a class="ae jo" href="https://github.com/iotaledger/mam.client.js/blob/master/example/publishAndFetchRestricted.js" rel="noopener ugc nofollow" target="_blank">的文档示例。</a></p><p id="0386" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，我们已经完成了所有的基本模块。让我们创建我们的“index.js”。</p><p id="b9d8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">前三行用于导入两个IPFS模块和MAM管理器。</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="f2cd" class="lf jy ht lb b fv lg lh l li lj">const addToIPFS = require(‘./actions/Functions/IPFS/add’)<br/>const manageMAM = require(‘./actions/Functions/MAM/manageMAM’)<br/>const catFromIPFS = require(‘./actions/Functions/IPFS/cat’)</span></pre><p id="b3b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后，为了创建一个数据库，我们将创建一个创建函数</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="805f" class="lf jy ht lb b fv lg lh l li lj">const create = async(DBJSON)=&gt;{</span><span id="e813" class="lf jy ht lb b fv lk lh l li lj">const ipfsHash = await addToIPFS.execute(JSON.parse(JSON.stringify(DBJSON)))</span><span id="57d1" class="lf jy ht lb b fv lk lh l li lj">const root = await manageMAM.send(ipfsHash)</span><span id="772a" class="lf jy ht lb b fv lk lh l li lj">return root</span><span id="7315" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="be0f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后读取数据</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="73b0" class="lf jy ht lb b fv lg lh l li lj">const read = async(root)=&gt;{</span><span id="5537" class="lf jy ht lb b fv lk lh l li lj">const fetchIPFShash = await manageMAM.fetch(root)</span><span id="8b52" class="lf jy ht lb b fv lk lh l li lj">const fetchedIPFS = catFromIPFS.execute(getLastHash(fetchIPFShash))</span><span id="486f" class="lf jy ht lb b fv lk lh l li lj">return fetchedIPFS</span><span id="10a6" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="c0df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">更新数据</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="a707" class="lf jy ht lb b fv lg lh l li lj">const update = async(root,key,value)=&gt;{</span><span id="144d" class="lf jy ht lb b fv lk lh l li lj">const DB = await read(root)</span><span id="eaaa" class="lf jy ht lb b fv lk lh l li lj">const DBjson = JSON.parse(DB)</span><span id="c3c4" class="lf jy ht lb b fv lk lh l li lj">DBjson[key] = value</span><span id="654e" class="lf jy ht lb b fv lk lh l li lj">const newRoot = await create(DBjson)</span><span id="43a7" class="lf jy ht lb b fv lk lh l li lj">return newRoot</span><span id="1475" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="7e88" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">删除数据</p><pre class="jq jr js jt fq la lb lc ld aw le dt"><span id="ac14" class="lf jy ht lb b fv lg lh l li lj">const deleteRaw = async(root,key)=&gt;{</span><span id="e909" class="lf jy ht lb b fv lk lh l li lj">const DB = await read(root)</span><span id="f6a6" class="lf jy ht lb b fv lk lh l li lj">const DBjson = JSON.parse(DB)</span><span id="a711" class="lf jy ht lb b fv lk lh l li lj">const newRoot = await create(DBjson)</span><span id="7cc6" class="lf jy ht lb b fv lk lh l li lj">return newRoot</span><span id="dd2a" class="lf jy ht lb b fv lk lh l li lj">}</span></pre><p id="d32f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">整个项目都包含在这个库里面<a class="ae jo" href="https://github.com/yehia67/IPFS-Tangle-Database-System/tree/master" rel="noopener ugc nofollow" target="_blank">https://github . com/ye hia 67/IPFS-Tangle-Database-System/tree/master</a></p><blockquote class="ll"><p id="353f" class="lm ln ht bd lo lp lq lr ls lt lu jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="lw lx ly lz ma ju fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lv"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><a href="https://coincodecap.com"><div class="fe ff mb"><img src="../Images/a06b758bdcc47dca7c2504f298674d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_s6JsD3P0hVj32E7t9EtGg.jpeg"/></div></a></figure></div></div>    
</body>
</html>