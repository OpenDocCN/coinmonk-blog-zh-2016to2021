<html>
<head>
<title>Full Stack Decentralized Voting App using Ethereum</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用以太坊的全栈分散投票App</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/full-stack-decentralized-app-using-ethereum-faea85a8e5be?source=collection_archive---------0-----------------------#2020-07-07">https://medium.com/coinmonks/full-stack-decentralized-app-using-ethereum-faea85a8e5be?source=collection_archive---------0-----------------------#2020-07-07</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/b5b68a85759a99cae35c99252579d705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*xbgkWpNPaRlJc-B7Fw8dYQ.gif"/></div></div></figure><p id="5c16" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我叫达薇亚·詹妮弗·杜莎。我现在是印度尼特NMAM理工学院的助理教授。在这篇文章中，我想分享区块链的概念，它的工作，用途，并演示如何使用以太坊建立一个完整的堆栈去中心化的应用程序。</p><p id="d12b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我要感谢来自DLI the(<a class="ae jz" href="http://www.dlithe.com/" rel="noopener ugc nofollow" target="_blank">www.dlithe.com</a>)的Arun Sir先生进行这次区块链技术实习。我还要感谢Anubhav Chaturvedi先生，他是我们的顾问，并尽了最大努力提供和分享他的知识以及网络实践。</p><p id="c24f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我写这篇技术博客是作为区块链初学者的参考。你在与区块链合作时可能会遇到的一些术语用斜体表示，以便你理解其含义。我参考了下面的网站，并试图重现投票场景:</p><p id="2f57" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae jz" href="https://www.dappuniversity.com/articles/the-ultimate-ethereum-dapp-tutorial" rel="noopener ugc nofollow" target="_blank">https://www . dapfuniversity . com/articles/the-ultimate-ether eum-dapp-tutorial</a></p><p id="28ef" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">我们开始吧。</strong></p><p id="29b0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在基本层面上<em class="ka">区块链</em>可以定义为由存储在公共数据库(链)中的数字数据(块)组成的区块链。这就形成了<em class="ka">总账</em>。换句话说，public ledger代表区块链中的所有数据。</p><p id="655b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用基于块的方法可以克服传统方法的缺点。以太坊区块链的几个关键因素包括去中心化、不变、透明、负责。</p><p id="2e53" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="ka"> SmartContract </em>:执行某些操作的功能。我们可以说它是我们代码的业务逻辑。之所以这么叫，是因为它们代表了某种协议。</p><p id="edf2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">用于编写智能合同的编程语言。因此，请确保在编码时在软件工具中安装了这个扩展。坚固性类似于java-script。</p><p id="c7bf" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu"> <em class="ka">案例分析</em> : </strong>在区块链上构建一个投票应用，任何连接到网络的人都可以参与选举并投票结果。</p><p id="2b0a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们理解它是如何工作的:</p><p id="86ac" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">公共分类账中的所有数据都通过<em class="ka">加密哈希</em>进行保护，并通过共识算法进行验证。网络上的节点参与进来，以确保分布在网络上的所有数据副本都是相同的。这是在区块链上构建投票应用程序的一个非常重要的原因，因为我们希望确保我们的投票被计算在内，并且不会改变。</p><p id="072a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们应用程序的用户在区块链上投票会是什么样子？首先，用户需要一个账户，这个账户的钱包地址要有一些以太，以太坊的加密货币。一旦他们连接到网络，他们投下他们的选票，并支付少量交易费，以将此交易写入区块链。这笔交易费被称为<em class="ka">气</em>。每当投票时，网络上的一些称为矿工的节点竞争完成这一事务。完成这项交易的矿工将获得我们投票购买的乙醚。</p><p id="e3d3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们有一个用HTML、CSS和Javascript编写的传统前端客户端。这个客户端将连接到一个本地以太坊区块链，而不是与后端服务器对话。让我们用Solidity编程语言在一个选举智能契约中编码关于我们的dApp的所有业务逻辑。让我们将这个智能合约部署到我们的本地以太网区块链，并允许帐户开始投票。</p><p id="ea65" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们的最终输出将如下所示:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/7a5b28ee994ce62dacc7a738bc20f443.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3BKsHH3aWLvOgAKzQ_1FA.png"/></div></div></figure><p id="0d8e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">DApp以太坊全栈建筑循序渐进指南。</strong></p><p id="da02" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第一步:安装依赖关系</strong></p><p id="a734" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">I)节点包管理器(NPM)</p><p id="85ad" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">您可以查看是否已经安装了节点，方法是在终端上键入:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="8043" class="kl km ht kh b fv kn ko l kp kq">$ node -v</span></pre><p id="ef51" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">ii)块菌框架</p><p id="8f1a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">它允许我们在以太坊区块链上构建分散的应用程序。</p><p id="718b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在命令行中安装带有NPM的松露，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="66a2" class="kl km ht kh b fv kn ko l kp kq">$ npm install -g truffle</span></pre><p id="02c7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">成功安装后，您将获得以下内容:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/3d6e102481a019f73f5c6451d99ef8e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wg4DNXAl61WqgtNv_j8S1Q.png"/></div></div></figure><p id="3390" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">三)加纳切</p><p id="7227" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下一个依赖项是<a class="ae jz" href="http://truffleframework.com/ganache" rel="noopener ugc nofollow" target="_blank"> Ganache </a>，一个本地内存区块链。你可以从Truffle框架网站下载<a class="ae jz" href="http://truffleframework.com/ganache" rel="noopener ugc nofollow" target="_blank">来安装Ganache。它会给我们10个外部帐户的地址在我们当地的以太坊区块链。每个账户都预装了100个假乙醚。</a></p><p id="d403" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">成功安装后，您应该会看到以下内容:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/ad9a862458e0adb370bcc43cbf824789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UlK_RfKm5ho_PvkHSRWnYQ.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/d1a39f13f396119258574a978824b0fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TpQmb2FN0L-QjapxxwjnqQ.png"/></div></div></figure><p id="eb86" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">iv)元掩模</p><p id="6b2a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下一个依赖项是Google Chrome 的<a class="ae jz" href="https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn?hl=en" rel="noopener ugc nofollow" target="_blank">元掩码扩展。为了使用区块链，我们必须连接到它。为了使用以太坊区块链，我们必须安装一个特殊的浏览器扩展。这就是metamask的用武之地。我们将能够用我们的个人账户连接到我们当地的以太坊区块链，并与我们的智能合约进行交互。</a></p><p id="14ed" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">安装Chrome浏览器后，你会在浏览器的右上角看到狐狸图标。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/0e5d7390a6e223717d5557c6165673ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQWBfRSNZOevkz7LQU1JrQ.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Browse for Meta Mask and Click Add to Chrome</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/e5ac4dbd0d39d8025295f48d64cc8229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sok_Z0u5GIWv7NauMHA5pQ.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/b7e9884051d480e6fe506133c9e62ea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Z2bM8kQeqK2PDc_-gpXKw.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Create a Wallet if you are using it for the first time if not import Wallet using the Saved Seed</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/b218a61b79d46d0798cf6d3a3b6a2efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4qcZ0Y9FNQQ0Zffz0VMGA.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">On Completion this is how your wallet would look like!</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/7ed6da00265becea39df95d377a7c7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOnSujBB6gJZtpwdhvBjXg.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">You can Deposit/Send some ethers using the available Networks</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/7a79712cd16e5625e0fb84cd667eed28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k2sesfZUScFjSKH0nV0gaw.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Depositing Ether from a Test Faucet of the Ropsten Network</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/1b8006aba796396e1e196b73b970988d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-56vv-Xsa9k6h001gZpleg.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Requesting 1 Ether from Faucet (Green Highlight)</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/1287b5d0dd0044fc1567b83621aefa16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9tKpAdVdWb8Uae0bXAMzmQ.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Connecting to your Account to deposit Ether</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/07a97c88eeb1ba78fe3270a591d0abfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZFaWlZFAC4DL24et_wyRqA.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Ether Successfully got Deposited.</figcaption></figure><p id="0e58" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">v)语法突出显示</p><p id="f9be" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这种依赖是可选的，但是推荐使用。我们将使用<a class="ae jz" href="https://www.sublimetext.com/" rel="noopener ugc nofollow" target="_blank">崇高文本</a>，我已经下载了<a class="ae jz" href="https://packagecontrol.io/packages/Ethereum" rel="noopener ugc nofollow" target="_blank">“以太坊”软件包</a>，它为可靠性提供了很好的语法高亮。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/edd402924f737803d02aed261500f90a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VbnygBa5gWSj1FBWxLvnoA.png"/></div></div></figure><p id="0e70" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第二步:冒烟测试</strong></p><p id="afd9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">I)打开Ganache。现在，Ganache已经启动，您有一个本地区块链运行。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kv"><img src="../Images/7a17f20001a1187ce5fd5d29d9c2d56a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qAmFoR1gmn2I96oVlvcM2A.gif"/></div></div></figure><p id="96c6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">ii)创建选举文件夹</p><p id="fefa" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在命令行中为我们的dApp创建一个项目目录，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="0753" class="kl km ht kh b fv kn ko l kp kq">$ mkdir election<br/>$ cd election</span></pre><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/28be98af415a59d064acc8def982fca5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aL3XFKTnVSWr3PiQWYVOxA.png"/></div></div></figure><p id="a527" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们已经进入了我们的项目，我们可以用一个<a class="ae jz" href="http://truffleframework.com/boxes/" rel="noopener ugc nofollow" target="_blank">块菌盒子</a>快速启动并运行。在您的项目目录中，从命令行安装pet shop box，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="36d8" class="kl km ht kh b fv kn ko l kp kq">$ truffle unbox pet-shop</span></pre><p id="a608" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们看看宠物店盒子给了我们什么:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/51af13f561ae107876f5fc9163c4f044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4CC9dt-4oiuNz_-LLJx5cQ.png"/></div></div></figure><p id="0ab8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">检查选举文件夹目录。您可以看到所有文件拆箱，如合同文件夹，迁移文件夹，测试文件夹等。</p><p id="544e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">iii)撰写智能合同</p><p id="64b3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这个智能合同将包含我们dApp的所有业务逻辑。它将负责读取和写入以太坊区块链。它将允许我们列出将参加选举的候选人，并跟踪所有的选票和选民。它还将管理选举的所有规则，比如强制帐户只能投票一次。从项目的根目录开始，在contracts目录中创建一个新的合同文件，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="845f" class="kl km ht kh b fv kn ko l kp kq">$ touch contracts/Election.sol</span></pre><p id="7582" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">打开文件并键入以下代码:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="1203" class="kl km ht kh b fv kn ko l kp kq">pragma solidity 0.5.16;</span><span id="d6e5" class="kl km ht kh b fv kw ko l kp kq">contract Election {<br/>    // Read/write candidate<br/>    string <strong class="kh hu">public</strong> candidate;</span><span id="b556" class="kl km ht kh b fv kw ko l kp kq">    // Constructor<br/>    constructor() <strong class="kh hu">public</strong> {<br/>        candidate = "Donald Trump";<br/>    }<br/>}</span></pre><p id="c951" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们从用<code class="eh kx ky kz kh b">pragma solidity</code>语句声明solidity版本开始。接下来，我们用“contract”关键字声明智能合约，后跟合约名称。接下来，我们声明一个状态变量，它将存储候选人姓名的值。状态变量允许我们将数据写入区块链。我们已经声明这个变量将是一个字符串，并且我们已经将它的可见性设置为<code class="eh kx ky kz kh b">public</code>。因为它是公共的，solidity将免费给我们一个getter函数，允许我们在契约之外访问这个值。</p><p id="c3ce" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然后，我们创建一个构造函数，每当我们将智能合约部署到区块链时，都会调用这个构造函数。在这里，我们将设置候选状态变量的值，该变量将在迁移时存储到区块链中。</p><p id="b501" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，我们已经为智能合约创建了基础，让我们看看是否可以将它部署到区块链。为此，我们需要在迁移目录中创建新文件。从项目根目录中，通过命令行创建一个新文件，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="c61b" class="kl km ht kh b fv kn ko l kp kq">$ touch migrations/2_deploy_contracts.js</span></pre><p id="5ec5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">请注意，我们用数字给迁移目录中的所有文件编号，这样Truffle kno</p><p id="b533" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">以何种顺序执行它们。让我们创建一个新的迁移来部署合同，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="68fb" class="kl km ht kh b fv kn ko l kp kq"><strong class="kh hu">var</strong> Election = artifacts.require("./Election.sol");</span><span id="86bf" class="kl km ht kh b fv kw ko l kp kq">module.exports = <strong class="kh hu">function</strong>(deployer) {<br/>  deployer.deploy(Election);<br/>};</span></pre><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/3b1d0b440e00523bd61325a0ad48df37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Sn0Sef12-IXFvWfFd60YA.png"/></div></div></figure><p id="983c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">首先，我们需要我们已经创建的契约，并将其分配给一个名为“Election”的变量。接下来，我们将它添加到已部署契约的清单中，以确保它在我们运行迁移时得到部署。现在，让我们像这样从命令行运行我们的迁移:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="59b4" class="kl km ht kh b fv kn ko l kp kq">$ truffle migrate</span></pre><p id="5c58" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果您对代码进行了任何更改，然后想要迁移，请使用</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="d57f" class="kl km ht kh b fv kn ko l kp kq">$ truffle migrate --reset</span></pre><p id="7f6d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">成功迁移后，您将收到以下消息:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/52366c58b5e5cafeefffbb04102f3ed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WlXcRj_I1phgjsMPqWiT9A.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/500f47391fd1848b2a1efdda4bfd2410.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0L1DSxOUbfj4Vd0N3vZnzA.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Successful Migration!!</figcaption></figure><p id="be59" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们已经成功地将智能合约迁移到本地以太坊区块链，让我们打开控制台与智能合约进行交互。您可以从命令行打开truffle控制台，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="aa54" class="kl km ht kh b fv kn ko l kp kq">$ truffle console</span></pre><p id="415b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们已经进入了控制台，让我们获取一个已部署的智能契约的实例，看看是否可以从契约中读取候选人的姓名。从控制台中，运行以下代码:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="3deb" class="kl km ht kh b fv kn ko l kp kq">Election.deployed().then(<strong class="kh hu">function</strong>(instance) { app = instance })</span></pre><p id="bb6b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这里的<code class="eh kx ky kz kh b">Election</code>是我们在迁移文件中创建的变量的名称。我们用<code class="eh kx ky kz kh b">deployed()</code>函数检索了一个已部署的契约实例，并将其分配给promise回调函数中的一个<code class="eh kx ky kz kh b">app</code>变量。</p><p id="26e1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们可以这样读取候选变量的值:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="35e4" class="kl km ht kh b fv kn ko l kp kq">app.candidate()<br/>// =&gt; 'Donald Trump'</span></pre><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/a7ad9a70a5b95bc8b68a21d8790d0a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMDcM7YPzxBplwcWBnJuAw.png"/></div></div></figure><p id="24bf" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第三步:创建候选人名单</strong></p><p id="6788" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在一切都设置妥当了，让我们继续通过列出将参加选举的候选人来建立聪明的联系。我们需要一种方法来存储多个候选项，并存储每个候选项的多个属性。我们希望跟踪候选人的id、姓名和票数。以下是我们将如何模拟候选人。</p><p id="5031" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">您的完整合同代码应该如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="09fe" class="kl km ht kh b fv kn ko l kp kq">pragma solidity 0.5.16;</span><span id="121e" class="kl km ht kh b fv kw ko l kp kq">contract Election {<br/>    // Model a Candidate<br/>    <strong class="kh hu">struct</strong> Candidate {<br/>        <strong class="kh hu">uint</strong> id;<br/>        <strong class="kh hu">string</strong> name;<br/>        <strong class="kh hu">uint</strong> voteCount;<br/>    }</span><span id="7935" class="kl km ht kh b fv kw ko l kp kq">    // Read/write candidates<br/>    mapping(<strong class="kh hu">uint</strong> =&gt; Candidate) <strong class="kh hu">public</strong> candidates;</span><span id="f979" class="kl km ht kh b fv kw ko l kp kq">    // Store Candidates Count<br/>    <strong class="kh hu">uint</strong> <strong class="kh hu">public</strong> candidatesCount;</span><span id="5a6f" class="kl km ht kh b fv kw ko l kp kq">    function <strong class="kh hu">Election</strong> () <strong class="kh hu">public</strong> {<br/>        addCandidate("Donald Trump");<br/>        addCandidate("Narendra Modi");<br/>    }</span><span id="2a0b" class="kl km ht kh b fv kw ko l kp kq">    function <strong class="kh hu">addCandidate</strong> (<strong class="kh hu">string</strong> memory _name) <strong class="kh hu">private</strong> {<br/>        candidatesCount ++;<br/>        candidates[candidatesCount] = Candidate(candidatesCount, _name, 0);<br/>    }</span><span id="5d2f" class="kl km ht kh b fv kw ko l kp kq">}</span></pre><p id="8ec6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，让我们像这样迁移我们的合同:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="68db" class="kl km ht kh b fv kn ko l kp kq">$ truffle migrate --reset</span></pre><p id="236e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第四步:测试</strong></p><p id="0c42" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们写一些测试。确保首先运行Ganache。然后，在命令行中从项目的根目录创建一个新的测试文件，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="5bac" class="kl km ht kh b fv kn ko l kp kq">$ touch test/election.js</span></pre><p id="4c96" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们将使用Javascript编写所有这些测试来模拟客户端与智能合约的交互，就像我们在控制台中所做的一样。以下是测试的所有代码:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="513a" class="kl km ht kh b fv kn ko l kp kq"><strong class="kh hu">var</strong> Election = artifacts.<strong class="kh hu">require</strong>("./Election.sol");</span><span id="11b7" class="kl km ht kh b fv kw ko l kp kq">contract("Election", <strong class="kh hu">function</strong>(accounts) {<br/>  <strong class="kh hu">var</strong> electionInstance;</span><span id="0aa6" class="kl km ht kh b fv kw ko l kp kq">  it("initializes with two candidates", <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">return</strong> Election.deployed().then(<strong class="kh hu">function</strong>(instance) {<br/>      <strong class="kh hu">return</strong> instance.candidatesCount();<br/>    }).then(<strong class="kh hu">function</strong>(count) {<br/>      assert.equal(count, 2);<br/>    });<br/>  });</span><span id="a676" class="kl km ht kh b fv kw ko l kp kq">  it("it initializes the candidates with the correct values", <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">return</strong> Election.deployed().then(<strong class="kh hu">function</strong>(instance) {<br/>      electionInstance = instance;<br/>      <strong class="kh hu">return</strong> electionInstance.candidates(1);<br/>    }).then(<strong class="kh hu">function</strong>(candidate) {<br/>      assert.equal(candidate[0], 1, "contains the correct id");<br/>      assert.equal(candidate[1], "Donald Trump", "contains the correct name");<br/>      assert.equal(candidate[2], 0, "contains the correct votes count");<br/>      <strong class="kh hu">return</strong> electionInstance.candidates(2);<br/>    }).then(<strong class="kh hu">function</strong>(candidate) {<br/>      assert.equal(candidate[0], 2, "contains the correct id");<br/>      assert.equal(candidate[1], "Narendra Modi", "contains the correct name");<br/>      assert.equal(candidate[2], 0, "contains the correct votes count");<br/>    });<br/>  });<br/>});</span></pre><p id="421f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们从命令行运行测试，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="1ce9" class="kl km ht kh b fv kn ko l kp kq">$ truffle test</span></pre><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/078d9c4087d6f8d3b217f14dac52b5bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1NZrXCK8RJZvR1ULnITQJg.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Successful passing of 2 tests</figcaption></figure><p id="def0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">第一个测试通过检查候选人计数是否等于2来检查合同是否用正确的候选人数量进行了初始化。</p><p id="dce6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下一个测试检查选举中每个候选人的值，确保每个候选人都有正确的id、姓名和票数。</p><p id="8b39" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第五步:客户端应用</strong></p><p id="3b6e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们开始构建将与我们的智能合约对话的客户端应用程序。我们将通过修改上一节中安装的Truffle Pet Shop box附带的HTML和Javascript文件来实现这一点。</p><p id="b8b4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">用以下代码替换“index.html”文件的所有内容:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="ee5d" class="kl km ht kh b fv kn ko l kp kq">&lt;!DOCTYPE html&gt;<br/>&lt;<strong class="kh hu">html</strong> lang="en"&gt;<br/>  &lt;<strong class="kh hu">head</strong>&gt;<br/>    &lt;<strong class="kh hu">meta</strong> charset="utf-8"&gt;<br/>    &lt;<strong class="kh hu">meta</strong> http-equiv="X-UA-Compatible" content="IE=edge"&gt;<br/>    &lt;<strong class="kh hu">meta</strong> name="viewport" content="width=device-width, initial-scale=1"&gt;<br/>    &lt;<strong class="kh hu">title</strong>&gt;Election Results&lt;/<strong class="kh hu">title</strong>&gt;</span><span id="ca7b" class="kl km ht kh b fv kw ko l kp kq">    &lt;!-- Bootstrap --&gt;<br/>    &lt;<strong class="kh hu">link</strong> href="css/bootstrap.min.css" rel="stylesheet"&gt;<br/>  &lt;/<strong class="kh hu">head</strong>&gt;<br/>  &lt;<strong class="kh hu">body</strong>&gt;<br/>    &lt;<strong class="kh hu">div</strong> class="container" style="width: 650px;"&gt;<br/>      &lt;<strong class="kh hu">div</strong> class="row"&gt;<br/>        &lt;<strong class="kh hu">div</strong> class="col-lg-12"&gt;<br/>          &lt;<strong class="kh hu">h1</strong> class="text-center"&gt;Election Results&lt;/<strong class="kh hu">h1</strong>&gt;<br/>          &lt;<strong class="kh hu">hr</strong>/&gt;<br/>          &lt;<strong class="kh hu">br</strong>/&gt;<br/>          &lt;<strong class="kh hu">div</strong> id="loader"&gt;<br/>            &lt;<strong class="kh hu">p</strong> class="text-center"&gt;Loading...&lt;/<strong class="kh hu">p</strong>&gt;<br/>          &lt;/<strong class="kh hu">div</strong>&gt;<br/>          &lt;<strong class="kh hu">div</strong> id="content" style="display: none;"&gt;<br/>            &lt;<strong class="kh hu">table</strong> class="table"&gt;<br/>              &lt;<strong class="kh hu">thead</strong>&gt;<br/>                &lt;<strong class="kh hu">tr</strong>&gt;<br/>                  &lt;<strong class="kh hu">th</strong> scope="col"&gt;#&lt;/<strong class="kh hu">th</strong>&gt;<br/>                  &lt;<strong class="kh hu">th</strong> scope="col"&gt;Name&lt;/<strong class="kh hu">th</strong>&gt;<br/>                  &lt;<strong class="kh hu">th</strong> scope="col"&gt;Votes&lt;/<strong class="kh hu">th</strong>&gt;<br/>                &lt;/<strong class="kh hu">tr</strong>&gt;<br/>              &lt;/<strong class="kh hu">thead</strong>&gt;<br/>              &lt;<strong class="kh hu">tbody</strong> id="candidatesResults"&gt;<br/>              &lt;/<strong class="kh hu">tbody</strong>&gt;<br/>            &lt;/<strong class="kh hu">table</strong>&gt;<br/>            &lt;<strong class="kh hu">hr</strong>/&gt;<br/>            &lt;<strong class="kh hu">p</strong> id="accountAddress" class="text-center"&gt;&lt;/<strong class="kh hu">p</strong>&gt;<br/>          &lt;/<strong class="kh hu">div</strong>&gt;<br/>        &lt;/<strong class="kh hu">div</strong>&gt;<br/>      &lt;/<strong class="kh hu">div</strong>&gt;<br/>    &lt;/<strong class="kh hu">div</strong>&gt;</span><span id="b871" class="kl km ht kh b fv kw ko l kp kq">    &lt;!-- jQuery (necessary for Bootstrap's JavaScript plugins) --&gt;<br/>    &lt;<strong class="kh hu">script</strong> src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"&gt;&lt;/<strong class="kh hu">script</strong>&gt;<br/>    &lt;!-- Include all compiled plugins (below), or include individual files as needed --&gt;<br/>    &lt;<strong class="kh hu">script</strong> src="js/bootstrap.min.js"&gt;&lt;/<strong class="kh hu">script</strong>&gt;<br/>    &lt;<strong class="kh hu">script</strong> src="js/web3.min.js"&gt;&lt;/<strong class="kh hu">script</strong>&gt;<br/>    &lt;<strong class="kh hu">script</strong> src="js/truffle-contract.js"&gt;&lt;/<strong class="kh hu">script</strong>&gt;<br/>    &lt;<strong class="kh hu">script</strong> src="js/app.js"&gt;&lt;/<strong class="kh hu">script</strong>&gt;<br/>  &lt;/<strong class="kh hu">body</strong>&gt;<br/>&lt;/<strong class="kh hu">html</strong>&gt;</span></pre><p id="411c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，用以下代码替换“app.js”文件的所有内容:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="93cf" class="kl km ht kh b fv kn ko l kp kq">App = {<br/>  web3Provider: null,<br/>  contracts: {},<br/>  account: '0x0',</span><span id="ec01" class="kl km ht kh b fv kw ko l kp kq">  init: <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">return</strong> App.initWeb3();<br/>  },</span><span id="5fb1" class="kl km ht kh b fv kw ko l kp kq">  initWeb3: <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">if</strong> (<strong class="kh hu">typeof</strong> web3 !== 'undefined') {<br/>      // If a web3 instance is already provided by Meta Mask.<br/>      window.ethereum.enable();<br/>      App.web3Provider = web3.currentProvider;<br/>      web3 = <strong class="kh hu">new</strong> Web3(web3.currentProvider);<br/>    } <strong class="kh hu">else</strong> {<br/>      // Specify default instance if no web3 instance provided<br/>      App.web3Provider = <strong class="kh hu">new</strong> Web3.providers.HttpProvider('http://localhost:7545');<br/>      web3 = <strong class="kh hu">new</strong> Web3(App.web3Provider);<br/>    }<br/>    <strong class="kh hu">return</strong> App.initContract();<br/>  },</span><span id="e800" class="kl km ht kh b fv kw ko l kp kq">  initContract: <strong class="kh hu">function</strong>() {<br/>    $.getJSON("Election.json", <strong class="kh hu">function</strong>(election) {<br/>      // Instantiate a new truffle contract from the artifact<br/>      App.contracts.Election = TruffleContract(election);<br/>      // Connect provider to interact with contract<br/>      App.contracts.Election.setProvider(App.web3Provider);</span><span id="2744" class="kl km ht kh b fv kw ko l kp kq">      <strong class="kh hu">return</strong> App.render();<br/>    });<br/>  },</span><span id="109d" class="kl km ht kh b fv kw ko l kp kq">  render: <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">var</strong> electionInstance;<br/>    <strong class="kh hu">var</strong> loader = $("#loader");<br/>    <strong class="kh hu">var</strong> content = $("#content");</span><span id="1be4" class="kl km ht kh b fv kw ko l kp kq">    loader.show();<br/>    content.hide();</span><span id="d65f" class="kl km ht kh b fv kw ko l kp kq">    // Load account data<br/>    web3.eth.getCoinbase(<strong class="kh hu">function</strong>(err, account) {<br/>      <strong class="kh hu">if</strong> (err === null) {<br/>        App.account = account;<br/>        $("#accountAddress").html("Your Account: " + account);<br/>      }<br/>    });</span><span id="a724" class="kl km ht kh b fv kw ko l kp kq">    // Load contract data<br/>    App.contracts.Election.deployed().then(<strong class="kh hu">function</strong>(instance) {<br/>      electionInstance = instance;<br/>      <strong class="kh hu">return</strong> electionInstance.candidatesCount();<br/>    }).then(<strong class="kh hu">function</strong>(candidatesCount) {<br/>      <strong class="kh hu">var</strong> candidatesResults = $("#candidatesResults");<br/>      candidatesResults.empty();</span><span id="2145" class="kl km ht kh b fv kw ko l kp kq">      <strong class="kh hu">for</strong> (<strong class="kh hu">var</strong> i = 1; i &lt;= candidatesCount; i++) {<br/>        electionInstance.candidates(i).then(<strong class="kh hu">function</strong>(candidate) {<br/>          <strong class="kh hu">var</strong> id = candidate[0];<br/>          <strong class="kh hu">var</strong> name = candidate[1];<br/>          <strong class="kh hu">var</strong> voteCount = candidate[2];</span><span id="10eb" class="kl km ht kh b fv kw ko l kp kq">          // Render candidate Result<br/>          <strong class="kh hu">var</strong> candidateTemplate = "&lt;tr&gt;&lt;th&gt;" + id + "&lt;/th&gt;&lt;td&gt;" + name + "&lt;/td&gt;&lt;td&gt;" + voteCount + "&lt;/td&gt;&lt;/tr&gt;"<br/>          candidatesResults.append(candidateTemplate);<br/>        });<br/>      }</span><span id="821d" class="kl km ht kh b fv kw ko l kp kq">      loader.hide();<br/>      content.show();<br/>    }).catch(<strong class="kh hu">function</strong>(error) {<br/>      console.warn(error);<br/>    });<br/>  }<br/>};</span><span id="9767" class="kl km ht kh b fv kw ko l kp kq">$(<strong class="kh hu">function</strong>() {<br/>  $(window).load(<strong class="kh hu">function</strong>() {<br/>    App.init();<br/>  });<br/>});</span></pre><p id="0ebb" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae jz" href="https://web3js.readthedocs.io/en/1.0/" rel="noopener ugc nofollow" target="_blank"> <em class="ka"> web3.js </em> </a>是一个javascript库，允许我们的客户端应用程序与区块链对话。它是一个库的集合，允许你使用HTTP、IPC或WebSocket与本地或远程以太坊节点进行交互。我们在“initWeb3”函数中配置web3。</p><p id="ae5f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">App.js代码执行以下操作:</p><ol class=""><li id="938b" class="la lb ht jd b je jf ji jj jm lc jq ld ju le jy lf lg lh li dt translated">初始化契约:我们在这个函数中获取智能契约的已部署实例，并分配一些允许我们与之交互的值。</li><li id="9ead" class="la lb ht jd b je lj ji lk jm ll jq lm ju ln jy lf lg lh li dt translated">Render函数:render函数使用智能合约中的数据来布局页面上的所有内容。现在，我们列出我们在智能合同中创建的候选人。我们通过遍历映射中的每个候选项，并将其呈现到表中来实现这一点。我们还在这个函数中获取连接到区块链的当前帐户，并将其显示在页面上</li></ol><p id="0803" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们在浏览器中查看客户端应用程序。首先，确保您已经像这样迁移了合同:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="73a0" class="kl km ht kh b fv kn ko l kp kq">$ truffle migrate --reset</span></pre><p id="91a5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，从命令行启动开发服务器，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="de13" class="kl km ht kh b fv kn ko l kp kq">$ npm run dev</span></pre><p id="cc1d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这应该会自动打开一个包含您的客户端应用程序的新浏览器窗口。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/cb3a4ebb1da22e7f4ede0be3e3ab7b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*87k0IY95Ik_fr_I4R8S0lA.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/be7010e49339d03b716ca9d03e00f993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UOk5SJxwaDhaaIZetDSqBA.png"/></div></div></figure><p id="2bd7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">请注意，您的应用程序显示“正在加载…”。那是因为我们还没有登录到区块链！为了连接到区块链，我们需要将其中一个帐户从Ganache导入Metamask。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/80ae3084f3327c33bc07882356389283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujxTakZED_iUc4wP1PJvzg.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Connecting to Metamask</figcaption></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/a9a4dd297d46ac221b55df5cd76ad3b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-vcyPomOJRvfV_y6odXmlA.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Connected to Metamask</figcaption></figure><p id="ebb6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为了更新帐号，请确保在其中一个配置文件中将注入的Web组件设置为true。应该通过选择custom RPC将网络设置为localhost:7545，并输入来自ganache的任何地址的私钥。</p><p id="da2b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">打开Ganache，点击任意键(图标)选择私钥。将会弹出以下内容。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/163cea843344e82d585ea34b29611aa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7vMSI66Fp_Rhe9x9eb0DuA.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/8734371e362080bf0e5cf18691f8cb9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UhJj8ZczmsQ4UbltqBkx5A.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/e41fb98b326c60fdd0be18e98e3b9826.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xleup945pW7nMW-X8unw3w.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Click on Import option and paste the private key</figcaption></figure><p id="4fe0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">第六步:投票</strong></p><p id="9569" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们添加在选举中投票的能力。让我们定义一个映射到智能契约的“选民”来跟踪在选举中投票的帐户。</p><p id="4c5d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">完整的合同代码应该如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="1109" class="kl km ht kh b fv kn ko l kp kq">pragma solidity 0.5.16;</span><span id="baa8" class="kl km ht kh b fv kw ko l kp kq">contract Election {<br/>    // Model a Candidate<br/>    <strong class="kh hu">struct</strong> Candidate {<br/>        <strong class="kh hu">uint</strong> id;<br/>        <strong class="kh hu">string</strong> name;<br/>        <strong class="kh hu">uint</strong> voteCount;<br/>    }</span><span id="6703" class="kl km ht kh b fv kw ko l kp kq">    // Store accounts that have voted<br/>    mapping(address =&gt; <strong class="kh hu">bool</strong>) <strong class="kh hu">public</strong> voters;<br/>    // Read/write candidates<br/>    mapping(<strong class="kh hu">uint</strong> =&gt; Candidate) <strong class="kh hu">public</strong> candidates;<br/>    // Store Candidates Count<br/>    <strong class="kh hu">uint</strong> <strong class="kh hu">public</strong> candidatesCount;</span><span id="8dd0" class="kl km ht kh b fv kw ko l kp kq">    constructor () <strong class="kh hu">public</strong> {<br/>        addCandidate("Donald Trump");<br/>        addCandidate("Narendra Modi");<br/>    }</span><span id="e8e9" class="kl km ht kh b fv kw ko l kp kq">    function <strong class="kh hu">addCandidate</strong> (<strong class="kh hu">string memory</strong> _name) <strong class="kh hu">private</strong> {<br/>        candidatesCount ++;<br/>        candidates[candidatesCount] = Candidate(candidatesCount, _name, 0);<br/>    }</span><span id="9260" class="kl km ht kh b fv kw ko l kp kq">    function <strong class="kh hu">vote</strong> (<strong class="kh hu">uint</strong> _candidateId) <strong class="kh hu">public</strong> {<br/>        // require that they haven't voted before<br/>        require(!voters[msg.sender]);</span><span id="a4b6" class="kl km ht kh b fv kw ko l kp kq">        // require a valid candidate<br/>        require(_candidateId &gt; 0 &amp;&amp; _candidateId &lt;= candidatesCount);</span><span id="13de" class="kl km ht kh b fv kw ko l kp kq">        // record that voter has voted<br/>        voters[msg.sender] = true;</span><span id="7d0f" class="kl km ht kh b fv kw ko l kp kq">        // update candidate vote Count<br/>        candidates[_candidateId].voteCount ++;<br/>    }<br/>}</span></pre><p id="2759" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">步骤7:测试投票功能</strong></p><p id="eb54" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们向“election.js”测试文件添加一个测试:</p><p id="6673" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们想在这里测试两件事:</p><ol class=""><li id="22b0" class="la lb ht jd b je jf ji jj jm lc jq ld ju le jy lf lg lh li dt translated">测试该函数是否会增加候选人的投票数。</li><li id="0830" class="la lb ht jd b je lj ji lk jm ll jq lm ju ln jy lf lg lh li dt translated">测试投票人在投票时是否被添加到映射中。</li></ol><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/f005adcf1cf6f28770f9a7a1b07efe82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l6lxHju4BuzaYLddGdl1Wg.png"/></div></div></figure><p id="e01c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">测试以确保我们的vote函数对双重投票和无效候选人抛出异常。</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/0bb356a2c710f7da883ee8076b1cab33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YUVlc9A7DerjuFB4kKhSqw.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/d109d3558a4aef7899c6dfb1f7374005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EaoFLpw8vL64bNnGJd-R4Q.png"/></div></div></figure><p id="3bff" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">所有测试成功通过！！</p><p id="193d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">步骤8:客户端投票</strong></p><p id="8c57" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们在“index.html”文件中添加一个允许帐户在表格下方投票的表单:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="2542" class="kl km ht kh b fv kn ko l kp kq">&lt;<strong class="kh hu">form</strong> onSubmit="App.castVote(); return false;"&gt;<br/>  &lt;<strong class="kh hu">div</strong> class="form-group"&gt;<br/>    &lt;<strong class="kh hu">label</strong> for="candidatesSelect"&gt;Select Candidate&lt;/<strong class="kh hu">label</strong>&gt;<br/>    &lt;<strong class="kh hu">select</strong> class="form-control" id="candidatesSelect"&gt;<br/>    &lt;/<strong class="kh hu">select</strong>&gt;<br/>  &lt;/<strong class="kh hu">div</strong>&gt;<br/>  &lt;<strong class="kh hu">button</strong> type="submit" class="btn btn-primary"&gt;Vote&lt;/<strong class="kh hu">button</strong>&gt;<br/>  &lt;<strong class="kh hu">hr</strong> /&gt;<br/>&lt;/<strong class="kh hu">form</strong>&gt;</span></pre><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/a1b76c2c09f4b8d47da7aa8f8ad79668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dIffIOIGBn2Vy6e8W84TsA.png"/></div></div></figure><p id="43a4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们更新我们的app.js文件来处理这两件事。首先，我们在表单的select元素中列出智能合同的所有候选人。然后，一旦帐户投票，我们将隐藏页面上的表单。我们将更新渲染函数，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="a812" class="kl km ht kh b fv kn ko l kp kq">render: <strong class="kh hu">function</strong>() {<br/>  <strong class="kh hu">var</strong> electionInstance;<br/>  <strong class="kh hu">var</strong> loader = $("#loader");<br/>  <strong class="kh hu">var</strong> content = $("#content");</span><span id="183f" class="kl km ht kh b fv kw ko l kp kq">  loader.show();<br/>  content.hide();</span><span id="2d8f" class="kl km ht kh b fv kw ko l kp kq">  // Load account data<br/>  web3.eth.getCoinbase(<strong class="kh hu">function</strong>(err, account) {<br/>    <strong class="kh hu">if</strong> (err === null) {<br/>      App.account = account;<br/>      $("#accountAddress").html("Your Account: " + account);<br/>    }<br/>  });</span><span id="2851" class="kl km ht kh b fv kw ko l kp kq">  // Load contract data<br/>  App.contracts.Election.deployed().then(<strong class="kh hu">function</strong>(instance) {<br/>    electionInstance = instance;<br/>    <strong class="kh hu">return</strong> electionInstance.candidatesCount();<br/>  }).then(<strong class="kh hu">function</strong>(candidatesCount) {<br/>    <strong class="kh hu">var</strong> candidatesResults = $("#candidatesResults");<br/>    candidatesResults.empty();</span><span id="9a00" class="kl km ht kh b fv kw ko l kp kq">    <strong class="kh hu">var</strong> candidatesSelect = $('#candidatesSelect');<br/>    candidatesSelect.empty();</span><span id="0ea1" class="kl km ht kh b fv kw ko l kp kq">    <strong class="kh hu">for</strong> (<strong class="kh hu">var</strong> i = 1; i &lt;= candidatesCount; i++) {<br/>      electionInstance.candidates(i).then(<strong class="kh hu">function</strong>(candidate) {<br/>        <strong class="kh hu">var</strong> id = candidate[0];<br/>        <strong class="kh hu">var</strong> name = candidate[1];<br/>        <strong class="kh hu">var</strong> voteCount = candidate[2];</span><span id="5881" class="kl km ht kh b fv kw ko l kp kq">        // Render candidate Result<br/>        <strong class="kh hu">var</strong> candidateTemplate = "&lt;tr&gt;&lt;th&gt;" + id + "&lt;/th&gt;&lt;td&gt;" + name + "&lt;/td&gt;&lt;td&gt;" + voteCount + "&lt;/td&gt;&lt;/tr&gt;"<br/>        candidatesResults.append(candidateTemplate);</span><span id="0263" class="kl km ht kh b fv kw ko l kp kq">        // Render candidate ballot option<br/>        <strong class="kh hu">var</strong> candidateOption = "&lt;option value='" + id + "' &gt;" + name + "&lt;/ option&gt;"<br/>        candidatesSelect.append(candidateOption);<br/>      });<br/>    }<br/>    <strong class="kh hu">return</strong> electionInstance.voters(App.account);<br/>  }).then(<strong class="kh hu">function</strong>(hasVoted) {<br/>    // Do not allow a user to vote<br/>    <strong class="kh hu">if</strong>(hasVoted) {<br/>      $('form').hide();<br/>    }<br/>    loader.hide();<br/>    content.show();<br/>  }).catch(<strong class="kh hu">function</strong>(error) {<br/>    console.warn(error);<br/>  });<br/>}</span></pre><p id="e8a5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，我们想编写一个函数，每当提交表单时都会调用这个函数:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="97e1" class="kl km ht kh b fv kn ko l kp kq">castVote: <strong class="kh hu">function</strong>() {<br/>    <strong class="kh hu">var</strong> candidateId = $('#candidatesSelect').val();<br/>    App.contracts.Election.deployed().then(<strong class="kh hu">function</strong>(instance) {<br/>      <strong class="kh hu">return</strong> instance.vote(candidateId, { from: App.account });<br/>    }).then(<strong class="kh hu">function</strong>(result) {<br/>      // Wait for votes to update<br/>      $("#content").hide();<br/>      $("#loader").show();<br/>    }).catch(<strong class="kh hu">function</strong>(err) {<br/>      console.error(err);<br/>    });<br/>  }</span></pre><p id="c2f7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，您的前端应用程序应该如下所示:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/02b139a746f5a7d969e63d41976a9a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4FRTkAiSD_Bh16EbIRjm6g.png"/></div></div></figure><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kb"><img src="../Images/5a270d9bbf8879534f858a336abf9954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQhig2SE4Zl38EX_EeTqBA.png"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Connect to Metamask to update your account number and cast vote</figcaption></figure><p id="0170" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">注意</strong>:对于最新的Metamask用户，隐私模式是Metamask的默认模式，他们需要在浏览器的控制台中输入window.ethereum.enable()或者需要包含在代码中。我已经在app.js代码中包含了这一行。不包括这行代码将导致帐户为空，如上面的浏览器所示。</p><p id="50f0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们看看投票应用程序是如何工作的:</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div class="fe ff lo"><img src="../Images/f9ed817413b8de28f332e3c0ef904a96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/1*3mKsaaXo99uOddw_yp8kEQ.gif"/></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">Voting Demo</figcaption></figure><p id="441d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">正如你在上面的gif中看到的，按照我们的测试案例，你只能从一个账户投票一次。双重投票导致投票失败。还要注意，一旦你投了票，就会扣除“气”(金额)(100ETH -&gt;99.9987ETH -&gt;99.9982ETH)。从导入的列表中选择其他帐户来投更多的票。</p><p id="41ad" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">一旦你完成了这一步，你就已经成功地在以太坊区块链上构建了一个完整的分布式应用程序！</p><figure class="kc kd ke kf fq iu fe ff paragraph-image"><div class="fe ff lp"><img src="../Images/e086437d08df975749d96ea12c41d62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/1*5jHaguUhchBdS4jyDW69GA.gif"/></div></figure><blockquote class="lq"><p id="9efa" class="lr ls ht bd lt lu lv lw lx ly lz jy ek translated"><a class="ae jz" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mb mc md me mf iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ma"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>