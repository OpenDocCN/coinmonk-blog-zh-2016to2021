<html>
<head>
<title>A ‘real-world’ framework for backtesting Uniswap V3 strategies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于回溯测试Uniswap V3策略的“真实世界”框架</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/a-real-world-framework-for-backtesting-uniswap-v3-strategies-88825abdcd17?source=collection_archive---------0-----------------------#2021-07-14">https://medium.com/coinmonks/a-real-world-framework-for-backtesting-uniswap-v3-strategies-88825abdcd17?source=collection_archive---------0-----------------------#2021-07-14</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="0ac9" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">为回测Uni_V3职位提供简单快捷的工作流程和webapp</h2></div><p id="9522" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">随着Uniswap v3的推出，流动性提供者缺乏一种好的方法来评估任意范围内的头寸表现。在下面的文章中，我将描述一个简单的工作流程来计算动态和被动头寸的回报。我还将展示一个运行ETH/USDC 0.30%费用池的例子。下面描述的工作流程已经在下面的<a class="ae ke" href="https://backtesting.credmark.com/" rel="noopener ugc nofollow" target="_blank">公众webapp中实现。</a></p><h1 id="f8f8" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw dt translated">第一部分:一个“真实世界”的回溯测试框架</h1><p id="5f6b" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">与其他LP选项相比，Uniswap V3的主要区别在于可以设置自定义价格范围来提供流动性。这导致流动性的动态分布，每次LPs建立或烧毁头寸时都会发生变化，因此为了计算头寸的应计费用(定义为价格范围(pa，pb)和提供的总流动性),我们必须计算该头寸在每次互换中拥有的活跃流动性份额。鉴于上述情况，我建议采用以下工作流程对Uniswap V3职位的绩效进行回溯测试:</p><p id="3751" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu"><em class="lc">1</em></strong><em class="lc"/><strong class="jk hu"><em class="lc">下载给定数据帧的池的所有交换</em> </strong> <em class="lc">。</em></p><p id="4c3e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="lc">工具:图表</em></p><blockquote class="ld le lf"><p id="7048" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated"><strong class="jk hu"> 2下载池流动性历史数据</strong>。</p><p id="6168" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">为了获得最准确的结果，建议使用web3客户端查询归档节点或Uniswap v3 Oracle，并获取每个数据块中的历史活跃流动性，但为了加快计算速度并将其公之于众，我在图中使用了当前可用的最大粒度(每小时数据)。使用revert.finance数据进行的一些交叉检查显示，当使用每小时数据和简单头寸(没有重新平衡)进行测试时，精确度约为+/-5%。</p><p id="54ef" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">工具:带归档节点访问或图形的Web3客户端</p><p id="a003" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated"><strong class="jk hu"> 3将互换数据与流动性数据</strong>、<em class="ht">合并，以了解互换发生时的活跃流动性。对于这个例子，我们假设全天的流动性保持不变。</em></p><p id="4563" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated"><strong class="jk hu"> 4定义一个模拟位置</strong>。<em class="ht">头寸被定义为(流动性，分笔成交点_下限，分笔成交点_上限)的组合。流动性是使用“liquidityforamounts”公式和以下参数计算的:初始资本金额($)、铸币价格和头寸范围(tick_lower，tick_upper)。流动性将保持不变，直到执行额外的添加或刻录。</em></p><p id="323e" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated"><em class="ht">工具:liquidityformounts @ liquidity amounts . sol或者我自己的</em><a class="ae ke" href="https://github.com/JNP777/UNI_V3-Liquitidy-amounts-calcs/blob/main/UNI_v3_funcs.py" rel="noopener ugc nofollow" target="_blank"><em class="ht">python的</em> </a> <em class="ht">包装器。</em></p><p id="3885" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated"><strong class="jk hu"> 5计算职位的PNL。</strong>对于回溯测试池中执行的每个互换，我们计算头寸产生的费用和头寸的实际非永久性损失(IL)。</p><p id="538a" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">-应计费用=Swap_amountIn*fee_tier*(头寸_流动性/活跃_流动性)</p><p id="b17f" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">-IL = LP代币的价值-持有初始流动性的价值</p><p id="76f9" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">-天然气成本薄荷= 500000 gwei *天然气价格</p><p id="ec6e" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">-PNL =累计费用_应计(发电时的美元值)- IL -Gas_costs_mint</p></blockquote><p id="169f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">-APR=PNL/Initial_capital*(职位年龄/年时间)</p><blockquote class="ld le lf"><p id="fec2" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">工具:<em class="ht">amountsforliquidity @ liquidity amounts . sol或者我自己的</em><a class="ae ke" href="https://github.com/JNP777/UNI_V3-Liquitidy-amounts-calcs/blob/main/UNI_v3_funcs.py" rel="noopener ugc nofollow" target="_blank"><em class="ht">python的</em> </a> <em class="ht">包装器。</em></p></blockquote><h1 id="8a5c" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw dt translated">第二部分:工作流的真实测试</h1><p id="b257" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">我已经在一个简单但强大的<a class="ae ke" href="http://34.241.148.133:8501/" rel="noopener ugc nofollow" target="_blank"> webapp </a>中实现了所描述的工作流程，我将在一个由<a class="ae ke" href="https://revert.finance/#/uniswap-position/27782" rel="noopener ugc nofollow" target="_blank"> ameen.eth </a>创建并在<a class="ae ke" href="https://twitter.com/ameensol/status/1403727891217584130" rel="noopener ugc nofollow" target="_blank"> twitter </a>上广泛讨论的真实职位上对其进行测试。</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="fe ff lj"><img src="../Images/eb4a258eeb1e3083c058d693367dc332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7eWLrA8422NCaOvl"/></div></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek"><a class="ae ke" href="https://revert.finance/#/uniswap-position/27782" rel="noopener ugc nofollow" target="_blank">Example of a real not rebalanced position for the UTH/USDC 0,3 % pool</a></figcaption></figure><p id="ae1d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该职位只有一个mint事务，我可以从中获取所需的参数，以便在web应用程序中进行测试:</p><p id="ae3a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">-铸币厂的日期时间</strong>:2021年5月29日下午3点56分</p><p id="e00c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">-初始资本(造币时)</strong> : 251.271，59美元USDC + 229696，3美元ETH = 480967，89美元=481.000美元</p><p id="e750" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">-价格范围:</strong> 1844，6164–2858，3641瑞士联邦理工学院/USDC</p><p id="21f8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">-汽油费用(在造币厂的时候)</strong>:17.01美元(44克威)</p><p id="1391" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该应用程序将执行上述回溯测试，并将显示自该头寸创建以来的应计费用、非永久性损失、gas_costs和PNL的变化:</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/a81737164bc98525a58a1e9abba9872b.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/0*XfCVC583PNfqVnjD"/></div></figure><p id="75db" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu"> <em class="lc">我们可以看到结果非常接近</em></strong><a class="ae ke" href="http://revert.finance" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu"><em class="lc">revert . finance</em></strong></a><strong class="jk hu"><em class="lc">数据，预测的APR </em> </strong> <em class="lc">与</em> <strong class="jk hu"> <em class="lc"> </em> </strong> <em class="lc">偏差仅为0.5%，应计费用为-1%，IL为+2%(主要是因为用于计算的价格差异很小)。</em></p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/21dd49b7dfe69f95fc466682d937928f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nkToI9x5pDMgh40V"/></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek">Screenshot of the webapp for backtesting Uniswap v3 positions</figcaption></figure><h1 id="12ea" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw dt translated">第三部分:使用动态流动性准备金进行回溯测试</h1><p id="28bb" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">那么，如果ameen.eth决定成为一个积极的流动性提供者会怎么样呢？为了回答这个问题，在本节中，我将测试从窄到宽的布林线的四种动态策略，并看看与被动策略相比会有什么结果(尽管肯定会有所不同，因为ameen.eth的参数范围选择表现得非常好，他大部分时间都在范围内)。</p><p id="9d92" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">选择的4个测试布林线策略是:</p><p id="651e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">1-范围+/-0.25 * STD _ 7D</p><p id="198c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">双量程+/- 1*STD_7D</p><p id="cc9e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">3量程+/- 2*STD_7D</p><p id="2010" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">4档+/- 4*STD_7D</p><h2 id="4963" class="ma kg ht bd kh mb mc md kl me mf mg kp jr mh mi kr jv mj mk kt jz ml mm kv mn dt translated">重新平衡方法:</h2><p id="56ec" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">只要我们的头寸超出范围，并且仅持有池中的一个令牌，就会触发重新平衡。</p><p id="829d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">一旦触发了重新平衡:</p><ul class=""><li id="93a2" class="mo mp ht jk b jl jm jo jp jr mq jv mr jz ms kd mt mu mv mw dt translated">该算法将采取一个新的立场，重新部署正是初始资本。</li><li id="5651" class="mo mp ht jk b jl mx jo my jr mz jv na jz nb kd mt mu mv mw dt translated">新头寸的价格范围相当于实际价格+/-策略的相应布林线。</li><li id="f246" class="mo mp ht jk b jl mx jo my jr mz jv na jz nb kd mt mu mv mw dt translated">考虑到要部署的资本和新的价格范围，计算所需令牌的数量。因为将需要互换来调整代币之间的数量关系，所以增加了汽油成本(120000汽油)。</li><li id="47b0" class="mo mp ht jk b jl mx jo my jr mz jv na jz nb kd mt mu mv mw dt translated">增加了造币厂位置的气体成本(500000气体)</li><li id="a94a" class="mo mp ht jk b jl mx jo my jr mz jv na jz nb kd mt mu mv mw dt translated">当我们交换剩余令牌来调整它们之间的关系并建立新的头寸而不是等待反转时，非永久性损失就会累积。</li></ul><h2 id="9240" class="ma kg ht bd kh mb mc md kl me mf mg kp jr mh mi kr jv mj mk kt jz ml mm kv mn dt translated">结果</h2><p id="fbe5" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">尽管本分析并非试图对潜在的做市策略进行详尽的分析，但其结果对于理解Uniswap v3中不同流动性提供方法的动态非常有用。</p><blockquote class="ld le lf"><p id="d811" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">该分析的主要目的之一是用图表显示积极流动性提供者的主要敌人是非永久性损失的积累，而不是天然气成本的积累。</p></blockquote><p id="9a94" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">首先，对5次回测的PNL进行比较:</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/cab8f6c04a8705853aaeaf4c152cb2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zi8NrtdM7wQT12lj"/></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek">PNL comparison of a passive strategy vs 4 dynamic strategies</figcaption></figure><p id="8235" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">尽管结果不一定适用于其他组合，但我们可以看到，在ETH/USDC 0.30%组合中，采用动态策略导致的损失随着范围变窄而增加。</p><p id="b478" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了详细分析这种策略是如何演变的，让我们来详细了解一下:</p><p id="a37c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">— 1头寸的价格范围</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/f283e840b4aeef4f641bfe82e018fdcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kczw-rg1BlkwhC6d"/></div></figure><p id="ef7f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">— 2四大战略的PNL详细结果</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="fe ff nc"><img src="../Images/914e355bbfe0dbb65cfb95906f78bc91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yVHACvmC82lp10FoCV3Xlg.png"/></div></div></figure><p id="f356" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">从上面的图表中可以看出，获胜策略(固定范围)在分析期内非常接近最低和最高价格，虽然在短时间内超出范围，但它通过赚取更多费用击败了范围更大的策略(+/- 4*STD_7D)。</p><blockquote class="ld le lf"><p id="2272" class="ji jj lc jk b jl jm iu jn jo jp ix jq lg js jt ju lh jw jx jy li ka kb kc kd hm dt translated">最后，值得注意的是固定范围策略和+/- 2*STD_7D策略这两种类似策略的非永久性损失曲线之间的差异。最后提到的将执行两次再平衡，导致非永久性损失增加x5，与固定策略相比，费用仅增加x1，5。</p></blockquote><h1 id="26a8" class="kf kg ht bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw dt translated">关于webapp</h1><p id="17c2" class="pw-post-body-paragraph ji jj ht jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd hm dt translated">在<a class="ae ke" href="https://backtesting.credmark.com/" rel="noopener ugc nofollow" target="_blank">下一个链接</a>中有一个简单版本的回溯测试器，里面有使用指南。</p><p id="0440" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">联系我</strong> <a class="ae ke" href="https://twitter.com/JNP7771" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu">推特</strong> </a> <strong class="jk hu">或者加入</strong> <a class="ae ke" href="https://discord.gg/HwX5a6uSGB" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hu"> LP咖啡馆</strong> </a> <strong class="jk hu">不和继续讨论</strong></p></div></div>    
</body>
</html>