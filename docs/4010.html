<html>
<head>
<title>Ethereum Under the Hood: Part-1 (ver 0.4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">引擎盖下的以太坊:第1部分(0.4版)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethereum-under-the-hood-part-1-ver-0-4-7ac9ccbfd0f6?source=collection_archive---------1-----------------------#2021-02-05">https://medium.com/coinmonks/ethereum-under-the-hood-part-1-ver-0-4-7ac9ccbfd0f6?source=collection_archive---------1-----------------------#2021-02-05</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="a6c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个系列将跟随我从头开始探索以太坊的旅程。我假设你有一些编程知识，理解一些但不是所有的概念。注意，我会在我认为合适的时候用更多的信息更新这个帖子的多个版本。</p><p id="1ee9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">世界计算机:以太坊区块链</strong></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/9788dacf1956b5fa5f2ab245317fb125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1BsAQxfukHzOkNGN.jpeg"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek"><a class="ae kf" href="https://ethereum.stackexchange.com/questions/268/ethereum-block-architecture" rel="noopener ugc nofollow" target="_blank"><strong class="bd kg">Ethereum Virtual Machine</strong></a></figcaption></figure><p id="5bc3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae kf" href="https://ethereum.org/" rel="noopener ugc nofollow" target="_blank">以太坊</a>是一个混合了g <a class="ae kf" href="https://blockgeeks.com/guides/cryptocurrency-game-theory/" rel="noopener ugc nofollow" target="_blank"> ame理论/经济学</a>的复杂软件。如果你试图理解下面发生了什么，这可能令人难以置信，有时也令人厌倦。我发现很难找到理解规范的资源。我没有找到一本，而是想写一本。</p><p id="39ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">理解以太坊的一个好方法是理解<a class="ae kf" href="https://github.com/ethereum/wiki/wiki/White-Paper" rel="noopener ugc nofollow" target="_blank">白色</a>、<a class="ae kf" href="https://github.com/chronaeon/beigepaper/blob/master/beigepaper.pdf" rel="noopener ugc nofollow" target="_blank">米色</a>、<a class="ae kf" href="https://github.com/ethereum/yellowpaper" rel="noopener ugc nofollow" target="_blank">黄色</a>论文中提到的定义。所有这些文件都指向细节不同的相同规格，<strong class="is hu">白色</strong>是更高级别的规格，<strong class="is hu">黄色</strong>是更详细的规格。在整个系列中，我们将主要参考米色纸(BP)和一些黄色纸(YP)的元素。因此，让我们暂时坚持BP的定义，开始我们的旅程。</p><p id="9b7d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jo">提示:我建议您将</em> <a class="ae kf" href="https://github.com/chronaeon/beigepaper/" rel="noopener ugc nofollow" target="_blank"> <em class="jo"> BP </em> </a> <em class="jo">和</em> <a class="ae kf" href="https://github.com/ethereum/yellowpaper" rel="noopener ugc nofollow" target="_blank"> <em class="jo"> YP </em> </a> <em class="jo">以PDF格式在两个窗口中打开，并在需要时参考规格。</em></p><p id="1bc4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">以太坊是什么？</strong></p><p id="e133" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以太坊imho是一个全局状态和虚拟机的结合体。<strong class="is hu">以太坊=世界状态+虚拟机</strong>。</p><p id="30a8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">什么是世界状态？</strong></p><p id="93c3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">世界状态简单地称为<strong class="is hu">这个系统在给定快照下的宇宙真理</strong>。让我们从一个不同的角度来看，假设一个州的数据是可用的，谁将使用它，他们能做什么？暂时保持这种想法。让我们来看看一些可用于世界状态数据库的API的框架代码。让我们假设有两个基本的<em class="jo">函数</em>可用<code class="eh kh ki kj kk b">getGlobalState() and isValidGlobalState()</code>，API的框架代码可能看起来像下面的代码片段。</p><pre class="jq jr js jt fq kl kk km kn aw ko dt"><span id="5c64" class="kp kq ht kk b fv kr ks l kt ku"><em class="jo">function</em> <strong class="kk hu">getWorldState()</strong>{<br/> return stateInfo ;<br/>}<br/><em class="jo">function</em> <strong class="kk hu">isValidWorldState(obj stateInfo)</strong>{<br/>  return true/false ;<br/>}</span></pre><p id="d272" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第一个<em class="jo">函数</em>返回该时间点的<strong class="is hu">真值</strong>，换句话说，该函数返回当前状态(又名真值)。第二个函数验证状态是否正确，这意味着您可以相信您所得到的东西，没有任何东西被篡改。下一个函数是否验证它接收到的状态是否准确？。让我们说一些未知的球员通行证说一个当前状态<strong class="is hu"> XYZ </strong>和一个应该验证当前状态<strong class="is hu"> XYZ </strong>是准确的使用<code class="eh kh ki kj kk b"><strong class="is hu">isValidWorldState(XYZ)</strong></code> <strong class="is hu"> </strong>和你应该得到<strong class="is hu">真</strong>如果不是呀！警报警报。</p><p id="017c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来的问题是？<strong class="is hu">状态XYZ </strong>必须存储在硬盘中，并且应该是另一组功能可以识别的格式，该功能将读取和添加新的状态。注意，我说的是读取和添加，而不是<strong class="is hu">更新，</strong>我们没有<strong class="is hu">更新</strong>功能，因为几乎所有的区块链都是只追加的，不能修改当前状态。</p><p id="ff9b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们为我们的<strong class="is hu">虚拟机</strong>探索一些可能的<em class="jo">功能</em>。根据黄皮书，虚拟机是状态转移函数的子集。看一看方便的参考资料。</p><p id="47f1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> <em class="jo">正式:</em></strong><a class="ae kf" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="is hu"><em class="jo">σT+1≡υ(σT，T) </em> </strong> </a> <strong class="is hu"> <em class="jo">出自黄纸。更多细节在</em>下面提供</strong></p><pre class="jq jr js jt fq kl kk km kn aw ko dt"><span id="1ca2" class="kp kq ht kk b fv kr ks l kt ku"><em class="jo">function</em> <strong class="kk hu">addNewState(obj nextState)</strong>{ <br/>  verify currentState;<br/>  newState = currentState+nextState;<br/>  return newState;<br/> }</span></pre><p id="0772" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">状态函数的读数可以是这样的:</p><pre class="jq jr js jt fq kl kk km kn aw ko dt"><span id="680f" class="kp kq ht kk b fv kr ks l kt ku"><em class="jo">function</em> <strong class="kk hu">readState(obj currentState)</strong>{<br/>    verify currentState;<br/>    return nextState;<br/> }</span></pre><p id="38d3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">挖掘</strong>也是状态转移函数和YP的一部分，这里有一个我正在创建的方便的表格来解释证据。</p><p id="3041" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jo">提示:方便参考YP使用的</em> <a class="ae kf" href="https://ethereum.stackexchange.com/questions/6022/algebra-symbology-guidance-for-ethereum-yellow-paper" rel="noopener ugc nofollow" target="_blank"> <em class="jo">符号</em> </a> <em class="jo">和</em> <strong class="is hu"> <em class="jo">附录-A </em> </strong> <em class="jo">下面</em></p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kv kw l"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Yellow Paper State Functions</figcaption></figure><p id="2a84" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们可以有另一个名为<strong class="is hu"> verifyState() </strong>的<em class="jo">函数</em>，我的观点是保持它的简单，通过使用这些状态转换<em class="jo">函数</em>，简单的计算机即虚拟机(VM)执行这些函数中的指令，并确保一切正常。让我在这里停下来，引用英国石油公司的论文摘要</p><p id="53d5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">"<strong class="is hu"> <em class="jo">以太坊协议是一个确定性但实际上无界的状态机，有两个基本功能；第一个是全局可访问的单例状态，第二个是将更改应用到该状态的虚拟机</em> </strong> <em class="jo">。”</em></p><p id="726a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在我们继续之前，请记住我们讨论过“虚拟机”(来自上一节)，也就是“VM”。VM函数验证世界状态，并通过添加新块来改变状态。想象一下，你正在出租我们的计算机来执行一些计算。</p><p id="2010" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">没有免费的东西，虚拟机不能运行一些随机代码，代码需要检查，数据需要验证，代码需要小心退出等等。所以每一个需要运行的代码都应该提交一定的费用。费用是<strong class="is hu">乙醚</strong>。让我们在这里停下来想一想。</p><p id="018f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">什么是以太？</strong></p><p id="7591" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">所以让我们回头看看以太坊是什么。以太坊是一台功能性的全球计算机，所以要运行这台全球计算机，我们需要付出一些网络成本，这个网络成本单位就是<strong class="is hu">以太:</strong>ξ</p><p id="bab3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">ξ可以分解成以下单位。<strong class="is hu">卫</strong>(ξ)是最小的单位，你可以看到一个<strong class="is hu">芬尼</strong>可以被命名为<strong class="is hu">卫</strong>(ξ)或0.0010000000000000000】醚</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kx"><img src="../Images/c760c6beadf3ba5fa6d94f403d072699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nybu72LvLl_E1KIG.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek"><a class="ae kf" href="https://github.com/chronaeon/beigepaper/" rel="noopener ugc nofollow" target="_blank">Source: Biege Paper</a></figcaption></figure><p id="17f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以太坊没有付费玩的概念怎么办？如果我是一个糟糕的演员，我可以很容易地用一个无限循环关闭系统，并消耗所有的资源，虚拟机不能执行下一个指令集。以太坊通过让人们付费来防止这种情况，其理念是一旦你为某样东西付费，你就会小心，不会伤害系统。我确实把这个想法过于简单化了，但是你明白了。在下一节中，我们将讨论什么是“真实”也就是全局状态，以及如何验证全局状态，什么是全局状态中的数据</p><p id="7f81" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">这个数据在<em class="jo">世界</em>状态<em class="jo">下是什么？</em></strong></p><p id="9dee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">简单地说，世界状态中的数据是由块划分的状态，每个新的块代表一个新的全局状态。块包含使用称为<a class="ae kf" href="https://github.com/ethereum/wiki/wiki/RLP" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu"> <em class="jo">递归链接前缀(RLP) </em> </strong> <em class="jo"> </em> </a>的串行化/去串行化算法的<strong class="is hu">地址和账户状态</strong>的映射，并作为<a class="ae kf" href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" rel="noopener ugc nofollow" target="_blank"><strong class="is hu">Patricia-Merkle Trie</strong></a><strong class="is hu"/>存储在维护<a class="ae kf" href="https://stackoverflow.com/questions/4019837/what-do-we-mean-by-byte-array" rel="noopener ugc nofollow" target="_blank">字节数组</a>到字节数组的映射的数据库后端中。我们将在下一集深入探讨什么是RLP。</p><p id="ecd1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，World state = Total数据库中数据库关系散列的总散列。我要在这里停下来伸展一下，我建议你也这样做。</p><p id="dd56" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">假设我们有一个键，值对数组，LHS是<br/>状态的映射，即Bytearray - &gt; Bytearray。RHS是实际的映射本身</p><pre class="jq jr js jt fq kl kk km kn aw ko dt"><span id="2414" class="kp kq ht kk b fv kr ks l kt ku"> state 1 = [key1, val1]<br/> state 2 = [key2, val2]<br/> state 3 = [key3, val3] Global State = <em class="jo">hash</em>( [ [state1], [state2], [state3]...] )</span></pre><p id="9456" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">引用《黄皮书》<em class="jo">中的话，国家可以包括账户余额、声誉、信托安排、与现实世界信息有关的数据等信息；简而言之，任何目前可以由计算机表示的东西都是可以接受的。”</em></p><p id="0727" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">还记得我们谈论过的<em class="jo">函数</em>以及这些函数中的一个参数“obj”吗，现在让我们稍微扩展一下“obj”，“obj”是“Object”的缩写。以太坊世界中的一个对象是一个字节数组。例如本质上是字节数组的对象的。</p><p id="b70c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kh ki kj kk b">“Dog” [“D”,”o”, “g”], [[], “Dog”, [“Cat”]]</code></p><p id="8c04" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">根据BP，字节数组以特殊格式存储，称为<strong class="is hu">递归链接前缀(RLP) </strong>。我们以前简单地提到过它。让我们在下一篇文章中更深入地探讨一下RLP的大惊小怪到底是怎么回事。</p><p id="871e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们回顾一下本周的发现。</p><ol class=""><li id="226c" class="ky kz ht is b it iu ix iy jb la jf lb jj lc jn ld le lf lg dt translated">以太坊是一台世界计算机。</li><li id="1fe3" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">以太坊是单一世界状态+虚拟机的<strong class="is hu">组合</strong></li><li id="0e74" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">世界状态是所有状态的集合。</li><li id="4553" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">一个<strong class="is hu">状态</strong>是一个<strong class="is hu">块</strong>的集合。</li><li id="8998" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">根据微型数据库中的<strong class="is hu"> RLP </strong>前缀规范，世界状态被存储为<strong class="is hu">帕特丽夏·默克尔特里树</strong>。</li><li id="ee6e" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">只有虚拟机可以<strong class="is hu">添加</strong>一个新状态。</li><li id="cd38" class="ky kz ht is b it lh ix li jb lj jf lk jj ll jn ld le lf lg dt translated">虚拟机需要<strong class="is hu">燃料</strong>来执行指令，燃料是‘乙醚’来防止流氓行为。</li></ol><p id="e489" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jo">在</em> <a class="ae kf" rel="noopener" href="/coinmonks/ethereum-under-the-hood-part-2-rlp-encoding-ver-0-3-c37a69781855"> <strong class="is hu"> <em class="jo">下一节</em></strong></a><em class="jo">中我们将深入探讨什么是</em><strong class="is hu"><em class="jo">【RLP】并且我们将使用一些代码示例。</em>T13】</strong></p><p id="555f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">附录A: YP符号</strong></p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kv kw l"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek"><strong class="ak">Yellow Paper Symbols</strong></figcaption></figure><p id="71e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">参考文献:</strong></p><p id="f599" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae kf" href="https://github.com/benjaminion/YellowPaper_CheatSheet/blob/master/YPCheatSheet.pdf" rel="noopener ugc nofollow" target="_blank">https://github . com/Benjamin ion/yellow paper _ cheat sheet/blob/master/ypcheat sheet . pdf</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff lm"><img src="../Images/2ec24ec0c7ea7e4afeef48b3eb026033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*khLhgqtf3yRqSS0y_55L5g.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek"><a class="ae kf" href="https://cypherpunks-core.github.io/ethereumbook/13evm.html" rel="noopener ugc nofollow" target="_blank"><strong class="bd kg">Source:Etherum Virtual Machine</strong></a></figcaption></figure></div></div>    
</body>
</html>