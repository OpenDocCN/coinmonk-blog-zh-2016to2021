<html>
<head>
<title>Voting on a Blockchain: Ballot Management DApp code walk-through</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">区块链投票:选票管理DApp代码演练</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/voting-on-a-blockchain-ballot-management-dapp-code-walk-through-11d7d287d82e?source=collection_archive---------1-----------------------#2019-12-06">https://medium.com/coinmonks/voting-on-a-blockchain-ballot-management-dapp-code-walk-through-11d7d287d82e?source=collection_archive---------1-----------------------#2019-12-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="b4e5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是探索以太坊上端到端投票系统开发的5篇文章中的第4篇。在本文中，我将解释DApp选票管理模块背后的代码。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/f2817fafa9c5b7c3f7bbcd5022955553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RN4JM0wqMvZZ9UgH9AqFqg.jpeg"/></div></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">Photo by <a class="ae ke" href="https://unsplash.com/@jtc?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Jesse Collins</a> on <a class="ae ke" href="https://unsplash.com/s/photos/government?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dd7a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在我撰写本系列的其余文章时，请经常查看。</p><p id="8306" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">1.<a class="ae ke" rel="noopener" href="/coinmonks/voting-on-a-blockchain-how-it-works-3bb41582f403">在区块链上投票:它是如何工作的</a> <br/> 2。<a class="ae ke" rel="noopener" href="/coinmonks/voting-on-a-blockchain-solidity-contract-codes-explained-c677996d94f2">区块链投票:Solidity合约代码讲解</a> <br/> 3。<a class="ae ke" rel="noopener" href="/coinmonks/voting-on-a-blockchain-dapp-demonstration-dfb5944a0c9e">区块链投票:DApp演示</a> <br/> 4。<a class="ae ke" rel="noopener" href="/@jacksonngtech/voting-on-a-blockchain-ballot-management-dapp-code-walk-through-11d7d287d82e">区块链投票:选票管理DApp代码走查</a> <br/> 5。<a class="ae ke" rel="noopener" href="/@jacksonngtech/voting-on-a-blockchain-voting-dapp-code-walk-through-362e74cf3980">区块链投票:投票DApp代码遍历</a></p><p id="1e5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">重述</strong></p><p id="f564" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">选票DApp的<a class="ae ke" href="https://jacksonng.org/codetest/ballot/" rel="noopener ugc nofollow" target="_blank">选票管理模块</a>让主席设定提案、设置投票登记簿、打开/关闭选票并在投票时监控投票人。它还发布投票结果。这个模块的完整源代码可以在我的<a class="ae ke" href="https://github.com/jacksonng77/ballot/blob/master/dapp/index.html" rel="noopener ugc nofollow" target="_blank"> Github库</a>中找到</p><p id="0762" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">设置</strong></p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="4a39" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">var</strong> web3 = <strong class="kg hu">new</strong> Web3();<br/>        <strong class="kg hu">var</strong> accountaddress;<br/>        <strong class="kg hu">var</strong> ballotContract;<br/>        <strong class="kg hu">var</strong> ballotByteCode;<br/>        <strong class="kg hu">var</strong> Ballot;<br/>        <strong class="kg hu">var</strong> ballotABI = [{"constant":false,"inputs":[]....."type":"event"}];<br/>        <strong class="kg hu">var</strong> voterTable;<br/>        <br/>        $( document ).ready(<strong class="kg hu">function</strong>() {<br/>            $('#kaleidorefresh').hide();<br/>            $('#panels_contract').hide();<br/>            $('#panels_voters').hide();<br/>       	    voterTable = $('#voterTable').DataTable( {<br/>                columns: [<br/>                    { title: "Address" },<br/>                    { title: "Name" },<br/>                    { title: "Status" }<br/>                ]<br/>            } );<br/>        });</span></pre><p id="3506" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">DApp首先设置将在整个投票生命周期中使用的全局变量，即:</p><ol class=""><li id="615e" class="kq kr ht is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">accountaddress</code>:这是管理投票过程的主席的以太坊账号。该地址在执行智能投票合同时使用。</li><li id="f52a" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">ballotContract</code>:存储选票智能合约的地址，部署选票智能合约后将生成该地址。</li><li id="4ed6" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">ballotByteCode</code>:这里是选票智能合约的字节码ekpt。稍后我们将在这个变量中填充字节代码。</li><li id="01e8" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">Ballot</code>:这个变量在我们执行和监控投票对象时存储它。</li><li id="5fb1" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">ballotABI</code>:(我在上面的代码片段中截断了它)这是选票智能合约的ABI。</li><li id="91d9" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><code class="eh kz la lb kg b">voterTable</code>:这将存储一个数据表，我们在其中跟踪投票者、他们的地址和他们的投票状态。</li></ol><p id="a317" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当页面加载时，我们执行以下操作:</p><ol class=""><li id="98e1" class="kq kr ht is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky dt translated">隐藏显示投票合同信息的面板，因为在页面刚刚加载时，投票合同尚未部署。</li><li id="8386" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">在这个阶段也隐藏显示投票者的面板。还没有任何选民。</li><li id="5509" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">我还加载了<a class="ae ke" href="https://datatables.net/" rel="noopener ugc nofollow" target="_blank">数据表</a>，它在3列中显示了投票者的信息，即地址(包含投票者的以太坊地址)、姓名(这是他们的真实姓名，Zoe Ellie等等。)和状态(是否已经投票)。</li></ol><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="761a" class="kk kl ht kg b fv km kn l ko kp">window.addEventListener('load', async () =&gt; {<br/>            <em class="lh">// Modern dapp browsers...</em><br/>        	<strong class="kg hu">if</strong> (window.ethereum) {<br/>        	    window.web3 = <strong class="kg hu">new</strong> Web3(ethereum);<br/>        		<strong class="kg hu">try</strong> {<br/>        			<em class="lh">// Request account access if needed</em><br/>        			await ethereum.enable();<br/>        			<em class="lh">// Acccounts now exposed</em><br/>        			accountaddress = web3.givenProvider.selectedAddress;<br/>                    ballotContract = <strong class="kg hu">new</strong> web3.eth.Contract(ballotABI);<br/>                    ballotByteCode = '0x608060....4052600080';<br/>        		    <br/>        		} <strong class="kg hu">catch</strong> (error) {<br/>        			<em class="lh">// User denied account access...</em><br/>        		}<br/>        	}<br/>        	<em class="lh">// Legacy dapp browsers...</em><br/>        	<strong class="kg hu">else</strong> <strong class="kg hu">if</strong> (window.web3) {<br/>        			window.web3 = <strong class="kg hu">new</strong> Web3(web3.currentProvider);<br/>        			<em class="lh">// Acccounts always exposed</em><br/>        			web3.eth.sendTransaction({<em class="lh">/* ... */</em>});<br/>        	}<br/>        	<em class="lh">// Non-dapp browsers...</em><br/>        	<strong class="kg hu">else</strong> {<br/>        			console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');<br/>        	}<br/>        });<br/>        <strong class="kg hu">var</strong> BallotContractAddress = "";<br/>        <strong class="kg hu">var</strong> MyTransactionHash;</span></pre><p id="a343" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当页面加载时，这段代码检查浏览器是否带有以太坊钱包，如<a class="ae ke" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank"> MetaMask </a>。一旦找到，我们就将钱包的活动地址加载到<code class="eh kz la lb kg b">accountaddress </code>变量中。我们还将选票契约的ABI加载到变量<code class="eh kz la lb kg b">ballotContract</code>中，并将选票契约的字节码加载到变量<code class="eh kz la lb kg b">ballotByteCode</code>中。选票的字节码是在编译选票智能合约时获得的。</p><p id="2897" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您的用户在没有以太坊钱包插件的浏览器中运行此DApp，它会弹出一条控制台消息，告诉您不能运行DApp。在实时实现中，您可能希望将这些用户重定向到下载数字钱包的页面。</p><p id="ac92" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">观望&amp;等待</strong></p><p id="5baf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在DApp的观察部分，我观察投票智能契约将在投票生命周期的不同点触发的各种事件。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="d5c4" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">function</strong> <strong class="kg hu">watchVoteEnd</strong>(){<br/>            Ballot.events.voteEnded({<br/>            }, (error, event) =&gt; { <br/>                console.log(event.returnValues.finalResult);<br/>                loadState(Ballot);<br/>                loadFinalResult(Ballot);<br/>                $("#loaderStartVote").hide();<br/>                $("#btnEnd").hide();<br/>            })<br/>            .on('data', (event) =&gt; {<br/>            })<br/>            .on('changed', (event) =&gt; {<br/>                <em class="lh">// remove event from local database</em><br/>            })<br/>            .on('error', console.error)                      <br/>        }</span></pre><p id="80f4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<code class="eh kz la lb kg b">watchVoteEnd() </code>函数中，我观察并等待选票智能合约触发一个<code class="eh kz la lb kg b">voteEnded</code>事件。这表示投票已经结束，现在应该执行以下操作:</p><ol class=""><li id="3dcb" class="kq kr ht is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky dt translated">执行<code class="eh kz la lb kg b">loadState()</code>将当前投票状态更改为“结束”。</li><li id="08b0" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">执行<code class="eh kz la lb kg b">loadFinalResult()</code>显示投票结果。</li><li id="298f" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">隐藏旋转加载器动画GIF图像，因为投票已经结束，我们不再等待任何东西在后台加载。</li><li id="e421" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">隐藏[结束投票]按钮，因为投票已经结束，所以不允许主席再次尝试结束投票。</li></ol><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="ee7d" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">function</strong> <strong class="kg hu">watchVoteDone</strong>(){<br/>            Ballot.events.voteDone({<br/>            }, (error, event) =&gt; { <br/>                console.log(event.returnValues.voter);<br/>                updateNewVote(event.returnValues.voter);    <br/>            })<br/>            .on('data', (event) =&gt; {<br/>            })<br/>            .on('changed', (event) =&gt; {<br/>                <em class="lh">// remove event from local database</em><br/>            })<br/>            .on('error', console.error)           <br/>        }</span></pre><p id="eacf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<code class="eh kz la lb kg b">watchVoteDone()</code>函数中，一个投票者刚刚投了票。所以我们执行<code class="eh kz la lb kg b">updateNewVote()</code>来更新选民表，将他的状态从“未投票”改为“已投票”。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="6ccb" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">var</strong> lastVoteAdded="";<br/>        <strong class="kg hu">function</strong> <strong class="kg hu">watchVoterAdded</strong>(){<br/>            Ballot.events.voterAdded({<br/>            }, (error, event) =&gt; { <br/>                console.log(event.returnValues.voter);<br/>                loadTotalVoter(Ballot);<br/>                <br/>                <em class="lh">//strange hack: this event fires twice for some reasons</em><br/>                <em class="lh">//so I save the last voter address and suppress it if</em><br/>                <em class="lh">//it is the same as the previous one :P</em><br/>                <strong class="kg hu">if</strong> (lastVoteAdded != event.returnValues.voter){<br/>                    loadVoter(Ballot, event.returnValues.voter);<br/>                    lastVoteAdded = event.returnValues.voter;                    <br/>                }<br/>                $("#loaderNewVoter").hide();                <br/>            })<br/>            .on('data', (event) =&gt; {<br/>            })<br/>            .on('changed', (event) =&gt; {<br/>                <em class="lh">// remove event from local database</em><br/>            })<br/>            .on('error', console.error)<br/>        }</span></pre><p id="84db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<code class="eh kz la lb kg b">watchVoterAdded()</code>函数中，我们观察并等待一个新的投票者被添加到投票者注册中。一旦添加了他，我们就停止旋转loader GIF图像，然后执行<code class="eh kz la lb kg b">loadTotalVoter()</code>来更新屏幕上显示的投票者总数。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="66d7" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">function</strong> <strong class="kg hu">watchVoteStarted</strong>(){<br/>            Ballot.events.voteStarted({<br/>            }, (error, event) =&gt; { })<br/>            .on('data', (event) =&gt; {<br/>                console.log(event.event); <em class="lh">// same results as the optional callback above</em><br/>                $("#loaderStartVote").hide();<br/>                $("#btnStart").hide();<br/>                $("#btnEnd").show();<br/>                $("#section_addVoter").hide();<br/>                loadState(Ballot);<br/>            })<br/>            .on('changed', (event) =&gt; {<br/>                <em class="lh">// remove event from local database</em><br/>            })<br/>            .on('error', console.error)<br/>        }</span></pre><p id="df24" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<code class="eh kz la lb kg b">watchVoteStarted() </code>函数中，我们观察由智能投票契约触发的事件，该事件表示投票已经开始。当主席按下[开始投票]时，就会出现这种情况。当这种情况发生时，我们:</p><ol class=""><li id="4348" class="kq kr ht is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky dt translated">停止<code class="eh kz la lb kg b">loaderStartVote</code>旋转GIF图像，因为投票已经开始。</li><li id="0597" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">我们隐藏了[开始投票]按钮，因为您不能重新启动已经开始的投票过程。</li><li id="248a" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">我们显示[结束投票]按钮，因为现在可以结束已经开始的投票过程。</li><li id="ccd1" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated">我们隐藏了[添加投票人]按钮，因为它不再可能将投票人添加到已经开始的投票过程中。</li></ol><p id="7b13" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">更新DApp的用户界面</strong></p><p id="110c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">此部分中的功能通过从选票智能合同中读取相应的值并在那里显示它们来更新选票管理DApp用户界面的各个部分。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="6898" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadBallotContract</strong>(myBallotContractAddress){<br/>        	Ballot = <strong class="kg hu">new</strong> web3.eth.Contract(ballotABI, myBallotContractAddress);<br/>        	Ballot.methods.ballotOfficialName().call().then((result) =&gt; {<br/>                $("#lbl_officialname").html("&lt;b&gt;Ballot Official Name: &lt;/b&gt;" + result);<br/>            });<br/>            Ballot.methods.proposal().call().then((result) =&gt; {<br/>                $("#lbl_proposal").html("&lt;b&gt;Proposal: &lt;/b&gt;" + result);<br/>            });<br/>            <br/>            loadFinalResult(Ballot);<br/>            loadTotalVoter(Ballot);<br/>            loadTotalVotes(Ballot);<br/>            loadState(Ballot);<br/>            <br/>            $("#lbl_address").html("&lt;b&gt;Address: &lt;/b&gt;" + myBallotContractAddress);           <br/>        };</span></pre><p id="fec7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadBallotContract() </code>功能从区块链中读取主席的姓名、提案和选票智能合约的地址，并将其显示在DApp用户界面的相应部分。它还从选票智能契约中加载投票过程的最终结果、投票者总数、投票总数以及投票过程的当前状态。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="01de" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadFinalResult</strong>(myBallot){<br/>            myBallot.methods.finalResult().call().then((result) =&gt; {<br/>                $("#lbl_result").html("&lt;b&gt;Result: &lt;/b&gt;" + result);<br/>            });<br/>        }</span></pre><p id="4296" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadFinalResult()</code>功能从区块链上的选票智能合约中读取投票结果，并显示在DApp UI的相应部分。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="d455" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadTotalVoter</strong>(myBallot){<br/>            myBallot.methods.totalVoter().call().then((result) =&gt; {<br/>                $("#lbl_voters_num").html("&lt;b&gt;Voters: &lt;/b&gt;" + result);<br/>            });<br/>        }</span></pre><p id="8a33" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadTotalVoter()</code>功能从区块链上的选票智能合约中读取投票者总数的值，并显示在DApp UI的相应部分。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="066a" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadTotalVotes</strong>(myBallot){<br/>            myBallot.methods.totalVote().call().then((result) =&gt; {<br/>                $("#lbl_votes_num").html("&lt;b&gt;Votes: &lt;/b&gt;" + result);<br/>            });   <br/>        }</span></pre><p id="9753" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadTotalVotes()</code>函数从区块链上的选票智能合约中读取总票数的值，并显示在DApp UI的相应部分。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="6226" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadState</strong>(myBallot){<br/>            myBallot.methods.state().call().then((result) =&gt; {<br/>                <strong class="kg hu">if</strong> (result == 0){<br/>                    $("#lbl_state").addClass("label label-primary");<br/>                    $("#lbl_state").html("Created");                    <br/>                }<br/>                <strong class="kg hu">else</strong> <strong class="kg hu">if</strong> (result == 1){<br/>                    $("#lbl_state").addClass("label label-success");<br/>                    $("#lbl_state").html("Voting");                    <br/>                }                <br/>                <strong class="kg hu">else</strong> <strong class="kg hu">if</strong> (result == 2){<br/>                    $("#lbl_state").addClass("label label-danger");<br/>                    $("#lbl_state").html("Ended");                    <br/>                } <br/>                <strong class="kg hu">return</strong> result;<br/>            });<br/>        }</span></pre><p id="ff77" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadState()</code>功能读取区块链上选票智能合约的当前状态，并将其显示在DApp用户界面的相应部分。投票过程有3种状态:</p><ol class=""><li id="77f9" class="kq kr ht is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky dt translated"><em class="lh">已创建:</em>投票提案已设置，投票合同刚刚初始化。</li><li id="4323" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><em class="lh">投票:</em>投票进行时</li><li id="f236" class="kq kr ht is b it lc ix ld jb le jf lf jj lg jn kv kw kx ky dt translated"><em class="lh">结束:</em>投票结束时</li></ol><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="f6b2" class="kk kl ht kg b fv km kn l ko kp">async <strong class="kg hu">function</strong> <strong class="kg hu">loadVoter</strong>(myBallot, _myVoterAddress){<br/>            myBallot.methods.voterRegister(_myVoterAddress).call().then((result) =&gt; {<br/>                console.log(result);<br/>                <br/>                <strong class="kg hu">var</strong> voteStatus;<br/>                <strong class="kg hu">if</strong> (result.voted){<br/>                    voteStatus = "&lt;span class='label label-primary'&gt;Voted&lt;/span&gt;";<br/>                }<br/>                <strong class="kg hu">else</strong> {<br/>                    voteStatus = "&lt;span class='label label-danger'&gt;Not Voted&lt;/span&gt;";<br/>                }<br/>                <br/>                <strong class="kg hu">var</strong> newRow = voterTable.row.add( [<br/>                    _myVoterAddress,<br/>                    result.voterName,<br/>                    voteStatus<br/>                ] ).draw(false).node();<br/>                $('td:eq(2)', newRow).attr('id', _myVoterAddress+"_cell");<br/>                <br/>            } );<br/>        }</span></pre><p id="f900" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">loadVoter()</code>函数从区块链上的选票智能合约中读取一个投票人的详细信息。它检查这个投票人是否已经投票。如果有，它会将其状态从“未投票”更改为“已投票”。它还检查这个投票者是否是新。如果是，他将被添加到投票登记表中。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="f779" class="kk kl ht kg b fv km kn l ko kp"><strong class="kg hu">function</strong> <strong class="kg hu">updateNewVote</strong>(_myVoterAddress){<br/>            $("#" + _myVoterAddress+"_cell").html("&lt;span class='label label-primary'&gt;Voted&lt;/span&gt;");  <br/>            loadTotalVotes(Ballot);<br/>        }</span></pre><p id="e4cd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh kz la lb kg b">updateNewVote() </code>功能从区块链上的选票智能合同中读取投票人的投票状态，并在DApp UI的相应部分将其状态更改为“已投票”。</p><p id="6a6a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">按钮</strong></p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="9731" class="kk kl ht kg b fv km kn l ko kp">$("#btnEnd").click(async <strong class="kg hu">function</strong>(){<br/>            $("#loaderStartVote").show();<br/>            <em class="lh">//Ballot = new web3.eth.Contract(ballotABI, BallotContractAddress);</em><br/>            <br/>            <strong class="kg hu">var</strong> mygas;<br/>            Ballot.methods.endVote().estimateGas({from: accountaddress})<br/>            .then(<strong class="kg hu">function</strong>(gasAmount){<br/>                mygas = gasAmount;<br/>            })<br/>            <br/>        	Ballot.methods.endVote().send({<br/>                from: accountaddress,<br/>                gas: mygas, <br/>                gasPrice: web3.eth.gasPrice        	    <br/>        	})<br/>            .on('transactionHash', (hash) =&gt; {<br/>                console.log("a");<br/>            })<br/>            .on('receipt', (receipt) =&gt; {<br/>                console.log("b");            <br/>                <br/>            })<br/>            .on('confirmation', (confirmationNumber, receipt) =&gt; {<br/>                console.log("c");<br/>            })<br/>            .on('error', console.error);            <br/>        });</span></pre><p id="3b59" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当投票过程主席准备结束投票时，按下[结束]按钮。它触发区块链中选票智能合约上的<code class="eh kz la lb kg b">endVote()</code>函数执行。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="8b2e" class="kk kl ht kg b fv km kn l ko kp">$("#btnStart").click(async <strong class="kg hu">function</strong>() {	<br/>            $("#loaderStartVote").show();<br/>            <em class="lh">//Ballot = new web3.eth.Contract(ballotABI, BallotContractAddress);</em><br/>            <br/>            <strong class="kg hu">var</strong> mygas;<br/>            Ballot.methods.startVote().estimateGas({from: accountaddress})<br/>            .then(<strong class="kg hu">function</strong>(gasAmount){<br/>                mygas = gasAmount;<br/>            })<br/>            <br/>        	Ballot.methods.startVote().send({<br/>                from: accountaddress,<br/>                gas: mygas, <br/>                gasPrice: web3.eth.gasPrice        	    <br/>        	})<br/>            .on('transactionHash', (hash) =&gt; {<br/>                console.log("a");<br/>            })<br/>            .on('receipt', (receipt) =&gt; {<br/>                console.log("b");            <br/>                <br/>            })<br/>            .on('confirmation', (confirmationNumber, receipt) =&gt; {<br/>                console.log("c");<br/>            })<br/>            .on('error', console.error);<br/>        });</span></pre><p id="21d1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当投票过程主席准备好开始投票时，按下[开始]按钮。它触发区块链中选票智能合约上的<code class="eh kz la lb kg b">startVote()</code>功能执行。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="ef71" class="kk kl ht kg b fv km kn l ko kp">$("#btnAdd").click(async <strong class="kg hu">function</strong>() {	<br/>            $("#loaderNewVoter").show();<br/>            console.log($("#txtNewVoterAddress").val());<br/>            console.log($("#txtNewVoterName").val());<br/>            <br/>            <em class="lh">//Ballot = new web3.eth.Contract(ballotABI, BallotContractAddress);</em><br/>            <br/>            <em class="lh">//estimate first</em><br/>            <strong class="kg hu">var</strong> mygas;<br/>            Ballot.methods.addVoter($("#txtNewVoterAddress").val(), $("#txtNewVoterName").val()).estimateGas({from: accountaddress})<br/>            .then(<strong class="kg hu">function</strong>(gasAmount){<br/>                mygas = gasAmount;<br/>            })<br/>            <br/>        	Ballot.methods.addVoter($("#txtNewVoterAddress").val(), $("#txtNewVoterName").val()).send({<br/>                from: accountaddress,<br/>                gas: mygas, <br/>                gasPrice: web3.eth.gasPrice       	    <br/>        	})<br/>            .on('transactionHash', (hash) =&gt; {<br/>                console.log("a");<br/>            })<br/>            .on('receipt', (receipt) =&gt; {<br/>                console.log("b");            <br/>                <br/>            })<br/>            .on('confirmation', (confirmationNumber, receipt) =&gt; {<br/>                console.log("c");<br/>            })<br/>            .on('error', console.error);<br/>            <br/>        });</span></pre><p id="3a6c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当投票程序主席向投票登记簿添加新投票人时，按下[添加投票人]按钮。它触发区块链中选票智能合约上的<code class="eh kz la lb kg b">addVoter()</code>函数执行。</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="bc82" class="kk kl ht kg b fv km kn l ko kp">$("#btnGo").click(async <strong class="kg hu">function</strong>() {	<br/>            $("#loader").show();<br/>            <strong class="kg hu">var</strong> i = 0;<br/>            <strong class="kg hu">var</strong> _ballotOfficialName = $("#official").val();<br/>            <strong class="kg hu">var</strong> _proposal = $("#proposal").val();<br/>            <br/>            ballotContract.deploy({<br/>                data: ballotByteCode,<br/>                arguments: [_ballotOfficialName, _proposal],<br/>            })<br/>            .send({<br/>                from: accountaddress,<br/>                gas: 1308700, <br/>                gasPrice: web3.eth.gasPrice,<br/>                gasLimit: 2000000<br/>            }, (error, transactionHash) =&gt; {<br/>                MyTransactionHash = transactionHash;<br/>                <em class="lh">//getContract(); for private kaleido chain only</em><br/>            })<br/>            .on('error', (error) =&gt; { <br/>                console.log("b");            <br/>            })<br/>            .on('transactionHash', (transactionHash) =&gt; { <br/>                console.log("c");<br/>            })<br/>            .on('receipt', (receipt) =&gt; {<br/>                console.log("DONE" + receipt.contractAddress); <em class="lh">// contains the new contract address</em><br/>                <br/>                BallotContractAddress = receipt.contractAddress;<br/>                loadBallotContract(BallotContractAddress);<br/>                console.log(BallotContractAddress);<br/>                $("#contractAddress").val(BallotContractAddress);<br/>                watchVoteStarted(); <em class="lh">//start watching for events</em><br/>                watchVoterAdded(); <em class="lh">//start watching for new voters</em><br/>                watchVoteDone(); <em class="lh">//start watching for vote done</em><br/>                watchVoteEnd(); <em class="lh">//start watching for vote end</em><br/>                $('#panels_contract').show();<br/>                $('#panels_voters').show();<br/>                $("#btnStart").show();<br/>                $("#btnEnd").hide();<br/>                $("#loader").hide();<br/>                $("#section_addVoter").show();<br/>            })<br/>            .on('confirmation', (confirmationNumber, receipt) =&gt; { <br/>                console.log(i);<br/>                i++;<br/>            })<br/>            .then((newContractInstance) =&gt; {<br/>                console.log(newContractInstance.options.address) <em class="lh">// instance with the new contract address</em><br/>            });<br/>                        <br/>        });</span></pre><p id="42a6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当主席开始新的投票过程时，按下[Go]按钮。它触发了在区块链部署的新的智能投票合同。</p><p id="9d2b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在成功部署后，它用刚刚在区块链上部署的新选票智能合同的地址填充<code class="eh kz la lb kg b">BallotContracAddress</code>字段。它执行<code class="eh kz la lb kg b">loadBalloContract()</code>来更新DApp UI上的投票官方名称和提议。然后，它会在投票开始时观察投票契约触发的新事件。</p><p id="2abd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">它使合同面板可见，以便用户可以查看合同详细信息。它使选民面板可见，以便主席可以添加新的选民。它还显示了[开始投票]按钮，以便主席可以按下它来宣布投票已经开始。</p><p id="dea5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">它会禁用[结束投票]按钮，因为不先开始投票就无法结束投票过程。</p><p id="2a3f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">它还显示了显示选民登记册中的选民的部分，以便主席可以开始将选民添加到选票智能合同中。</p><p id="7c12" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">下一步是什么</strong></p><p id="cfd9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在区块链上<strong class="is hu">投票的<a class="ae ke" rel="noopener" href="/@jacksonngtech/voting-on-a-blockchain-voting-dapp-code-walk-through-362e74cf3980">第五(也是最后)</a>部分，我们将检查投票者DApp模块的代码。敬请关注。</strong></p><figure class="jp jq jr js fq jt fe ff paragraph-image"><a href="https://coincodecap.com"><div class="fe ff li"><img src="../Images/a06b758bdcc47dca7c2504f298674d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_s6JsD3P0hVj32E7t9EtGg.jpeg"/></div></a></figure><blockquote class="lj"><p id="52a5" class="lk ll ht bd lm ln lo lp lq lr ls jn ek translated"><a class="ae ke" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="lu lv lw lx ly jt fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lt"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>