<html>
<head>
<title>Ethernaut Lvl 13 Gatekeeper 1 Walkthrough: How to calculate smart contract gas consumption (and byte masking)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 13关守1演练:如何计算智能合同用气量(和字节屏蔽)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-13-gatekeeper-1-walkthrough-how-to-calculate-smart-contract-gas-consumption-and-eb4b042d3009?source=collection_archive---------1-----------------------#2018-09-04">https://medium.com/coinmonks/ethernaut-lvl-13-gatekeeper-1-walkthrough-how-to-calculate-smart-contract-gas-consumption-and-eb4b042d3009?source=collection_archive---------1-----------------------#2018-09-04</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一个围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank">齐柏林</a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>的<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在这个级别，你估计气体和屏蔽你的字节通过三个不同的门。门1背后的概念是<a class="ae ji" rel="noopener" href="/@nicolezhu/ethernaut-lvl-4-walkthrough-how-to-abuse-tx-origin-msg-sender-ef37d6751c8">这里详细解释</a>。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2680" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">如何计算气体</h1><p id="10ed" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">在以太坊，计算是要花钱的。这是由<code class="eh lj lk ll lm b">gas * gas price</code>计算的，其中<code class="eh lj lk ll lm b">gas</code>是计算单位，<code class="eh lj lk ll lm b">gas price</code>随以太网上的负载而缩放。交易发送者需要为她/它调用的每个交易支付由此产生的费用。</p><blockquote class="ln"><p id="91f7" class="lo lp ht bd lq lr ls lt lu lv lw ke ek translated">复杂的交易(如合同创建)比简单的交易(如给某人送乙醚)花费更多。将数据存储到区块链比读取数据花费更多，读取常量变量<a class="ae ji" rel="noopener" href="/coinmonks/ethernaut-lvl-12-privacy-walkthrough-how-ethereum-optimizes-storage-to-save-space-and-be-less-c9b01ec6adb6">比读取存储值花费更少</a>。</p></blockquote><h2 id="efb6" class="lx kn ht bd ko ly lz ma ks mb mc md kw js me mf ky jw mg mh la ka mi mj lc mk dt translated">逐步通过<strong class="ak">固体组件(2号门)</strong></h2><p id="b38f" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">具体来说，<code class="eh lj lk ll lm b">gas</code>是在组装级别分配的，即每次调用堆栈上发生操作时。例如，这些是算术运算及其当前燃气成本，来自<a class="ae ji" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank">以太坊黄皮书</a>(附录H):</p><figure class="mm mn mo mp fq mq fe ff paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="fe ff ml"><img src="../Images/235b4dacc846f27c5a141fe95120ea95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__lUMXzB3rLXZoNB5QN-8g.png"/></div></div><figcaption class="mx my fg fe ff mz na bd b be z ek">Where δ: gas to remove from the stack; α: gas to add to the stack</figcaption></figure><p id="6613" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">让我们使用<a class="ae ji" href="http://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank"> Remix IDE </a>来逐步完成下面的简单契约:</p><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="fdb9" class="lx kn ht lm b fv nf ng l nh ni">pragma solidity ^0.4.24;<br/>contract SimpleContract {<br/>    function add() public pure returns (uint) {<br/>        uint a = 1; <br/>        uint b = 2; <br/>        return (a+b);<br/>    }<br/>}</span></pre><p id="c172" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在Javascript VM中，部署这个契约，调用<code class="eh lj lk ll lm b">add()</code>，在Remix控制台中点击<code class="eh lj lk ll lm b">debug</code> enabler，调出调试器UI:</p><figure class="mm mn mo mp fq mq fe ff paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="fe ff nj"><img src="../Images/5ead2a53fd25f44e4624858c8f463edd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mEeGIQZKmUPFjGjzT7GfCA.png"/></div></div></figure><p id="1274" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">当您进入每个汇编操作码时，启用<strong class="jl hu">指令</strong>和<strong class="jl hu">步骤细节</strong>下拉菜单。</p><p id="85ed" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">请注意步骤详情中的气体值与黄皮书中的操作码表是如何对应的。在这种情况下，操作码<code class="eh lj lk ll lm b">ADD</code>花费3 gas，正如预测的那样。</p><h2 id="da5c" class="lx kn ht bd ko ly nk ma ks mb nl md kw js nm mf ky jw nn mh la ka no mj lc mk dt translated">重要的是要知道</h2><p id="3ad9" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">不同的实度<strong class="jl hu">编译器版本</strong>会计算出不同的gas。并且<strong class="jl hu">优化</strong>是否启用也会影响用气量。尝试在<code class="eh lj lk ll lm b">Settings</code>选项卡中更改编译器默认值，看看<strong class="jl hu">剩余气体</strong>将如何变化。</p><p id="5774" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><em class="np">在开始这个级别之前，请确保您已经将Remix配置为正确的编译器版本。</em></p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2ec6" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">数据类型转换</h1><p id="ac8b" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">解决这个问题的第二个知识是关于数据转换的。每当您将一个具有较大存储空间的数据点转换成一个较小的数据点时，您将丢失和损坏您的数据。</p><figure class="mm mn mo mp fq mq fe ff paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="fe ff nq"><img src="../Images/36d8cf27fffe8940e19562a912a5d94b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iaHciYKXtdk4-Z9tGaiknw.png"/></div></div></figure><h2 id="7142" class="lx kn ht bd ko ly nk ma ks mb nl md kw js nm mf ky jw nn mh la ka no mj lc mk dt translated">字节屏蔽(门3)</h2><p id="4e56" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">相反，如果你想故意达到上述结果，你可以执行字节屏蔽。可靠性允许对字节和整型进行如下的位运算:</p><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="9ba3" class="lx kn ht lm b fv nf ng l nh ni">bytes4 a = 0xffffffff;<br/>bytes4 mask = 0xf0f0f0f0;<br/>bytes4 result = a &amp; mask ;   // 0xf0f0f0f0</span></pre><p id="8d10" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">你现在准备解决这一关！</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">详细演练</h1><figure class="mm mn mo mp fq mq fe ff paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="fe ff nr"><img src="../Images/4a8ae4a1537147524167cce3ca2b61e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvU6mUZ_h09bukg7JWerlw.png"/></div></div></figure><h2 id="eee1" class="lx kn ht bd ko ly nk ma ks mb nl md kw js nm mf ky jw nn mh la ka no mj lc mk dt translated">通过1号门</h2><ol class=""><li id="255d" class="ns nt ht jl b jm le jp lf js nu jw nv ka nw ke nx ny nz oa dt translated">类似于以太者<a class="ae ji" rel="noopener" href="/@nicolezhu/ethernaut-lvl-4-walkthrough-how-to-abuse-tx-origin-msg-sender-ef37d6751c8">4级</a>，你可以通过简单地让你的合同作为中间人通过1号门。创建一个名为<code class="eh lj lk ll lm b">Hack.sol</code>的契约来访问您的级别实例:</li></ol><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="fabc" class="lx kn ht lm b fv nf ng l nh ni">contract Hack {<br/>    GatekeeperOne gate = GatekeeperOne(//YOUR ADDR);<br/>    ...<br/>}</span></pre></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h2 id="5da1" class="lx kn ht bd ko ly nk ma ks mb nl md kw js nm mf ky jw nn mh la ka no mj lc mk dt translated"><em class="ob">通过3号门</em></h2><p id="f136" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">2.门3接收一个8字节的密钥，并具有以下要求:</p><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="ccd9" class="lx kn ht lm b fv nf ng l nh ni">require(uint32(_gateKey) == uint16(_gateKey));<br/>require(uint32(_gateKey) != uint64(_gateKey));<br/>require(uint32(_gateKey) == uint16(tx.origin));</span></pre><p id="4eba" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这意味着整数键在转换成各种字节大小时，需要满足以下属性:</p><ul class=""><li id="a9ee" class="ns nt ht jl b jm jn jp jq js oc jw od ka oe ke of ny nz oa dt translated"><code class="eh lj lk ll lm b">0x11111111 == 0x1111</code>，仅当值被<code class="eh lj lk ll lm b">0x0000FFFF</code>屏蔽时才有可能</li><li id="b951" class="ns nt ht jl b jm og jp oh js oi jw oj ka ok ke of ny nz oa dt translated"><code class="eh lj lk ll lm b">0x1111111100001111 != 0x00001111</code>，只有使用掩码<code class="eh lj lk ll lm b">0xFFFFFFFF0000FFFF</code>保持之前的值时才有可能</li></ul><p id="c07d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.使用<code class="eh lj lk ll lm b">0xFFFFFFFF0000FFFF</code>掩码计算密钥:</p><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="0ba2" class="lx kn ht lm b fv nf ng l nh ni">bytes8 key = bytes8(tx.origin) &amp; 0xFFFFFFFF0000FFFF;</span></pre></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h2 id="f1c3" class="lx kn ht bd ko ly nk ma ks mb nl md kw js nm mf ky jw nn mh la ka no mj lc mk dt translated">通过2号门</h2><p id="4fe3" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">最后，为了通过Gate 2的<code class="eh lj lk ll lm b">require(msg.gas % 8191 == 0)</code>，你必须确保你的剩余gas是<code class="eh lj lk ll lm b">8191</code>的整数倍，在调用栈中执行<code class="eh lj lk ll lm b">msg.gas % 8191</code>的特定时刻。</p><p id="3698" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.因为您将计算gas，所以首先要弄清楚您的契约实例的编译器版本和设置。在<a class="ae ji" href="https://ropsten.etherscan.io/" rel="noopener ugc nofollow" target="_blank">以太扫描</a>中，通过地址查找你的契约实例。</p><p id="5e44" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">5.注意GatekeeperOne是在启用了<code class="eh lj lk ll lm b">no optimization</code>的情况下用<code class="eh lj lk ll lm b">version v0.4.18</code>编译的。相应地更新你的混音设置。</p><figure class="mm mn mo mp fq mq fe ff paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="fe ff ol"><img src="../Images/3d7e6a3a0f8b1bdc0208d3c5cac114b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXJnH42NiXrnQJRbal02Sg.png"/></div></div></figure><p id="46fe" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">6.创建一个调用<code class="eh lj lk ll lm b">enter()</code>的函数，并分配指定数量的气体。您应该使用较低级的<code class="eh lj lk ll lm b">call</code>函数调用enter()，这样可以更好地控制气体的使用。分配任意数量的气体:</p><pre class="mm mn mo mp fq nb lm nc nd aw ne dt"><span id="9d40" class="lx kn ht lm b fv nf ng l nh ni">function hackGate() public {<br/>    gate.call.gas(99999)(bytes4(keccak256('enter(bytes8)')), key);<br/>}</span></pre><p id="a42b" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">7.在JavaScript VM中调试Remix调试器，直到找到正确的操作码(当Remix IDE在<code class="eh lj lk ll lm b">msg.gas % 8191</code>上高亮显示时)。</p><p id="52a9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">8.计算剩余气体的数量，并反推得出正确的原始气体分配。并用你的新值替换呼叫气体分配。</p><blockquote class="om on oo"><p id="29f0" class="jj jk np jl b jm jn iu jo jp jq ix jr op jt ju jv oq jx jy jz or kb kc kd ke hm dt translated">注意:在剩余的<code class="eh lj lk ll lm b">gas % 8191</code>变为0之前，您可能需要重复步骤8 1-2次。</p></blockquote><p id="d323" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">6.将混音切换回<strong class="jl hu">注入的Web3 </strong>，你现在应该可以通过GatekeeperOne了！</p><figure class="mm mn mo mp fq mq"><div class="bz el l di"><div class="os ot l"/></div></figure><h1 id="beaf" class="km kn ht bd ko kp ou kr ks kt ov kv kw iz ow ja ky jc ox jd la jf oy jg lc ld dt translated">关键安全要点</h1><ul class=""><li id="0a71" class="ns nt ht jl b jm le jp lf js nu jw nv ka nw ke of ny nz oa dt translated">不要在你的智能合约中断言气体消耗，因为不同的编译器设置会产生不同的结果。</li><li id="e3ed" class="ns nt ht jl b jm og jp oh js oi jw oj ka ok ke of ny nz oa dt translated">将数据类型转换为不同的大小时，要小心数据损坏。</li><li id="1e23" class="ns nt ht jl b jm og jp oh js oi jw oj ka ok ke of ny nz oa dt translated"><strong class="jl hu">通过不存储不必要的值来节省气体</strong>。将一个值推入状态<code class="eh lj lk ll lm b">MSTORE</code>、<code class="eh lj lk ll lm b">MLOAD</code>总是比用<code class="eh lj lk ll lm b">SSTORE</code>、<code class="eh lj lk ll lm b">SLOAD</code>将值存储到区块链更省时</li><li id="3552" class="ns nt ht jl b jm og jp oh js oi jw oj ka ok ke of ny nz oa dt translated"><strong class="jl hu">通过使用适当的修饰符来获得免费的函数调用，即<code class="eh lj lk ll lm b">external pure</code>或<code class="eh lj lk ll lm b">external view</code>函数调用都是免费的，从而节省汽油</strong>！</li><li id="5593" class="ns nt ht jl b jm og jp oh js oi jw oj ka ok ke of ny nz oa dt translated"><strong class="jl hu">通过屏蔽值(更少的操作)而不是类型转换来节省气体</strong></li></ul><h1 id="5396" class="km kn ht bd ko kp ou kr ks kt ov kv kw iz ow ja ky jc ox jd la jf oy jg lc ld dt translated">更多级别</h1><div class="oz pa fm fo pb pc"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-12-privacy-walkthrough-how-ethereum-optimizes-storage-to-save-space-and-be-less-c9b01ec6adb6"><div class="pd ab ej"><div class="pe ab pf cl cj pg"><h2 class="bd hu fv z el ph eo ep pi er et hs dt translated">以太坊Lvl 12隐私演练:以太坊如何优化存储以节省空间和减少…</h2><div class="pj l"><h3 class="bd b fv z el ph eo ep pi er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pk l"><p class="bd b gc z el ph eo ep pi er et ek translated">medium.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq mv pc"/></div></div></a></div><div class="oz pa fm fo pb pc"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-14-gatekeeper-2-walkthrough-how-contracts-initialize-and-how-to-do-bitwise-ddac8ad4f0fd"><div class="pd ab ej"><div class="pe ab pf cl cj pg"><h2 class="bd hu fv z el ph eo ep pi er et hs dt translated">Ethernaut Lvl 14网守2演练:合同如何初始化(以及如何按位…</h2><div class="pj l"><h3 class="bd b fv z el ph eo ep pi er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pk l"><p class="bd b gc z el ph eo ep pi er et ek translated">medium.com</p></div></div><div class="pl l"><div class="pr l pn po pp pl pq mv pc"/></div></div></a></div><blockquote class="ln"><p id="1877" class="lo lp ht bd lq lr ps pt pu pv pw ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="py pz qa qb qc mq fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff px"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>