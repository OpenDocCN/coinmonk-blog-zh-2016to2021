<html>
<head>
<title>Writing a Smart Contract that takes and gives Ether on Remix [PT1]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">撰写一份智能合同，接受和给予以太网的混合[PT1]</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/writing-a-smart-contract-that-takes-and-gives-ether-on-remix-pt1-3356ed0d1927?source=collection_archive---------8-----------------------#2021-12-06">https://medium.com/coinmonks/writing-a-smart-contract-that-takes-and-gives-ether-on-remix-pt1-3356ed0d1927?source=collection_archive---------8-----------------------#2021-12-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="ffdd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">项目参数:</p><ol class=""><li id="242e" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">使用加密神谕获取以太坊的美元价格</li><li id="aca7" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">创建功能，允许用户存款至少500美元的乙醚到我们的合同</li><li id="8a58" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">创建允许用户从函数中取钱的函数</li><li id="1b5b" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">用Remix编写原始合同，然后将项目转换为truffle项目，编写测试迁移，并将其从VE部署到Testnet</li></ol><p id="6c7f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">好的，这很一般，但是这和微小的状态变化有很大的不同，我们开始吧:</p><p id="0c64" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">大声思考让我们从第一个参数开始，我们需要什么？</p><ol class=""><li id="6bd9" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">对于初学者，我们需要使用一个加密预言，让我们使用链式链接</li><li id="a5a3" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">我们必须弄清楚如何根据神谕中的信息来计算以太坊的价格</li><li id="9c2e" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">创建一个支付函数，允许用户存入给定数量的乙醚并持有它。</li></ol><p id="11d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们从实现价格获取功能开始。让我们从关于获取最新价格的<a class="ae kc" href="http://docs.chain.link/docs/get-the-latest-price/" rel="noopener ugc nofollow" target="_blank"> Chainlink文档</a>开始。</p><p id="26e1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您想在合同中实现获取价格功能，首先必须导入合同本身。合同的顶部应该如下所示</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="60d1" class="km kn ht ki b fv ko kp l kq kr">//SPDX-License-Identifier: MIT</span><span id="89b0" class="km kn ht ki b fv ks kp l kq kr">pragma solidity ^0.8.7;</span><span id="d706" class="km kn ht ki b fv ks kp l kq kr">import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";</span></pre><p id="83f0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">import语句所做的是，它实际上引用了chainlink Github，并获得了允许我们获取价格的合同。</p><p id="0999" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在到我们的实际合同，现在我们将在混音工作，并转移到一个松露项目。所以让我们开始用函数来计算价格。下面我一行一行的解释。</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="691e" class="km kn ht ki b fv ko kp l kq kr">contract getPaid {</span><span id="5b0a" class="km kn ht ki b fv ks kp l kq kr">address payable public owner;<br/>address[] public funders;</span><span id="bc6e" class="km kn ht ki b fv ks kp l kq kr">constructor() {<br/>   owner = payable(msg.sender);</span><span id="a231" class="km kn ht ki b fv ks kp l kq kr">function getThePrice() public view returns (uint256) {<br/>//note that the contract address used is the ETH / USD price from the Kovan TestNet</span><span id="af03" class="km kn ht ki b fv ks kp l kq kr">AggregatorV3Interface priceFeed = AggregatorV3Interface(<!-- -->0x9326BFA02ADD2366b30bacB125260Af641031331);<br/>(,int256 price,,,) = priceFeed.latestRoundData();<br/>return uint256(price);</span><span id="d1cd" class="km kn ht ki b fv ks kp l kq kr">}</span><span id="8973" class="km kn ht ki b fv ks kp l kq kr">}</span></pre><p id="f106" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">关于变量和构造函数的一点小注意:</p><ol class=""><li id="7049" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">第一个变量是一个空变量，它将被设置为与契约交互的任何人的地址。</li><li id="afe1" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">那么funders数组是一个只存储地址的数组，当我们需要实现取款功能时会用到它。</li><li id="bb3b" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">如果你使用的是V8编译器，那么不要忘记让owner变量是可支付的，因为在V8中msg.sender不是自动可支付的</li></ol><p id="635f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">好的，这是一个强大的小函数，一旦它被部署，每次我们调用它时，它都会为我们获取价格:</p><ol class=""><li id="d49d" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">函数声明行声明函数名以及函数类型，它是公共的，意味着它可以被任何人调用，它不改变状态，所以它是一个视图函数，最后，它返回数据类型uint 256[无符号整数256位]。</li><li id="7ddf" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后priceFeed变量被声明，你看到它的类型是AggregatorV3Interface，他妈的？在我们的例子中，你实际上可以从导入的接口声明新的对象，因为如果你在这里看实体文件<a class="ae kc" href="https://github.com/smartcontractkit/chainlink/blob/master/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol" rel="noopener ugc nofollow" target="_blank">，你会看到文件从接口开始。TF是接口？你可以把它想象成一个预装了半生不熟的功能的契约，半生不熟的意思是，你必须明确地告诉solidity你希望它如何与那些功能交互。</a></li><li id="3703" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">PriceFeed变量被设置为等于接口的一个实例，该实例指向监控ETH / USD对的Kovan测试网上的一个合约。你明白我说的半生不熟是什么意思了吗？我们必须告诉接口与什么契约地址进行交互]</li><li id="6d9a" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后我们有了这段奇怪的代码，它以一个括号、一个逗号开始，后跟数据类型int256 price和另外3个逗号。因此，如果你去合同底部查看函数“latestRoundData ”,你会看到该函数有5个返回值，它们都有各种信息，如更新时的RoundID和其他信息，但对于我们的情况，我们只需要价格。您可能会问Sonny，为什么我们不能将priceFeed设置为int256 price。如果函数只返回一个值，你可以这样做，但是因为它返回5，我们需要逗号和我们返回的值加到5上。因为我们不在乎返回它们，所以我们不需要填写它们，我们只需要逗号，这样它就知道我们想要的价格。</li><li id="b648" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后，我们将该值强制转换为256位无符号整数并返回它。现在，如果你把它部署在Kovan或你正在使用的任何testnet上，你会看到一个比你预期的要长得多的数字。如果您查看每个合同地址的chainlink文档，每对地址都有一个返回的小数位数，因此在我们的例子中，它返回8个小数点，因此如果您向右数8个数字，您将得到以美元为单位的价格。</li></ol><p id="82e5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">既然我们已经创建了价格获取函数，现在我们可以使用它来强制执行我们的智能合约的最小存款值，让我们选择100美元，这样任何低于该值的金额都将被我们的合约拒绝。但是我们需要第二个助手函数，它将把给出的价格转换成实际的美元计价的价格</p><ol class=""><li id="fb46" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">让我们先想想这个，之前我说过，事物被命名为8个小数位，所以如果我们除以10 ^ 8，我们应该得到正确位置的小数，我们有一个美元换算。让我们把这个编码起来</li></ol><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="8764" class="km kn ht ki b fv ko kp l kq kr">function ConvertPriceToUSD() public view returns (uint256){</span><span id="c2c1" class="km kn ht ki b fv ks kp l kq kr">uint256 currPrice = getThePrice();</span><span id="2a47" class="km kn ht ki b fv ks kp l kq kr">return  (currPrice / 10 ** 8);</span><span id="b900" class="km kn ht ki b fv ks kp l kq kr">//this should move the decimal place enough to get a denomination of ETH in dollar terms<br/>}</span></pre><p id="6859" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们有一个方法来获得当前的价格是美元，稍后我们可以使用它来比较下面的资金函数中存放的ETH的数量。还要确保在th:</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="247b" class="km kn ht ki b fv ko kp l kq kr">function deposit() public payable {</span><span id="88a0" class="km kn ht ki b fv ks kp l kq kr">uint256 minimumAmt = 100 * 10  ** 18;</span><span id="89a3" class="km kn ht ki b fv ks kp l kq kr">require(msg.value &gt;= minimumAmt, "Deposit more fool");</span><span id="0154" class="km kn ht ki b fv ks kp l kq kr">addressToDollarAmt[msg.sender] += msg.value;</span><span id="40ae" class="km kn ht ki b fv ks kp l kq kr">funders.push(msg.sender);</span><span id="3cba" class="km kn ht ki b fv ks kp l kq kr">}</span></pre><p id="d95f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">好吧，让我们一行一行地分析这个函数的功能:</p><ol class=""><li id="d56b" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">所以在第一行你会看到一个新的关键字，那就是payable，这是我们告诉Solidity编译器这个函数在某种程度上处理货币交换的方式。</li><li id="454b" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后，我们声明一个函数绑定变量，它设置了一个最小的阈值，要在下面的行中进行测试，我们将它乘以10 18，以WEI表示</li><li id="a621" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">下面我们有一个require语句，说明100 wei是该合约的最低门槛，如果他们的存款少于该值，他们会收到一条错误消息。</li><li id="ca0d" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后这个地址被推送到funders数组。</li></ol><p id="85a7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">太棒了，我们已经为多个用户实现了存款功能，但是如果我们的用户想从合同中取钱怎么办，我们如何确保只有他们可以提取他们投入的钱，而不是其他任何人的钱？</p><p id="4f85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们需要一些东西，第一个是修饰符，第二个是实际的撤销函数本身:</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="223d" class="km kn ht ki b fv ko kp l kq kr">modifier onlyOwner {</span><span id="52d3" class="km kn ht ki b fv ks kp l kq kr">require(msg.sender == owner);</span><span id="5741" class="km kn ht ki b fv ks kp l kq kr">_;</span><span id="06b9" class="km kn ht ki b fv ks kp l kq kr">}</span><span id="e7e7" class="km kn ht ki b fv ks kp l kq kr">function withdraw() public payable onlyOwner {</span><span id="5199" class="km kn ht ki b fv ks kp l kq kr">payable(msg.sender).transfer(address(this).balance);</span><span id="aa36" class="km kn ht ki b fv ks kp l kq kr">for (uint256 funderI=0; funderI &lt; funders.length; funderI++) {</span><span id="8f4f" class="km kn ht ki b fv ks kp l kq kr">address withdrawlAddy = funders[funderI];</span><span id="446c" class="km kn ht ki b fv ks kp l kq kr">addressToDollarAmt[withdrawlAddy] = 0;</span><span id="aa0e" class="km kn ht ki b fv ks kp l kq kr">}</span><span id="9230" class="km kn ht ki b fv ks kp l kq kr">funders = new address[](0);</span><span id="a191" class="km kn ht ki b fv ks kp l kq kr">}</span></pre><ol class=""><li id="f1b0" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw dt translated">首先，我们从我们的修饰符开始，它只是一个额外的必需参数，我们可以用在我们的撤销函数中。不要错过“_”，这样会抛出一个异常，而不是破坏契约。</li><li id="1229" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">然后，正如您在声明行中看到的，我们使用修饰符only owner，然后当您转到第二行时，我们将msg.sender变量设为变量类型，然后我们调用transfer方法将合同的余额传输回与合同交互的地址。</li><li id="afec" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw dt translated">不要忘记，我们还必须更新阵列的状态，以确保我们合同的安全性。因此，我们开始一个循环来遍历funders数组，并将数组中的所有值都设置为0[因此，只有该数组包含与之交互的人的地址]，然后启动一个新的funders数组，并将该新数组中的所有值都设置为0。</li></ol><p id="2b19" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，你已经完成了合同，现在是时候搬出kushy沙盒，这是重新组合，并将其转移到松露。如果你有任何未解决的错误，请查看这个GitHub报告。</p><blockquote class="kt"><p id="258a" class="ku kv ht bd kw kx ky kz la lb lc jn ek translated">加入Coinmonks <a class="ae kc" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae kc" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h2 id="6048" class="km kn ht bd ld le lf lg lh li lj lk ll jb lm ln lo jf lp lq lr jj ls lt lu lv dt translated">也阅读</h2><div class="lw lx fm fo ly lz"><a rel="noopener follow" target="_blank" href="/coinmonks/leveraged-token-3f5257808b22"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">杠杆代币[多头代币]终极指南</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">杠杆化令牌是具有杠杆化风险敞口的ERC20令牌，不考虑保证金、要求、管理…</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">medium.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a href="https://blog.coincodecap.com/bitsgap-review" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">获取信号、交易机器人和套利</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">在本文中，我们将讨论bits gap——一个满足您所有交易需求的一站式加密交易平台…</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">blog.coincodecap.com</p></div></div><div class="mi l"><div class="mp l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a href="https://blog.coincodecap.com/best-telegram-channels" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">40个最佳电报频道，用于加密、电影、表演和演讲| CoinCodeCap</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">编辑描述</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">blog.coincodecap.com</p></div></div><div class="mi l"><div class="mq l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a href="https://blog.coincodecap.com/best-social-trading-platforms" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">5个最佳社交交易平台[2021] | CoinCodeCap</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">编辑描述</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">blog.coincodecap.com</p></div></div><div class="mi l"><div class="mr l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a href="https://blog.coincodecap.com/blockfi-review" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">BlockFi评论2021:利弊和利率| CoinCodeCap</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">编辑描述</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">blog.coincodecap.com</p></div></div><div class="mi l"><div class="ms l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a rel="noopener follow" target="_blank" href="/coinmonks/buy-bitcoin-in-india-feb50ddfef94"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">如何在印度购买比特币？2021年购买比特币的7款最佳应用[手机版]</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">如何使用移动应用程序购买比特币印度</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">medium.com</p></div></div><div class="mi l"><div class="mt l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a rel="noopener follow" target="_blank" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">加密税务软件——五大最佳比特币税务计算器[2021]</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">不管你是刚接触加密还是已经在这个领域呆了一段时间，你都需要交税。</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">medium.com</p></div></div><div class="mi l"><div class="mu l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a href="https://blog.coincodecap.com/best-hardware-wallet-bitcoin" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">存储比特币的最佳加密硬件钱包[2021] | CoinCodeCap</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">编辑描述</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">blog.coincodecap.com</p></div></div><div class="mi l"><div class="mv l mk ml mm mi mn mo lz"/></div></div></a></div><div class="lw lx fm fo ly lz"><a rel="noopener follow" target="_blank" href="/coinmonks/pionex-review-exchange-with-crypto-trading-bot-1e459d0191ea"><div class="ma ab ej"><div class="mb ab mc cl cj md"><h2 class="bd hu fv z el me eo ep mf er et hs dt translated">Pionex评论2021 |免费加密交易机器人和交换</h2><div class="mg l"><h3 class="bd b fv z el me eo ep mf er et ek translated">Pionex是为交易自动化提供工具的后起之秀。Pionex上提供了9个加密交易机器人…</h3></div><div class="mh l"><p class="bd b gc z el me eo ep mf er et ek translated">medium.com</p></div></div><div class="mi l"><div class="mw l mk ml mm mi mn mo lz"/></div></div></a></div></div></div>    
</body>
</html>