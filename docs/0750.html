<html>
<head>
<title>A Minimalist Framework for writing and testing Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写和测试智能合同的极简框架</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/a-minimalist-framework-for-writing-and-testing-smart-contracts-f25d1941b2e6?source=collection_archive---------3-----------------------#2018-06-10">https://medium.com/coinmonks/a-minimalist-framework-for-writing-and-testing-smart-contracts-f25d1941b2e6?source=collection_archive---------3-----------------------#2018-06-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><blockquote class="iq"><p id="b21b" class="ir is ht bd it iu iv iw ix iy iz ja ek translated">开发您自己的环境来部署、运行和测试Solidity合同。</p></blockquote><figure class="jb jc jd je jf jg fe ff paragraph-image"><div class="ab fr cl jh"><img src="../Images/b628204db3c5f6d01dfce2083948c1da.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_9mKhRBMALELj-T4aELu6g.jpeg"/></div><figcaption class="jk jl fg fe ff jm jn bd b be z ek">Frameworks are helpful in the long run. They hold the panes in place.</figcaption></figure><p id="4508" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">在Solidity中编写合同的挑战部分不是代码的实际逻辑，而是保证我们编写的合同是<strong class="jq hu"> <em class="kl">没有错误</em></strong><strong class="jq hu"><em class="kl">只做它必须做的事情</em> </strong> <em class="kl">。后果可能是可怕的——损失数百万美元的价值，锁定投票决策等。更糟糕的是普通用户产生的恐惧和怀疑感。我相信我们都是以太坊这样的分散化技术的堡垒，作为贡献开发者(或“合同作者”)，确保我们所写合同的功能性和安全性是我们的职责。</em></p><ol class=""><li id="afb8" class="kn ko ht jq b jr js jv jw jz kp kd kq kh kr ja ks kt ku kv dt translated">正如我在开头提到的，写合同并不是最具挑战性的部分。事实上，当你访问在线solidity IDE时，你会看到一份相当复杂的合同。用户可以在不离开浏览器选项卡的情况下部署、运行合同并与之交互。与契约交互并以某种顺序运行某些功能不是测试。合同测试应该是严格的。</li><li id="2ff9" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">坐在Remix中点击这里和那里对于初始测试(即当编写合同功能时)是很好的，但是严格的测试应该很快。</li><li id="fb5b" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">当测试代码时，一个好的开发人员会尝试破解代码。手动模拟复杂的测试很无聊，但这并不排除测试用例应该是复杂的。</li></ol><p id="2672" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">为了解决这一切，并在Solidity中增加更多的合同开发，诞生了<a class="ae km" href="http://truffleframework.com/" rel="noopener ugc nofollow" target="_blank">松露框架</a>。这真的很神奇！</p><ol class=""><li id="db17" class="kn ko ht jq b jr js jv jw jz kp kd kq kh kr ja ks kt ku kv dt translated">对于经验丰富的开发人员来说，使用像Truffle这样的现有框架并不是一个不同的话题；但是那些进入Solidity开发的人讨厌使用框架的想法(甚至像Truffle一样好的东西，双关语)。正如我从自己的行为中了解到的那样，这可能是对走另一条“学习曲线”的最初犹豫。我们可以从头开始开发自己的产品来解决所有问题。学习好的实践变得容易多了。</li><li id="d165" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">可靠性合同不像是为运行飞机而设计的庞大代码库；它们最多是与其他合同或外部拥有的帐户通信的多个类(但也不太多)。一个最小框架保持了清晰和简洁的精神。</li><li id="b20b" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated"><strong class="jq hu">学习。看到事情是如何干净利落地实现的，以及部署、运行和测试Solidity contracts是多么容易，而不需要额外的套件，这对初学者来说几乎是神秘的，这是非常有益的。</strong></li></ol><p id="8b00" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu"> <em class="kl">目标</em> </strong>:我们将建立一个测试环境，通过简单地发出<code class="eh lb lc ld le b">npm run test</code>，我们可以为我们的Solidity smart contracts编写并运行一套测试。</p><p id="03db" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu"> <em class="kl">随身用品:</em> </strong></p><ol class=""><li id="3152" class="kn ko ht jq b jr js jv jw jz kp kd kq kh kr ja ks kt ku kv dt translated">我安装了npm (6.1.0)和node (v8.9.0)。</li><li id="0ebd" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">solc是我们将要使用的Solidity编译器。</li><li id="4371" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">我们将使用<a class="ae km" href="https://mochajs.org/" rel="noopener ugc nofollow" target="_blank">摩卡</a>作为测试框架。</li><li id="d06c" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated"><a class="ae km" href="https://www.npmjs.com/package/ganache-cli" rel="noopener ugc nofollow" target="_blank">加纳切-cli </a>【仿效】区块链和EVM当地的以太坊，我们可以在上面快速部署我们的合同，而不需要实际的以太来支付天然气费用。</li><li id="f72b" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">web3是一个库集合，可以让你与区块链节点(本地或远程)交互。</li></ol><p id="8c28" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu"> <em class="kl">装置:</em> </strong></p><ol class=""><li id="71be" class="kn ko ht jq b jr js jv jw jz kp kd kq kh kr ja ks kt ku kv dt translated">你可以在这里从<a class="ae km" href="https://www.npmjs.com/get-npm" rel="noopener ugc nofollow" target="_blank">下载并安装npm和NodeJs (也叫node)。</a></li><li id="6f47" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">创建并移入新目录，发出<code class="eh lb lc ld le b"><strong class="jq hu">npm init</strong></code>命令，通过设置新的npm包来创建新的节点项目。会出现一个向导询问不同的参数，只需一直按回车键直到完成。</li><li id="e1eb" class="kn ko ht jq b jr kw jv kx jz ky kd kz kh la ja ks kt ku kv dt translated">现在，只需在终端发出以下命令，就可以安装所有的需求:</li></ol><pre class="lf lg lh li fq lj le lk ll aw lm dt"><span id="d06a" class="ln lo ht le b fv lp lq l lr ls"><strong class="le hu">npm install --save solc ganache-cli web3@1.0.0-beta.26 mocha</strong></span></pre><p id="cd56" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu">注意:Windows用户</strong>在安装web3之前需要安装windows-tools。因此，在步骤3之前运行<code class="eh lb lc ld le b">npm install --global --production windows-build-tools</code>。</p><p id="f1f7" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">运行步骤3后，我可以看到以下安装是成功的:</p><figure class="lf lg lh li fq jg fe ff paragraph-image"><div class="ab fr cl jh"><img src="../Images/9fafc82e4169d5ac8613b0fcd6015fd6.png" data-original-src="https://miro.medium.com/v2/format:webp/1*yHkHdl1qaJ8-H9TSti40ew.png"/></div></figure><p id="8887" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu"> <em class="kl">目录结构:</em> </strong></p><p id="e61f" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">目录结构对于确保我们在同一页上是至关重要的。具体来说，在主工作目录中，创建两个目录- <code class="eh lb lc ld le b">./contracts</code>和<code class="eh lb lc ld le b">./test</code>。这是我们最终的目录树的样子；先不要担心其他文件，我们马上就要到了。</p><p id="6f3d" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><code class="eh lb lc ld le b">./contracts</code>将保存用Solidity编写的合同，而<code class="eh lb lc ld le b">./test</code>是我们用JavaScript编写的mocha风格测试的地方。</p><figure class="lf lg lh li fq jg fe ff paragraph-image"><div class="ab fr cl jh"><img src="../Images/f05ab965992dbbd0ec714861bb16e781.png" data-original-src="https://miro.medium.com/v2/format:webp/1*jgmXPceLNBPVKILhphA3sQ.png"/></div><figcaption class="jk jl fg fe ff jm jn bd b be z ek">erc20 is the project main-directory.</figcaption></figure><p id="fcf6" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">在接下来的部分中，我们将完成并总结所有内容。</p><p id="df9e" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">我正在使用来自以太坊维基页面的样本固定供应<a class="ae km" href="https://theethereum.wiki/w/index.php/ERC20_Token_Standard#Sample_Fixed_Supply_Token_Contract" rel="noopener ugc nofollow" target="_blank"> ERC20令牌。继续将可靠性代码复制到新合同中，并保存在<code class="eh lb lc ld le b">./contracts</code>文件夹中。您可以查看上面的目录快照，我在那里调用了sample_fixed_supply_token.sol。</a></p><p id="5635" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">为了编译这个契约，我们将使用已经安装的<code class="eh lb lc ld le b">sol</code>包。继续在主文件夹中创建一个文件，我们称之为compile.js。</p><p id="f8ae" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">js——编译并生成字节码以及与契约交互的接口。</p><p id="ab00" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">如果取消第14行的注释，运行命令<code class="eh lb lc ld le b">node compile.js</code>应该会输出一堆东西，包括字节码和接口，也叫做ABI。</p><p id="0a3e" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">我们使用其他两个库(即path和fs)的唯一原因是，它们是非常标准的库，并且在使用Node时提供了读取文件的标准方法。</p><p id="4eee" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">好了，现在我们可以编译代码了。我们现在需要的是在区块链上部署它，然后运行它。</p><p id="3980" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu">区块链(以太坊节点)在哪里？</strong></p><p id="f571" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">更具体地说，我们在哪里运行合同？我们不需要一个以太坊节点来运行我们编译的代码吗？是的，为了解决这个问题，我们使用了<a class="ae km" href="https://github.com/trufflesuite/ganache-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hu"> ganache-cli </strong> </a>。Ganache过去被称为TestRPC，当它运行时，它创建地址(我们可以访问)并模拟以太坊节点的行为。这保证了我们在这里测试的是我们在任何以太坊节点上部署契约时得到的。此外，还有另一个好处，即部署契约时没有任何挖掘的概念，因此速度要快得多。相反，在像Rinkeby这样成熟的测试网上部署契约会增加额外的两位数秒。</p><p id="9283" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><strong class="jq hu">测试，最后</strong></p><p id="2b7c" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">我们将以常规<a class="ae km" href="https://mochajs.org/" rel="noopener ugc nofollow" target="_blank">摩卡</a>风格进行测试:)</p><p id="a929" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">转到package.json文件，将名为“test”的字段设置为“mocha”。Npm需要知道你想要什么。</p><figure class="lf lg lh li fq jg fe ff paragraph-image"><div class="ab fr cl jh"><img src="../Images/fb3f1941ad693a05562f083f99a85664.png" data-original-src="https://miro.medium.com/v2/format:webp/1*RGOjUVf3ZVIkl7TF9yEuZw.png"/></div><figcaption class="jk jl fg fe ff jm jn bd b be z ek">Open mocha style!!!</figcaption></figure><p id="4145" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">现在我们需要做的就是编写实际的测试用例。转到。/test并添加一个测试文件。我正在编写一个最小的测试来展示我们的“框架”的运行。</p><p id="d176" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">。/test/fixed_supply_test_1.js-一个简单的测试。</p><p id="98ed" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">请注意我是如何使用ganache在上部署和运行我的合同的；但更重要的是，从第12行开始，我们所遵循的并不是什么新东西。它非常类似于任何普通的mocha测试文件。现在，npm知道我们想要使用mocha，并且我们已经编写了测试文件；如果我转到终端和我的项目的主目录并键入<code class="eh lb lc ld le b">npm run test</code>，我应该看到我的测试正在运行。</p><figure class="lf lg lh li fq jg fe ff paragraph-image"><div class="ab fr cl jh"><img src="../Images/f4ded258271eb4c2a17e2d066c408ddb.png" data-original-src="https://miro.medium.com/v2/format:webp/1*zzXGkgNpBMeUhE0bpCJ1cA.png"/></div><figcaption class="jk jl fg fe ff jm jn bd b be z ek">Two very very simple tests passing (pun intended) by the terminal screen.</figcaption></figure><p id="64ff" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated">为合同写测试<strong class="jq hu">是必须的</strong>，它<strong class="jq hu">也不难</strong>。我想展示在没有任何额外框架的情况下开始编写测试是多么容易，并欣赏这个过程中所包含的简单性。另外，请记住，我并没有试图解释如何为可靠性契约编写测试，那是改天的话题。也许，一旦你完成了这里的工作，你会真正喜欢使用<a class="ae km" href="http://truffleframework.com/" rel="noopener ugc nofollow" target="_blank">松露<strong class="jq hu"> </strong>框架</a>。</p></div><div class="ab cl lt lu hb lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hm hn ho hp hq"><p id="9e37" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ja hm dt translated"><em class="kl">原载于2018年6月10日medium.com</em><a class="ae km" rel="noopener" href="/coinmonks/a-minimalist-framework-for-writing-smart-contracts-e2f98bcd1046"><em class="kl"/></a><em class="kl">。</em></p></div></div>    
</body>
</html>