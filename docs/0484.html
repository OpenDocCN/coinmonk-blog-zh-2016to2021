<html>
<head>
<title>Migrating an Ethereum Smart Contract to a Live Network with Truffle</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Truffle将以太坊智能合约迁移到实时网络</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/migrating-an-ethereum-smart-contract-to-a-live-network-with-truffle-d5d35fcec327?source=collection_archive---------4-----------------------#2018-05-11">https://medium.com/coinmonks/migrating-an-ethereum-smart-contract-to-a-live-network-with-truffle-d5d35fcec327?source=collection_archive---------4-----------------------#2018-05-11</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="384a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦你建立了你的第一个以太坊智能合约，下一步就是将它部署到一个活跃的网络中，因为运行在<code class="eh jo jp jq jr b">localhost</code>上的孤独的智能合约是悲伤和孤独的。</p><p id="5e7c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了简单起见，本教程将使用简单的<a class="ae js" href="http://truffleframework.com/boxes/react" rel="noopener ugc nofollow" target="_blank">反应松露盒</a>作为起点。首先，我们将在本地测试以太坊环境中测试和运行这个应用程序，然后我们将智能合约部署到Rinkeby测试网，并从那里运行它。</p><p id="7a93" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jt">**免责声明* *本教程面向已经熟悉以太坊和智能合约基础的人。如果你是以太坊的新手，可以跟着这个教程学习，但是建议先从一个简单的“建立你的第一个dapp”教程开始。</em></p><h1 id="6e8c" class="ju jv ht bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">设置</h1><p id="8ec4" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hm dt translated"><em class="jt">(如果您有一个现有的truffle项目在本地运行，请随意跳过这一部分，并转到下面的</em> <strong class="is hu"> <em class="jt">部署到Rinkeby </em> </strong> <em class="jt">部分。)</em></p><p id="9395" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第一个要求是设置您的javascript环境(如果您已经安装了npm，那么您就成功了)。我首选的安装node/npm的方法是用Linux/Mac的<a class="ae js" href="https://github.com/creationix/nvm" rel="noopener ugc nofollow" target="_blank"> nvm </a>(节点版本管理器)，或者只使用标准的<a class="ae js" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">安装程序</a>。你还需要一个支持web 3/以太坊的浏览器，我推荐使用<a class="ae js" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank">元掩码</a>来实现这个目的。</p><p id="0c35" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来你需要安装<em class="jt">块菌</em>和<em class="jt">ganache；</em>用<code class="eh jo jp jq jr b">npm install -g truffle ganache-cli</code>做这个。</p><p id="4bd1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后在你想要工作的文件夹中打开终端并运行<code class="eh jo jp jq jr b">truffle unbox react</code>。这将下载预先制作的样板文件，这是松露和react的最小设置，准备好等待几分钟来下载和配置一切。</p><p id="8f3b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后运行<code class="eh jo jp jq jr b">npm start</code>启动UI，在浏览器中查看，网址为<a class="ae js" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>，界面如下。</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff kx"><img src="../Images/4722393fe4dde587548f00ec61745af1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*COq2VFoGuweNzpSMeXlSYQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">The running truffle box.</figcaption></figure><p id="e88e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">表面上看起来一切正常，但如果您打开浏览器控制台，您将看到以下错误:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff ln"><img src="../Images/fcf825f890438d385b69570dfe9db15b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X9DMDPKdvk2vjvWDLeknow.png"/></div></div></figure><p id="c438" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个错误是因为合同还没有被部署到以太网，MetaMask正在注入到浏览器中(耶，读取错误消息！).如果您没有看到“检测到注入的web3”这一行请确保您的元掩码设置正确。</p><p id="d96e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，我们需要做的是将智能合同部署到网络中。我们通过打开另一个终端并运行<code class="eh jo jp jq jr b">ganache-cli -m “your twelve work pass phrase from metamask …”</code>来做到这一点。当我们打开MetaMask并将网络设置为“Localhost 8545”时，我们会看到100.0 Eth出现在我们的帐户中。</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div class="fe ff lo"><img src="../Images/b04b1deba134f963c8c1332f96062d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*5oYb1hcv4Prvudth1rnxjg.png"/></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Selecting the Ganache testnet in MetaMask</figcaption></figure><p id="0092" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们需要告诉Truffle这个网络，这样它就可以部署到这个网络上。编辑“truffle.js”(或Windows上的“truffle-config.js”)文件，包含以下内容:</p><pre class="ky kz la lb fq lp jr lq lr aw ls dt"><span id="a510" class="lt jv ht jr b fv lu lv l lw lx">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: 'localhost',<br/>      port: 8545,<br/>      network_id: '*' // Match any network id<br/>    }<br/>  }<br/>};</span></pre><p id="cbc2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在跑<code class="eh jo jp jq jr b">truffle compile</code>接着跑<code class="eh jo jp jq jr b">truffle migrate --network development</code>。重新加载UI，将显示一个元掩码对话框，要求您确认交易；前提是元掩码已解锁。接受交易后，代码会将智能合约中的一个变量设置为“5 ”,并在浏览器中显示。</p><p id="bde9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">到目前为止一切顺利！我亲爱的朋友们。</p><h2 id="0971" class="lt jv ht bd jw ly lz ma ka mb mc md ke jb me mf ki jf mg mh km jj mi mj kq mk dt translated">部署到林克比</h2><p id="1441" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hm dt translated">设置元掩码以使用“Rinkeby测试网络”。如果您的余额为零，请到这个<a class="ae js" href="https://faucet.rinkeby.io/" rel="noopener ugc nofollow" target="_blank">龙头</a>为您的主要以太坊地址(您在MetaMask中的第一个地址)获取一些测试以太。将合同部署到以太坊是一个昂贵的过程(复杂的合同可能高达50美元)，所以我强烈建议使用测试以太网进行练习。</p><p id="bf75" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了方便起见，我们将使用Infura作为托管节点；因此，请继续操作，在这里创建一个Infura帐户<a class="ae js" href="https://infura.io/signup" rel="noopener ugc nofollow" target="_blank">，并记录您收到的密钥。我将在下一节介绍如何使用本地运行的以太坊节点。</a></p><p id="d2c6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，运行<code class="eh jo jp jq jr b">npm i -s truffle-hdwallet-provider</code>来安装一个提供者，它会将您连接到所选的网络，签署您的交易并将这些交易提交给网络。</p><p id="f95a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">web3使用“提供者”向以太坊网络提交交易，并在这种情况下签署这些交易。要使用该提供程序，请将以下内容添加到您的<code class="eh jo jp jq jr b">truffle.js</code>文件中。我们对rinkeby使用3的<code class="eh jo jp jq jr b">network_id</code>,但是其他可能感兴趣的网络id分别是main-net、ropsten和kovan的1、4、42。</p><pre class="ky kz la lb fq lp jr lq lr aw ls dt"><span id="fa48" class="lt jv ht jr b fv lu lv l lw lx">const HDWalletProvider = require("truffle-hdwallet-provider");<br/>const memonic = <!-- -->"your twelve work pass phrase from metamask …"<br/>module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: 'localhost',<br/>      port: 8545,<br/>      network_id: '*' // Match any network id<br/>    },<br/>    rinkeby: {<br/>      provider: function() {<br/>        return new HDWalletProvider(memonic, "<a class="ae js" href="https://rinkeby.infura.io/KbYGhpVayiCZmhG8JMXE" rel="noopener ugc nofollow" target="_blank">https://rinkeby.infura.io/</a>&lt;&lt;your_infura_access_token&gt;&gt;")<br/>      },<br/>      network_id: 3<br/>    }<br/>  }<br/>};</span></pre><p id="646e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在您已经准备好再次运行迁移<code class="eh jo jp jq jr b">truffle migrate --network rinkeby</code>。这将比上次我们使用Ganache时花费更长的时间，因为我们需要等待网络挖掘数据块。</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff ml"><img src="../Images/c84dab11b6703cf3319bec00a85ecd11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSO7zDlzY9bcYRA7dt66eQ.png"/></div></div></figure><p id="2656" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后，您可以从交易中复制散列，在本例中为<code class="eh jo jp jq jr b">0xbdf619456e2a48065c176304b806b9d334bfd8b5cd389d477ac8d5007f9ba9e5</code>，并在<a class="ae js" href="https://rinkeby.etherscan.io" rel="noopener ugc nofollow" target="_blank"> rinkeby etherscan </a>上搜索它，以确认和查看您的交易的详细信息。</p><p id="94a3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">再次打开用户界面，确认设置存储的交易，并确认交易在<a class="ae js" href="http://rinkeby.etherscan.io" rel="noopener ugc nofollow" target="_blank"> etherscan </a>上通过。</p><p id="1aa3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">祝贺您，您已将您的第一份合同部署到公共网络！</p><h2 id="9268" class="lt jv ht bd jw ly lz ma ka mb mc md ke jb me mf ki jf mg mh km jj mi mj kq mk dt translated">挑战</h2><p id="2ae6" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hm dt translated">如果您想尝试稍微困难一点的东西，您可以尝试使用这个修改过的<a class="ae js" href="https://gist.github.com/JasoonS/11fca1a98f1eb41a79987a041541e8c8" rel="noopener ugc nofollow" target="_blank">提供者引擎</a>来部署您的合同，它直接使用私钥，而不是memonic短语。这是直接从原来的<a class="ae js" href="https://github.com/trufflesuite/truffle-hdwallet-provider/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">松露-高清钱包-供应商</a>修改而来。</p><h1 id="e148" class="ju jv ht bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dt translated">使用本地运行的节点</h1><p id="71e6" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hm dt translated">您也可以使用未锁定的帐户直接部署到本地节点。请特别小心使用这种方法，如果你的以太坊节点对公众开放，他们可以用你的未锁定账户执行交易。这可以通过在本地运行奇偶校验或geth来实现。请参考各自的文档进行设置。</p><p id="b86c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦您的节点正确运行，您就可以像使用Ganache一样部署您的合同，因为它也只是为您提供一组解锁的帐户。</p><h2 id="7136" class="lt jv ht bd jw ly lz ma ka mb mc md ke jb me mf ki jf mg mh km jj mi mj kq mk dt translated">将合同部署到公共网络的另一种有趣方式</h2><p id="2bd6" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hm dt translated">您可以使用<a class="ae js" href="https://remix.ethereum.org/#optimize=false&amp;version=soljson-v0.4.23+commit.124ca40d.js" rel="noopener ugc nofollow" target="_blank">https://remix.ethereum.org</a>，将您的代码粘贴到那里，或者使用<a class="ae js" href="https://github.com/ethereum/remixd" rel="noopener ugc nofollow" target="_blank"> remixd，</a>选择您的环境(注入的web3指的是元掩码，如下图所示)，然后单击部署。如果你使用这种方法，你需要手动保存并链接合同地址到Truffle，如果你想为你的UI使用Truffle的话。</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff fg"><img src="../Images/1c77aa3aec10412369ef24d400569e61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lL_NGQHpCPRVaWe5g2DfSQ.png"/></div></div></figure><p id="ade0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我希望你在部署你的第一个dapp到世界上的时候玩得开心！</p><p id="82c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您有任何问题或建议，请在下面留下评论。</p></div></div>    
</body>
</html>