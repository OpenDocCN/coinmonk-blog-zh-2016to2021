<html>
<head>
<title>Taquito Batch API tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Taquito批处理API教程</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/taquito-batch-api-tutorial-fe2957057d3e?source=collection_archive---------2-----------------------#2020-11-20">https://medium.com/coinmonks/taquito-batch-api-tutorial-fe2957057d3e?source=collection_archive---------2-----------------------#2020-11-20</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="bb9a" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">如何使用Taquito Batch API在同一个hash下发送多个事务</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/875ebdd02324e5d851c0fdf8736d095f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaJvu-CBjybkr0-PZy6rJQ.jpeg"/></div></div></figure><p id="2590" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">当您开始为您的智能合约开发更复杂的dapps时，您会遇到的一个摩擦点发生在连续创建多个新交易时。每个Tezos帐户都有一个计数器，每当网络上的一个块中包含一个操作时，计数器就会增加。这意味着如果你已经有一个未决的事务，你不能伪造一个新的事务，否则你将得到现在臭名昭著的错误消息<code class="eh kq kr ks kt b">Counter 12345 already used for contract tz1...</code></p><p id="2aee" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">当您想要同时发送多个事务时，有不同的场景:例如，您可以在dapp中保存来自用户的每个更新请求，然后要求他们确认并一次发出它们。Taquito创建了<a class="ae ku" href="https://tezostaquito.io/docs/batch_API" rel="noopener ugc nofollow" target="_blank">批处理API </a>来简化这个过程。这是本教程的主题。</p><h1 id="0992" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">什么是批处理API？</h1><p id="b633" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">Taquito提供了一种简单的方式来伪造交易并将其发送到区块链，无论您希望将几个tez发送到某个地址还是与智能合同进行交互。每当Tezos帐户签署一项交易，其交易计数器就增加1。此功能可防止用户连续发送两个或多个事务，如以下代码片段所示:</p><pre class="jj jk jl jm fq ls kt lt lu aw lv dt"><span id="28d0" class="lw kw ht kt b fv lx ly l lz ma">/*  <br/>* ONE OF THESE TRANSACTIONS WILL FAIL  <br/>* AND YOU WILL GET AN ERROR MESSAGE  <br/>*/  </span><span id="496d" class="lw kw ht kt b fv mb ly l lz ma">const op1 = await contract.methods.interact("tezos").send();<br/>const op2 = await contract.methods.wait([["unit"]]).send();</span><span id="c9ee" class="lw kw ht kt b fv mb ly l lz ma">await op1.confirmation();<br/>await op2.confirmation();  </span><span id="026a" class="lw kw ht kt b fv mb ly l lz ma">/*  <br/>* Error Message returned by the node:  <br/>* "Error while applying operation opWH2nEcmmzUwK4T6agHg3bn9GDR7fW1ynqWL58AVRAb7aZFciD:  <br/>* branch refused (Error:  <br/>* Counter 1122148 already used for contract tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb (expected 1122149))"  <br/>*/</span></pre><p id="d95a" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">跟踪交易的确认和交易计数器的更新可能会非常令人沮丧和繁琐，这就是Taquito提供Batch API的原因。Batch API允许您将所有事务组合在一起，并在相同的事务计数器值下一次发出它们。</p><h1 id="711b" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">它是如何工作的？</h1><p id="8a8b" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">对象公开了一个名为<code class="eh kq kr ks kt b">batch</code>的方法。随后，返回的对象公开了6种不同的方法，这些方法可以根据要发出的事务数量进行连接。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mc"><img src="../Images/842c39ded2500c94d0bb28c8099acd52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OT2Xkm4VAk1qiOEC0VpC-w.png"/></div></div></figure><p id="b217" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">将不同的方法连接在一起进行批处理操作后，将创建一个事务，并通过返回的一个操作散列进行广播。对于Taquito创建的任何其他交易，您需要等待确定数量的确认。</p><h1 id="2885" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">withTransfer方法</h1><p id="4209" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">此方法允许您将tez转移添加到批处理操作中。它将一个对象作为具有4个属性的参数。其中两个是强制的:<code class="eh kq kr ks kt b">to</code>表示转账的收款人，<code class="eh kq kr ks kt b">amount</code>表示要转账的技术开发区金额。另外两个属性是可选的:如果<code class="eh kq kr ks kt b">mutez</code>被设置为<code class="eh kq kr ks kt b">true</code>，则<code class="eh kq kr ks kt b">amount</code>中指定的值被认为是mutez。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff md"><img src="../Images/56d06c13503b666e5fef3f8acca60066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZHeOkD3iR-xUkS5zbkVDIg.png"/></div></div></figure><h1 id="f769" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated"><code class="eh kq kr ks kt b">withOrigination</code>方法</h1><p id="aac2" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">此方法允许您将一个或多个合同的来源添加到现有的一批操作中。它将一个对象作为具有4个属性的参数。<code class="eh kq kr ks kt b">code</code>属性是强制的，可以是表示普通迈克尔逊代码的字符串，也可以是迈克尔逊契约的JSON表示。参数对象还必须包含一个<code class="eh kq kr ks kt b">init</code>或<code class="eh kq kr ks kt b">storage</code>属性:当指定了<code class="eh kq kr ks kt b">init</code>时，<code class="eh kq kr ks kt b">storage</code>是可选的，反之亦然。<code class="eh kq kr ks kt b">init</code>是初始存储对象值，可以是Micheline或JSON编码的。<code class="eh kq kr ks kt b">storage</code>是存储对象的JavaScript表示。可选地，您还可以为新创建的合同指定一个<code class="eh kq kr ks kt b">balance</code>和一个<code class="eh kq kr ks kt b">delegate</code>。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff me"><img src="../Images/d5d2da420494d77a8cee9b50fa698728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oc_ht034uMp-BDbtNQgWPA.png"/></div></div></figure><h1 id="94db" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated"><code class="eh kq kr ks kt b">withDelegation</code>方法</h1><p id="3cd3" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">这个简单的方法允许批处理多个委托事务。该方法将一个对象作为具有单一属性的参数:委托的地址。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mf"><img src="../Images/ba1b59ad30279b7040c9535a0f3b2543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YIaL79blwOb5JJQjjd-Uhw.png"/></div></div></figure><h1 id="c3ad" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated"><code class="eh kq kr ks kt b">withContractCall</code>方法</h1><p id="fdd2" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">这个方法可能是最有用的方法之一，因为它允许您在一个事务下批处理和发出多个契约调用。这个参数也非常简单:如果您要发送一个事务，那么它接受您在契约抽象对象上调用的函数。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mg"><img src="../Images/a99c88e710712374cd3bf5f3c7d30764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tb0OgPubT_jAJDOvReFTsA.png"/></div></div></figure><h1 id="cb25" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated"><code class="eh kq kr ks kt b">with</code>方法</h1><p id="ec70" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">如果您希望拥有一个数组，其中包含您想要发出的不同事务的对象，那么您可以使用<code class="eh kq kr ks kt b">with</code>方法。它允许您将事务作为对象分组，而不是连接函数调用。您使用的对象期望与相应方法的参数具有相同的属性，并具有一个额外的<code class="eh kq kr ks kt b">kind</code>属性，该属性指示您想要发出的事务类型(一个方便的<code class="eh kq kr ks kt b">opKind</code>枚举是从Taquito包中导出的<a class="ae ku" href="https://github.com/ecadlabs/taquito/blob/master/packages/taquito-rpc/src/opkind.ts" rel="noopener ugc nofollow" target="_blank">，带有<code class="eh kq kr ks kt b">kind</code>属性的有效值)。</a></p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mh"><img src="../Images/453611c95be80175acd843fb647d27bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6E9PIXfsBbe3k07xNFYQSQ.png"/></div></div></figure><blockquote class="mi mj mk"><p id="cdc3" class="ju jv ml jw b jx jy iu jz ka kb ix kc mm ke kf kg mn ki kj kk mo km kn ko kp hm dt translated">注意:您不能使用此方法进行约定调用。</p></blockquote><h1 id="7a16" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated"><code class="eh kq kr ks kt b">send</code>方法</h1><p id="0782" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">将所有必要的操作批处理在一起后，必须使用<code class="eh kq kr ks kt b">send</code>方法来发出它们。这一步与发出单个事务非常相似。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mp"><img src="../Images/b397e886cdcf91c5e6a5e9d37f09bc4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BIilB5Ip5DK4zk9VZTGtOQ.png"/></div></div></figure><p id="fa7a" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">与Taquito创建的其他操作一样，<code class="eh kq kr ks kt b">send</code>方法是一个承诺，它返回一个对象，在该对象中操作散列在<code class="eh kq kr ks kt b">hash</code>属性下可用，并且您可以在该对象中等待，直到用<code class="eh kq kr ks kt b">confirmation</code>方法确认交易(将您希望接收的确认数作为参数)。</p><h1 id="4e1a" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">有哪些局限性？</h1><p id="12e2" class="pw-post-body-paragraph ju jv ht jw b jx ln iu jz ka lo ix kc kd lp kf kg kh lq kj kk kl lr kn ko kp hm dt translated">分批操作的限制在单次操作的限制之内，例如，一起分批操作的数量受到Tezos区块链的气体限制。<br/>除此之外，批量操作只能由一个账户签名。</p><h1 id="056e" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">参考</h1><ul class=""><li id="8b3a" class="mq mr ht jw b jx ln ka lo kd ms kh mt kl mu kp mv mw mx my dt translated"><a class="ae ku" href="https://github.com/ecadlabs/taquito/blob/master/integration-tests/batch-api.spec.ts" rel="noopener ugc nofollow" target="_blank">集成测试</a></li><li id="996d" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" href="https://tezostaquito.io/typedoc/classes/_taquito_taquito.walletoperationbatch-2.html" rel="noopener ugc nofollow" target="_blank">文档</a></li></ul><h1 id="1311" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">另外，阅读</h1><ul class=""><li id="0bc7" class="mq mr ht jw b jx ln ka lo kd ms kh mt kl mu kp mv mw mx my dt translated">最好的<a class="ae ku" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="ab2a" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/deribit-review-options-fees-apis-and-testnet-2ca16c4bbdb2"> Deribit审查</a> |选项、费用、API和Testnet</li><li id="6778" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ftx-crypto-exchange-review-53664ac1198f"> FTX密码交易所评论</a></li><li id="51e2" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">最好的比特币<a class="ae ku" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069?source=friends_link&amp;sk=324dd9ff8556ab578d71e7ad7658ad7c">硬件钱包</a></li><li id="4268" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">密码本交易平台</a></li><li id="69bb" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">最好的<a class="ae ku" rel="noopener" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b">加密税务软件</a></li><li id="7c4f" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/the-best-crypto-trading-platforms-in-2020-the-definitive-guide-updated-c72f8b874555">最佳加密交易平台</a></li><li id="97a4" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">最佳<a class="ae ku" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">加密贷款平台</a></li><li id="ab33" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ledger-vs-trezor-best-hardware-wallet-to-secure-cryptocurrency-22c7a3fd391e">莱杰vs特雷佐</a></li><li id="9efe" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630">block fi vs Celsius</a>vs Hodlnaut</li><li id="1dc3" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">Bitsgap评论——一个轻松赚钱的加密交易机器人</li><li id="2401" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">为专业人士设计的加密交易机器人</li><li id="2791" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/primexbt-review-88e0815be858"> PrimeXBT审查</a> |杠杆交易、费用和交易</li><li id="4fc4" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/haasonline-review-d8d1a3400419">哈森在线评论</a>享受九折优惠</li><li id="eb27" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">Bitmex上的<a class="ae ku" rel="noopener" href="/coinmonks/the-idiots-guide-to-margin-trading-on-bitmex-dbbd7742c6fc?source=friends_link&amp;sk=7bfa99d2a181142510c8442c8ddb0786">保证金交易的白痴指南</a></li><li id="5279" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/etoro-review-78807ddeb33c"> eToro评论</a> |交易股票、密码、交易所交易基金、差价合约和商品</li><li id="aaab" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/bitmex-advanced-margin-trading-guide-2270c195ce25?source=friends_link&amp;sk=1d986cca731f5084b9a2db4a4bc4a7ad"> Bitmex高级保证金交易指南</a></li><li id="6e2e" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/best-crypto-apis-for-developers-5efe3a597a9f">面向开发人员的最佳加密API</a></li><li id="b037" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/crypto-arbitrage-guide-how-to-make-money-as-a-beginner-62bfe5c868f6">加密套利</a>指南:新手如何赚钱</li><li id="b46f" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">顶级<a class="ae ku" href="https://blog.coincodecap.com/bitcoin-node-solutions" rel="noopener ugc nofollow" target="_blank">比特币节点</a>提供商</li><li id="0966" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">最佳<a class="ae ku" rel="noopener" href="/coinmonks/what-are-the-best-charting-platforms-for-cryptocurrency-trading-85aade584d80">加密制图工具</a></li><li id="ef45" class="mq mr ht jw b jx mz ka na kd nb kh nc kl nd kp mv mw mx my dt translated">了解比特币最好的<a class="ae ku" rel="noopener" href="/coinmonks/what-are-the-best-books-to-learn-bitcoin-409aeb9aff4b">书籍有哪些？</a></li></ul><blockquote class="ne"><p id="b751" class="nf ng ht bd nh ni nj nk nl nm nn kp ek translated"><a class="ae ku" href="https://coincodecap.com?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="np nq nr ns nt jn fe ff paragraph-image"><a href="https://coincodecap.com?utm_source=coinmonks"><div class="fe ff no"><img src="../Images/160ce73bd06d46c2250251e7d5969f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*BoDnKUyK8p4hitHAJZ5Pdw.png"/></div></a></figure></div></div>    
</body>
</html>