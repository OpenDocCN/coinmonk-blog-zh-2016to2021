<html>
<head>
<title>Your first EOS dApp — The Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的第一个EOS dApp——合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/your-first-eos-dapp-the-contract-ce793f43d852?source=collection_archive---------2-----------------------#2018-05-31">https://medium.com/coinmonks/your-first-eos-dapp-the-contract-ce793f43d852?source=collection_archive---------2-----------------------#2018-05-31</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="fe ff iq"><img src="../Images/0d631cd3a85debf5c56bf7bcbece7fae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/0*SPIDFS54PCMvx7qb.png"/></div><figcaption class="ix iy fg fe ff iz ja bd b be z ek"><a class="ae jb" href="https://themerkle.com/eos-io-announces-major-updates-to-project/" rel="noopener ugc nofollow" target="_blank">source</a></figcaption></figure><p id="60ff" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">在我们的<a class="ae jb" rel="noopener" href="/coinmonks/your-first-eos-dapp-the-setup-dde55d3dcfb7">上一篇文章</a>中，我们设置了独立的EOS链以及我们的钱包和账户。在本文中，我们将编写用于管理学校入学抽奖的合同。我们将学习核心EOS概念，如</p><ul class=""><li id="07ec" class="ka kb ht je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">如何创建我的EOS智能合同</li><li id="d658" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">什么是<strong class="je hu"> <em class="ko"> web assembly </em> </strong>在EOS中有什么用途</li><li id="92c8" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">我如何部署我的EOS合同并与之交互</li></ul><h2 id="2ada" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">设置</h2><p id="4cd8" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">我建议使用类似于<a class="ae jb" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio Code </a>的IDE，但是你真的可以使用任何编辑器。让我们继续创建下面的文件和项目目录。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="df4a" class="kp kq ht lu b fv ly lz l ma mb">mkdir lottery &amp;&amp; cd lottery<br/>mkdir contracts &amp;&amp; cd contracts<br/>mkdir lottery &amp;&amp; cd lottery</span></pre><h2 id="a60c" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">密码</h2><p id="3c93" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">在<em class="ko">彩票/合同/彩票/彩票. cpp </em>路径下创建一个<em class="ko">彩票. cpp </em>文件</p><figure class="lp lq lr ls fq iu"><div class="bz el l di"><div class="mc md l"/></div></figure><h2 id="3622" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">编制</h2><p id="5260" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">EOS在<strong class="je hu"> Web Assembly </strong>上下了很大的赌注，并选择它作为执行合同的运行时环境。</p><blockquote class="me mf mg"><p id="be24" class="jc jd ko je b jf jg jh ji jj jk jl jm mh jo jp jq mi js jt ju mj jw jx jy jz hm dt translated"><em class="ht"> Web Assembly是微软、谷歌和苹果支持的新兴行业标准。该标准的目标是使在您的浏览器中运行不受信任的高性能代码成为可能。</em> <a class="ae jb" rel="noopener" href="/mozilla-tech/why-webassembly-is-a-game-changer-for-the-web-and-a-source-of-pride-for-mozilla-and-firefox-dda80e4c43cb"> <em class="ht"> Web Assembly是一款游戏改变者</em> </a> <em class="ht">，它将实现高性能的Web应用，如视频和图像编辑以及游戏。—丹·拉里默</em></p></blockquote><p id="9c22" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">这里我们生成web程序集(。wast)从我们的。cpp文件，这可以从我们在上一篇文章中的安装中获得。注意，如果你不在彩票/合同/彩票文件夹中，你需要调整你的路径。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="29f8" class="kp kq ht lu b fv ly lz l ma mb">eosiocpp -o Lottery.wast Lottery.cpp</span></pre><p id="cb1e" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">ABI对于大多数区块链项目来说都很常见，它本质上是一个描述调用者可用的智能契约的动作和属性的接口。请注意Lottery.cpp文件中的<em class="ko"> //@abi </em>语法，它告诉我们的<em class="ko"> eosiocpp </em>编译器要公开哪些成员以及以何种方式公开。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="bc81" class="kp kq ht lu b fv ly lz l ma mb">eosiocpp -g Lottery.abi Lottery.cpp</span></pre><h2 id="5ccb" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">部署</h2><p id="911f" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">如果您的EOS链尚未启动，您需要启动它。你可能也需要打开你的钱包。</p><p id="860b" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><strong class="je hu">启动链条</strong></p><p id="e1b9" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">您需要从安装和构建EOS的目录中运行下面的命令。</p><p id="3488" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><em class="ko">注意，我们正在运行</em> <strong class="je hu"> dawn-v4.1.0 </strong> <em class="ko">，我们有一个额外的参数，允许我们查看我们的</em><strong class="je hu"><em class="ko">print()</em></strong><em class="ko">方法，并且历史插件已经将名称改为</em><strong class="je hu"><em class="ko">history _ API _ plugin</em></strong></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="cf01" class="kp kq ht lu b fv ly lz l ma mb">./build/programs/nodeos/nodeos -e -p eosio --plugin eosio::wallet_api_plugin --plugin eosio::chain_api_plugin --plugin eosio::history_api_plugin --contracts-console</span></pre><p id="9d12" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><strong class="je hu">解锁钱包</strong></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="ba30" class="kp kq ht lu b fv ly lz l ma mb">cleos wallet unlock -n lottery</span></pre><p id="2bcd" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">输入您在上一篇文章中为<em class="ko">彩票</em>钱包保存的密码。</p><p id="15c4" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">你在<a class="ae jb" rel="noopener" href="/coinmonks/your-first-eos-dapp-the-setup-dde55d3dcfb7">上一篇文章</a>中的lottery.code账户应该仍然存在，但是如果你升级了链并且丢失了数据，你可以运行这个来重新创建它。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="0c53" class="kp kq ht lu b fv ly lz l ma mb">cleos create account eosio lottery.code &lt;owner public key&gt; &lt;active public key&gt;</span></pre><p id="48a2" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><strong class="je hu">部署合同</strong></p><p id="d777" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">现在我们有了<strong class="je hu">。浪费了</strong>和。<strong class="je hu"> abi </strong>文件使用运行链和解锁的钱包，我们可以部署此合同！<em class="ko">注意，该命令是从</em> <strong class="je hu"> <em class="ko">彩票</em> </strong> <em class="ko">根项目文件夹中运行的。</em></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="6ccb" class="kp kq ht lu b fv ly lz l ma mb">cleos set contract lottery.code ./contracts/lottery ./contracts/lottery/Lottery.wast ./contracts/lottery/Lottery.abi</span></pre></div><div class="ab cl mk ml hb mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hm hn ho hp hq"><h2 id="ca41" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated"><strong class="ak">测试账户</strong></h2><p id="a984" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">我们需要创建两个以上的帐户来运行此合同。</p><ul class=""><li id="961e" class="ka kb ht je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">管理员——这个账户是为管理彩票的学校管理员开设的</li><li id="c0b4" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated"><strong class="je hu">家长</strong> —该账户供家长为其学生报名参加抽奖</li></ul><p id="d56a" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">请运行此处描述的<a class="ae jb" rel="noopener" href="/coinmonks/your-first-eos-dapp-the-setup-dde55d3dcfb7">帐户创建过程，或查看下面的命令摘要。</a></p><p id="d79d" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><em class="ko">对于每个账户:</em></p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="7702" class="kp kq ht lu b fv ly lz l ma mb">// Generate owner public/private keys<br/>cleos create key</span><span id="213e" class="kp kq ht lu b fv mr lz l ma mb">// Import owner private key into wallet<br/>cleos wallet import &lt;owner private key hash&gt; -n lottery</span><span id="6445" class="kp kq ht lu b fv mr lz l ma mb">// Generate active public/private keys<br/>cleos create key</span><span id="19c2" class="kp kq ht lu b fv mr lz l ma mb">// Import active private key into wallet<br/>cleos wallet import &lt;active private key hash&gt; -n lottery</span><span id="5427" class="kp kq ht lu b fv mr lz l ma mb">// Create account<br/>cleos create account eosio &lt;account name&gt; &lt;owner public key&gt; &lt;active public key&gt;</span></pre><p id="fac0" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">一旦您创建了admin和parent帐户，我们将能够在本文的后面运行测试脚本。</p><h2 id="7c07" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated"><strong class="ak">与合同互动</strong></h2><p id="a4e2" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">既然契约已经部署到链中，我们就可以开始与它进行交互了。我们有三个面向用户的功能:</p><ul class=""><li id="15ed" class="ka kb ht je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">添加级别—我们需要添加级别和可用空缺(这应该只有主管帐户可以访问)</li><li id="ef19" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">删除等级—我们需要删除等级级别(这应该只有主管帐户可以访问)</li><li id="a429" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">获取级别—获取级别和可用空缺(所有客户都应该可以访问)</li><li id="7543" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">添加学生—我们需要一种方法，让家长能够输入他们孩子的信息，以便让他们参加抽奖。这应该适用于所有帐户，但我们将为此创建一个父帐户。此时，家长只能输入一名学生。</li><li id="4ab2" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">移除学生-输入学生的家长帐户应该能够将学生从彩票中移除。</li><li id="d574" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">获取学生-输入学生或主管的家长帐户应该能够让学生检查他/她的彩票状态</li><li id="38c6" class="ka kb ht je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">运行彩票——管理员帐户应该能够运行所有等级的彩票</li></ul><h2 id="d373" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">测试脚本</h2><p id="1ef0" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">为了提高效率，可以运行下面的测试脚本来说明上面的需求。</p><p id="4062" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><em class="ko">免责声明:除了要求调用者是授权帐户并拥有他们自己的插入数据之外，我无法探索合同上的权限。如果有人能告诉我锁定智能合同的某些行为的方向，那将会很有帮助。我能想到的唯一办法就是维护我自己的权限表？</em></p><figure class="lp lq lr ls fq iu"><div class="bz el l di"><div class="mc md l"/></div></figure><p id="a2d6" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">上面的测试在目前的形式下并不理想，但实际上在开发环境中没有一个是理想的。这个堆栈比truffle开发环境落后好几光年，但是我将在下一篇文章中探索使用<a class="ae jb" href="https://eosprojects.org/projects/p/eosfactory/" rel="noopener ugc nofollow" target="_blank"> Tokenika的产品EOS Factory </a>来解决一个更真实的开发者流。也就是说，做一些困难的事情并对EOS CLI工具有一个基本的了解是没有错的。</p></div><div class="ab cl mk ml hb mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hm hn ho hp hq"><h2 id="fcd3" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jn la lb lc jr ld le lf jv lg lh li lj dt translated">解决纷争</h2><p id="40c4" class="pw-post-body-paragraph jc jd ht je b jf lk jh ji jj ll jl jm jn lm jp jq jr ln jt ju jv lo jx jy jz hm dt translated">在本地运行EOS链是相当具有挑战性的，并且会出现它处于无效状态的情况。每天早上我必须重置我的链，因为交易已经过期，无法使用。</p><pre class="lp lq lr ls fq lt lu lv lw aw lx dt"><span id="5826" class="kp kq ht lu b fv ly lz l ma mb">rm -rf "~/Library/Application Support/eosio/nodeos/data"</span><span id="7ac3" class="kp kq ht lu b fv mr lz l ma mb">&lt;eos dir&gt;/build/programs/nodeos/nodeos -e -p eosio --plugin eosio::wallet_api_plugin --plugin eosio::chain_api_plugin --plugin eosio::history_api_plugin --contracts-console</span></pre></div></div>    
</body>
</html>