<html>
<head>
<title>IPFS Production Configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IPFS生产配置</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ipfs-production-configuration-57121f0daab2?source=collection_archive---------1-----------------------#2019-08-09">https://medium.com/coinmonks/ipfs-production-configuration-57121f0daab2?source=collection_archive---------1-----------------------#2019-08-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="491f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在不久的将来，我们的团队将使用IPFS进行生产服务，所以我调查了很多关于它的配置。我要分享我学到的知识。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/ed6178036fc477280c484ca0c81b6661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DKeJRSzx6Be_unUx1acpfA.jpeg"/></div></div></figure></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="80c4" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">1.准备</h2><p id="8508" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">首先，导出“IPFS _路径”。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="11e0" class="kh ki ht li b fv lm ln l lo lp">export IPFS_PATH=/data/ipfsrep</span></pre><p id="74ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">IPFS存储库创建到此路径。默认路径是您的$HOME。为了以后方便起见，我强烈建议将这个路径设置到适当的位置。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="d30a" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">2.知识库初始化</h2><p id="3442" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">使用“—配置文件服务器”选项初始化存储库。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="d7bb" class="kh ki ht li b fv lm ln l lo lp">ipfs init —- profile server</span></pre><p id="47ba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">此选项通过禁用本地网络中的主机和内容发现来优化数据中心的IPFS配置。见<a class="ae lq" href="https://docs.ipfs.io/introduction/usage/" rel="noopener ugc nofollow" target="_blank">公文</a></p><blockquote class="lr ls lt"><p id="30cf" class="iq ir lu is b it iu iv iw ix iy iz ja lv jc jd je lw jg jh ji lx jk jl jm jn hm dt translated">如果在数据中心的服务器上运行，应该用服务器配置文件初始化IPFS。这将防止IPFS创建大量数据中心内部流量来尝试发现本地节点</p></blockquote></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="a9df" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">3.编辑配置文件</h2><p id="5039" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">IPFS为我们提供了命令行“配置”选项，尽管我认为手动编辑配置文件很容易。配置文件位于“IPFS路径”的正下方</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="1a46" class="kh ki ht li b fv lm ln l lo lp">vi $IPFS_PATH/config</span></pre><p id="cc97" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从头开始，编辑“地址”。API "和"地址。网关”。虽然网关是只读的，但API是可写的。当您将网关设置为“0.0.0.0”时，网关对互联网开放。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="b939" class="kh ki ht li b fv lm ln l lo lp">"Addresses": {<br/>  "API": "/ip4/127.0.0.1/tcp/5001",<br/>  "Gateway": "/ip4/0.0.0.0/tcp/8080",</span></pre><p id="ba44" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，编辑“数据存储。StorageMax”。这是IPFS存储库的数据存储大小的上限。默认值为“10GB”，但您可能需要更多。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="3f50" class="kh ki ht li b fv lm ln l lo lp">"StorageMax": "100GB"</span></pre><p id="8381" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，遵循<a class="ae lq" href="https://cluster.ipfs.io/documentation/deployment/setup/" rel="noopener ugc nofollow" target="_blank">官方指令</a>。基本上，这个网站是为集群，但也有助于单一的。</p><blockquote class="lr ls lt"><p id="1c62" class="iq ir lu is b it iu iv iw ix iy iz ja lv jc jd je lw jg jh ji lx jk jl jm jn hm dt translated">增加虫群。ConnMgr.HighWater(最大连接数)并将宽限期减少到20秒。</p></blockquote><p id="2d85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">“HighWater”是连接数，当超过该值时，将触发连接GC操作。“宽限期”是新连接免于被连接管理器关闭的持续时间。</p><blockquote class="lr ls lt"><p id="ce96" class="iq ir lu is b it iu iv iw ix iy iz ja lv jc jd je lw jg jh ji lx jk jl jm jn hm dt translated">增加数据存储。BloomFilterSize根据您的回购大小(以字节为单位):1048576 (1MB)是一个很好的值</p></blockquote><p id="5f5e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">“BloomFilterSize”是表示块存储的bloom过滤器的字节大小的数字。</p><blockquote class="lr ls lt"><p id="9f9b" class="iq ir lu is b it iu iv iw ix iy iz ja lv jc jd je lw jg jh ji lx jk jl jm jn hm dt translated">他<code class="eh ly lz ma li b">IPFS_FD_MAX</code>环境变量控制<code class="eh ly lz ma li b">go-ipfs</code>为自己设置的FD <code class="eh ly lz ma li b">ulimit</code>值。根据您的<code class="eh ly lz ma li b">Highwater</code>值，您可能希望将其增加到<code class="eh ly lz ma li b">8192</code>或更高。</p></blockquote><p id="fc8e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">FD表示文件描述符。“IPFS_FD_MAX”指定打开文件描述符限制。<br/>根据此代码，<a class="ae lq" href="https://github.com/ipfs/go-ipfs/blob/master/cmd/ipfs/util/ulimit.go" rel="noopener ugc nofollow" target="_blank">默认最大FD </a>为“8192”，最好设置为“8192”。</p><p id="9504" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后，如果您使用as Gateway，请编辑“Gateway。HTTPHeaders”。默认情况下，CORS处于启用状态。我们可以在这里指定“Access-Control-Allow-Headers”或“Access-Control-Allow-Origin”。如果你从来没有以可写的方式运行Gateway，最好从“Access-Control-Allow-Methods”中删除“POST”和“PUT”方法。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="b7ce" class="kh ki ht li b fv lm ln l lo lp">"Gateway": {<br/>  "APICommands": [],<br/>  "HTTPHeaders": {<br/>    "Access-Control-Allow-Headers": [<br/>      "X-Requested-With",<br/>      "Range",<br/>      "User-Agent"<br/>    ],<br/>    "Access-Control-Allow-Methods": [<br/>      "GET"<br/>    ],<br/>    "Access-Control-Allow-Origin": [<br/>      "*"<br/>    ]<br/>  },</span></pre></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="9819" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">4.运行背景</h2><p id="cb28" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">出于开发目的，您可以通过一个简单的命令启动IPFS后台进程。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="0c07" class="kh ki ht li b fv lm ln l lo lp">ipfs daemon &gt; $IPFS_PATH/ipfs-`date +%Y%m%d%H%M%S`.log &amp;</span></pre><p id="fc56" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后，像这个命令一样停止。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="cec3" class="kh ki ht li b fv lm ln l lo lp">ps ax | grep ipfs | head -n 1 | awk ‘{print $1}’ | xargs kill</span></pre><p id="3f5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">出于生产目的，最好使用systemd。创建系统用户并更改“$ IPFS _路径”的所有者。然后，创建一个名为“ipfs.service”的配置文件。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="8dd1" class="kh ki ht li b fv lm ln l lo lp">adduser — system — group ipfs<br/>chown -R ipfs:ipfs $IPFS_PATH<br/>vi /lib/systemd/system/ipfs.service</span></pre><p id="260c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">至于配置，<a class="ae lq" href="https://github.com/ipfs/go-ipfs/issues/1430" rel="noopener ugc nofollow" target="_blank">这个GitHub问题</a>很有帮助。</p><p id="8b3a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如下图所示的示例配置。请根据您的环境更改“IPFS路径”。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="6c13" class="kh ki ht li b fv lm ln l lo lp">[Unit]<br/>Description=IPFS daemon<br/>After=network.target<br/>Requires=network.target</span><span id="2a7b" class="kh ki ht li b fv mb ln l lo lp">[Service]<br/>Type=simple<br/>User=ipfs<br/>RestartSec=1<br/>Restart=always<br/>Environment=IPFS_PATH=/data/ipfsrep<br/>Environment=IPFS_FD_MAX=8192<br/>ExecStart=/usr/local/bin/ipfs daemon</span><span id="31e9" class="kh ki ht li b fv mb ln l lo lp">[Install]<br/>WantedBy=multiuser.target</span></pre></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="fec1" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">5.支持HTTPS</h2><p id="fbd6" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">IPFS不支持HTTPS，所以我们需要准备一个代理服务器或负载均衡器，用于SSL卸载。</p><p id="fb19" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">代理设置见<a class="ae lq" href="https://hackernoon.com/public-ipfs-node-behind-nginx-reverse-proxy-5682747f174b" rel="noopener ugc nofollow" target="_blank">这篇博文</a>。</p><p id="9ff4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">关于azure负载平衡器的设置，请参见<a class="ae lq" rel="noopener" href="/@t.tak/build-https-support-load-balancer-on-azure-81e111e58d98">我之前的博文</a>。</p><p id="acf0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">供您参考，默认API端口是“5001”，默认网关端口是“8080”。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="acdf" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">6.停止拥挤</h2><p id="52c6" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">IPFS正在尝试根据引导对等列表连接其他节点。您可以通过下面的命令看到它。</p><pre class="jp jq jr js fq lh li lj lk aw ll dt"><span id="77ee" class="kh ki ht li b fv lm ln l lo lp">ipfs bootstrap list</span></pre><p id="fa6a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你使用IPFS作为只读，我认为最好停止蜂拥而至，以节省网络费用。默认端口是“4001”。请记住，你需要关闭入境，此外出境以及。IPFS节点试图从自身连接，因此我们需要关闭出站。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="47a7" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">7.备份和恢复</h2><p id="b690" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">您只需备份“$ IPFS _路径”下的所有文件。您可以恢复“$IPFS路径”文件下的所有数据。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="5007" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">8.集群设置</h2><p id="17ae" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">不幸的是，我们的团队不使用集群，所以请查看<a class="ae lq" href="https://cluster.ipfs.io/" rel="noopener ugc nofollow" target="_blank">官方网站</a>或<a class="ae lq" rel="noopener" href="/@rossbulat/using-ipfs-cluster-service-for-global-ipfs-data-persistence-69a260a0711c">有用的博客文章</a>。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="31d6" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">9.将哈希存储到以太坊的技巧</h2><p id="1f5c" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">对于打算将IPFS哈希存储到以太坊的人，告诉你节省汽油费用的技巧。不要将IPFS哈希存储为字符串类型。将其存储为bytes32类型。IPFS哈希字符串比字节32消耗更多的内存，所以它的成本很高。</p><p id="6916" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae lq" href="https://ethereum.stackexchange.com/questions/44506/ipfs-hash-algorithm" rel="noopener ugc nofollow" target="_blank"> IPFS哈希是base58编码值</a>。所以我们只需对其进行解码以获得字节32。</p><p id="a47b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">参见<a class="ae lq" href="https://github.com/OriginProtocol/origin/blob/master/packages/ipfs/src/index.js" rel="noopener ugc nofollow" target="_blank">原始协议代码</a>作为代码示例。参见<a class="ae lq" rel="noopener" href="/layerx/how-to-reduce-gas-cost-in-solidity-f2e5321e0395">我之前的博客</a>了解更多节省汽油费用的技巧。</p></div><div class="ab cl ka kb hb kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hm hn ho hp hq"><h2 id="5c53" class="kh ki ht bd kj kk kl km kn ko kp kq kr jb ks kt ku jf kv kw kx jj ky kz la lb dt translated">摘要</h2><p id="62a1" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">IPFS生产配置信息较少，因此可能不足以完成上述步骤。请继续关注更新</p><p id="1b2e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你运行一个小的服务，这些步骤可能太多了。在这种情况下，只需使用“—配置文件服务器”选项初始化存储库。IPFS优化配置。</p><p id="166d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">希望能有所帮助。</p><blockquote class="mc"><p id="e56a" class="md me ht bd mf mg mh mi mj mk ml jn ek translated"><a class="ae lq" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mn mo mp mq mr jt fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mm"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>