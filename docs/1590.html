<html>
<head>
<title>Tutorial Chaincode Event Listener on Hyperledger Fabric Java SDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hyperledger Fabric Java SDK上的Chaincode事件监听器教程</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/tutorial-chaincode-event-listener-on-hyperledger-fabric-java-sdk-557304f1fe28?source=collection_archive---------2-----------------------#2018-10-03">https://medium.com/coinmonks/tutorial-chaincode-event-listener-on-hyperledger-fabric-java-sdk-557304f1fe28?source=collection_archive---------2-----------------------#2018-10-03</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="42d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">大家好！本教程面向所有对fabric-sdk-java有一定经验的Java开发人员。今天，我想向您展示如何设置一个“Chaincode事件监听器”,以准确了解您提交的交易最终在区块链中提交的时间，如图中描述的工作流程。</p><blockquote class="jo"><p id="8d36" class="jp jq ht bd jr js jt ju jv jw jx jn ek translated"><a class="ae jy" href="https://coincodecap.com" rel="noopener ugc nofollow" target="_blank">发现并回顾最佳区块链软件</a></p></blockquote><p id="3561" class="pw-post-body-paragraph iq ir ht is b it jz iv iw ix ka iz ja jb kb jd je jf kc jh ji jj kd jl jm jn hm dt translated">在进入代码之前，我先给你事件的定义:事件是你将fabric与不同系统集成的主要方式。所以由此你可以理解掌握事件的创建、倾听和处理的重要性。</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff ke"><img src="../Images/61b41d9cd3c116847ea0b21480a580ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UdWdIBkO35oRlsY42UbrKQ.png"/></div></div><figcaption class="kq kr fg fe ff ks kt bd b be z ek">Developer Interaction in Hyperledger Fabric</figcaption></figure><p id="8d5e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">先决条件是要有一个已经在运行的系统，正如<a class="ku kv gr" href="https://medium.com/u/86b31a38e345?source=post_page-----557304f1fe28--------------------------------" rel="noopener" target="_blank">的</a><a class="ae jy" rel="noopener" href="/@lkolisko/hyperledger-fabric-sdk-java-basics-tutorial-a67b2b898410">这个教程</a>中很好地解释的那样。</p><p id="a252" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有了可以从Java SDK调用的工作链代码的基本系统后，就可以开始在代码中包含事件了。</p><p id="0e49" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们需要修改、创建或实现的文件依次是:</p><ol class=""><li id="86f1" class="kw kx ht is b it iu ix iy jb ky jf kz jj la jn lb lc ld le dt translated"><strong class="is hu"> chaincode </strong> —我们需要用<a class="ae jy" href="https://godoc.org/github.com/hyperledger/fabric/core/chaincode/shim#ChaincodeStub.SetEvent" rel="noopener ugc nofollow" target="_blank">垫片在“PutState”之后设置来自chaincode的事件。ChaincodeStubInterface . set event</a>。</li><li id="d4f3" class="kw kx ht is b it lf ix lg jb lh jf li jj lj jn lb lc ld le dt translated"><strong class="is hu">chaincodeventcapture</strong>—我们需要创建这个类来捕获链码事件。</li><li id="7cef" class="kw kx ht is b it lf ix lg jb lh jf li jj lj jn lb lc ld le dt translated"><strong class="is hu">chaincodeEvents</strong>—这是一个列表，确切地说是当事件来自链码时填充的向量&lt; ChaincodeEventCapture &gt;。</li><li id="c9f1" class="kw kx ht is b it lf ix lg jb lh jf li jj lj jn lb lc ld le dt translated"><strong class="is hu">chaincode event listener</strong>—这是我们需要实现来接收chaincode事件的接口。</li></ol><h1 id="156d" class="lk ll ht bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh dt translated">在链码中设置事件(发出事件)</h1><p id="b618" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">这部分是最简单的一个过程(是啊，谢谢你去！)，你基本上要在PutState之后立即添加SetEvent，让chaincode发出事件。关于事件的所有事情在<a class="ae jy" href="https://www.youtube.com/watch?v=qf7Vr2IgL_Q" rel="noopener ugc nofollow" target="_blank">这个视频</a>里真的解释的很好。</p><p id="b66a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在重要的是要知道每个事务只能设置一个事件(只有最后一个SetEvent会被传输回SDK)</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff mn"><img src="../Images/d4efc59c214bec94c296c70c8f8f62ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PmggWfHAc6_fXW64llUBKw.jpeg"/></div></div></figure><p id="2e61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我展示了一个代码示例，您可以从这个<a class="ae jy" href="https://github.com/pavva91/invokeapi/blob/master/agentInvokeCall.go" rel="noopener ugc nofollow" target="_blank"> repo </a>中找到。</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="d723" class="mt ll ht mp b fv mu mv l mw mx">// tSet Event in the chaincodehis call do the PutState after some checks<br/>agent := a.CreateAgent(agentId, agentName, agentAddress, stub)  <br/>// ==== Agent saved. Set Event ===<br/>eventPayload:="Created Agent: " + agentId<br/>payloadAsBytes := []byte(eventPayload)<br/>eventError := stub.SetEvent("AgentCreatedEvent",payloadAsBytes)</span></pre><p id="ba82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">添加我们为从链代码部分发出的事件所做的这3行代码，现在让我们跳到Java客户端应用程序— SDK部分！</p><h1 id="79a2" class="lk ll ht bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh dt translated">创建ChaincodeEventCapture类</h1><p id="5d1f" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">现在是时候创建类来捕获链码事件了，我从<a class="ae jy" href="https://github.com/hyperledger/fabric-sdk-java/blob/master/src/test/java/org/hyperledger/fabric/sdkintegration/End2endIT.java" rel="noopener ugc nofollow" target="_blank"> fabric-sdk官方测试</a>的端到端测试场景中学到了这种方法。</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="2bd2" class="mt ll ht mp b fv mu mv l mw mx">public class ChaincodeEventCapture { <br/>  private final String handle;<br/>  private final BlockEvent blockEvent;<br/>  private final ChaincodeEvent chaincodeEvent;<br/><br/>  public ChaincodeEventCapture(String handle, BlockEvent blockEvent,<br/>      ChaincodeEvent chaincodeEvent) {<br/>    this.handle = handle;<br/>    this.blockEvent = blockEvent;<br/>    this.chaincodeEvent = chaincodeEvent;<br/>  }<br/><br/>  <em class="my">/**<br/>   * </em><strong class="mp hu"><em class="my">@return </em></strong><em class="my">the handle<br/>   */<br/>  </em>public String getHandle() {<br/>    return handle;<br/>  }<br/><br/>  <em class="my">/**<br/>   * </em><strong class="mp hu"><em class="my">@return </em></strong><em class="my">the blockEvent<br/>   */<br/>  </em>public BlockEvent getBlockEvent() {<br/>    return blockEvent;<br/>  }<br/><br/>  <em class="my">/**<br/>   * </em><strong class="mp hu"><em class="my">@return </em></strong><em class="my">the chaincodeEvent<br/>   */<br/>  </em>public ChaincodeEvent getChaincodeEvent() {<br/>    return chaincodeEvent;<br/>  }<br/>}</span></pre><h1 id="f2f1" class="lk ll ht bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh dt translated">创建ChaincodeEventCapture列表</h1><p id="f278" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">这个列表是这种方法的核心，因为它将填充侦听器捕获的事件。</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="f896" class="mt ll ht mp b fv mu mv l mw mx">Vector&lt;ChaincodeEventCapture&gt; chaincodeEvents = new Vector&lt;&gt;();</span></pre><h1 id="f3d4" class="lk ll ht bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh dt translated">实现链码事件监听器</h1><p id="d846" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">这个列表是这种方法的核心，因为它将填充侦听器捕获的事件。(<a class="ae jy" href="https://github.com/hyperledger/fabric-sdk-java/blob/master/src/main/java/org/hyperledger/fabric/sdk/ChaincodeEventListener.java" rel="noopener ugc nofollow" target="_blank">此处接口声明</a>)</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="2683" class="mt ll ht mp b fv mu mv l mw mx">ChaincodeEventListener chaincodeEventListener = new ChaincodeEventListener() {<br/><br/>    @Override<br/>    public void received(String handle, BlockEvent blockEvent,     ChaincodeEvent chaincodeEvent) {<br/>        chaincodeEvents.add(new ChaincodeEventCapture(handle, blockEvent, chaincodeEvent));<br/><br/>        String eventHub = blockEvent.getPeer();</span><span id="fb62" class="mt ll ht mp b fv mz mv l mw mx">if(eventHub != null){ <br/>            eventHub = blockEvent.getPeer().getName()<br/>        } else {<br/>            eventHub = blockEvent.getEventHub().getName();<br/>        }<br/>        // Here put what you want to do when receive chaincode event<br/>        System.out.println("RECEIVED CHAINCODE EVENT with handle: " + handle + ", chaincodeId: " + chaincodeEvent.getChaincodeId() + ", chaincode event name: " + chaincodeEvent.getEventName() + ", transactionId: " + chaincodeEvent.getTxId() +", event Payload: " + new String(chaincodeEvent.getPayload()) + ", from eventHub: " + eventHub));</span><span id="41a5" class="mt ll ht mp b fv mz mv l mw mx">    }<br/>};</span></pre><h1 id="5e35" class="lk ll ht bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh dt translated">让我们把所有的东西放在一起！</h1><p id="301f" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">首先，在我的实现中，我创建了封装ChaincodeEventListener实现及其注册的方法:</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="8462" class="mt ll ht mp b fv mu mv l mw mx">public static String setChaincodeEventListener(Channel channel,<br/>    String expectedEventName, Vector&lt;ChaincodeEventCapture&gt; chaincodeEvents)<br/>    throws InvalidArgumentException {<br/><br/>    ChaincodeEventListener chaincodeEventListener = new ChaincodeEventListener() {<br/><br/>        @Override public void received(String handle, BlockEvent blockEvent,<br/>            ChaincodeEvent chaincodeEvent) {// ...the code up...}<br/>    };<br/>    // chaincode events.<br/>    String eventListenerHandle = channel.registerChaincodeEventListener(Pattern.<em class="my">compile</em>(".*"),<br/>        Pattern.<em class="my">compile</em>(Pattern.<em class="my">quote</em>(expectedEventName)), chaincodeEventListener);<br/>    return eventListenerHandle;<br/>}</span></pre><p id="234c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第二，我们去调用链码，因为你已经开始在<a class="ae jy" rel="noopener" href="/@lkolisko/hyperledger-fabric-sdk-java-basics-tutorial-a67b2b898410">这篇文章</a>中添加事件处理部分。</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="4a16" class="mt ll ht mp b fv mu mv l mw mx">public boolean createAgent(HFClient clientHF, User userHF, Channel channel, Agent newAgent)<br/>    throws ProposalException, InvalidArgumentException {<br/><br/>    String chaincodeFunctionName = "CreateAgent";<br/><br/>    String agentId = newAgent.getAgentId().toString();<br/>    String agentName = newAgent.getName().toString();<br/>    String agentAddress = newAgent.getAddress().toString();<br/><br/>    String[] chaincodeArguments = new String[] {agentId, agentName, agentAddress};<br/><br/>    Collection&lt;ProposalResponse&gt; successful = new LinkedList&lt;&gt;();<br/>    Collection&lt;ProposalResponse&gt; failed = new LinkedList&lt;&gt;();<br/><br/>    // START CHAINCODE EVENT LISTENER HANDLER----------------------<br/>    String expectedEventName = "AgentCreatedEvent";<br/>    Vector&lt;ChaincodeEventCapture&gt; chaincodeEvents = new Vector&lt;&gt;(); // Test list to capture<br/>    String chaincodeEventListenerHandle =<br/>        SdkIntegration.<em class="my">setChaincodeEventListener</em>(channel, expectedEventName, chaincodeEvents);<br/>    // END CHAINCODE EVENT LISTENER HANDLER------------------------<br/><br/>    Collection&lt;ProposalResponse&gt; invokePropResp =<br/>        <em class="my">writeBlockchain</em>(clientHF, userHF, channel, chaincodeName, chaincodeFunctionName,<br/>            chaincodeArguments);<br/><br/>    boolean allPeerSucces = <em class="my">printWriteProposalResponse</em>(successful, failed, invokePropResp);<br/><br/>    System.<em class="my">out</em>.println("successfully received transaction proposal responses.");<br/><br/>    <em class="my">/**<br/>     * Send transaction to orderer only if all peer success<br/>     */<br/><br/>    sendTxToOrderer</em>(userHF, channel, successful, allPeerSucces);<br/><br/>    // START WAIT FOR THE EVENT-------------------------------------<br/>    boolean eventDone = false;<br/>    eventDone = SdkIntegration<br/>        .<em class="my">waitForChaincodeEvent</em>(150, channel, chaincodeEvents, chaincodeEventListenerHandle);<br/>    <em class="my">log</em>.info("eventDone: " + eventDone);<br/>    // END WAIT FOR THE EVENT---------------------------------------<em class="my"><br/>    </em>return allPeerSucces;<br/><br/>}</span></pre><p id="ecdc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">正如您可以在上面的代码中看到的，我们向调用添加了两个部分(在注释中用尾随行突出显示了开始和结束部分:</p><ol class=""><li id="cd82" class="kw kx ht is b it iu ix iy jb ky jf kz jj la jn lb lc ld le dt translated"><strong class="is hu">在写入区块链</strong>之前，我们首先创建一个空列表，该列表将由event listener(Vector&lt;chaincode event capture&gt;chaincode events = new Vector&lt;&gt;())填充事件；)其次我们创建ChaincodeEventListener，调用之前定义的函数(setChaincodeEventListener)。（</li><li id="14fc" class="kw kx ht is b it lf ix lg jb lh jf li jj lj jn lb lc ld le dt translated"><strong class="is hu">在将(成功的)交易建议发送给订购者</strong>之后—在这一部分中，我们主要等待调用此处显示的waitForChaincodeEvent函数的事件，它基本上是一个超时的服务员:</li></ol><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="89c5" class="mt ll ht mp b fv mu mv l mw mx">public static boolean waitForChaincodeEvent(Integer timeout, Channel channel,<br/>    Vector&lt;ChaincodeEventCapture&gt; chaincodeEvents, String chaincodeEventListenerHandle)<br/>    throws InvalidArgumentException {<br/>    boolean eventDone = false;<br/>    if (chaincodeEventListenerHandle != null) {<br/><br/><br/>        int numberEventsExpected = channel.getEventHubs().size() + channel<br/>            .getPeers(EnumSet.<em class="my">of</em>(Peer.PeerRole.<em class="my">EVENT_SOURCE</em>)).size();<br/>        <em class="my">log</em>.info("numberEventsExpected: " + numberEventsExpected);<br/>        //just make sure we get the notifications<br/>        if (timeout.equals(0)) {<br/>            // get event without timer<br/>            while (chaincodeEvents.size() != numberEventsExpected) {<br/>                // do nothing<br/>            }<br/>            eventDone = true;<br/>        } else {<br/>            // get event with timer<br/>            for (int i = 0; i &lt; timeout; i++) {<br/>                if (chaincodeEvents.size() == numberEventsExpected) {<br/>                    eventDone = true;<br/>                    break;<br/>                } else {<br/>                    try {<br/>                        double j = i;<br/>                        j = j / 10;<br/>                        <em class="my">log</em>.info(j + " second");<br/>                        Thread.<em class="my">sleep</em>(100); // wait for the events for one tenth of second.<br/>                    } catch (InterruptedException e) {<br/>                        e.printStackTrace();<br/>                    }<br/>                }<br/>            }<br/>        }<br/><br/>        <em class="my">log</em>.info("chaincodeEvents.size(): " + chaincodeEvents.size());<br/><br/>        // unregister event listener<br/>        channel.unregisterChaincodeEventListener(chaincodeEventListenerHandle);<br/>        int i = 1;<br/>        // arrived event handling<br/>        for (ChaincodeEventCapture chaincodeEventCapture : chaincodeEvents) {<br/>            <em class="my">log</em>.info("Event number. " + i);<br/>            <em class="my">log</em>.info("event capture object: " + chaincodeEventCapture.toString());<br/>            <em class="my">log</em>.info("Event Handle: " + chaincodeEventCapture.getHandle());<br/>            <em class="my">log</em>.info("Event TxId: " + chaincodeEventCapture.getChaincodeEvent().getTxId());<br/>            <em class="my">log</em>.info("Event Name: " + chaincodeEventCapture.getChaincodeEvent().getEventName());<br/>            <em class="my">log</em>.info("Event Payload: " + chaincodeEventCapture.getChaincodeEvent()<br/>                .getPayload()); // byte<br/>            <em class="my">log</em>.info("Event ChaincodeId: " + chaincodeEventCapture.getChaincodeEvent()<br/>                .getChaincodeId());<br/>            BlockEvent blockEvent = chaincodeEventCapture.getBlockEvent();<br/>            try {<br/>                <em class="my">log</em>.info("Event Channel: " + blockEvent.getChannelId());<br/>            } catch (InvalidProtocolBufferException e) {<br/>                e.printStackTrace();<br/>            }<br/>            <em class="my">log</em>.info("Event Hub: " + blockEvent.getEventHub());<br/>          <br/>            i++;<br/>        }<br/><br/>    } else {<br/>        <em class="my">log</em>.info("chaincodeEvents.isEmpty(): " + chaincodeEvents.isEmpty());<br/>    }<br/>    <em class="my">log</em>.info("eventDone: " + eventDone);<br/>    return eventDone;<br/>}</span></pre><p id="439a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了简单起见，如果您想第一次测试事件处理的工作情况，您可以用这个空while(我不推荐)替换最后一个函数(waitForChaincodeEvent):</p><pre class="kf kg kh ki fq mo mp mq mr aw ms dt"><span id="fbb9" class="mt ll ht mp b fv mu mv l mw mx">        while (chaincodeEvents.isEmpty()) {<br/>            // do nothing<br/>        }</span></pre><p id="ddd4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们完成了！您正在hyperledger-fabric Java SDK上处理chaincode事件！</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff na"><img src="../Images/222fba7616749453c59e7b669349d11f.png" data-original-src="https://miro.medium.com/v2/resize:fit:522/1*7PzUDZE0Vy_Wd2VmsDU-7g.gif"/></div></figure><p id="f2af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">希望这个教程有用！如果是，不要犹豫，给我一个响亮的掌声！；)</p><p id="db7d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">再见！</p><p id="cc22" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">— <em class="my">瓦莱里奥</em></p><blockquote class="jo"><p id="dc49" class="jp jq ht bd jr js jt ju jv jw jx jn ek translated"><a class="ae jy" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="nc nd ne nf ng kj fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nb"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>