<html>
<head>
<title>Future-proofing ERC20 tokens</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向未来的ERC20令牌</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/future-proofing-erc20-tokens-7b8c27acedfb?source=collection_archive---------7-----------------------#2018-05-29">https://medium.com/coinmonks/future-proofing-erc20-tokens-7b8c27acedfb?source=collection_archive---------7-----------------------#2018-05-29</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="52cd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">作者:Neeraj Kashyap</p><figure class="jo jp jq jr fq js fe ff paragraph-image"><div class="ab fr cl jt"><img src="../Images/f5b6670eb31f03d9149b6b873be49c3c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*N4Xyvmrm-6uMzJcKkU7BMw.png"/></div><figcaption class="jw jx fg fe ff jy jz bd b be z ek"><a class="ae ka" rel="noopener" href="/blockchannel/the-anatomy-of-erc20-c9e5c5ff1d02">source</a></figcaption></figure><p id="f81b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">自2015年11月下旬推出以来，<a class="ae ka" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" rel="noopener ugc nofollow" target="_blank"> ERC20令牌标准</a>已经成为以太坊区块链上实现自定义货币的标准接口。在撰写本文时，区块链以太坊的ERC20代币的总市值约为数百亿美元。mindshare的这种优势表明，支持使用ERC20令牌进行交易的应用程序数量将在短期内激增。随着<a class="ae ka" href="https://www.google.com/search?q=erc20+wallets" rel="noopener ugc nofollow" target="_blank">对钱包符合ERC20标准的需求</a>，这一趋势已经开始。在应用程序层面，随着机构群体解决围绕ERC20令牌的治理和公共决策问题，我们应该会看到基本使用ERC20令牌的应用程序的复杂程度将远远超过钱包。我相信这些问题已经在<a class="ae ka" rel="noopener" href="/makerdao/what-is-mkr-e6915d5ca1b3"> MKR社区</a>讨论过了。</p><p id="20f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">自从引入ERC20令牌标准以来，社区已经发现了各种ERC20实现中的缺陷。例如:</p><ol class=""><li id="4aeb" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated">无法恢复无意中发送给不知道如何与之交互的合同或钱包的令牌。(这促使了EIP223 的出现，该报告称，这一问题造成的财富损失总额超过300万美元。)</li><li id="7fe3" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated"><a class="ae ka" href="https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit?usp=sharing" rel="noopener ugc nofollow" target="_blank">ERC 20 API:Approve/transfer from方法的攻击载体</a></li><li id="17a8" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">最近的<a class="ae ka" href="https://cryptoslate.com/batchoverflow-exploit-creates-trillions-of-ethereum-tokens/" rel="noopener ugc nofollow" target="_blank"> BatchOverflow漏洞利用</a>。</li></ol><p id="d35f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">任何负责在主网上部署ERC20令牌的人都应该牢记，随着时间的推移，我们会发现更多针对不同ERC20实现的缺陷和攻击媒介。我们不应该假设我们的ERC20特定实现可以避免这种漏洞，尤其是在真金白银岌岌可危的情况下。</p><p id="722d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">此外，随着像<a class="ae ka" href="https://github.com/ethereum/EIPs/issues/223" rel="noopener ugc nofollow" target="_blank"> ERC223 </a>和现在的<a class="ae ka" href="https://github.com/ethereum/EIPs/issues/777" rel="noopener ugc nofollow" target="_blank"> ERC777 </a>这样的提议，我们看到合同开发者社区越来越多地重复ERC20的想法。考虑到环境变化的速度，我们应该为ERC20接口的某个后代篡夺其在以太坊区块链的当前位置做好准备。</p><p id="9d42" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">所有这些意味着，当我们部署一个令牌或者一个与这样一个令牌接口的契约时，我们应该致力于尽可能容易地升级底层令牌实现。</p><p id="5b82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">升级ERC20令牌时的主要挑战是如何转移令牌内部分类帐的状态，这些分类帐表示:</p><ol class=""><li id="d5d3" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated">属于每个账户的代币数量，</li><li id="f3ea" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">一个帐户授权另一个帐户代表其转移的令牌数。</li></ol><p id="bfe9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这很困难的原因是，如果这些分类帐存储在智能合同本身中，它们可能非常大的事实使得将它们复制到新合同的交易开销非常昂贵。</p><p id="6148" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">编写可升级智能合约的一类建议涉及将这些合约的存储功能与实际逻辑分离。以下文章展示了这一理念是如何随着时间的推移而发展的:</p><ol class=""><li id="329c" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated"><a class="ae ka" href="https://blog.colony.io/writing-upgradeable-contracts-in-solidity-6743f0eecc88" rel="noopener ugc nofollow" target="_blank">撰写可升级的合同</a></li><li id="7c99" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">David Rugendyke设计的可升级可靠性合同</li><li id="d961" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated"><a class="ae ka" rel="noopener" href="/cardstack/upgradable-contracts-in-solidity-d5af87f0f913">Hassan Abdel-Rahman撰写的可升级合同</a></li></ol><p id="0991" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然而，对于旨在作为货币频繁使用的代币，由这种合同间架构引起的额外汽油支出可能是不期望的。当一个实体使用ERC20令牌执行交易时，它也隐含地向ETH付款以使令牌交易成为可能。沉重的每笔交易ETH成本肯定会影响令牌的大规模使用。</p><p id="595a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于ERC20令牌，BitClave的Anton Bukov最近提出了惰性迁移:<a class="ae ka" rel="noopener" href="/bitclave/the-easy-way-to-upgrade-smart-contracts-ba30ba012784">升级智能合约的简单方法</a>。该想法允许您定义ERC20合同升级的线性链，如下所示:</p><ol class=""><li id="09a1" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated">写下你的ERC20令牌，这样它们就可以被冻结了。代币合同冻结后，将不再允许对其进行额外的交易。冷冻后，它的状态永远不会改变。</li><li id="6e8d" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">当您部署最新版本的令牌时，您应该将它指向令牌合约的先前(现在已冻结)版本。</li><li id="428d" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">新合同可以使用其<em class="kp"> migratedBalances </em>映射来判断钱包是否已经迁移了其余额。</li><li id="6d99" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">每当发起转移时，令牌协定检查发送方的余额是否已经从先前的协定中迁移，如果没有，则在那时延迟应用迁移。</li><li id="e401" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">一旦应用了迁移，其所应用到的地址的<em class="kp"> migratedBalances </em>被设置为真，从而不会针对当前合同第二次应用这样的迁移。</li></ol><p id="aced" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">尽管Bukov仅针对传递函数详细说明了此工作流，但类似的机制也可应用于津贴，在approval和transferFrom方法中执行适当的检查，并且它确实产生了一个方案，该方案允许在一般情况下没有可怕的气体开销的迁移。</p><p id="2b9d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">我对布科夫的方案有三点批评:</strong></p><ol class=""><li id="525c" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated">旧合同的冻结限制了可组合性。Bukov在他的ERC20实现中继承了<a class="ae ka" href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/lifecycle/Pausable.sol" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin Pausable契约</a>，但是没有在他的ERC20方法中指定whenNotPaused修饰符。即便如此，他的解释非常清楚，余额必须冻结在旧合同上。这意味着，如果使用该方案的某人部署了实现所建议的接口的合同的初始版本C0，然后将其升级到C1(因此冻结了C0)，并且最终将其升级到C2(因此冻结了C1)，那么持有C0令牌的某人将不可能将其令牌迁移到C2，因为迁移将要求他们作为中间步骤更新他们在C1的余额。可能正确的解决方案是冻结转移和批准，但不冻结迁移方法(事实上，它们可以从Pausable契约中获取whenPaused修饰符)。</li><li id="76c0" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">任何特定合同“视图”操作的最坏情况气体开销与已执行的升级数量成线性关系。例如，如果您执行了10次升级，而有人想要查询自初始合同部署以来尚未迁移的帐户余额，他们的余额调用将导致10次外部合同调用，这意味着每次部署的天然气开销超过最便宜的<em class="kp"> balanceOf </em>调用的天然气成本的10倍。这可以通过触发迁移来缓解，即使是对当前契约的这种调用。无论如何，这种升级链需要实现者解决我之前的批评。</li><li id="296b" class="kb kc ht is b it kk ix kl jb km jf kn jj ko jn kg kh ki kj dt translated">冻结旧令牌部署的行为是一种暴力行为。除非令牌管理机构能够在实际冻结之前将升级清楚地传达给令牌用户群体，否则我们可以很好地假设这种升级会对令牌用户群的相当一部分造成破坏。</li></ol><p id="62f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">前两点是技术性的，屈服于技术解决方案。第三块必须区别对待。它涉及存在于令牌发放机构和该令牌的用户之间的隐含契约。所讨论的代币作为货币的效用将由于其功能的这种中断而受到损害。这可能对通常使用代币的市场的经济动态产生重大影响。</p><p id="9398" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有趣的是，这是一个我们在法定货币世界中最近模拟的场景——2016年高面额印度纸币的非货币化。考虑到去货币化发生的时间不长，很难说它对印度GDP的影响有多大。特别是因为有很多宣传围绕着这个问题在各个方向。经济合作与发展组织报告的<a class="ae ka" href="https://stats.oecd.org/index.aspx?queryid=350" rel="noopener ugc nofollow" target="_blank">季度GDP与去年同期相比的增长统计数据，并没有完全推翻去货币化确实对印度经济产生了重大影响的假设。如果GDP增长率受到非货币化的影响，那么它是否合理只能在印度政府政策的背景下判断，与我们无关。在这场讨论中，真正重要的是，印度政府确实违反了它与公民之间的隐性契约，宣布其投入流通的某些面值的货币无效，而违反这一契约可能对印度经济产生了重大影响。对于发行ERC20代币的组织来说，如果他们认为冻结旧版本的ERC20合同与强行让货币退出流通之间存在相似之处，那么前一种说法(适用于代币被用作货币的经济体)的可能性所固有的负面影响应该是避开涉及冻结合同的升级流程的充分理由。这样的组织可能会倾向于一个升级过程，更好地反映T4更传统的货币流通方式。</a></p><p id="f45f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">问题依然存在——在保持懒惰的Bukov方法的优势的同时，执行ERC20合同升级的更温和的方法是什么？回到ERC20合同更新与流通货币不同表现形式的管理之间的类比，主要要求如下:</p><p id="62b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">要求1:旧版本ERC20令牌的持有者应该能够继续使用他们的旧令牌进行交易，如果他们这样选择的话。</strong></p><p id="a6dc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当然，我们还必须偏离与货币流通的类比，因为与法定货币的情况不同，我们不应该假设存在类似银行的实体，它们将自己的代币商店交给类似美联储的管理实体进行检查。区块链的美妙之处在于，这样的角色和关系不再是一个经济体运转所必需的。这意味着给定代币的旧版本的持有者不能被强迫接受代币的任何其他版本的支付。因此:</p><p id="dd9b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">要求2:如果令牌持有者想要使用给定令牌的升级版本，他们必须自己(或通过授权代理)发起其持有物的迁移。</strong></p><p id="378b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这意味着令牌的管理实体或组织不能强制令牌的所有用户使用某个升级版本。升级必须基于它的优点。这比威权主义更符合分权经济的理念。</p><p id="a59a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后，就令牌持有者而言，必须有一种方法来保持令牌的版本无关值。例如，在极端情况下，一个ERC20代币X允许一个账户从任何其他ERC20代币中全部转移其余额，代币X将变得一文不值，因为任何个人都可以发行自己的ERC20代币，给自己一个非常大的余额，然后将该余额全部转移到X。必须对哪些合同是财富转移的有效来源进行一些控制:</p><p id="31dd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">要求3:我们部署的任何ERC20合约都应该有一个它升级的ERC20合约的白名单，即ERC20令牌，其持有者可以将其财富转移到正在讨论的合约。</strong></p><p id="9960" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，我们可以将我们的可升级(和升级)ERC20合同生态系统视为形成一个有向图，其中白名单定义有向边(包含白名单的合同作为终端顶点)。</p><p id="5ccb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有了这个需求，我们还必须解决如何表示这个控件的问题。我们不应完全低估代币管理机构的重要性，尤其是在当前形势下，此类机构通过为代币创建市场，合法地为代币持有者带来价值。尽管今天，这些治理实体通常是公司，但希望在未来这些实体将是与治理相关的合同。无论哪种方式，对于实现升级功能的ERC20契约来说，拥有一个管理者的概念是很重要的，管理者能够对其状态做出一些决定。对于升级，调控器应该能够明确指定哪些契约被列入令牌迁移的白名单。这给我们提出了以下要求:</p><p id="5f4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">需求4:我们部署的任何ERC20契约都应该有一个管理者的概念，一个可以调用契约上一组与治理相关的方法的特殊地址。</p><p id="7f80" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">要求5:至少，为了启用ERC20令牌升级，升级合同的管理者必须能够将之前的ERC20合同部署列入白名单以进行令牌迁移。</strong></p><p id="f752" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后，对于ERC20规范，有一个重要要求:</p><p id="937e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">要求6:升级后的ERC20合同必须在每次迁移后修改其<em class="kp"> totalSupply </em>。</strong></p><p id="6b74" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">至少符合这些要求的ERC20合同可用于以原则方式升级之前的ERC20合同部署，并且可以以可组合方式升级。我们已经开源了一个ERC20实现来做这件事:<a class="ae ka" href="https://github.com/doc-ai/nrn-brainstem/blob/master/src/stem.sol" rel="noopener ugc nofollow" target="_blank">https://github . com/doc-ai/nrn-brainstem/blob/master/src/stem . sol</a>(带<a class="ae ka" href="https://github.com/doc-ai/nrn-brainstem/blob/master/test/stem.js" rel="noopener ugc nofollow" target="_blank">测试</a>)。</p><p id="4774" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们还使用此合同将NRN令牌部署到位于以下地址的Ropsten testnet:</p><p id="3872" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="kp">0x 654 ffbe 6d 907 caf 34 CAE 0 f 0 bbd 043114 c 8980 a7c</em></p><p id="32f6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你想让我把一些NRN存入你的账户，请在下面留下你的钱包地址。</p><p id="0868" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请注意，本文中提出的需求代表了以我建议的方式实现升级所需的最低功能。有许多特性可以放在实现这些需求的契约上。例如:</p><p id="1cd4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过向在部署升级后的特定时间内升级的旧版本令牌的持有者提供令牌奖励来激励升级。</p><p id="2ded" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">设置白名单令牌迁移的汇率。这允许此处描述的类型的合同形成用于ERC20令牌的完全去中心化的交换。</p><p id="560f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果对这些用例感兴趣，我可以在后续文章中对它们进行扩展。</p><p id="a472" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我希望您能对这篇博文中提出的升级过程以及合同和测试有所反馈。非常欢迎你对https://github.com/doc-ai/nrn-brainstem的贡献。最后，如果您想考虑使用这种方法部署ERC20升级，我们绝对应该谈谈。</p></div></div>    
</body>
</html>