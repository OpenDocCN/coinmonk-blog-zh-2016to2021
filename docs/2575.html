<html>
<head>
<title>Automated deploy to IPFS and ENS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动部署到IPFS和ENS</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/automated-deploy-to-ipfs-and-ens-12bae2f40302?source=collection_archive---------0-----------------------#2019-12-12">https://medium.com/coinmonks/automated-deploy-to-ipfs-and-ens-12bae2f40302?source=collection_archive---------0-----------------------#2019-12-12</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="c39c" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">如何用IPFS和以太坊名称服务自动发布你的去中心化网站</h2></div><p id="d8a1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">所以你已经注册了一个很好的ENS名称，并希望通过IPFS和以太坊名称服务提供你的站点/dapp。要使这成为部署脚本的一个无缝部分，需要几个步骤。</p><h1 id="3389" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">在我们开始之前…</h1><p id="3930" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">在本指南中，我假设您已经知道如何使用IPFS和ENS托管站点的基础知识。重点是部署自动化和调整您的CI工作流。如果你不熟悉ENS和IPFS，有些问题可能会出现:)</p><p id="3abf" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu"> Node.js版本</strong>:在撰写<em class="lb">时，ens-updater </em>无法安装在版本≥ 12.x的节点上，因为一些依赖项需要脚本模块，但无法构建。这个问题在<a class="ae lc" href="https://github.com/TripleSpeeder/ens-updater/issues/44" rel="noopener ugc nofollow" target="_blank">https://github.com/TripleSpeeder/ens-updater/issues/44</a>追踪。在问题解决之前，请使用节点版本10或更低版本。</p><h1 id="7445" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">要完成的任务</h1><p id="6eae" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">部署您的分散式站点是一个两步过程:</p><ol class=""><li id="cc7c" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll dt translated">将内容发布到IPFS，获得新的CID</li><li id="75ae" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">将您的ENS名称的IPFS记录设置为指向新的CID</li></ol><p id="29af" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这两个步骤都有命令行工具。首先，我们将详细了解每个步骤，然后我们将创建一个Travis配置，该配置将完全自动化部署。</p><h2 id="cfea" class="lr kf ht bd kg ls lt lu kk lv lw lx ko jr ly lz kq jv ma mb ks jz mc md ku me dt translated">步骤1-发布到IPFS</h2><p id="c3f6" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">对于此任务，我们将使用CLI工具<a class="ae lc" href="https://github.com/ipfs-shipyard/ipfs-deploy" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> ipfs-deploy </em> </a>。通过npm在全球范围内安装:</p><p id="60df" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh mf mg mh mi b">&gt; npm install -g ipfs-deploy</code></p><p id="a2c8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这个工具使用起来非常简单。您只需要提供想要部署的构建文件夹，并选择想要使用的IPFS锁定服务。</p><p id="f214" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">假设应用程序的生产版本位于文件夹<code class="eh mf mg mh mi b">build</code>中，您可以运行以下命令，通过公共可用的<a class="ae lc" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> infura </a> ipfs节点进行部署:</p><p id="db2c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh mf mg mh mi b">&gt; ipfs-deploy build -p infura</code></p><p id="7089" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">注意由<em class="lb"> ipfs-deploy </em>提供的CID字符串<em class="lb"> Qm… </em>。这是您的构建的唯一标识符，需要添加到您的ENS名称中。</p><p id="b668" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="lb"> Ipfs-deploy </em>支持多种不同的IPFSpinning服务，其中一些需要认证。查看<a class="ae lc" href="https://github.com/ipfs-shipyard/ipfs-deploy" rel="noopener ugc nofollow" target="_blank">自述文件</a>了解更多详情。</p><p id="477c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">第一步到此结束——你的构建已经发布了！请继续阅读，了解如何更新您的ENS姓名记录。</p><h2 id="ecc5" class="lr kf ht bd kg ls lt lu kk lv lw lx ko jr ly lz kq jv ma mb ks jz mc md ku me dt translated">步骤2 —设置您的ENS名称的contenthash记录</h2><p id="be7a" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">对于这一步，我们将使用cli工具<a class="ae lc" href="https://github.com/TripleSpeeder/ens-updater" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> ens-updater </em> </a> <em class="lb">。</em>通过npm全球安装:</p><p id="0b75" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh mf mg mh mi b">&gt; npm install -g @triplespeeder/ens-updater</code></p><p id="c05f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="lb"> ens-updater </em>支持许多不同的命令来管理您的ens名称。对于本教程，我们只对设置您的姓名的contenthash条目感兴趣，使它指向您在步骤1中获得的CID。查看<code class="eh mf mg mh mi b">ens-updater --help</code>的输出以了解支持命令的概述，并查看<a class="ae lc" href="https://github.com/TripleSpeeder/ens-updater" rel="noopener ugc nofollow" target="_blank"> github页面</a>以了解更多信息。</p><p id="cfcc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">因为我们需要与ENS智能合约交互来更新contenthash条目，所以我们需要两件事情来继续:</p><ul class=""><li id="fd0e" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd mj lj lk ll dt translated">访问以太坊节点与合同进行交互</li><li id="17dd" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd mj lj lk ll dt translated">控制ENS名称的帐户的私钥</li></ul><p id="aeae" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您可以直接提供私钥，也可以通过助记符字符串(和可选的帐户索引)间接提供私钥。对于这两个选项，您需要将信息放在文件<em class="lb">中。env </em>或设置环境变量。</p><p id="2ab2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">对于本教程，我们将把私钥保存在一个. env文件中。打开您选择的文本编辑器并创建文件。工作目录中的env:</p><pre class="mk ml mm mn fq mo mi mp mq aw mr dt"><span id="c5db" class="lr kf ht mi b fv ms mt l mu mv">PRIVATE_KEY=&lt;private key here, without leading 0x&gt;</span></pre><p id="88e5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了确保一切设置正确，使用<code class="eh mf mg mh mi b">--dry-run</code>选项调用<em class="lb"> ens-updater </em>。设置此选项后，将不会执行任何实际事务，但会报告潜在的配置或设置问题。</p><p id="cf7c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">例</strong>:将ENS name <em class="lb"> mysite.eth </em>的contenthash记录设置为ipfs CID<em class="lb">qmd 2 yehmtswlppdkwnjem H4 wwageufxyemhsn 4 vcjmcvky</em>的完整命令:</p><p id="2545" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh mf mg mh mi b">&gt; ens-updater setContenthash mysite.eth ipfs-ns Qmd2yEHMTswLppDkWNjEMH4WwAgeuFXYeMHSn4VcJMcvKy --web3 http://localhost:8545 --verbose --dry-run</code></p><p id="0d2a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">检查结果输出，查看是否报告了任何错误。否则，没有<code class="eh mf mg mh mi b">— dry-run</code>选项也可以继续！</p><p id="d8f4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在把你的浏览器指向<a class="ae lc" href="http://mysite.eth" rel="noopener ugc nofollow" target="_blank"> http://mysite.eth </a>。假设您的系统设置正确，可以使用。你应该看到你的网站在运行！</p><p id="b396" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">第2步到此结束——现在可以通过您的ENS名称访问您的网站了！请继续阅读为自动化部署设置Travis。</p><h1 id="10a9" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">将所有这些整合在一起，实现全自动部署</h1><p id="4005" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">要使用Travis自动执行上述步骤，我们需要:</p><ul class=""><li id="fedf" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd mj lj lk ll dt translated">创建一个结合了<em class="lb"> ipfs-deploy </em>和<em class="lb"> ens-updater </em>的部署脚本，由Travis在部署阶段执行</li><li id="bda6" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd mj lj lk ll dt translated">设置Travis执行部署脚本</li><li id="97c5" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd mj lj lk ll dt translated">为特拉维斯设置环境变量，以便<em class="lb"> ens-updater </em>可以访问私钥</li></ul><h2 id="90ff" class="lr kf ht bd kg ls lt lu kk lv lw lx ko jr ly lz kq jv ma mb ks jz mc md ku me dt translated">部署脚本</h2><p id="7e00" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">由于<em class="lb"> ipfs-deploy </em>通过stdout提供CID，并且<em class="lb"> ens-updater </em>可以设置为从stdin读取CID，因此我们可以在一个小shell脚本中将这两个命令连接在一起，如下所示:</p><pre class="mk ml mm mn fq mo mi mp mq aw mr dt"><span id="c273" class="lr kf ht mi b fv ms mt l mu mv">#!/bin/bash<br/>ipfs-deploy build -p $1 -C -O | ens-updater setContenthash mysite.eth ipfs-ns stdin -v --web3 $2</span></pre><p id="e842" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该脚本期望pinner服务将用于部署作为第一个参数，将web3连接字符串作为第二个参数。还要注意，通过将特殊字符串“stdin”指定为<em class="lb"> ens-updater </em>的CID，它知道从stdin中读取CID。</p><p id="9999" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">将该脚本添加到您的项目中，使其成为存储库的一部分，并可供Travis使用。</p><h2 id="1c4f" class="lr kf ht bd kg ls lt lu kk lv lw lx ko jr ly lz kq jv ma mb ks jz mc md ku me dt translated">特拉维斯构型</h2><p id="223b" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">现在编辑travis.yaml以在部署阶段执行您的脚本。这里是一个真实项目的(精简的)示例配置，强调了重要部分:</p><pre class="mk ml mm mn fq mo mi mp mq aw mr dt"><span id="5597" class="lr kf ht mi b fv ms mt l mu mv">os: linux<br/>language: node_js<br/>node_js: 10<br/>jobs:<br/>  include:<br/>    - name: "IPFS"<br/>      install:<br/>        - npm ci<br/>        - <strong class="mi hu">npm install -g ipfs-deploy<br/>        - npm install -g @triplespeeder/ens-updater</strong><br/>      script: npm run build<br/>      <strong class="mi hu">deploy:<br/>        provider: script<br/>        script: bash scripts/deploy_ipfs.sh pinata https://mainnet.infura.io/v3/$INFURA_ID<br/>        skip_cleanup: true</strong></span></pre><p id="c537" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">安装</strong>阶段包含安装工具<em class="lb"> ipfs-deploy </em>和<em class="lb"> ens-updater </em>的附加命令。</p><p id="af14" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">部署</strong>阶段使用ipfs pinner服务“pinata”和来自infura的web3实例执行我们刚刚创建的部署脚本。不要忘记<code class="eh mf mg mh mi b">skip_cleanup</code>选项——否则，Travis将在开始部署之前清除构建文件夹…</p><p id="7567" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">最后缺少的部分是提供ENS名称控制器帐户的私钥。让我们开始吧！</p><ul class=""><li id="28ef" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd mj lj lk ll dt translated">转到您在Travis的项目页面</li><li id="0f59" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd mj lj lk ll dt translated">打开设置页面</li><li id="9971" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd mj lj lk ll dt translated">转到“环境变量”一节</li></ul><p id="b80d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">添加一个名为“PRIVATE_KEY”的新环境变量，并将您的私钥粘贴到VALUE字段中。将分支字段设置为主分支，因为部署将仅从主分支运行。确保<strong class="jk hu">而不是</strong>选中“在构建日志中显示值”<strong class="jk hu"/>——否则任何人都可以在构建日志中看到您的私钥。</p><p id="dd63" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在我的例子中，我还为pinata IPFS服务和Infura web3服务添加了环境变量，并为Github-pages的可选部署添加了GitHub令牌。以下是完整设置的屏幕截图:</p><figure class="mk ml mm mn fq mx fe ff paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="fe ff mw"><img src="../Images/747618abf17866b42570c6856cb9bd76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IaEHr7vbjyOb17SfZcIqQg.png"/></div></div></figure><p id="2194" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">有了这些变化，触发一个新的构建。如果一切顺利，您的构建日志将会像这样结束:</p><figure class="mk ml mm mn fq mx fe ff paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="fe ff ne"><img src="../Images/9d468a99c32c931eab1c6d5dc5b1eac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bPOjWn8jkZgvVQPLCj2F7w.png"/></div></div></figure><p id="ecc4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu">就是这样！每当您向主分支推送更新时，这些更改将被部署到IPFS，并且您的ENS名称的contenthash记录将被更新。</strong></p></div><div class="ab cl nf ng hb nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hm hn ho hp hq"><p id="0e01" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这个故事比我想象的要长，所以谢谢你读到这里！如果你有任何问题或意见，请写信给我。你也可以通过<a class="ae lc" href="https://twitter.com/TripleSpeeder" rel="noopener ugc nofollow" target="_blank">推特</a> (@triplespeeder)或者发邮件给<a class="ae lc" href="mailto:michael@m-bauer.org" rel="noopener ugc nofollow" target="_blank">michael@m-bauer.org</a>联系我</p><figure class="mk ml mm mn fq mx fe ff paragraph-image"><a href="https://coincodecap.com"><div class="fe ff nm"><img src="../Images/a06b758bdcc47dca7c2504f298674d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_s6JsD3P0hVj32E7t9EtGg.jpeg"/></div></a></figure><blockquote class="nn"><p id="2b2b" class="no np ht bd nq nr ns nt nu nv nw kd ek translated"><a class="ae lc" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="ny nz oa ob oc mx fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nx"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>