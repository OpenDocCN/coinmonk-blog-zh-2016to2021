<html>
<head>
<title>Using “Table” on EOS Smart Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在EOS智能合同中使用“表格”</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/using-table-on-eos-smart-contract-291f98312b80?source=collection_archive---------4-----------------------#2018-07-04">https://medium.com/coinmonks/using-table-on-eos-smart-contract-291f98312b80?source=collection_archive---------4-----------------------#2018-07-04</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/f408aa21e5ea04eacc1fab1efd82ca61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pH-LTxN8khFPMmdxvYUwOg.png"/></div></div></figure><p id="7030" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae jz" rel="noopener" href="/coinmonks/adding-action-to-eos-smart-contracts-85f6dcf2c841">上一篇关于智能合约动作的帖子</a>提到，转移到动作的数据只存在于智能合约运行的瞬间。因此，为了保存和共享，另一种类型的保存方法是必要的。这在EOS术语中称为“表”。这些数据即使在智能合约结束时也需要存在，因此使用持久性API对其进行管理。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="c4e7" class="kj kk ht kf b fv kl km l kn ko">#include &lt;eosiolib/eosio.hpp&gt;<br/>#include &lt;eosiolib/print.hpp&gt;<br/>using namespace eosio;<br/>class hello : public eosio::contract {<br/>  public:<br/>      using contract::contract;<br/>/// <a class="ae jz" href="http://twitter.com/abi" rel="noopener ugc nofollow" target="_blank">@abi</a> action <br/>      void hi( account_name user ) {<br/>         print( "Hello, World", name{user} );<br/>      }<br/>};<br/>EOSIO_ABI( hello, (hi) )</span></pre><p id="6a97" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">首先，我们来写基本代码。这是作为数据接收hi动作的账户类型的基本结构。</p><p id="b860" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">要使用table，首先需要声明要保存为类或结构的数据结构。在这个例子中，我们将使用structure来保存hi发送给了谁。</p><p id="abd4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">与前面的例子不同，您可能会觉得这很难，因为它包含了不直观的C++语法和DB结构。把它想成“它有这种形式”是一种更简单的方法。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="aba1" class="kj kk ht kf b fv kl km l kn ko">/// <a class="ae jz" href="http://twitter.com/abi" rel="noopener ugc nofollow" target="_blank">@abi</a> table ttab i64<br/>struct ttab<br/>{<br/>account_name to;<br/>uint64_t primary_key() const {return to;}</span><span id="f649" class="kj kk ht kf b fv kp km l kn ko">EOSLIB_SERIALIZE(ttab,(to))<br/>};</span></pre><p id="1014" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">定义数据结构的结构。如果你一行一行地看这个</p><p id="bd39" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">"/// @abi table ttab i64 "使用" eosiocpp -g "来创建注释所必需的abi。/// @abi action的基本代码是action的注解。</p><p id="39f4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然后用struct ttab {}声明并定义一个结构；。结构的内容是</p><p id="a121" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">" Account _ name to"帐户信息类型中值为1到的结构</p><p id="4b74" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">。剩下的两行是管理eos表的函数和宏。</p><p id="2a81" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">设置保存" uint 64 _ t primary _ Key()const { return to；}”表。表必须有主键。因为在这个例子中将要保存到表上的数据字段是一个“to”，所以这个to将被指定为主键。</p><p id="f23c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这是用于从“EOSLIB_SERIALIZE(ttab，(to))智能协定中调用数据的宏。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="2825" class="kj kk ht kf b fv kl km l kn ko">typedef   multi_index&lt;N(ttab),ttab&gt; _ttab;</span></pre><p id="b357" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">将上面声明的结构声明为Multi_index形式。Multi_index是在Boost库中具有易于使用的数据结构的表单中提供的表单。你可以把它想成“上面声明的ttab结构的名字ttab是用来声明表单被用作_ttab”在这个例子中。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="1d53" class="kj kk ht kf b fv kl km l kn ko">/// <a class="ae jz" href="http://twitter.com/abi" rel="noopener ugc nofollow" target="_blank">@abi</a> action<br/>        void hi(account_name user)<br/>        {<br/>             _ttab ttabs(_self,_self);<br/>            <br/>            auto iter=ttabs.find(user);<br/>            if(iter==ttabs.end())<br/>            {<br/>                print("need insert\t"); <br/>                ttabs.emplace(_self,[&amp;](auto&amp; ttab)<br/>                {<br/>                    ttab.to = user;<br/>                });<br/>            }<br/>            else<br/>            {<br/>                print("data already exist\t");<br/>            }<br/>            print("hello, world : ", name{user});<br/>        }</span></pre><p id="9de3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在一个典型的例子中，为了从表中检索信息，</p><p id="fde3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用“_ttab ttabs(_self，_self)上的参数(_ self)；”_ttab要重置的ttabs变量(实例构造函数)。参数中使用的“_self”是指执行智能合约的账户。</p><p id="0e0f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">ttabs构造函数的第一个参数表示将拥有生成的表的帐户。</p><p id="13a2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">第二个参数可以认为是使用ttabs的帐户。</p><p id="a487" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">查找作为“auto iter=ttabs.find(user)”传输的用户数据ttab中的活动数据。从ttab中找到的数据将被用作“迭代器”形式。详细描述迭代器超出了本文的范围，只是简单解释一下上面的例子，</p><p id="f7d4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果将上面找到的“<strong class="jd hu"> if(iter==ttabs.end()) </strong>”信息与最后一个ttab进行比较，如果相同，这意味着转移到action的用户不在表中。在这种情况下，插入数据。如果没有，并且用户信息在表中，那么它是不做任何事情就打印消息的结构。</p><p id="6d6a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果没有“TTA bs . launte(_ self，[&amp;](auto&amp; ttab)”用户表，使用multi_index提供的定位函数，插入数据。</p><p id="40df" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">第一个参数是关于谁将为存储数据付费的帐户信息。在此示例中，智能合约帐户支付费用，但是您必须考虑设计，以便在实际的服务器上使用此信息。</p><p id="e8ba" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">第二个是ttab的Lambda形式，应该也是指C++，但是在这个例子中，把它想成是循环传递的数据结构应该没问题。</p><p id="ef82" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这个例子中，许多详细的概念都被省略了，这样即使是初学者也能很容易地理解。同样，类比也有许多概念顺序。因此，这只适用于教程，不适用于代码。</p><p id="7cf9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">本教程演示了如何在智能合约中轻松使用表格。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="b160" class="kj kk ht kf b fv kl km l kn ko">#include &lt;eosiolib/eosio.hpp&gt;<br/>#include &lt;eosiolib/print.hpp&gt;</span><span id="683f" class="kj kk ht kf b fv kp km l kn ko">using namespace eosio;</span><span id="91f8" class="kj kk ht kf b fv kp km l kn ko">class hello : public eosio::contract <br/>{<br/>    public:<br/>        using contract::contract;</span><span id="76b8" class="kj kk ht kf b fv kp km l kn ko">/// <a class="ae jz" href="http://twitter.com/abi" rel="noopener ugc nofollow" target="_blank">@abi</a> table ttab i64<br/>        struct ttab<br/>        {<br/>            account_name to;<br/>            uint64_t primary_key() const {return to;}</span><span id="c6bd" class="kj kk ht kf b fv kp km l kn ko">EOSLIB_SERIALIZE(ttab,(to))<br/>        };</span><span id="e2da" class="kj kk ht kf b fv kp km l kn ko">typedef multi_index&lt;N(ttab),ttab&gt; _ttab;</span><span id="2fb1" class="kj kk ht kf b fv kp km l kn ko">/// <a class="ae jz" href="http://twitter.com/abi" rel="noopener ugc nofollow" target="_blank">@abi</a> action<br/>        void hi(account_name user)<br/>        {<br/>             _ttab ttabs(_self,_self);<br/>            <br/>            auto iter=ttabs.find(user);<br/>            if(iter==ttabs.end())<br/>            {<br/>                print("need insert\t"); <br/>                ttabs.emplace(_self,[&amp;](auto&amp; ttab)<br/>                {<br/>                    ttab.to = user;<br/>                });<br/>            }<br/>            else<br/>            {<br/>                print("data already exist\t");<br/>            }<br/>            print("hello, world : ", name{user}, " 6");<br/>        }<br/>};</span><span id="723c" class="kj kk ht kf b fv kp km l kn ko">EOSIO_ABI(hello,(hi))</span></pre><p id="5b46" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果整个代码和上面一样，编译并上传源代码。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="b3c1" class="kj kk ht kf b fv kl km l kn ko">#eosiocpp -o tbsample.wast tbsample.cpp</span><span id="6c60" class="kj kk ht kf b fv kp km l kn ko">#eosiocpp -g tbsample.abi tbsample.cpp</span></pre><p id="ae33" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">编译后，上传合同并执行。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="b5e6" class="kj kk ht kf b fv kl km l kn ko"># cleos set contract usersc /root/sc/tbsample</span></pre><figure class="ka kb kc kd fq iu fe ff paragraph-image"><div class="ab fr cl kq"><img src="../Images/89c1a0cc9ec6ac762b67f3a8f2a0f3f0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*7Z8FkfoFwDm0jtIeDaiI7Q.png"/></div></figure><p id="9b5d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">将“testuser”数据提供给hi动作并执行。</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="8011" class="kj kk ht kf b fv kl km l kn ko"># cleos push action usersc hi ‘[“testuser”]’ -p usersc</span></pre><figure class="ka kb kc kd fq iu fe ff paragraph-image"><div class="ab fr cl kq"><img src="../Images/f3ac362d71512c97a535e6b240c5744b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*nHXhDImHlSS2QAwlBEUW-Q.png"/></div></figure><p id="db72" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">因为这是第一个" testuser "插入，所以显示并插入" need insert "到表中。</p><p id="293e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果您将“testuser”作为数据并再次执行契约，</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="bfc5" class="kj kk ht kf b fv kl km l kn ko"># cleos push action usersc hi ‘[“testuser”]’ -p usersc</span></pre><figure class="ka kb kc kd fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kr"><img src="../Images/48d036adddf7795c5ee4ec9f2e8a3777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rSxm4vvF9G7JKUMYhykSVQ.png"/></div></div></figure><p id="32ac" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">可以看到数据如上已经存在。</p><p id="d1a6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用cleos，您可以搜索用户的表。如果您插入以下内容并搜索usersc的ttab表，</p><pre class="ka kb kc kd fq ke kf kg kh aw ki dt"><span id="59f4" class="kj kk ht kf b fv kl km l kn ko">#cleos get table usersc usersc ttab</span></pre><figure class="ka kb kc kd fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kr"><img src="../Images/0c487665c86a0315c89e8e215f3de042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCe6WVVviLKK9krO6NEgwg.png"/></div></div></figure><p id="b675" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">您可以确认在上面的例子中输入的testuser，包括为测试输入的其他数据，是否存在。</p><p id="066b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在本帖中，我们查看了智能合同的表格。</p></div><div class="ab cl ks kt hb ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hm hn ho hp hq"><h2 id="5fcb" class="kj kk ht bd kz la lb lc ld le lf lg lh jm li lj lk jq ll lm ln ju lo lp lq lr dt translated">ITAM游戏是一个透明的游戏生态系统的区块链平台</h2><p id="5d69" class="pw-post-body-paragraph jb jc ht jd b je ls jg jh ji lt jk jl jm lu jo jp jq lv js jt ju lw jw jx jy hm dt translated">订阅ITAM游戏并接收最新信息。</p><p id="4717" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">访问ITAM游戏电讯，就ITAM游戏和区块链进行交流。点击下面的链接加入！👫</p><p id="2bd0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">网址:<strong class="jd hu"/><a class="ae jz" href="https://itam.games" rel="noopener ugc nofollow" target="_blank">https://itam . games</a><strong class="jd hu"><br/></strong>电报:<a class="ae jz" href="https://t.me/itamgames" rel="noopener ugc nofollow" target="_blank">https://t.me/itamgames</a></p></div></div>    
</body>
</html>