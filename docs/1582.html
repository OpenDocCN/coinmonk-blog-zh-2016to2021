<html>
<head>
<title>How to Build a Python App that texts you when your ETH Balance Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建一个Python应用程序，当你的ETH平衡发生变化时，它会给你发短信</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-build-a-python-app-that-texts-you-when-your-eth-balance-changes-a78baa4222e0?source=collection_archive---------0-----------------------#2018-10-02">https://medium.com/coinmonks/how-to-build-a-python-app-that-texts-you-when-your-eth-balance-changes-a78baa4222e0?source=collection_archive---------0-----------------------#2018-10-02</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/d9f6918d1f7441e78417e155c896ca6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JpHta1RUlBxVNal4p-uGiw.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">You will be building…<em class="jf">THE ETHEREUM WATCHTOWER</em></figcaption></figure><p id="bd4f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">以太坊很复杂。黑客攻击经常发生。当你的平衡发生变化时，收到一条短信不是很好吗？例如，想象你刚刚在<a class="ae ke" href="https://opensea.io/assets" rel="noopener ugc nofollow" target="_blank"> OpenSea </a>上买了一个很酷的新<a class="ae ke" href="https://www.etheremon.com/" rel="noopener ugc nofollow" target="_blank">以太精灵</a>。以太坊上的交易可能需要一段时间，这会让用户紧张。毕竟，发送到错误地址的ETH就永远失去了。dApp用户界面已经有了很大的进步，但是他们现在感觉不那么安全。让我们使用保护！</p><figure class="kg kh ki kj fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kf"><img src="../Images/551d5e0cca8bc34763d361ce4803f291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZ8SEZWQ-WtMLge7K3zRnA.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">This is what I imagine I’m doing when I interact with dApps</figcaption></figure><p id="0080" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">目标:</strong>我们将构建一个包含不到150行代码的Python应用程序，它可以在指定的以太坊余额发生变化时发送短信提醒。我选择继续在Heroku上部署脚本。</p><p id="030e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">* *为什么是python？没理由；我也可以很容易地用Javascript构建它。我唯一的标准是我的语言必须有一个健壮的Web3包。在<a class="ae ke" rel="noopener" href="/carbon-money/how-to-build-and-deploy-a-full-stack-upgradeable-erc-20-dapp-81a7e35e374">上一篇文章中，我写了一个教程</a>来构建一个ReactJS前端钱包来与以太坊智能合约交互，所以这次我想展示如何构建一个简单的Python脚本。</p><p id="a75f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">设置:</strong></p><ul class=""><li id="692b" class="kk kl ht ji b jj jk jn jo jr km jv kn jz ko kd kp kq kr ks dt translated"><a class="ae ke" href="https://www.twilio.com/docs/sms/quickstart/python" rel="noopener ugc nofollow" target="_blank">创建一个Twilio </a>帐户，这是一个非常简单的以编程方式发送短信的方法。您将需要一个Twilio SSID和一个认证密钥。</li><li id="01b0" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd kp kq kr ks dt translated">获得一个<a class="ae ke" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> Infura账号</a>轻松连接以太坊</li><li id="0999" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd kp kq kr ks dt translated">创建一个Heroku帐户来服务您的应用程序</li></ul><p id="3b3b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">一)Python脚本:</strong></p><p id="27bf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">首先，我们将使用<a class="ae ke" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> Infura </a>通过Web3轻松连接到以太坊节点。<code class="eh ky kz la lb b">settings</code>加载<code class="eh ky kz la lb b">dotenv</code>，它应该包含任何全局变量，包括您的Infura API密钥。Web3是Python的web3模块，基于流行的javascript版本。</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="3a77" class="lg lh ht lb b fv li lj l lk ll"># setupWeb3.py: Export web3 object using infura to connect to mainnet<br/>from web3 import Web3<br/>import settings<br/>import config</span><span id="17fe" class="lg lh ht lb b fv lm lj l lk ll"># Load constants from .env which are now present as system environment variable<br/>INFURA_API_KEY_MAIN = config.INFURA_API_KEY_MAIN</span><span id="6ef1" class="lg lh ht lb b fv lm lj l lk ll"># Set provider using Infura node<br/>w3 = Web3(Web3.HTTPProvider("<a class="ae ke" href="https://mainnet.infura.io/v3/" rel="noopener ugc nofollow" target="_blank">https://mainnet.infura.io/v3/</a>" + INFURA_API_KEY_MAIN))</span></pre><p id="78cf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ky kz la lb b">config</code>是一个从本地dotenv文件或<a class="ae ke" rel="noopener" href="/taqtilebr/managing-herokus-app-environment-variables-d13fd99610b"> Heroku配置变量</a>中检索全局键值对的模块，您可以通过它们的管理GUI或命令行来管理它们。一个例子<code class="eh ky kz la lb b">config.py</code>可能包括:</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="039e" class="lg lh ht lb b fv li lj l lk ll"># config.py: get global variables</span><span id="1a7b" class="lg lh ht lb b fv lm lj l lk ll">import os</span><span id="fe53" class="lg lh ht lb b fv lm lj l lk ll">## read Heroku config vars<br/>INFURA_API_KEY_MAIN = os.environ.get("INFURA_API_KEY_MAIN")<br/>TWILIO_SID = os.environ.get("TWILIO_SID")<br/>TWILIO_AUTH_TOKEN = os.environ.get("TWILIO_AUTH_TOKEN")</span><span id="bf75" class="lg lh ht lb b fv lm lj l lk ll">## user wallets to monitor</span><span id="c170" class="lg lh ht lb b fv lm lj l lk ll"># Owner of smart contracts<br/>owner = os.environ.get("OWNER")<br/># Validator can set permissions on Regulator<br/>validator = os.environ.get("VALIDATOR")</span></pre><p id="cd24" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">接下来，在<code class="eh ky kz la lb b">whitelist.py</code>中输入当余额变化时您想要发送的电话号码。FROM号码是您注册的Twilio号码，它将向您发送短信。</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="8f89" class="lg lh ht lb b fv li lj l lk ll"># whitelist.py: store phone numbers to text</span><span id="b27b" class="lg lh ht lb b fv lm lj l lk ll"># Twilio verified receivers<br/>NICK = '+1XXXXXXXXXX'</span><span id="c69f" class="lg lh ht lb b fv lm lj l lk ll"># Twilio sender<br/>FROM = '+1XXXXXXXXX'</span></pre><p id="0edb" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">既然我们已经设置了配置，让我们编写我们的“文本调度程序”，它利用Twilio API向<code class="eh ky kz la lb b">whitelist.py</code>中列出的指定用户发送文本:</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="7373" class="lg lh ht lb b fv li lj l lk ll"># textdispatcher.py: text whitelisted user(s) using Twilio API</span><span id="44a1" class="lg lh ht lb b fv lm lj l lk ll">import os<br/>import whitelist<br/>import config</span><span id="ce7d" class="lg lh ht lb b fv lm lj l lk ll"># Constants<br/>text_from = whitelist.FROM<br/>TWILIO_SID = config.TWILIO_SID<br/>TWILIO_AUTH_TOKEN = config.TWILIO_AUTH_TOKEN</span><span id="ed75" class="lg lh ht lb b fv lm lj l lk ll"># Text recipients specified in textTo list<br/>def text(bod, textTo):<br/> for recipient in textTo:<br/>     from twilio.rest import Client<br/>     client = Client(TWILIO_SID, TWILIO_AUTH_TOKEN)<br/>     message = client.messages.create(body=bod, from_=text_from, to=recipient)<br/>     print('Sent SMS to {}'.format(recipient))</span></pre><p id="02b0" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">最后，让我们使用来自<code class="eh ky kz la lb b">setupWeb3.py</code>的<code class="eh ky kz la lb b">w3</code>对象来读取我们的ETH余额。该文件稍长，但读取余额很容易:</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="c64a" class="lg lh ht lb b fv li lj l lk ll">from setupWeb3 import w3</span><span id="12ff" class="lg lh ht lb b fv lm lj l lk ll">try:<br/>  balance = w3.fromWei(w3.eth.getBalance(address), 'ether')<br/> except:<br/>  print('ERROR reading balance')<br/></span></pre><p id="b380" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">要完成该应用程序，请使用textdispatcher在事件触发时向用户发送短信，在这种情况下，每当我的余额发生变化时，我都希望收到一条短信，我想知道余额是增加了还是减少了:</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="d785" class="lg lh ht lb b fv li lj l lk ll">from textdispatcher import text</span><span id="e8a5" class="lg lh ht lb b fv lm lj l lk ll">latestBlock = w3.eth.blockNumber<br/>oldBalance = w3.fromWei(w3.eth.getBalance(address, block_identifier=latestBlock-1), 'ether')<br/>newBalance = w3.fromWei(w3.eth.getBalance(address), 'ether')</span><span id="0b50" class="lg lh ht lb b fv lm lj l lk ll"># psuedo-code follows...<br/>if newBalance &gt; oldBalance:<br/>   text("balance of {} has increased, blocknumber: {}".format(address, latestBlock), peopleToText)<br/>elif newBalance &lt; oldBalance:<br/>   text("balance of {} has decreased, blocknumber: {}".format(address, latestBlock), peopleToText)<br/>else:<br/>    # Insert action to do here if balance has not changed</span></pre><p id="3b5d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">进入脚本将是<code class="eh ky kz la lb b">__init__.py</code>，它将运行一个连续的循环，每两秒钟查询一次以太坊余额:</p><pre class="kg kh ki kj fq lc lb ld le aw lf dt"><span id="01fd" class="lg lh ht lb b fv li lj l lk ll">from getBalance import textBalanceOwner, textBalanceValidator<br/>import whitelist<br/>import time</span><span id="24e9" class="lg lh ht lb b fv lm lj l lk ll">def loop_main(poll_interval):<br/> # Who will receive the alerts<br/> recipients = [whitelist.NICK, whitelist.GAVIN]<br/> while True:<br/>  textBalanceOwner(recipients)<br/>  textBalanceValidator(recipients)<br/>  time.sleep(poll_interval)</span><span id="c549" class="lg lh ht lb b fv lm lj l lk ll">def main():<br/> loop_main(2)</span><span id="cecc" class="lg lh ht lb b fv lm lj l lk ll">main()</span></pre><p id="e068" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">瞧吧！现在你可以安心了，你的ETH平衡不会在你不知道的情况下改变！</p><figure class="kg kh ki kj fq iu fe ff paragraph-image"><div class="fe ff lo"><img src="../Images/4eb6d77ec19b50dc26d0ce166b8bd6d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*cVlnCVm1dNyjYoG1LnUyfw.gif"/></div></figure><p id="824b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> B)在Heroku上部署Git:</strong>有几种方法可以在Heroku上连续运行应用程序，更多细节请看这篇<a class="ae ke" href="https://stackoverflow.com/questions/39139165/running-simple-python-script-continuously-on-heroku" rel="noopener ugc nofollow" target="_blank"> stackoverflow帖子</a>。我决定使用Heroku插件“调度程序”每天运行一次我的脚本。这种方法很容易设置，但不可否认地感觉有点粗糙。</p><ol class=""><li id="10ef" class="kk kl ht ji b jj jk jn jo jr km jv kn jz ko kd lp kq kr ks dt translated">创建一个新的应用程序，我将其命名为“eth-watchtower”。<code class="eh ky kz la lb b">requirements.txt</code>和<code class="eh ky kz la lb b">runtime.txt</code>将指示Heroku安装必要的依赖项来运行您的脚本</li><li id="1e25" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd lp kq kr ks dt translated">对于“部署方法”，我选择通过Github方便地部署</li><li id="e12e" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd lp kq kr ks dt translated">或者，在选定的分支上启用自动部署。这使得对“生产”分支的代码更改可以通过Heroku立即部署。例如，我自动部署我的<code class="eh ky kz la lb b">master/</code>分支</li><li id="1f36" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd lp kq kr ks dt translated">进入Heroku &gt;设置&gt;显示配置变量，为<code class="eh ky kz la lb b">config.py</code>中的所有变量添加全局键值对，如您的Infura API密钥或Twilio认证令牌。<code class="eh ky kz la lb b">config.py</code>使用Heroku的<code class="eh ky kz la lb b">os</code>包从本地运行的dotenv或Heroku门户读取全局变量</li><li id="2a98" class="kk kl ht ji b jj kt jn ku jr kv jv kw jz kx kd lp kq kr ks dt translated">在Heroku &gt;资源中搜索并安装<strong class="ji hu">调度程序</strong>插件，并将<code class="eh ky kz la lb b">python __init__.py</code>作为日常调度任务。更多细节请看Heroku调度器文档</li></ol><p id="ae3e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">签署</strong></p><p id="0e79" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><a class="ae ke" href="https://github.com/nicholaspai/ETHwatchtower/tree/master" rel="noopener ugc nofollow" target="_blank">完整Github回购此处</a></p><p id="ba2b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">你可以在这个简单的应用程序上添加许多功能，我很想听听你的想法！我希望你觉得这篇教程很容易阅读并且很有帮助，如果你有任何问题，请随时联系我。</p><p id="773e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我目前是<a class="ae ke" href="http://carbon.money" rel="noopener ugc nofollow" target="_blank"> Carbon </a>的产品开发人员，我们刚刚在ramp @ <a class="ae ke" href="http://fiat.carbon.money" rel="noopener ugc nofollow" target="_blank"> fiat.carbon.money </a>推出了我们的以太坊-菲亚特，我们很乐意合作:)</p><blockquote class="lq"><p id="1cd1" class="lr ls ht bd lt lu lv lw lx ly lz kd ek translated"><a class="ae ke" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mb mc md me mf iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ma"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>