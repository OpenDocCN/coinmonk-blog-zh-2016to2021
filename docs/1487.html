<html>
<head>
<title>DevOps toolkits: Supervisor — managing multiple processes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DevOps工具包:主管—管理多个流程</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/when-you-throw-a-web-crawler-to-a-devops-supervisord-562765606f7b?source=collection_archive---------6-----------------------#2018-09-10">https://medium.com/coinmonks/when-you-throw-a-web-crawler-to-a-devops-supervisord-562765606f7b?source=collection_archive---------6-----------------------#2018-09-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="f8f2" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated"><a class="ae ji" rel="noopener" href="/@thebestchef/when-you-throw-a-web-crawler-to-a-devops-elk-9a2a7cccf95a">第2部分— ELK堆栈</a></h2></div><p id="564c" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">一个网络爬虫被扔给一个DevOps。然后，他问了以下问题:</p><ul class=""><li id="5d77" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">万一崩溃了呢？</li><li id="3559" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">如何让它变得可靠？</li><li id="8ee7" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">如何扩大规模？</li><li id="8217" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">如何有效监控过程？</li></ul><p id="76c6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">开发可行的代码很容易，但使其健壮却很难。开发人员或成熟的程序员的工作之一就是让他们的代码可靠。</p><h1 id="13cc" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">监督者</h1><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff ll"><img src="../Images/541bc0159195d29759826d60b71607c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0gzaAy8dgyKkpOuZYmqVQA.jpeg"/></div></div></figure><p id="6c12" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">首先，我们将介绍一个简单而强大的工具— <a class="ae ji" href="https://github.com/Supervisor/supervisor" rel="noopener ugc nofollow" target="_blank"> supervisor </a>。这是一个过程控制系统，具有以下特点:</p><ul class=""><li id="a75e" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">简单的</li></ul><p id="42c5" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">只需编辑配置文件即可完成大部分工作</p><ul class=""><li id="8c20" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">高效的</li></ul><p id="5683" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">Supervisor不依赖PID文件和定期轮询来重启失败的进程。相反，它通过fork/exec启动子流程，并且子流程不会后台化。当一个进程终止时，操作系统向管理程序发出信号。</p><ul class=""><li id="18b1" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">可扩张的</li></ul><p id="57a2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">有了事件通知协议，人们可以实现事件驱动的电子邮件通知程序等功能，或者轻松地与ELK等其他工具集成。</p><ul class=""><li id="a449" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">方便用户的</li></ul><p id="b54b" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">有一个CLI和web仪表板来监视和控制流程。提供了多个版本的开源仪表板。您可以轻松管理您的流程，甚至可以将仪表盘整合到您自己的工作站中。</p><h1 id="2893" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">使用</h1><p id="9c69" class="pw-post-body-paragraph jj jk ht jl b jm mb iu jo jp mc ix jr js md ju jv jw me jy jz ka mf kc kd ke hm dt translated">安装主管:</p><p id="ab1e" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><code class="eh lx ly lz ma b">pip install supervisor</code></p><p id="be4e" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">Supervisord在python 2中是最稳定的。然而，这并不意味着您的应用程序必须由python 2来实现，或者甚至由python来实现。它可以是其他任何东西。</p><p id="c7cb" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">假设我们有一个python爬虫，叫做<code class="eh lx ly lz ma b">crawler.py</code>。我们可以做以下事情来使它容易与其他服务集成</p><h1 id="1e0b" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">保持活力</h1><p id="bf1d" class="pw-post-body-paragraph jj jk ht jl b jm mb iu jo jp mc ix jr js md ju jv jw me jy jz ka mf kc kd ke hm dt translated"><code class="eh lx ly lz ma b">supervisord.conf</code>文件将实现以下功能:</p><ul class=""><li id="8a12" class="kf kg ht jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn dt translated">当supervisor启动时，启动流程</li><li id="62a8" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">如果退出代码既不是0也不是2，则重新启动该进程</li><li id="b19e" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">特定路径中的输出日志</li><li id="8dad" class="kf kg ht jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn dt translated">启用旋转日志</li></ul><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="493f" class="mk ku ht ma b fv ml mm l mn mo">[supervisord] <br/>nodaemon=true <br/>loglevel=info </span><span id="ffa3" class="mk ku ht ma b fv mp mm l mn mo">[program:crawler] <br/>command=python crawler.py <br/>autorestart=unexpected <br/>exitcodes=0,2 <br/>stopsignal=TERM</span></pre><p id="eba8" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">就是这样！这就是我们启动一个最小但有效的监管机构所需要的一切。<br/>要启动它，打开终端，转到放置配置文件的目录，键入:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="fa47" class="mk ku ht ma b fv ml mm l mn mo">supervisord</span></pre><p id="b588" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">然后您可以看到日志消息。</p><h1 id="d632" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">放置日志文件</h1><p id="4911" class="pw-post-body-paragraph jj jk ht jl b jm mb iu jo jp mc ix jr js md ju jv jw me jy jz ka mf kc kd ke hm dt translated">然后，我们将指定日志文件的位置。</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="9f2e" class="mk ku ht ma b fv ml mm l mn mo">[supervisord] <br/>nodaemon=true <br/>loglevel=info <br/>logfile=../log/supervisord.log <br/>logfile_maxbytes=50MB </span><span id="8ed7" class="mk ku ht ma b fv mp mm l mn mo">[program:crawler] <br/>command=python crawler.py <br/>stdout_logfile=../log/crawler_out.log <br/>stderr_logfile=../log/crawler_err.log <br/>logfile_maxbytes=50MB <br/>autorestart=unexpected <br/>exitcodes=0,2 <br/>stopsignal=TERM</span></pre><p id="8e0f" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">注意，我们可以在conf文件中使用相对路径</p><h1 id="da28" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">启用仪表板</h1><p id="4d33" class="pw-post-body-paragraph jj jk ht jl b jm mb iu jo jp mc ix jr js md ju jv jw me jy jz ka mf kc kd ke hm dt translated">通过在同一配置文件中添加以下行来启用supervisorctl:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="0767" class="mk ku ht ma b fv ml mm l mn mo">[supervisorctl] <br/>;serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL for a unix socket <br/>serverurl=http://127.0.0.1:9001 ; </span><span id="0434" class="mk ku ht ma b fv mp mm l mn mo">[inet_http_server] <br/>port = 127.0.0.1:9001 </span><span id="258f" class="mk ku ht ma b fv mp mm l mn mo">[rpcinterface:supervisor] <br/>supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</span></pre><p id="9cda" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">然后，当我们访问<code class="eh lx ly lz ma b">127.0.0.1:9001</code>时，将显示一个主管网络仪表板。</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mq"><img src="../Images/8a89653749eba9f995c6d0aba21f0889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1iH-ODG_X2CnNK6MtmjJjw.png"/></div></div></figure><p id="d7cd" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">或者只需在终端中输入<code class="eh lx ly lz ma b">supervisorctl</code>，我们就会进入CLI界面。</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/c2ef601a190cebb33bf683b52e204c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*2NQ-UVtz1iRbMIy4NIBYYA.png"/></div></figure><h1 id="e4fa" class="kt ku ht bd kv kw kx ky kz la lb lc ld iz le ja lf jc lg jd lh jf li jg lj lk dt translated">实现事件驱动的电子邮件通知程序</h1><p id="3857" class="pw-post-body-paragraph jj jk ht jl b jm mb iu jo jp mc ix jr js md ju jv jw me jy jz ka mf kc kd ke hm dt translated">必须启用Stdout和stderr事件，事件侦听器才能获取数据。<br/>我们将在python中编写一个监听器，在爬虫意外崩溃时发送电子邮件。</p><p id="8ae3" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">配置文件:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="2eb3" class="mk ku ht ma b fv ml mm l mn mo">[program:spider] <br/>command=python crawler.py <br/>stdout_events_enabled=true <br/>stderr_events_enabled=true <br/>stdout_logfile=../log/crawler_out.log <br/>stderr_logfile=../log/crawler_err.log <br/>logfile_maxbytes=50MB <br/>autorestart=unexpected <br/>exitcodes=0,2 <br/>stopsignal=TERM </span><span id="7800" class="mk ku ht ma b fv mp mm l mn mo">[eventlistener:listener] <br/>command=python listener.py <br/>events=PROCESS_STATE <br/>autorestart=true <br/>stdout_logfile=../log/listener_out.log <br/>stderr_logfile=../log/listener_err.log</span></pre><p id="c7c2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">listener.py:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="0480" class="mk ku ht ma b fv ml mm l mn mo">import sys <br/>from send_email import send <br/>from supervisor.childutils import listener </span><span id="f484" class="mk ku ht ma b fv mp mm l mn mo">def write_stdout(s): <br/>    sys.stdout.write(s) <br/>    sys.stdout.flush() </span><span id="970e" class="mk ku ht ma b fv mp mm l mn mo">def write_stderr(s): <br/>    sys.stderr.write(s) <br/>    sys.stderr.flush() </span><span id="18a3" class="mk ku ht ma b fv mp mm l mn mo">def main(): <br/>    while True: <br/>        # transition from ACKNOWLEDGED to READY<br/>        write_stdout('READY\n')<br/>        headers, body = listener.wait(sys.stdin, sys.stdout) <br/>        body = dict([pair.split(":") for pair in body.split(" ")]) <br/>        <br/>        if body['processname'] == 'spider' and headers["eventname"] == "PROCESS_STATE_STOPPED": <br/>            send('spider stopped', 'spider stopped', &lt;your_email&gt;) <br/>        if body['processname'] == 'spider' and headers["eventname"] == "PROCESS_STATE_EXITED": <br/>            send('spider exited', 'spider exited', &lt;your_email&gt;)             <br/>        write_stderr("Headers: %r\n" % repr(headers)) <br/>        write_stderr("Body: %r\n" % repr(body))  <br/>        write_stdout("RESULT 2\nOK") </span><span id="e21b" class="mk ku ht ma b fv mp mm l mn mo">if __name__ =='__main__': <br/>    main()</span></pre><p id="09ae" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">助手功能— send_email.py:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="c74a" class="mk ku ht ma b fv ml mm l mn mo">from email.mime.multipart import MIMEMultipart <br/>from email.mime.text import MIMEText <br/>import smtplib </span><span id="5ac8" class="mk ku ht ma b fv mp mm l mn mo">msg = MIMEMultipart() <br/>password = &lt;password&gt; <br/>msg['From'] = &lt;email_sender&gt; </span><span id="12c7" class="mk ku ht ma b fv mp mm l mn mo">def send(sub, body, rep): <br/>    msg['Subject'] = sub <br/>    msg['To'] = rep <br/>    body = body </span><span id="df32" class="mk ku ht ma b fv mp mm l mn mo">    # add in the message body <br/>    msg.attach(MIMEText(body, 'plain')) </span><span id="401c" class="mk ku ht ma b fv mp mm l mn mo">    #create server server = smtplib.SMTP('smtp.gmail.com: 587') <br/>    server.starttls() </span><span id="8206" class="mk ku ht ma b fv mp mm l mn mo">    # Login Credentials for sending the mail <br/>    server.login(msg['From'], password) <br/>    <br/>    # send the message via the server.<br/>    server.sendmail(msg['From'], msg['To'], msg.as_string()) <br/>    server.quit() <br/>    return</span></pre></div><div class="ab cl ms mt hb mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="hm hn ho hp hq"><p id="a1a1" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><code class="eh lx ly lz ma b">supervisord.conf</code>的最终版本:</p><pre class="lm ln lo lp fq mg ma mh mi aw mj dt"><span id="81cc" class="mk ku ht ma b fv ml mm l mn mo">[program:crawler] <br/>command=python crawler.py <br/>stdout_events_enabled=true <br/>stderr_events_enabled=true <br/>stdout_logfile=../log/crawler_out.log <br/>stderr_logfile=../log/crawler_err.log <br/>logfile_maxbytes=50MB <br/>autorestart=unexpected <br/>exitcodes=0,2 <br/>stopsignal=TERM</span><span id="32c5" class="mk ku ht ma b fv mp mm l mn mo">[supervisorctl] <br/>;serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL for a unix socket <br/>serverurl=http://127.0.0.1:9001 ;</span><span id="0b1f" class="mk ku ht ma b fv mp mm l mn mo">[inet_http_server] <br/>port = 127.0.0.1:9001</span><span id="4532" class="mk ku ht ma b fv mp mm l mn mo">[rpcinterface:supervisor] <br/>supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</span><span id="56d9" class="mk ku ht ma b fv mp mm l mn mo">[eventlistener:listener] <br/>command=python listener.py <br/>events=PROCESS_STATE <br/>autorestart=true <br/>stdout_logfile=../log/listener_out.log <br/>stderr_logfile=../log/listener_err.log<br/></span></pre></div><div class="ab cl ms mt hb mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="hm hn ho hp hq"><h2 id="078d" class="mk ku ht bd kv mz na nb kz nc nd ne ld js nf ng lf jw nh ni lh ka nj nk lj nl dt translated"><a class="ae ji" rel="noopener" href="/@thebestchef/when-you-throw-a-web-crawler-to-a-devops-elk-9a2a7cccf95a">第二部分——麋鹿栈</a></h2><blockquote class="nm"><p id="29bb" class="nn no ht bd np nq nr ns nt nu nv ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nx ny nz oa ob lq fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nw"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>