<html>
<head>
<title>How To Subscribe Smart Contract Events Using Web3 1.0 ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Web3 1.0订阅智能合约事件？</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-subscribe-smart-contract-events-using-web3-1-0-93e996c06af2?source=collection_archive---------1-----------------------#2018-08-11">https://medium.com/coinmonks/how-to-subscribe-smart-contract-events-using-web3-1-0-93e996c06af2?source=collection_archive---------1-----------------------#2018-08-11</a></blockquote><div><div class="eg hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="92cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可能已经听说过，现在可以用websocket连接以太坊节点。Web3.js有一个叫做<code class="ei jp jq jr js b">web.eth.subscribe.</code>的新方法，使用它，你可以订阅4种不同类型的事件(pendingTransactions，newBlockHeaders，syncing，logs)。在本文中，我们将关注日志。所以让我们开始吧！</p><p id="0fe4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们需要连接到一个websocket提供者。</p><pre class="jt ju jv jw fr jx js jy jz aw ka dt"><span id="a2d4" class="kb kc hu js b fw kd ke l kf kg">const Web3 = require('web3')</span><span id="dd48" class="kb kc hu js b fw kh ke l kf kg">const web3 = new Web3('ws://localhost:8545')</span></pre><p id="ee4b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">重要提示</strong> : Subscribe方法只适用于websocket提供者！</p><p id="aa4b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">设置我们的合同实例:</p><p id="5c93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这一点上，我假设你使用<a class="ae ki" href="https://truffleframework.com/" rel="noopener ugc nofollow" target="_blank"> Truffle框架</a>来构建你的智能合约。</p><pre class="jt ju jv jw fr jx js jy jz aw ka dt"><span id="3bd6" class="kb kc hu js b fw kd ke l kf kg">const tokenInterface = require('../build/contracts/myToken.json')</span><span id="debb" class="kb kc hu js b fw kh ke l kf kg">const deployedAddress = tokenInterface.networks[networkId].address</span><span id="a4e5" class="kb kc hu js b fw kh ke l kf kg">token = new web3.eth.Contract(tokenInterface.abi,deployedAddress)</span></pre><p id="3539" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很好！现在是时候设置我们的subcribe函数了。</p><pre class="jt ju jv jw fr jx js jy jz aw ka dt"><span id="db01" class="kb kc hu js b fw kd ke l kf kg">// a list for saving subscribed event instances<br/>const subscribedEvents = {}</span><span id="59c3" class="kb kc hu js b fw kh ke l kf kg">// Subscriber method</span><span id="bc30" class="kb kc hu js b fw kh ke l kf kg">const subscribeLogEvent = (contract, eventName) =&gt; {</span><span id="8415" class="kb kc hu js b fw kh ke l kf kg">  const eventJsonInterface = web3.utils._.find(</span><span id="958e" class="kb kc hu js b fw kh ke l kf kg">    contract._jsonInterface,</span><span id="d593" class="kb kc hu js b fw kh ke l kf kg">    o =&gt; o.name === eventName &amp;&amp; o.type === 'event',</span><span id="8231" class="kb kc hu js b fw kh ke l kf kg">  )</span><span id="7f2c" class="kb kc hu js b fw kh ke l kf kg">  const subscription = web3.eth.subscribe('logs', {</span><span id="d100" class="kb kc hu js b fw kh ke l kf kg">    address: contract.options.address,</span><span id="3f54" class="kb kc hu js b fw kh ke l kf kg">    topics: [eventJsonInterface.signature]</span><span id="0bf8" class="kb kc hu js b fw kh ke l kf kg">  }, (error, result) =&gt; {</span><span id="06cf" class="kb kc hu js b fw kh ke l kf kg">    if (!error) {</span><span id="ba55" class="kb kc hu js b fw kh ke l kf kg">      const eventObj = web3.eth.abi.decodeLog(</span><span id="ae2f" class="kb kc hu js b fw kh ke l kf kg">        eventJsonInterface.inputs,</span><span id="7348" class="kb kc hu js b fw kh ke l kf kg">        result.data,</span><span id="ade9" class="kb kc hu js b fw kh ke l kf kg">        result.topics.slice(1)</span><span id="83fa" class="kb kc hu js b fw kh ke l kf kg">      )</span><span id="f6f3" class="kb kc hu js b fw kh ke l kf kg">      console.log(`New ${eventName}!`, eventObj)</span><span id="bcf8" class="kb kc hu js b fw kh ke l kf kg">    }</span><span id="7dca" class="kb kc hu js b fw kh ke l kf kg">  })</span><span id="fec9" class="kb kc hu js b fw kh ke l kf kg">  subscribedEvents[eventName] = subscription</span><span id="a9e9" class="kb kc hu js b fw kh ke l kf kg">}</span></pre><p id="b8ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们几乎准备好了！我们所要做的就是调用“subscribeLogEvent”函数进行订阅。一些鹰眼可能已经注意到我从主题数组(<code class="ei jp jq jr js b">result.topics.slice(1)</code>)中删除了第一个主题。当我们使用非匿名事件时，这是一个需求。详细信息见<a class="ae ki" href="https://web3js.readthedocs.io/en/1.0/web3-eth-abi.html#decodelog" rel="noopener ugc nofollow" target="_blank"> web3.js文档</a>。</p><p id="b4eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你现在可以称之为:</p><pre class="jt ju jv jw fr jx js jy jz aw ka dt"><span id="0f4d" class="kb kc hu js b fw kd ke l kf kg">subscribeLogEvent(myContractInstance, 'Transfer')</span></pre><p id="f293" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以猜到<code class="ei jp jq jr js b">Transfer</code>是这个事件的名字。</p><p id="0a94" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，每当一个事件触发时，您应该能够在控制台上看到它，并显示正确的参数名称。</p><figure class="jt ju jv jw fr kk ff fg paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="ff fg kj"><img src="../Images/5998666132d46cd04a818bac031b0be4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhSbynw2LkPKC_rBOWg04w.png"/></div></div></figure><p id="784a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在这里找到完整的工作示例<a class="ae ki" href="https://github.com/vbilici/web3-subscribe-example" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="dd52" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">编码快乐！</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="4e27" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">参考资料:</p><p id="fc8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ki" href="https://web3js.readthedocs.io/en/1.0/web3-eth-subscribe.html" rel="noopener ugc nofollow" target="_blank"> Web3文档</a></p><blockquote class="ky"><p id="a450" class="kz la hu bd lb lc ld le lf lg lh jo el translated">加入Coinmonks <a class="ae ki" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae ki" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>获取每日<a class="ae ki" href="http://coincodecap.com/" rel="noopener ugc nofollow" target="_blank">加密新闻</a></p></blockquote><h2 id="15d6" class="kb kc hu bd li lj lk ll lm ln lo lp lq jc lr ls lt jg lu lv lw jk lx ly lz ma dt translated">另外，阅读</h2><ul class=""><li id="20fb" class="mb mc hu it b iu md iy me jc mf jg mg jk mh jo mi mj mk ml dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-tax-software-ed4b4810e338">加密税务软件</a></li><li id="723e" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">网格交易</a> | <a class="ae ki" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069">加密硬件钱包</a></li><li id="874f" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="http://Top 4 Telegram Channels for Crypto Traders" rel="noopener ugc nofollow" target="_blank">密码电报信号</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="f33b" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/crypto-exchange-dd2f9d6f3769">最佳加密交易所</a> | <a class="ae ki" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度最佳加密交易所</a></li><li id="6065" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="https://coincodecap.com/binance-vs-bitstamp" rel="noopener ugc nofollow" target="_blank">币安vs Bitstamp </a> | <a class="ae ki" href="https://coincodecap.com/bitpanda-coinbase-coinsbit" rel="noopener ugc nofollow" target="_blank"> Bitpanda vs比特币基地vs Coinsbit </a></li><li id="5711" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="https://coincodecap.com/buy-ripple-india" rel="noopener ugc nofollow" target="_blank">如何购买Ripple (XRP) </a> | <a class="ae ki" href="https://coincodecap.com/crypto-exchange-africa" rel="noopener ugc nofollow" target="_blank">非洲最好的加密交易所</a></li><li id="861b" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="https://coincodecap.com/crypto-exchange-africa" rel="noopener ugc nofollow" target="_blank">非洲最佳加密交易所</a> | <a class="ae ki" href="https://coincodecap.com/hoo-exchange-review" rel="noopener ugc nofollow" target="_blank">胡交易所评论</a></li><li id="452c" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" href="https://coincodecap.com/etoro-robinhood" rel="noopener ugc nofollow" target="_blank"> eToro vs罗宾汉</a>|<a class="ae ki" href="https://coincodecap.com/bybit-bityard-moonxbt" rel="noopener ugc nofollow" target="_blank">MoonXBT vs by bit vs Bityard</a></li><li id="47a8" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated">开发人员的最佳加密API</li><li id="b359" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated">最佳<a class="ae ki" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">密码借贷平台</a></li><li id="3c98" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/free-crypto-signals-48b25e61a8da">免费加密信号</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a></li><li id="9487" class="mb mc hu it b iu mm iy mn jc mo jg mp jk mq jo mi mj mk ml dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/leveraged-token-3f5257808b22">杠杆代币</a>终极指南</li></ul></div></div>    
</body>
</html>