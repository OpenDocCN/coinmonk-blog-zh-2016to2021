<html>
<head>
<title>Running Corda DLT with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">和库伯内特一起经营科达·DLT</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/running-corda-dlt-with-kubernetes-3f21c15d4dd8?source=collection_archive---------5-----------------------#2018-05-16">https://medium.com/coinmonks/running-corda-dlt-with-kubernetes-3f21c15d4dd8?source=collection_archive---------5-----------------------#2018-05-16</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/04bfa0c95322803d7bce366a5d1d2519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sqVzeqruiaVwZ82K.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek"><a class="ae jf" href="https://www.corda.net/" rel="noopener ugc nofollow" target="_blank">source</a></figcaption></figure><p id="304d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在<a class="ae jf" href="https://tomorrow.fi" rel="noopener ugc nofollow" target="_blank">明天实验室</a>，我们正在与一群芬兰银行建立一个数字房地产交易平台。我们的目标不是将其构建为传统的集中式应用，而是利用区块链技术构建一个更加分散的系统。我们正在使用的平台是一个名为<a class="ae jf" href="https://github.com/corda/corda" rel="noopener ugc nofollow" target="_blank"> Corda </a>的分布式账本(DLT)产品。这是一个关于如何使用运行在<a class="ae jf" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>集群中的Docker容器建立Corda测试网络的教程。</p><p id="3cb4" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们使用最新的Corda开源版本3.1和H2数据库。我们的Docker映像管道有两个阶段:第一步是构建一个没有任何CorDapp的基础Corda映像，第二步是构建一个包含CorDapp jars的最终映像。基本docker文件如下所示:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="dd6e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，该图像被标记为tag tomorrow/corda:latest。为了运行Corda，我们使用一个shell脚本在tmux会话中启动Corda节点。这样，如果以后需要的话，很容易将它附加到Corda Shell中。run-corda.sh如下所示:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="d596" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">下一步是构建CorDapps jar。为此，我们使用gradle并将jar复制到文件夹build/cordapps。然后下一步是用下面的Dockerfile构建最终的图像。</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="1667" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">太好了！现在我们有了一个可以在Kubernetes中运行的Docker映像。为了运行Corda测试网络，我们必须为所有节点创建配置，然后生成证书和一些其他必要的文件。更多详情，请参见此处的说明<a class="ae jf" href="https://docs.corda.net/setting-up-a-corda-network.html" rel="noopener ugc nofollow" target="_blank"/>。在我们的例子中，我们需要三个配置文件:公证人、甲方和乙方。这是一个最小的Corda设置，由两方和一个节点作为非验证公证人。配置存储在名为config的文件夹中，如下所示:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="3f05" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，我们运行Corda网络引导工具，为网络生成必要的文件。您可以从<a class="ae jf" href="http://downloads.corda.net/network-bootstrapper-corda-3.0.jar" rel="noopener ugc nofollow" target="_blank">这里</a>下载该工具，并使用以下命令运行它。</p><p id="f0e7" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh kk kl km kn b">java -jar network-bootstrapper-corda-3.0.jar config</code></p><p id="a1bd" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们选择使用Kubernetes secrets来存储节点的配置、证书和其他必要文件。这是我们用于为甲方配置创建Kubernetes机密的命令:</p><pre class="ke kf kg kh fq ko kn kp kq aw kr dt"><span id="ad85" class="ks kt ht kn b fv ku kv l kw kx">kubectl create secret generic partya-config \<br/>— from-file=./config/partya/node.conf \<br/>— from-file=./config/partya/network-parameters \<br/>— from-file=./config/log4j.xml</span></pre><p id="858c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">注意！我们还使用自己的log4j配置文件，以便可以配置日志记录。使用以下命令存储甲方的证书:</p><pre class="ke kf kg kh fq ko kn kp kq aw kr dt"><span id="ad3d" class="ks kt ht kn b fv ku kv l kw kx">kubectl create secret generic partya-keystore \<br/>--from-file=./config/partya/certificates/nodekeystore.jks \<br/>--from-file=./config/partya/certificates/sslkeystore.jks \<br/>--from-file=./config/partya/certificates/truststore.jks</span></pre><p id="ffbe" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为其他节点创建机密的命令类似。最后一个棘手的部分是将节点信息文件分发给所有节点。Corda 3.x网络模型要求这些文件在所有节点上都可用。因此，我们创建了一个将在所有节点中使用的秘密。它是使用以下命令创建的:</p><pre class="ke kf kg kh fq ko kn kp kq aw kr dt"><span id="369b" class="ks kt ht kn b fv ku kv l kw kx">kubectl create secret generic additional-node-infos \<br/>--from-file=./config/notary/nodeInfo-9D193AC8883388E96664F3B0CC0AD3D162114F85F1633A69EF8CB30DA0993065 \  --from-file=./config/partya/nodeInfo-E4477B559304AADFC0638772C0956A38FA2E2A7A5EB0E65D0D83E5884831879A \  --from-file=./config/partyb/nodeInfo-B1F1FD9F15FCFDE1C9EE7A59504A44D669AB67B655597D60B691138E9C12E93C</span></pre><p id="9687" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">那些看起来神秘的文件名是Corda bootstrapper根据您的节点配置生成的节点哈希。因此，请记住根据引导程序生成的内容来更改名称。现在，我们终于可以为Kubernetes配置部署了。以下是甲方节点的示例:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="e18b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">此配置中需要提及的几件事:</p><ul class=""><li id="d9bd" class="ky kz ht ji b jj jk jn jo jr la jv lb jz lc kd ld le lf lg dt translated">对于p2p网络，如果您打开10002端口就足够了，但是我们需要RPC端口10003用于外部访问(我们有一个单独的REST API用于使用Corda)。</li><li id="fccc" class="ky kz ht ji b jj lh jn li jr lj jv lk jz ll kd ld le lf lg dt translated">主机名对于正确配置非常重要</li><li id="d6ba" class="ky kz ht ji b jj lh jn li jr lj jv lk jz ll kd ld le lf lg dt translated">这不是高可用性配置。开源版本的Corda不支持。所以使用Recreate作为部署策略最有意义。它防止两个pod试图同时在同一地址运行。</li><li id="0d61" class="ky kz ht ji b jj lh jn li jr lj jv lk jz ll kd ld le lf lg dt translated">该图像应更改为之前创建的图像。在我们的例子中，它是dias/app:1.0.116。它还必须指向您的Kubernetes集群可以访问的Docker存储库。我们使用私有注册表，并使用这些<a class="ae jf" href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry" rel="noopener ugc nofollow" target="_blank">指令</a>来配置访问。</li><li id="fc64" class="ky kz ht ji b jj lh jn li jr lj jv lk jz ll kd ld le lf lg dt translated">内存限制可能有点高。我们还没有调整它们。</li></ul><p id="924e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">其他节点的配置看起来相似。在我们创建它们之后，最后一步是使用命令应用所有配置:</p><pre class="ke kf kg kh fq ko kn kp kq aw kr dt"><span id="d0e1" class="ks kt ht kn b fv ku kv l kw kx">kubectl apply -f .</span></pre><p id="fa1c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">理论上，网络地图服务(在这种情况下是公证节点)应该在其他节点之前启动，以便它们可以在启动时连接到它。实际上，节点等待连接一段时间，对我们来说这已经足够了。一次启动它们会更简单。盈利前的最后一步是通过连接到任何节点来测试网络设置工作。它是这样工作的:</p><pre class="ke kf kg kh fq ko kn kp kq aw kr dt"><span id="1b12" class="ks kt ht kn b fv ku kv l kw kx">kubectl exec -it partya-5bddb8df-pqvjp — /bin/bash<br/>tmux attach -t corda<br/>run networkMapSnapshot</span></pre><p id="160e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这应该显示连接到网络的所有节点。在这种情况下是三个节点。请记住使用Ctrl+b后跟d退出tmux会话。tmux的警告是，如果您不想终止应用程序，就不应该终止会话。</p><p id="3c06" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">设置有点长，也没那么简单。在某个时候，R3会提供一个您可以连接到的网络。然而，目前Kubernetes是运行您自己的测试网络的好方法。初始设置后，很容易更新应用程序，它工作顺利。我们用Google Kubernetes引擎运行我们的测试网络，但是我们不使用任何Google特有的功能。这种设置应该适用于任何Kubernetes实现。</p><p id="39b8" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果我有时间，为Docker和Kubernetes设置创建一个Github repo可能是个好主意。似乎有很多人在这个设置中挣扎。</p></div></div>    
</body>
</html>