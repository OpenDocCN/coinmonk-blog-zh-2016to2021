<html>
<head>
<title>Serverless application with AWS Lambda and Kotlin. Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda和Kotlin的无服务器应用程序。第四部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/serverless-application-with-aws-lambda-and-kotlin-part-4-b364f9dfd9cd?source=collection_archive---------3-----------------------#2018-08-26">https://medium.com/coinmonks/serverless-application-with-aws-lambda-and-kotlin-part-4-b364f9dfd9cd?source=collection_archive---------3-----------------------#2018-08-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/b6220f012b97cfdb6757e5ce0f2040ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYCz7HQrg-4k1a-rt_q6Qw.png"/></div></div></figure><h1 id="ff56" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">第4部分——使用熟悉的工具:在AWS Lambda上使用Spring Cloud函数为Java平台编写Kotlin函数</h1><p id="3ca4" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">本系列文章由4部分组成:</p><ol class=""><li id="1fc7" class="kx ky ht kb b kc kz kg la kk lb ko lc ks ld kw le lf lg lh dt translated"><a class="ae li" rel="noopener" href="/@sulevsky/serverless-application-with-aws-lambda-and-kotlin-part-1-62d12ce7d64f">无服务器应用和功能即服务简介</a></li><li id="762f" class="kx ky ht kb b kc lj kg lk kk ll ko lm ks ln kw le lf lg lh dt translated"><a class="ae li" rel="noopener" href="/@sulevsky/serverless-application-with-aws-lambda-and-kotlin-part-2-26c06dc62099">第一滴血:在AWS Lambda上用Kotlin为Java平台编写函数</a></li><li id="b72c" class="kx ky ht kb b kc lj kg lk kk ll ko lm ks ln kw le lf lg lh dt translated"><a class="ae li" rel="noopener" href="/coinmonks/serverless-application-with-aws-lambda-and-kotlin-part-3-f733511f1326">预热优化:在AWS Lambda上为Node.js平台编写Kotlin函数</a></li><li id="dcb8" class="kx ky ht kb b kc lj kg lk kk ll ko lm ks ln kw le lf lg lh dt translated">使用熟悉的工具:在AWS Lambda上使用Spring Cloud函数用Kotlin for for Java平台编写函数(你在这里)</li></ol><p id="f601" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">这部分系列的目的是展示如何使用Kotlin编程语言和Spring框架在基于Java平台的AWS lambda上创建Lambda函数。</p></div><div class="ab cl lr ls hb lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hm hn ho hp hq"><p id="fb51" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">所有源代码可以从<a class="ae li" href="https://github.com/sulevsky/aws-lambda-java/tree/master/lambda-kotlin-spring" rel="noopener ugc nofollow" target="_blank"> <strong class="kb hu"> Github </strong> </a>下载</p></div><div class="ab cl lr ls hb lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hm hn ho hp hq"><p id="46d0" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">Spring Framework是大多数Java/Kotlin开发人员熟知的工具。它简化了应用程序开发，为依赖注入、面向方面编程、自动配置等提供了许多工具。Spring框架的进一步发展导致了更具体的框架:Spring MVC是web框架，Spring Batch是为批处理构建管道的框架<a class="ae li" href="https://spring.io/projects" rel="noopener ugc nofollow" target="_blank">以及许多其他的</a>。</p><p id="61f7" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">Spring Cloud Function是Spring保护伞下开发的一个框架。框架帮助开发具有Spring特性的FaaS应用程序，例如依赖注入、AOP、自动配置。</p><p id="969b" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">Spring对Kotlin有很大的支持，并且在最近的版本中部分是用Kotlin编写的。</p><p id="8495" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">在我们的第三个例子中，我们将构建一个与前面的例子功能相同的应用程序(从API Gateway接收数据并存储到S3)，但是现在使用了Spring Cloud函数。</p><ol class=""><li id="4031" class="kx ky ht kb b kc kz kg la kk lb ko lc ks ld kw le lf lg lh dt translated"><strong class="kb hu">设置项目</strong></li></ol><p id="cd49" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">设置项目与我们为<a class="ae li" rel="noopener" href="/@sulevsky/serverless-application-with-aws-lambda-and-kotlin-part-2-26c06dc62099"> Java平台</a>构建应用程序的例子非常相似。在这个例子中，我们将构建包含依赖项的fat jar。用<code class="eh ly lz ma mb b">spring-boot-gradle-plugin</code>管理的Spring依赖项——我们需要将它包含到gradle构建脚本中。此外，我们需要添加一个Spring Cloud函数依赖项。Spring为三个流行的FaaS提供商AWS Lambda、Azure和OpenWhisk提供了适配器。因此，我们将在外部构建脚本中添加一个依赖项<code class="eh ly lz ma mb b">org.springframework.cloud:spring-cloud-function-adapter-aws:1.0.0.RELEASE </code>。</p><p id="57aa" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">为了支持Spring自动配置，我们将修改构建fat jar的<code class="eh ly lz ma mb b">shadowJar</code>任务。</p><figure class="mc md me mf fq iu"><div class="bz el l di"><div class="mg mh l"/></div></figure><p id="c21b" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">有了这个构建配置，Spring的自动配置的所有功能现在都可以为我们所用了！</p><p id="f808" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">2.<strong class="kb hu">创建功能</strong></p><p id="d6c6" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">功能创建包括:</p><ul class=""><li id="eec6" class="kx ky ht kb b kc kz kg la kk lb ko lc ks ld kw mi lf lg lh dt translated">创建类型为<code class="eh ly lz ma mb b">Function</code>、<code class="eh ly lz ma mb b">Consumer</code>或<code class="eh ly lz ma mb b">Supplier</code>的bean</li></ul><figure class="mc md me mf fq iu"><div class="bz el l di"><div class="mg mh l"/></div></figure><ul class=""><li id="d48a" class="kx ky ht kb b kc kz kg la kk lb ko lc ks ld kw mi lf lg lh dt translated">引导Spring Boot应用程序</li></ul><figure class="mc md me mf fq iu"><div class="bz el l di"><div class="mg mh l"/></div></figure><p id="b197" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">3.<strong class="kb hu">配置AWS Lambda </strong></p><p id="f251" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">部署到AWS也是用Gradle完成的</p><figure class="mc md me mf fq iu"><div class="bz el l di"><div class="mg mh l"/></div></figure><p id="6263" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">如您所见，我们已经配置了一个对应于Spring配置的入口点。</p><pre class="mc md me mf fq mj mb mk ml aw mm dt"><span id="a1c2" class="mn jc ht mb b fv mo mp l mq mr"><strong class="mb hu">class </strong>Handler : SpringBootApiGatewayRequestHandler(Application::<strong class="mb hu">class</strong>.<em class="ms">java</em>)</span><span id="fdb5" class="mn jc ht mb b fv mt mp l mq mr">corresponds to</span><span id="f91a" class="mn jc ht mb b fv mt mp l mq mr">handler = <strong class="mb hu">"com.demo.Handler"</strong></span></pre><p id="e530" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">我们为一项功能配置了更多的内存。</p><p id="2f55" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">4.<strong class="kb hu">AWS上的测试</strong></p><p id="4bf7" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">现在我们可以部署和测试我们的功能了。</p><p id="1734" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">部署运行命令<code class="eh ly lz ma mb b">gradle deployFunction</code>(可以在Github上看到配置)。</p><p id="848f" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">在AWS控制台上，转到Lambda configuration并配置新的测试事件，使用API网关AWS代理(如果您想要完整的组件配置:API网关和S3，请参见本系列的第二篇文章)。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mu"><img src="../Images/4d026d19b3d47cc1ae400476641aff3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c8kZfQUo4Ig4787JjxUdJQ.png"/></div></div></figure><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mv"><img src="../Images/d7eba7bcdccfb4dcbb34089c1c083163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bI7I1zW7_N2dzdahVV5mFw.png"/></div></div></figure><p id="62ac" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">如果你触发了一个事件，你会得到输出。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mw"><img src="../Images/316c4b513a95e86035896c37774ac403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lo1P8TyMh6kl8v0kZMC76Q.png"/></div></div></figure><p id="49fd" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">我们已经在用Kotlin编写的AWS Lambda上设置了Spring应用程序。</p><p id="ee32" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">但是启动时间呢？对于Java平台和Spring云函数来说，这仍然是一个问题。我们已经配置了1024MB的RAM，如果我们像前面的例子那样设置512MB的RAM，应用程序甚至在20秒内都不会启动。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mx"><img src="../Images/42f1c677bba213fc50cdead2372124fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGs2y9gN6kM0-_JYWgWzrg.png"/></div></div></figure><p id="7df6" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">因此，与普通Java或Node.js函数相比，Spring Cloud函数需要更多的RAM和CPU。但是，如果你能忍受更长的预热时间和/或所需的额外计算资源，并且你想使用强大的Spring生态系统，Spring Cloud Function是一个很好的解决方案。</p><p id="1193" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">我们可以看到我们的应用程序有一些较低的内存和CPU限制。如果我们将内存设置为256 MB或更少，应用程序将无法启动并抛出OutOfMemoryError。但是后续调用花费的时间要少得多，并且适合大多数web应用程序。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff my"><img src="../Images/8f19c9c9693e10fffc893c101cf7649d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTk2NTYx4YlUpsCFB8ndPQ.png"/></div></div><figcaption class="mz na fg fe ff nb nc bd b be z ek">Invocation time depends on provided resources</figcaption></figure><p id="580b" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated"><strong class="kb hu">结论</strong>:</p><p id="9558" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated">在这一系列文章中，我们已经开始了用Kotlin构建无服务器应用程序的旅程。我们从Java平台开始，看到Kotlin完全适合在无服务器应用程序中使用。后来，我们通过将Kotlin代码编译成JavaScript并在Node.js平台上运行函数来提高应用程序的性能。在最后一个例子中，我们使用Spring Cloud函数作为软件开发的一个很好的工具。这些解决方案各有利弊。但是如果你是一个Java/Kotlin开发者，你想使用无服务器平台，你可以根据你的需求和描述的解决方案来证明你的选择。</p><p id="38f0" class="pw-post-body-paragraph jz ka ht kb b kc kz ke kf kg la ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hm dt translated"><strong class="kb hu">参考文献</strong>:</p><div class="nd ne fm fo nf ng"><a href="https://hackernoon.com/im-afraid-you-re-thinking-about-aws-lambda-cold-starts-all-wrong-7d907f278a4f" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab ej"><div class="ni ab nj cl cj nk"><h2 class="bd hu fv z el nl eo ep nm er et hs dt translated">恐怕你对AWS Lambda冷启动的想法完全错了</h2><div class="nn l"><h3 class="bd b fv z el nl eo ep nm er et ek translated">当我在API Gateway的上下文中与人们讨论AWS Lambda冷启动时，我经常得到这样的回答…</h3></div><div class="no l"><p class="bd b gc z el nl eo ep nm er et ek translated">hackernoon.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu iz ng"/></div></div></a></div><div class="nd ne fm fo nf ng"><a href="https://read.acloud.guru/does-coding-language-memory-or-package-size-affect-cold-starts-of-aws-lambda-a15e26d12c76" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab ej"><div class="ni ab nj cl cj nk"><h2 class="bd hu fv z el nl eo ep nm er et hs dt translated">语言、内存、封装尺寸如何影响AWS Lambda的冷启动？</h2><div class="nn l"><h3 class="bd b fv z el nl eo ep nm er et ek translated">比较使用不同语言、内存分配和部署规模的AWS Lambda的冷启动时间…</h3></div><div class="no l"><p class="bd b gc z el nl eo ep nm er et ek translated">read.acloud.guru</p></div></div><div class="np l"><div class="nv l nr ns nt np nu iz ng"/></div></div></a></div><blockquote class="nw"><p id="d295" class="nx ny ht bd nz oa ob oc od oe of kw ek translated"><a class="ae li" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="oh oi oj ok ol iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff og"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>