<html>
<head>
<title>Update an Identity in Hyperledger Fabric using Node SDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用节点SDK更新Hyperledger结构中的身份</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/update-an-identity-in-hyperledger-fabric-using-node-sdk-1b93edb6cb2b?source=collection_archive---------0-----------------------#2020-06-13">https://medium.com/coinmonks/update-an-identity-in-hyperledger-fabric-using-node-sdk-1b93edb6cb2b?source=collection_archive---------0-----------------------#2020-06-13</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="25f7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Hyperledger Fabric使用认证机构和加密工具为网络中的任何身份生成加密材料。Cryptogen tool仅用于开发目的，但实际上使用认证机构是首选。如果任何用户想在网络中进行交易，用户需要有一个证书，该证书将由为该组织注册的管理员生成。因此，我们首先需要在组织中注册管理员，然后注册，使用管理员上下文注册用户。这可以使用Fabric Node SDK中的CertificateAuthority类来完成。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/c6b6fb4edfa8b009fef430d9faf06c4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2M654S8EHE6EBOP9opVfEQ.png"/></div></div></figure><p id="79c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当你这样做时，让我们以织物样品中的fabcar为例。/startFabric.sh，结构网络将启动并运行，在对等体中安装并实例化chaincode。如果您需要使用node SDK从客户端进行交易，您可以运行enrollAdmin.js来注册Admin，它会在您提供的wallet文件夹中为admin生成密钥对和证书，还可以运行registerUser.js来注册enroll User，它会为user生成相同的密钥对和证书。我们使用用户证书来调用chaincode方法和提交事务。我们可以将自定义属性传递给用户证书，用户证书可用于在链码中执行访问级别控制，我们称之为基于属性的访问控制(ABAC)。假设您想要更改证书属性，一种方法是我们可以根据您提供的MaxEnrollment参数多次重新注册用户。这将在您每次注册用户时生成新的证书。另一种方法是使用来自节点SDK的IdentityService更新证书属性。让我们来看看它。</p><p id="d7a0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们尝试用自定义属性注册用户“testinguser”。我们创建一个名为“role”的自定义属性，并为其赋值“patient”。</p><pre class="jp jq jr js fq ka kb kc kd aw ke dt"><span id="b1c9" class="kf kg ht kb b fv kh ki l kj kk"> attrs: [{ name: “role”, value: “patient”, ecert: true }]</span></pre><p id="84d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就是你添加自定义属性的方式。</p><p id="828d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下面是registerUser.js的代码，自定义属性是在注册用户时添加的</p><pre class="jp jq jr js fq ka kb kc kd aw ke dt"><span id="d560" class="kf kg ht kb b fv kh ki l kj kk">'use strict';</span><span id="7840" class="kf kg ht kb b fv kl ki l kj kk">const { FileSystemWallet, Gateway, X509WalletMixin } = require('fabric-network');<br/>const path = require('path');<br/>const ccpPath = path.resolve(__dirname, '..', '..', 'first-network', 'connection-org1.json');</span><span id="c568" class="kf kg ht kb b fv kl ki l kj kk">async function main() {</span><span id="acd6" class="kf kg ht kb b fv kl ki l kj kk">try {</span><span id="391b" class="kf kg ht kb b fv kl ki l kj kk">// Create a new file system based wallet for managing identities.</span><span id="17b5" class="kf kg ht kb b fv kl ki l kj kk">const walletPath = path.join(process.cwd(), 'wallet');<br/>const wallet = new FileSystemWallet(walletPath);<br/>console.log(`Wallet path: ${walletPath}`);</span><span id="8ca9" class="kf kg ht kb b fv kl ki l kj kk">// Check to see if we've already enrolled the user.</span><span id="dc14" class="kf kg ht kb b fv kl ki l kj kk">const userExists = await wallet.exists('testinguser');<br/>if (userExists) {<br/>console.log('An identity for the user "testinguser" already exists in the wallet');<br/>return;</span><span id="3f02" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="5420" class="kf kg ht kb b fv kl ki l kj kk">// Check to see if we've already enrolled the admin user.</span><span id="af74" class="kf kg ht kb b fv kl ki l kj kk">const adminExists = await wallet.exists('admin');<br/>if (!adminExists) {<br/>console.log('An identity for the admin user "admin" does not exist in the wallet');<br/>console.log('Run the enrollAdmin.js application before retrying');<br/>return;</span><span id="b135" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="2be2" class="kf kg ht kb b fv kl ki l kj kk">// Create a new gateway for connecting to our peer node.</span><span id="a21d" class="kf kg ht kb b fv kl ki l kj kk">const gateway = new Gateway();<br/>await gateway.connect(ccpPath, { wallet, identity: 'admin', discovery: { enabled: true, asLocalhost: true } });</span><span id="9e96" class="kf kg ht kb b fv kl ki l kj kk">// Get the CA client object from the gateway for interacting with the CA.</span><span id="943b" class="kf kg ht kb b fv kl ki l kj kk">const ca = gateway.getClient().getCertificateAuthority();<br/>const adminIdentity = gateway.getCurrentIdentity();</span><span id="0892" class="kf kg ht kb b fv kl ki l kj kk">// Register the user, enroll the user, and import the new identity into the wallet.</span><span id="b2fd" class="kf kg ht kb b fv kl ki l kj kk">const secret = await ca.register({ affiliation: 'org1.department1', enrollmentID: 'testinguser', role: 'client', attrs: [{ name: "role", value: "patient", ecert: true }] }, adminIdentity);</span><span id="9918" class="kf kg ht kb b fv kl ki l kj kk">const enrollment = await ca.enroll({ enrollmentID: 'testinguser', enrollmentSecret: secret });</span><span id="024b" class="kf kg ht kb b fv kl ki l kj kk">const userIdentity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());</span><span id="9808" class="kf kg ht kb b fv kl ki l kj kk">await wallet.import('testinguser', userIdentity);</span><span id="4f8f" class="kf kg ht kb b fv kl ki l kj kk">console.log('Successfully registered and enrolled admin user "testinguser" and imported it into the wallet');</span><span id="eed8" class="kf kg ht kb b fv kl ki l kj kk">// retrieve the registered identity</span><span id="d7e2" class="kf kg ht kb b fv kl ki l kj kk">const identityService = ca.newIdentityService();</span><span id="8201" class="kf kg ht kb b fv kl ki l kj kk">const retrieveIdentity = await identityService.getOne("testinguser",adminIdentity)</span><span id="dc0e" class="kf kg ht kb b fv kl ki l kj kk">console.log("user attributes: ",retrieveIdentity.result.attrs)</span><span id="879e" class="kf kg ht kb b fv kl ki l kj kk">} catch (error) {</span><span id="9f79" class="kf kg ht kb b fv kl ki l kj kk">console.error(`Failed to register user "testinguser": ${error}`);</span><span id="af87" class="kf kg ht kb b fv kl ki l kj kk">process.exit(1);</span><span id="3c69" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="8870" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="77af" class="kf kg ht kb b fv kl ki l kj kk">main();</span></pre><p id="8107" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您可以看到控制台中记录的身份详细信息，其自定义属性“role”的值为“patient”。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff km"><img src="../Images/8d19e1651d9451805e514165c6e7db74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fnvi0yc4pvFNyLp7Ys5STA.png"/></div></div></figure><p id="f186" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们试着将属性“角色”从病人改为医生，</p><p id="50e5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以CLI方式进行，</p><pre class="jp jq jr js fq ka kb kc kd aw ke dt"><span id="8a59" class="kf kg ht kb b fv kh ki l kj kk">fabric-ca-client identity modify testinguser --json '{"secret": "newPassword", "affiliation": ".", "attrs": [{"name": "role", "value": "patient"}]}'</span></pre><p id="94ca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您想使用Node SDK更改属性，可以使用IdentityService类来创建/更新/删除/检索身份。</p><p id="4399" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看下面的代码，</p><pre class="jp jq jr js fq ka kb kc kd aw ke dt"><span id="aeb8" class="kf kg ht kb b fv kh ki l kj kk">'use strict';</span><span id="fdac" class="kf kg ht kb b fv kl ki l kj kk">const { FileSystemWallet, Gateway, X509WalletMixin, User } = require('fabric-network');</span><span id="0c09" class="kf kg ht kb b fv kl ki l kj kk">const path = require('path');</span><span id="4699" class="kf kg ht kb b fv kl ki l kj kk">const ccpPath = path.resolve(__dirname, '..', '..', 'first-network', 'connection-org1.json');</span><span id="de5a" class="kf kg ht kb b fv kl ki l kj kk">async function main() {</span><span id="1bdf" class="kf kg ht kb b fv kl ki l kj kk">try {</span><span id="b9cc" class="kf kg ht kb b fv kl ki l kj kk">// Create a new file system based wallet for managing identities.</span><span id="5d8d" class="kf kg ht kb b fv kl ki l kj kk">const walletPath = path.join(process.cwd(), 'wallet');</span><span id="38ba" class="kf kg ht kb b fv kl ki l kj kk">const wallet = new FileSystemWallet(walletPath);</span><span id="b18f" class="kf kg ht kb b fv kl ki l kj kk">console.log(`Wallet path: ${walletPath}`);</span><span id="7d1a" class="kf kg ht kb b fv kl ki l kj kk">// Check to see if we've already enrolled the user.</span><span id="f769" class="kf kg ht kb b fv kl ki l kj kk">const userExists = await wallet.exists('testinguser');</span><span id="f8bd" class="kf kg ht kb b fv kl ki l kj kk">if (!userExists) {</span><span id="44f6" class="kf kg ht kb b fv kl ki l kj kk">console.log('An identity for the user "testinguser" does not exist in the wallet');</span><span id="ea48" class="kf kg ht kb b fv kl ki l kj kk">console.log('Run the registerUser.js application before retrying');</span><span id="57b3" class="kf kg ht kb b fv kl ki l kj kk">return;</span><span id="c01a" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="f1df" class="kf kg ht kb b fv kl ki l kj kk">const gateway = new Gateway();</span><span id="d8f3" class="kf kg ht kb b fv kl ki l kj kk">await gateway.connect(ccpPath, { wallet, identity: 'admin', discovery: { enabled: true, asLocalhost: true } });</span><span id="b366" class="kf kg ht kb b fv kl ki l kj kk">const ca = gateway.getClient().getCertificateAuthority();</span><span id="8888" class="kf kg ht kb b fv kl ki l kj kk">const adminIdentity = gateway.getCurrentIdentity();</span><span id="1a73" class="kf kg ht kb b fv kl ki l kj kk">const identityService = ca.newIdentityService();</span><span id="689c" class="kf kg ht kb b fv kl ki l kj kk">let updateObj = {</span><span id="024e" class="kf kg ht kb b fv kl ki l kj kk">type:"client",</span><span id="9801" class="kf kg ht kb b fv kl ki l kj kk">affiliation:"org1.department1" ,</span><span id="b6c7" class="kf kg ht kb b fv kl ki l kj kk">attrs: [{ name: "role", value: "doctor", ecert: true }] ,</span><span id="045a" class="kf kg ht kb b fv kl ki l kj kk">caname:"ca_peerOrg1"</span><span id="be68" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="c30f" class="kf kg ht kb b fv kl ki l kj kk">// update identity</span><span id="b29f" class="kf kg ht kb b fv kl ki l kj kk">const response = await identityService.update("testinguser",updateObj,adminIdentity)</span><span id="dad5" class="kf kg ht kb b fv kl ki l kj kk">console.log("userIdenity attributes: ",response.result.attrs)</span><span id="7069" class="kf kg ht kb b fv kl ki l kj kk">} catch (error) {</span><span id="e142" class="kf kg ht kb b fv kl ki l kj kk">console.error(`Failed to update "testinguser" attributes: ${error}`);</span><span id="3cd7" class="kf kg ht kb b fv kl ki l kj kk">process.exit(1);</span><span id="645c" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="0e6c" class="kf kg ht kb b fv kl ki l kj kk">}</span><span id="0bc2" class="kf kg ht kb b fv kl ki l kj kk">main();</span></pre><p id="49bf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当您运行代码时，您可以看到值为doctor的修改后的“role”属性的详细信息。太好了！</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff kn"><img src="../Images/2e51a9af5747a0a729173bdbfa8dad87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0rY2si05qilUTcnKHuC_WA.png"/></div></div></figure><p id="eefc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这样，您可以在Hyperledger Fabric中更新身份详细信息，而无需重新注册。</p><p id="7714" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">快乐学习！！！</p><blockquote class="ko"><p id="e68d" class="kp kq ht bd kr ks kt ku kv kw kx jn ek translated"><a class="ae ky" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="la lb lc ld le jt fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff kz"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>