<html>
<head>
<title>Solidity: Transaction-Ordering Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可靠性:事务排序攻击</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/solidity-transaction-ordering-attacks-1193a014884e?source=collection_archive---------0-----------------------#2018-03-06">https://medium.com/coinmonks/solidity-transaction-ordering-attacks-1193a014884e?source=collection_archive---------0-----------------------#2018-03-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/6805d09884b4b4949347cb562a8f1877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qH4N6Vp6bc_PuajD4z2Gyw.png"/></div></div></figure><p id="df63" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">本文将解释<strong class="jd hu">以太坊智能合约</strong>中的一种攻击载体，称为<strong class="jd hu">交易订购/前置运行攻击</strong>。</p></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><p id="fc82" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">为什么？</strong></p><ul class=""><li id="47f4" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy kl km kn ko dt translated">创建安全智能合同的最佳实践</li><li id="e09c" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">识别常见的攻击</li><li id="c83b" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">确保资金不会因编程错误而损失</li></ul><figure class="kv kw kx ky fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ku"><img src="../Images/393c8ed20db437ec5f1dc1fa8263564e.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*GwovmPM7mF-9susMXjKjbg.png"/></div></div></figure></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><p id="b9cd" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">交易订购攻击</strong></p><ul class=""><li id="b0f6" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy kl km kn ko dt translated">事务排序攻击是一种竞争条件攻击</li><li id="44ff" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">简而言之，如果你以广告价格购买一件商品，你会支付这个价格</li><li id="0770" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">交易订购攻击会在交易过程中改变价格，因为在交易完成之前，其他人(合同所有者、矿工或其他用户)已经发送了修改价格的交易</li><li id="0714" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">两个事务可以发送到mempool/tx-pool，它们到达的顺序无关紧要</li><li id="19c5" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">在这种情况下，与交易一起发送的气体是至关重要的，因为它决定了先开采哪个交易</li><li id="516e" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">攻击者也可以是挖掘者，因为挖掘者可以选择挖掘事务的顺序</li><li id="84e9" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">这在智能合约中产生了一个问题，智能合约依赖于存储变量的状态根据交易的顺序保持在某个值</li></ul><figure class="kv kw kx ky fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kz"><img src="../Images/aeb122198079154c6e14afa62cd3de80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lrjVFLIM5qSYyxLF1I0zOg.jpeg"/></div></div></figure></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><p id="a004" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">合同</strong></p><ul class=""><li id="f438" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy kl km kn ko dt translated">下面的合同将作为中介，以一定的价格提供数字资产</li><li id="ead0" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">价格记录在存储变量<code class="eh la lb lc ld b">uint256 price</code>中</li><li id="1745" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">合同的所有者可以通过调用<code class="eh la lb lc ld b">setPrice(uint256 _price)</code>函数来更改价格</li></ul><pre class="kv kw kx ky fq le ld lf lg aw lh dt"><span id="efaa" class="li lj ht ld b fv lk ll l lm ln">pragma solidity ^0.4.18;<br/><br/>contract TransactionOrdering {<br/>    uint256 price;<br/>    address owner;<br/>    <br/>    event Purchase(address _buyer, uint256 _price);<br/>    event PriceChange(address _owner, uint256 _price);<br/>    <br/>    modifier ownerOnly() {<br/>        require(msg.sender == owner);<br/>        _;<br/>    }<br/><br/>    function TransactionOrdering() {<br/>        // constructor<br/>        owner = msg.sender;<br/>        price = 100;<br/>    }<br/><br/>    function buy() returns (uint256) {<br/>        Purchase(msg.sender, price);<br/>        return price;<br/>    }<br/><br/>    function setPrice(uint256 _price) ownerOnly() {<br/>        price = _price;<br/>        PriceChange(owner, price);<br/>    }<br/>}</span></pre><p id="9c1f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">合同部署在:0 xfd 3673 a4 FD 729 ee 501 cbac D4 AAC 97741 e 287d 318</p><blockquote class="lo"><p id="3152" class="lp lq ht bd lr ls lt lu lv lw lx jy ek translated"><a class="ae ly" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="ma mb mc md me iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lz"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><p id="cc6a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">攻击场景:</strong></p><ol class=""><li id="092b" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy mf km kn ko dt translated">数字资产的<strong class="jd hu">购买者</strong>将调用<strong class="jd hu"> buy() </strong>函数，以存储变量中指定的价格设置购买，起始<strong class="jd hu">价格=100 </strong>。</li></ol><p id="ffc8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">2.<strong class="jd hu">合同所有者</strong>将调用<strong class="jd hu"> setPrice() </strong>并将价格存储变量更新为<strong class="jd hu"> price=150 </strong>。</p><p id="d2e7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">3.<strong class="jd hu">合同所有者</strong>将发送带有<strong class="jd hu">更高天然气费用</strong>的交易。</p><p id="60df" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">4.<strong class="jd hu">合同所有者的</strong>交易将首先被挖掘，由于较高的气费而更新合同的状态。</p><p id="4eff" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">4.<strong class="jd hu">买家</strong>交易很快就会被挖掘，但是现在<strong class="jd hu"> buy() </strong>函数将使用新更新的<strong class="jd hu"> price=150 </strong>。</p></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><p id="5a0d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">解决方案</strong></p><ul class=""><li id="5202" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy kl km kn ko dt translated">一种解决方案是使用交易计数器来“锁定”商定的价格</li></ul><pre class="kv kw kx ky fq le ld lf lg aw lh dt"><span id="55d6" class="li lj ht ld b fv lk ll l lm ln">pragma solidity ^0.4.18;<br/><br/>contract SolutionTransactionOrdering {<br/>  uint256 price;<br/>  uint256 txCounter;<br/>  address owner;<br/>  <br/>  event Purchase(address _buyer, uint256 _price);<br/>  event PriceChange(address _owner, uint256 _price);<br/>  <br/>  modifier ownerOnly() {<br/>    require(msg.sender == owner);<br/>    _;<br/>  }<br/>  function getPrice() constant returns (uint256) {<br/>    return price;<br/>  }<br/><br/>  function getTxCounter() constant returns (uint256) {<br/>    return txCounter;<br/>  }<br/><br/>  function SolutionTransactionOrdering() {<br/>    // constructor<br/>    owner = msg.sender;<br/>    price = 100;<br/>    txCounter = 0;<br/>  }<br/><br/>  function buy(uint256 _txCounter) returns (uint256) {<br/>    require(_txCounter == txCounter);<br/>    Purchase(msg.sender, price);<br/>    return price;<br/>  }<br/><br/>  function setPrice(uint256 _price) ownerOnly() {<br/>    price = _price;<br/>    txCounter += 1;<br/>    PriceChange(owner, price);<br/>  }<br/>}</span></pre><ol class=""><li id="7fe0" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy mf km kn ko dt translated">买方现在请求以发送交易时显示的价格购买。</li><li id="207c" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy mf km kn ko dt translated">这是通过买方发送一个反映txCounter ( <code class="eh la lb lc ld b">function buy(uint256 _txCounter)</code>)当前状态的整数来实现的</li></ol><p id="fc16" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">3.当<strong class="jd hu">合同所有者更新价格</strong>时，txCounter递增(<code class="eh la lb lc ld b">function setPrice(uint256 _price) ownerOnly() {... txCounter += 1}</code></p><p id="c8aa" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">4.现在，在交易排序攻击的场景中，如果买方的txCounter整数与合同中的当前状态不同，则买方的交易将被恢复</p><p id="8c53" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">5.这意味着价格在买方交易过程中已经改变，因此不会被接受</p><p id="1130" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">合同部署在:0x 1 abfe 2 f 12447 e 877 CB 1 bfe 91 a4 e 7 eed 0251 B4 d 56</p></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><p id="0439" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">结论</strong></p><ul class=""><li id="a9f4" class="kg kh ht jd b je jf ji jj jm ki jq kj ju kk jy kl km kn ko dt translated">事务排序攻击是一种常见的攻击媒介</li><li id="7480" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">智能合约本质上是异步的，因为我们在发送事务和挖掘时间之间存在时间差</li><li id="fed1" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">所有交易都是不平等的，与交易相关的不同天然气水平将激励矿商优先考虑订单</li><li id="e54d" class="kg kh ht jd b je kp ji kq jm kr jq ks ju kt jy kl km kn ko dt translated">如果一个契约提供了一个时间敏感的服务，状态应该根据事务的顺序被锁定</li></ul><figure class="kv kw kx ky fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mg"><img src="../Images/5cd2532b5215520531451e16d98f115b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZhYyhAFa_7RLXKY65sd0A.png"/></div></div></figure></div></div>    
</body>
</html>