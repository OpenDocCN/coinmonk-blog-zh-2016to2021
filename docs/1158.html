<html>
<head>
<title>Integrating physical devices with IOTA — Managing price and addresses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将物理设备与IOTA集成—管理价格和地址</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/integrating-physical-devices-with-iota-price-and-addresses-4f352e321cbb?source=collection_archive---------4-----------------------#2018-07-28">https://medium.com/coinmonks/integrating-physical-devices-with-iota-price-and-addresses-4f352e321cbb?source=collection_archive---------4-----------------------#2018-07-28</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="6c3d" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">关于将物理设备与IOTA协议集成的初学者教程系列的第4部分。</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div class="fe ff ji"><img src="../Images/a99e7972a1d985cbd751a42cd18da8e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*3z7eKcLh5ddpzj3JCgTXQA.jpeg"/></div></figure><h1 id="c578" class="jq jr ht bd js jt ju jv jw jx jy jz ka iz kb ja kc jc kd jd ke jf kf jg kg kh dt translated">介绍</h1><p id="266b" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">这是关于将物理设备与IOTA协议集成的初学者教程系列的第4部分。在本教程中，我们将为我们的IOTA支付系统添加几个新功能。这些特征与我们如何在动荡的IOTA市场中管理我们的服务价格以及我们如何处理IOTA一次性签名问题有关。</p><p id="a3cf" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">如果你还没有阅读本系列的第一篇<a class="ae lj" rel="noopener" href="/coinmonks/integrating-physical-devices-with-iota-83f4e00cc5bb">和第三篇</a><a class="ae lj" rel="noopener" href="/@hugogregersen/integrating-physical-devices-with-iota-83f4e00cc5bb">教程，你应该在继续之前阅读它们，因为它们构成了我们在本教程中构建的项目的基础。</a></p><p id="b070" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><em class="lk">注意！<br/>与本系列之前的教程相比，本教程将更加面向软件，因为我们不会在项目中添加任何新的硬件。</em></p><h1 id="3f0d" class="jq jr ht bd js jt ju jv jw jx jy jz ka iz kb ja kc jc kd jd ke jf kf jg kg kh dt translated">使用案例</h1><p id="7acd" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">现在我们已经有了基于LCD的用户界面，我们应该更仔细地看看在<a class="ae lj" rel="noopener" href="/@hugogregersen/integrating-physical-devices-with-iota-83f4e00cc5bb">之前的</a>教程中简要提到的几个问题。先说通常被称为<em class="lk">地址复用</em>的话题。</p><p id="6ee0" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">地址重用</strong> <br/>为了明确起见，当我使用术语“IOTA一次性签名问题”时，我不是指IOTA中的任何错误或bug中的“问题”。IOTA一次性签名方案是通过设计添加到IOTA协议中的保护机制。尽管如此，在IOTA协议之上构建应用程序时，这是我们需要注意和处理的事情。如先前教程“<em class="lk">中所述，只要酒店所有者不从他的冰箱地址花费任何资金，他们是完全安全的，然而，一旦他从其中一个地址花费任何资金，该地址就不再安全，并且必须由新的IOTA支付地址替换。</em>这实际上意味着，每次您从IOTA地址消费资金时，其私钥的一部分就会被暴露，这使得不良行为者有可能伪造其签名并窃取其资金。那么，我们该如何处理这个“问题”呢？我们必须假设酒店老板想花掉他辛苦赚来的一分一毫，对吗？对他来说，一个选择是只要他想从旧地址消费，就用新地址替换旧的冰箱付款地址。一个更好的选择可能是简单地为每次付款生成一个新地址，这样我们就可以一起忽略地址重用问题。现在我们已经有了新的LCD，我们也有了实施该解决方案的实用方法。</p><p id="fb80" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">我想在本教程中讨论的第二个问题是，在不稳定的IOTA市场中，我们如何管理冰箱服务的价格。我们的冰箱服务采用静态IOTA价格，比如1小时服务1 MIOTA，可能不是我们酒店业主的最佳商业模式。毕竟，他用美元支付的电费和冰箱维护费基本上是固定的，与IOTA市场价格的日常波动无关。我认为对我们酒店老板来说，一个更可持续的商业模式是用美元为他的冰箱服务定价，比如1小时服务1美元，而不是在每次交易开始时将美元价格转换成MIOTA。那么我们如何实现这个特性呢？再次，我们的新液晶显示器来拯救。通过使用API调用流行的coinmarketcap.com网站，我们可以查找以美元为单位的当前IOTA价格，将我们的美元价格转换为IOTA价格，并在LCD上显示正确的IOTA价格。我们需要考虑的另一个问题是，我们的美元价格也可能会根据外部因素(如电价)而不时变化。因此，我们必须确保我们有一个简单的方法来更新美元价格，同时确保客人得到他支付的服务时间。利用一些基本的数学知识，这一切都是可能的。</p><p id="afd5" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><em class="lk">注意！<br/>值得注意的是，新的Trinity钱包已经内置了将法定货币转换为IOTA的功能。因此，从这个意义上说，以法定货币显示冰箱价格，并让Trinity负责法定货币到IOTA货币的转换可能就足够了。</em></p><h1 id="ede3" class="jq jr ht bd js jt ju jv jw jx jy jz ka iz kb ja kc jc kd jd ke jf kf jg kg kh dt translated">支付过程</h1><p id="9f43" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">接下来，让我们看看基于为每次支付生成新地址的新支付流程是什么样子的。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/c05663012d80ec16ac0bb457c03cd056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*4NMSxE6I0L5Q5EvJRnKkVg.png"/></div></figure><ol class=""><li id="2560" class="lm ln ht kk b kl le ko lf kr lo kv lp kz lq ld lr ls lt lu dt translated"><strong class="kk hu">生成新的支付地址</strong> <br/>我们首先使用PyOTA中的<em class="lk"> get_new_addresses() </em>函数生成一个新的支付地址。注意，我们现在必须在创建api对象时提供一个有效的<strong class="kk hu">种子</strong>。此<strong class="kk hu">种子</strong>将在生成地址时由函数使用。还要注意的是，<em class="lk"> get_new_addresses() </em>是一个确定性函数，这意味着我们每次都需要为函数提供一个唯一的索引，以确保我们不会两次生成相同的地址。可能有不同的方法为函数提供唯一的索引，例如时间戳等。在我的例子中，我简单地使用了一个计数器，每次付款都加1。</li><li id="f87f" class="lm ln ht kk b kl lv ko lw kr lx kv ly kz lz ld lr ls lt lu dt translated"><strong class="kk hu">生成并显示新的二维码</strong> <br/>接下来，我们获取新地址并将其发送到我们的二维码生成器。请注意，在进行IOTA支付时，我们必须在支付地址中包含校验和。因此，在将我们的地址发送到QR码生成器之前，我们使用<em class="lk"> with_valid_checksum() </em>函数将校验和添加到地址中。</li><li id="f505" class="lm ln ht kk b kl lv ko lw kr lx kv ly kz lz ld lr ls lt lu dt translated"><strong class="kk hu">检查交易地址</strong> <br/>接下来，我们开始查找我们地址的收款。一旦有新的交易被添加到我们的地址，我们就知道有一笔款项即将到来。</li><li id="4cb5" class="lm ln ht kk b kl lv ko lw kr lx kv ly kz lz ld lr ls lt lu dt translated"><strong class="kk hu">隐藏二维码</strong>在我的例子中，我将QR码替换为一条消息，表明已检测到新的付款，我们正在等待付款确认。</li><li id="14fd" class="lm ln ht kk b kl lv ko lw kr lx kv ly kz lz ld lr ls lt lu dt translated"><strong class="kk hu">获取地址余额</strong> <br/>接下来，我们开始检查我们的地址是否有正余额，这意味着在步骤3中检测到的交易(支付)已经被确认。</li><li id="09eb" class="lm ln ht kk b kl lv ko lw kr lx kv ly kz lz ld lr ls lt lu dt translated"><strong class="kk hu">将时间添加到lightbalance </strong> <br/>一旦检测到正余额，我们将获取新的IOTA余额，并根据当前时间/美元价格将其转换为时间。我们最后将计算出的时间添加到我们当前的光线平衡中，这个过程不断重复。</li></ol><h1 id="8b61" class="jq jr ht bd js jt ju jv jw jx jy jz ka iz kb ja kc jc kd jd ke jf kf jg kg kh dt translated">成分</h1><p id="c995" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">相对于<a class="ae lj" rel="noopener" href="/coinmonks/integrating-physical-devices-with-iota-adding-a-user-interface-2fb028a8fee1">之前的</a>教程，不需要额外的组件。</p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="e108" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">所需的软件和库</h1><p id="a8a6" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">相对于<a class="ae lj" rel="noopener" href="/coinmonks/integrating-physical-devices-with-iota-adding-a-user-interface-2fb028a8fee1">之前的</a>教程，不需要额外的软件或库。</p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="26f3" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">Python代码</h1><p id="6d54" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">现在让我们看看自从<a class="ae lj" rel="noopener" href="/coinmonks/integrating-physical-devices-with-iota-adding-a-user-interface-2fb028a8fee1">之前的</a>教程以来，Python代码中添加的一些新函数。</p><p id="31b9" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">种子</strong> <br/>最重要的变化当然是我们不再有一个固定的支付地址来收取我们所有的付款。相反，我们为每笔付款生成一个新地址。为此，我们现在必须向IOTA地址生成器提供一个<strong class="kk hu">种子</strong>。因此，确保用自己的<strong class="kk hu">种子</strong>替换Python代码中的<strong class="kk hu">种子</strong>。查看<a class="ae lj" href="https://blog.iota.org/the-secret-to-security-is-secrecy-d32b5b7f25ef" rel="noopener ugc nofollow" target="_blank">这里</a>了解更多关于创建IOTA种子的信息。</p><p id="19e9" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">索引计数器</strong> <br/>增加了一个新的读/写索引计数器功能，以确保我们在断电等情况下跟踪最新的地址索引。索引计数器函数使用Python <em class="lk"> configparser </em>库，该库使用<strong class="kk hu">将数据存储为文本文件。ini </strong>格式。确保下载“let_there_be_light.ini”文件并将其放在与Python程序相同的文件夹中，否则会出现错误。你可以从<a class="ae lj" href="https://gist.github.com/huggre/c5185df916ca00d2e1d12943a9d9d03a" rel="noopener ugc nofollow" target="_blank">这里</a>下载文件。</p><p id="2320" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">等待图标</strong> <br/>为了防止用户向同一个IOTA地址进行多次支付，一旦检测到新的支付，我们会将我们的二维码暂时替换为沙漏图标。请注意，pyQRcode库在将QR代码呈现给GUI时使用了TkInter BitmapImage函数。这个函数使用一种特殊的图形文件格式，称为XBM，这意味着我们不能使用我们典型的图形格式，如bmp，jpg，png等。然而，如果你想创建自己的图标，有一些应用程序和在线服务可以让你将典型的图形格式转换成XBM。为了防止在使用我的Python示例代码时出现任何错误，请确保下载“hourglass.xbm”文件并将其放在与Python程序相同的文件夹中。你可以从<a class="ae lj" href="https://gist.github.com/huggre/c126863786991b49c2965d42b12f6b3d" rel="noopener ugc nofollow" target="_blank">这里</a>下载文件。</p><p id="a311" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">价格</strong>为此，我创建了在Python程序启动时读取的lightprice_USD变量。将我们的美元服务价格转换为IOTA的价格时，也会使用lightprice_USD变量。要更改服务价格，只需将lightprice_USD变量更新为与服务价格相匹配的值。请注意，lightprice_USD是一个浮点数，价格以美元表示。一分钟服务。</p><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="mm mn l"/></div></figure><p id="7d54" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">你可以从<a class="ae lj" href="https://gist.github.com/huggre/c0b4776d9430c02c07671be19c400210" rel="noopener ugc nofollow" target="_blank">这里</a>下载Python源代码</p><h1 id="c2fc" class="jq jr ht bd js jt ju jv jw jx jy jz ka iz kb ja kc jc kd jd ke jf kf jg kg kh dt translated">运行项目</h1><p id="f980" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">要运行这个项目，首先需要将上一节中的代码保存为Raspberry PI上的文本文件。</p><p id="eea6" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">注意Python程序文件使用。py扩展名，那么我们就把文件保存为<strong class="kk hu"><em class="lk">let _ there _ light _ addr . py</em></strong>在树莓PI上吧。</p><p id="56df" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">要执行该程序，只需启动一个新的终端窗口，导航到保存<em class="lk">let _ there _ be _ light _ addr . py</em>的文件夹，然后键入:</p><p id="1af1" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><strong class="kk hu">python let _ there _ be _ light _ addr . py</strong></p><p id="c7f1" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">现在，您应该会看到GUI出现在您的LCD/显示器上，显示自动生成的IOTA支付地址的QR码。一旦一笔付款被确认，一个新的地址将被生成并显示在GUI中。要退出Python程序，只需按退出按钮。</p><p id="9f3b" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated"><em class="lk">注意！<br/>在执行程序之前，请确保下载“iota_logo75.jpg”文件并将其放在与python文件相同的文件夹中，否则会出现错误。logo文件可以从</em> <a class="ae lj" href="https://github.com/huggre/pay_the_light_gui/blob/master/iota_logo75.jpg" rel="noopener ugc nofollow" target="_blank"> <em class="lk">这里下载</em> </a> <em class="lk">。</em></p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="1962" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">支付光</h1><p id="867a" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">要打开LED(或者在我的情况下，将<strong class="kk hu">灯设置为打开</strong>状态),您只需使用您最喜欢的移动IOTA钱包，扫描GUI中显示的二维码，然后传输一些IOTA。一旦IOTA tangle确认了交易，LED应该亮起(或者在我的情况下，将<strong class="kk hu">灯设置为打开</strong>状态)，并保持亮起，直到灯余额为空，这取决于您传输的IOTA的数量。</p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="f61a" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">下一步是什么？</h1><p id="ed20" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">你可以在这里找到本系列下一个教程的链接<a class="ae lj" rel="noopener" href="/coinmonks/integrating-physical-devices-with-iota-using-rfid-with-iota-868c15e0a040"/></p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="c084" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">贡献</h1><p id="7601" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">如果你想对本教程有所贡献，你可以在这里找到一个Github库<a class="ae lj" href="https://github.com/huggre/pay_the_light_addr" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl ma mb hb mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hm hn ho hp hq"><h1 id="7564" class="jq jr ht bd js jt mh jv jw jx mi jz ka iz mj ja kc jc mk jd ke jf ml jg kg kh dt translated">捐款</h1><p id="70bd" class="pw-post-body-paragraph ki kj ht kk b kl km iu kn ko kp ix kq kr ks kt ku kv kw kx ky kz la lb lc ld hm dt translated">如果你喜欢这个教程，并希望我继续制作其他教程，请随时向下面显示的IOTA地址捐款。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/f898855aa9f02c497078a9bdbee25534.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*j2ENIzmDzXcGSgAdY4w-Jw.png"/></div></figure><p id="bf63" class="pw-post-body-paragraph ki kj ht kk b kl le iu kn ko lf ix kq kr lg kt ku kv lh kx ky kz li lb lc ld hm dt translated">nyzbhovsmdwabxsacajttwjoqrvvawlbsfqvsjswwbjjlsqknzfc 9 xcrpqsvfqzpbjcjrannpvmmezqjrqsvvgz</p></div></div>    
</body>
</html>