<html>
<head>
<title>Upgrade your smart contract using Openzeppelin CLI [2020]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Openzeppelin CLI升级您的智能合约[2020]</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/upgrade-your-smart-contract-using-openzeppelin-cli-2020-4422fbd328cd?source=collection_archive---------2-----------------------#2020-07-30">https://medium.com/coinmonks/upgrade-your-smart-contract-using-openzeppelin-cli-2020-4422fbd328cd?source=collection_archive---------2-----------------------#2020-07-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="d5e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就在一个多月前，我实习的办公室给了我一项任务，让我把他们的一份智能合同“升级”。于是，开始了我的旅程。通过查阅<a class="ae jo" href="https://docs.openzeppelin.com/upgrades/2.8/writing-upgradeable" rel="noopener ugc nofollow" target="_blank"> Openzeppelin docs </a>、<a class="ae jo" href="https://forum.openzeppelin.com/" rel="noopener ugc nofollow" target="_blank">论坛</a>和众多互联网文章，我得以完成这个任务。我把它展示给了我的办公室，现在是时候和你们大家分享了！我试图用尽可能少的附带信息使这成为简单明了的代码指南。顺便说一下，您需要对以太坊上的基本智能合约开发有所了解，如果您……拿起一杯咖啡，加入进来吧！💁</p><p id="abfe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可升级性是区块链的一个特性，宣传的不如实现的多。哪里…？在几乎所有部署到mainnet的智能合同中！嗯…为什么不呢？到处都需要可升级性！对区块链来说更是如此，他们处理敏感数据和资产的移动，包括金钱！如果包含一些错误或功能障碍的智能合同落入贪婪黑客的邪恶视线，可能会发生不可逆转的灾难性损失(例如，查看这些<a class="ae jo" rel="noopener" href="/solidified/the-biggest-smart-contract-hacks-in-history-or-how-to-endanger-up-to-us-2-2-billion-d5a72961d15d">大黑客</a>)。在升级过程中，您可以修复现有智能合同中的错误、漏洞并添加功能和变量，而无需更改您和您的用户在区块链中与之交互的地址。所有这些都是在升级之间保持变量的值或状态不变的情况下发生的！现在你可能会问…这是怎么回事？“不可改变的”区块链发生了什么事！？！</p><p id="f030" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">嗯…放松！在你开始质疑区块链的诚信之前，让我告诉你…它们仍然是不可改变的！你不知道的是这个被称为<a class="ae jo" href="https://docs.openzeppelin.com/upgrades/2.6/proxies" rel="noopener ugc nofollow" target="_blank">代理模式</a>的绝妙主意，它让区块链保持其本性，同时能够前进并适应变化！该模式通过创建一个包装契约(代理)来实现这一点，该包装契约将调用委托(转发)给我们的实际实现契约，同时用实现智能契约的状态变量来映射自身中的存储槽。对于每个事务，从代理使用状态存储，而从实现契约应用功能逻辑。因此，当一个实现契约被更新时，整个契约被部署到代理将指向下一个的另一个地址…给我们一种错觉，好像我们的契约是从以前的状态“更新”的！</p><p id="a3e2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">自己实现起来相当复杂。这就是为什么我们使用像<a class="ae jo" href="https://docs.openzeppelin.com/cli/2.7/" rel="noopener ugc nofollow" target="_blank"> Openzeppelin CLI </a>这样的工具，让我们使用非常简单的命令来完成所有这些工作，同时从我们那里抽象出事后诸葛亮的沉重细节！</p><p id="2aa8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们将在本文中讨论以下主题。设置Openzeppelin CLI <br/> 2。添加配置文件<br/> 3。撰写可升级智能合同时需要考虑的要点<br/> 4。示例合同:简单存储5。编译和部署智能合同<br/> 6。升级到版本2…增加功能和状态<br/> 7。将版本2部署到网络<br/> 8。与升级后的实例<br/> 9进行交互。使用库升级到版本3…10。重新交互以重新检查</p><blockquote class="jp jq jr"><p id="913f" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hm dt translated">注<em class="ht"> : </em>您可以在本回购  <strong class="is hu">中找到本指南<a class="ae jo" href="https://github.com/asmitadhungana/UpgradeSmartContracts" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">的代码；)</strong></a></strong></p></blockquote><h1 id="c668" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">1.设置Openzeppelin CLI</h1><p id="5b27" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">为了能够使用openzeppelin的内置功能(它很健壮，可以与truffle相媲美)，您首先需要使用它的CLI。首先，确保您的计算机中全局安装了nodeJS和npm。现在，在你想要的驱动器中创建一个新目录，然后跳进去！一旦进入:</p><ul class=""><li id="1440" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh dt translated">初始化一个空节点项目<br/> <code class="eh li lj lk ll b">$ npm init</code></li><li id="f8b4" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">安装Openzeppelin CLI<br/>T1】</li><li id="fd03" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">创建一个新的CLI项目来管理您已部署的合同<br/> <code class="eh li lj lk ll b">$ npx openzeppelin init </code> <strong class="is hu"> <br/> </strong> <em class="js">【注意:您可以将每个CLI命令的“openzeppelin”替换为“oz”】<br/></em>在初始化时，将形成三个主要构件:<br/> <em class="js"> *。打开zeppelin </em>目录，该目录将保存项目特定信息<br/> <em class="js"> * contracts </em>目录，您将在其中编写所有智能contracts<br/><em class="js">* networks . js</em>文件，您将在其中管理您的网络配置</li><li id="672b" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">注意跟踪<em class="js">中的以下文件。openzeppelin </em>使用版本控制(git)<br/>*<em class="js">project . JSON<br/></em>*公共网络文件像<em class="js">mainnet.json/ropsten.json/rinkeby.json</em></li></ul><h1 id="4dba" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">2.添加配置文件</h1><p id="6090" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">您可以将这些内容复制到项目中各自的文件中:</p><ul class=""><li id="375d" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh dt translated"><strong class="is hu"> package.json </strong></li></ul><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 1: package.json</figcaption></figure><p id="9882" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在…运行<code class="eh li lj lk ll b">$ npm install</code> <br/>在这里，第13行、第14行和第19行中的依赖项是主要的依赖项[阅读3.3]，而其他的是可选的。它们是openzeppelin库，允许我们创建可升级的智能合同。在15中，依赖项是<strong class="is hu"><em class="js">Truffle HD wallet provider</em></strong>，一个通过<a class="ae jo" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> infura.io </a>或任何其他兼容提供程序配置以太坊网络连接的便捷工具。而第16行的<strong class="is hu"> <em class="js"> dotenv </em> </strong>允许你从源代码中分离出秘密。这在协作环境中很有用，在这种环境中，您可能不想与他人共享您的数据库登录凭证或私钥。</p><ul class=""><li id="a7b7" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh dt translated"><strong class="is hu"> networks.js </strong></li></ul><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 2: networks.js</figcaption></figure><p id="4528" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这些是允许您的openzeppelin项目连接到各自网络的网络配置。这里，我们为本地以太坊模拟器<a class="ae jo" href="https://www.trufflesuite.com/ganache" rel="noopener ugc nofollow" target="_blank"> Ganache </a>和以太坊测试网<a class="ae jo" href="https://rinkeby.etherscan.io/" rel="noopener ugc nofollow" target="_blank"> rinkeby </a>添加网络配置(将在本教程中使用)。</p><h2 id="b235" class="mc jx ht bd jy md me mf kc mg mh mi kg jb mj mk kk jf ml mm ko jj mn mo ks mp dt translated">。包封/包围（动词envelop的简写）</h2><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 3: .env</figcaption></figure><p id="0187" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">添加来自你的metamask钱包账户的助记符(确保它加载了一些测试乙醚)和你的rinkeby的Infura密钥，你可以按照<a class="ae jo" href="https://walkingtree.tech/deploying-a-smart-contract-in-rinkeby-using-infura/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>生成！</p><blockquote class="jp jq jr"><p id="a735" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hm dt translated"><strong class="is hu">警告！！！您不应将此文件提交给版本控制，因为它包含您的wallet种子短语和您的API密钥；有机器人等着用乙醚从任何账户中清除资金！为避免这种情况，请添加"。env "在你的<strong class="is hu">中换一行。gitignore </strong></strong></p></blockquote><h1 id="3c69" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">3.编写可升级智能合同时要考虑的要点</h1><p id="0be1" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">这些限制是由于管理EVM可升级智能合同开发的代理模式而产生的。这些是由于EVM的限制，而不是openzeppelin的限制:</p><ol class=""><li id="cdcb" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn mq lf lg lh dt translated"><strong class="is hu"> No constructor()函数:<br/> </strong>您不能使用solidity构造函数来初始化您的设置逻辑。相反，使用initialize函数代替带有初始化器修饰符的构造函数，初始化器修饰符继承自open zeppelin/contracts-ether eum-package/contracts/initialize able . sol。</li><li id="92da" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn mq lf lg lh dt translated"><strong class="is hu">无初始值声明:<br/> </strong>变量在契约中声明时不能声明初始值。<code class="eh li lj lk ll b">eg: uint256 initialValue = 0; </code>不允许出现在函数体之外。相反，在<em class="js">初始化器中为你的契约定义初始值。</em></li><li id="36fb" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn mq lf lg lh dt translated">没有普通的合同和库作为依赖关系<br/> 确保你安装的是<code class="eh li lj lk ll b"><a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-contracts-ethereum-package" rel="noopener ugc nofollow" target="_blank">@openzeppelin/contracts-ethereum-package</a></code>而不是普通的<code class="eh li lj lk ll b"><a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-contracts" rel="noopener ugc nofollow" target="_blank">@openzeppelin/contracts</a></code>。后者是为一般用途而设置的，而<code class="eh li lj lk ll b">@openzeppelin/contracts-ethereum-package</code>是为与<a class="ae jo" href="https://docs.openzeppelin.com/upgrades/2.8/" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin升级</a>一起使用而定制的。这意味着其合同<a class="ae jo" href="https://docs.openzeppelin.com/cli/2.6/dependencies#upgrades::writing-contracts.adoc#use-upgradeable-packages" rel="noopener ugc nofollow" target="_blank">已经设置为可升级</a>。</li><li id="abeb" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn mq lf lg lh dt translated"><strong class="is hu">升级期间无存储布局干预<br/> </strong>升级期间您不能:<br/> a .更改现有变量的类型<br/> b .更改变量声明的顺序<br/> c .删除现有变量<br/> d .在现有变量之前引入新变量</li></ol><h1 id="52ce" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">4.合同示例:简单存储</h1><p id="66a3" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">在“contracts”文件夹中，让我们在Solidity中创建一个名为“SimpleStorage.sol”的普通智能合同。它有一个名为<em class="js"> storedValue </em>的状态变量和一个函数<em class="js"> retrieve() </em>，任何用户都可以通过它来检索<em class="js"> storedValue </em> [ <em class="js">注意，solidity将默认为公共状态变量提供一个getter函数，这只是为了演示的目的</em></p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 4: vanilla Unupgradeable SimpleStorage.sol</figcaption></figure><p id="2f94" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，为了使它可升级，您必须按照[3]中的规则做一些调整，如下所示:</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 5: modified Upgradeable SimpleStorage.sol</figcaption></figure><h1 id="cda2" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">5.编译和部署智能合同</h1><p id="f9e6" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">使用openzeppelin cli命令来完成，如下所示:</p><ol class=""><li id="66a1" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn mq lf lg lh dt translated">编制合同:<br/> <code class="eh li lj lk ll b"><strong class="is hu">$ npx oz compile</strong></code></li><li id="2dcb" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn mq lf lg lh dt translated">将其部署到网络:<br/> <code class="eh li lj lk ll b"><strong class="is hu">$ npx oz deploy </strong></code> <strong class="is hu"> <br/> </strong> <em class="js">这将带您到一个交互式控制台，在那里您应该根据您的要求选择给定的选项。因为我将它部署在rinkeby testnet中，所以我会这样做:</em></li></ol><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="cc13" class="mc jx ht ll b fv mv mw l mx my">? choose the kind of deployment: upgradeable<br/>? Pick a network: rinkeby<br/>? Pick a contract to deploy: SimpleStorage<br/>? Call a function to initialize the instance after creating it? Y<br/>? Select which function<em class="js">:  *initialize()</em></span><span id="d94e" class="mc jx ht ll b fv mz mw l mx my"><em class="js">If all goes well, the returned text should be similar to this:</em></span><span id="8758" class="mc jx ht ll b fv mz mw l mx my">✓ Setting everything up to create contract instances<br/>✓ Instance created at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a<br/>To upgrade this instance run ‘oz upgrade’ 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a</span></pre><h1 id="ff21" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">6.升级到v2…添加功能和状态</h1><p id="88bc" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">假设我们想要添加一个可以增加storedValue的值的功能。因此，在前面的契约中，让我们添加一个新的状态变量<em class="js"> addedValue </em>来存储传递的参数，并添加一个<em class="js"> incrementValue( ) </em>函数来将其添加到<em class="js"> storedValue。</em></p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 6: SimpleStorage.sol Version 2</figcaption></figure><h1 id="3c5d" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">7.将版本2部署到网络</h1><p id="1dab" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">为此，您必须使用CLI命令“<em class="js"> oz upgrade </em>”，这将再次带您进入一个交互式控制台。选择如下所示的选项:</p><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="6269" class="mc jx ht ll b fv mv mw l mx my"><strong class="ll hu">$ npx oz upgrade</strong></span><span id="002c" class="mc jx ht ll b fv mz mw l mx my">? Pick a network:  rinkeby<br/>? Which instances would you like to upgrade?:  Choose by name<br/>? Pick an instance to upgrade ?  SimpleStorage<br/>? Call a function on the instance after upgrading it?  No</span><span id="631d" class="mc jx ht ll b fv mz mw l mx my">New variable 'uint256 addedValue' was added in contract SimpleStorage in contracts/SimpleStorage.sol:1 at the end of the contract.<br/>See https://docs.openzeppelin.com/upgrades/2.6//writing-upgradeable#modifying-your-contracts for more info.</span><span id="605a" class="mc jx ht ll b fv mz mw l mx my">✓ Contract SimpleStorage deployed<br/>All implementations have been deployed<br/>✓ Instance upgraded at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a. Transaction receipt: 0x43834b9b13c20db353b657fff15f4a3881da0cd092dc994cfb3400513e229d0f<br/>✓ Instance at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a upgraded</span></pre><h1 id="7fa5" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">8.与升级后的(v2)实例交互</h1><p id="6cbe" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">现在，让我们与升级后的实例进行交互，检查升级是否添加了<em class="js"> increment() </em>函数...<br/> Openzeppelin为我们提供了两个交互命令:<br/><em class="js">oz send-tx</em>调用修改状态变量的函数和<br/><em class="js">oz call</em>调用不修改状态变量的函数。</p><ul class=""><li id="0c25" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh dt translated">首先，我们将调用我们新引入的带有参数<em class="js"> 10 </em>的<em class="js"> increment() </em>函数来添加到<em class="js"> storedValue </em>:</li></ul><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="9532" class="mc jx ht ll b fv mv mw l mx my"><strong class="ll hu">$ npx oz send-tx</strong></span><span id="ccbf" class="mc jx ht ll b fv mz mw l mx my">? Pick a network: rinkeby<br/>? Pick an instance: SimpleStorage at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a<br/>? Select which function: incrementValue(x: uint256)<br/>? x: uint256: 10<br/>✓ Transaction successful. Transaction hash: 0x9a93f387a1166f324fa9221bc8d29abc948c97244f344c25fa237b786ce57f19</span></pre><ul class=""><li id="9a3e" class="kz la ht is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh dt translated">然后，我们将调用<em class="js"> retrieve() </em>函数来查看<em class="js"> storedValue </em>的值是否增加了:</li></ul><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="3d33" class="mc jx ht ll b fv mv mw l mx my"><strong class="ll hu">$ npx oz call</strong></span><span id="7775" class="mc jx ht ll b fv mz mw l mx my">? Pick a network rinkeby<br/>? Pick an instance SimpleStorage at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a<br/>? Select which function retrieve()<br/>✓ Method ‘retrieve()’ returned: 10<br/>10</span></pre><p id="e595" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们可以看到，<em class="js"> retrieve() </em>方法返回了<em class="js"> 10 </em>。也就是说我们的<em class="js"> increment() </em>函数添加成功了！干杯！</p><h1 id="9539" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">9。让我们再次升级…使用库:</h1><p id="aca3" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">现在，让我们看看如何将实用程序库添加到我们的可升级智能合同中。我们将把<a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-contracts-ethereum-package/blob/master/contracts/math/SafeMath.sol" rel="noopener ugc nofollow" target="_blank"> Openzeppelin的Safemath库</a>添加到我们的合同中，并修改<em class="js"> increment() </em>函数，以避免在添加过程中出现任何类型的溢出！请注意，我们只能添加可升级的库[3.3]</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="ly lz fg fe ff ma mb bd b be z ek">fig 7: SimpleStorage.sol Version 3</figcaption></figure><blockquote class="jp jq jr"><p id="78b7" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hm dt translated"><strong class="is hu">警告！</strong>更改或添加父合同可能会更改您的合同的存储变量。</p></blockquote><p id="3691" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="js">这是基于:</em><a class="ae jo" href="https://docs.openzeppelin.com/upgrades/2.8/writing-upgradeable#modifying-your-contracts" rel="noopener ugc nofollow" target="_blank"><strong class="is hu"><em class="js">https://docs . open zeppelin . com/upgrades/2.8/writing-upgradable # modifying-your-contracts</em></strong></a></p><blockquote class="jp jq jr"><p id="fd21" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hm dt translated">请注意，您也可能会通过更改其父合同无意中更改了合同的存储变量…交换基础合同的声明顺序，或引入新的基础合同，将会更改变量的实际存储方式…如果子合同有自己的变量，您也不能向基础合同添加新变量。</p></blockquote><h1 id="368b" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">10.重新交互以重新检查:</h1><p id="8b82" class="pw-post-body-paragraph iq ir ht is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hm dt translated">现在，让我们将升级后的SimpleStorage(版本3)部署到rinkeby testnet:</p><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="fce9" class="mc jx ht ll b fv mv mw l mx my"><strong class="ll hu">$ npx oz upgrade</strong></span><span id="6e41" class="mc jx ht ll b fv mz mw l mx my">? Pick a network rinkeby<br/>? Which instances would you like to upgrade? Choose by name<br/>? Pick an instance to upgrade SimpleStorage<br/>? Call a function on the instance after upgrading it? No<br/>Nothing to compile, all contracts are up to date.<br/>All implementations are up to date<br/>✓ Instance upgraded at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a. Transaction receipt: 0xe22a159bfaf3486a919db0d3cf66a5f199858f8cf4452efd2ef378a3ea07f1b8<br/>✓ Instance at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a upgraded</span></pre><p id="dfe5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">…并调用<em class="js"> retrieve() </em>函数来检查存储是否在这些升级之间被保留:</p><pre class="lr ls lt lu fq mr ll ms mt aw mu dt"><span id="2e25" class="mc jx ht ll b fv mv mw l mx my"><strong class="ll hu">$ npx oz call</strong></span><span id="810e" class="mc jx ht ll b fv mz mw l mx my">? Pick a network rinkeby<br/>? Pick an instance SimpleStorage at 0xC9F4797BeAA8c56af23760e7EB57A6e7196c693a<br/>? Select which function retrieve()<br/>✓ Method ‘retrieve()’ returned: 10<br/>10</span></pre><p id="7185" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们可以清楚地看到，<em class="js"> retrieve </em>函数将<em class="js"> storedValue </em>的值返回为<em class="js"> 10 </em>，与上一版本保持不变。这样，我们可以修改以前的函数，添加库，修复错误，同时保持变量的状态不变。最棒的是…我们可以像以前一样和同一个地址互动！</p><p id="eb13" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是本教程的全部内容…我希望这对你有用！在本系列的下一部分中，我将指导您如何以编程方式(使用我们自己的脚本)升级我们的智能合约！我将从SimpleStorage smart契约的最后一个状态(v3)继续向您展示！<br/>敬请期待……；)</p><h2 id="d189" class="mc jx ht bd jy md me mf kc mg mh mi kg jb mj mk kk jf ml mm ko jj mn mo ks mp dt translated"><strong class="ak">同样，请阅读</strong></h2><ul class=""><li id="f48c" class="kz la ht is b it ku ix kv jb na jf nb jj nc jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/defi-future-10-promising-projects-in-the-defi-world-ff2b697ab006">顶级DeFi项目</a></li><li id="0bc7" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/whats-the-best-crypto-trading-bot-in-2020-top-8-bitcoin-trading-bot-c16adeb13317">最佳加密交易机器人</a></li><li id="51e2" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">最好的比特币<a class="ae jo" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069?source=friends_link&amp;sk=324dd9ff8556ab578d71e7ad7658ad7c">硬件钱包</a></li><li id="69bb" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">最好的<a class="ae jo" rel="noopener" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b">加密税务软件</a></li><li id="7c4f" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/the-best-crypto-trading-platforms-in-2020-the-definitive-guide-updated-c72f8b874555">最佳加密交易平台</a></li><li id="3524" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/best-wallets-to-use-uniswap-e91a6385d9e8">unis WAP最佳钱包</a></li><li id="97a4" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">最佳<a class="ae jo" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">加密贷款平台</a></li><li id="a1cf" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">Bitsgap评论——一个轻松赚钱的加密交易机器人</li><li id="2401" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">为专业人士设计的加密交易机器人</li><li id="eb27" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">Bitmex的<a class="ae jo" rel="noopener" href="/coinmonks/the-idiots-guide-to-margin-trading-on-bitmex-dbbd7742c6fc?source=friends_link&amp;sk=7bfa99d2a181142510c8442c8ddb0786">保证金交易指南</a></li><li id="aaab" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">加密摇摆交易的权威指南</li><li id="cfc6" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/bitmex-advanced-margin-trading-guide-2270c195ce25?source=friends_link&amp;sk=1d986cca731f5084b9a2db4a4bc4a7ad"> Bitmex高级保证金交易指南</a></li><li id="6e2e" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/best-crypto-apis-for-developers-5efe3a597a9f">面向开发人员的最佳加密API</a></li><li id="b037" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/crypto-arbitrage-guide-how-to-make-money-as-a-beginner-62bfe5c868f6">加密套利</a>指南:新手如何赚钱</li><li id="b46f" class="kz la ht is b it lm ix ln jb lo jf lp jj lq jn le lf lg lh dt translated">顶级<a class="ae jo" href="https://blog.coincodecap.com/bitcoin-node-solutions" rel="noopener ugc nofollow" target="_blank">比特币节点</a>提供商</li></ul><blockquote class="nd"><p id="b751" class="ne nf ht bd ng nh ni nj nk nl nm jn ek translated"><a class="ae jo" href="https://coincodecap.com?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="no np nq nr ns lv fe ff paragraph-image"><a href="https://coincodecap.com?utm_source=coinmonks"><div class="fe ff nn"><img src="../Images/160ce73bd06d46c2250251e7d5969f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*BoDnKUyK8p4hitHAJZ5Pdw.png"/></div></a></figure></div></div>    
</body>
</html>