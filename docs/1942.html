<html>
<head>
<title>My pattern for async transactions of smart contracts written in Ethereum’s Solidity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我用以太坊写的智能合约异步交易模式</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/my-pattern-for-async-transactions-of-smart-contracts-written-in-ethereums-solidity-8b44008fe708?source=collection_archive---------5-----------------------#2019-01-04">https://medium.com/coinmonks/my-pattern-for-async-transactions-of-smart-contracts-written-in-ethereums-solidity-8b44008fe708?source=collection_archive---------5-----------------------#2019-01-04</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="530f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">许多在开发Solidity之前实现了Java、Go、Python…的开发人员感觉像是开着DeLorean回到了80年代末。坚固是坚固的，但非常有限。神谕长大了，永远留了下来。因此，异步可靠性合同是真实的。这是我的模式…</p><p id="eaeb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我将使用名为#ScriptIt  的<a class="ae jo" href="https://link.medium.com/Ff82rMqCcT" rel="noopener"> <strong class="is hu">船长节点oracle用于以下用例:</strong></a></p><ul class=""><li id="3032" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">新用户获得256分</li><li id="9fd3" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">对于每个新的呼叫，用户的点数将减少log2</li></ul><figure class="ke kf kg kh fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kd"><img src="../Images/4fe656eb9872ff9a971ca422202cc885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NDB_RGsV5PXksfdK-aXDhw.jpeg"/></div></div><figcaption class="kp kq fg fe ff kr ks bd b be z ek">the captain will run your NodeJS calls directly from Solidity in a Docker container and return the result back to your contract</figcaption></figure><h1 id="93d5" class="kt ku ht bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">智能合同</h1><p id="4d22" class="pw-post-body-paragraph iq ir ht is b it lr iv iw ix ls iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hm dt translated">异步联系人将从包含异步调用和回调功能的<code class="eh lw lx ly lz b">usingCaptainJS</code>派生。</p><p id="0f87" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了在回调发生时记住异步调用，你需要一个<code class="eh lw lx ly lz b">JobCounter</code>和一个<code class="eh lw lx ly lz b">mapping</code>的任务id和发送者的地址:</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="6aa4" class="me ku ht lz b fv mf mg l mh mi">uint JobCounter = 0;<br/>mapping (uint =&gt; address) JobToSenderMap;</span></pre><h1 id="66ed" class="kt ku ht bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">这些事件</h1><p id="c43c" class="pw-post-body-paragraph iq ir ht is b it lr iv iw ix ls iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hm dt translated">以太坊中的a同步交易是<em class="mj">待定</em>，然后<em class="mj">失败</em>或<em class="mj">成功</em> (ful)。异步事务需要发出事件来通知用户事务是挂起、成功还是失败。</p><p id="889f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，您定义了三个这样的事件，每个事件至少应该包含发件人的地址:</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="57a2" class="me ku ht lz b fv mf mg l mh mi">event <strong class="lz hu">GetPoints_Success</strong>(address Sender, uint Points);<br/>event <strong class="lz hu">GetPoints_Pending</strong>(address Sender);<br/>event <strong class="lz hu">GetPoints_Failed</strong>(address Sender, string ErrorMsg);</span></pre><h1 id="f16a" class="kt ku ht bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">该功能</h1><p id="8ad4" class="pw-post-body-paragraph iq ir ht is b it lr iv iw ix ls iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hm dt translated">以太坊的默认模式是每个用户调用一个契约函数，并支付在一个同步事务上下文中执行代码所需的费用。</p><p id="541e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是现在我们有了异步事务上下文。这意味着在同步功能调用终止后将需要额外的气体。</p><p id="515f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，您的功能必须是<code class="eh lw lx ly lz b">payable</code>，并且您的第一项检查必须是验证用户转移了足够的额外气体:</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="f24b" class="me ku ht lz b fv mf mg l mh mi">uint GasRequired = DEFAULT_GAS_UNITS * tx.gasprice + 70 szabo;</span><span id="794f" class="me ku ht lz b fv mk mg l mh mi">require(<strong class="lz hu">msg.value &gt;= GasRequired</strong>, "please send some extra gas...");</span></pre><p id="fddc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这个演示用例中，我们将需要在<code class="eh lw lx ly lz b">usingCaptainJS</code>中定义的默认天然气单位乘以当前交易天然气价格，再加上70 Szabo的交易费(船长需要向执行mathjs调用的集装箱船支付这笔费用)。</p><p id="d4c9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦确定用户已经转移了足够的气体，你可以根据GitHub 上船长的描述调用mathjs的log2函数:</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="0f27" class="me ku ht lz b fv mf mg l mh mi"><strong class="lz hu">Run</strong>(<br/>  JobCounter,      <br/>  <strong class="lz hu">concat</strong>("math:log2(",<strong class="lz hu">uintToString</strong>(PointsPerUser[msg.sender]), ")"),<br/>  "", "", 1, DEFAULT_GAS_UNITS, tx.gasprice<br/>);</span><span id="d711" class="me ku ht lz b fv mk mg l mh mi">emit <strong class="lz hu">GetPoints_Pending</strong>(msg.sender);</span></pre><p id="cd39" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在调用<code class="eh lw lx ly lz b">Run(...)</code>之后，您必须<code class="eh lw lx ly lz b">emit</code>处理<em class="mj">未决的</em>事件。如果调用<code class="eh lw lx ly lz b">Run(...)</code>失败，同步调用将失败。</p><h1 id="3310" class="kt ku ht bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">复试</h1><p id="f227" class="pw-post-body-paragraph iq ir ht is b it lr iv iw ix ls iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hm dt translated">一旦队长计算出用户积分的log2值，他将通过调用<code class="eh lw lx ly lz b">CaptainsResult</code>函数将结果发送回您的合同。通过添加<code class="eh lw lx ly lz b">onlyCaptainsOrdersAllowed</code>确保只有机长在调用该功能。</p><p id="9252" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">确保<code class="eh lw lx ly lz b">emit</code>功能结束时的<em class="mj">成功</em>事件。</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="dc3d" class="me ku ht lz b fv mf mg l mh mi">function <strong class="lz hu">CaptainsResult</strong>(uint JobCounter, string Log2Result) external onlyCaptainsOrdersAllowed {<br/>  <em class="mj">// the return of the async call<br/>  </em>address sender = JobToSenderMap[JobCounter];<br/>  uint Points = <strong class="lz hu">StringToUint</strong>(Log2Result);</span><span id="3ca3" class="me ku ht lz b fv mk mg l mh mi">  PointsPerUser[sender] = Points;<br/>  emit <strong class="lz hu">GetPoints_Success</strong>(sender, Points);<br/>}</span></pre><p id="25f6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果队长无法调用您提交的代码(可能您的JavaScript代码中有一个错别字)，他将通过调用您合同中的<code class="eh lw lx ly lz b">CaptainsError</code>函数来通知您。</p><p id="9535" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">确保在函数结束时<code class="eh lw lx ly lz b">emit</code><em class="mj">失败</em>事件。</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="74aa" class="me ku ht lz b fv mf mg l mh mi">function <strong class="lz hu">CaptainsError</strong>(uint JobCounter, string ErrorMsg) external onlyCaptainsOrdersAllowed {<br/>   <em class="mj">// the return of the async call<br/>   </em>address sender = JobToSenderMap[JobCounter];<br/>   emit <strong class="lz hu">GetPoints_Failed</strong>(sender, ErrorMsg);<br/>}</span></pre><p id="7dc4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就是这样。</p></div><div class="ab cl ml mm hb mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hm hn ho hp hq"><p id="1ea0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">更新@<a class="ae jo" href="https://twitter.com/captainjs_v2" rel="noopener ugc nofollow" target="_blank">https://twitter.com/captainjs_v2</a></p><p id="2181" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">坚固性代码@<a class="ae jo" href="https://github.com/CaptainJavaScript/Solidity" rel="noopener ugc nofollow" target="_blank">https://github.com/CaptainJavaScript/Solidity</a></p><p id="e1fa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">客户端测试代码@<a class="ae jo" href="https://github.com/CaptainJavaScript/Seaman-Client" rel="noopener ugc nofollow" target="_blank">https://github.com/CaptainJavaScript/Seaman-Client</a></p></div><div class="ab cl ml mm hb mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hm hn ho hp hq"><p id="b662" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下面是完整的代码:</p><pre class="ke kf kg kh fq ma lz mb mc aw md dt"><span id="0494" class="me ku ht lz b fv mf mg l mh mi">pragma solidity ^0.4.25;</span><span id="6291" class="me ku ht lz b fv mk mg l mh mi">import "./usingCaptainJS_v2.sol";</span><span id="7391" class="me ku ht lz b fv mk mg l mh mi">contract <strong class="lz hu">AsyncPattern</strong> is usingCaptainJS {</span><span id="037f" class="me ku ht lz b fv mk mg l mh mi"><em class="mj">// to identify async calls<br/></em>uint JobCounter = 0;<br/>mapping (uint =&gt; address) JobToSenderMap;</span><span id="c5e9" class="me ku ht lz b fv mk mg l mh mi"><em class="mj">// demo use case: points per sender<br/></em>mapping (address =&gt; uint) PointsPerUser;</span><span id="fe39" class="me ku ht lz b fv mk mg l mh mi"><br/>event <strong class="lz hu">GetPoints_Success</strong>(address Sender, uint Points);<br/>event <strong class="lz hu">GetPoints_Pending</strong>(address Sender);<br/>event <strong class="lz hu">GetPoints_Failed</strong>(address Sender, string ErrorMsg);</span><span id="f1b6" class="me ku ht lz b fv mk mg l mh mi">function <strong class="lz hu">GetPoints</strong>() public payable {<br/> <em class="mj">// make sure to have enough gas for the async callback<br/> </em>uint GasRequired = DEFAULT_GAS_UNITS * tx.gasprice + 70 szabo;<br/> require(msg.value &gt;= GasRequired, "please send some extra gas...");</span><span id="9da7" class="me ku ht lz b fv mk mg l mh mi"><em class="mj"> // remember this call<br/> </em>JobToSenderMap[++JobCounter] = msg.sender;<br/> <em class="mj">// now do the math - but mix async + async...<br/> // every user has 256 points at the beginning and with every next<br/> // call it is log2 of his points<br/> </em>if(PointsPerUser[msg.sender] == 0) {<br/>   <em class="mj">// first call!<br/>   </em>PointsPerUser[msg.sender] = 256;<br/>   emit <strong class="lz hu">GetPoints_Success</strong>(msg.sender, 256);<br/> }<br/> else {<br/>   <em class="mj">// every other call<br/>   </em><strong class="lz hu">Run</strong>(<br/>    JobCounter, <strong class="lz hu">concat</strong>("math:log2(", <strong class="lz hu">uintToString</strong>(PointsPerUser[msg.sender]), ")"),<br/>    "", "", 1, DEFAULT_GAS_UNITS, tx.gasprice<br/>   );</span><span id="c7ec" class="me ku ht lz b fv mk mg l mh mi">   emit <strong class="lz hu">GetPoints_Pending</strong>(msg.sender);<br/>  }<br/> }</span><span id="e2b3" class="me ku ht lz b fv mk mg l mh mi"> function <strong class="lz hu">CaptainsResult</strong>(uint JobCounter, string Log2Result) external onlyCaptainsOrdersAllowed {<br/>  <em class="mj">// the return of the async call<br/>  </em>address sender = JobToSenderMap[JobCounter];<br/>  uint Points = <strong class="lz hu">StringToUint</strong>(Log2Result);<br/>  PointsPerUser[sender] = Points;<br/>  emit <strong class="lz hu">GetPoints_Success</strong>(sender, Points);<br/> }</span><span id="2e26" class="me ku ht lz b fv mk mg l mh mi"> function <strong class="lz hu">CaptainsError</strong>(uint JobCounter, string ErrorMsg) external onlyCaptainsOrdersAllowed {<br/>  <em class="mj">// the return of the async call<br/>  </em>address sender = JobToSenderMap[JobCounter];<br/>  emit <strong class="lz hu">GetPoints_Failed</strong>(sender, ErrorMsg);<br/> }</span><span id="d341" class="me ku ht lz b fv mk mg l mh mi">}</span></pre><blockquote class="ms"><p id="8ad6" class="mt mu ht bd mv mw mx my mz na nb jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="nd ne nf ng nh ki fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nc"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>