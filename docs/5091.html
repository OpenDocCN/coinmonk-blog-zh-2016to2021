<html>
<head>
<title>EIP712, a full-stack example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EIP712，全栈示例</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/eip712-a-full-stack-example-e12185b03d54?source=collection_archive---------0-----------------------#2021-08-01">https://medium.com/coinmonks/eip712-a-full-stack-example-e12185b03d54?source=collection_archive---------0-----------------------#2021-08-01</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="ba9f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我当时正在做一个需要使用EIP712的项目。GitHub中有许多文章和示例解释并展示了如何使用EIP712，但我很难理解它作为一个整体是如何工作的，以及前端代码和智能合约是如何关联的。这是EIP712的一个例子(不是解释)。有关解释和其他代码示例，请参见下面的链接部分。</p><h2 id="594f" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">先决条件和我使用的版本</h2><ol class=""><li id="ca56" class="kj kk ht is b it kl ix km jb kn jf ko jj kp jn kq kr ks kt dt translated">扎实的基础知识</li><li id="e238" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">国家预防机制7.19.1</li><li id="e65f" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">节点16.2.0</li><li id="fa07" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">元掩码9.8.4</li><li id="c2f8" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">块菌</li></ol><h2 id="6c58" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">EIP-712</h2><p id="7314" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">EIP-712是一种更高级、更安全的交易签名方法。使用此标准，不仅可以对交易进行签名并验证签名，还可以将数据与签名一起传递到智能合约中，并对照该数据验证签名，以了解签名者是否是实际发送了交易中要调用的数据的人。</p><p id="1da2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">EIP-712的实施可以在Uniswap V2 <a class="ae lc" href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L141" rel="noopener ugc nofollow" target="_blank">外围合同</a>中看到，该合同通过一个许可来移除流动性，该许可最终调用<a class="ae lc" href="https://github.com/Uniswap/uniswap-v2-core/blob/master/contracts/UniswapV2ERC20.sol#L81" rel="noopener ugc nofollow" target="_blank"> Uniswap V2核心</a>中的方法来完成此事。<br/>来自前端的签名被传递给外围设备中的方法，该签名用于代表使用核心设备中的方法的用户批准路由器合同。</p><h2 id="1608" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">示例编码</h2><p id="38e3" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">我们的示例将使用EIP-721提案来签署带有数据(地址、存储数据的值和截止日期)的事务，这些数据用于更改合同中变量的值。</p><p id="e901" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果签名和散列给出了签名者的地址，并且没有超过最后期限，则storedData的值被改变。</p><p id="0caa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一个无用的例子，但仍然理解这一点将确保您可以在其他地方使用这个标准。EIP-712的正确用法是创建一个ERC20许可证，就像uniswap团队所做的那样。</p><h2 id="6c59" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第一步</h2><p id="2c49" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">继续克隆松露的<a class="ae lc" href="https://www.trufflesuite.com/boxes/react" rel="noopener ugc nofollow" target="_blank">反应盒</a>。</p><p id="455b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们将简单地在这个回购中调整和添加所需的代码，以使EIP 712工作。</p><h2 id="7635" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第二步</h2><p id="9ada" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">数据是EIP 712最关键的部分。这些要签名的数据必须符合预定义的格式。它必须有一个EIP 712域和要签名的数据(在我们的示例中设置)。这两者的组合将被签署并发送到智能合同进行验证。</p><p id="dd4f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在EIP-712下签名的每个数据必须有一个EIP 712域和另一个数据。这两者的结构可以是任意的，但是在JS代码和SC代码上必须是相同的。</p><p id="2ec2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">EIP 712域的结构是使用该提议时被广泛接受的标准。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff ld"><img src="../Images/741f879591c12657dbfa0e66a34b13df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ec9WICucr8VY8jYvaov2sw.png"/></div></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">EIP-721 Data standard</figcaption></figure><p id="0286" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">EIP 712域具有指定哪个网络和哪个特定合同将用于验证签名的参数。具有相同代码的另一个合同将无法验证签名。</p><h2 id="faca" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第三步</h2><p id="0d61" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">让我们添加一个按钮，单击该按钮将弹出元掩码弹出窗口，使用eth_signTypedData_v3方法对数据进行签名。</p><p id="14f9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">做这件事的代码可以在这里看到<a class="ae lc" href="https://github.com/apurbapokharel/EIP712Example/blob/master/client/src/App.js#L46" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="5f1c" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第四步</h2><p id="4cb3" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">一旦使用eth_signTypedData_v3方法对上面定义的数据进行了签名，我们就可以获得签名，并将签名拆分为r、s和v部分，然后将其发送到智能合约，智能合约将对这些参数和数据哈希使用ercrecover来恢复签名者的公钥。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff lt"><img src="../Images/654170643c7d792dde9d1ed54a2dfbf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2E0De7s1FIZrE1QtB8iguw.png"/></div></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Splitting the signature</figcaption></figure><h2 id="ab49" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第五步</h2><p id="74ac" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">撰写智能合同。</p><p id="5f87" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就像JS代码一样，我们已经定义了包含EIPdomain的数据和要签名的数据，智能合约也需要两个变量来表示每个EIPdomain的散列数据和我们的数据(在这种情况下为set data)。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/f1c26700784653ec3385835f6fe7011b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*JYJ-_R-uHDLHa-p5_x6cAQ.png"/></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Using ercrecover</figcaption></figure><p id="6e12" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在UI端，我们对数据进行签名，并将r、s和v发送到智能合约。</p><p id="03d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">上面的代码做了两件事，首先是散列数据并生成它们的散列。接下来，它使用该数据的散列(在SC中称为hash)和签名，通过ercrecover方法生成签名者的公钥。</p><p id="f57e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">上面显示的数据的两个keccak散列应该类似于在out JS代码中定义的数据结构。如果这些不同，则无法恢复签名人的地址。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/75d91ac26f24e9cf1e816e9cdd24cddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*TjcXzu9p96dIhwQgyGmwvA.png"/></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Structure of our signed data</figcaption></figure><h2 id="9384" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第六步</h2><p id="5cd0" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">将infura中的助记符添加到truffle-config.js文件中(第3行)，并指定部署者的地址(第18行)。上面的例子使用了rinkeby testnet，但是任何测试都可以使用，参见truffle <a class="ae lc" href="https://www.trufflesuite.com/docs/truffle/reference/configuration" rel="noopener ugc nofollow" target="_blank">文档</a>部署到其他测试网。</p><p id="8707" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后部署合同。部署后，复制simplestorage的地址，并将其替换为verifyingContract下app.js中第76行的地址。默认情况下，它应该是0x 803 b 558 FD 23967 f 9d 37 bafe 2764329327 f 45 e 89 e，这是我的SimpleStorage.sol契约所在的地址。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/0079b9fe38f83ba2eb8d12f67b16e3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*_oRShkdSXJ7ju3AZILsx3g.png"/></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">Deployment snippet</figcaption></figure><h2 id="7282" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">第七步</h2><p id="d874" class="pw-post-body-paragraph iq ir ht is b it kl iv iw ix km iz ja jb kz jd je jf la jh ji jj lb jl jm jn hm dt translated">转到客户端目录并运行npm run start来启动react应用程序。</p><p id="ac31" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">按下“按下以签名”按钮，然后在元掩码弹出窗口上签署签名请求。接下来，确认交易以设置智能合约的值。</p><p id="2f62" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">交易完成后，刷新webapp以查看反映的更改。</p></div><div class="ab cl lx ly hb lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hm hn ho hp hq"><ol class=""><li id="c8cb" class="kj kk ht is b it iu ix iy jb me jf mf jj mg jn kq kr ks kt dt translated">Github链接到<a class="ae lc" href="https://github.com/apurbapokharel/EIP712Example" rel="noopener ugc nofollow" target="_blank">回购</a>。</li><li id="9f9c" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated"><a class="ae lc" rel="noopener" href="/metamask/eip712-is-coming-what-to-expect-and-how-to-use-it-bb92fd1a7a26">https://medium . com/meta mask/EIP 712-is-coming-what-to-expect-and-how-to-use-it-bb 92 FD 1a 7a 26</a></li><li id="457d" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated"><a class="ae lc" href="https://soliditydeveloper.com/ecrecover" rel="noopener ugc nofollow" target="_blank">https://soliditydeveloper.com/ecrecover</a></li><li id="c043" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">【https://docs.metamask.io/guide/signing-data.html T2】号</li><li id="21a0" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated">【https://github.com/danfinlay/js-eth-personal-sign-examples T4】</li><li id="8414" class="kj kk ht is b it ku ix kv jb kw jf kx jj ky jn kq kr ks kt dt translated"><a class="ae lc" href="https://github.com/ethereum/EIPs/tree/master/assets/eip-712" rel="noopener ugc nofollow" target="_blank">https://github.com/ethereum/EIPs/tree/master/assets/eip-712</a></li></ol></div></div>    
</body>
</html>