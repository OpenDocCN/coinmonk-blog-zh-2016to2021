<html>
<head>
<title>Get legendary items by breaking PNRG of MyCyptoChamp, an Ethereum online game (CVE-2018–12885)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过打破以太坊在线游戏MyCyptoChamp的PNRG获得传奇物品(CVE-2018–12885)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/get-legendary-items-by-breaking-pnrg-of-mycyptochamp-an-ethereum-online-game-cve-2018-12855-6e6beb41b8df?source=collection_archive---------9-----------------------#2018-07-31">https://medium.com/coinmonks/get-legendary-items-by-breaking-pnrg-of-mycyptochamp-an-ethereum-online-game-cve-2018-12855-6e6beb41b8df?source=collection_archive---------9-----------------------#2018-07-31</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><h1 id="6e9b" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">摘要</h1><p id="46f0" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">以太坊在线游戏<a class="ae km" href="https://mycryptochamp.io/" rel="noopener ugc nofollow" target="_blank"> MyCryptoChamp </a>有一个漏洞，它会生成可预测的随机数。在这个游戏中，用户可以通过支付一些以太来创建冠军和物品。这时，冠军和物品的力量是由随机数决定的。随机数由带有私有变量和块哈希为<code class="eh kn ko kp kq b">block.number-1</code>的<code class="eh kn ko kp kq b">keccak256()</code>函数生成。然而，它们都是公开的，所以攻击者可以很容易地访问它们并预先计算随机数。这个案例和我之前描述的一千个猜想<strong class="jq hu"><em class="kr"/></strong>的漏洞是如此的相似[1]。我利用MyCryptoChamp <strong class="jq hu"> </strong>利用内部事务，就像我利用1000 Guess一样。你可以在这篇文章中找到更详细的解释:“<a class="ae km" rel="noopener" href="/coinmonks/attack-on-pseudo-random-number-generator-prng-used-in-1000-guess-an-ethereum-lottery-game-7b76655f953d"> <em class="kr">攻击以太坊抽奖游戏1000 Guess中使用的伪随机数发生器(PRNG)。(CVE-2018–12454)</em></a>”。经过剥削，我得到了一个强大的冠军与三个传奇项目。</p><h1 id="40ba" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">细节</h1><p id="b548" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我之前提到过，这个漏洞类似于1000 Guess的漏洞。如果你不知道如何读取私有变量和如何利用内部事务，我推荐你阅读我的<a class="ae km" rel="noopener" href="/coinmonks/attack-on-pseudo-random-number-generator-prng-used-in-1000-guess-an-ethereum-lottery-game-7b76655f953d">上一篇文章【1】</a>。还有更多细节。</p><h2 id="f244" class="ks ir ht bd is kt ku kv iw kw kx ky ja jz kz la je kd lb lc ji kh ld le jm lf dt translated">易受攻击代码</h2><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff lg"><img src="../Images/9b37459dc824c21161ecb34266c7c2da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhJcJta38ZmtaokBuc2WWA.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Figure 1. MyCryptoChamp generates random numbers with a private variable and a blockhash</figcaption></figure><p id="fa22" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated"><code class="eh kn ko kp kq b">randMod</code>函数是MyCryptoChamp智能合约的易受攻击函数。它使用带有私有变量<code class="eh kn ko kp kq b">randNonce</code>和<code class="eh kn ko kp kq b">blockhash(block.number-1)</code>的<code class="eh kn ko kp kq b">keccak256</code>生成随机数。两者都是公开的，所以任何人都可以访问。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff mb"><img src="../Images/a35fb73042ebf40852fe7dfacb6c29ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kuf3W7_kPSkHXgdxEkJRbQ.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Figure 2. Part of createChamp() function which generates new champs</figcaption></figure><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff mc"><img src="../Images/30a5ace8bc93c7b11d288e47dd7fb4f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ttn5EVekQtUF6mkdyj_qSg.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Figure 3. Part of openLootbox() function which generates new items</figcaption></figure><p id="47e5" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">图2和图3显示MyCryptoChamp使用随机数生成champs和items。冠军/物品的威力取决于随机数。因此，如果攻击者可以预测随机数，他可以创建最强大的冠军和项目。</p><h2 id="5b05" class="ks ir ht bd is kt ku kv iw kw kx ky ja jz kz la je kd lb lc ji kh ld le jm lf dt translated">利用</h2><p id="1b25" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">利用MyCryptoChamp的方法很简单。攻击者通过使用<code class="eh kn ko kp kq b">randNonce</code>和<code class="eh kn ko kp kq b">blockhash(block.number-1)</code>预先计算随机数。当所需的随机数生成后，攻击者向MyCryptoChamp发送交易并获得champs/items。</p><p id="f982" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">先来了解一下<code class="eh kn ko kp kq b">randNonce</code>怎么走。我们可以这样读取私有变量[2]:</p><pre class="lh li lj lk fq md kq me mf aw mg dt"><span id="3732" class="ks ir ht kq b fv mh mi l mj mk">web3.eth.getStorageAt(contractAddress, position)</span></pre><p id="3813" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated"><code class="eh kn ko kp kq b">position</code>是变量的索引位置。我们可以使用上述方法检索智能合约中的所有存储变量。在MyCryptoChamp中，<code class="eh kn ko kp kq b">randNonce</code>位于槽11。因此，当<code class="eh kn ko kp kq b">contractAddress</code>为MyCryptoChamp智能合约的地址，<code class="eh kn ko kp kq b">position</code>为11时，我们可以得到<code class="eh kn ko kp kq b">randNonce</code>。</p><p id="3d53" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">现在，我们要做的就是找出<code class="eh kn ko kp kq b">blockhash(block.number-1)</code>。为了准确地知道它，我们应该知道包含我们发送的事务的块。如果我在块号<code class="eh kn ko kp kq b">N</code>发送一个事务，该事务将在块号<code class="eh kn ko kp kq b">N+a</code>执行，因为矿工选择和执行事务需要一些时间。然而，没有人确切地知道<code class="eh kn ko kp kq b">a</code>。因此，在我们发送事务之前，我们无法知道执行事务的块的块号。</p><p id="9f57" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">那么，我们如何得到<code class="eh kn ko kp kq b">blockhash(block.number-1)</code>并预计算随机数呢？。我们只能在智能合约中知道执行我们的事务的块的块号。因此，我们应该部署一个智能契约，并预先计算该契约中的随机数。此智能合约应满足以下条件:</p><ol class=""><li id="d350" class="ml mm ht jq b jr lw jv lx jz mn kd mo kh mp kl mq mr ms mt dt translated">以与目标合同相同的方式生成随机数</li><li id="e908" class="ml mm ht jq b jr mu jv mv jz mw kd mx kh my kl mq mr ms mt dt translated">如果目标协定生成攻击者想要的随机数，则向目标协定发送内部事务</li><li id="6703" class="ml mm ht jq b jr mu jv mv jz mw kd mx kh my kl mq mr ms mt dt translated">如果生成攻击者不想要的随机数，则恢复</li></ol><p id="c135" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">为了攻击MyCryptoChamp，攻击者需要满足上述条件的契约。由于3的条件，攻击者应该不断地发送交易，直到他们得到他们想要的随机数。所以消耗了一些气费。然而，在大多数情况下，这与他们攻击成功后获得的利益相比是微不足道的。</p><p id="ba53" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">为了利用MyCryptoChamp，我部署了以下契约:</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff mz"><img src="../Images/786ba7c83691ae06db4ca206c86ac2c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*faAtl9u_T-TFFRTYlYki6A.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Figure 4. The smart contract to exploit MyCryptoChamp</figcaption></figure><p id="6b1b" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">在<code class="eh kn ko kp kq b">createChp</code>函数中，第一个随机数代表攻击力，第二个随机数代表防御力。在<code class="eh kn ko kp kq b">createItm</code>函数中，第一个随机数表示物品的稀有度，第二个随机数表示物品类型。这两个函数在生成攻击者想要的随机数时都会调用MyCryptoChamp的函数。攻击契约中生成的随机数与MyCryptoChamp的契约中生成的随机数相同，因为两者是在同一个块中生成的。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div class="fe ff na"><img src="../Images/dc7d45880c42189537a047dfa4e831fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*AkBt1PBhvtsKIgomqlSdGQ.png"/></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Figure 5. Champ and items that I created by exploiting the vulnerability</figcaption></figure><p id="901d" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">图5。显示了我利用此漏洞创建的冠军和项目。我创造了强大的冠军和三个传奇物品。</p><h1 id="ef95" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">报告</h1><p id="58db" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">6月底我就上报给开发商了。令人惊讶的是，他们把我花在开发上的油费还给我了。</p><p id="5210" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">现在MyCryptoChamp被修补了。</p><ul class=""><li id="e43d" class="ml mm ht jq b jr lw jv lx jz mn kd mo kh mp kl nb mr ms mt dt translated">旧智能合约:<a class="ae km" href="https://etherscan.io/address/0xa44e464b13280340904ffef0a65b8a0033460430" rel="noopener ugc nofollow" target="_blank">https://ethers can . io/address/0xa 44 e 464 b 13280340904 ffef 0 a 65 b 8 a 0033460430</a></li><li id="03be" class="ml mm ht jq b jr mu jv mv jz mw kd mx kh my kl nb mr ms mt dt translated">新智能合约:<a class="ae km" href="https://etherscan.io/address/0x689FB61845488297dfE7586E5f7956475955d2Dc" rel="noopener ugc nofollow" target="_blank">https://ethers can . io/address/0x 689 FB 61845488297 dfe 7586 e5f 7956475955 D2 DC</a></li></ul><p id="b2ff" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">他们拿走了我的冠军和三件传奇物品。实际上，我找不到新智能合约的源代码，所以我不确定它现在是否安全。</p><h1 id="982e" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">结论</h1><p id="b0fa" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在以太坊智能合约中生成随机数并不容易。使用私有变量和过去块的块变量是不安全的。如果你想了解更多的细节，我推荐你阅读我以前的文章[1]。如果有智能合约生成随机数，你应该检查它是完全随机的。</p><h1 id="3e9d" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">参考</h1><p id="1699" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">[1]<a class="ae km" rel="noopener" href="/coinmonks/attack-on-pseudo-random-number-generator-prng-used-in-1000-guess-an-ethereum-lottery-game-7b76655f953d">https://medium . com/coin monks/attack-on-pseudo-random-number-generator-prng-used-in-1000-guess-an-ether eum-lottery-game-7b 76655 f953 d</a></p><p id="a22c" class="pw-post-body-paragraph jo jp ht jq b jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ma kj kk kl hm dt translated">[2]<a class="ae km" href="https://web3js.readthedocs.io/en/1.0/web3-eth.html#getstorageat" rel="noopener ugc nofollow" target="_blank">https://web 3js . readthe docs . io/en/1.0/web 3-eth . html # get storage at</a></p><blockquote class="nc"><p id="5bf0" class="nd ne ht bd nf ng nh ni nj nk nl kl ek translated"><a class="ae km" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="nm nn no np nq ll fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff na"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>