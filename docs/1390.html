<html>
<head>
<title>EOS Contracts — Deploying and Using Contracts without On-Chain ABI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EOS合同—部署和使用没有链上ABI的合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/eos-contracts-deploying-and-using-contracts-without-on-chain-abi-1bf48f145838?source=collection_archive---------5-----------------------#2018-08-24">https://medium.com/coinmonks/eos-contracts-deploying-and-using-contracts-without-on-chain-abi-1bf48f145838?source=collection_archive---------5-----------------------#2018-08-24</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/761cf122f9e525fb9f3bc37d9a0d4fc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eeMJrwIyX5aTh9QZQO6vog.jpeg"/></div></div></figure><p id="20ce" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果你是一个聪明的合同开发者，那么你至少应该听说过ABI。<strong class="jd hu"> ABI </strong>代表<em class="jz">应用二进制接口</em>，用于将人类可读的数据格式(即JSON)转换为普通的二进制格式，以获得最大效率。</p><p id="ee1e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">回到以太坊，ABI是离线出版发行的。例如，<a class="ae ka" href="https://etherscan.io" rel="noopener ugc nofollow" target="_blank"> Etherscan </a>为经过验证的合同提供ABIs，这样用户就可以很容易地与它们进行交互。</p><p id="6b8d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">认识到ABI的重要性，EOS决定把它放在链上。例如，以下是系统合同<code class="eh kb kc kd ke b">eosio.token</code>的ABI摘录:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="4561" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">从ABI中我们可以了解到，动作<code class="eh kb kc kd ke b">transfer</code>使用的参数类型为<code class="eh kb kc kd ke b">transfer</code>，包含4个字段:<code class="eh kb kc kd ke b">from</code>、<code class="eh kb kc kd ke b">to</code>、<code class="eh kb kc kd ke b">quantity</code>和<code class="eh kb kc kd ke b">memo</code>。这样，当用户调用契约接口时，前端软件可以根据ABI中包含的信息序列化用户提供的参数。</p><p id="f1c5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事实上，每当您使用<code class="eh kb kc kd ke b">eosjs</code>进行契约交互时，它总是首先发出一个<code class="eh kb kc kd ke b">get_abi</code>请求，然后是实际的<code class="eh kb kc kd ke b">push_transaction</code>请求。</p><p id="d0fa" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然而，虽然在链上使用ABI很方便，但是这种机制也带来了不希望的副作用。对于私人合同，我们希望发布的信息越少越好，发布ABI绝对不是最好的方式。</p><p id="9db9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="jz">注意，你仍然可以不使用ABI(即反编译)来破译一个编译好的契约，但是ABI的发布使这变得容易多了。</em></p><p id="37f8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">因此，我将介绍一种只发布契约代码，并且仍然能够与之交互的方法。</p></div><div class="ab cl kl km hb kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hm hn ho hp hq"><h1 id="4b2e" class="ks kt ht bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">部署合同</h1><p id="0d6c" class="pw-post-body-paragraph jb jc ht jd b je lq jg jh ji lr jk jl jm ls jo jp jq lt js jt ju lu jw jx jy hm dt translated">默认情况下，使用命令<code class="eh kb kc kd ke b">cleos set contract</code>发布合同会将ABI文件与合同一起发布。没有办法改变这种行为，如<code class="eh kb kc kd ke b">cleos</code>源代码所示:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="ddb6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这就是为什么我们使用官方JS库用于EOS的原因。</p><p id="ac11" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">关于使用该库的基本说明，请参考GitHub官方文档以获得帮助。我假设你已经成功地创建了一个工作的<code class="eh kb kc kd ke b">eos</code>对象。</p><p id="4b1c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">首先，阅读已编译的合同文件:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="c8d4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然后，在部署代码时只调用<code class="eh kb kc kd ke b">setcode</code>:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="cacb" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">正如您将看到的，该合同在没有上传ABI的情况下成功部署。</p></div><div class="ab cl kl km hb kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hm hn ho hp hq"><h1 id="cabe" class="ks kt ht bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">援引合同</h1><p id="a0b8" class="pw-post-body-paragraph jb jc ht jd b je lq jg jh ji lr jk jl jm ls jo jp jq lt js jt ju lu jw jx jy hm dt translated">但是，该合同不能立即使用。当我们使用<code class="eh kb kc kd ke b">eos.transaction</code>与合同交互时，会抛出一个错误，因为没有可用的ABI信息。我们可以使用以下命令在本地加载ABI:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="9649" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然而交易还是会失败！这是因为在进行交易之前，<code class="eh kb kc kd ke b">eos</code>会自动触发一个<code class="eh kb kc kd ke b">get_abi</code>请求并覆盖本地版本。为了有效地缓存ABI，我们需要一个不能访问区块链的<code class="eh kb kc kd ke b">eos</code>对象。</p><p id="5b1e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">但是另一个问题来了。每个EOS交易都有一个标题，只能从区块链自动获取。如果我们只是创建一个断开的<code class="eh kb kc kd ke b">eos</code>对象，它甚至不能构造事务。</p><p id="3a3f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">幸运的是，我们可以首先从普通的<code class="eh kb kc kd ke b">eos</code>对象中获取头，将其传递给新的对象<code class="eh kb kc kd ke b">coldEos</code>，在<code class="eh kb kc kd ke b">coldEos</code>中缓存ABI，使用<code class="eh kb kc kd ke b">coldEos</code>进行事务生成和签名，最后，再次使用<code class="eh kb kc kd ke b">eos</code>将签名的事务推送到网络上。</p><p id="92f1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们首先需要定义一个获取事务头的函数:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="f35b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然后，我们可以创建一个<code class="eh kb kc kd ke b">coldEos</code>对象，并用它来签署事务。我们将调用一个名为<code class="eh kb kc kd ke b">myaction</code>的契约接口，并将一个字符串作为参数:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure><p id="b586" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">最后，我们用<code class="eh kb kc kd ke b">eos</code>对象广播签名的事务:</p><figure class="kf kg kh ki fq iu"><div class="bz el l di"><div class="kj kk l"/></div></figure></div><div class="ab cl kl km hb kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hm hn ho hp hq"><p id="ae87" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">整个过程有点复杂，但我们最终设法部署了一个没有ABI的合同，并成功地与它进行了交互。</p><p id="9ea4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">请在Medium上关注我，了解更多关于区块链和智能合约的信息！</p><blockquote class="lv"><p id="3e75" class="lw lx ht bd ly lz ma mb mc md me jy ek translated"><a class="ae ka" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mg mh mi mj mk iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mf"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>