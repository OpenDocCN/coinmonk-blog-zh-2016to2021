<html>
<head>
<title>Smart Contract Exploits Part 4 — Featuring Capture the Ether (Miscellaneous)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">智能合约利用第4部分—以捕获以太为特色(杂项)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/smart-contract-exploits-part-4-featuring-capture-the-ether-miscellaneous-232df82a559f?source=collection_archive---------4-----------------------#2018-09-23">https://medium.com/coinmonks/smart-contract-exploits-part-4-featuring-capture-the-ether-miscellaneous-232df82a559f?source=collection_archive---------4-----------------------#2018-09-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="1d6f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第四部分也是最后一部分——杂项下的两个挑战，这些挑战似乎在其他部分找不到归宿。让我们马上进入它。</p><p id="0085" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于错过第一部分的人:<a class="ae jo" rel="noopener" href="/@Enigmatic1256/smart-contract-exploits-part-1-featuring-capture-the-ether-lotteries-8a061ad491b?source=your_stories_page---------------------------">https://medium . com/@ enigmatic 1256/smart-contract-exploits-part-1-featured-capture-the-ether-lotteries-8a 061 ad 491 b</a></p><p id="a600" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">而第二部分在这里找到:<a class="ae jo" rel="noopener" href="/@Enigmatic1256/smart-contract-exploits-part-2-featuring-capture-the-ether-math-31a289da0427">https://medium . com/@ enigmatic 1256/smart-contract-exploits-part-2-featured-capture-the-ether-math-31a 289 da 0427</a></p><p id="a854" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">而第三部分在这里找到:<a class="ae jo" rel="noopener" href="/@Enigmatic1256/smart-contract-exploits-part-3-featuring-capture-the-ether-accounts-c86d7e9a1400">https://medium . com/@ enigmatic 1256/smart-contract-exploits-part-3-featured-capture-the-ether-accounts-c 86d 7 e 9 a 1400</a></p><p id="e66c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可以找到这些挑战的网站:<a class="ae jo" href="https://capturetheether.com/challenges/" rel="noopener ugc nofollow" target="_blank">https://capturetheether.com/challenges/</a><br/>这些挑战的作者是非常聪明的smarx，抓住他的推特账号@smarx。</p><p id="99c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">和以前一样，这篇文章需要一些关于Solidity及其相关开发工具的知识。</p><p id="7cfc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">事不宜迟——前方有巨大的剧透！</p><h1 id="e0b4" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">16.承担所有权</h1><p id="0624" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">源代码如下。</p><figure class="ks kt ku kv fq kw"><div class="bz el l di"><div class="kx ky l"/></div></figure><p id="9ff9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个问题相当于免费的300分；然而，其含义可能是严重的，这被用作在野外的实际利用。</p><p id="9aca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">看看契约本身，我们可以假设函数<code class="eh kz la lb lc b"><em class="ld">AssumeOwmershipChallenge()</em></code>是契约的构造函数。然而，由于拼写错误，这变成了一个普通的可调用函数，允许我们将所有者设置为我们的调用地址并赢得挑战。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff le"><img src="../Images/d8a8a2e03c130efd1d63ccade5246e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xIGcgiHu0OI96ZQn.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">How it looks like when deployed on Remix.</figcaption></figure><p id="cc79" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从Solidity v0.4.22开始，我们现在可以用<code class="eh kz la lb lc b"><em class="ld">constructor(arg1, arg2…)</em></code>定义我们的构造函数，这允许构造函数脱颖而出，也避免了这种性质的利用。</p><p id="dbb6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，要赢得这个挑战，我们只需要将代码复制到Remix中，指向部署的契约地址，调用函数<code class="eh kz la lb lc b"><em class="ld">AssumeOwmershipChallenge()</em></code>，然后调用<code class="eh kz la lb lc b"><em class="ld">authenticate()</em></code>。</p><h1 id="6c38" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">17.代币银行</h1><p id="0f13" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">源代码如下。</p><figure class="ks kt ku kv fq kw"><div class="bz el l di"><div class="kx ky l"/></div></figure><p id="23cc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">代码太多了。基本上，这个想法是，这个合同作为一个“银行”，跟踪我们的银行余额，并发布反映持有令牌数量的余额，其中500，000将由我们持有，另外500，000将由部署捕获以太挑战的代理合同持有。1000000个ERC223令牌在作为令牌库部署时全部由挑战合同持有，正如创建ERC223合同时注意到的那样，它将总供应量分配给<code class="eh kz la lb lc b"><em class="ld">msg.sender</em></code>。我们能够根据银行余额提取分配给我们的令牌数，该漏洞要求我们从银行提取所有1，000，000个ERC223令牌。</p><p id="7f66" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过查看合同，我们可以看到一个撤销功能，大概是我们会以某种方式利用的一个功能，并且似乎我们可以，假设余额仅在<code class="eh kz la lb lc b"><em class="ld">token.transfer</em></code>行之后扣除，并且有一个我们可以使用的<code class="eh kz la lb lc b"><em class="ld">tokenFallback</em></code>接口。我们可以使用漏洞利用契约来模拟我们的漏洞利用，其中<code class="eh kz la lb lc b"><em class="ld">tokenFallback</em></code>接口将触发我们的漏洞利用契约上的相同功能，该功能执行第二次撤销，所有这些都不会因为发生<code class="eh kz la lb lc b"><em class="ld">require(balanceOf[msg.sender] &gt;= amount)</em></code>余额检查而减少余额。事实上，这与2016年导致道关闭的重返攻击性质相似。</p><p id="699b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们已经有了入侵入口，我们需要做的是弄清楚如何进行完整的设置和序列来执行重新进入攻击，这需要一个银行余额作为先决条件。</p><p id="aafb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了在我们的开发合同上获得一些银行余额，我们可以执行下面的序列:</p><ol class=""><li id="2c37" class="lp lq ht is b it iu ix iy jb lr jf ls jj lt jn lu lv lw lx dt translated">从代币银行提取我们的500，000 ERC223代币。</li><li id="7bb7" class="lp lq ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">创建并部署实现tokenFallback()函数的漏洞利用合同，该函数在第一次调用时不做任何事情，因此我们可以将当前拥有的令牌转移到该漏洞利用合同。</li><li id="d98d" class="lp lq ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">从利用合同中，将令牌转移回令牌库。这触发了令牌银行的tokenFallback()函数，为我们的漏洞利用合同提供了500，000银行余额。</li></ol><p id="f2f0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们可以执行实际的利用:</p><ol class=""><li id="0a1b" class="lp lq ht is b it iu ix iy jb lr jf ls jj lt jn lu lv lw lx dt translated">我们的漏洞利用合同调用500，000个令牌的retract()，这调用了我们的漏洞利用合同的tokenFallback()函数。</li><li id="fa63" class="lp lq ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">我们的漏洞利用契约的tokenFallback()再次调用500，000个令牌的contract()。并且在第三次重新进入时不做任何事情。</li><li id="dce2" class="lp lq ht is b it ly ix lz jb ma jf mb jj mc jn lu lv lw lx dt translated">由于只有在令牌转移之后才扣除银行余额，因此重新进入将成功执行。(余额将溢出，但现在挑战已经完成)</li></ol><p id="193c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">拼凑代码:</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff md"><img src="../Images/d5aa8cd0b5d7f0243b022d63fa4477b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TUNo-uirWL2YgE74.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Our exploit contract.</figcaption></figure><p id="7b90" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们将手动设置步骤1和2，这可以很容易地通过混音完成。步骤3可以通过<code class="eh kz la lb lc b"><em class="ld">transferToTokenBank()</em></code>功能完成。完成设置后，我们只需要调用<code class="eh kz la lb lc b"><em class="ld">execute()</em></code>来运行漏洞攻击。</p><p id="ee91" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">运行步骤:</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff me"><img src="../Images/02cd676cbfe97afadebe0b4f69feb66f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iJIAAAjwnfcqLMCB.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Step 1, withdrawing tokens.</figcaption></figure><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff me"><img src="../Images/bf41b526b0a39cb84b82b5bdc9d900d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_ZrxiIbdvbOxnvXy.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Step 2, transferring all 500,000 ERC223 tokens to our exploit contract.</figcaption></figure><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff me"><img src="../Images/7f6b4f9b97559fb1b1a7969b769fb131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3coweICiM7xesPmr.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Step 3, execute transferToTokenBank() so our exploit contract gets loaded with a balance.</figcaption></figure><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff mf"><img src="../Images/c1d21161e6657adb9f07fbebcdc5549a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*co3-x_kChrOzW39V.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Our exploit contract now has some bank balance to execute to re-entrance attack.</figcaption></figure><p id="6289" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦我们用令牌库挑战契约地址初始化CodeToCall对象，我们就准备好实施我们的利用。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff mg"><img src="../Images/05e2fe4a24f53cfc75b006c24e0063d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*73N28SnSrKe4ImxY.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">Execute exploit — Note how <code class="eh kz la lb lc b"><em class="mh">Transfer()</em></code> was ran twice.</figcaption></figure><p id="71d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可能会怀疑这一点，因为由于我们扣除了比我们实际拥有的更多的余额，我们的余额将会溢出。此时，isComplete将被设置为true，从而完成这个挑战。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff mi"><img src="../Images/a4d473c2aeb23faae8eebf474eecc3e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uf-1HK4zrr0rvczn.png"/></div></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">We are done!</figcaption></figure><h1 id="2c3d" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">结论</h1><p id="d442" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">这是这个多部分系列的第四部分，也是最后一部分。公共区块链处理实值，在设计和构建直接访问实值的软件时应该格外小心。虽然这些漏洞中的一些可以在语言层上避免，例如具有健壮的边界检查和设置递归调用的限制，但我个人发现这些漏洞中的许多并不完全是由于可靠性本身，而且基于区块链的构建往往需要不同的直觉，因此需要不同的方法。</p><p id="1143" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，继续入侵，打破东西，并审查智能合同如何对不同的实现做出反应。我们可以努力为每个人开发更安全可靠的智能合同。</p><blockquote class="mj"><p id="0eab" class="mk ml ht bd mm mn mo mp mq mr ms jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mu mv mw mx my kw fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mt"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>