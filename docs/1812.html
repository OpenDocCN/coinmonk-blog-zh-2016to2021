<html>
<head>
<title>Deploying EOS contracts using EOS.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EOS.js部署EOS合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/setcode-and-setabi-with-eos-js-dd83480ba234?source=collection_archive---------4-----------------------#2018-11-21">https://medium.com/coinmonks/setcode-and-setabi-with-eos-js-dd83480ba234?source=collection_archive---------4-----------------------#2018-11-21</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><figure class="hs ht fm fo hu hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff hr"><img src="../Images/b86269594d49333baee67e8e46ad530c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*brXTn0EYt04N6js4.png"/></div></div></figure><div class=""/><p id="323e" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这篇文章是关于使用<a class="ae jz" href="https://github.com/EOSIO/eosjs" rel="noopener ugc nofollow" target="_blank"> eosjs </a>从JavaScript前端或节点后端以编程方式部署智能合约代码及其ABI的。</p><p id="db94" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><code class="eh ka kb kc kd b">eosio</code>系统契约的<code class="eh ka kb kc kd b">setcode</code>动作接受<code class="eh ka kb kc kd b">.wasm</code>文件作为十六进制字符串。要部署<em class="ke">代码</em>，我们需要做的就是将<code class="eh ka kb kc kd b">.wasm</code>文件转换成十六进制字符串，然后调用动作。更困难的是调用<code class="eh ka kb kc kd b">setabi</code>函数，因为它需要一个ABI的<strong class="jd if">打包二进制</strong>表示。为此，我们需要<a class="ae jz" href="https://github.com/EOSIO/eosjs/issues/421" rel="noopener ugc nofollow" target="_blank">连载ABI </a>。</p><p id="6e8b" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下面是使用<code class="eh ka kb kc kd b">eosjs &gt;= 20.0.0</code>的工作代码:</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="9a1d" class="kn ko ie kd b fv kp kq l kr ks">const fs = require(`fs`)<br/>const path = require(`path`)<br/>const { Serialize } = require(`eosjs`)<br/>const { api } = require(`../config`)<br/><br/>function getDeployableFilesFromDir(dir) {<br/>  const dirCont = fs.readdirSync(dir)<br/>  const wasmFileName = dirCont.find(filePath =&gt; filePath.match(/.*\.(wasm)$/gi))<br/>  const abiFileName = dirCont.find(filePath =&gt; filePath.match(/.*\.(abi)$/gi))<br/>  if (!wasmFileName) throw new Error(`Cannot find a ".wasm file" in ${dir}`)<br/>  if (!abiFileName) throw new Error(`Cannot find an ".abi file" in ${dir}`)<br/>  return {<br/>    wasmPath: path.join(dir, wasmFileName),<br/>    abiPath: path.join(dir, abiFileName),<br/>  }<br/>}<br/><br/>async function deployContract({ account, contractDir }) {<br/>  const { wasmPath, abiPath } = getDeployableFilesFromDir(contractDir)<br/><br/>  // 1. Prepare SETCODE<br/>  // read the file and make a hex string out of it<br/>  const wasm = fs.readFileSync(wasmPath).toString(`hex`)<br/><br/>  // 2. Prepare SETABI<br/>  const buffer = new Serialize.SerialBuffer({<br/>    textEncoder: api.textEncoder,<br/>    textDecoder: api.textDecoder,<br/>  })<br/><br/>  let abi = JSON.parse(fs.readFileSync(abiPath, `utf8`))<br/>  const abiDefinition = api.abiTypes.get(`abi_def`)<br/>  // need to make sure abi has every field in abiDefinition.fields<br/>  // otherwise serialize throws<br/>  abi = abiDefinition.fields.reduce(<br/>    (acc, { name: fieldName }) =&gt;<br/>      Object.assign(acc, { [fieldName]: acc[fieldName] || [] }),<br/>    abi<br/>  )<br/>  abiDefinition.serialize(buffer, abi)<br/><br/>  // 3. Send transaction with both setcode and setabi actions<br/>  const result = await api.transact(<br/>    {<br/>      actions: [<br/>        {<br/>          account: 'eosio',<br/>          name: 'setcode',<br/>          authorization: [<br/>            {<br/>              actor: account,<br/>              permission: 'active',<br/>            },<br/>          ],<br/>          data: {<br/>            account: account,<br/>            vmtype: 0,<br/>            vmversion: 0,<br/>            code: wasm,<br/>          },<br/>        },<br/>        {<br/>          account: 'eosio',<br/>          name: 'setabi',<br/>          authorization: [<br/>            {<br/>              actor: account,<br/>              permission: 'active',<br/>            },<br/>          ],<br/>          data: {<br/>            account: account,<br/>            abi: Buffer.from(buffer.asUint8Array()).toString(`hex`),<br/>          },<br/>        },<br/>      ],<br/>    },<br/>    {<br/>      blocksBehind: 3,<br/>      expireSeconds: 30,<br/>    }<br/>  )<br/>}</span></pre><p id="485c" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">请注意，在将JS ABI对象转换为原始ABI时，我们如何利用eosjs的<code class="eh ka kb kc kd b">api</code>对象的一些内部字段，如<code class="eh ka kb kc kd b">api.abiTypes.get(`abi_def`)</code>。下面是如何在<code class="eh ka kb kc kd b">eosjs</code>中创建<code class="eh ka kb kc kd b">api</code>对象并为本地EOS网络进行配置的:</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="bcf1" class="kn ko ie kd b fv kp kq l kr ks">// config.js<br/>const { Api, JsonRpc, JsSignatureProvider } = require(`eosjs`)<br/>const fetch = require(`node-fetch`) // node only; not needed in browsers<br/>const { TextEncoder, TextDecoder } = require(`util`) // node only; native TextEncoder/Decoder<br/><br/>const signatureProvider = new JsSignatureProvider([<br/>    `5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3`,<br/>    /* other private keys for your contract account */,<br/>])<br/>const rpc = new JsonRpc(`http://127.0.0.1:7777`, { fetch })<br/>const api = new Api({<br/>    rpc,<br/>    signatureProvider,<br/>    textDecoder: new TextDecoder(),<br/>    textEncoder: new TextEncoder(),<br/>})<br/><br/><br/>module.exports = {<br/>    api,<br/>}</span></pre><p id="6c94" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，您只需要用合同帐户名调用<code class="eh ka kb kc kd b">deployContract</code>函数，并配置<code class="eh ka kb kc kd b">signatureProvider</code>以包含该帐户的私有密钥用于<code class="eh ka kb kc kd b">active</code>权限:</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="8a23" class="kn ko ie kd b fv kp kq l kr ks">deployContract({ account: `test`, contractDir: `./contract` })</span></pre></div><div class="ab cl kt ku hb kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hm hn ho hp hq"><p id="df27" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">最初发表于<a class="ae jz" href="https://cmichel.io/setcode-and-setabi-with-eos-js/" rel="noopener ugc nofollow" target="_blank"> cmichel.io </a></p><blockquote class="la"><p id="1274" class="lb lc ie bd ld le lf lg lh li lj jy ek translated"><a class="ae jz" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="ll lm ln lo lp hv fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lk"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>