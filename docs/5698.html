<html>
<head>
<title>Dex contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Dex合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/dex-contracts-20e11ed52ef7?source=collection_archive---------9-----------------------#2021-10-12">https://medium.com/coinmonks/dex-contracts-20e11ed52ef7?source=collection_archive---------9-----------------------#2021-10-12</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="95a7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">NFT分数分散式交易所不实施AMM(自动做市商)模式。它使用旧的订单簿模型，这意味着它登记交易者的订单，并将它们相互匹配。与AMM模型相比，这显然是低效的，但实现起来更简单。交易所可以处理限价单和市价单。限价单被设置为以给定的价格执行，而市价单独立于实际价格立即与最佳价格匹配。你可以在这里阅读更长的解释<a class="ae jo" href="https://www.investopedia.com/ask/answers/100314/whats-difference-between-market-order-and-limit-order.asp" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="4f29" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看Dex合同组:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/403eb486871572325bd4f83a64fec6ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*m8RW7XPR_1XPqIihd6VuRg.jpeg"/></div></figure><p id="9593" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基础契约跟踪必要的数据结构:</p><ul class=""><li id="af1b" class="jx jy ht is b it iu ix iy jb jz jf ka jj kb jn kc kd ke kf dt translated">交易员的ETH余额</li><li id="e1b4" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">交易商的ETH保留余额，保存每个交易商订单中当前保留的总ETH金额</li><li id="1eb7" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">包含代表单个订单的订单结构的订单簿。订单分为两类:购买订单和销售订单。</li><li id="90d8" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">保留股份，保留每个NFT和所有者的订单中保留的股份数量</li></ul><p id="b757" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">注:ETH在基础合约中被称为对销货币。这是因为契约被部署到EVM兼容链(BSC和Polygon)中，所以ETH被作为BSC和Matic的抽象来处理。</p><p id="a8df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基础合同的功能:</p><ul class=""><li id="1199" class="jx jy ht is b it iu ix iy jb jz jf ka jj kb jn kc kd ke kf dt translated">存取款:办理柜台交易货币的存取款</li><li id="a48e" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">创建限价单:顾名思义，它在订单簿中创建限价单。它按照以下方式组织订单簿:<br/> -购买订单按照价格降序排列。<br/> -同时，卖单按价格升序排列。<br/>这就像我们在传统交易所看到的订单一样。它有助于市场订单匹配机制。</li><li id="a26f" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">创建市价单:它创建市价单并自动匹配最佳限价单。实际上，市价单甚至没有登记在订单簿中，它只是根据限价单进行匹配和执行。</li></ul><p id="d585" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">与真实交换相比，有两个简化:</p><ul class=""><li id="7703" class="jx jy ht is b it iu ix iy jb jz jf ka jj kb jn kc kd ke kf dt translated">限价单不相互匹配，只有市价单与限价单匹配。</li><li id="049f" class="jx jy ht is b it kg ix kh jb ki jf kj jj kk jn kc kd ke kf dt translated">在将市价订单与限价订单进行匹配后，市价订单中剩余的未履行部分将会丢失。这意味着它没有在订单簿中登记，因为订单簿当前仅包含限价订单。</li></ul><p id="c527" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这两个限制阻止了该模型在任何实际应用中的使用，但是为了学习体验，使得该模型更容易实现。</p><p id="e5d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">合约中最复杂的部分是市价单的创建和限价单的匹配。让我们把它分解成几个要点:</p><p id="001f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">1.匹配算法在有订单要匹配且市场订单有剩余部分要匹配时执行:</p><pre class="jq jr js jt fq kl km kn ko aw kp dt"><span id="a0ef" class="kq kr ht km b fv ks kt l ku kv">while (i &lt; orders.length &amp;&amp; remaining &gt; 0)</span></pre><p id="bb5c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2.基于限价单的可用部分和市价单的剩余部分，可以计算匹配金额:</p><pre class="jq jr js jt fq kl km kn ko aw kp dt"><span id="4171" class="kq kr ht km b fv ks kt l ku kv">uint256 available = orders[i].amount — orders[i].filled;<br/>uint256 matched = (remaining &gt; available) ? available : remaining;<br/>remaining = remaining — matched;</span></pre><p id="6abd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">3.在保持平衡和转移柜台交易货币方面，买卖订单是有区别的。通过销售订单执行的例子可以理解一般的想法:</p><pre class="jq jr js jt fq kl km kn ko aw kp dt"><span id="36ec" class="kq kr ht km b fv ks kt l ku kv">nftFractionsRepository.transferFrom(<br/> msg.sender,<br/> orders[i].trader,<br/> tokenId,<br/> matched,<br/> “”<br/> );<br/>ethBalance[msg.sender] += orders[i].price * matched;<br/>ethBalance[orders[i].trader] -= orders[i].price * matched;<br/>ethReservedBalance[orders[i].trader] -= orders[i].price * matched;</span></pre><p id="b356" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">4.当匹配算法结束时，有一个维护任务。订单簿必须从完全执行的订单中清除。由于数组的元素只能在Solidity中弹出(只能删除最后一个元素)，我们必须重新排列顺序簿，以在末尾包含完全执行的元素并弹出它们:</p><pre class="jq jr js jt fq kl km kn ko aw kp dt"><span id="8bb3" class="kq kr ht km b fv ks kt l ku kv">while (i &lt; orders.length &amp;&amp; orders[i].filled == orders[i].amount) {<br/> _onOrderRemoval(orders[i].id);<br/> for (uint256 j = i; j &lt; orders.length — 1; j++) {<br/> orders[j] = orders[j + 1];<br/> }<br/> orders.pop();<br/> i++;<br/>}</span></pre><p id="83bf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基础契约还定义了挂钩函数，以在执行的适当点挂钩逻辑:<br/> -订单上插(插入/更新)<br/> -订单移除<br/> -交易执行<br/>-ETH余额变化<br/>-ETH预留余额变化<br/> -股份预留余额变化</p><p id="16d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这些钩子只在Dex契约的Polygon版本中实现:MaticDex <br/>它发出相应的事件来被图形捕获:<br/>-OrderUpsert<br/>-order removal<br/>-new trade<br/>-EthBalanceChange<br/>-EthReservedBalanceChange<br/>-shares reservedbalancechange</p><p id="c064" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">相比之下，Dex契约的BSC版本公开了内部数据结构的getter函数:<br/> -获取订单<br/> -获取ETH余额<br/> -获取ETH预留余额<br/> -获取股份预留余额<br/>它们服务于订单显示和执行UI的数据需求。</p><p id="9699" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在下一节中，我们将详细介绍<a class="ae jo" rel="noopener" href="/@szmizorsz/the-bridge-82608dfcf5a2">桥</a>。</p><p id="c127" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你想阅读本系列的其他文章，你可以在<a class="ae jo" rel="noopener" href="/@szmizorsz/nft-fractions-decentralised-exchange-introduction-3e696f27c065">主要文章</a>中找到链接。</p><p id="6d4b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">或者如果你想看我的其他项目和贡献:</p><p id="12e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae jo" href="https://www.szabolcsszentes.com/" rel="noopener ugc nofollow" target="_blank">https://www.szabolcsszentes.com/</a></p><blockquote class="kw"><p id="fae8" class="kx ky ht bd kz la lb lc ld le lf jn ek translated">加入Coinmonks <a class="ae jo" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jo" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h2 id="6048" class="kq kr ht bd lg lh li lj lk ll lm ln lo jb lp lq lr jf ls lt lu jj lv lw lx ly dt translated">也阅读</h2><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/leveraged-token-3f5257808b22"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">杠杆代币[多头代币]终极指南</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">杠杆化令牌是具有杠杆化风险敞口的ERC20令牌，不考虑保证金、要求、管理…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/crypto-exchange" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">最佳加密交易所| 2021年十大加密货币交易所</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">加密货币交易所的加密交易需要了解市场，这可以帮助你获得利润。之前…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="mr l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/best-swap-platforms" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">2021年最佳加密交换平台| CoinCodeCap</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">如果我们看看今天的场景，许多加密货币交换平台提供了广泛的功能和深度…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="ms l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">2021年最佳加密借贷平台| 6大比特币借贷平台</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">获得比特币和其他加密货币的最佳贷款利率</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="mt l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">2021年最佳免费加密交易机器人</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">2021年币安、比特币基地、库币和其他密码交易所的最佳密码交易机器人。四进制，位间隙…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="mu l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/best-crypto-signals-telegram-5785cdbc4b2b"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">最佳4个加密交易信号电报通道</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">这是乏味的找到正确的加密交易信号提供商。因此，在本文中，我们将讨论最好的…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="mv l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/bitsgap-review" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">获取信号、交易机器人和套利</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">在本文中，我们将回顾Bitsgap，这是一个满足您所有交易需求的一站式加密交易平台。它…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="mw l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/best-social-trading-platforms" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">5个最佳社交交易平台[2021] | CoinCodeCap</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">困惑于社交交易和副本交易哪个平台最好？本文将带您了解各种…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="mx l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/blockfi-review" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">BlockFi评论2021:利弊和利率| CoinCodeCap</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">今天，我们提出了一个全面的BlockFi评论，这是一个成立于2017年的加密贷款平台，拥有其…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="my l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/buy-bitcoin-in-india-feb50ddfef94"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">如何在印度购买比特币？2021年购买比特币的7款最佳应用[手机版]</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">如何使用移动应用程序购买比特币印度</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="mz l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">加密税务软件——五大最佳比特币税务计算器[2021]</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">不管你是刚接触加密还是已经在这个领域呆了一段时间，你都需要交税。</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="na l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a href="https://blog.coincodecap.com/best-hardware-wallet-bitcoin" rel="noopener  ugc nofollow" target="_blank"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">存储比特币的最佳加密硬件钱包[2021] | CoinCodeCap</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">保管您的数字资产很容易，但找到正确的存储方式却是一项繁琐的任务。在线钱包有一个风险…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">blog.coincodecap.com</p></div></div><div class="ml l"><div class="nb l mn mo mp ml mq jv mc"/></div></div></a></div><div class="lz ma fm fo mb mc"><a rel="noopener follow" target="_blank" href="/coinmonks/pionex-review-exchange-with-crypto-trading-bot-1e459d0191ea"><div class="md ab ej"><div class="me ab mf cl cj mg"><h2 class="bd hu fv z el mh eo ep mi er et hs dt translated">Pionex评论2021 |免费加密交易机器人和交换</h2><div class="mj l"><h3 class="bd b fv z el mh eo ep mi er et ek translated">Pionex是为交易自动化提供工具的后起之秀。Pionex上提供了9个加密交易机器人…</h3></div><div class="mk l"><p class="bd b gc z el mh eo ep mi er et ek translated">medium.com</p></div></div><div class="ml l"><div class="nc l mn mo mp ml mq jv mc"/></div></div></a></div></div></div>    
</body>
</html>