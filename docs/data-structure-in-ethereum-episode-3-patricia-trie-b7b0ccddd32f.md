# ä»¥å¤ªåŠä¸­çš„æ•°æ®ç»“æ„|ç¬¬ 3 é›†:Patricia trieã€‚

> åŸæ–‡ï¼š<https://medium.com/coinmonks/data-structure-in-ethereum-episode-3-patricia-trie-b7b0ccddd32f?source=collection_archive---------0----------------------->

![](img/fc35c38c4302572f0e64075633fd31c8.png)

Image source: [**/r/ethereum**](https://www.reddit.com/r/ethereum/comments/67sds9/ethereum_background_wallpaper_image_in_hd/) by [**BitcoinIsTehFuture**](https://www.reddit.com/user/BitcoinIsTehFuture)

Patricia trie æ˜¯ä»¥å¤ªåŠä¸­ç”¨æ¥å­˜å‚¨æ•°æ®çš„ä¸»è¦ trieã€‚å®ƒæ˜¯ç”± [Radix trie å’Œ Merkle trie](/@phansnt/data-structure-in-ethereum-episode-2-radix-trie-and-merkle-trie-d941d0bfd69a) æ··åˆè€Œæˆã€‚

> ä¸ºäº†ä½¿å®ƒå®¹æ˜“ç†è§£ï¼Œæˆ‘å°†é¦–å…ˆå¸¦æˆ‘ä»¬å»ä¸€ä¸ªä½æ•ˆçš„å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œï¼Œç„¶åå»â€œæ”¹è¿›çš„â€å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œï¼Œæœ€åæ˜¯â€œçœŸæ­£çš„â€å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºæˆ‘ä»¬äº†è§£æŸäº›ç»“æ„äº§ç”Ÿçš„åŸå› ã€‚
> 
> è¿™æ„å‘³ç€å…³äºåŠ¨æœºå’Œç›´è§‰*ğŸƒã€‚*

> [å‘ç°å¹¶è¯„ä¼°æœ€ä½³åŒºå—é“¾ api å’ŒèŠ‚ç‚¹äº§å“](https://coincodecap.com/category/blockchain-node-and-api)

***æ•°æ®é›†***

***æœ¯è¯­***

![](img/a6aad55a095d3dcb701ce2589e8acc6e.png)

A node.

ä»¥å¤ªåŠä¸­çš„èŠ‚ç‚¹å­˜å‚¨ä¸ºé”®å€¼ï¼Œé”®å€¼æ˜¯èŠ‚ç‚¹çš„æ•£åˆ—ã€‚å€¼æ˜¯ä¸€ä¸ªåŒ…å« 17 ä¸ªå…ƒç´ çš„æ•°ç»„ã€‚åœ¨ 17 ä¸ªå…ƒç´ ä¸­ï¼Œå‰ 16 ä¸ªå…ƒç´ ç”±ä»`0`åˆ°`f`çš„åå…­è¿›åˆ¶æ•°ç´¢å¼•ï¼Œæœ€åä¸€ä¸ªæ˜¯è¯¥èŠ‚ç‚¹åŒ…å«çš„æ•°æ®ã€‚

> é”®ä¸è·¯å¾„

è¯·æ³¨æ„ï¼Œ`key`ç”¨äºâ€œæ•°æ®åº“æŸ¥æ‰¾â€(æ„ä¸ºé€šè¿‡æ•°æ®åº“æœºåˆ¶æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹)ï¼Œè€Œ`path`ç”¨äºâ€œtrie æŸ¥æ‰¾â€(æ„ä¸ºé€šè¿‡è·¯å¾„é™åºæŸ¥æ‰¾æ•°æ®ï¼Œå¦‚ [Radix trie](/@phansnt/data-structure-in-ethereum-episode-2-radix-trie-and-merkle-trie-d941d0bfd69a) )ã€‚

> å¦‚æœä»ç„¶ä¸æ˜ç¡®ï¼Œä¸‹é¢çš„ä¾‹å­ä¼šæ›´ç®€å•ã€‚

***æ•ˆç‡ä½ä¸‹çš„å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œ***

æˆ‘ä»¬æ„å»ºä¸€ä¸ª trie æ¥è¡¨ç¤ºæˆ‘ä»¬çš„æ•°æ®é›†ã€‚

![](img/36e18a093a87cf5fa896ddda5443befd.png)

Building trie by dataset.

ä¸ºäº†å†æ¬¡æµ‹è¯•ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€æ­¥ä¸€æ­¥åœ°æœç´¢`395`è·¯å¾„çš„å€¼ã€‚

> ç¬¦å·:â€œè¿™æ˜¯æ•°æ®åº“æŸ¥æ‰¾â€â€”â€”**tdl**ï¼Œâ€œè¿™æ˜¯ trie æŸ¥æ‰¾â€â€”â€”**TTL**ï¼›

1.  æˆ‘ä»¬å°†`395`ä¸‹é™åˆ° 3 ä¸ªéƒ¨åˆ†`3`ã€`9`ã€`5`ï¼Œä¾æ¬¡ä½¿ç”¨ã€‚
2.  ä»`rootHash`å¼€å§‹ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°ä¸`rootHash`å¯¹åº”çš„`rootNode`(**tdl**)ã€‚
3.  è·¯å¾„çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯`3`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ç”±`rootNode`çš„`3`ç´¢å¼•çš„å…ƒç´ ï¼Œé‚£å°±æ˜¯`hashA` ( **ttl** )ã€‚
4.  æŸ¥æ‰¾`hashA` ( **tdl** )ï¼Œè·å–ç”±`9` ( **ttl** )ç´¢å¼•çš„å…ƒç´ ï¼Œå…ƒç´ çš„å€¼ä¸º`hashC`ã€‚
5.  å¯»æ‰¾`hashC` ( **tdl** )ï¼Œè·å–ç”±`5` ( **ttl** )ç´¢å¼•çš„å…ƒç´ ï¼Œå…ƒç´ çš„å€¼ä¸º`hashD`ã€‚
6.  æ­¤æ—¶ï¼Œæˆ‘ä»¬æ²¿ç€æ•´ä¸ªè·¯å¾„å‘ä¸‹ï¼Œè¿™æ ·æˆ‘ä»¬å°†è·å¾—ä¸`hashD` ( **ttl** )å¯¹åº”çš„èŠ‚ç‚¹çš„æ•°æ®å…ƒç´ (æœ€åä¸€ä¸ªå…ƒç´ )ä¸­åŒ…å«çš„å€¼ï¼Œç»“æœæ˜¯`duck`ã€‚

æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ path æ¥æŸ¥æ‰¾å€¼(Radix trie çš„ä¸€ä¸ªå±æ€§),å¦‚æœ trie ä¸­çš„ä¸€ä¸ªå€¼è¢«æ›´æ”¹ï¼Œå®ƒå°†å¯¼è‡´ trie çš„`rootHash`è¢«æ›´æ”¹(Merkle trie çš„ä¸€ä¸ªå±æ€§)ã€‚

æ­¤å¤–ï¼Œtrie çš„æ•°æ®å…ƒç´ ä¸­æœ‰å¤ªå¤šçš„ç©ºå€¼èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»æ”¹è¿›å®ƒä»¥æé«˜æ•ˆç‡ã€‚

***ã€æ”¹è‰¯ç‰ˆã€‘å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œ***

> æˆ‘ä»¬å¦‚ä½•æ”¹è¿›å®ƒï¼Ÿæœ€å¥½çš„ç­”æ¡ˆåœ¨ä»¥å¤ªåŠç»´åŸºé‡Œï¼Œæˆ‘ä¸ä¼šè§£é‡Šçš„æ›´å¥½ï¼Œä¸‹é¢å°±å¼•ç”¨ä¸€ä¸‹*ğŸ’…ğŸ’…ğŸ’…ã€‚*

[åœ£ç­”](https://github.com/ethereum/wiki/wiki/Patricia-Tree#optimization)ã€‚

![](img/ebf739b95badbcce9a387446174ead30.png)

Finally, chose one ğŸ’†ğŸ’†ğŸ’†.

åœ¨[ç¬¬ä¸€é›†+](/@phansnt/data-structure-in-ethereum-episode-1-compact-hex-prefix-encoding-12558ae02791) ä¸­æˆ‘å·²ç»æåˆ°è¿‡`leaf`èŠ‚ç‚¹å’Œ`extension`èŠ‚ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“å®ƒä»¬æ˜¯ä»€ä¹ˆã€‚æˆ‘ä»¬é‡åˆ°äº†ä¸€äº›ä½¿æˆ‘ä»¬çš„æ ‘é€€åŒ–çš„æƒ…å†µï¼Œé‚£äº›æ˜¯æ²¡æœ‰åˆ†æ”¯çš„é•¿è·¯å¾„(æ²¡æœ‰åˆ†å‰çš„è·¯å¾„)ã€‚

æ¯”å¦‚:`56f0`ï¼Œè¦è·å–`horse`å€¼ï¼Œéœ€è¦ä¸‹è¡Œå¤ªå¤šç©ºå€¼èŠ‚ç‚¹ã€‚

ä½†æ˜¯ï¼Œè¿™å¯¼è‡´äº†ä¸¤ä¸ªå­é—®é¢˜ã€‚

1.  æ²¡æœ‰åˆ†å‰çš„è·¯å¾„æŒ‡å‘æ•°æ®çš„æœ«ç«¯ã€‚æ¯”å¦‚:`56f0`ã€‚
2.  ä¸­é—´æ²¡æœ‰åˆ†å‰çš„è·¯å¾„ã€‚æ¯”å¦‚:`{cabe, cab8}`çš„`cab`ã€‚

ä¸ºäº†è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä»–ä»¬å¼•å…¥äº†`leaf`èŠ‚ç‚¹ï¼Œä¸ºäº†è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä»–ä»¬å¼•å…¥äº†`extension`èŠ‚ç‚¹ã€‚å®ƒä»¬æ˜¯å…·æœ‰ 2 ä¸ªå…ƒç´ çš„æ•°ç»„å½¢å¼çš„èŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯`partialPath`ï¼Œå¸®åŠ©å‡å°‘ç©ºå€¼èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªå…ƒç´ åŒ…å«å€¼ï¼Œå¦‚æœæ˜¯`leaf`åˆ™ä¸º`data`ï¼Œå¦‚æœæ˜¯`extension`åˆ™ä¸º`merkleHash`ã€‚

![](img/a51026a8f3c7d2b917c97b7c4171b77a.png)

Using leaf node.

`hashE`ç°åœ¨å˜æˆäº†ä¸€ä¸ª`leaf`èŠ‚ç‚¹ï¼Œè¦å¾—åˆ°`56f0`è·¯å¾„çš„å€¼æˆ‘ä»¬å¯ä»¥è¿™æ ·åš:

1.  è·å–ç´¢å¼•ä¸º`5`çš„å…ƒç´ `rootHash`ï¼Œå€¼ä¸º`hashE`ã€‚
2.  å› ä¸º`hashE`å¯èƒ½æ˜¯ä¸€ä¸ª`leaf`æˆ–`extension`èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»å°†è·¯å¾„çš„å‰©ä½™éƒ¨åˆ†(remainder)ä¸`hashE`çš„`partialPath`è¿›è¡Œæ¯”è¾ƒã€‚ä½™æ•°æ˜¯`6f0`ï¼Œ`partialPath`æ˜¯`6f0`(äºŒè€…ç›¸åŒ)ï¼Œæ‰€ä»¥è¿™ä¸ªèŠ‚ç‚¹æ˜¯`leaf`èŠ‚ç‚¹ã€‚æˆ‘ä»¬è¿”å›`data`å­—æ®µï¼Œç»“æœæ˜¯`horse`ã€‚

![](img/87a97e0084134204c5f54fd44d4b4b0e.png)

Using leaf node and extension node.

`hashB`ç°åœ¨å˜æˆäº†`extension`èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œè·å–`cab8`è·¯å¾„çš„`data`:

1.  è·å–ç”±`rootHash`çš„`c`ç´¢å¼•çš„å…ƒç´ ï¼Œå€¼ä¸º`hashB`ã€‚
2.  æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`hashB`æ˜¯ä¸€ä¸ªæœ‰ 2 ä¸ªå€¼çš„æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æ–­æ¯”è¾ƒä½™æ•°å’Œ`partialPath`æ¥çŸ¥é“å“ªä¸ªæ˜¯èŠ‚ç‚¹ã€‚ä½™æ•°ä¸º`ab8`ä¸”`partialPath`ä¸º`ab`ï¼Œè¡¨ç¤ºèŠ‚ç‚¹ä¸º`extension`èŠ‚ç‚¹ã€‚æˆ‘ä»¬ä»è·¯å¾„çš„å½“å‰å‰©ä½™éƒ¨åˆ†ç§»é™¤`partialPath`ï¼Œæˆ‘ä»¬å¾—åˆ°è·¯å¾„çš„æ–°å‰©ä½™éƒ¨åˆ†æ˜¯`8`ï¼Œä¸‹ä¸€ä¸ªæ•£åˆ—æ˜¯`hashJ`ã€‚
3.  æ‰¾åˆ°`hashJ`å¯¹åº”çš„èŠ‚ç‚¹ï¼Œè·å–`8`ç´¢å¼•çš„å…ƒç´ ï¼Œå€¼ä¸º`hashK`ã€‚ä½™æ•°ç°åœ¨æ˜¯ç©ºçš„ã€‚
4.  å¯»æ‰¾`hashK`å¹¶ä¸”æˆ‘ä»¬æ”¶åˆ°ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹`partialPath`(å¶èŠ‚ç‚¹ï¼Œå› ä¸ºä½™æ•°ç­‰äº`partialPath`)ï¼Œè¿”å›`dog`ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`hashD`ã€`hashK`å’Œ`hashL`ä¹Ÿæ˜¯`leaf`èŠ‚ç‚¹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„ trie ä»ç„¶æ²¡æœ‰å®Œå…¨ä¼˜åŒ–ã€‚

![](img/bfb932dc2f486645bbbaacd4d5405342.png)

Optimized trie.

ç°åœ¨ï¼Œè¿™ä¸ª trie ä¼¼ä¹è¢«`leaf`èŠ‚ç‚¹å’Œ`extension`èŠ‚ç‚¹å……åˆ†ä¼˜åŒ–äº†ã€‚

> ä»¥ä¸Šä¸¤ä¸ªä¾‹å­æœ‰åŠ©äºæˆ‘ä»¬ç†è§£ä¸ºä»€ä¹ˆä»¥åŠå¦‚ä½•å»ºç«‹å’Œæ”¹è¿›å¸•ç‰¹é‡Œå¤ç‰¹é‡Œã€‚ç°åœ¨æˆ‘ä»¬å°†å®Œæˆå®ƒï¼Œå¹¶å¾—åˆ°ä»¥å¤ªåŠä½¿ç”¨çš„æœ€ç»ˆå¸•ç‰¹é‡Œå¤ç‰¹é‡Œã€‚*ğŸš€ğŸš€ğŸš€*

***å¸•ç‰¹ä¸½å¤Â·ç‰¹é‡Œ***

ä¸€äº›é™„åŠ è§„åˆ™:

1.  æ¯ä¸€æ¬¡`partialPath`å‡ºæ‰‹å‰éƒ½ä¼šè¢« [HP ç¼–ç ](/@phansnt/data-structure-in-ethereum-episode-1-compact-hex-prefix-encoding-12558ae02791)ã€‚
2.  èŠ‚ç‚¹ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å°†è¢« [RLP ç¼–ç ](/@phansnt/data-structure-in-ethereum-episode-1-recursive-length-prefix-rlp-encoding-decoding-d1016832f919)ã€‚
3.  å€¼(èŠ‚ç‚¹)å°†åœ¨å­˜å‚¨ä¸‹æ¥ä¹‹å‰è¿›è¡Œ RLP ç¼–ç ã€‚

![](img/f709de4573000f1121e6e0b8a3de86eb.png)

Patricia trie.

***ä»¥å¤ªåŠæ•°æ®ç»“æ„***

åœ¨ä»¥å¤ªåŠä¸­ï¼ŒPatricia trie ç”¨äº 4 trie:

1.  stateRoot
2.  storageRoot
3.  transactionRoot
4.  æ”¶æ®æ ¹

å…¶ä¸­ï¼Œ`stateRoot`ã€`transactionRoot`å’Œ`receiptRoot`åŒ…å«åœ¨å—å¤´ä¸­ã€‚ç‰¹åˆ«åœ°ï¼Œ`storageRoot`æ˜¯å­ trie å¹¶ä¸”åŒ…å«åœ¨çŠ¶æ€ trie çš„æ•°æ®ä¸­ã€‚

ä¸‹é¢çš„é“¾æ¥æ˜¯å¯¹å®ƒä»¬çš„å®Œç¾è§£é‡Šã€‚

[](https://github.com/ethereum/wiki/wiki/Patricia-Tree#tries-in-ethereum) [## ä»¥å¤ªåŠ/ç»´åŸº

### ç»´åŸº-ä»¥å¤ªåŠç»´åŸº-

github.com](https://github.com/ethereum/wiki/wiki/Patricia-Tree#tries-in-ethereum) 

***ç»“è®º***

æˆ‘ä»ç¬¬ 1 é›†åˆ°ç¬¬ 3 é›†å±•ç¤ºçš„ä¸€åˆ‡éƒ½æ˜¯ä¸€äº›ç†è®ºä¸Šçš„ä¸œè¥¿ï¼Œä¼¼ä¹ä¸è¶³ä»¥ç†è§£ Patricia trie åœ¨å®è·µä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚åœ¨ä¸‹ä¸€é›†ï¼Œæˆ‘ä»¬å°†åšä¸€ä¸ªè¿æ¥æ•°æ®åº“çš„ä¾‹å­ï¼Œå¹¶å±•ç¤º trie æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚é‚£çœŸçš„å¾ˆé…·ã€‚

> ä½ éœ€è¦å…ˆäº†è§£ä¸€äº›å…³äº gethã€web3 å’Œ levelDB çš„çŸ¥è¯†ï¼Œä»¥ä¾¿åœ¨é˜…è¯»ç¬¬å››é›†æ—¶æ›´åŠ æµç•…ã€‚

> [ç›´æ¥åœ¨æ‚¨çš„æ”¶ä»¶ç®±ä¸­è·å¾—æœ€ä½³è½¯ä»¶äº¤æ˜“](https://coincodecap.com/?utm_source=coinmonks)

[![](img/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png)](https://coincodecap.com/?utm_source=coinmonks)

***å‚è€ƒæ–‡çŒ®***

æ¥è‡ªç»´åŸºä»¥å¤ªåŠçš„æ–‡æ¡£:

[](https://github.com/ethereum/wiki/wiki/Patricia-Tree#optimization) [## ä»¥å¤ªåŠ/ç»´åŸº

### ç»´åŸº-ä»¥å¤ªåŠç»´åŸº-

github.com](https://github.com/ethereum/wiki/wiki/Patricia-Tree#optimization)