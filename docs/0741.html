<html>
<head>
<title>Stateful vs. Stateless Blockchain Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有状态与无状态区块链契约</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/stateful-vs-stateless-blockchain-contracts-bcd1b0c25ff?source=collection_archive---------6-----------------------#2018-06-09">https://medium.com/coinmonks/stateful-vs-stateless-blockchain-contracts-bcd1b0c25ff?source=collection_archive---------6-----------------------#2018-06-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><figure class="hs ht fm fo hu hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff hr"><img src="../Images/6b78ebbfc80451f9249d9badbab4f1b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ls5oBovvHvMSXa14P9lF1w.png"/></div></div><figcaption class="ic id fg fe ff ie if bd b be z ek">Stateless vs. Stateful Blockchain Contracts. Credit Image David di Veroli Unsplash.</figcaption></figure><div class=""/><div class=""><h2 id="3c47" class="pw-subtitle-paragraph jf ih ii bd b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ek translated">或者以太坊合约有什么问题，新的Ardor轻量级合约如何解决这个问题</h2></div><p id="94b6" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">查看<a class="ae kt" rel="noopener" href="/@lyaffe/lightweight-contracts-articles-49c3032a50da">更多轻量级合同文章</a></p><p id="e636" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">要了解现有以太坊智能合约有多糟糕，请查看其中一个最简单的<a class="ae kt" href="https://www.ethereum.org/crowdsale" rel="noopener ugc nofollow" target="_blank">示例</a>，向下滚动一点，查看代表MyToken合约示例的30行代码。</p><figure class="kv kw kx ky fq hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff ku"><img src="../Images/aeb001a60843d760e97ddd34dd9f0e07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MekDu9kN7ZTwfrtwK9qGiQ.png"/></div></div><figcaption class="ic id fg fe ff ie if bd b be z ek">Crowdfund your idea — Ethereum Smart Contract example</figcaption></figure><p id="0816" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">这是每一个新的智能合约开发者都会从的例子，直接来自马嘴，ethereum.org。</p><p id="f588" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">那么，这样一个看起来无害的例子有什么错呢？让我们仔细分析一下合同的执行情况，找出问题所在。</p><p id="30c6" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated"><strong class="jz ij">以太坊契约是有状态的</strong></p><p id="b419" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">第8行的balanceOf array是万恶之源(从计算机科学的角度来说)。该数组维护持有MyToken的帐户余额，用编程术语来说，我们将数组的余额称为契约的“状态”,因为该信息在契约调用之间维护，并存储在区块链上。</p><p id="d853" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">这种方法的错误在于，它是并发问题和各种外来攻击媒介的磁石。</p><p id="df1d" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">例如，看看第23行的transfer()方法，想想如果transfer方法被两个不同的线程调用会发生什么，这两个线程都将同一个消息发送者的所有余额提取到另一个帐户中，每个线程同时在自己的CPU上运行。</p><p id="d1b2" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">如果在一个CPU上，一个线程通过了第24行上的余额检查，但是还没有达到第26行上的余额扣除，而在另一个CPU上运行的另一个线程同时调用来自同一发送者的转移，则两个线程都将通过第24行上的检查，允许消息发送者加倍花费他的代币，即转移高达他的可用余额的两倍。</p><p id="5733" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">我们称这个问题为竞争条件，任何维护共享状态的程序，如balanceOf array，都会受到它的影响。</p><p id="f4b3" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">这意味着以太坊契约不能并行执行。因此，即使您的桌面上有一个这样的<a class="ae kt" href="http://www.dell.com/il/en/business/p/poweredge-tower-servers" rel="noopener ugc nofollow" target="_blank">怪物</a>，您的合同仍然只在一个CPU上执行，使得整个服务器大部分时间处于空闲状态。理想情况下，当我们处理一个充满契约调用事务的块时，我们想要的是并行运行所有的契约，但是由于共享状态，这是不可能的。</p><p id="7e67" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">共享状态会导致其他问题，例如，如果在第26行和第27行之间，契约开发人员决定调用外部契约，该怎么办？这个外部契约可能抛出异常，使得发送者没有他的余额，即使这个余额还没有被记入接收者的贷方。</p><p id="517c" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">更糟糕的是，这种外部契约调用可能会从向自身发送令牌的外部契约中恶意地再次调用transfer方法。下面的<a class="ae kt" href="https://consensys.github.io/smart-contract-best-practices/recommendations/" rel="noopener ugc nofollow" target="_blank">资源</a>混淆地将这个问题命名为“竞争条件”,尽管它与并发性无关，并定义了一些可以遵循的最佳实践来避免这些问题。然而，随着合同变得更加复杂和关键，这些最佳实践变得非常难以实施。</p><p id="0b2c" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">总的来说，依靠合同来保存其状态是一个坏主意，它打开了几个攻击媒介和操纵选项，并且还由于难以发现缺陷而导致锁定合同中的资金的持续风险。</p><p id="cfd6" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated"><strong class="jz ij">热情轻量级合同救场</strong></p><p id="278b" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">Ardor基于NXT技术，已经有几种方法可以在区块链上安全地保存状态，使用消息、账户属性、别名、云数据、各种类型的令牌等实体。所有这些实体都使用自己的事务类型和API构建到核心区块链中。</p><p id="669d" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">基于这个现有的功能，我们将轻量级契约设计成无状态的。这意味着协定本身从不保存任何状态，如数组的balanceOf。相反，合同要求的所有状态修改都作为正常交易提交，一旦被区块链接受，将修改上面列出的一些实体，以便将信息保存到区块链中。稍后，当同一个或另一个轻量级契约需要一些状态信息(如令牌余额或账户KYC信息)时，它将使用一个公共API从区块链查询它。</p><p id="b141" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">类似于上述以太坊契约的轻量级契约的直接1:1示例是不可行的，因为在Ardor中，为了更改令牌余额，您所需要的只是调用transferAsset API，所以让我们看看另一个示例，看看这是如何工作的。</p><p id="f85f" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">这个简单的Hello World示例演示了Ardor轻量级契约如何通过发送消息事务来修改区块链的状态，而不保留任何内部状态。</p><p id="c89a" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated"><a class="ae kt" href="https://bitbucket.org/Jelurida/ardor/src/master/addons/src/java/com/jelurida/ardor/contracts/HelloWorld.java" rel="noopener ugc nofollow" target="_blank">https://bit bucket . org/jelu Rida/ardor/src/master/addons/src/Java/com/jelu Rida/ardor/contracts/hello world . Java</a></p><p id="20f2" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">由于HelloWorld契约中没有存储共享数据，因此很明显，许多HelloWorld契约实例可以并行执行，而不会导致任何与并发性相关的问题或类似以太坊的竞态条件。</p><p id="f77d" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">合同提交的任何交易都将由内置竞争条件预防的区块链处理，从而将处理这一难题的责任从合同开发商转移到核心区块链开发商。</p><p id="7e29" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">由于轻量级契约由单个节点执行，而不是由所有节点执行，因此不存在重复的消息传递事务淹没区块链的风险。如您所见，合同被调用，进行一些处理，提交一些事务，然后退出。契约的下一次调用不依赖于保存在契约本身中的任何数据，因此可以并行运行。</p><p id="5107" class="pw-post-body-paragraph jx jy ii jz b ka kb jj kc kd ke jm kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">我们相信Ardor使用的无状态契约执行方法将会比其他有状态方法更加安全和可伸缩。</p><figure class="kv kw kx ky fq hv fe ff paragraph-image"><a href="http://bit.ly/2G71Sp7"><div class="fe ff kz"><img src="../Images/449450761cd76f44f9ae574333f9e9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKX2mtg7p1lOs7JmosPLsA.png"/></div></a></figure></div></div>    
</body>
</html>