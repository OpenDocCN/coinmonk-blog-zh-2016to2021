<html>
<head>
<title>Solidity Smart Contracts Walk-through Series Part-3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Solidity智能合约演练系列第3部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/solidity-smart-contracts-walk-through-series-part-3-480ba8019ab9?source=collection_archive---------4-----------------------#2019-10-10">https://medium.com/coinmonks/solidity-smart-contracts-walk-through-series-part-3-480ba8019ab9?source=collection_archive---------4-----------------------#2019-10-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/3cb59de439f89b810f3db0a4d9053b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sCrTrOBzpLqQ-RCi3RuK9Q.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@chrisliverani?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Chris Liverani</a> on <a class="ae jf" href="https://unsplash.com/s/photos/handshake?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d6c6" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这是智能合同演练系列的第3部分<strong class="ji hu">。在下面的帖子中，我将向您深入介绍我们的业务合作智能合同的技术实现细节。代码库可以在这里找到<a class="ae jf" href="https://github.com/Harry-027/Solidity-Smart-Contracts-Walkthrough" rel="noopener ugc nofollow" target="_blank"><strong class="ji hu"/></a><strong class="ji hu">。</strong></strong></p><p id="4c45" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">业务伙伴关系用例::</strong></p><p id="c764" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">两个用户(或商业伙伴)可以通过签署合同来建立伙伴关系。一旦签订合同，合作双方将获得以下特权:</p><ul class=""><li id="6fbc" class="ke kf ht ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated">在合同中增加资金的权利。</li><li id="0c11" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">将资金从合同转移给第三方的权利。</li><li id="74c7" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">提出一个项目，按比例分配给他们。(双方分配的总和应为100%)</li><li id="db69" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">批准提议的项目。一旦一个项目得到双方的批准，它将被提交给区块链与分配细节。</li><li id="539c" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">移除项目。一旦双方同意删除某个项目，它将在区块链上被标记为已删除。</li><li id="4b00" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">解除合作关系的权利。一旦双方同意分居，上述权利将不再适用于任何一方。此外，储存在合同中的资金将在他们之间平均分配。</li></ul><p id="6e9c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">我们开始吧……</strong></p><p id="4f64" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">下面是我们定义的数据结构:</p><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ks"><img src="../Images/837f67c616bb33ad1ebd3c5417fb1981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tj2jAUI1ZdCQH2ba0jmM0g.png"/></div></div></figure><p id="933f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们将存储双方的地址(<strong class="ji hu">partner one&amp;partner two</strong>)。两个布尔标志(<strong class="ji hu">符号&amp;分隔</strong>)将跟踪合作关系的状态。两个映射(<strong class="ji hu">has separated&amp;has signed</strong>)都将存储来自合作伙伴的关于其合作或分离的批准。<strong class="ji hu">项目结构</strong>将帮助我们存储要在合作伙伴之间共享的项目及其各自的份额百分比。<strong class="ji hu">物品</strong>数组将存储物品列表。<strong class="ji hu"> ItemIds </strong>数组将存储项目的索引。</p><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div class="fe ff kx"><img src="../Images/812da50e1e8634cef7ad4a0027fad128.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*7tuKgiUuDv7h1F3pZr6euQ.png"/></div><figcaption class="jb jc fg fe ff jd je bd b be z ek"><strong class="bd ky">Events to be fired while confirming various transactions on blockchain</strong></figcaption></figure><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kz"><img src="../Images/18fe3093110ac27ecfe69e54587c47be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tv9eVHoLVTLEzIH9D3py_Q.png"/></div></div></figure><p id="67bd" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们将在合约部署本身期间初始化两个用户(一旦他们签署合约，他们将成为未来的合作伙伴)的钱包地址(在构造器中<strong class="ji hu">)。我们还将使用修饰符，如<strong class="ji hu"> onlyPartner，is signed&amp;not separated来</strong>限制各种合同功能。</strong></p><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff la"><img src="../Images/50fdf6030d5f97442af34c5cde3be1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPvVEO5qPmAzSyrpAx587w.png"/></div></div></figure><p id="22ab" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">方法将允许双方用户签署合同。一旦双方都签署了合同，合同的状态将变为合伙(通过将<strong class="ji hu">已签署</strong>标志标记为<strong class="ji hu">真</strong>)。</p><blockquote class="lb lc ld"><p id="730b" class="jg jh le ji b jj jk jl jm jn jo jp jq lf js jt ju lg jw jx jy lh ka kb kc kd hm dt translated">注意-指定为<strong class="ji hu">外部</strong>的方法可以从契约外部调用。要在契约内部调用它，请使用<strong class="ji hu"> this </strong>关键字(this.externalMethodName())。指定为<strong class="ji hu"> public </strong>的方法可以在契约外部或内部调用。<strong class="ji hu">内部</strong>方法只能在内部调用。<strong class="ji hu">私有</strong>方法在派生契约中不可用。</p></blockquote><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/2fb71e5db7b7fefc9cc5b6e079623302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TZrl0BkqrnGbD29nt0eXVw.png"/></div></div></figure><p id="dabf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> proposeItem </strong>将让双方提出任何要在他们之间分享的物品。只有在以下情况下，交易才会成功-</p><ul class=""><li id="15f6" class="ke kf ht ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated">两个用户都是伙伴关系(<strong class="ji hu"> signed = true </strong>)。</li><li id="4498" class="ke kf ht ji b jj kn jn ko jr kp jv kq jz kr kd kj kk kl km dt translated">每个合伙人的份额应该为<strong class="ji hu">非负</strong> &amp;总份额总和应该等于<strong class="ji hu"> 100% </strong>。</li></ul><p id="bb8c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> proposeItem </strong>方法还会将项目标记为由提出项目<strong class="ji hu">的用户批准(item . hasapprovedadd[msg . sender]= true)。</strong>然后将该项目存储在<strong class="ji hu">项目</strong>列表中&amp;也将维护其在<strong class="ji hu"> itemIds </strong>数组中的索引。</p><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/28212d08eea079bffe99c2747818e61c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*KcHl3Y4tqHoY_CsW7GslKg.png"/></div></figure><p id="60c9" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> approveItem </strong>将接受一个itemId，从列表中确定要批准的项目。在发件人批准之前，它将验证该项目是否已被添加、删除或之前已被批准。合作伙伴双方批准后，项目将被标记为已添加。</p><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lk"><img src="../Images/c9e719254160924155a06d866b2d7f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VGzLZCVLllCUXH0jBOB5Jw.png"/></div></div></figure><p id="8f69" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> RemoveItem </strong>将接受一个itemId，以确定要删除的项目。一旦双方同意，项目将被标记为删除。</p><blockquote class="lb lc ld"><p id="ab4c" class="jg jh le ji b jj jk jl jm jn jo jp jq lf js jt ju lg jw jx jy lh ka kb kc kd hm dt translated"><strong class="ji hu">注意-</strong>address . send()&amp;address . transfer()方法是安全的，因为它们将23000 gas转发给仅足以记录某些内容的外部调用。而address.value.call(msg.value)()是不安全的，因为它将完整的gas转发给外部调用，从而使契约容易受到黑客攻击。</p></blockquote><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ll"><img src="../Images/587c82279bf7996e497e4e0fa3a8a1a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ojjsyPXDc-atFmOyNrOPNQ.png"/></div></div></figure><p id="cb59" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">匿名<strong class="ji hu">应付</strong>方法将允许合作伙伴在合同中存储资金。<strong class="ji hu">支付</strong>方法将允许他们向第三方转移任何资金。</p><blockquote class="lb lc ld"><p id="1000" class="jg jh le ji b jj jk jl jm jn jo jp jq lf js jt ju lg jw jx jy lh ka kb kc kd hm dt translated">注意—匿名回退函数可能在任何其他函数之后被调用。如果它只能用于交易(普通以太网传输)，那么您应该验证<strong class="ji hu"> msg.data.length == 0 </strong>(最佳实践)。</p></blockquote><figure class="kt ku kv kw fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lm"><img src="../Images/4c321f41e37c645053c24932f2813f94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f-PPXHMxfFje5rccukb0Kw.png"/></div></div></figure><p id="c5c1" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> getSeparated </strong>允许双方申请结束合作关系。如果双方都同意分居，合同将终止合作关系。它不允许他们在区块链进行任何其他交易。此外，合同中存储的所有资金将在他们之间平均分配。</p></div><div class="ab cl ln lo hb lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hm hn ho hp hq"><p id="2c59" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="le">其他部分:</em> <a class="ae jf" rel="noopener" href="/@harish0y2j/solidity-smart-contracts-walk-through-series-part-1-90075f4e9da6"> <em class="le"> Part-1 </em> </a> <em class="le">，</em><a class="ae jf" rel="noopener" href="/@harish0y2j/solidity-smart-contracts-walk-through-series-part-2-d526c5d5782e"><em class="le">Part-2</em></a><em class="le">，</em> <a class="ae jf" rel="noopener" href="/@harish0y2j/solidity-smart-contracts-walk-through-series-part-3-480ba8019ab9"> <em class="le"> Part-3 </em> </a></p><p id="227f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">代码库可以在这里找到<a class="ae jf" href="https://github.com/Harry-027/Solidity-Smart-Contracts-Walkthrough" rel="noopener ugc nofollow" target="_blank">。</a></p><blockquote class="lu"><p id="3fe8" class="lv lw ht bd lx ly lz ma mb mc md kd ek translated"><a class="ae jf" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mf mg mh mi mj iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff me"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>