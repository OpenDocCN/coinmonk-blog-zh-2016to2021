<html>
<head>
<title>#HowToBUIDL (2/n) :: Your First Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated"># how to guidl(2/n)::你的第一份合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/howtobuidl-2ofn-come-one-come-all-8a3e0ee706b1?source=collection_archive---------4-----------------------#2018-05-08">https://medium.com/coinmonks/howtobuidl-2ofn-come-one-come-all-8a3e0ee706b1?source=collection_archive---------4-----------------------#2018-05-08</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="3002" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">来吧来吧所有人！在这篇文章的最后，你将会写下你的第一份智能合同，名为“最伟大的表演”。</h2></div><blockquote class="ji jj jk"><p id="1b0e" class="jl jm jn jo b jp jq iu jr js jt ix ju jv jw jx jy jz ka kb kc kd ke kf kg kh hm dt translated">来一个！都来吧！来加入伟大的数字铁路吧！没有进入的障碍，只要你在被称为分散共识的规则框架内参与。这意味着你将为此而努力。这并不容易，但至少你已经迈出了第一步。来建造明天的数字铁路吧！一日三餐！你头上的屋顶！公平丰厚的工资！来，发财吧！不是每个人都会接受挑战。我想我会把它留给你。机会在等着你。</p></blockquote><p id="e76e" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated"><em class="jn">如果还没有，一定要赶在阅读前</em> <a class="ae kl" rel="noopener" href="/coinmonks/howtobuidl-series-1-of-n-bf51e248243d"> <em class="jn"> BUIDL :: Dev环境设置</em> </a> <em class="jn">。</em></p><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/70d868e93393677134daa4f0caafe78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7N3096R9TkHLMcLv7_88dg.png"/></div></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">Ethereum Blockchain lets us build the Digital Railroads of Tomorrow</figcaption></figure><h2 id="1c62" class="lc ld ht bd le lf lg lh li lj lk ll lm ki ln lo lp kj lq lr ls kk lt lu lv lw dt translated">就在此时此地。我提出了报价…</h2><p id="db51" class="pw-post-body-paragraph jl jm ht jo b jp lx iu jr js ly ix ju ki lz jx jy kj ma kb kc kk mb kf kg kh hm dt translated">在# HowToBUIDL系列的第一篇文章— <a class="ae kl" rel="noopener" href="/coinmonks/howtobuidl-series-1-of-n-bf51e248243d"> #BUIDL :: Dev环境设置</a>中，我们介绍了如何为这一步准备好您的计算机环境。也许你仍然持怀疑态度，或者担心自己没有这个技能。你被困在自己的意识中，只是没有被指引方向。</p><p id="e161" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">所以把典型的东西换成多彩的。如果很疯狂，就活得疯狂一点。你可以明智地玩，传统之王，或者你可以冒险看看…</p><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/075e5121c0d176ab071f73f3b2d3cd8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-brNqW9oNhZRByIMF38ErA.png"/></div></div></figure><p id="1c2b" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">这个通用以太坊区块链的核心是一个共识框架，允许任何人参与。该网络由一个激励网络来保证安全，在这个激励网络中，矿工可以获得被称为以太的加密安全货币作为奖励。一个点对点的节点网络保持了网络的健壮性，并允许人们向世界任何地方汇款，而不用考虑国界和微不足道的费用。</p><p id="c35b" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">分散式平台的好处是大幅降低成本和准入门槛，消除单点故障，防止审查，并确保参与互动的所有各方之间的透明度和信任。但是这个空间不仅仅是资金转移。智能合同通过消除中介真正促进了这种去中心化的想法。</p><p id="01f8" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">我们有方法将任何独特的对象表示为“令牌”,并且我们可以改变我们对所有权的看法。如果您拥有传输数据的权利，您就可以拥有传输数据所代表的内容的权利。在未来，我们可能会看到土地所有权、房地产所有权、融资协议和有限资源使用权的数字转移，其形式是应用程序公用令牌，甚至是可兑换成演出门票的老式门票。</p><p id="5e6c" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated"><strong class="jo hu"> <em class="jn">倾向于改变现状的不是最大的实体，而是最小的、往往是少数的声音，是变革的进步者</em> </strong> <em class="jn">。在我看来，授权来自包容，这正是区块链式项目所代表的。没有人想被排除在市场之外，而一个集中的市场有可能被排除在外。区块链技术提供了一种方式来#建造数字铁路，以前所未有的方式连接人们。</em></p><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff mc"><img src="../Images/23cf8234e09d6e35f51765777188b1f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WdI8MK9JKSM4NPjFhUyJ0g.jpeg"/></div></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">We’re going to the other side.</figcaption></figure></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><h2 id="fc92" class="lc ld ht bd le lf lg lh li lj lk ll lm ki ln lo lp kj lq lr ls kk lt lu lv lw dt translated">让我们开始吧。</h2><p id="4d67" class="pw-post-body-paragraph jl jm ht jo b jp lx iu jr js ly ix ju ki lz jx jy kj ma kb kc kk mb kf kg kh hm dt translated">智能契约是保持数据状态的构造，并为外部世界提供了一种与数据交互的方式。代码代表规则。也许“<em class="jn">聪明</em>”是用词不当。契约中的规则越复杂，就越难遵循，也就越难创建无bug的代码。事实上，你制定的契约越简单，你就越容易验证它，以确保代码做它说要做的事情。一旦部署到以太坊网络，代码是不可阻挡的，因此值得掌握合同中可以存储什么。虽然我们使用了术语“<em class="jn">合同”</em>但是目前，代码并没有在法庭上得到支持和执行。这些规则必须用代码定义，并专门编写来执行嵌入在契约中的逻辑。</p><p id="9713" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">每份合同都必须从描述最低版本的<em class="jn"> Solidity </em>开始，这是一种用于编写以太坊智能合同的语言。禁止0.4.22及以下版本，<a class="ae kl" href="https://github.com/ethereum/solc-js/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/ethereum/solc-js/releases</a>包含每个最新版本的信息。</p><p id="d1aa" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">首先创建一个名为ComeOneComeAll的新目录，启动truffle。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="d73e" class="lc ld ht ml b fv mp mq l mr ms">mkdir ComeOneComeAll<br/>cd ComeOneComeAll<br/>truffle init<br/>cd contracts/<br/>npm install zeppelin-solidity</span></pre><p id="b0a7" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">用你最喜欢的编辑器创建一个名为GreatestShow.sol的新文件<br/>对于较大的项目，你可能想使用一个名为VSCode的编辑器，但我认为名为Sublime的免费编辑器对我们的目的来说很好。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="0213" class="lc ld ht ml b fv mp mq l mr ms">pragma solidity ^0.4.23;</span></pre><p id="f8e2" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">接下来，通过给它命名来开始契约。让我们建造最伟大的表演。当我们去部署GreatestShow契约时，将调用构造函数。让我们利用这个机会传递一些信息，并记录一些免费发送给我们的数据。我们会保留使用它的人的以太坊地址，也会记下那个领班。根据您的存储和成本需求，文本可以表示为<code class="eh mt mu mv ml b">string</code>或<code class="eh mt mu mv ml b">bytes</code>。合同中的每项操作，包括存储数据，都要花费一点钱，我们称之为“汽油”。现在让我们保持简单，使用一个字符串。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="3437" class="lc ld ht ml b fv mp mq l mr ms">contract GreatestShow {</span><span id="c9aa" class="lc ld ht ml b fv mw mq l mr ms">    address public owner public; <br/>    string public ringMaster;</span><span id="67bc" class="lc ld ht ml b fv mw mq l mr ms">    constructor(string _ringMaster) {<br/>        owner = msg.sender;<br/>    }</span><span id="18bb" class="lc ld ht ml b fv mw mq l mr ms">}</span></pre><p id="b5a5" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">如果我们要部署此合同，我们将在migrations/2 _ deploy _ contracts . sol文件中执行如下操作:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="af68" class="lc ld ht ml b fv mp mq l mr ms">const GreatestShow = artifacts.require("./GreatestShow.sol");<br/><br/>module.exports = (deployer, network, accounts) =&gt; {<br/>    deployer.deploy( GreatestShow, "P.T. Barnum" );<br/>};</span></pre><p id="49c3" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">从命令行，我们可以运行:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="6110" class="lc ld ht ml b fv mp mq l mr ms">truffle migrate</span></pre><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff mx"><img src="../Images/f6ae3eeb1be1bde7d70b89750de31b58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gHbTeNUPXrwOsAfWwLvTMQ.jpeg"/></div></div></figure><p id="91d2" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt my translated"><span class="l mz na nb bm nc nd ne nf ng di"> G </span>太好了！我们有一场演出。从技术上来说，这就是我们达成明智合约所需要的一切。照这样，代码可以编译并部署到以太坊网络上。问题是，如果你只有一个马戏团团长，那就不算是一场表演。目前甚至没有任何参与者、演员或动物。在我们称我们的节目取得巨大成功之前，我们最好继续。</p><p id="0950" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">接下来，我们将向GreatestShow添加另一个属性，以便记录可用座位的总数。存储正数所需的变量类型是“无符号整数”，用uint表示。再说一次，现在只知道它是无符号的，因为它不可能是负的。这个数可以存储一个大到2的256次方的数(巨数！)因此，在未来，更好的做法是对存储持实际态度，只考虑与现实相关的数字。我们将添加一个函数，让合同的创建者存储可用座位的数量。</p><p id="6fb4" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">我们没有触及的一件事是变量的“公共”可访问性修饰符。出于数据安全的目的，假设合同中存储的所有数据都是公开可用的，即使没有标记。这是坚持公开、开放和抵制审查原则的好处之一。当一个变量被显式标记为public时，它会被赋予一个方便的访问器函数，默认情况下该函数的调用方可以使用该函数。因为我们在这里没有指定，所以有必要演示一下如何在<code class="eh mt mu mv ml b">contract</code>的主体中实现setter/getter对。setter接受一个我们分配给契约状态的参数，getter注意到它是<code class="eh mt mu mv ml b">returns(&lt;type&gt;)</code>。Solidity函数可以返回多个值，但是在这种情况下，只返回一个值是有意义的。因为getter不会改变数据的状态，所以按照惯例，您应该将它标记为<code class="eh mt mu mv ml b">view</code>。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="ae0a" class="lc ld ht ml b fv mp mq l mr ms">    uint availableSeats;</span><span id="13ab" class="lc ld ht ml b fv mw mq l mr ms">    function setAvailableSeats( uint _availableSeats ) public {<br/>        availableSeats = _availableSeats;<br/>    }</span><span id="613c" class="lc ld ht ml b fv mw mq l mr ms">    function getAvailableSeats() view public returns(uint) {<br/>        return availableSeats;<br/>    }</span></pre><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/c2a53327249333f526cdef5f6367344a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Qmvwl5RiBFHgd4nRNg5Zg.png"/></div></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">Awesome. We’ve got some seats and we’re ready to entertain!</figcaption></figure><p id="fb70" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">没错。现在我们有了一个乐队指挥和座位，但是在我们有一整套表演来娱乐他们之前，没有人会被娱乐。</p><p id="5ecc" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">现在让我们在节目中加入一些表演。可以给一个表演起一个名字、表演中的演员数量、表演所需的老虎、熊和大象的数量以及分配的时间。此外，可能需要注意的是，表演开始前需要清理舞台。这将让节目的制作人知道，为了处理表演，需要一些特殊的准备。</p><p id="6758" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">所有的编程语言都试图通过给程序员提供通过某种数据结构定义对象的方法来模拟现实。在Solidity中，最常见的方法是使用<code class="eh mt mu mv ml b">struct</code>——在这里可以定义用户定义的类型。在契约的主体中，让我们定义一个<code class="eh mt mu mv ml b">Performance</code>结构。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="4265" class="lc ld ht ml b fv mp mq l mr ms">    struct Performance {<br/>        string name;</span><span id="629d" class="lc ld ht ml b fv mw mq l mr ms">        uint32 actors;</span><span id="142f" class="lc ld ht ml b fv mw mq l mr ms">        uint8 tigers;<br/>        uint8 bears;<br/>        uint8 elephants;</span><span id="2c81" class="lc ld ht ml b fv mw mq l mr ms">        uint16 timeInSeconds;</span><span id="fea8" class="lc ld ht ml b fv mw mq l mr ms">        bool clearTheStageFirst;<br/>    }</span></pre><p id="adbb" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">契约的创建者现在需要一种方法，通过将所需的值传递给一个函数来添加一个<code class="eh mt mu mv ml b">Performance</code>。在合同中存储这些数据是有成本的；但是，我们现在不讨论这个问题。现在，我们只是在演示跟踪它的必要性。这意味着我们将不得不跟踪<code class="eh mt mu mv ml b">Performance</code>对象的<code class="eh mt mu mv ml b">array</code>，标为<code class="eh mt mu mv ml b">Performance[] performances</code>。我们将在每次调用<code class="eh mt mu mv ml b">addPerformance</code>函数时追加到数组中。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="609e" class="lc ld ht ml b fv mp mq l mr ms">  Performance[] performances;<br/>    <br/>  function addPerformance( <br/>              string _name,<br/>              uint32 _actors,                              <br/>              uint8 _tigers, <br/>              uint8 _bears,<br/>              uint8 _elephants, <br/>              uint16 _timeInSeconds,<br/>              bool _clearTheStageFirst ) public {</span><span id="3921" class="lc ld ht ml b fv mw mq l mr ms">      performances.push( <br/>          Performance( { name: _name, actors: _actors, <br/>              tigers: _tigers, bears: _bears, <br/>              elephants: _elephants,<br/>              timeInSeconds: _timeInSeconds,<br/>              clearTheStageFirst: _clearTheStageFirst } <br/>          ) <br/>      );<br/>  }</span></pre><p id="d7c0" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">我们马上就要超越我们自己了，但希望这将有助于理清事情。在契约被部署到网络之后，契约的所有者可能会使用类似于下面的代码在<code class="eh mt mu mv ml b">truffle console</code>中获得已部署契约的实例。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="3429" class="lc ld ht ml b fv mp mq l mr ms">// Add a performance of Knife Throwing requiring 2 people. <br/>// The performance will last 3 minutes and require zero animals.<br/>GreatestShow.deployed().then( function(show) {<br/>    show.addPerformance( "Knife Thrower", 2, 0, 0, 0, 180, false );<br/>} );</span></pre><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/e162b35502e9cbe4a5df2a3656a7edaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qSGDwUuFYqOK3zA9rz0l7w.png"/></div></div></figure><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="f858" class="lc ld ht ml b fv mp mq l mr ms">// Add a performance of 4 Flame Breathers lasting 30 seconds<br/>GreatestShow.deployed().then( function(show) {<br/>    show.addPerformance( "Flame Breather", 4, 0, 0, 0, 30, false );<br/>} );</span></pre><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/3e321a5fe8a006c7acecfe724cc2baf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W7bLa1kH3j2PNxozST-jhQ.png"/></div></div></figure><p id="c212" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">和大多数语言一样，Solidity中的数组是零索引的。要获得合同代码中的第一个性能，您可以参考<code class="eh mt mu mv ml b">performances[0]</code>。<br/>但是，如果您作为合同的调用者想要访问特定性能的所有数据，该怎么办呢？想象一下，你的合同用户想要在某个web应用程序上列出信息。我们将添加一个方便的方法来获取传入的<code class="eh mt mu mv ml b">_index</code>中特定<code class="eh mt mu mv ml b">Performance</code>实例的所有数据。</p><p id="1db9" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">请再次注意，数据没有改变，但也请注意，我们不能直接返回<code class="eh mt mu mv ml b">Performance</code>对象。可靠性限制要求数据必须作为多个值返回，如<code class="eh mt mu mv ml b">returns</code>语句所示。我们用括号<code class="eh mt mu mv ml b">(</code>将所有返回值括起来<code class="eh mt mu mv ml b">)</code>。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="8dca" class="lc ld ht ml b fv mp mq l mr ms">function getPerformance( uint _index ) view public <br/>      returns (string, uint32, uint8, uint8, uint8, uint16, bool) {</span><span id="3709" class="lc ld ht ml b fv mw mq l mr ms">    Performance storage perf = performances[_index];</span><span id="5900" class="lc ld ht ml b fv mw mq l mr ms">    return (perf.name, perf.actors, perf.tigers, perf.bears, <br/>            perf.elephants, perf.timeInSeconds, <br/>            perf.clearTheStageFirst); <br/>  }</span></pre><p id="8f94" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">假设第三个条目是赞达亚扮演的空中飞人安妮惠勒。她是一个女人的表演，但需要一组8个其他配角来帮助抓住她，并在她表演各种杂技时把她扔来扔去。舞台需要对设备来说是清晰的。如何从表演中获取一些信息示例:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="f4d0" class="lc ld ht ml b fv mp mq l mr ms">GreatestShow.deployed().then( function(show) {<br/>   let performance = show.getPerformance( 2 ); // 0-indexed</span><span id="7311" class="lc ld ht ml b fv mw mq l mr ms">   console.log( "Name:" + performance.name );     // Flying Trapeze<br/>   console.log( "Actors:" + performance.actors ); // 9 = 1 + 8<br/>   console.log( "Clear:" + performance.clearTheStageFirst); // true<br/>});</span></pre><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/14f17b82605dcc837a1b96f76c7567db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XAPi5smFcxp5j5oOQeWOrQ.png"/></div></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">Zendaya as Anne Wheeler the Flying Trapeze Artist and 8 supporting Actors</figcaption></figure><p id="64c7" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">我们就要完成了，但是我们需要一个方法来为买票的人筹钱！幸运的是，在以太坊中有一种方法可以创建一个接受以太的函数，以太是代表数字货币的本地加密货币。以太对美元或英镑等普通法定货币的汇率是波动的，但我们不会因为争论而担心这一点。不，相反我们只会担心接受以太来交换一定数量的席位。</p><p id="2585" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">我们还没有讨论过<code class="eh mt mu mv ml b">mapping</code>数据类型，但是本质上它允许我们将一个值映射到另一个值。在这里，我们将演示如何跟踪以太坊地址以及它们在无符号整数中的票数。</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="1622" class="lc ld ht ml b fv mp mq l mr ms">mapping(address =&gt; uint256) internal tickets;</span></pre><p id="aabd" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">接受以太的一个简单方法是将一个回退函数标记为<code class="eh mt mu mv ml b">payable</code>，并在该函数内部执行逻辑，为函数调用方的以太坊地址分配一定数量的单位成本门票。一个简单的方法可能如下所示:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="89b8" class="lc ld ht ml b fv mp mq l mr ms">uint256 internal ethusd = 700; // peg to 700 dollars<br/>uint256 internal rateInCents = 2000; // 2000 cents = $20.00</span><span id="d8a0" class="lc ld ht ml b fv mw mq l mr ms">function () payable public {</span><span id="a40b" class="lc ld ht ml b fv mw mq l mr ms">   uint256 _wei = msg.value; // 1 Ether = 1000000000000000000 wei<br/>   uint256 tickets4ETH = _wei.mul(ethusd).mul(100).div(rateInCents);<br/>   tickets[msg.sender] = tickets[msg.sender].add( tickets4ETH );</span><span id="f492" class="lc ld ht ml b fv mw mq l mr ms">}</span></pre><p id="7e3b" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">暂且忽略ETHUSD利率在现实中是不断变化的。我们代表的固定价值是每张700美元，票价是20美元。可靠性有一些限制，不允许存储浮点数。我们知道我们必须处理这个限制，我们希望确保我们有更多的<em class="jn">位置可用于执行算术运算，以便我们在乘法或除法时不损失尽可能多的精度，因此我们首先乘以100，然后将结果除以每张票的rateInCents。我们也在依靠<code class="eh mt mu mv ml b">SafeMath</code>图书馆来做<code class="eh mt mu mv ml b">mul</code>、<code class="eh mt mu mv ml b">div</code>、<code class="eh mt mu mv ml b">add</code>以及<code class="eh mt mu mv ml b">sub</code>。我们现在不讨论其中的原因，但请注意，智能合约中的任何算术运算都可能产生不良影响，有时还会出现灾难性的数据完整性问题，因此我们在执行数学运算时总是会检查溢出。</em></p><p id="d182" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">回到控制台，安装zeppelin-solidity:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="0515" class="lc ld ht ml b fv mp mq l mr ms">npm install zeppelin-solidity</span></pre><p id="d4ea" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">并且在你的文件顶部的<code class="eh mt mu mv ml b">pragma</code>行之后&amp;合同之前<code class="eh mt mu mv ml b">GreatestShow</code>:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="85f2" class="lc ld ht ml b fv mp mq l mr ms">import 'zeppelin-solidity/contracts/math/SafeMath.sol';</span></pre><p id="6511" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">然后，在实际合同中，第一行应该是:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="e021" class="lc ld ht ml b fv mp mq l mr ms">using SafeMath for uint256; // adds helper functions to uint256</span></pre><p id="2690" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">好的。我们准备好继续了！你已经创建了你的<code class="eh mt mu mv ml b">GreatestShow</code>契约，你有办法指定你的<code class="eh mt mu mv ml b">ringMaster</code>的名字，我们正在跟踪由<code class="eh mt mu mv ml b">Performance</code>结构表示的<code class="eh mt mu mv ml b">performances</code>数据结构，并保持<code class="eh mt mu mv ml b">availableSeats</code>的数量。为了确保我们能够填补这些席位，我们确保<code class="eh mt mu mv ml b">payable</code>回退功能可用，以便当客户从他们的帐户向我们发送乙醚时，我们根据他们发送给我们的数量向他们的<code class="eh mt mu mv ml b">msg.sender</code>地址分配门票价值。</p><p id="23f3" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">让我们回到控制台，准备好迎接奇迹的发生:</p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="e52f" class="lc ld ht ml b fv mp mq l mr ms"><strong class="ml hu">truffle compile</strong></span><span id="1b46" class="lc ld ht ml b fv mw mq l mr ms">Compiling ./contracts/GreatestShow.sol...</span><span id="1f48" class="lc ld ht ml b fv mw mq l mr ms">Compiling zeppelin-solidity/contracts/math/SafeMath.sol...</span><span id="c14b" class="lc ld ht ml b fv mw mq l mr ms">Writing artifacts to ./build/contracts</span></pre></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><p id="6641" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">完全公开:我们故意在应用程序中留下了几个bug，我们将在下一集解决它们，在下一集我们将研究如何测试我们的智能契约。代码编译不代表它<em class="jn">逻辑正确；</em>这仅仅意味着代码在语法上是正确的。对于智能合约，测试是必不可少的。过去，开发人员可以简单地停止服务器，恢复他们控制的数据库中的更改，并修补一个错误。但我们正处于一个新的范式中。<a class="ae kl" rel="noopener" href="/coinmonks/stop-the-erc20-fud-just-learn-and-buidl-47871067362c">我们部署到区块链的代码是不可变的。</a></p><h2 id="7348" class="lc ld ht bd le lf lg lh li lj lk ll lm ki ln lo lp kj lq lr ls kk lt lu lv lw dt translated">你成功了！</h2><p id="c232" class="pw-post-body-paragraph jl jm ht jo b jp lx iu jr js ly ix ju ki lz jx jy kj ma kb kc kk mb kf kg kh hm dt translated">恭喜你！您现在知道如何使用Solidity和Truffle框架#构建您的第一个基于以太坊区块链的智能合约！</p><blockquote class="ji jj jk"><p id="1b4f" class="jl jm jn jo b jp jq iu jr js jt ix ju jv jw jx jy jz ka kb kc kd ke kf kg kh hm dt translated">别管笼子了，因为我们知道怎么做钥匙。<br/>哦！该死，你突然可以自由飞翔了。我带你去另一边。</p></blockquote><figure class="kn ko kp kq fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="fe ff km"><img src="../Images/e03baf46be30f33c99d2f6b9a26efb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9Dv5HJuI-slQurLSMJnPQ.png"/></div></div></figure><p id="699e" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated">如果你被困住了，不要害怕。我有一份完整的项目副本，你可以从一个公共的<a class="ae kl" href="https://github.com/emmonspired/ComeOneComeAll/" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>下载，在那里你可以将你的代码与我已经检查过的工作示例进行比较。</p><figure class="kn ko kp kq fq kr"><div class="bz el l di"><div class="nh ni l"/></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">Greatest Showman, 2017</figcaption></figure><p id="9f32" class="pw-post-body-paragraph jl jm ht jo b jp jq iu jr js jt ix ju ki jw jx jy kj ka kb kc kk ke kf kg kh hm dt translated"><em class="jn"> Dan Emmons是</em><a class="ae kl" href="http://www.emmonspired.com/" rel="noopener ugc nofollow" target="_blank"><em class="jn">Emmons pired LLC</em></a><em class="jn">的所有者，一名</em> <a class="ae kl" href="http://cryptoconsortium.org/lookup/6f0d14" rel="noopener ugc nofollow" target="_blank"> <em class="jn">认证比特币专业人士</em> </a> <em class="jn">，认证以太坊开发者，全栈开发者，加密货币项目顾问。他还是一个名为</em><a class="ae kl" href="https://www.youtube.com/watch?v=SVBZ7mdgGcA" rel="noopener ugc nofollow" target="_blank"><em class="jn"># ByteSizeBlockchain</em></a><em class="jn">的Youtube频道和iTunes播客的创作者。</em></p></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><h1 id="1a0c" class="nj ld ht bd le nk nl nm li nn no np lm iz nq ja lp jc nr jd ls jf ns jg lv nt dt translated">完整代码示例</h1><p id="e7be" class="pw-post-body-paragraph jl jm ht jo b jp lx iu jr js ly ix ju ki lz jx jy kj ma kb kc kk mb kf kg kh hm dt translated"><strong class="jo hu">注意:</strong>我们将在以后的文章中进行一些代码编辑(重构)。<br/>这篇文章的目的是让你兴奋起来，激发你的想象力。在一篇文章中不一定能涵盖好的或专业的编程技术和代码风格的每个方面，我们也不想让你第一次尝试就不知所措。谢谢你远道而来。<strong class="jo hu">继续前进！</strong></p><pre class="kn ko kp kq fq mk ml mm mn aw mo dt"><span id="870c" class="lc ld ht ml b fv mp mq l mr ms">pragma solidity ^0.4.23;</span><span id="4b53" class="lc ld ht ml b fv mw mq l mr ms">import 'zeppelin-solidity/contracts/math/SafeMath.sol';</span><span id="9389" class="lc ld ht ml b fv mw mq l mr ms">contract GreatestShow {<br/>  <br/>  address public owner;<br/>  string public ringMaster;</span><span id="185f" class="lc ld ht ml b fv mw mq l mr ms">  constructor(string _ringMaster) public {<br/>    owner = msg.sender;<br/>    ringMaster = _ringMaster;<br/>  }</span><span id="cef5" class="lc ld ht ml b fv mw mq l mr ms">  uint availableSeats;</span><span id="1ce6" class="lc ld ht ml b fv mw mq l mr ms">  function setAvailableSeats( uint _availableSeats ) public {<br/>      availableSeats = _availableSeats;<br/>  }<br/>  <br/>  function getAvailableSeats() view public returns(uint) {<br/>      return availableSeats;<br/>  }</span><span id="826e" class="lc ld ht ml b fv mw mq l mr ms">  struct Performance {<br/>    string name;</span><span id="0b5e" class="lc ld ht ml b fv mw mq l mr ms">    uint32 actors;</span><span id="83cd" class="lc ld ht ml b fv mw mq l mr ms">    uint8 tigers;<br/>    uint8 bears;<br/>    uint8 elephants;</span><span id="6784" class="lc ld ht ml b fv mw mq l mr ms">    uint16 timeInSeconds;</span><span id="46e8" class="lc ld ht ml b fv mw mq l mr ms">    bool clearTheStageFirst;<br/>  }</span><span id="d707" class="lc ld ht ml b fv mw mq l mr ms">  Performance[] performances;<br/>    <br/>  function addPerformance( <br/>              string _name,<br/>              uint32 _actors,                              <br/>              uint8 _tigers, <br/>              uint8 _bears,<br/>              uint8 _elephants, <br/>              uint16 _timeInSeconds,<br/>              bool _clearTheStageFirst ) public returns(uint) {</span><span id="f15c" class="lc ld ht ml b fv mw mq l mr ms">      performances.push( <br/>          Performance( { name: _name, actors: _actors, <br/>              tigers: _tigers, bears: _bears, <br/>              elephants: _elephants,<br/>              timeInSeconds: _timeInSeconds,<br/>              clearTheStageFirst: _clearTheStageFirst } <br/>          ) <br/>      );</span><span id="93c3" class="lc ld ht ml b fv mw mq l mr ms">      return performances.length;<br/>  }<br/> <br/>  function getPerformance( uint _index ) view public <br/>      returns (string, uint32, uint8, uint8, uint8, uint16, bool) {</span><span id="3f52" class="lc ld ht ml b fv mw mq l mr ms">      Performance storage perf = performances[_index];<br/>      return (perf.name, perf.actors, perf.tigers, perf.bears, <br/>       perf.elephants, perf.timeInSeconds, perf.clearTheStageFirst);<br/>  }</span><span id="f279" class="lc ld ht ml b fv mw mq l mr ms">mapping(address =&gt; uint256) internal tickets;</span><span id="9b94" class="lc ld ht ml b fv mw mq l mr ms">uint256 internal ethusd = 700; // peg to 700 dollars<br/>uint256 internal rateInCents = 2000; // 2000 cents = $20.00</span><span id="4922" class="lc ld ht ml b fv mw mq l mr ms">using SafeMath for uint256;</span><span id="e088" class="lc ld ht ml b fv mw mq l mr ms">  function () payable public {     <br/>    uint256 _wei = msg.value; // 1 Ether = 1000000000000000000<br/>    uint256 tickets4ETH =_wei.mul(ethusd).mul(100).div(rateInCents);<br/>    tickets[msg.sender] = tickets[msg.sender].add( tickets4ETH );     <br/>  }<br/>      <br/>}</span></pre></div></div>    
</body>
</html>