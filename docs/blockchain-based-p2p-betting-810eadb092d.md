# 基于区块链的 P2P 博彩

> 原文：<https://medium.com/coinmonks/blockchain-based-p2p-betting-810eadb092d?source=collection_archive---------5----------------------->

以太坊网络(Ethereum network)在区块链开发人员的狭小圈子里广为人知，它已经成为智能合约开发的一个便捷而稳定的平台。我们正在尝试让没有准备好用户可以使用智能合同，提供简单但实用的合同。我们最近开发了名为 Bet Me 的智能赌博合同。

合同的核心是两个对手的赌注。他们用金钱打赌来增强对自己权利的信心。输家赔钱，赢家全拿。在本文中，我将更详细地介绍这一点。

![](img/c5c723bba7e82fc7ced076c19f16c1c6.png)

# 区块链和这有什么关系？

让我们从一个关于区块链的文章的作者很少问的问题开始:在这种情况下，区块链真的有必要吗？什么任务在口头或法律协议的帮助下很难解决，但在区块链的帮助下很容易解决？

如果两个人有一个面对面的争论，这通常会导致一个新的审判。“我不是这个意思”，“外部环境影响了结果；否则我就是对的”，“我并没有真的和你打赌，你只是瞎编的”和其他可能的借口，典型的用于那些彼此很了解并且没有下太多赌注的人之间的口头赌注。

如果是严肃的赌注和相对较远的熟人，通常建议签订一份书面协议，并在协议中详细说明争议的实质、费率、做出决定的标准以及双方认为重要的任何其他条件。这种方法有许多局限性。

*   最常见的是需要一名律师，甚至两名律师，双方各一名；否则，可能会忘记重要的一点，这可能会导致经济损失。
*   合同通常只包括双方的义务，而不包括可能违反义务的责任。因此，一方不付款太容易了，而另一方通过法院得到他们的钱又极其困难和昂贵。
*   也可能是双方都坚持自己的对，即使诉诸法庭也不能保证赢的人能拿到钱。
*   也可能是败诉方没有钱，即使法院判决也不会强制其还债，尽管承担了所有的义务。

区块链(尤其是以太坊网络)支持与金钱打交道。(我们将以太坊加密货币称为货币；虽然它不完全正确，但它很方便，反映了真实的事态，因为以太坊可以很容易地兑换成法定货币，反之亦然)。同时，在以太坊中，可以将协议设置为一组特定的规则；不实现这些目标是完全不可能的。因此，我们的智能合约从每一方收取资金，并将其冻结，直到特定事件的发生。一套特定的程序规则将允许赢家提款。这正是我们所需要的。

# 履行

一套管理争议的规则可以通过多种方式实施。下面，我们就来说说我们为 Smartz 平台的用户做了什么。

双方参与了一场打赌。在以太坊网络上创建合同的人被称为[合同]的所有者，他的交易对手被称为对手。合同所有者指定一个他/她认为是真实的文本声明。对手打赌这个陈述是错误的。争议的结果由一个独立的仲裁者决定，其候选资格得到业主和反对者的认可。仲裁人从争议金额中收取一定比例的佣金。

合同工作分为几个连续的阶段。

1.  **谈判**。在创建合同之前，所有者和对手可以以任何方便的方式进行谈判。共同决定仲裁人后，他们向候选人发出邀请，监督他们的赌注。收到邀请后，仲裁器将看到所有条件和相应的状态。下面将详细介绍，但现在重要的是要理解未来的仲裁人必须将这个数字转移到合同中，以表明他/她愿意根据什么条件来判断下注方。如果业主已经建立了一个非零保证金(ArbiterPenaltyAmount)，然后，同意该条款，仲裁人必须将指定数量的乙醚转移到合同中。之后，相应的金额被冻结，直到仲裁员对投注方做出判决，或者直到解决争议的最后期限。在后一种情况下，仲裁人失去了提取保证金的机会，这笔金额在投注各方之间平均分配。
2.  **初始化**。契约所有者创建契约的实例并配置其参数:打赌的主题；仲裁人必须做出决定的截止日期(截止日期)；仲裁者佣金的百分比(分数≥ 0 且<100)；ArbiterPenaltyAmount 保证金的金额(可能是零)，仲裁人必须保证他/她将在必要时以可用的措辞来判断赌注。所有者还设置他/她信任的仲裁器的以太坊地址。只有这个地址的所有者以后才能成为仲裁者。
3.  **老板的赌注**。在配置之后，合同的所有者下注。为此，他/她将任何数量的乙醚转移到合同中。这个金额就是赌注，它保存在合同的地址。
4.  **仲裁者协议**。主人的赌注设定了赌注的条款。现在，仲裁者看到了交易的全部条款:赌注的措辞，必须做出决定的时间，最重要的是，可以了解他/她将获得多少奖励。如果仲裁人对条款满意，他/她确认他/她的参与并同时转移保证金。
5.  **寻找对手**。仲裁人同意后，开始寻找对手。如果他/她准备只与某个特定的人打赌，则所有者要么预先设置对手的地址，要么将该地址留空。在这种情况下，网络上任何地址的所有者(仲裁人和所有者除外)都可以成为对手。对手确认参与打赌，调用一个单独的契约方法，在该方法中，他/她传输当前的数据版本号和与所有者打赌一样多的以太网。从这一刻起，赌注被认为已经下了。现在，合同要么等待仲裁人的决定，要么等待最后期限。
6.  **打赌的结果**。仲裁者可以用三种方式来判断争议。
    ——承认索赔是真实的。在这种情况下，除了仲裁人的佣金费用和保证金(如果适用)之外，合同所有者可以提取全部以太量:这笔钱由仲裁人提取，对手什么也得不到。
    —承认索赔是虚假的。在这种情况下，仲裁人可以提取应付给他的佣金和保证金。对手拿走剩下的，主人什么也得不到。
    ——宣布赌注未定。例如，所有者用“A 队和 B 队之间的足球比赛定于下周日进行，结果将是 A 队以 2:1 获胜”的说法制造了一场纠纷。如果比赛被取消，仲裁人不会解决赌注，但他应该可以收回他/她的押金，因为问题不是他的错。在这种情况下，每一方都可以请求按照他们自己的费率从合同地址向他们的钱包转账。
7.  **取钱**。当仲裁人做出决定或截止日期到来时，任何一方都可以请求撤销仲裁。合同本身会根据赌注的结果计算出有多少乙醚可以提取。
8.  **毁约**。所有者可以向契约发送自毁命令。这可以在交易结束之前(如果没有找到仲裁人)或交易完成之后(如果所有各方都提取了应付给他们的资金)完成。如果(由于某种原因)合同地址收到的以太比计划的多，那么这样的机会将是有用的。这种事件发生的概率很低，但是在以太坊网络上，一个人不可能完全屏蔽广播到任意契约地址的翻译，扔冻结的钱是愚蠢的。

现在，我们来了解一下为什么需要州版本号。这个数字随着赌注的重大条款的每次变化而增加，比如争议的措辞、仲裁人佣金或罚款的金额。当有人同意打赌的条件时，他/她 1)看到数据的实际状态；2)向契约发送方法调用，以注册对条款的遵从。如果在这两个事件之间，其中一方(很可能是所有者)更改了合同参数，它将与另一个数据版本一致。

例如，一个候选仲裁人进入 smartz.io 的合同界面，看到他/她被提供为 10 Ether(今天大约是 3000 美元)争议作出裁决，佣金为 1 %(大约 30 美元)。候选人欣然同意，并将确认的交易发送到网络。一个不诚实的业主看到矿池中仲裁者的一个未处理的交易，发送自己的:将仲裁者的佣金费用改为 0 %。作弊者将天然气价格定在平均价格之上，在某种可能性下，矿工可以更早地处理他或她的交易。

这被称为前跑攻击。状态版本号可以防止这种攻击。如果事务处理得更早，合同中数据的版本号将会改变。仲裁器在他的事务中发送的数据版本号少了一个。因此，契约将拒绝执行事务，并发生回滚。仲裁器将审查新条款，并通过发送当前数据版本号来拒绝参与或同意。

当开发一个使用以太网的契约时，我们必须考虑很多不好的情况。如果合同的所有者决定欺骗仲裁人，会发生什么？如果仲裁者被证明是不诚实的呢？而如果对手其实是黑客呢？还是三人都想欺骗对方，因为赌注已经够高了？此外，还必须考虑到违反正常下注过程的任何可能性，此时以太将在合同中被阻止，甚至所有者也无法访问它。

例如，在实施过程中已经出现了将赌注认定为不可解决的选项。同理，下注的阶段顺序如下:主人下注->仲裁人选择->对手下注。可能是对手还没有确认参赛，截止日期定的很远。为了不变成长期投资者，仲裁者可能会拒绝参与，但只是在对手下注之前。而且合同里还有很多这样的细微差别。

好消息是，它需要被编程一次，并进一步使用。如果赌注被正式化为书面合同，在这种边缘情况下，许多人将不得不一次又一次地进入每一点，并就如何解释它进行谈判。区块链让人们设置条件，就像在合同中一样，同时将条件的解释强加给虚拟机，并且总是有一个且只有一个执行结果。

人们不能忽视一个感兴趣的仲裁者的问题。在我们的合同中，仲裁人独自决定。对于简单的情况，这就足够了，但有时仲裁者个人利益的风险是不可接受的。解决方案之一是在合同逻辑中引入增加几个仲裁人并通过投票做出决定的可能性。这是一个相当复杂的逻辑，尤其是如果你想把它通用于所有可能的赌注及其参与者。然而，好消息是，复杂的集体仲裁的所有逻辑都可以做成一个单独的智能合同。打赌的主人将注册合同的地址作为仲裁者。从接口的角度来看，这样的契约应该可以从下注契约中调用几种方法:判断下注的同意，拒绝提供这样的同意，判决的三个版本和以太撤的一个方法。在仲裁契约中，大多数仲裁员都可以使用决策逻辑，就像多签名钱包契约中的决策逻辑一样，它也可以作为构造器在 Smartz.io 上使用。

对于一些赌注，你可以用一个使用一个或多个神谕的契约来代替一组仲裁者。或者想出另一条出路(例如，通过随机决策将赌注变成类似轮盘赌的场景)。所有这一切——不改变赌注的合同代码，也不使其工作逻辑复杂化。

# 测试

我们想说几句关于测试的话。每个人都知道自动化测试是好的。许多人实际上自己为他们的代码编写测试。一些人在开发中使用 TDD 方法——一种长期的和众所周知的测试驱动开发。TDD 和简单测试的关键区别在于测试比代码写得早。这允许您从外部查看合同代码，体验可能出现的问题并提前解决它们。此外，当正确使用时，如果突然需要，TDD 允许您更快地改变工作的逻辑。正确的使用来自经验。TDD 并不是银弹，正如人们在阅读关于这个主题的大量资料时所想的那样。也就是说，令人担忧的是，Truffle 和 Node.js 上的开发指南并没有展示在 Solidity 上使用 TDD 进行开发。初级开发人员养成了坏习惯，结果吃了很多苦头。

TDD 意味着项目中有大量的测试。例如，bet 合同代码需要 325 行，而该合同的测试代码由 2，144 行组成。在某些时候，有足够的测试来运行松露测试超过一分钟。TDD 中的开发周期意味着在小的代码变更之后频繁地运行测试。为了使开发不变得痛苦，必须教会 Truffle 只运行与转换的正则表达式相一致的那部分测试。

在幕后，Truffle 使用 Mocha 框架来处理测试。Mocha 能够过滤常规测试的启动，但是 Truffle 不能从命令行传输相应的参数——grep。利用 Truffle 配置是常规 JavaScript 代码这一事实，我输入了 Mocha 的命令行参数解析和参数形成。我最终得到的配置文件可以在该项目的 GitHub 上找到。实现不是很漂亮，但是很管用，节省了很多时间。

# 摘要

争议契约被认为在功能方面非常简单，但是由于 TDD 和对可能的攻击媒介的分析，它已经发展成为在限制方面稍微丰富一些的实现。合同的明显缺陷与仲裁人的唯一决定有关；然而，如果几个仲裁人的投票系统在单独的智能合同中实现，则可以在不修改赌注的合同代码的情况下消除它们。以同样的方式，使用神谕来解决争端，这是可能的。

BetMe bet 合约可以在 [Smartz](https://smartz.io/) 平台上使用现成的模板进行测试和运行。这需要为桌面浏览器或移动设备的信任钱包提供元掩码扩展。另外，契约本身的源代码可以在 GitHub 上找到。

值得承认的是，今天区块链技术的使用基本上已经减少到加密货币和 ICO 代币的发行。分散自治组织(DAO)尚未成为现实。但是，如果您考虑 bet 结算系统将如何进一步发展，您可以提交一份带有评级的仲裁员登记册(例如，基于令牌管理的登记册)。下注完成后，参与者可以投票支持或反对与他们交易的仲裁员，从而改变他们在排名中的位置。

一方面，BetMe 争议合同是一个实际适用的自足要素。另一方面，它很可能成为一块砖，去中心化组织的生态系统最终将从这块砖中演化出来。

# 参考

*   GitHub: BetMe 智能合约【https://github.com/smartzplatform/betme-ether 
*   BetMe — Smartz 平台 Wiki【https://wiki.smartz.io/en/betme 
*   令牌管理的注册中心 1.0[https://medium . com/@ ilovebagels/令牌管理的注册中心-1-0-61a232f8dac7](/@ilovebagels/token-curated-registries-1-0-61a232f8dac7)
*   元掩码扩展 [https://metamask.io](https://metamask.io/)
*   信托——以太坊& ERC20 钱包[https://trustwalletapp.com](https://trustwalletapp.com/)

> [在您的收件箱中直接获得最佳软件交易](https://coincodecap.com/?utm_source=coinmonks)

[![](img/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png)](https://coincodecap.com/?utm_source=coinmonks)