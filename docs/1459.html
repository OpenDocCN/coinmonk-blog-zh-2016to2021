<html>
<head>
<title>Ethernaut Lvl 14 Gatekeeper 2 Walkthrough: How contracts initialize (and how to do bitwise operations)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 14 Gatekeeper 2演练:协定如何初始化(以及如何进行位运算)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-14-gatekeeper-2-walkthrough-how-contracts-initialize-and-how-to-do-bitwise-ddac8ad4f0fd?source=collection_archive---------3-----------------------#2018-09-05">https://medium.com/coinmonks/ethernaut-lvl-14-gatekeeper-2-walkthrough-how-contracts-initialize-and-how-to-do-bitwise-ddac8ad4f0fd?source=collection_archive---------3-----------------------#2018-09-05</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一部<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank">齐柏林</a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这个关卡需要你熟悉<a class="ae ji" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank">以太坊黄皮书</a>并再通过三道关卡。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2680" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">合同创建的内部工作方式</h1><p id="46cf" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">黄皮书将合同创建正式表示为:</p><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="fe ff lj"><img src="../Images/9941d4b04be809e8b9036254c776a36c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xG42ImBtHKw5AZR1bWcz8Q.png"/></div></div></figure><p id="9d4c" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><strong class="jl hu">以下是如何创建合同的简化流程以及这些变量的含义:</strong></p><ol class=""><li id="e8b7" class="lv lw ht jl b jm jn jp jq js lx jw ly ka lz ke ma mb mc md dt translated">首先，创建合同的交易<em class="me">被发送到以太网。该交易包含输入变量，特别是:</em></li></ol><ul class=""><li id="0906" class="lv lw ht jl b jm jn jp jq js lx jw ly ka lz ke mf mb mc md dt translated"><strong class="jl hu">发送方</strong>:这是想要创建新合同的<em class="me">直接</em>合同或外部钱包的地址。</li><li id="ff1f" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><a class="ae ji" rel="noopener" href="/@nicolezhu/ethernaut-lvl-4-walkthrough-how-to-abuse-tx-origin-msg-sender-ef37d6751c8"> <strong class="jl hu">原交易人(o) </strong> </a>:创建合同的<em class="me">原</em> <em class="me">外部钱包</em>(用户)。注意<code class="eh ml mm mn mo b">o != s</code>如果用户使用一个工厂合同来创建更多的合同！</li><li id="5b02" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><strong class="jl hu">可用气体(g) </strong>:这是用户指定的、分配给合同创建的总气体。</li><li id="9a52" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><strong class="jl hu">天然气价格(p) </strong>:这是单位天然气的市场价格，将交易成本转换为乙醚。</li><li id="214f" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><strong class="jl hu">禀赋(v) </strong>:这是<code class="eh ml mm mn mo b">value</code>(在魏那里)被转移来播种这个新合同。默认值为零。</li><li id="0e1c" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><strong class="jl hu">初始化EVM代码(i) </strong>:这是你的新契约的<code class="eh ml mm mn mo b">constructor</code>函数和初始化变量中的所有东西，以字节码的格式。</li></ul><p id="8215" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.第二，仅基于交易的输入数据，新合同的指定地址被(预先)计算。在这个阶段，输入状态值被修改，但是新契约的状态仍然为空。</p><p id="b345" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.第三，初始化代码在EVM启动，并创建一个实际的合同。</p><p id="594b" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.在这个过程中，状态变量被改变，数据被存储，气体被消耗和扣除。</p><p id="5883" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">5.一旦契约完成初始化，它就存储它自己的与其(预先)计算的地址相关联的代码。</p><p id="a609" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">6.最后，剩余的gas和一个成功/失败消息被异步返回给发送方<code class="eh ml mm mn mo b">s</code>。</p><blockquote class="mp mq mr"><p id="cca1" class="jj jk me jl b jm jn iu jo jp jq ix jr ms jt ju jv mt jx jy jz mu kb kc kd ke hm dt translated"><strong class="jl hu">提示:</strong>请注意，在第5步之前，新合同的地址中不存在任何代码！</p></blockquote><p id="03a6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在黄皮书的脚注中:</p><blockquote class="mv"><p id="47b5" class="mw mx ht bd my mz na nb nc nd ne ke ek translated">在初始化代码执行期间，地址上的EXTCODESIZE应返回零，这是帐户代码的长度，而CODESIZE应返回初始化代码的长度(如H.2中所定义的</p></blockquote><p id="33d6" class="pw-post-body-paragraph jj jk ht jl b jm nf iu jo jp ng ix jr js nh ju jv jw ni jy jz ka nj kc kd ke hm dt translated"><strong class="jl hu">简而言之</strong>，如果您试图在合约构建之前或构建期间检查智能合约的代码大小，您将得到一个空值。这是因为智能契约还没有形成，因此不能自我认识到它自己的代码大小。</p><h1 id="f417" class="km kn ht bd ko kp nk kr ks kt nl kv kw iz nm ja ky jc nn jd la jf no jg lc ld dt translated">位运算</h1><p id="3345" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">Solidity支持以下逻辑门操作:</p><ul class=""><li id="08df" class="lv lw ht jl b jm jn jp jq js lx jw ly ka lz ke mf mb mc md dt translated"><code class="eh ml mm mn mo b">&amp;</code> : and(x，y)<strong class="jl hu">x和y的按位</strong>；其中<code class="eh ml mm mn mo b">1010 &amp; 1111 == 1010</code></li><li id="b5fc" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><code class="eh ml mm mn mo b">|</code> : or(x，y)<strong class="jl hu">x和y的按位</strong>or；其中<code class="eh ml mm mn mo b">1010 | 1111 == 1111</code></li><li id="448e" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><code class="eh ml mm mn mo b">^</code> : xor(x，y)<strong class="jl hu">x和y的按位</strong>xor；其中<code class="eh ml mm mn mo b">1010 ^ 1111 == 0101</code></li><li id="e4c1" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated"><code class="eh ml mm mn mo b">~</code>:not(x)<strong class="jl hu">x的按位</strong>；其中<code class="eh ml mm mn mo b">~1010 == 0101</code></li></ul><h2 id="d7a3" class="np kn ht bd ko nq nr ns ks nt nu nv kw js nw nx ky jw ny nz la ka oa ob lc oc dt translated">通知；注意</h2><ul class=""><li id="f551" class="lv lw ht jl b jm le jp lf js od jw oe ka of ke mf mb mc md dt translated">如果<code class="eh ml mm mn mo b">A xor B = C</code>，那么<code class="eh ml mm mn mo b">A xor C = B</code></li><li id="9681" class="lv lw ht jl b jm mg jp mh js mi jw mj ka mk ke mf mb mc md dt translated">在Solidity中，取幂由<code class="eh ml mm mn mo b">**</code>处理，而不是<code class="eh ml mm mn mo b">^</code></li></ul><p id="8c06" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">你现在有所有的知识来解决水平！</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">详细演练</h1><figure class="lk ll lm ln fq lo fe ff paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="fe ff og"><img src="../Images/e32510e9a03828fb1518dd56cf4d9f14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RL2dbRL7B2jS7zab0EmKLw.png"/></div></div></figure><ol class=""><li id="eee1" class="lv lw ht jl b jm jn jp jq js lx jw ly ka lz ke ma mb mc md dt translated">通过在<a class="ae ji" href="http://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank"> Remix IDE </a>中创建一个智能合同中间人来通过第一关:</li></ol><pre class="lk ll lm ln fq oh mo oi oj aw ok dt"><span id="8d6d" class="np kn ht mo b fv ol om l on oo">contract Hack {<br/>}</span></pre><p id="9834" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">接下来，让我们在2之前通过门3，因为<code class="eh ml mm mn mo b">key</code>值是在门2调用函数的先决条件。要解决3号门，请注意:</p><pre class="lk ll lm ln fq oh mo oi oj aw ok dt"><span id="84df" class="np kn ht mo b fv ol om l on oo">uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(0) — 1)</span></pre><p id="f652" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.回想一下，如果如果<code class="eh ml mm mn mo b">A xor B = C</code>，那么<code class="eh ml mm mn mo b">A xor C = B</code>。这意味着密钥只是以下内容的<code class="eh ml mm mn mo b">bytes8</code>类型转换:</p><pre class="lk ll lm ln fq oh mo oi oj aw ok dt"><span id="5073" class="np kn ht mo b fv ol om l on oo">uint64(_gateKey) = uint64(keccak256(msg.sender)) ^ uint64(0) — 1)</span></pre></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><p id="d795" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">最后，注意Gate 3使用一个汇编函数来检查调用契约的<strong class="jl hu">大小是否为零，即包含0代码</strong>。但是，为了调用GatekeeperTwo，您的调用契约首先必须有代码。</p><pre class="lk ll lm ln fq oh mo oi oj aw ok dt"><span id="f3c9" class="np kn ht mo b fv ol om l on oo">assembly { x := extcodesize(caller) }</span></pre><p id="0ae6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><em class="me">那么这怎么可能呢？</em></p><p id="5e84" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><strong class="jl hu">回想一下，在契约的构造过程中，它从其(预先)计算的地址部署代码，但是该代码还没有与契约本身相关联地存储！</strong></p><p id="cbf1" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这意味着如果<code class="eh ml mm mn mo b">extcodesize</code>是发送方契约的原始<code class="eh ml mm mn mo b">constructor</code>函数中的子例程，那么<code class="eh ml mm mn mo b">extcodesize(sender)</code>应该返回0。</p><p id="ca90" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.将<code class="eh ml mm mn mo b">enter()</code>函数调用放入您的<code class="eh ml mm mn mo b">Hack.sol</code>的合同构造中:</p><figure class="lk ll lm ln fq lo"><div class="bz el l di"><div class="op oq l"/></div></figure><p id="5ac2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">恭喜你通过了两道门！</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">关键安全要点</h1><ul class=""><li id="1e23" class="lv lw ht jl b jm le jp lf js od jw oe ka of ke mf mb mc md dt translated">除了<a class="ae ji" rel="noopener" href="/coinmonks/ethernaut-lvl-7-walkthrough-how-to-selfdestruct-and-create-an-ether-blackhole-eb5bb72d2c57">契约黑洞</a>之外，还可以通过停止契约初始化来创建僵尸契约。由此产生的合同有一个地址，但永久没有代码，并且永远无法返回您最初的<strong class="jl hu">捐赠</strong>。</li></ul><h1 id="5396" class="km kn ht bd ko kp nk kr ks kt nl kv kw iz nm ja ky jc nn jd la jf no jg lc ld dt translated">更多级别</h1><div class="or os fm fo ot ou"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-13-gatekeeper-1-walkthrough-how-to-calculate-smart-contract-gas-consumption-and-eb4b042d3009"><div class="ov ab ej"><div class="ow ab ox cl cj oy"><h2 class="bd hu fv z el oz eo ep pa er et hs dt translated">Ethernaut Lvl 13看门人1演练:如何计算智能合同用气量(和…</h2><div class="pb l"><h3 class="bd b fv z el oz eo ep pa er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pc l"><p class="bd b gc z el oz eo ep pa er et ek translated">medium.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi lt ou"/></div></div></a></div><div class="or os fm fo ot ou"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-15-naught-coin-walkthrough-how-to-abuse-erc20-tokens-and-bad-icos-6668b856a176"><div class="ov ab ej"><div class="ow ab ox cl cj oy"><h2 class="bd hu fv z el oz eo ep pa er et hs dt translated">以太币15级零硬币演练:如何滥用ERC20代币和坏ico</h2><div class="pb l"><h3 class="bd b fv z el oz eo ep pa er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pc l"><p class="bd b gc z el oz eo ep pa er et ek translated">medium.com</p></div></div><div class="pd l"><div class="pj l pf pg ph pd pi lt ou"/></div></div></a></div><blockquote class="mv"><p id="7f9e" class="mw mx ht bd my mz pk pl pm pn po ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="pq pr ps pt pu lo fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff pp"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>