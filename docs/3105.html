<html>
<head>
<title>Using IPFS + FileCoin for decentralised storage with Powergate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Powergate将IPFS + FileCoin用于分散式存储</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/using-ipfs-filecoin-for-decentralised-storage-with-powergate-71ffe42f8c09?source=collection_archive---------2-----------------------#2020-06-29">https://medium.com/coinmonks/using-ipfs-filecoin-for-decentralised-storage-with-powergate-71ffe42f8c09?source=collection_archive---------2-----------------------#2020-06-29</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="df96" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我正在使用<a class="ae jo" href="https://filecoin.io/" rel="noopener ugc nofollow" target="_blank"> FileCoin </a>为一个我计划在<a class="ae jo" href="https://hackfs.com/" rel="noopener ugc nofollow" target="_blank"> HackFS </a>期间开发的应用程序设计一个分散式存储模型。作为Filecoin的新手，我对如何有效地使用它来满足我的应用程序的存储需求有些疑问。</p><p id="5b6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">例如，我发现很难为我的应用程序设计一个基于存储交易的工作流。用户是否需要为每次新文件上传创建新的存储交易？我们需要订阅模式吗？如何续签即将到期的存储协议？</p><p id="0c86" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是我偶然发现<a class="ae jo" href="https://textile.io/" rel="noopener ugc nofollow" target="_blank">纺织</a>的<a class="ae jo" href="https://docs.textile.io/powergate/" rel="noopener ugc nofollow" target="_blank"> Powergate </a>。它似乎通过其FFS (Filecoin文件存储)模块回答了上述大部分问题，我立即想首先在一个支持以下功能的应用程序上测试它:</p><ul class=""><li id="616a" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">用户登录(为每个用户创建FFS实例)</li><li id="f109" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">允许用户录制音频</li><li id="9706" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">保存/删除录制的音频</li><li id="e8a5" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">从IPFS检索音频内容并播放。</li></ul><p id="e476" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为什么要采用这种基于特定音频内容的工作流程？稍后我会谈到这一点，以及如何使用Powergate实现这些功能；首先，我们需要对Powergate做一个简单的概述。</p><h1 id="533b" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">Powergate的(非常)简要概述</h1><blockquote class="lb lc ld"><p id="9cd2" class="iq ir le is b it iu iv iw ix iy iz ja lf jc jd je lg jg jh ji lh jk jl jm jn hm dt translated">Powergate是一个API驱动的解决方案，用于跨<a class="ae jo" href="https://filecoin.io/" rel="noopener ugc nofollow" target="_blank"> Filecoin </a>和<a class="ae jo" href="https://ipfs.io/" rel="noopener ugc nofollow" target="_blank"> IPFS </a>部署多层存储。Filecoin上的持久存储允许对数据进行丰富的存储配置，如复制因子、矿工选择、交易续订和维修</p></blockquote><p id="2118" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">上述定义中的一个关键点是<code class="eh li lj lk ll b">multitiered</code>。基本上，Powergate有热存储层和冷存储层，IPFS节点充当热缓存层，Filecoin充当冷持久层。</p><p id="842b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过Powergate存储新数据包括将数据添加到热IPFS层，并将返回的CID的配置推送到Filecoin。通过其CID识别的数据可以通过Powergate客户端从IPFS检索回来。如果IPFS上的CID不可用，可以在配置的超时后自动从Filecoin检索数据。</p><blockquote class="lb lc ld"><p id="770a" class="iq ir le is b it iu iv iw ix iy iz ja lf jc jd je lg jg jh ji lh jk jl jm jn hm dt translated">这是一个非常简短的概述。我鼓励你仔细阅读Powergate文档，寻找更好的想法。我在“进一步阅读”部分列出了一些帮助我开始阅读的资源。</p></blockquote><h1 id="6b4f" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">那么如何在应用中使用Powergate呢？</h1><p id="9c69" class="pw-post-body-paragraph iq ir ht is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hm dt translated">当我浏览了Powergate文档后，为这个应用程序设计一个基本的设计就相对容易了。下图提供了设计和连接组件的概述。</p><figure class="ls lt lu lv fq lw fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/2ecf4ca015f078a9958f20749af1035e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*c8ItwTbV-a6k5LtKPVzqfQ.jpeg"/></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">High level design for an application using Powergate.</figcaption></figure><p id="bcd0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们从这个设计图中列出主要的交互组件。</p><ul class=""><li id="5dcd" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">一个苗条的前端</li><li id="d3d5" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">转到后端</li><li id="ced9" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">PostgreSQL数据库</li><li id="6b3b" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">Powergate devnet实例(IPFS + Filecoin支持的存储)</li></ul><p id="b11d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如图所示，前端和后端都需要直接与Powergate devnet实例进行交互。</p><p id="eafd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">那么为什么前端需要和Powergate交互呢？</p><ul class=""><li id="787e" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">保存录制的音轨(上传数据)</li><li id="25bb" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">检索要播放的音轨数据(检索数据)</li></ul><p id="a3c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是要向FFS发出这些上传和检索请求，我们需要包含一个FFS令牌进行身份验证。</p><p id="c480" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们从哪里得到这个FFS代币？</p><p id="7e8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">后端在接收到用户登录请求时，检查是否有任何FFS令牌与用户相关联。如果不存在这样的令牌，则向Powergate发送一个请求，请求<strong class="is hu">创建一个新的FFS实例</strong>及其相应的auth令牌。用这个令牌更新DB上的用户模型，并用这个令牌响应登录请求。</p><h2 id="c9ec" class="md ke ht bd kf me mf mg kj mh mi mj kn jb mk ml kr jf mm mn kv jj mo mp kz mq dt translated">创建新的FFS实例</h2><p id="f46f" class="pw-post-body-paragraph iq ir ht is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hm dt translated"><em class="le">因为我使用Go作为这个应用程序的后端，所以我使用了</em> <strong class="is hu"> <em class="le"> Powergate Go客户端</em> </strong> <em class="le">来创建FFS实例。由于前端也向Powergate发出请求，我们也将在下一节看到我是如何使用JS客户机的。</em></p><p id="52ad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看登录处理程序中的一个代码块，它</p><ul class=""><li id="38a2" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">发送创建FFS实例的请求，并且</li><li id="7532" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">用令牌更新用户模型</li></ul><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="af33" class="md ke ht ll b fv mv mw l mx my">if len(u.FFSToken) == 0 {<br/>    // create a new FFS instance for user<br/>    _, ffsToken, err := u.FFSCreate() // ignore instanceID for now<br/>    if err != nil {<br/>        // handle error<br/>    }</span><span id="67c3" class="md ke ht ll b fv mz mw l mx my">    u.FFSToken = ffsToken<br/>    if err := h.userRepo.Update(u); err != nil {<br/>        // handle error<br/>    }<br/>}</span></pre><p id="10d1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是<code class="eh li lj lk ll b">FFSCreate()</code>的样子:</p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="9a71" class="md ke ht ll b fv mv mw l mx my">import (<br/>    "github.com/multiformats/go-multiaddr"<br/>    pow "github.com/textileio/powergate/api/client"<br/>    "google.golang.org/grpc"<br/>)</span><span id="99e1" class="md ke ht ll b fv mz mw l mx my">func FFSCreate() (string, string, error) {<br/>    ma, err := multiaddr.NewMultiaddr("/ip4/0.0.0.0/tcp/5002")<br/>    if err != nil {<br/>        // log error<br/>        return "", "", err<br/>    }</span><span id="2a37" class="md ke ht ll b fv mz mw l mx my">    client, err := pow.NewClient(ma, grpc.WithInsecure())<br/>    if err != nil {<br/>        // log error<br/>        return "", "", err<br/>    }<br/>    <br/>    ffsID, ffsToken, err := client.FFS.Create(context.Background())<br/>    if err != nil {<br/>        // log error<br/>        return "", "", err<br/>    }</span><span id="4510" class="md ke ht ll b fv mz mw l mx my">    err = client.Close()<br/>    if err != nil {<br/>        // log error<br/>    }</span><span id="8ebf" class="md ke ht ll b fv mz mw l mx my">    return ffsID, ffsToken, err<br/>}</span></pre><p id="9c5f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">好的，首先，powergate客户端需要连接到服务API(默认地址在<code class="eh li lj lk ll b">/ip4/0.0.0.0/tcp/5002</code>，并在上面的代码块中硬编码)。</p><p id="2a64" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦创建了客户端，<code class="eh li lj lk ll b">client.FFS.Create()</code>就会创建一个FFS实例并返回<code class="eh li lj lk ll b">ffsID</code>和<code class="eh li lj lk ll b">ffsToken.</code></p><p id="8281" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就是这样！</p><p id="29fc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后，我们可以更新用户模型，并用这个令牌响应登录请求。</p><h2 id="cf7e" class="md ke ht bd kf me mf mg kj mh mi mj kn jb mk ml kr jf mm mn kv jj mo mp kz mq dt translated">持续音频轨道</h2><p id="9dae" class="pw-post-body-paragraph iq ir ht is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hm dt translated">一旦我们有了FFS令牌，我们就可以向FFS API发出经过身份验证的请求。</p><p id="dc62" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们首先创建powergate客户端并设置FFS令牌:</p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="cffe" class="md ke ht ll b fv mv mw l mx my">import { createPow } from "@textile/powergate-client";</span><span id="411b" class="md ke ht ll b fv mz mw l mx my">const pow = createPow({<br/>    host: process.env.POW_HOST<br/>});</span><span id="a814" class="md ke ht ll b fv mz mw l mx my">pow.setToken("some-ffs-token");</span></pre><p id="5711" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在客户端已经设置好了，让我们继续将数据存储在IPFS+Filecoin上。这分两步进行—</p><p id="a2af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">将数据添加到IPFS缓存并获取CID(热上传)</strong></p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="f8e3" class="md ke ht ll b fv mv mw l mx my">async function hotUpload(blob) {<br/>    var audioBuffer = await blob.arrayBuffer();<br/>    var input = new Uint8Array(audioBuffer);<br/>    const { cid } = await pow.ffs.addToHot(input);<br/>    return cid;<br/>}</span></pre><p id="8308" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">blob已经包含了记录的音频数据，我将其转换为Uint8Array作为输入参数传递给<code class="eh li lj lk ll b">pow.ffs.addToHot().</code></p><p id="b9bc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">推送对应于CID的配置，用于Filecoin上数据的持久性(冷上传)</strong></p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="f7f0" class="md ke ht ll b fv mv mw l mx my">async function coldUpload(cid) {<br/>    const { jobId } = await pow.ffs.pushConfig(cid);<br/>    return jobId;<br/>}</span></pre><p id="86cb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对应于这里的<code class="eh li lj lk ll b">cid</code>的默认配置决定了我们希望如何在Filecoin上保存内容。</p><p id="0ff8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">例如，如果在热层中不可用，我们可以配置在特定的可配置超时后是否应该从冷层自动检索CID的内容。此外，我们可以配置复制系数、存储交易期限和自动续订。您可以在<a class="ae jo" href="https://docs.textile.io/powergate/cidconfig/#cidconfig-details" rel="noopener ugc nofollow" target="_blank">默认配置</a>中查看许多其他配置。</p><p id="cd1b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可以进一步观察<code class="eh li lj lk ll b">jobId</code>的工作状态更新。可以做类似下面的事情来观看一个<code class="eh li lj lk ll b">jobId.</code>(由于我在JavaScript方面的不足，我自己至今还不能正确地使用它)</p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="e508" class="md ke ht ll b fv mv mw l mx my">// watch the FFS job status to see the storage process progressing<br/>const cancel = pow.ffs.watchJobs((job) =&gt; {<br/>  if (job.status === ffs.JobStatus.CANCELED) {<br/>    console.log("job canceled")<br/>  } else if (job.status === ffs.JobStatus.FAILED) {<br/>    console.log("job failed")<br/>  } else if (job.status === ffs.JobStatus.SUCCESS) {<br/>    console.log("job success!")<br/>  }<br/>}, jobId)</span></pre><h2 id="d494" class="md ke ht bd kf me mf mg kj mh mi mj kn jb mk ml kr jf mm mn kv jj mo mp kz mq dt translated">从IPFS检索音轨</h2><p id="55da" class="pw-post-body-paragraph iq ir ht is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hm dt translated">一旦音轨上传，我们还需要检索存储的数据，以便能够播放音频内容。下面的函数<code class="eh li lj lk ll b">getTrackContent()</code>以Uint8Array的形式检索对应于CID的数据，从中创建一个blob并返回本地URL，该URL可以依次传递给一个音频元素以播放媒体。</p><pre class="ls lt lu lv fq mr ll ms mt aw mu dt"><span id="64f5" class="md ke ht ll b fv mv mw l mx my">async function getTrackContent(cid) {<br/>    const audioBytes = await pow.ffs.get(cid);<br/>    const audioBuffer = audioBytes.buffer;<br/>    var blobOpts = { 'type' : 'audio/wav; codecs=0' };<br/>    if (MediaRecorder.isTypeSupported("audio/wav;codecs=MS_PCM")) {<br/>        blobOpts = { 'type' : 'audio/wav; codecs=MS_PCM' };<br/>    }<br/>    const blob = new Blob([audioBuffer], blobOpts);<br/>    const url = URL.createObjectURL(blob);<br/>    return url;<br/>}</span></pre><p id="ebf2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh li lj lk ll b">pow.ffs.get()</code>尝试首先从IPFS缓存中检索对应于CID的内容，如果不可用，则在可配置的超时后从Filecoin获取内容。</p></div><div class="ab cl na nb hb nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hm hn ho hp hq"><p id="1364" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">总而言之，看起来Powergate确实让应用程序开发人员开始使用Filecoin + IPFS来满足他们分散的存储需求变得更加容易。期待在下个月的HackFS上探索更多，我将为寻找音乐的业余音乐家开发一个合作音乐平台！</p><h1 id="9bda" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated">进一步阅读/观看</h1><ul class=""><li id="4e5f" class="jp jq ht is b it lm ix ln jb nh jf ni jj nj jn ju jv jw jx dt translated"><a class="ae jo" href="https://docs.textile.io/powergate/ffs/" rel="noopener ugc nofollow" target="_blank">关于Powergate FFS的文档</a></li><li id="f800" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">C <a class="ae jo" href="https://docs.textile.io/powergate/cidconfig/" rel="noopener ugc nofollow" target="_blank">为cid配置存储</a></li><li id="a96e" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">Powergate <a class="ae jo" href="https://textileio.github.io/js-powergate-client/" rel="noopener ugc nofollow" target="_blank">文档的JS客户端</a></li><li id="a21e" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">转到Powergate <a class="ae jo" href="https://pkg.go.dev/github.com/textileio/powergate/api/client?tab=doc" rel="noopener ugc nofollow" target="_blank">文档的客户端</a></li><li id="7b8c" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">这篇<a class="ae jo" href="https://blog.textile.io/integrating-powergate/" rel="noopener ugc nofollow" target="_blank">介绍性的博文</a>由Textile在JavaScript客户端上发布</li><li id="297f" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">当然还有<a class="ae jo" href="https://www.youtube.com/watch?v=aiOTSkz_6aY" rel="noopener ugc nofollow" target="_blank">这个由<a class="nk nl gr" href="https://medium.com/u/ff64f4a69e5a?source=post_page-----71ffe42f8c09--------------------------------" rel="noopener" target="_blank">安德鲁·希尔</a>和<a class="nk nl gr" href="https://medium.com/u/debfdff4580c?source=post_page-----71ffe42f8c09--------------------------------" rel="noopener" target="_blank">亚伦·苏图拉</a>为Powergate制作的介绍视频</a>。</li></ul><blockquote class="nm"><p id="8aa0" class="nn no ht bd np nq nr ns nt nu nv jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="nx ny nz oa ob lw fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nw"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>