<html>
<head>
<title>SQL based Sanity check in Airflow before kicking off machine learning model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在启动机器学习模型之前对气流进行基于SQL的健全性检查</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/sql-based-sanity-check-in-airflow-before-kicking-off-machine-learning-model-2733868b1cf2?source=collection_archive---------7-----------------------#2018-06-30">https://medium.com/coinmonks/sql-based-sanity-check-in-airflow-before-kicking-off-machine-learning-model-2733868b1cf2?source=collection_archive---------7-----------------------#2018-06-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="9f84" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当我们建立机器学习模型时，我们不想在坏的或损坏的数据上训练模型。所以对它进行健全性检查是很重要的。示例包括特定列列表的“<em class="jo">total _ rows&gt;0”</em>或“<em class="jo"> null count </em>”等。</p><p id="5408" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这种方法中，我们将寻找一种简单的方法，将其添加到我们的工作流程中。</p><p id="8def" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看一个例子，我们在我们的HIVE表中生成数据，我们想检查一列的所有值是否都不为空。</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="9438" class="jy jz ht ju b fv ka kb l kc kd">-- It is a presto query<br/>SELECT<br/>   count_if(col_x is null) as null_count,<br/>   count(1) as total<br/>FROM<br/>   db.some_table<br/>WHERE<br/>   dt = ‘{ds}’</span></pre><p id="4ac1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在上面的查询中，如果<code class="eh ke kf kg ju b">null_count</code>等于<code class="eh ke kf kg ju b">total</code>，那么它应该会失败。所以最简单的事情，我们现在可以做的是改变我们的查询返回<code class="eh ke kf kg ju b">True</code>或<code class="eh ke kf kg ju b">False</code>。</p><blockquote class="kh ki kj"><p id="c089" class="iq ir jo is b it iu iv iw ix iy iz ja kk jc jd je kl jg jh ji km jk jl jm jn hm dt translated">真— →测试用例通过(总行数不等于空计数)</p><p id="e074" class="iq ir jo is b it iu iv iw ix iy iz ja kk jc jd je kl jg jh ji km jk jl jm jn hm dt translated">False — →测试用例失败(总行数等于空计数)</p></blockquote><p id="f15e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们修改上面的查询:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="eca4" class="jy jz ht ju b fv ka kb l kc kd">-- It is a presto query<br/>SELECT<br/>   count_if(segments is null) != count(1)<br/>FROM<br/>   db.some_table<br/>WHERE<br/>   dt = ‘{ds}’</span></pre><p id="6d17" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这将返回<strong class="is hu">真/假</strong></p><p id="f4ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过扩展这种设计，我们可以编写一个函数来运行这些sql测试查询。</p></div><div class="ab cl kn ko hb kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hm hn ho hp hq"><h1 id="7d64" class="ku jz ht bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">让我们定义一个用例，看看我们如何解决它。</h1><p id="c76f" class="pw-post-body-paragraph iq ir ht is b it lr iv iw ix ls iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hm dt translated"><strong class="is hu">目标</strong>:在<strong class="is hu"> <em class="jo">气流</em> </strong>中，在使用工作台<code class="eh ke kf kg ju b">db.some_data</code>的预定机器学习模型启动之前，运行一些基本的<strong class="is hu">健全性检查</strong>，如果检查失败，<strong class="is hu">跳过</strong>模型运行任务。</p><p id="0a84" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">所以我们的气流DAG会像这样。</p><figure class="jp jq jr js fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff lw"><img src="../Images/be46e04ba50a0866d67d4ebcd21da05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dsu1lc4w8Pa_traYZ8cINQ.png"/></div></div></figure><p id="ad35" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">工作流程步骤:</p><ol class=""><li id="d113" class="me mf ht is b it iu ix iy jb mg jf mh jj mi jn mj mk ml mm dt translated">我们将测试用例定义为字典对象列表。</li><li id="15e1" class="me mf ht is b it mn ix mo jb mp jf mq jj mr jn mj mk ml mm dt translated">我们将通过<em class="jo"> sanity_check_func </em>函数和<em class="jo">测试_用例字典</em>传递给<a class="ae ms" href="https://airflow.apache.org/code.html#airflow.operators.ShortCircuitOperator" rel="noopener ugc nofollow" target="_blank"><strong class="is hu">shortcircuit operator</strong></a>。</li><li id="7c3c" class="me mf ht is b it mn ix mo jb mp jf mq jj mr jn mj mk ml mm dt translated">sanity_check_func将像Presto query一样逐个运行每个测试用例(<em class="jo">我们可以使用任何引擎</em>)，当任何一个查询返回False时，ShortCircutOperator将跳过下游任务。</li></ol><h1 id="7939" class="ku jz ht bd kv kw mt ky kz la mu lc ld le mv lg lh li mw lk ll lm mx lo lp lq dt translated">样本测试案例:</h1><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="d331" class="jy jz ht ju b fv ka kb l kc kd"># Data Validation Test Cases<br/>test_cases = [<br/>{<br/>  '<strong class="ju hu">name</strong>': 'data exists',<br/>  '<strong class="ju hu">description</strong>': 'Check if the most recent partition has data',<br/>  '<strong class="ju hu">sql</strong>': """ SELECT<br/>                COUNT(1) &gt; 0<br/>             FROM<br/>                 db.some_table<br/>             WHERE<br/>                 dt = '{ds}'<br/>         """<br/>}, <br/>{<br/>  '<strong class="ju hu">name</strong>': 'Validate Col X',<br/>  '<strong class="ju hu">description</strong>': 'At least 1000 SUM in last 3 days ',<br/>  '<strong class="ju hu">sql</strong>': """ <br/>          SELECT<br/>              SUM(col_x) &gt;= 1000<br/>          FROM<br/>               db.some_table<br/>          WHERE<br/>              dt BETWEEN to_iso8601(date '{ds}' + interval '-3'<br/>    day) AND '{ds}'<br/>  """<br/>}, <br/>{<br/>  '<strong class="ju hu">name</strong>': 'All null value test',<br/>  '<strong class="ju hu">description</strong>': 'Test if all the values are not null for given cols in recent partition',<br/>  '<strong class="ju hu">sql</strong>': """<br/>       SELECT<br/>          count_if(col_x is null) != count(1),<br/>          count_if(col_y is null) != count(1),<br/>          count_if(col_z is null) != count(1)<br/>       FROM<br/>          db.some_table<br/>       WHERE<br/>          dt BETWEEN to_iso8601(date '{ds}' + interval '-1'<br/>    day) AND '{ds}'<br/>  """<br/>}<br/>]</span></pre><h1 id="7132" class="ku jz ht bd kv kw mt ky kz la mu lc ld le mv lg lh li mw lk ll lm mx lo lp lq dt translated">健全性测试函数</h1><figure class="jp jq jr js fq lx"><div class="bz el l di"><div class="my mz l"/></div></figure><h1 id="64f7" class="ku jz ht bd kv kw mt ky kz la mu lc ld le mv lg lh li mw lk ll lm mx lo lp lq dt translated">ShortCircuitOperator运算符示例</h1><figure class="jp jq jr js fq lx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="615c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">其他要点:</p><ol class=""><li id="513c" class="me mf ht is b it iu ix iy jb mg jf mh jj mi jn mj mk ml mm dt translated">我们也可以将它添加到其他ETL工作流中，一旦创建了数据，就进行一些基本的健全性检查。</li><li id="18fc" class="me mf ht is b it mn ix mo jb mp jf mq jj mr jn mj mk ml mm dt translated">我们还可以将结果保存在mysql或其他数据库中，并使用任何BI工具绘制它。</li><li id="4b30" class="me mf ht is b it mn ix mo jb mp jf mq jj mr jn mj mk ml mm dt translated">我们可以调用任何其他外部系统(如datadog)来记录事件并创建警报。</li></ol></div></div>    
</body>
</html>