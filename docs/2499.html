<html>
<head>
<title>The 8 Things That Can Happen to Your Ethereum Transaction and How to Navigate Them in Your Dapp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太坊交易中可能发生的8件事以及如何在Dapp中浏览它们</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/the-8-things-that-can-happen-to-your-ethereum-transaction-and-how-to-navigate-them-in-your-dapp-ed5b37470367?source=collection_archive---------1-----------------------#2019-11-07">https://medium.com/coinmonks/the-8-things-that-can-happen-to-your-ethereum-transaction-and-how-to-navigate-them-in-your-dapp-ed5b37470367?source=collection_archive---------1-----------------------#2019-11-07</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><figure class="hs ht fm fo hu hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff hr"><img src="../Images/7e12f1fe73560101e0868064b2b44a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3YYCpp-gGByu7vqkqax5w.jpeg"/></div></div></figure><div class=""/><p id="92ad" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在<a class="ae jz" rel="noopener" href="/coinmonks/whats-wrong-with-dapps-on-ethereum-68d666645848">之前的一篇文章</a>中，我们讨论了以太坊节点的固有限制以及这些限制对开发者的一些约束，并描述了dfuse平台可以如何提供帮助。在这篇文章中，我们将重点关注以太坊交易的复杂生命周期，以及当您试图在dapps中提供出色的用户体验时这些带来的挑战，以及dfuse如何提供帮助。</p><p id="5a02" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">每当一个交易被提交到以太网，它就会以一种相当复杂的方式通过一系列的状态。并不是每一个状态转换都是向前的，一个事务可以返回到一个更早的状态，可以被另一个事务取代，或者可以完全脱离。(我们将在本文后面更详细地描述事务生命周期。)</p><p id="1fb8" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用dfuse毫不费力地跟踪事务状态在dapp中跟踪事务的过程，并为您的用户提供良好的体验，可能是一项挑战。今天，许多基于以太坊构建的dapp为他们的用户提供了有吸引力但静态的用户体验，这些用户体验显示了某个时间点的事务状态，并且必须被刷新(要么通过用户点击刷新，要么通过dapp UI定期刷新页面)以获得更新。其他的提供了更动态的接口，但是只能以相对粗糙的粒度来实现，和/或以高网络流量为代价，并且在它们的底层区块链节点上强加高负载。</p><p id="7cf6" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在本帖中，我们将讨论这样做的原因，然后讨论如何在您的dapp中提供现代和流畅的用户体验，通过细粒度的事务状态更新，并以高度网络高效和服务器高效的方式。</p><h1 id="248a" class="ka kb ie bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">今天的Dapp接口</h1><p id="d034" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">每个dapp都需要向其用户显示关于dapp正在执行的底层区块链事务的信息，无论这些事务是以太网传输、令牌传输还是智能合约方法调用。</p><p id="b581" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如今，许多dapps都有一种界面风格，在这种风格中，无论何时向用户显示关于其底层区块链操作的信息，该信息都反映了区块链在单个时间点(即页面显示的时间)的状态。</p><p id="c6e5" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">随着交易在其生命周期中的移动，用户经常需要更新的信息，例如了解何时完成转移，因此dapp要么提供“刷新”或“更新”按钮(或为用户自动刷新相同的页面)，要么用户使用浏览器的刷新按钮重新显示页面。</p><p id="7987" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">一些dapps更进一步，向用户显示动态事务更新。他们通过在页面后台轮询AJAX请求，反复检查以太坊节点的更新，然后将更改发布到前端来实现这一点。这是非常复杂的，因为dapp必须进行许多API调用，查询许多不同的数据源(包括块、内存池和网络条件),以便跟踪事务的生命周期直到完成。</p><p id="a21f" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这种方法也带来了一种折衷——要么事务更新不频繁且粒度较粗，这让用户感到沮丧，并诱使他们无论如何都要点击刷新以获得更快的更新——要么dapp必须以高频率轮询链，从而产生大量网络流量并给底层区块链节点带来高负载。</p><h1 id="c75d" class="ka kb ie bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">为什么不是事件驱动的界面？</h1><p id="c165" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">事实上，静态页面或轮询是dapp开发人员的最佳选择，这反映了以太坊节点提供的API的本质。接收从区块链推送的事务更新并将它们实时反映给用户的事件驱动界面将提供更好的体验——但标准以太坊节点并不是为提供丰富的实时流事务数据而设计的。</p><p id="bf34" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">以太坊节点确实提供了有限的事件流功能。这些事件流仅在使用Ethereum的JSON-RPC接口的发布/订阅功能时可用(使用GraphQL时不可用)。发布/订阅接口允许dapps订阅接收一些事件类型的通知:</p><ul class=""><li id="175e" class="ld le ie jd b je jf ji jj jm lf jq lg ju lh jy li lj lk ll dt translated"><strong class="jd if">新标题</strong> —每次一个新的块标题被附加到链中</li><li id="4660" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">日志</strong> —包含在新导入的块中并与给定过滤器匹配的日志</li><li id="1fe2" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if"> newPendingTransactions </strong> —添加到挂起状态并使用节点中可用的密钥签名的所有事务的哈希(公共节点上很少出现这种情况)</li><li id="2890" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">同步</strong> —指示节点开始或停止同步的时间</li></ul><p id="4820" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">(详见<a class="ae jz" href="https://github.com/ethereum/go-ethereum/wiki/RPC-PUB-SUB" rel="noopener ugc nofollow" target="_blank">此处</a>)</p><p id="b776" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这些事件类型非常有限，无法让dapp在交易的整个生命周期中跟踪交易。</p><h1 id="0b08" class="ka kb ie bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">以太坊交易生命周期</h1><p id="2a3e" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">以太坊交易有一个复杂的生命周期。每个事务经过多个定义的<em class="lr">状态</em>，在向前(或向后)移动时经历各种<em class="lr">状态转换</em>！)穿越各州。</p><h2 id="7eb3" class="ls kb ie bd kc lt lu lv kg lw lx ly kk jm lz ma ko jq mb mc ks ju md me kw mf dt translated">交易状态</h2><p id="fc7c" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">以太坊交易从第一次提交到网络开始经历一系列状态，直到(可能)包含在链上的块中。这些状态如下:</p><ul class=""><li id="cd44" class="ld le ie jd b je jf ji jj jm lf jq lg ju lh jy li lj lk ll dt translated"><strong class="jd if">未知</strong>:网络未看到也未处理的交易将处于<strong class="jd if">未知</strong>状态。</li><li id="a220" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">待处理</strong>:交易处于<strong class="jd if">待处理</strong>状态，等待矿工拣货处理。他们在所谓的<em class="lr"> mempool </em>。采矿者通常首先选择天然气价格较高的交易，因此天然气价格较低的交易可能会长期处于<strong class="jd if">待定</strong>状态。油价最低的交易可能永远不会被接受，这将导致它们无限期地“停留”在<strong class="jd if">待定</strong>状态。</li><li id="2d09" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if"> IN_BLOCK: </strong>当一个挖掘器成功地选择了一个事务并在一个块内挖掘它时，该事务进入<strong class="jd if"> IN_BLOCK </strong>状态。一旦<strong class="jd if"> IN_BLOCK </strong>，如果该块被分叉，则事务可以移回<strong class="jd if">挂起</strong>状态。</li><li id="e60a" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">已替换</strong>:当以下任一事件发生时，交易可以从<strong class="jd if">挂起</strong>状态转移到<strong class="jd if">已替换</strong>状态；</li></ul><ol class=""><li id="343a" class="ld le ie jd b je jf ji jj jm lf jq lg ju lh jy mg lj lk ll dt translated">来自同一发送方的具有相同随机数的另一个交易进入<strong class="jd if"> IN_BLOCK </strong>状态，或者</li><li id="f95f" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy mg lj lk ll dt translated">源自相同发送者的具有相同现时值的另一个交易进入<strong class="jd if">未决</strong>状态，该交易具有高12%的汽油价格</li></ol><p id="65ca" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下图显示了这些状态以及它们之间的转换。</p><figure class="mi mj mk ml fq hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff mh"><img src="../Images/284ea656f26d476185ac96b725920942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEVduj7C09sHSD2kTqIWeA.png"/></div></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">The following diagram shows these states and the transitions between them.</figcaption></figure><h2 id="b055" class="ls kb ie bd kc lt lu lv kg lw lx ly kk jm lz ma ko jq mb mc ks ju md me kw mf dt translated">状态转换</h2><p id="a188" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">如上图所示，状态之间的转换也有名称。</p><ul class=""><li id="fbc5" class="ld le ie jd b je jf ji jj jm lf jq lg ju lh jy li lj lk ll dt translated"><strong class="jd if">入池</strong>:进入等待矿工选择的事务池的<strong class="jd if">未知</strong>状态的事务称为<strong class="jd if">入池</strong>并进入<strong class="jd if">挂起</strong>状态。如果替换的条件不再为真，则处于<strong class="jd if">替换</strong>状态的交易也有可能再次变为<strong class="jd if">池</strong>(例如:在极少数情况下，在_BLOCK 中的<strong class="jd if">低气价交易被分叉，并且<strong class="jd if">替换的</strong>交易具有相同的nonce+具有较高气价的发送方，仍在浮动)。</strong></li><li id="ab34" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">挖掘的</strong>:挖掘的事务是已经被挖掘器处理过的事务，创建一个块。一旦被挖掘，事务就被称为处于<strong class="jd if"> IN_BLOCK </strong>状态。由于以太网的对等性质，从给定节点的角度来看，事务可以从<strong class="jd if">未知</strong>状态直接转移到<strong class="jd if"> IN_BLOCK </strong>状态，而无需明显地通过<strong class="jd if">挂起</strong>状态。出于同样的原因，从给定节点的角度来看，事务也可以从<strong class="jd if">替换</strong>状态转到<strong class="jd if"> IN_BLOCK </strong>状态，而不经过<strong class="jd if">未决</strong>状态。</li><li id="23ae" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">被替换</strong>:从<strong class="jd if">挂起</strong>状态转移到<strong class="jd if">被替换</strong>状态的交易称为<strong class="jd if">被替换</strong>。参见上述<strong class="jd if">替换</strong>状态，了解发生这种情况的条件。</li><li id="8589" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">分叉</strong>:当挖掘出的事务(即处于<strong class="jd if"> IN_BLOCK </strong>状态的事务)是被网络反转的块的一部分时，会发生分叉事务。反转块内的所有事务将随后被分叉，从而将它们从<strong class="jd if"> IN_BLOCK </strong>状态移动到<strong class="jd if"> PENDING </strong>状态。</li><li id="181f" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd if">已确认</strong>:每次后续子块被挖掘时，处于<strong class="jd if"> IN_BLOCK </strong>状态的事务被<strong class="jd if">确认</strong>。</li></ul><p id="9b0e" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">正如您所看到的，以太坊交易的生命周期可能非常复杂，这使得dapp很难准确地跟踪它并向其用户提供无缝更新。</p><h2 id="aa0d" class="ls kb ie bd kc lt lu lv kg lw lx ly kk jm lz ma ko jq mb mc ks ju md me kw mf dt translated">使用dfuse轻松跟踪交易状态</h2><p id="9c3f" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated"><a class="ae jz" href="https://www.dfuse.io/en" rel="noopener ugc nofollow" target="_blank"> dfuse平台</a>为您提供了一个丰富的流接口，支持实时详细跟踪以太坊交易的生命周期。<a class="ae jz" href="https://docs.dfuse.io/guides/ethereum/concepts/trx_lifecycle/" rel="noopener ugc nofollow" target="_blank"> dfuse以太坊状态跟踪器API </a>使开发者能够提交以太坊交易，然后随着交易在其整个生命周期中的进展，通过同一渠道提供即时和粒度更新。</p><p id="5b6a" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用GraphQL，您可以实时订阅特定事务的转换，并可以精确地指定每次转换想要接收的数据。dfuse平台通过各种状态转换来管理跟踪事务的复杂性，并在事件发生时实时将事件流式传输到dapp。</p><p id="56a2" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">结果是，您不需要实现复杂的后台逻辑来重复轮询更新，也不需要浪费带宽和处理重复的查询。您可以简单地订阅您需要的更新，然后在您的UI中反映出来。</p><p id="61f6" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下面的动画展示了一个经历复杂生命周期的事务，它经历了八次状态转换，最后才被包含在块中并得到确认。</p><figure class="mi mj mk ml fq hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff mq"><img src="../Images/e9d87be1cb38c7cbeaf0e863d838ecbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*M-Ruw7l3dKnl1feta6BwpA.gif"/></div></div></figure><p id="143f" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果您没有使用dfuse，您的dapp将不得不重复轮询链，以捕捉事务经历的所有转换，从而更新您的用户，并且您的代码需要准备好适当地响应每个转换。</p><p id="b28c" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">有了dfuse，您的dapp只需要监听单个连接上的流更新，因为dfuse会为您跟踪曲折，直到事务的命运最终确定。</p><h1 id="d8fd" class="ka kb ie bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">尖端Dapps的现代平台</h1><p id="fc9c" class="pw-post-body-paragraph jb jc ie jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">Lifecycle API只是dfuse平台的一个很小但很重要的部分。dfuse为您的dapps提供了一个完整的现代化基础设施层，即:</p><ul class=""><li id="2ab1" class="ld le ie jd b je jf ji jj jm lf jq lg ju lh jy li lj lk ll dt translated">快，</li><li id="3d0d" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated">可扩展，</li><li id="2872" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated">为您提供对区块链活动的高度细化的流式访问，</li><li id="73d7" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated">支持主动的webhook风格的回调，</li><li id="9c07" class="ld le ie jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated">所有这些都具有业界最高的可靠性。</li></ul><p id="f380" class="pw-post-body-paragraph jb jc ie jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">今天就试试<a class="ae jz" href="http://www.dfuse.io" rel="noopener ugc nofollow" target="_blank"> dfuse </a>。如有任何问题/建议，或谈论您的以太坊dapp建筑体验，请通过twitter或电子邮件联系我们——我们很想知道您是否对这项服务感到满意。</p><blockquote class="mr"><p id="fd7d" class="ms mt ie bd mu mv mw mx my mz na jy ek translated"><a class="ae jz" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nc nd ne nf ng hv fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nb"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>