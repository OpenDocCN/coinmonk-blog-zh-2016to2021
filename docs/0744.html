<html>
<head>
<title>Blockchain CTF write-up: Ethernaut GatekeeperOne level</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">区块链CTF报道:Ethernaut GatekeeperOne级别</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/blockchain-ctf-write-up-ethernaut-gatekeeperone-level-49f8d0a0528b?source=collection_archive---------9-----------------------#2018-06-09">https://medium.com/coinmonks/blockchain-ctf-write-up-ethernaut-gatekeeperone-level-49f8d0a0528b?source=collection_archive---------9-----------------------#2018-06-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="378b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可能知道，Open Zeppelin推出了一个名为<a class="ae jo" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank"> Ethernaut </a>的区块链CTF，这真的很神奇。不同的级别有不同的复杂程度，但我都喜欢。这也是一个开源倡议，这是一个优势。</p><p id="52b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我决定写下一些仍然没有记录的级别，以便帮助更多的人了解区块链安全，或者至少可以更好地了解区块链技术的一些构建模块。</p><p id="6737" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这一次，我来描述一下“<strong class="is hu"> GatekeeperOne </strong>的水平。</p><p id="03a3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这个关卡中，你会得到一个区块链智能合同<em class="jp">实例</em>以及用solidity编写的代码。</p><p id="7cbc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">目标是“进入”网关守护设备，这意味着正确并完全执行“进入功能”:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/d41d587c47d07707d4d424a3c937e352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLPAQ0lrxkrr7L3rjQA-Ng.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">GatekeeperOne Smartcontract code of delivered instance to hack</figcaption></figure><p id="774a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">快速浏览代码后，我们必须猜测要作为参数传递给函数的“_gateKey”，同时破解3个修饰符(gateOne、gateTwo和gateThree安全检查)。一旦我们得到它，enter函数将简单地将tx.origin(我们的钱包)指定为进入者，但只有在同一个调用中满足所有条件时才会发生。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kg"><img src="../Images/0045bf1966b7a7596badc8f506f22308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*uG7JNGxGQiO2qoSjh_UwvQ.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">gateOne modifier code</figcaption></figure><p id="cac6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> gateOne </strong>修改器很容易黑掉，我们只需要创建一个<a class="ae jo" href="https://github.com/rriescog/Ethernaut-CTF/blob/master/GatekeeperOnesol.sol" rel="noopener ugc nofollow" target="_blank">恶意smartcontract </a>来代表调用GatekeeperOne smartcontract，那样的话msg.sender将是我们的恶意smartcontract地址，tx.origin将是我们的metamask钱包地址。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kh"><img src="../Images/921f900dd57287bd744eca0653ec7f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*15zHBKXy0YwneItqgHOACw.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">gateTwo modifier code</figcaption></figure><p id="f0c1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">gateTwo 修改器更难破解。在这种情况下，修饰符的代码要求在评估条件的堆栈执行的特定时刻“gas left”，msg.gas必须正好是“8191”的整数倍(%表示“mod”)。</p><p id="1a5e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为此，我决定从Javascript VM环境开始调试，以便检查在区块链事务中需要发送的“气体”的确切数量，以便在堆栈执行的确切点满足这样的条件。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ki"><img src="../Images/f4ee0d64dd9b2075fd3f76a0908adcae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgPi6spVPKZS-Kof7RoxTA.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Remaining “Gas” Debugging to get a multiple value of 8191 (need to open instruction set / assembly)</figcaption></figure><p id="00ca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">调试时，您将在“步骤细节”部分看到剩余气体。我使用REMIX IDE作为一个强大的IDE工具/环境。</p><p id="020f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，smartcontract需要传递的“气”的确切数量，就是调用中的<strong class="is hu"> 32979 </strong>。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kj"><img src="../Images/251d561ebfb4d774bce4dc5b81372328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*WB-fMUlFr6___vrr9Kw3dA.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">gateThree modifier code</figcaption></figure><p id="6463" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> gateThree </strong>修改器需要一个名为<strong class="is hu"> "_gateKey" </strong>的参数，我们必须猜测。由于所有的条件都必须同时满足，我们在函数中看到了有趣的逻辑。</p><p id="618a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在最后一行代码中，<em class="jp"> _gateKey依赖于tx.origin </em>，这意味着您将拥有一个与我不同的_gateKey。我会解释你应该做的过程，但请记住，你将有一个不同的_gateKey，因为它依赖于tx.origin(交易的起点，你的钱包)。</p><p id="d5d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请记住，msg.sender将是恶意的smartcontract地址，而tx.origin将是您的(元掩码)钱包。</p><p id="0ca0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">首先，检查你的钱包地址。</p><p id="37b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第二，如果<strong class="is hu"> uint32(_gateKey) </strong>必须等于<strong class="is hu"> uint16(tx.origin) </strong>，同时<strong class="is hu"> uint32(_gateKey) </strong>必须等于<strong class="is hu"> uint16(_gateKey) </strong>，这意味着您必须屏蔽您的钱包地址(tx.origin)多达32位(通过填充0)。</p><p id="18cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这可以通过一个简单的</p><p id="2a76" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"><em class="jp">‘a&amp;b’</em></strong></p><p id="61d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">操作，其中“a”是您的“tx.origin”地址,“b”是一个类似</p><p id="102f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"><em class="jp">' bytes 8 public mask = 0x ffffffff 0000 ffff '</em></strong></p><p id="961a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您还可以通过使用在线转换器(如<a class="ae jo" href="https://www.scadacore.com/tools/programming-calculators/online-hex-converter/" rel="noopener ugc nofollow" target="_blank">scadacore.com</a>)来检查uint32、uint 16和任何其他替代操作。请注意，你将不得不与<strong class="is hu">【大端】</strong>价值观一起工作。</p><p id="f328" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第三，由于第三个条件是<strong class="is hu"> uint32(_gateKey) </strong>必须<strong class="is hu">不同(！=) </strong>从<strong class="is hu"> uint64(_gateKey)，我们只填充了32位(见上面掩码中的0)，其余的，将保持tx.origin位不变。</strong></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kk"><img src="../Images/9b03704e09c98befed2ac14654d4d7fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*Gxj3ND54xDQvG6ZkyzLHVw.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Gatekeeperhack Smartcontract</figcaption></figure><p id="a149" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">综上所述，我创建了上面的<strong class="is hu">恶意smartcontract </strong>命名为<strong class="is hu">“Gatekeeperhack”</strong>作为代理契约来代表我调用实例化的GatekeeperOne。</p><p id="8ea2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">变量<strong class="is hu"> "target" </strong>通过打开<strong class="is hu"> Ropsten区块链测试网</strong>中的zeppelin链接到真实实例(您必须用您的ropsten ethernaut实例地址替换“在此复制您的ETHERNAUT实例地址”)。</p><p id="8444" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">提供的面膜对你完全有用。</p><p id="9453" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我使用低级别的<strong class="is hu">【调用】</strong>来更好地控制<strong class="is hu">气体通过</strong>(记住上面的gateTwo)，不要忘记，在这种情况下，远程调用一个远程函数契约，将迫使您使用:</p><blockquote class="kl"><p id="bc80" class="km kn ht bd ko kp kq kr ks kt ku jn ek translated"><strong class="ak"> 'bytes4(sha3("函数名(参数类型)"))，参数值'</strong></p></blockquote><p id="afc1" class="pw-post-body-paragraph iq ir ht is b it kv iv iw ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn hm dt translated">注意:由于<em class="jp"> sha3 </em>已被弃用，建议您使用<em class="jp"> keccak256 </em>代替。</p></div><div class="ab cl la lb hb lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hm hn ho hp hq"><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lh"><img src="../Images/32c077bb022e18e30007ce1d83b1a1c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*giebcK3JaohjT2LfMBfc2A.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">enter function debugging when it is hacked :)</figcaption></figure><p id="d878" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后但同样重要的是，当关卡完成时，你会收到一些建议！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff li"><img src="../Images/b8fd3078aecb5bf13c531fbac7b2b27e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bj5kOymPcxX638uHqmnJgA.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">GatekeeperOne level completed!</figcaption></figure><p id="94a1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我希望你和我一样喜欢这个级别。</p><p id="ea62" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后但同样重要的是，<a class="ae jo" href="https://github.com/rriescog/Ethernaut-CTF/blob/master/GatekeeperOnesol.sol" rel="noopener ugc nofollow" target="_blank">代码可以在Github </a>获得。</p><p id="993b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">祝好运和<strong class="is hu">快乐黑客</strong>！</p></div></div>    
</body>
</html>