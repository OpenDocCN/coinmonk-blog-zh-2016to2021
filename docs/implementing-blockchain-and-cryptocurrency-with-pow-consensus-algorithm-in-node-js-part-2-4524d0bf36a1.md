# ç¬¬ 2 éƒ¨åˆ†:ç”¨ PoW å…±è¯†ç®—æ³•å®žçŽ°åŒºå—é“¾å’ŒåŠ å¯†è´§å¸

> åŽŸæ–‡ï¼š<https://medium.com/coinmonks/implementing-blockchain-and-cryptocurrency-with-pow-consensus-algorithm-in-node-js-part-2-4524d0bf36a1?source=collection_archive---------2----------------------->

åœ¨ node.js ä¸­ä½¿ç”¨å·¥ä½œå…±è¯†ç®—æ³•è¯æ˜Žï¼Œå°è§„æ¨¡ã€æ˜“äºŽç†è§£ã€å…¨é¢ã€é€æ­¥å®žæ–½åŒºå—é“¾å’ŒåŠ å¯†è´§å¸

![](img/ca1a2e2c4224dbbeb2b00eaca6e45a01.png)

Source: [Bitcoin Wiki](https://en.bitcoinwiki.org/wiki/Proof-of-work)

åœ¨[çš„ä¸Šä¸€ç¯‡æ–‡ç« ](/coinmonks/implementing-blockchain-and-cryptocurrency-with-pow-consensus-algorithm-part-1-545fb32be0c2)ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†åŒºå—é“¾å’Œå·¥ä½œè¯æ˜Žï¼Œè¿˜è®¨è®ºäº†æˆ‘ä»¬å°†è¦å®žçŽ°çš„ä»£ç çš„è®¾è®¡å’Œæž¶æž„ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹åŠ¨æ‰‹ã€‚

# å…ˆå†³æ¡ä»¶:

1.  [Node.js](https://nodejs.org/en/download/) å’Œ [NPM](https://www.npmjs.com/)
2.  [æ–‡æœ¬ç¼–è¾‘å™¨](https://code.visualstudio.com/download)(å¸¦æœ‰æ·±è‰²ä¸»é¢˜ðŸ˜›)
3.  [Postman](https://www.getpostman.com/) æˆ–ä»»ä½•å…¶ä»– app ä¸Ž HTTP APIs äº¤äº’ã€‚

***å°±æ˜¯è¿™æ ·ã€‚***

# è®©æˆ‘ä»¬ç¼–ç :

æˆ‘ä»¬å°†ä»Žåˆ›å»ºé¡¹ç›®çš„æ ¹ç›®å½•å¼€å§‹ã€‚ä¸ºæ‚¨çš„é¡¹ç›®å‘½åã€‚å‡è®¾æ˜¯ Nodechainã€‚

```
mkdir nodechain
cd nodechain
```

åˆ›å»ºæ–°çš„èŠ‚ç‚¹é¡¹ç›®

```
npm init -y
```

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåä¸º nodemon çš„åŒ…æ¥è¿è¡Œæˆ‘ä»¬çš„å¼€å‘æœåŠ¡å™¨ï¼Œå¹¶åœ¨æ¯æ¬¡ä¿å­˜æ—¶é‡æ–°åŠ è½½æœåŠ¡å™¨ã€‚è¿™ä¸ªå·¥å…·è®©æˆ‘ä»¬å…åŽ»äº†å¾ˆå¤šéº»çƒ¦ã€‚

```
npm install nodemon --save-dev
```

å¥½å§ã€‚ç»§ç»­å‰è¿›ã€‚

# è¡—åŒº

åŒºå—é“¾æ˜¯ç”±å—ç»„æˆçš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå—ç±»ã€‚å—æœ‰ 4 ä¸ªä¸»è¦å±žæ€§:

æ—¶é—´æˆ³â€”å—çš„åˆ›å»ºæ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½

lastHash â€”é“¾ä¸Šæœ€åŽä¸€ä¸ªå—çš„å“ˆå¸Œ

å“ˆå¸Œ-å½“å‰å—çš„å“ˆå¸Œ

æ•°æ®â€”å—æˆ–äº‹åŠ¡ä¸­çš„æ•°æ®

å› æ­¤ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`block.js`,å¹¶åˆ›å»ºä¸€ä¸ªå…·æœ‰è¿™äº›å±žæ€§çš„ç±»ã€‚

The block class

åŒæ ·ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª`toString()`å‡½æ•°ï¼Œå®ƒå°†ä»¥å¯è¯»çš„æ ¼å¼æ‰“å°å—çš„ç»†èŠ‚ã€‚

A readable printing function

åœ¨åŒºå—é“¾ä¸­ï¼Œæ¯ä¸ªæ•°æ®å—çš„å“ˆå¸Œå€¼æ˜¯æ ¹æ®ä¹‹å‰æ•°æ®å—çš„å“ˆå¸Œå€¼è®¡ç®—çš„ã€‚

ç”±äºŽåœ¨é“¾çš„å¼€å§‹æ²¡æœ‰ç§¯æœ¨ï¼ŒåŒºå—é“¾æœ‰äº†åˆ›ä¸–çºªç§¯æœ¨çš„æ¦‚å¿µã€‚åˆ›ä¸–è¡—åŒºæœåŠ¡äºŽæˆä¸ºåŒºå—é“¾èµ·æºçš„ç›®çš„ã€‚è¿™æ˜¯ä¸€ä¸ªç¡¬ç¼–ç çš„å—ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€lastHashã€Hash å’Œæ•°æ®å€¼çš„è™šæ‹Ÿå€¼ã€‚

è®©æˆ‘ä»¬ç”¨ä¸€äº›ç¡¬ç¼–ç å€¼ç»™æˆ‘ä»¬çš„å—ç±»æ·»åŠ ä¸€ä¸ªé™æ€çš„`genesis()`å‡½æ•°ã€‚è¯¥å‡½æ•°å°†åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è™šæ‹Ÿå€¼çš„æ–°å—ã€‚è¿™æ˜¯é™æ€çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³åˆ›å»ºä¸€ä¸ªå®žä¾‹æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

What came first egg? Chicken? No the genesis block.

æŽ¥ä¸‹æ¥æˆ‘ä»¬è¦æ·»åŠ åˆ° block ç±»ä¸­çš„æ˜¯åŸºäºŽæ•°æ®å’Œæœ€åŽä¸€ä¸ªæ•£åˆ—åˆ›å»ºæ–°å—çš„èƒ½åŠ›ã€‚å§‘ä¸”ç§°ä¹‹ä¸º`mineBlock()`

è¿™ä¸ªé™æ€çš„`mineBlock()`å‡½æ•°æŽ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œæœ€åŽä¸€ä¸ªå—å’Œæ•°æ®ï¼Œå¹¶åŸºäºŽè¿™ä¸¤é¡¹ç”Ÿæˆä¸€ä¸ªæ–°çš„å—ã€‚æˆ‘ä»¬åœ¨æ•´ä¸ªé¡¹ç›®ä¸­çš„è®¸å¤šåŠŸèƒ½å°†æ˜¯é™æ€çš„ã€‚

ä¸ºäº†ç”Ÿæˆå“ˆå¸Œå€¼ï¼Œæˆ‘ä»¬éœ€è¦åä¸º`crypto-js`çš„èŠ‚ç‚¹åŒ…ï¼Œè®©æˆ‘ä»¬å®‰è£…å®ƒã€‚

```
npm i crypto-js --save
```

ä»Žè¯¥æ¨¡å—å¯¼å…¥ sha-256 å‡½æ•°ã€‚

```
const SHA256 = require('crypto-js/sha256');
```

æˆ‘ä»¬ä¸ä¼šç›´æŽ¥ä½¿ç”¨æ•£åˆ—å‡½æ•°ï¼Œç›¸åï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬å°†æ¥è¿˜ä¼šç”¨åˆ°å®ƒã€‚

The backticks and dollar syntax, thatâ€™s ES6.

è®©æˆ‘ä»¬ç”¨ä¸Šé¢æ‰€æœ‰çš„ä¸œè¥¿åˆ›å»ºä¸€ä¸ª`mineBlock()`å‡½æ•°ã€‚

æˆ‘ä»¬å°†å¾ˆå¿«åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚

è¿™æ˜¯æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢åˆ›å»ºçš„å—ç±»ã€‚

The Block

çŽ°åœ¨æˆ‘ä»¬å·²ç»åˆ›å»ºäº†å—ç±»ï¼Œæˆ‘ä»¬å¿…é¡»æµ‹è¯•å®ƒã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬æœ€å¥½åˆ›å»ºä¸€ä¸ªæµ‹è¯•çŽ¯å¢ƒã€‚å¯¹äºŽè¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ jestã€‚

```
npm i jest --save-dev
```

*æ³¨æ„:å¦‚æžœä½ åœ¨å®‰è£… jest æ—¶é‡åˆ°é—®é¢˜ï¼Œæˆ‘æ›¾ç»æœ‰è¿‡ï¼Œè¯•ç€é™çº§åˆ°ä¸€ä¸ªè¾ƒä½Žçš„ç‰ˆæœ¬ï¼Œå®ƒå¯¹æˆ‘å¾ˆæœ‰æ•ˆã€‚*

ä½¿ç”¨ jestï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ javascript é¡¹ç›®ä¸­æ‰§è¡Œæµ‹è¯•æ–‡ä»¶ã€‚ä¸ºäº†æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œjest å°†æŸ¥æ‰¾æ‰©å±•åä¸º*.test.js çš„æ–‡ä»¶ï¼Œå› æ­¤ä¸ºäº†æµ‹è¯•æˆ‘ä»¬çš„ block ç±»ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª block.test.js æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€äº›æµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬å°†æµ‹è¯•æž„é€ å‡½æ•°ã€genesisã€hash å’Œ mineBlock æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚

Sweet tests

è¦è¿è¡Œè¯¥æ–‡ä»¶ï¼Œè¯·å¯¹ package.json æ–‡ä»¶ä¸­çš„è„šæœ¬è¿›è¡Œä¸€äº›æ›´æ”¹ã€‚åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•è„šæœ¬ã€‚

```
"test": "jest --watchAll"
```

æˆ‘ä»¬æ¥åšæµ‹è¯•ã€‚

```
npm run test
```

æˆ‘ä»¬å°†é€šè¿‡ä¸¤æ¬¡æµ‹è¯•ï¼Œè¡¨æ˜Žæˆ‘ä»¬çš„åŠŸèƒ½è¿è¡Œè‰¯å¥½ã€‚

æ£€æŸ¥æµ‹è¯•æ˜¯å¦æ­£å¸¸ã€‚å¯¹æµ‹è¯•æ–‡ä»¶è¿›è¡Œä¸€äº›æ›´æ”¹ï¼Œç„¶åŽå†æ¬¡è¿è¡Œæµ‹è¯•ã€‚ä½ ä¼šå‘çŽ°æµ‹è¯•ä¼šå¤±è´¥ã€‚

é…·æ¯™äº†ã€‚æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŸºæœ¬å—ã€‚è®©æˆ‘ä»¬ç»§ç»­åˆ›å»ºä¸€ä¸ªåŒºå—é“¾ç±»æ¥é“¾æŽ¥è¿™äº›å—ã€‚

# åŒºå—é“¾

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `blockchain.js`æ–‡ä»¶ã€‚è¦åˆ›å»ºåŒºå—é“¾ç±»ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥ block ç±»ã€‚

åœ¨æž„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¼šç»™é“¾ä¸€ä¸ªåˆå§‹å—ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å°†åˆ©ç”¨æˆ‘ä»¬åˆ›å»ºçš„é™æ€ genesis å‡½æ•°æ¥å¼€å§‹æˆ‘ä»¬çš„é“¾ã€‚

The blockchain class

æŽ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ª`addBlock(data)`å‡½æ•°ï¼Œç»™æˆ‘ä»¬çš„åŒºå—é“¾ç±»æ·»åŠ æ›´å¤šå—çš„èƒ½åŠ›ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬çš„`mineBlock()`å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å—ï¼Œç„¶åŽå°†å®ƒæŽ¨é€åˆ°é“¾ä¸­ã€‚æˆ‘ä»¬å°†è®¿é—®é“¾ä¸Šçš„æœ€åŽä¸€ä¸ªå—ï¼Œç„¶åŽä½¿ç”¨ä¼ é€’ç»™`addBLock()`çš„æ•°æ®è°ƒç”¨`mineBlock()`å‡½æ•°

adding new block to the chain

è¿™æ˜¯æˆ‘ä»¬çš„ blockchain.js æ–‡ä»¶åˆ°ç›®å‰ä¸ºæ­¢çš„æ ·å­ã€‚

The Blockchain

é…·æ¯™äº†ã€‚è€ƒéªŒæˆ‘ä»¬åŒºå—é“¾çš„æ—¶å€™åˆ°äº†ã€‚åˆ›å»ºä¸€ä¸ª blockchain.test.js æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬æ·»åŠ å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ªå˜é‡`blockchain`ï¼Œå®ƒä»¬ä¹Ÿå°†ç”¨äºŽæ·»åŠ å—ã€‚çŽ°åœ¨è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹`addBlock()`å‡½æ•°ã€‚

Sweet tests

è¿è¡Œæµ‹è¯•ï¼ŒçŽ°åœ¨æ‚¨å°†çœ‹åˆ° 4 ä¸ªæµ‹è¯•é€šè¿‡ã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘åŒºå—é“¾æ·»åŠ æ›´å¤šåŠŸèƒ½æ¥æ”¯æŒå¤šä¸ªå‚ä¸Žè€…ã€‚

[ç¬¬ä¸‰éƒ¨åˆ†:ç”¨ PoW å…±è¯†ç®—æ³•å®žçŽ°åŒºå—é“¾å’ŒåŠ å¯†è´§å¸](/coinmonks/part-3-implementing-blockchain-and-cryptocurrency-with-pow-consensus-algorithm-d9b8cb928e3e)

*æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚* ***åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä»£ç æ¥éªŒè¯åŒºå—é“¾å¹¶æ·»åŠ å¯¹å¤šä¸ªçŸ¿å·¥çš„æ”¯æŒã€‚*** *å¸Œæœ›ä½ å–œæ¬¢ç¼–ç ã€‚å¦‚æžœä½ å‘çŽ°è¿™å¾ˆæœ‰å¸®åŠ©ï¼Œè¯·é¼“æŽŒã€‚*

å¦‚æžœä½ å¯¹åŒºå—é“¾ã€ä»¥å¤ªåŠæˆ–æ•´ä¸ªä¸–ç•Œæœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·å‘è¡¨è¯„è®ºã€‚:)

> [ç›´æŽ¥åœ¨æ‚¨çš„æ”¶ä»¶ç®±ä¸­èŽ·å¾—æœ€ä½³è½¯ä»¶äº¤æ˜“](https://coincodecap.com/?utm_source=coinmonks)

[![](img/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png)](https://coincodecap.com/?utm_source=coinmonks)