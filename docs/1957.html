<html>
<head>
<title>Tell me more Internet of Things — Part 2 — Google Cloud IoT cost and value comparison</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">告诉我更多物联网信息—第2部分—谷歌云物联网成本和价值比较</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/tell-me-more-internet-of-things-part-2-google-cloud-iot-cost-and-value-comparison-38bfb20d94e1?source=collection_archive---------2-----------------------#2019-01-10">https://medium.com/coinmonks/tell-me-more-internet-of-things-part-2-google-cloud-iot-cost-and-value-comparison-38bfb20d94e1?source=collection_archive---------2-----------------------#2019-01-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="075c" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">谷歌云物联网-入职、数据存储和可视化。如何将您的设备连接到谷歌云物联网，并将摄取的数据传输到数据库进行存储、可视化和分析。</h2></div><p id="d889" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-1-iot-platform-cost-and-value-comparison-558ce8966767">Part 1</a><strong class="jk hu">|</strong><a class="ae ke" rel="noopener" href="/coinmonks/tell-me-more-internet-of-things-part-2-google-cloud-iot-cost-and-value-comparison-38bfb20d94e1"><strong class="jk hu">Part 2<em class="kf"/></strong></a><em class="kf">|</em><a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-3-mindsphere-cost-and-value-comparison-b333ebfb872a">Part 3</a><em class="kf">|</em>|<a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-4-iota-cost-and-value-comparison-381008495d1d">Part 4</a><em class="kf">|</em>|<a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-5-google-cloud-user-handling-ae285e7e34b2">Part 5</a><strong class="jk hu"/><em class="kf">|</em><a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-6-google-cloud-user-input-push-subscription-aa39ebc4a348">Part 6</a><em class="kf">|…| Part n</em></p><p id="0568" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在本系列的<a class="ae ke" rel="noopener" href="/@bertrand.jan/tell-me-more-internet-of-things-part-1-iot-platform-cost-and-value-comparison-558ce8966767"> <strong class="jk hu">第1部分</strong> </a>中，我解释了我们打算如何基于特定的使用、业务案例及其价值主张来比较物联网平台。我们定义了项目的范围和规模，并完成了传感器的硬件设置。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff kg"><img src="../Images/42a174e9afb15cc267fc76f283b00654.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*ak_n0OHvK8ZdSguNm6NL8g.png"/></div></figure><p id="bda1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该部分的目标是将传感器数据连续存储在可扩展的数据库中，以便进行可视化和数据分析。在谷歌云服务中，有多种方法可以实现这一点。我主要遵循这些教程:</p><ul class=""><li id="f828" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd kt ku kv kw dt translated"><a class="ae ke" href="https://cloud.google.com/community/tutorials/cloud-iot-rtdp" rel="noopener ugc nofollow" target="_blank">利用云物联网核心进行实时数据处理</a></li><li id="fec2" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated"><a class="ae ke" rel="noopener" href="/google-cloud/build-a-weather-station-using-google-cloud-iot-core-and-mongooseos-7a78b69822c5">使用谷歌云物联网核心和MongooseOS建立气象站</a></li></ul><p id="1bbb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们开始实施一个基于Goolge Cloud提供的标准服务的可扩展解决方案。之后，我们用云函数替换云流引擎，以增加底层服务的透明度，并比较受限的可扩展版本(它甚至可以免费运行于少数设备和原型)</p><h2 id="67f8" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">实施情况和结果概述</h2><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff lx"><img src="../Images/56c177013798a2bacdd37d6c459b392a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CkU_VtJsNrQspiP6TWxQ9A.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Implemented (costs estimated) solution</figcaption></figure><p id="cdc2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该设备通过node.js MQTT(消息队列遥测传输)代理装载。使用RSA公钥/私钥加密—物联网核心，因为设备注册表保存了设备的公钥，用于加密通信<strong class="jk hu"> M2 </strong>。从那里，我们使用发布/订阅来收集数据<strong class="jk hu"> </strong>，并通过云流/云函数将它拉至我们的数据库(大查询)。可视化是在数据工作室<strong class="jk hu"> M3 </strong>的帮助下实现的</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mg"><img src="../Images/f16a4e8d97671295c1e6962389afbc42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*vAshu5uFQda6qk9yTbiwTg.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">State of implementation (M0 — M3)</figcaption></figure><p id="cc0f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">对于当前没有用户、只有设备接收数据的实施，物联网核心成本最高，其次是云功能的计算成本。接收的消息最少1024字节。这就是我们较高的净接收量的原因(因为我们的消息大约有100字节，MQTT开销稍多一点)。每台设备的成本随着设备的增加而增加，原型是免费的<strong class="jk hu"> K1 </strong>。服务价格包括维护和更新基础设施以及保证它们的安全。</p><p id="3cc5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在软件方面，通过MQTT node.js库实现设备代理相对容易，并且存在各种入门教程<strong class="jk hu"> K3 </strong>。设备管理(物联网核心)解释得很好。有足够的文档可用，但是对于数据的可视化来说，它的服务组合相当复杂。<strong class="jk hu">直接从浏览器进入云外壳的可能性以及针对不同服务的可用逐步教程是很棒的K4。</strong>所有实施的里程碑(<strong class="jk hu"> M1-M3 </strong>)都提供了开箱即用的各种不同的可能服务，包括通过K5数据工作室<strong class="jk hu">的可视化。</strong>除了所有这些优点(你现在已经知道我已经接近粉丝了)，定义数据存储或处理位置的无限可能性使该平台适合IP(知识产权)、ECC(出口管制分类)和其他可能的责任。另一方面，这种自由选择增加了实现的复杂性。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mh"><img src="../Images/96a47f1ff0fc4deb1f5437d0816d9200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lppbg65R4hh-n3-Qwv459A.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Google Cloud estimated costs running with Cloud Function.</figcaption></figure><p id="d7ae" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我已经为此实现创建了一个<a class="ae ke" href="https://tell-me-more-iot.appspot.com" rel="noopener ugc nofollow" target="_blank">配置器</a>，您可以使用它来研究我是如何得出不同服务的成本的。输入有</p><ul class=""><li id="5c37" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd kt ku kv kw dt translated"><strong class="jk hu">量器</strong> <em class="kf">(本例:1；100;1000;10.000) </em></li><li id="9c91" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated"><strong class="jk hu">消息大小</strong> <em class="kf">(本例:100字节)</em></li><li id="da00" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated"><strong class="jk hu">消息频率</strong> <em class="kf">(我们的情况是:每台设备每分钟20条消息)</em></li></ul><div class="mi mj fm fo mk ml"><a href="https://tell-me-more-iot.appspot.com/books/5634472569470976" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab ej"><div class="mn ab mo cl cj mp"><h2 class="bd hu fv z el mq eo ep mr er et hs dt translated">谷歌云平台上的谷歌云物联网配置器- Node.js</h2><div class="ms l"><h3 class="bd b fv z el mq eo ep mr er et ek translated">服务成本细目</h3></div><div class="mt l"><p class="bd b gc z el mq eo ep mr er et ek translated">tell-me-more-iot.appspot.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz km ml"/></div></div></a></div><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/947c9ea7db6c7888dec0fb7a74dcad2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c_jVhwAQYcC5vbP41j8oAg.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Screen of my cost configuration app (naturally running on Google Cloud App engine)</figcaption></figure><p id="583a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">当然还有官方的更复杂的成本估算器——有更多的功能和服务。<a class="ae ke" href="https://cloud.google.com/pricing/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pricing/</a></p><p id="0b87" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在此第2部分实施(M0-M3)中，<strong class="jk hu">尚未包括</strong>:<strong class="jk hu">用户管理— </strong>个人可视化和事件建议。<strong class="jk hu">高效的数据存储</strong>方便用户快速查询。<strong class="jk hu">为用户提供自动化数据分析</strong>。</p><h1 id="4351" class="nb ld ht bd le nc nd ne li nf ng nh lm iz ni ja lp jc nj jd ls jf nk jg lv nl dt translated">高度可扩展的实施</h1><p id="c9ae" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">该解决方案基于设备上的</p><ol class=""><li id="ea4a" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd nr ku kv kw dt translated"><strong class="jk hu">物联网核心</strong>。这里，设备通过设备所有者提供的公钥/私钥(非对称加密)进行注册。<em class="kf">我们只将数据从设备发送到谷歌云物联网核心。设备管理器可以做更多事情，例如更新设备配置(包括回滚等。)</em></li><li id="242b" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated">该设备运行node.js程序，通过<strong class="jk hu"> MQTT </strong>(消息队列遥测传输)协议将传感器数据发送到注册表。</li><li id="d9c4" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated">从那里，我们在<strong class="jk hu"> Pub/Sub </strong>中为这个注册中心创建一个订阅。</li><li id="8d00" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated"><strong class="jk hu">数据流</strong>用于从该订阅中获取数据，并将其永久存储到数据库BigQuery中。</li><li id="d93f" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated"><strong class="jk hu"> BigQuery </strong>保存存储模式，可通过API或Data Studio查询</li><li id="9654" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated"><strong class="jk hu"> Data Studio </strong>用于可视化、报告和手动分析。</li></ol><p id="d898" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">你可能会问自己，为什么我需要这么多服务来可视化和查询数据？我们在同一条船上——让我们一起找出答案。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff ns"><img src="../Images/6b3637b004e571eef5a546ea523b483e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*LaCW43vHs1cVU2MwRChykw.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Overview of Google cloud services used in this article for the project</em></figcaption></figure><p id="a15d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这种实现仍然不提供</p><ol class=""><li id="cf8a" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd nr ku kv kw dt translated">用户管理—个人可视化和事件建议。</li><li id="de8d" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated">高效的数据存储，方便用户快速查询。</li><li id="94f2" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd nr ku kv kw dt translated">面向用户的自动化数据分析。</li></ol><p id="edb4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果你喜欢自己尝试，请给自己一个免费的谷歌云服务。有一个大约200美元的1年免费试用。此外，也有某些总是自由的限制。</p><p id="e019" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在Google Cloud中，我们可以通过项目标识来区分不同的项目。他们有自己的资源、账单和分析。我们定义了一个新的谷歌云项目。我的项目名称(项目id)是<code class="eh nu nv nw nx b">tell-me-more-iot</code>。这是一个唯一的全局标识符，您需要自己选择一个。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ny"><img src="../Images/7653eb1c462920d2b3a26cc60939df68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a5LRaJ8YXpdFbVIx"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Creating a new project in Google Cloud (project id: tell-me-more-iot)</em></figcaption></figure><p id="c1e1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">也许这里有一个新的概览图(在这个GUI中有相当多的功能)</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff nz"><img src="../Images/2d222f8135338bc374354dc721b3c524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*k2uTKHE5nb3ILSo8GPbJxw.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Some overview for the complex, extensive dashboard of google cloud</em></figcaption></figure><h1 id="7cd0" class="nb ld ht bd le nc nd ne li nf ng nh lm iz ni ja lp jc nj jd ls jf nk jg lv nl dt translated">谷歌物联网核心和发布/订阅</h1><p id="27a2" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">有一个很好的快速入门教程可用于基础入门(甚至是计算实例的虚拟入门——如果你手头没有pi或运行linux的笔记本电脑)</p><p id="00eb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们介绍了通过GUI(图形用户界面)和命令行创建注册表和设备的两种可能性。为此，我展示了两种方法，以后你可以自己决定如何进步</p><h2 id="c250" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">使用图形用户界面</h2><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff oa"><img src="../Images/b9135fed489cacda297f1d4f9c314182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYrpFW827axt7UUu6Z4zqQ.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Creating a IoT Core Registry (and with that a topic for the Pub/Sub)</figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ob"><img src="../Images/713ffdd4f28053f15417610aa49d5ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qknu2OGDjylYhH5u16oQ9g.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Creating the topic for the Pub/Sub during IoT Core registry creation</em></figcaption></figure><p id="85be" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们选择了以下名称:</p><blockquote class="oc od oe"><p id="fab1" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">PROJECT _ ID = " tell-me-more-IOT "<br/>TOPIC _ ID = " tmmiot-TOPIC-1 "<br/>TOPIC _ PATH = " projects/tell-me-more-IOT/topics/"<br/>REGISTRY _ ID = " tmmiot-REGISTRY-1 "<br/>REGION = " Europe-west 1 "</p></blockquote><h2 id="9d53" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">通过云Shell使用命令行</h2><p id="74e0" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">云外壳(终端)是一个短暂的linux debian实例，带有预先配置的软件。您可以使用必要的软件定义自己的docker配置文件(一旦cloud shell打开，就应该部署的映像)。但它已经有了git、node.js，当然还有g Cloud——Google Cloud整个服务组合的CLI(命令行输入)。</p><p id="3e99" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">执行gcloud命令会导致</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="a4fa" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ (tell-me-more-iot)$ <br/><strong class="nx hu">gcloud iot registries create</strong></span><span id="c8e8" class="lc ld ht nx b fv oq on l oo op"><strong class="nx hu">ERROR</strong>: (gcloud.iot.registries.create) argument (<strong class="nx hu">REGISTRY </strong>: — region=REGION): Must be specified.<br/>For detailed information on this command and its flags, <strong class="nx hu">run</strong>:<br/> gcloud iot registries create — help</span></pre><p id="625d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们可以进一步参考帮助，或者您只需使用</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="d2fb" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ (tell-me-more-iot)$ <br/><strong class="nx hu">mkdir scripts<br/>touch createIoT-1.sh<br/>chmod +x createIoT-1.sh<br/>nano createIoT-1.sh</strong></span></pre><p id="9e30" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">复制并粘贴下面的代码(<code class="eh nu nv nw nx b">mkdir</code>创建一个新的文件夹脚本，<code class="eh nu nv nw nx b">touch</code>创建一个名为createIoT-1.sh(我们的shell脚本)的新文件。<code class="eh nu nv nw nx b">chmod +x</code>赋予文件被执行的权利。<code class="eh nu nv nw nx b">nano</code>是一个命令行编辑器/或者您可以使用谷歌的基于网络的云编辑器。)</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="fc7b" class="lc ld ht nx b fv om on l oo op">#!/bin/bash<br/>PROJECT_ID=”tell-me-more-iot”<br/>TOPIC_ID=”tmmiot-topic-1"<br/>TOPIC_PATH=”projects/tell-me-more-iot/topics/”<br/>REGISTRY_ID=”tmmiot-registry-1"<br/>REGION=”europe-west1"<br/>gcloud config set project $PROJECT_ID<br/>gcloud pubsub topics create $TOPIC_ID<br/>gcloud iot registries create $REGISTRY_ID \<br/> — region=$REGION \<br/> — no-enable-http-config \<br/> — enable-mqtt-config \<br/> — event-notification-config=topic=$TOPIC_ID</span></pre><p id="e482" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后使用以下命令执行shell脚本</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="79c5" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ (tell-me-more-iot)$ <br/><strong class="nx hu">./createIoT-1.sh</strong></span></pre><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ny"><img src="../Images/c0dd1c9bcf1cdd88e950ac7f5d0f809e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jfwBC71R373_jqwh"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Creating the registry and sub/pub topic via CLI</em></figcaption></figure><p id="d249" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">此刻没有那么多事情发生，因为我们没有向注册表发送任何东西，也没有定义设备(注册表中我们的<strong class="jk hu"> <em class="kf"> pi </em> </strong>的表示)</p><p id="421f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">让我们开始准备将传感器数据发送到注册表。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff or"><img src="../Images/8b523cbe0cf0cd44bb30439cca8b069a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*t1wRIPJy4LGT1hnIECDbqw.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Status of the implementation</em></figcaption></figure><h1 id="9d61" class="nb ld ht bd le nc nd ne li nf ng nh lm iz ni ja lp jc nj jd ls jf nk jg lv nl dt translated">准备将数据发送到云注册设备的设备</h1><blockquote class="oc od oe"><p id="64fb" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">回到码头。</p></blockquote><p id="4aac" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们为MQTT客户机软件创建了一个文件夹</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="209c" class="lc ld ht nx b fv om on l oo op">@raspberry: ~ $ <br/><strong class="nx hu">mkdir tmmiot &amp;&amp; cd tmmiot</strong></span></pre><p id="b2d5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">提取专用的client node.js脚本(基于这个<a class="ae ke" href="https://github.com/GoogleCloudPlatform/nodejs-docs-samples" rel="noopener ugc nofollow" target="_blank">广泛的示例库</a></p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="8484" class="lc ld ht nx b fv om on l oo op">@raspberry: ~/tmmiot/ $ <br/><strong class="nx hu">git clone </strong><a class="ae ke" href="https://github.com/jhab82/tellMeMoreIoT-MQTTclient" rel="noopener ugc nofollow" target="_blank"><strong class="nx hu">https://github.com/jhab82/tellMeMoreIoT-MQTTclient</strong></a></span></pre><p id="a38c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">一旦下载完成，我们需要在脚本中安装并替换传感器的USB端口名<code class="eh nu nv nw nx b">ttyUSB0</code>(参见<strong class="jk hu">第1部分</strong></p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="71b9" class="lc ld ht nx b fv om on l oo op">@raspberry: ~/tmmiot/tellMeMoreIoT-MQTTclient/ $ <br/><strong class="nx hu">npm install</strong></span></pre><p id="515f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">该程序将运行，但会崩溃，要求一个我们需要创建的私钥文件。</p><ul class=""><li id="3011" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd kt ku kv kw dt translated"><strong class="jk hu">私钥</strong>——解密消息(由我们的设备创建和拥有)</li><li id="2d45" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated"><strong class="jk hu">公钥</strong> —能够加密消息(由我们的设备创建，并与我们的物联网核心注册设备共享)</li></ul><p id="6e31" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">根据本<a class="ae ke" href="https://cloud.google.com/iot/docs/how-tos/credentials/keys" rel="noopener ugc nofollow" target="_blank">教程</a>，我们的设备需要签署一个JSON Web令牌(JWT ),该令牌将被发送到物联网核心用于<strong class="jk hu">身份证明。</strong>此外，我们使用X.509证书，该证书默认在30天后到期，您可以添加<code class="eh nu nv nw nx b">-days 100000</code>以便有更多时间进行设备注册。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="557f" class="lc ld ht nx b fv om on l oo op">@raspberry: ~/tmmiot/tellMeMoreIoT-MQTTclient/ $ <br/><strong class="nx hu">openssl req -x509 -newkey rsa:2048 -keyout rsa_private.pem -nodes -out rsa_cert.pem -subj "/CN=unused"</strong></span></pre><p id="0bc7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">已经创建了两个文件。<code class="eh nu nv nw nx b">rsa_private.pem </code>留在原处，不会与任何人或任何东西共享。我们现在应该将<code class="eh nu nv nw nx b">rsa_cert.pem</code>复制到我们的注册表中。</p><h2 id="e674" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">通过图形用户界面使用设备</h2><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff os"><img src="../Images/1d4082e635aad7fad64f67c76e79afa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVkyD7UdcditX7WAk5UmWg.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Adding the device and to the IoT registry and handing over the public key (this public key was generated on our pi — only for visual aid I have created here with the consol)</em></figcaption></figure><p id="b6c5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们导航到我们的<code class="eh nu nv nw nx b">tmmiot-registy-1</code>并单击create，填写必要的信息，包括将我们的<strong class="jk hu"> RS256_X509 </strong>证书粘贴到公钥值字段中(d <em class="kf">别忘了添加设备)。</em>我们现在已经准备好与云进行安全通信。</p><h2 id="c467" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">将数据发送到云注册中心专用设备</h2><blockquote class="oc od oe"><p id="f3e9" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">回到码头</p></blockquote><p id="41c2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">是时候把传感器数据带到云端了。在您能够启动代理(或客户机启动和数据发送)之前，您需要更改一些变量以适应您在<code class="eh nu nv nw nx b">mqtt-agent.js</code>中的项目。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="cc6a" class="lc ld ht nx b fv om on l oo op">var argv = { projectId: “<strong class="nx hu">tell-me-more-iot</strong>”,<br/> cloudRegion: “<strong class="nx hu">europe-west1</strong>”,<br/> registryId: “<strong class="nx hu">tmmiot-registry</strong>”,<br/> deviceId: “<strong class="nx hu">tmmiot-device-1</strong>”,<br/> privateKeyFile: “rsa_private.pem”,<br/> tokenExpMins: 20,<br/> numMessages: 10,<br/> algorithm: “RS256”,<br/> mqttBridgePort: 443,<br/> mqttBridgeHostname: “mqtt.googleapis.com”,<br/> messageType: “events”,<br/> };</span></pre><p id="053c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我改编了由<a class="ae ke" href="https://github.com/GoogleCloudPlatform/nodejs-docs-samples/tree/master/iot/mqtt_example" rel="noopener ugc nofollow" target="_blank"> Google </a>提供的node.js MQTT客户端示例。客户端每3分钟运行一次。并查询传感器，然后运行2-3秒并产生一个测量点，该测量点以JSON格式的字符串发送到Google cloud registry。每20分钟一次。JSON web令牌得到更新。我们发送的数据是JSON格式的，如下所示:</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="1a23" class="lc ld ht nx b fv om on l oo op">{“id”:”tmmiot-device-1",”time”:1544729995403,”date”:”2018–12–13T19:39:55.403Z”,”pm2p5":5,”pm10":6.8}</span></pre><p id="40ba" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">使用以下方式运行客户端:</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="69ce" class="lc ld ht nx b fv om on l oo op">@raspberry: ~/tmmiot/tellMeMoreIoT-MQTTclient/ $ <br/><strong class="nx hu">node mqtt-agent.js</strong></span></pre><p id="2e2b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">或者使用nohup命令在后台运行程序(即使您关闭了终端)</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="7773" class="lc ld ht nx b fv om on l oo op">@raspberry: ~/tmmiot/tellMeMoreIoT-MQTTclient/ $ <br/><strong class="nx hu">nohup node mqtt-agent.js &gt; out.log 2&gt;&amp;1 &amp;</strong></span></pre><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/655a104fc101a2ee9e650fd3e8a9550e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5pn5y52IOwtUQrF0"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">IoT Core registry and first heartbeat and data received from the device</figcaption></figure><h2 id="93cf" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">创建主题订阅</h2><p id="3121" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">为了接收或处理数据，我们需要订阅发布/订阅主题。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="3062" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ (tell-me-more-iot)$<br/><strong class="nx hu">gcloud pubsub subscriptions create tmmiot-subscription <br/>-topic=tmmiot-topic-1</strong></span></pre><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ot"><img src="../Images/5b875fc171c5fff28a1122e2e5d01ec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUUfgiQ_TpPZVfiG5d7RLw.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Pulled sensor data by command line on Cloud Shell</figcaption></figure><p id="6206" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">订阅将在主题被请求(拉)时发送消息，并将消息保留7天(此持续时间可以是有限的或延长的)。一旦消息被接收并得到确认，它就不再存在于主题/注册表中。</p><p id="2f81" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">由于我们已经向主题发送了一些传感器数据，并且有了订阅，我们可以拉取(请求数据)—拉取不会以任何定义的顺序传递消息。下面的代码只是提取一条消息并确认它。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="4f52" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ (tell-me-more-iot)$ <br/><strong class="nx hu">gcloud pubsub subscriptions pull -auto-ack tmmiot-subscription</strong></span></pre><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff ou"><img src="../Images/620252559ec28c1cf7d5831d2f021afa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*RubvfjUZQJ5_YULPIWifLQ.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Status of the implementation</em></figcaption></figure><p id="b94e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu"> <em class="kf"> pi </em> </strong>通宵运行，我们可以在注册表中看到对设备的监控</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/1d84f5ee3083145382f4e84f02288b1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_dUKyatcsRgotmwt"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Monitoring of the device registry in Google IoT — Bytes received peaks at 640B every 20min (JSON web token renewal) and around 128B for the message every 3 min.</em></figcaption></figure><h1 id="9e0f" class="nb ld ht bd le nc nd ne li nf ng nh lm iz ni ja lp jc nj jd ls jf nk jg lv nl dt translated">将订阅数据流式传输到BigQuery</h1><p id="56ed" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">将数据从发布/订阅流传输到BigQuery数据库是非常容易的。</p><p id="826f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Google Cloud Flow函数运行一个模板Java应用程序，该应用程序将所有JSON格式的字符串数据流式传输到一个具有等效模式的预定义BigQuery数据库中。我们发送的数据需要如下所示的数据库</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="f42d" class="lc ld ht nx b fv om on l oo op">{“id”:”tmmiot-device-1",”time”:1544729995403,”date”:”2018–12–13T19:39:55.403Z”,”pm2p5":5,”pm10":6.8}</span></pre><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff ov"><img src="../Images/8307046452e8468989453fe4d37d92be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*o4leb_nY8TA8Gd2GKiUHfQ.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Database schema represented by a simple table</figcaption></figure><h2 id="545f" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">创建大查询数据库</h2><p id="28b3" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">让我们使用命令行来创建数据库并添加我们的模式。首先，我们需要定义一个JSON格式的文件<code class="eh nu nv nw nx b">tmmiot_table_schema.json</code>，并将其存储在我们的cloudshell中。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="69e2" class="lc ld ht nx b fv om on l oo op">[<br/> {<br/> “description”: “device-id”,<br/> “name”: “id”,<br/> “type”: “STRING”,<br/> “mode”: “NULLABLE”<br/> },<br/> {<br/> “description”: “Measurement time”,<br/> “name”: “time”,<br/> “type”: “STRING”,<br/> “mode”: “NULLABLE”<br/> },<br/> {<br/> “description”: “Measurement date”,<br/> “name”: “date”,<br/> “type”: “STRING”,<br/> “mode”: “NULLABLE”<br/> },<br/> {<br/> “description”: “Sensor 1”,<br/> “name”: “pm2p5”,<br/> “type”: “STRING”,<br/> “mode”: “NULLABLE”<br/> },<br/> {<br/> “description”: “Sensor 2”,<br/> “name”: “pm10”,<br/> “type”: “STRING”,<br/> “mode”: “NULLABLE”<br/> }<br/>]</span></pre><p id="90b0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">创建数据集<code class="eh nu nv nw nx b">tmmiot_dataset</code></p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="0b51" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ <br/><strong class="nx hu">bq mk — dataset tell-me-more-iot:tmmiot_dataset</strong></span></pre><p id="2269" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，我们用JSON格式的模式向数据集添加一个表<code class="eh nu nv nw nx b">tmmiot_table</code></p><blockquote class="oc od oe"><p id="e5a4" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">bq mk —表[项目标识]:[数据集]。[表格][模式文件的路径]</p></blockquote><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="4fab" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ <br/><strong class="nx hu">bq mk -table tell-me-more-iot:tmmiot_dataset.tmmiot_table tmmiot_table_schema.json</strong></span></pre><p id="b239" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="kf">提示:与之前的CLI不同，我们不会使用</em><strong class="jk hu"><em class="kf">g cloud</em></strong><em class="kf">作为命令，而是使用</em> <strong class="jk hu"> <em class="kf"> bq </em> </strong> <em class="kf">。</em></p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/e902e5416d111c7a7cd517064eb032e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c1nWirp190gdo-VP"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">BigQuery dataset with table and schema</em></figcaption></figure><h2 id="bc5a" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">为BigQuery创建云流</h2><blockquote class="oc od oe"><p id="5900" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated"><strong class="jk hu">请在测试后删除数据流作业，因为这项服务是为高性能而设计的，而且随着时间的推移会让你花钱</strong></p></blockquote><p id="0994" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们的传感器数据仍然没有被永久记录。订阅只能保存7天的遥测事件数据。我们希望永久存储数据和最简单且高度可扩展的解决方案——我们使用来自Google Cloud Flow 的<a class="ae ke" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates#cloudpubsubtobigquery" rel="noopener ugc nofollow" target="_blank">模板。</a></p><p id="dc41" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了使用cloud flow，我们需要首先定义一个用于存储临时文件的数据桶。</p><p id="fc80" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="kf">提示:这里我们使用</em><strong class="jk hu"><em class="kf"/></strong><code class="eh nu nv nw nx b"><strong class="jk hu"><em class="kf">gsutil</em></strong></code><strong class="jk hu"><em class="kf"/></strong><em class="kf">来创建和访问google cloud的存储功能，这些功能是以桶的形式组织的。您当然可以再次使用GUI。</em></p><blockquote class="oc od oe"><p id="823a" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">gsutil m B- p[项目名称]-c[存储类别]-l[存储桶位置]GS://[存储桶名称]/</p></blockquote><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="1bbc" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ <br/><strong class="nx hu">gsutil mb -p tell-me-more-iot gs://tmmiot_bucket_1</strong></span></pre><p id="1c9b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">要创建一个子文件夹，我们需要将<code class="eh nu nv nw nx b">cp</code>文件复制到子目录中。</p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="8600" class="lc ld ht nx b fv om on l oo op">@cloudshell:~ <br/><strong class="nx hu">touch tmp_test<br/>gsutil cp tmp_test gs://tmmiot_bucket_1/tmp/</strong></span></pre><p id="05a9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">当然，这也可以通过GUI来实现</p><p id="93a9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><em class="kf">提示:我们已经创建了存储，但还没有考虑存储位置。如果你需要你的数据在一个特定的地方，你需要指定</em></p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/a0021581a076cd957d2410cc547d4a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RG5bVzI-TDwfUikK"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Further we open the Dataflow GUI and create a new job</figcaption></figure><p id="8808" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">此外，我们打开Dataflow GUI并创建一个新作业。作业名称<code class="eh nu nv nw nx b">tmmiot-dataflow</code>和云数据流模板:<strong class="jk hu">云发布/订阅BigQuery </strong></p><blockquote class="oc od oe"><p id="3a54" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">作业名称:<strong class="jk hu"> tmmiot-dataflow <br/> </strong>云数据流模板:<strong class="jk hu">Cloud Pub/Sub to big query<br/></strong>区域端点:<strong class="jk hu">Europe-west 1<br/></strong>Cloud Pub/Sub输入主题:<strong class="jk hu">projects/tell-me-more-IOT/topics/tmmiot-topic-1<br/></strong>big query输出表:<strong class="jk hu">tell-me-more-IOT:tmmiot _ dataset . tmmiot _ table<br/></strong>临时位置:)</p><p id="a709" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">提示:n1-standard-1是能够用于此模板的最小机器(我们尝试了f1-micro，但出现了下一个错误)。如果不移交最大工作线程和机器类型，默认情况下将有4个工作线程和n1个标准4(4个vCPUs和15GB RAM)。</p></blockquote><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ow"><img src="../Images/e6b0bce68abecd04d490998d75ae5aa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yjqRFHU8OtA0EH9o"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Error when trying to use a f1-micro compute engine as the data flow engine</em></figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ox"><img src="../Images/0066c67393c50a08e0de7a8f10e78096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzyTXjYwjho1a02D12qrRA.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Creation of the dataflow job and view of the compute instance where the job is running</em></figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/ff1372432b13a8fcef1a00a445563d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dWFBl_Tnjsa6sRNk"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Dataflow overview with resource metrics</em></figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/3fc9d3a29dd1b9c6aaa20759808d8788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*orrrRjwI8oqYk-3S"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Querying the database after 9 min data flow running</em></figcaption></figure><blockquote class="oc od oe"><p id="1efe" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">提示:数据流作业只能停止，不能完全删除。该作业将显示在概览中。例如，如果您输入了存储段名称，则作业会失败，并将保留在概览中。由于我已经在一夜之间将数据输入到主题(Pub/Sub)中，所以我会假设将所有未确认的消息都推入数据库中。但在等待9分钟后，我们只看到三个条目，这意味着流媒体服务只考虑新消息。</p></blockquote><p id="9c70" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">JAVA模板<a class="ae ke" href="https://github.com/GoogleCloudPlatform/DataflowTemplates/blob/master/src/main/java/com/google/cloud/teleport/templates/PubSubToBigQuery.java" rel="noopener ugc nofollow" target="_blank">源代码声明</a></p><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="204e" class="lc ld ht nx b fv om on l oo op">/** * The {@link PubSubToBigQuery} pipeline is a streaming pipeline which ingests data in JSON format * from Cloud Pub/Sub, executes a UDF, and outputs the resulting records to BigQuery. Any errors * which occur in the transformation of the data or execution of the UDF will be output to a * separate errors table in BigQuery. The errors table will be created if it does not exist prior to * execution. Both output and error tables are specified by the user as template parameters.</span></pre><blockquote class="oc od oe"><p id="be3b" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">提示:这个流量引擎对于我们一个单独的传感器来说太大了——但是一旦你有了更多的流量，你就知道去哪里找了😄</p></blockquote><h1 id="7664" class="nb ld ht bd le nc nd ne li nf ng nh lm iz ni ja lp jc nj jd ls jf nk jg lv nl dt translated">使用Data Studio可视化数据</h1><p id="e0a3" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">这是实现我们故事目标的最后一步。但是在我们进入第3部分之前，我们将替换数据流服务，以便创建相同功能的可伸缩性较低的版本，从而实现更好的透明性，并节省一些欧元。</p><p id="ca96" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">让我们尝试从我们的传感器可视化PM10和PM2.5的时间序列(因为我们只有一个设备，所以我们只做这个)。</p><ul class=""><li id="18f5" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd kt ku kv kw dt translated">导航到<a class="ae ke" href="http://datastudio.google.com" rel="noopener ugc nofollow" target="_blank">datastudio.google.com</a>并创建一个新报告。</li><li id="ab88" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated">将您的BigQuery连接到此报表</li><li id="4174" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated">配置以文本形式读入的日期</li><li id="4a70" class="ko kp ht jk b jl kx jo ky jr kz jv la jz lb kd kt ku kv kw dt translated">创建新字段，将日期字符串转换为YYYYMMDDHH格式</li></ul><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="9e58" class="lc ld ht nx b fv om on l oo op"><strong class="nx hu">TODATE</strong>(date, ‘RFC_3339’, ‘%Y%m%d%H’)</span></pre><ul class=""><li id="9b43" class="ko kp ht jk b jl jm jo jp jr kq jv kr jz ks kd kt ku kv kw dt translated">将传感器数据配置为平均值(或最大值或最小值)</li></ul><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff oy"><img src="../Images/d14efa0bb39436de61fd6f6161157c1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*inAM-osP64K6LW4I1MqVmQ.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Create a new report with Data Studio connected to BigQuery</em></figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff na"><img src="../Images/247d45c75076a35d9a4cb611135aaab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c7cHKGtAYNvzFoMv"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek"><em class="nt">Visualization of sensor data in Google Cloud Studio</em></figcaption></figure><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff oz"><img src="../Images/78c7b4073486d5a0082429553ae16992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*-xX4mFv3NzPo2IFPfJ-Vrw.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Overview of implementation</figcaption></figure><h2 id="ce15" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">演员表</h2><p id="bd16" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">离开这个运行约26小时后，帐单显示我约2，50€消费。全部连接到云数据流引擎。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff pa"><img src="../Images/1c27dc540828f043195dec9507b5e05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1R_KwNqgVppczVhvSlVnA.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Screen from the billing for tell-me-more-iot project</figcaption></figure></div><div class="ab cl pb pc hb pd" role="separator"><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg"/></div><div class="hm hn ho hp hq"><h1 id="5ef0" class="nb ld ht bd le nc pi ne li nf pj nh lm iz pk ja lp jc pl jd ls jf pm jg lv nl dt translated">用云函数替换数据流</h1><p id="b214" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">让我们快速替换数据流作业(旨在处理大量遥测事件),并将其替换为可扩展性较差但部署迅速的解决方案。它的云功能。</p><p id="4096" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">云功能只是在应用程序或计算引擎帐户上使用预定义的分配内存运行。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff pn"><img src="../Images/fa304d3ff07d595bb7b1751fbd967275.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C3BCp0fRM0RW2Ne7n0IUOA.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Cloud Function setup</figcaption></figure><blockquote class="oc od oe"><p id="15de" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated"><strong class="jk hu"> index.js </strong></p></blockquote><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="4179" class="lc ld ht nx b fv om on l oo op">/**<br/> * Triggered from a message on a Cloud Pub/Sub topic.<br/> *<br/> * @param {!Object} event Event payload and metadata.<br/> * @param {!Function} callback Callback function to signal completion.<br/> */<br/>exports.pubsubToBQ = (event, callback) =&gt; {<br/> <strong class="nx hu">const</strong> pubsubMessage = event.data;</span><span id="b32a" class="lc ld ht nx b fv oq on l oo op"><strong class="nx hu">const</strong> BigQuery = require(‘@google-cloud/bigquery’);<br/> <strong class="nx hu">const</strong> bigquery = <strong class="nx hu">new</strong> BigQuery();</span><span id="32aa" class="lc ld ht nx b fv oq on l oo op">bigquery<br/>    .dataset("tmmiot_dataset")<br/>    .table  ("tmmiot_table")<br/>    .insert (JSON.parse(Buffer.from(pubsubMessage.data, 'base64').toString()), {'ignoreUnknownValues':true, 'raw':false})<br/>    .then   ((data) =&gt; {<br/>      console.log(`Inserted 1 rows`);<br/>      console.log(data);<br/>    })<br/>    .catch(err =&gt; {<br/>      <strong class="nx hu">if</strong> (err &amp;&amp; err.name === 'PartialFailureError') {<br/>        <strong class="nx hu">if</strong> (err.errors &amp;&amp; err.errors.length &gt; 0) {<br/>          console.log('Insert errors:');<br/>          err.errors.forEach(err =&gt; console.error(err));<br/>        }<br/>      } <strong class="nx hu">else</strong> {<br/>        console.error('ERROR:', err);<br/>      }<br/>    });<br/><br/><br/>  callback();<br/>};</span></pre><blockquote class="oc od oe"><p id="f5d7" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated"><strong class="jk hu"> packages.json </strong></p></blockquote><pre class="kh ki kj kk fq oi nx oj ok aw ol dt"><span id="4037" class="lc ld ht nx b fv om on l oo op">{<br/> “name”: “pubsubToBigQuery”,<br/> “version”: “0.0.1”,<br/> “dependencies”: {<br/> “@google-cloud/bigquery”: “^.3.0”<br/> }<br/>}</span></pre><blockquote class="oc od oe"><p id="5904" class="ji jj kf jk b jl jm iu jn jo jp ix jq of js jt ju og jw jx jy oh ka kb kc kd hm dt translated">提示:如果您自己尝试，请更改数据集和表的名称</p></blockquote><p id="38f5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们用更小的解决方案云功能取代了Cloudflow(大数据)。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff po"><img src="../Images/1cdae55642ea57f7f3e733001905a5c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*omY7P6Bm1YuYb9Zon8yh7A.png"/></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Overview of implementation</figcaption></figure><h2 id="a41f" class="lc ld ht bd le lf lg lh li lj lk ll lm jr ln lo lp jv lq lr ls jz lt lu lv lw dt translated">演员表</h2><p id="8735" class="pw-post-body-paragraph ji jj ht jk b jl nm iu jn jo nn ix jq jr no jt ju jv np jx jy jz nq kb kc kd hm dt translated">大约24小时后，云功能不再收费。只注册了9次调用，但是每3分钟可靠地执行一次函数。这是最有可能的，因为云函数是如何计算调用的。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff pp"><img src="../Images/cc812aedbec67c9966171558a232a320.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Fy57nI7njLxczx6HJ8ozg.png"/></div></div><figcaption class="mc md fg fe ff me mf bd b be z ek">Filtered billable services for Cloud Function after leaving it 24h running</figcaption></figure></div><div class="ab cl pb pc hb pd" role="separator"><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg"/></div><div class="hm hn ho hp hq"><p id="cc80" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我喜欢你的评论、更正和建议👌。</p></div></div>    
</body>
</html>