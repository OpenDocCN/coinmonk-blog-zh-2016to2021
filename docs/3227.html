<html>
<head>
<title>How to optimize ETH smart contract size — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何优化ETH智能合约规模—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-optimize-eth-smart-contract-size-part-1-a393f444a1df?source=collection_archive---------0-----------------------#2020-08-03">https://medium.com/coinmonks/how-to-optimize-eth-smart-contract-size-part-1-a393f444a1df?source=collection_archive---------0-----------------------#2020-08-03</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="19c1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">根据智能合同实施业务项目是一项相当困难的工作。由于有必要以这样一种方式来设计契约，即操作的执行不会占用大量的气体，因此代码看起来简单明了，甚至考虑到了对具有可靠数据结构的操作的所有限制。</p><p id="9013" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">大型项目出现的一个主要问题是，合同规模超过了部署的允许规模，不符合区块链限制。在这种情况下，当您尝试部署契约时，可能会收到类似open zeppelin sdk中的<code class="eh jo jp jq jr b">deployment failed with error: oversized data</code>或truffle中的<code class="eh jo jp jq jr b">VM Exception while processing transaction: out of gas</code>这样的错误。</p><p id="a32e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有许多方法来组织项目中的合同代码，以使每个合同适合所需的大小，但在本文中，我们将研究如何使用库将合同的一些内容移动到库中。</p><h2 id="4d0c" class="js jt ht bd ju jv jw jx jy jz ka kb kc jb kd ke kf jf kg kh ki jj kj kk kl km dt translated">什么是最大合同规模，如何检查当前合同规模</h2><p id="54e0" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">契约内容的大小上限约为24577字节，您必须将契约逻辑放入这个小尺寸中。</p><p id="23c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<code class="eh jo jp jq jr b">truffle compile</code>对您的合同进行编译后——编译的结果将被保存到<code class="eh jo jp jq jr b">build</code>文件夹中。然后，您可以通过文件夹中的合同名称访问任何合同，并通过如下代码获得<code class="eh jo jp jq jr b">deployedBytecode</code>的大小:</p><pre class="ks kt ku kv fq kw jr kx ky aw kz dt"><span id="a73a" class="js jt ht jr b fv la lb l lc ld">const contractPath = `build/contracts/MyContract.json`;<br/>const obj = <strong class="jr hu"><em class="le">JSON</em></strong>.parse(fs.readFileSync());<br/>const size = Buffer.<em class="le">byteLength</em>(obj.deployedBytecode, 'utf8') / 2;</span><span id="141b" class="js jt ht jr b fv lf lb l lc ld">console.log('contract size is', size);</span></pre><p id="6983" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您可以从<a class="ae lg" href="https://gist.github.com/Jonybang/110799f0765b0da5c4809e3f314f7fa7" rel="noopener ugc nofollow" target="_blank"> gist </a>中获得用于记录您在<code class="eh jo jp jq jr b">build</code>文件夹中的所有合同的脚本。现在让我们来看看解决智能合同大小问题的方法之一。</p><h2 id="92b2" class="js jt ht bd ju jv jw jx jy jz ka kb kc jb kd ke kf jf kg kh ki jj kj kk kl km dt translated">将逻辑从智能合约移动到库</h2><p id="a3b4" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">让我们举一个我们可以优化的智能合约的简单例子。以及我们如何使用库来改进这些代码。</p><figure class="ks kt ku kv fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="7296" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里我们有<code class="eh jo jp jq jr b">PolygonData</code>结构、<code class="eh jo jp jq jr b">polygons</code>映射、两个简单的获取和设置数据的函数:<code class="eh jo jp jq jr b">addPolygonPoint</code> <code class="eh jo jp jq jr b">isInsidePolygonById</code>和一个复杂的内部函数<code class="eh jo jp jq jr b">isInsidePolygon</code>。最后一个函数，我们可以把它作为公共函数转移到图书馆。但是因为这个函数使用了<code class="eh jo jp jq jr b">PolygonData</code>结构，所以我们也应该移动这个函数。让我们来看看结果库:</p><figure class="ks kt ku kv fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="0b7a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">像<code class="eh jo jp jq jr b">PolygonUtils</code>这样的库可以通过用<code class="eh jo jp jq jr b">storage</code>修饰符传递参数来使用其他契约的存储。现在，我们可以访问<code class="eh jo jp jq jr b">PolygonData</code>结构中的任何字段，即使是数组、映射或其他结构——你可以定义结构中的任何数据，并在库中使用它来获取或设置其中的值。合同现在看起来怎么样？</p><figure class="ks kt ku kv fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="f8df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">哦，它看起来很简单也很可爱。ETH smart contracts中的库——这是一个强大的工具，不仅可以优化您的合同，还可以使您的合同代码更好，并遵循软件开发的DRY and KISS概念。</p><p id="b1b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是不要忘记，您必须在部署和测试中将您的库链接到契约，如下所示:</p><pre class="ks kt ku kv fq kw jr kx ky aw kz dt"><span id="0bfc" class="js jt ht jr b fv la lb l lc ld">const PolygonChecker = artifacts.require('PolygonChecker');<br/>const PolygonUtils = artifacts.require('PolygonUtils');</span><span id="5974" class="js jt ht jr b fv lf lb l lc ld">const utils = await PolygonUtils.new();</span><span id="599d" class="js jt ht jr b fv lf lb l lc ld">PolygonChecker.link('LandUtils', utils.address);</span><span id="0016" class="js jt ht jr b fv lf lb l lc ld">const checker = await PolygonChecker.new();</span></pre><p id="a9fb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">附注<a class="ae lg" href="https://twitter.com/mudgen" rel="noopener ugc nofollow" target="_blank">尼克·穆奇</a>和我分享了另一种类似的方式<a class="ae lg" href="https://dev.to/mudgen/solidity-libraries-can-t-have-state-variables-oh-yes-they-can-3ke9" rel="noopener ugc nofollow" target="_blank">通过“钻石存储”</a>将你的契约逻辑移到库中——就是将结构放在契约存储中明确指定的位置。</p><p id="39ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可以在推特里问我和关注:<a class="ae lg" href="https://twitter.com/jony_bang" rel="noopener ugc nofollow" target="_blank">https://twitter.com/jony_bang</a></p><p id="1103" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">也加入我们的<a class="ae lg" href="https://discord.gg/hjyhqVk" rel="noopener ugc nofollow" target="_blank">不和谐社区</a>进行讨论。</p></div></div>    
</body>
</html>