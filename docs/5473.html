<html>
<head>
<title>Full Knowledge User Proofs: working with storage without paying for gas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">完全了解用户证据:无需支付天然气费用即可使用储物空间</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/full-knowledge-user-proofs-working-with-storage-without-paying-for-gas-e124cef0c078?source=collection_archive---------3-----------------------#2021-09-23">https://medium.com/coinmonks/full-knowledge-user-proofs-working-with-storage-without-paying-for-gas-e124cef0c078?source=collection_archive---------3-----------------------#2021-09-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><blockquote class="iq ir is"><p id="1081" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hm dt translated"><a class="ae js" href="#59a0" rel="noopener ugc nofollow">问题陈述</a> <br/> <a class="ae js" href="#54f3" rel="noopener ugc nofollow">标准方法</a><br/><a class="ae js" href="#a0d4" rel="noopener ugc nofollow">Let ' s get schwifty</a><br/><a class="ae js" href="#1d0b" rel="noopener ugc nofollow">局限性</a> <br/> <a class="ae js" href="#b489" rel="noopener ugc nofollow">加成1:更便宜的哈希计算</a> <br/> <a class="ae js" href="#9d37" rel="noopener ugc nofollow">结论</a> <br/> <a class="ae js" href="#db08" rel="noopener ugc nofollow">鸣谢</a></p></blockquote><p id="4abb" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated"><a class="ae js" href="https://github.com/alcueca/solidity-mentorship/issues" rel="noopener ugc nofollow" target="_blank">收益导师计划</a>提供给你解决的问题之一是<a class="ae js" href="https://github.com/alcueca/solidity-mentorship/issues/6" rel="noopener ugc nofollow" target="_blank">建立一个多抵押品的金库</a>。它漫不经心地提到了燃气效率，但没有设定任何目标。自然，我必须看看我能把汽油用量推到多低。</p><h1 id="59a0" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">问题陈述</h1><p id="bbf6" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">这是它的一个简化版本:一个(单用户)金库，用户可以从“祝福”列表中存入令牌作为抵押，并以此为抵押借用戴。</p><p id="f78b" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">让我们尝试优化<code class="eh kz la lb lc b">borrow()</code>气体效率！为了让事情变得有趣，我们将假设用户在金库中添加了100种不同的抵押品类型。</p><h1 id="54f3" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">标准方法</h1><p id="9b55" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">考虑到气体效率的标准方法可能是这样的(不考虑访问控制和多用户支持):</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="ce2b" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated"><code class="eh kz la lb lc b">borrow()</code>简单地遍历用户存放的所有抵押品，将它们的价格相加，并允许用户借入该金额。</p><p id="ff64" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">我们负担不起为用户的每笔存款调用外部oracle(<a class="ae js" href="https://eips.ethereum.org/EIPS/eip-2929#abstract" rel="noopener ugc nofollow" target="_blank">每次调用至少使用2600 gas </a>)，所以我们将资产价格存储在<code class="eh kz la lb lc b">Assets</code>结构中，并有一个触发另一个契约的链外流程，该契约每10分钟调用一次Oracle，然后每10分钟调用一次<code class="eh kz la lb lc b">setAssetPrices()</code>。<strong class="iw hu">无外线来电</strong> <code class="eh kz la lb lc b"><strong class="iw hu">borrow()</strong></code> <strong class="iw hu"> - &gt;降低用户燃气费用。<br/></strong></p><p id="4356" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">总的来说，每次调用borrow()花费我们100项资产约60万美元，1项资产约5.3万美元。</p></div><div class="ab cl lk ll hb lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hm hn ho hp hq"><h1 id="a0d4" class="jw jx ht bd jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp lv kr ks kt dt translated">我们去睡觉吧</h1><p id="ed68" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">访问契约存储是以太坊中开销最大的操作之一。在我们的<code class="eh kz la lb lc b">borrow()</code>函数中我们做了很多:至少100次获取存款余额/资产ID，另外100次获取资产价格。每一次存储<a class="ae js" href="https://eips.ethereum.org/EIPS/eip-2929#abstract" rel="noopener ugc nofollow" target="_blank">读取花费我们2100 </a>，所以那是2100 * 200 = 400k汽油。我们可以压缩一下<code class="eh kz la lb lc b">Asset</code>和<code class="eh kz la lb lc b">Deposit</code>结构，也许可以减少一半，但是20万还是很多。</p><p id="12dc" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">幸运的是，<code class="eh kz la lb lc b">borrow()</code>根本不用访问存储。如果<code class="eh kz la lb lc b">assets</code>和<code class="eh kz la lb lc b">deposits</code>在<a class="ae js" href="https://docs.soliditylang.org/en/latest/types.html#data-location" rel="noopener ugc nofollow" target="_blank">调用数据</a>中可用，我们就可以从那里读取它们。访问呼叫数据只需要3块钱，不会比这更低了。</p><p id="4933" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">实现起来很简单，<code class="eh kz la lb lc b">borrow()</code>看起来和初始版本几乎一样:</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="c24f" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">客户端:</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="4f5d" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">我们只是简单地要求用户给我们函数运行所需的全部数据。</p><p id="5ea9" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">现在，有一个明显的问题:用户可以对他们的存款撒谎，我们不能盲目信任他们。我们需要用户向我们提供<strong class="iw hu">证明</strong>证明<code class="eh kz la lb lc b">_deposits</code>和<code class="eh kz la lb lc b">_assets</code>与<code class="eh kz la lb lc b">deposits</code>和<code class="eh kz la lb lc b">assets</code>相同。有一种简单的方法可以做到这一点:比较存储值和用户提供值的哈希值</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="1d82" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated"><strong class="iw hu">全知识用户证明(FKUP) </strong>将<code class="eh kz la lb lc b">borrow()</code>100项资产的用气量从约600k降至285k，1项资产的用气量从53k降至52k。</p><h1 id="1d0b" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">限制</h1><p id="a8f9" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">FKUP不是灵丹妙药，有一点局限性:</p><ul class=""><li id="efbd" class="lw lx ht iw b ix iy jb jc jt ly ju lz jv ma jr mb mc md me dt translated">如果你的合同的用户是另一个合同，汽油费就没了。除非他们采用相同的模式，使<code class="eh kz la lb lc b">Asset[] calldata _assets, Deposit[] calldata _deposit</code>成为他们接口的一部分，并简单地将数据传递给你</li><li id="46b6" class="lw lx ht iw b ix mf jb mg jt mh ju mi jv mj jr mb mc md me dt translated">如果您的功能不仅仅是处理存储中的一些数字(想象一下<code class="eh kz la lb lc b">borrow()</code>调用外部oracle获取价格)，那么汽油节省仍然会存在，但它们会被外部调用的成本所掩盖</li><li id="e8a3" class="lw lx ht iw b ix mf jb mg jt mh ju mi jv mj jr mb mc md me dt translated">每次<code class="eh kz la lb lc b">_assets</code>或<code class="eh kz la lb lc b">_deposit</code>改变时，它们的散列都需要重新计算。如果你的数据经常变化，<code class="eh kz la lb lc b">borrow()</code>仍然很节能，但是<code class="eh kz la lb lc b">deposit()</code>和<code class="eh kz la lb lc b">setAssetPrices()</code>可能会抵消这些节省。</li><li id="3672" class="lw lx ht iw b ix mf jb mg jt mh ju mi jv mj jr mb mc md me dt translated">如果数据经常变化，用户数据有可能与最近的合同数据不匹配。如果不希望这样，在散列不匹配的情况下，<code class="eh kz la lb lc b">borrow()</code>可以回退到从存储中读取，而不是恢复。</li></ul></div><div class="ab cl lk ll hb lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hm hn ho hp hq"><h1 id="b489" class="jw jx ht bd jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp lv kr ks kt dt translated">好处1:更便宜的哈希计算</h1><pre class="ld le lf lg fq mk lc ml mm aw mn dt"><span id="26bd" class="mo jx ht lc b fv mp mq l mr ms">function x(uint256 amount, Asset[] calldata _assets) public { <br/>   require(keccak256(abi.encode(_assets)) == assetsChecksum, "assets checksum");<br/>}</span></pre><p id="2d9c" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">这里不需要abi.encode()调用。为什么？_assets位于calldata中，并且已经在客户端用abi.encode()序列化了。唯一的挑战是keccak256不能从calldata中读取，所以我们先用一点汇编把_assets复制到内存中。总的来说，我们又节省了5万吨汽油:</p><figure class="ld le lf lg fq lh"><div class="bz el l di"><div class="li lj l"/></div></figure><p id="b026" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">234k天然气和100项资产，51k天然气和1项资产。</p><p id="01a2" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">有一种方法可以把总的用气量降低到150k，我会把它留到下一篇文章。</p><h1 id="9d37" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">结论</h1><p id="3529" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">我们测试了3个版本的<code class="eh kz la lb lc b">borrow()</code>函数:</p><ol class=""><li id="a6e7" class="lw lx ht iw b ix iy jb jc jt ly ju lz jv ma jr mt mc md me dt translated">香草一号，很好理解，差不多用<strong class="iw hu"> 600k气</strong></li><li id="f441" class="lw lx ht iw b ix mf jb mg jt mh ju mi jv mj jr mt mc md me dt translated">香草FKUP:还是容易理解，用<strong class="iw hu"> 285k气体</strong></li><li id="3e78" class="lw lx ht iw b ix mf jb mg jt mh ju mi jv mj jr mt mc md me dt translated">轻度优化的FKUP:有点难以理解，但仍然可以，<strong class="iw hu"> 234k气体</strong></li></ol><p id="2ce8" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">Vanilla FKUP可能是最划算的，因为它不使用Yul，可以节省2倍的汽油。</p><p id="357f" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">由于<a class="ae js" href="#1d0b" rel="noopener ugc nofollow">的限制</a>，这不是一个放之四海而皆准的模式，但它可能是方便的。</p><p id="74c4" class="pw-post-body-paragraph it iu ht iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hm dt translated">下一篇文章将在Solidity和Yul的混合中增加一个版本，并详细介绍dapptools和C++的比较。</p><h1 id="db08" class="jw jx ht bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dt translated">感谢</h1><p id="b7ce" class="pw-post-body-paragraph it iu ht iw b ix ku iz ja jb kv jd je jt kw jh ji ju kx jl jm jv ky jp jq jr hm dt translated">非常感谢<a class="ae js" href="https://twitter.com/yield?s=20" rel="noopener ugc nofollow" target="_blank">智能合同指导协议</a>和<a class="ae js" href="https://twitter.com/alcueca" rel="noopener ugc nofollow" target="_blank">阿尔贝托</a>是一位令人敬畏的导师。如果你对成为导师或学员感兴趣，请查看<a class="ae js" href="https://ethernautdao.medium.com/introducing-the-ethernautdao-21bfca20ee80" rel="noopener">以太导航</a>。<br/> <a class="ae js" href="https://twitter.com/devtooligan" rel="noopener ugc nofollow" target="_blank"> devtooligan </a>帮助讨论了这个想法的早期版本并编辑了这篇文章。</p><h2 id="ad54" class="mo jx ht bd jy mu mv mw kc mx my mz kg jt na nb kk ju nc nd ko jv ne nf ks ng dt translated">也阅读</h2><div class="nh ni fm fo nj nk"><a href="https://blog.coincodecap.com/crypto-exchange" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">最佳加密交易所| 2021年十大加密货币交易所</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">ICON _ PLACEHOLDEREstimated预计阅读时间:28分钟加密货币交易所的加密交易需要知识…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">blog.coincodecap.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a href="https://blog.coincodecap.com/crypto-lending" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">2021年10大最佳加密贷款平台| CoinCodeCap</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">当谈到加密货币贷款时，大量因素等同于良好的收入状况。此外，借款的一部分…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">blog.coincodecap.com</p></div></div><div class="nt l"><div class="oa l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a rel="noopener follow" target="_blank" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">2021年最佳免费加密交易机器人</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">2021年币安、比特币基地、库币和其他密码交易所的最佳密码交易机器人。四进制，位间隙…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">medium.com</p></div></div><div class="nt l"><div class="ob l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a rel="noopener follow" target="_blank" href="/coinmonks/best-crypto-signals-telegram-5785cdbc4b2b"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">最佳4个加密交易信号电报通道</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">这是乏味的找到正确的加密交易信号提供商。因此，在本文中，我们将讨论最好的…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">medium.com</p></div></div><div class="nt l"><div class="oc l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a href="https://blog.coincodecap.com/blockfi-review" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">BlockFi评论2021:利弊和利率| CoinCodeCap</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">今天，我们提出了一个全面的BlockFi评论，这是一个成立于2017年的加密贷款平台，拥有其…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">blog.coincodecap.com</p></div></div><div class="nt l"><div class="od l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a rel="noopener follow" target="_blank" href="/coinmonks/buy-bitcoin-in-india-feb50ddfef94"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">如何在印度购买比特币？2021年购买比特币的7款最佳应用[手机版]</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">如何使用移动应用程序购买比特币印度</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">medium.com</p></div></div><div class="nt l"><div class="oe l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a rel="noopener follow" target="_blank" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">加密税务软件——五大最佳比特币税务计算器[2021]</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">不管你是刚接触加密还是已经在这个领域呆了一段时间，你都需要交税。</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">medium.com</p></div></div><div class="nt l"><div class="of l nv nw nx nt ny nz nk"/></div></div></a></div><div class="nh ni fm fo nj nk"><a href="https://blog.coincodecap.com/best-hardware-wallet-bitcoin" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">存储比特币的最佳加密硬件钱包[2021] | CoinCodeCap</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">保管您的数字资产很容易，但找到正确的存储方式却是一项繁琐的任务。在线钱包有一个风险…</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">blog.coincodecap.com</p></div></div><div class="nt l"><div class="og l nv nw nx nt ny nz nk"/></div></div></a></div></div></div>    
</body>
</html>