<html>
<head>
<title>Smart Contract Fuzzing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">智能合同模糊化</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/smart-contract-fuzzing-d9b88e0b0a05?source=collection_archive---------0-----------------------#2020-10-30">https://medium.com/coinmonks/smart-contract-fuzzing-d9b88e0b0a05?source=collection_archive---------0-----------------------#2020-10-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="7bee" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">如何找到针鼹的边缘案例</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/e36b89084e03730d70450283558c4d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1M95WFMOXuPNMr1O"/></div></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">Oh, hi!</figcaption></figure><p id="0fd9" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">编写智能合同不适合胆小的人。</p><p id="b2c7" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">最近，我参与了<a class="ae ku" href="http://app.yield.is" rel="noopener ugc nofollow" target="_blank">产出协议</a>的上线。对于没听说过的，它是以太坊的一个固定利率借贷平台。它还实现了一些数学公式，这些公式处于智能合约的边缘。</p><p id="93c3" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><a class="ae ku" href="http://app.yield.is" rel="noopener ugc nofollow" target="_blank">让步协议</a>也是一个“部署并忘记”的平台。一旦我们上市，我们没有办法阻止用户与我们的软件互动，也没有办法修复核心合同中的任何错误。</p><blockquote class="kv"><p id="65fb" class="kw kx ht bd ky kz la lb lc ld le kt ek translated">我们可以像火箭一样上升，然后爆炸。</p></blockquote><p id="ddde" class="pw-post-body-paragraph jy jz ht ka b kb lf iu kd ke lg ix kg kh lh kj kk kl li kn ko kp lj kr ks kt hm dt translated">然而，我们没有。令人惊讶的是，我们遇到的错误数量很少，而且没有一个出现在核心智能合约中。</p><p id="a344" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">其中的一个原因是我们使用了模糊器来发现使用单元测试或集成测试无法发现的边缘情况。使用fuzzer还不是一件常见的事情，许多人要求我写这篇文章，并帮助他们模糊他们的合同。所以我们在这里。</p><p id="b378" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">什么是起毛？</strong></p><p id="90ca" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">通过<a class="ae ku" href="https://en.wikipedia.org/wiki/Fuzzing" rel="noopener ugc nofollow" target="_blank">模糊化</a>，我理解了测试大量数字或随机场景，找出产生意想不到结果的值。</p><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="lk ll l"/></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">A reasonable approach to fuzzing.</figcaption></figure><p id="9008" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">例如，在Yield中，我们计算分数指数，这是一种迭代计算，在以太坊上运行可能非常昂贵，因为每个操作都要花钱。</p><p id="1c50" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">为了给我们的用户省钱，我们破解了<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/pool/YieldMath.sol#L274" rel="noopener ugc nofollow" target="_blank">指数计算算法，过了一会儿</a>就不再计算小数了。不利的一面是，我们的智能合约现在的交易价格会偏离数学理想的随机数量。</p><p id="e8a3" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">但是偏离有多远呢？我们能设置它使价格保持在理想价格的一美元以内吗？</p><p id="1bb4" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">唯一知道的方法是用大量随机场景测试智能合约。<a class="ae ku" href="https://www.trailofbits.com/" rel="noopener ugc nofollow" target="_blank">跟踪位</a>告诉我们在代码审计期间使用fuzzer，这就是我们如何到达这里的。</p><p id="cad9" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">如何模糊化</strong></p><p id="dac1" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">首先你必须<a class="ae ku" href="https://github.com/crytic/echidna" rel="noopener ugc nofollow" target="_blank">安装针鼹鼠</a>。在网站的选项中，我设法下载了Ubuntu的预编译二进制文件。为此，你需要安装<a class="ae ku" href="https://github.com/crytic/crytic-compile" rel="noopener ugc nofollow" target="_blank">加密编译</a>和<a class="ae ku" href="https://github.com/crytic/slither" rel="noopener ugc nofollow" target="_blank">滑动</a>。我记得我花了几次尝试才把它做好，这在今天是一个罕见的事件，所有东西都在npm包中。</p><blockquote class="kv"><p id="d376" class="kw kx ht bd ky kz la lb lc ld le kt ek translated">Fuzzing不容易，工具粗糙，数学很难，但是值得。</p></blockquote><p id="0b63" class="pw-post-body-paragraph jy jz ht ka b kb lf iu kd ke lg ix kg kh lh kj kk kl li kn ko kp lj kr ks kt hm dt translated">如果需要帮助，就加入<a class="ae ku" href="https://empireslacking.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">帝国黑客Slack </a>频道。</p><p id="2343" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">针鼹github有很多文档和几个教程，我完全无法理解。拯救我的是古斯塔沃·格列科的一个运行中的例子，从那以后我一直在调整和重用它。也许有一天我会了解到更多的细节。</p><p id="688c" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">简而言之，你需要一个<code class="eh lm ln lo lp b">config.yaml</code>文件，这是我的:</p><pre class="jj jk jl jm fq lq lp lr ls aw lt dt"><span id="1265" class="lu lv ht lp b fv lw lx l ly lz">seqLen: 50<br/>testLimit: 20000<br/>prefix: “crytic_”<br/>deployer: “0x41414141”<br/>sender: [“0x42424242”, “0x43434343”]<br/>cryticArgs: [“ — compile-force-framework”, “Buidler”]<br/>coverage: true<br/>checkAsserts: true</span></pre><p id="caea" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">你对这些东西做什么的猜测和我一样好。RTFM。我没有。</p><p id="be79" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">然后你用你想要测试的不变量编写一个可靠性契约，这个测试来自<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/master/contracts/helpers/DecimalMath.sol" rel="noopener ugc nofollow" target="_blank"> DecimalMath.sol </a>的<code class="eh lm ln lo lp b">muld</code>函数。</p><pre class="jj jk jl jm fq lq lp lr ls aw lt dt"><span id="02cb" class="lu lv ht lp b fv lw lx l ly lz">// SPDX-License-Identifier: GPL-3.0-or-later<br/>pragma solidity ^0.6.10;</span><span id="8e3e" class="lu lv ht lp b fv ma lx l ly lz">import "../helpers/DecimalMath.sol";</span><span id="9042" class="lu lv ht lp b fv ma lx l ly lz"><br/>/// <a class="ae ku" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@dev</a> Implements simple fixed point math mul and div operations for 27 decimals.<br/>contract DecimalMathInvariant is DecimalMath {</span><span id="049a" class="lu lv ht lp b fv ma lx l ly lz">function muld_(uint256 x, uint256 y)<br/>    public pure returns (uint256)<br/>  {<br/>    uint z = muld(x, y);<br/>  <br/>    assert((x * y) / UNIT == z); // Assert math<br/>    assert (divd(z, y) &lt;= x); // We are rounding down<br/>    // Assert revert on overflow<br/>    if(y &gt; UNIT) assert(z &gt;= x); // x could be zero<br/>    if(y &lt; UNIT) assert(z &lt;= x); // y could be zero<br/>  }<br/>}</span></pre><p id="1292" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">我们将使用echidna调用本契约中的<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/DecimalMathInvariant.sol#L11" rel="noopener ugc nofollow" target="_blank">decimalmathinvantar . muld _</a>函数20，000次。鼹鼠知道它必须运行这个功能，因为它是<code class="eh lm ln lo lp b">public</code>。该函数有两个参数(x和y ),所以针鼹每次运行时都会使用随机值。</p><p id="6089" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">当针鼹运行时，它认为因<code class="eh lm ln lo lp b">require</code>而恢复是成功的，但因<code class="eh lm ln lo lp b">assert</code>而恢复是失败的。</p><p id="2290" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在上面的契约中，我检查了定点乘法的四个属性:</p><ol class=""><li id="9abf" class="mb mc ht ka b kb kc ke kf kh md kl me kp mf kt mg mh mi mj dt translated">x * y == z，替换逗号。</li><li id="7baa" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt mg mh mi mj dt translated">DecimalMath.muld 向下舍入(通过断言z / y &lt; = x，替换逗号)。</li><li id="0883" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt mg mh mi mj dt translated">如果y大于1，z大于x(如果有溢出，这就不成立)。</li><li id="749f" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt mg mh mi mj dt translated">如果y小于1，z也小于x(如果有下溢，这就不成立)。</li></ol><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="mp ll l"/></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">You might want to write that invariant down</figcaption></figure><p id="213a" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">编码不变量迫使你思考如何通过寻找总是保持为真的属性来测试一些东西，而不是重复原始智能契约中的代码。寻找不变量通常是困难的，你应该从商业专家那里得到帮助。</p><p id="f8c9" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">检查<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/master/contracts/invariants/DecimalMathInvariant.sol" rel="noopener ugc nofollow" target="_blank">完整的契约</a>以查看我正在测试的所有不变量。鼹鼠将负责合同中的所有公共职能。</p><p id="1be1" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">现在，您可以开始测试了:</p><pre class="jj jk jl jm fq lq lp lr ls aw lt dt"><span id="cb54" class="lu lv ht lp b fv lw lx l ly lz">$ echidna-test . — contract DecimalMathInvariant — config contracts/invariants/config.yaml</span></pre><p id="5f0f" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">这两个参数是契约的<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/DecimalMathInvariant.sol#L7" rel="noopener ugc nofollow" target="_blank">名称，在这里我们对不变量进行了编码(不是我们正在测试的目标契约，也不是路径)。第二个参数是到。之前的yaml文件</a>。</p><p id="1599" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">鼹鼠将花一些时间分析合同并做好准备，最终你会看到:</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mq"><img src="../Images/a883ca97d3885ea23d3017b4ac6a1838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aV-HMj0hVTQyYABO"/></div></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">Glorious</figcaption></figure><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mr"><img src="../Images/47fd77360f967d2018aec1b67d3efefd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uSh3w3laG7Yk2Wy3"/></div></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">Even better</figcaption></figure><p id="9a4f" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">你可能会注意到里面有些奇怪的东西。我们弄模糊的这个<code class="eh lm ln lo lp b">UNIT</code>是什么？</p><p id="675c" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">打开和关闭不变量</strong></p><p id="02ea" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">现在，在<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/master/contracts/invariants/config.yaml" rel="noopener ugc nofollow" target="_blank"> yaml </a>文件中肯定有这样做的方法，但是我使用函数的可见性来打开和关闭不变量。</p><p id="b8ca" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">鼹鼠将对你合同中的每一个功能进行模糊处理。这可能不是你想要的。有时，您可能只想测试一个引起麻烦的函数，而不是契约中的10倍，其中9倍通过了测试。或者有时您可能有一些不想模糊的助手函数。</p><p id="7ba2" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在这种情况下，你可以声明函数<code class="eh lm ln lo lp b">internal</code>，针鼹会忽略它。声明你所有的状态变量<code class="eh lm ln lo lp b">internal</code>，否则它们会变得毫无意义的模糊。</p><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="ms ll l"/></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">Too much fuzzing</figcaption></figure><p id="13fc" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/WhitepaperInvariant.sol#L124" rel="noopener ugc nofollow" target="_blank">这个文件</a>中，我有一个助手函数来帮助我计算Yield白皮书中的不变量。我将在其他任何地方使用该函数，我不想单独测试它，因为我没有办法在脱离上下文的情况下确认它是否有效。</p><p id="cfc1" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/WhitepaperInvariant.sol#L110" rel="noopener ugc nofollow" target="_blank">同一个文件</a>中，我甚至有一个不变测试函数，它被注释掉了。这是开发过程中留下的，应该被清理掉，多尴尬。</p><p id="ffdf" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在顶部<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/WhitepaperInvariant.sol#L10" rel="noopener ugc nofollow" target="_blank">你会看到有一堆常量，都是内部的。如果它们是公共的，针鼹会考虑它们的功能并模糊它们，就像发生在<code class="eh lm ln lo lp b">UNIT</code>的情况一样，它继承自父契约，碰巧是<code class="eh lm ln lo lp b">public</code>，所以它被模糊了。</a></p><p id="f9c1" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">这些是我写的第一个模糊契约，这很幸运，因为作为库或无状态契约，它们很容易模糊。在我开始研究fuzzing <a class="ae ku" href="https://github.com/usmfum/USM/tree/master/contracts/fuzzing" rel="noopener ugc nofollow" target="_blank">有状态契约</a>后不久，那告诉我我做的每件事都是错的。</p><p id="06d3" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">模糊有状态契约</strong></p><p id="e428" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">我很快就需要模糊保持状态的契约，而不仅仅是数学库。经过思考和探索，我意识到针鼹进行的测试并不是孤立进行的。</p><p id="ea8d" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">鼹鼠随机运行合同中的函数，直到出现故障。我认为<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/259aab24751159bf1ff00646fd8c470e84e81561/contracts/invariants/config.yaml#L1" rel="noopener ugc nofollow" target="_blank"> seqLen </a>参数在<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/master/contracts/invariants/config.yaml" rel="noopener ugc nofollow" target="_blank">中。yaml </a>文件必须定义一个序列中有多少个函数调用。</p><p id="8574" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">在一个序列中，状态被维护。与其让不变契约继承要测试的契约，不如将它们链接在一起，就像本例中的<a class="ae ku" href="https://github.com/WETH10/WETH10/blob/main/contracts/fuzzing/WETH10Fuzzing.sol" rel="noopener ugc nofollow" target="_blank"> WETH10 </a>一样。</p><pre class="jj jk jl jm fq lq lp lr ls aw lt dt"><span id="d5a5" class="lu lv ht lp b fv lw lx l ly lz">contract WETH10Fuzzing {<br/>  WETH10 internal weth;<br/>  address internal holder;</span><span id="0a76" class="lu lv ht lp b fv ma lx l ly lz">  /// <a class="ae ku" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@dev</a> Instantiate the WETH10 contract, and a holder address<br/>  /// that will return weth when asked to.<br/>  constructor () {<br/>    weth = new WETH10();<br/>    holder = address(new MockHolder(address(weth), address(this)));<br/>  }</span></pre><p id="df4b" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">以前我是孤立地测试每个功能，但现在我保留了状态。鼹鼠将在WETH10中执行函数，寻找失败的断言。我的不变量测试函数现在看起来像这样:</p><pre class="jj jk jl jm fq lq lp lr ls aw lt dt"><span id="e198" class="lu lv ht lp b fv lw lx l ly lz">/// <a class="ae ku" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@dev</a> Test that supply and balance hold on deposit.<br/>function deposit(uint ethAmount) public {<br/>  uint supply = weth.totalSupply();<br/>  uint balance = weth.balanceOf(address(this));<br/>  weth.deposit{value: ethAmount}();<br/>  <br/>  assert(weth.totalSupply() == add(supply, ethAmount));<br/>  assert(weth.balanceOf(address(this)) == add(balance, ethAmount));<br/>  assert(address(weth).balance == weth.totalSupply());<br/>}</span><span id="8043" class="lu lv ht lp b fv ma lx l ly lz">/// <a class="ae ku" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@dev</a> Test that supply and balance hold on withdraw.<br/>function withdraw(uint ethAmount) public {<br/>  uint supply = weth.totalSupply();<br/>  uint balance = weth.balanceOf(address(this));<br/>  weth.withdraw(ethAmount);<br/>  <br/>  assert(weth.totalSupply() == sub(supply, ethAmount));<br/>  assert(weth.balanceOf(address(this)) == sub(balance, ethAmount));<br/>  assert(address(weth).balance == weth.totalSupply());<br/>}</span></pre><p id="2d73" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">有了这个，我正在测试无论我们之前处于什么状态，供应和平衡都会随着<code class="eh lm ln lo lp b">deposit</code>和<code class="eh lm ln lo lp b">withdraw</code>的变化而变化。您可以使用它来构建更复杂的多合同设置。</p><p id="6c52" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">调试模糊器</strong></p><p id="2f6b" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">当所有的测试都通过了，那真是太好了。除非第一次发生这种情况，因为那样你就会怀疑并认为你写错了测试代码。所以首先你需要让你的测试失败。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div class="fe ff mt"><img src="../Images/79bf5dfcb297c98e51610c452f07816d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/0*sC4ME3zgRj0-6uoO"/></div><figcaption class="ju jv fg fe ff jw jx bd b be z ek">We broke it! Yay!</figcaption></figure><p id="7532" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">当测试失败时，鼹鼠会找到使断言失败的函数调用组合。然后，它会找出导致失败的最短序列，通常是一两次调用。鼹鼠会告诉你它执行的函数调用，就是这样。</p><p id="d80b" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">您不会得到日志、关于哪个特定断言失败的信息或者状态变量的内容。知道某件事失败的原因并不容易。</p><p id="9e7d" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">您将需要在truffle控制台中运行该序列，或者在常规测试文件中运行<a class="ae ku" href="https://github.com/yieldprotocol/fyDai/blob/master/test/invariants/602_whitepaper_invariant.ts" rel="noopener ugc nofollow" target="_blank">,这有时更方便，这样您就可以在特定情况下使用智能合约，并开始调查断言失败的原因。</a></p><p id="f23b" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">如果针鼹告诉我，我的“买入戴，反向交易”不变量因某些参数而失败，我会将它们粘贴到测试文件中，作为fuzzing契约的伴侣。然后，我可以获得所有相关变量的转储，并在传统设置中开始调试。</p><p id="ed89" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated"><strong class="ka hu">结论</strong></p><p id="c2a6" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">Fuzzing不容易，工具粗糙，数学很难，但是值得。</p><p id="6cf4" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">Fuzzing让我对我的智能合同有了前所未有的信心。现在，仅仅依靠单元测试和在测试网络中摸索似乎是鲁莽的。</p><p id="03b2" class="pw-post-body-paragraph jy jz ht ka b kb kc iu kd ke kf ix kg kh ki kj kk kl km kn ko kp kq kr ks kt hm dt translated">大概就是这样。我就知道这么多。这不是很多，但对我来说，到目前为止效果很好。非常感谢你走到这一步，祝你好运！</p><h2 id="cf99" class="lu lv ht bd mu mv mw mx my mz na nb nc kh nd ne nf kl ng nh ni kp nj nk nl nm dt translated">另外，阅读</h2><ul class=""><li id="02dc" class="mb mc ht ka b kb nn ke no kh np kl nq kp nr kt ns mh mi mj dt translated">最好的<a class="ae ku" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="b851" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">加密复制交易平台</a></li><li id="ae2d" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">最好的<a class="ae ku" rel="noopener" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b">加密税务软件</a></li><li id="92e4" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/the-best-crypto-trading-platforms-in-2020-the-definitive-guide-updated-c72f8b874555">最佳加密交易平台</a></li><li id="d8fc" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">最佳<a class="ae ku" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">加密贷款平台</a></li><li id="4f10" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" href="https://bitquery.io/blog/best-blockchain-analysis-tools-and-software" rel="noopener ugc nofollow" target="_blank">最佳区块链分析工具</a></li><li id="d432" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/crypto-arbitrage-guide-how-to-make-money-as-a-beginner-62bfe5c868f6">加密套利</a>指南:新手如何赚钱</li><li id="aa54" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">最佳<a class="ae ku" rel="noopener" href="/coinmonks/what-are-the-best-charting-platforms-for-cryptocurrency-trading-85aade584d80">加密制图工具</a></li><li id="15e1" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ledger-vs-trezor-best-hardware-wallet-to-secure-cryptocurrency-22c7a3fd391e">莱杰vs特雷佐</a></li><li id="56fd" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">了解比特币的<a class="ae ku" rel="noopener" href="/coinmonks/what-are-the-best-books-to-learn-bitcoin-409aeb9aff4b">最佳书籍有哪些？</a></li><li id="170f" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a></li><li id="d145" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/aax-exchange-review-2021-67c5ea09330c"> AAX交易所评论</a> |推荐代码、交易费用、利弊</li><li id="54f9" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/deribit-review-options-fees-apis-and-testnet-2ca16c4bbdb2"> Deribit审查</a> |选项、费用、API和Testnet</li><li id="e34b" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ftx-crypto-exchange-review-53664ac1198f"> FTX密码交易所评论</a></li><li id="d0c3" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ngrave-zero-review-c465cf8307fc">n零审核</a></li><li id="1310" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit交换审查</a></li><li id="8b1e" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/cryptohopper-vs-3commas-vs-shrimpy-a2c16095b8fe"> 3Commas vs Cryptohopper </a></li><li id="b18b" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">最好的比特币<a class="ae ku" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069?source=friends_link&amp;sk=324dd9ff8556ab578d71e7ad7658ad7c">硬件钱包</a></li><li id="e7b1" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">最佳<a class="ae ku" href="https://blog.coincodecap.com/best-monero-wallets" rel="noopener ugc nofollow" target="_blank"> monero钱包</a></li><li id="747f" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" href="https://blog.coincodecap.com/ledger-nano-s-vs-x" rel="noopener ugc nofollow" target="_blank">莱杰纳米s vs x </a></li><li id="ace6" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" href="https://blog.coincodecap.com/bitsgap-3commas-quadency" rel="noopener ugc nofollow" target="_blank">bits gap vs 3 commas vs quad ency</a></li><li id="a274" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" href="https://blog.coincodecap.com/ledger-nano-s-vs-trezor-one-ledger-nano-x-trezor-t" rel="noopener ugc nofollow" target="_blank">莱杰纳米S vs特雷佐one vs特雷佐T vs莱杰纳米X </a></li><li id="44f0" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630">block fi vs Celsius</a>vs Hodlnaut</li><li id="52d0" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">Bitsgap评论——一个轻松赚钱的加密交易机器人</li><li id="92c0" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated">为专业人士设计的加密交易机器人</li><li id="22eb" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/primexbt-review-88e0815be858"> PrimeXBT审查</a> |杠杆交易、费用和交易</li><li id="62d2" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/ellipal-titan-review-85e9071dd029">埃利帕尔泰坦评论</a></li><li id="1a26" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" href="https://blog.coincodecap.com/secux-stone-hardware-wallet-review" rel="noopener ugc nofollow" target="_blank">赛克斯·斯通评论</a></li><li id="31ff" class="mb mc ht ka b kb mk ke ml kh mm kl mn kp mo kt ns mh mi mj dt translated"><a class="ae ku" rel="noopener" href="/coinmonks/blockfi-review-53096053c097">区块链评论</a> |从您的密码中赚取高达8.6%的利息</li></ul></div></div>    
</body>
</html>