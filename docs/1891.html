<html>
<head>
<title>Cool Crypto — Sending Value With A Link</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">酷炫加密——通过链接发送值</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/cool-crypto-sending-value-with-a-link-b6cf7277c15d?source=collection_archive---------4-----------------------#2018-12-17">https://medium.com/coinmonks/cool-crypto-sending-value-with-a-link-b6cf7277c15d?source=collection_archive---------4-----------------------#2018-12-17</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><figure class="hs ht fm fo hu hv fe ff paragraph-image"><div role="button" tabindex="0" class="hw hx di hy bf hz"><div class="fe ff hr"><img src="../Images/ad1f120e49e2513fae15ed2098a215a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x2gUD6BhNjkF7ac4UEwg5Q.jpeg"/></div></div><figcaption class="ic id fg fe ff ie if bd b be z ek">Photo by <a class="ae ig" href="https://unsplash.com/photos/5mZ_M06Fc9g?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Roman Mager</a> on <a class="ae ig" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="da83" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">最近我一直在帮忙开发由<a class="ke kf gr" href="https://medium.com/u/610daeab315b?source=post_page-----b6cf7277c15d--------------------------------" rel="noopener" target="_blank"> Austin Thomas Griffith </a>创建的开源一次性钱包应用。背后的<a class="ae ig" rel="noopener" href="/gitcoin/ethereum-in-emerging-economies-b235f8dac2f2">想法</a>是尝试创建一个可以使用移动网络浏览器交换价值的应用程序。它权衡了存储私钥、下载应用程序等的复杂性和最佳实践，只是为了制作一些应该易于上手和易于使用的东西。</p><p id="08d2" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我发现最有趣的功能之一是发送一些值的能力，在这个例子中是<a class="ae ig" rel="noopener" href="/poa-network/poa-network-partners-with-makerdao-on-xdai-chain-the-first-ever-usd-stable-blockchain-65a078c41e6a"> xDai </a>，给使用链接的人(在这里试用应用<a class="ae ig" href="https://xdai.io/" rel="noopener ugc nofollow" target="_blank"/>)。这种方法背后的功能非常酷，并且利用了大量的web3/crypto基础知识。我觉得深究起来很有意思，觉得值得分享。</p><h2 id="3f29" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">开始</h2><p id="18a3" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">首先，Dapp并没有真正“发送”xDai，它更像是一种存款/索赔模式，使用一些很酷的加密技术来确保只有拥有正确信息的人(由发送者通过链接提供)才能索赔。</p><p id="a205" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">其次有两个部分web Dapp和区块链上的智能合约。web Dapp实际上只是与智能合约交互的一种很好的方式。</p><h2 id="8e85" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">逐步地</h2><p id="e960" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">一步一步的描述帮助我理解了它。请注意，我没有在这里显示代码的所有细节，它更多的是一个高层次的描述，以显示概念。</p><h2 id="76f5" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">发送</h2><p id="0254" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">使用Dapp,“发送者”输入他们想要发送的金额，然后点击发送。</p><figure class="lh li lj lk fq hv fe ff paragraph-image"><div class="fe ff lg"><img src="../Images/2b1211d729f382310ee4899c462b88db.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*pQlkMl5N1Arid_dLUEAW7g.png"/></div><figcaption class="ic id fg fe ff ie if bd b be z ek">App Send Screen</figcaption></figure><p id="dd7d" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">点击send后，Dapp会在后台做一些工作，以获取智能合约设置所需的输入。</p><p id="8c8c" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Dapp使用<a class="ae ig" href="https://web3js.readthedocs.io/en/1.0/web3-utils.html#sha3" rel="noopener ugc nofollow" target="_blank"> web3.js </a>散列一些随机数据:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="9f3e" class="kg kh ij lm b fv lq lr l ls lt">let randomHash = web3.utils.sha3("" + Math.random());</span></pre><p id="ad1f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在，Dapp使用web3.js生成一个随机帐户，该帐户将有一个私钥和一个公钥:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="b58e" class="kg kh ij lm b fv lq lr l ls lt">let randomWallet = web3.eth.accounts.create();</span></pre><p id="141f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，使用随机钱包私钥对随机散列数据进行<a class="ae ig" href="https://web3js.readthedocs.io/en/1.0/web3-eth-accounts.html#sign" rel="noopener ugc nofollow" target="_blank">签名</a>(有关签名等的更多细节，请参见下文):</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="6fc8" class="kg kh ij lm b fv lq lr l ls lt">let sig = web3.eth.accounts.sign(randomHash, randomWallet.privateKey);</span></pre><p id="5e70" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Dapp向区块链智能合约发送一个交易，其值等于与签名和散列数据一起发送的金额:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="0008" class="kg kh ij lm b fv lq lr l ls lt">Contract.send(randomHash, sig.signature), 140000, false, value ...<br/>// This is just a pseudo code to give the gist, see the <a class="ae ig" href="https://github.com/austintgriffith/burner-wallet" rel="noopener ugc nofollow" target="_blank">repo</a> for the full code</span></pre><p id="db43" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">智能合约包含资金结构到字节32 ID键的映射:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="f0e0" class="kg kh ij lm b fv lq lr l ls lt">struct Fund {<br/>    address sender;<br/>    address signer;<br/>    uint256 value;<br/>    uint256 nonce;<br/>    bool claimed;<br/>}<br/><br/>mapping (bytes32 =&gt; Fund) public funds;</span></pre><p id="2599" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">当Dapp“发送”该值时，智能合约创建新的资金结构，签名者字段被设置为由Dapp创建的随机钱包的公钥。该字段很重要，因为它在提出索赔时用作检查:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="343c" class="kg kh ij lm b fv lq lr l ls lt">newFund = Fund({<br/>    sender: msg.sender,<br/>    <strong class="lm ik">signer: randomWallet.publicKey,</strong><br/>    value: msg.value,<br/>    nonce: nonce,<br/>    claimed: false<br/>})</span></pre><p id="9bdc" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在使用randomHash值作为键来映射newFund:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="23ff" class="kg kh ij lm b fv lq lr l ls lt">funds[<strong class="lm ik">randomHash</strong>] = newFund;</span></pre><p id="9ea6" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">来自发送者的xDai现在已经被发送到智能合约，并准备好由具有所需信息的任何人来认领。</p><p id="6abd" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">最后，Dapp使用randomHash和随机钱包私钥作为链接参数来生成链接:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="906a" class="kg kh ij lm b fv lq lr l ls lt">Link Format: xDai.io/randomHash;privateKey</span></pre><p id="5576" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后可以复制链接，并通过WhatsApp、短信等发送。</p><p id="62eb" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji ik">索赔:</strong></p><p id="4697" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这里可能值得注意的是，这个链接实际上只是一个分享申请xDai所需的重要信息的好方法。Dapp还做了与区块链智能合约交互的艰苦工作。</p><p id="d6da" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">当链接被访问时，Dapp从链接中解析randomHash和privateKey。</p><p id="7987" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，它使用链接中的私钥对消息进行签名:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="04f8" class="kg kh ij lm b fv lq lr l ls lt">let accountHash = web3.utils.sha3(claimAccount);<br/>let sig = web3.eth.accounts.sign(accountHash, privateKey);</span></pre><p id="a9b1" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在，使用签名和原始数据调用智能合同索赔函数:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="990b" class="kg kh ij lm b fv lq lr l ls lt">Contact.claim(accountHash, sig, randomHash, claimAccount)</span></pre><p id="9b88" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Solidity ecrecover函数用于从签名中获取公共地址(这就是神奇之处，参见下面的信息):</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="95a9" class="kg kh ij lm b fv lq lr l ls lt">address signer = recoverSigner(accountHash, sig);</span></pre><p id="bf29" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">最后，智能合约使用与randomHash匹配的密钥检查资金，random hash的“签名者”等于从签名中恢复的地址。如果是，那么它可以将值发送到索赔者的帐户:</p><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="2cff" class="kg kh ij lm b fv lq lr l ls lt">if(funds[randomHash].signer == signer &amp;&amp; funds[randomHash].claimed == false){    <br/>    funds[randomHash].claimed = true;<br/>    claimAccount.send(funds[randomHash].value);<br/>}</span></pre><p id="9c00" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">唷，就是它！这看起来像是发生了很多事情，但基本的是，这是用户在智能合同中存储价值的一种智能方式，该智能合同只能使用正确的信息来声明，而不显示公共区块链上的信息是什么。</p><h1 id="0d42" class="lu kh ij bd ki lv lw lx km ly lz ma kq mb mc md kt me mf mg kw mh mi mj kz mk dt translated">酷炫的加密技术</h1><p id="2d96" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">签名，ecrecover，呃什么？？有些事情可能值得更详细地探讨一下。</p><h2 id="2547" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">钱包、账户等</h2><p id="5179" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">用<code class="eh ml mm mn lm b">web3.eth.accounts.create()</code>生成的帐户有自己的私钥和公钥。更多信息可在<a class="ae ig" href="http://ethdocs.org/en/latest/account-management.html?highlight=address#keyfiles" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae ig" href="https://ethereum.stackexchange.com/questions/33171/ethereum-address-vs-public-key" rel="noopener ugc nofollow" target="_blank">中找到，点击这里</a>。私钥和公钥通过具有签名和验证属性的算法链接在一起。</p><h2 id="97a4" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">签名和验证</h2><p id="80b7" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">以下是对<a class="ae ig" rel="noopener" href="/@angellopozo/ethereum-signing-and-validating-13a2d7cb0ee3">这篇有帮助的帖子</a>的一个非常简短的总结。</p><p id="aa63" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">签名是用户“签署”任何人都可以验证来自该用户的数据的行为。</p><p id="80af" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">签名函数将接收私钥和数据。输出将是作为签名的另一个字符串。</p><p id="4ce9" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了验证签名来自私钥的所有者，需要签名、原始数据和公钥。</p><p id="d1e5" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">运行从签名数据中恢复公钥的验证器功能。</p><p id="c020" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后将恢复的公钥与原始公钥进行比较，如果两者相同，则签名有效。</p><h2 id="11b6" class="kg kh ij bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la dt translated">ecrecover</h2><p id="1bdd" class="pw-post-body-paragraph jg jh ij ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd hm dt translated">在这种情况下，Solidity<a class="ae ig" href="https://solidity.readthedocs.io/en/latest/units-and-global-variables.html#mathematical-and-cryptographic-functions" rel="noopener ugc nofollow" target="_blank">e Recover</a>(椭圆曲线恢复)函数用于恢复与公钥相关的地址。智能合约代码中的<a class="ae ig" href="https://github.com/austintgriffith/burner-wallet/blob/master/contracts/Links/Links.sol" rel="noopener ugc nofollow" target="_blank"> recoverSigner </a>函数展示了一个如何做到这一点的示例，而<a class="ae ig" href="https://blog.ricmoo.com/verifying-messages-in-solidity-50a94f82b2ca" rel="noopener ugc nofollow" target="_blank">这个</a>函数则很好地解释了正在发生的事情。</p><p id="8ad0" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我认为这是一个非常棒的加密应用的例子！</p><blockquote class="mo"><p id="6a87" class="mp mq ij bd mr ms mt mu mv mw mx kd ek translated"><a class="ae ig" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mz na nb nc nd hv fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff my"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><figure class="lh li lj lk fq hv fe ff paragraph-image"><a href="http://bit.ly/2G71Sp7"><div class="fe ff ne"><img src="../Images/449450761cd76f44f9ae574333f9e9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKX2mtg7p1lOs7JmosPLsA.png"/></div></a><figcaption class="ic id fg fe ff ie if bd b be z ek"><a class="ae ig" href="http://bit.ly/2G71Sp7" rel="noopener ugc nofollow" target="_blank"><strong class="bd nf">Click to read today’s top story</strong></a></figcaption></figure></div></div>    
</body>
</html>