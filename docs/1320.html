<html>
<head>
<title>Visualizing property prices in Hong Kong with Pandas, Overpy and Folium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用熊猫、Overpy和叶子形象化香港的房地产价格</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/visualizing-property-prices-in-hong-kong-with-pandas-overpy-and-folium-595240ffca90?source=collection_archive---------1-----------------------#2018-08-15">https://medium.com/coinmonks/visualizing-property-prices-in-hong-kong-with-pandas-overpy-and-folium-595240ffca90?source=collection_archive---------1-----------------------#2018-08-15</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class="fi fk iq ir is ab cb"><figure class="it iu iv iw ix iy iz paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><img src="../Images/574bca797c20b16841ce474dc9904f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*JoXNSjGeARIx4gcm5XoMPQ.png"/></div></figure><figure class="it iu jg iw ix iy iz paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><img src="../Images/e5176f5e5be76314907523c7c9e21ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*jq_95Kqj8Rahz13jb6XS1w.png"/></div><figcaption class="jh ji fg fe ff jj jk bd b be z ek jl di jm jn">Visualization of Hong Kong housing data using Folium, a Python wrapper for Leaflet.js maps</figcaption></figure></div><p id="68d2" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">香港以其高得离谱的房地产市场而闻名。2018年1月，这座城市被评为世界上最不可负担的城市。房价中值是收入中值的15倍以上。2017年，尼科尔森山项目中的两个单元被认为是亚洲最昂贵的公寓，售价总计1.49亿美元。另一方面，更便宜但宜居的公寓平均每月租金为10，000 HKD (1，300美元)。考虑到香港房价的巨大差异，我们如何使用Python可视化这些数据呢？</p><figure class="kn ko kp kq fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><div class="fe ff km"><img src="../Images/065d9b5f7ded398d04d5a467187ca1ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1pA14Gho_hUKvQbHdbthdA.jpeg"/></div></div></figure><p id="144f" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">香港几乎没有公开的数据来源。最简单的方法来获得房地产价格估计是从房地产代理网站。米德兰房地产价格图表等价格图表提供了住房数据，如每平方英尺的毛价格和可销售平均价格。使用pdf到csv转换器，我们可以提取一个简单的数据集，其中包含房地产及其每平方的价格。制成当然，需要数据清理来删除或估算损坏或丢失的数据。为了您的方便，从美联物业价格图表中提取的样本数据集包含在<a class="ae kr" href="https://github.com/enochk22/hk_prop_price_visualization/tree/master/code/data" rel="noopener ugc nofollow" target="_blank">数据</a>文件夹中。你可以在我的<a class="ae kr" href="https://github.com/enochk22/hk_prop_price_visualization/tree/master/" rel="noopener ugc nofollow" target="_blank"> Github repo </a>找到完整的代码。</p><p id="1b45" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">首先，我们需要预处理数据并获得所列属性的坐标(经度和纬度)。一个很好的GPS坐标来源是OpenStreetMap.org的。通过将香港指定为区号并提供每个位置的节点名，可以对天桥API进行简单的查询。你可以在这里了解更多关于Overpass API和Overpass SQL<a class="ae kr" href="https://wiki.openstreetmap.org/wiki/Overpass_API" rel="noopener ugc nofollow" target="_blank">的内容。我还推荐阅读</a><a class="ks kt gr" href="https://medium.com/u/eb95fc687c6a?source=post_page-----595240ffca90--------------------------------" rel="noopener" target="_blank"> Nikolai Janakiev </a>关于<a class="ae kr" href="https://towardsdatascience.com/loading-data-from-openstreetmap-with-python-and-the-overpass-api-513882a27fd0" rel="noopener" target="_blank">用Python和transition API从OpenStreetMap加载数据的文章</a>。</p></div><div class="ab cl ku kv hb kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hm hn ho hp hq"><p id="2ba9" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">您可能会很快注意到，在数据集中的99个属性中，并不是所有的属性都可以作为OpenStreetMap上的节点使用。有些物业，如马鞍山新建成的Sausalito，可作为路(节点的集合)。</p><figure class="kn ko kp kq fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><div class="fe ff lb"><img src="../Images/69ea6f1a0a542e8dadea0d379ee496f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOWC0KLP1pqnrEBrHBYBkA.png"/></div></div><figcaption class="jh ji fg fe ff jj jk bd b be z ek">Some locations are not available on OpenStreetMap</figcaption></figure><p id="3e29" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">因此，查询功能被设计为处理三种情况:属性被标记为节点、方式或不存在。如果该属性不存在，我们只需将其坐标标记为[999，999]以将其从地图中删除。</p><pre class="kn ko kp kq fq lc ld le lf aw lg dt"><span id="1bb8" class="lh li ht ld b fv lj lk l ll lm">def overpyq(loc):<br/> quer = '''<br/>  area["ISO3166-1"="HK"][admin_level=2];<br/>  (node["name:en"="'''+str(loc)+'''"](area);<br/>  );<br/>  out center;<br/>  '''<br/> res = api.query(quer)<br/> if not res.nodes:<br/>  quer2 = '''<br/>   area["ISO3166-1"="HK"][admin_level=2];<br/>   (way["name:en"="'''+str(loc)+'''"](area);<br/>   );<br/>   out center;<br/>   '''<br/>  res = api.query(quer2).ways[0].get_nodes(resolve_missing=True)[0] if api.query(quer2).ways != [] else 999<br/>  return res<br/> res = api.query(quer).nodes[0]<br/> return res</span></pre><p id="3a81" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">值得一提的是，原始数据集包含美元符号和逗号。使用Python中的正则表达式和字符串操作，可以剪切和替换这些特殊字符。然后将预处理的数据放入一个字典中，使用我们之前定义的函数进行查询。</p><pre class="kn ko kp kq fq lc ld le lf aw lg dt"><span id="0218" class="lh li ht ld b fv lj lk l ll lm"># preprocessing<br/>places = []<br/>prices = []<br/>places += [place for place in data.estate]<br/>prices += list(chain.from_iterable(map(int, re.findall(r'\d+',price.replace(',', ''))) for price in data.avg_price_saleable))<br/>querydict = dict(zip(places,prices))</span><span id="0bfc" class="lh li ht ld b fv ln lk l ll lm"># collect coords into list<br/>api = overpy.Overpass()<br/>coords  = []<br/>lons = []<br/>lats = []<br/>for key in querydict:<br/> r = overpyq(str(key))<br/> coords += [(float(r.lon), float(r.lat))] if r != 999 else [(float(999), float(999))]<br/>lons += [lon[1] for lon in coords]<br/>lats += [lat[0] for lat in coords]</span></pre><p id="38d8" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">使用<strong class="jq hu">熊猫</strong>，我们可以将房产名称、价格和坐标组合到一个巨大的数据框架中进行映射。请注意，坐标标记为[999，999]的属性不会显示在最终地图上，因为它们没有在OpenStreetMap上标记。</p><figure class="kn ko kp kq fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><div class="fe ff lo"><img src="../Images/e8250a0ed4ccc522726dc27e4b18014f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQsaE8emBPHHub7vJTlCtg.png"/></div></div></figure><p id="7223" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">最后一步是创建一个<strong class="jq hu">叶子</strong>图。Folium是用于<strong class="jq hu">leafle . js</strong>的python包装器，这是一个用于移动友好的交互式地图的开源<strong class="jq hu"> JavaScript </strong>库。通过添加<code class="eh lp lq lr ld b">LayerControl()</code>,我们可以给我们的叶子地图添加不同的图块。Folium有许多默认的平铺层可供选择，您也可以导入自定义的平铺层。在地图上添加圆形标记，其半径对应于资产价格。不同深浅的红色也对应着价格是否高于每平方10，000和15，000 HKD。制成地图保存为<code class="eh lp lq lr ld b">hkmap.html</code>，可以在浏览器中查看。</p><pre class="kn ko kp kq fq lc ld le lf aw lg dt"><span id="561c" class="lh li ht ld b fv lj lk l ll lm">m = folium.Map(location=[22.34, 114.1], tiles='cartodbpositron', zoom_start=10.5)<br/>folium.TileLayer('cartodbdark_matter').add_to(m)<br/>folium.TileLayer('stamenterrain').add_to(m)<br/>folium.TileLayer('stamentoner').add_to(m)<br/>folium.LayerControl().add_to(m)<br/>for i in range(0,len(querydf)):<br/> col = '#FF0033' if querydf.iloc[i]['saleable_price'] &gt; 15000 else ('#FF6633' if querydf.iloc[i]['saleable_price'] &gt; 10000 else '#FFCC33')<br/> folium.Circle(<br/>   location=[querydf.iloc[i]['lon'], querydf.iloc[i]['lat']],<br/>   popup=querydf.iloc[i]['estate']+': '+str(querydf.iloc[i]['saleable_price'])+' HKD per sq ft',<br/>   radius=querydf.iloc[i]['saleable_price']/25,<br/>   color=col,<br/>   fill=True,<br/>   opacity= 0.89,<br/>   fill_color=col,<br/>   stroke= True,<br/>   weight= 1<br/> ).add_to(m)<br/>m.save('hkmap.html')</span></pre><p id="affb" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">现在你知道了。在Python库的帮助下，可视化香港的各种房地产价格似乎并不太难。随意派生我的<a class="ae kr" href="https://github.com/enochk22/hk_prop_price_visualization" rel="noopener ugc nofollow" target="_blank"> repo </a>或者甚至使用其他库创建你自己的可视化。</p><figure class="kn ko kp kq fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ja jb di jc bf jd"><div class="fe ff ls"><img src="../Images/18f5e0e89a1c53c434317a6f74d0f121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gkA1S2yzN_MnAjEnb1Luvw.png"/></div></div></figure><p id="7f52" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">感谢您阅读我的第一篇文章。</p><blockquote class="lu"><p id="c914" class="lv lw ht bd lx ly lz ma mb mc md kl ek translated"><a class="ae kr" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mf mg mh mi mj iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff me"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>