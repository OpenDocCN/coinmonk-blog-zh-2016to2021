<html>
<head>
<title>Rock, Paper, Scissors in Solidity | Part 3 | Commit-Reveal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">石头，纸，剪刀在坚实|第3部分|承诺-揭示</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/rock-paper-scissors-in-solidity-part-3-commit-reveal-4d56a84cbe97?source=collection_archive---------2-----------------------#2021-10-19">https://medium.com/coinmonks/rock-paper-scissors-in-solidity-part-3-commit-reveal-4d56a84cbe97?source=collection_archive---------2-----------------------#2021-10-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/247708701503236e717d52c0f84453cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GfjjNT6YnDCm_U1u"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae jf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="46c2" class="jg jh ht bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">保守秘密</h2><p id="393b" class="pw-post-body-paragraph ke kf ht kg b kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky hm dt translated">这个游戏不能实时玩。在“石头、纸、剪刀”的游戏中，玩家无法预测另一个玩家要玩什么。但是，如果玩家没有在完全相同的时间进行游戏，整个场景就会改变。</p><p id="24ab" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">想象一下，如果两个人玩一个石头、纸和剪刀的游戏，间隔30分钟。让玩家保持诚实的最好方法是让玩家在类似投票亭的地方提交他们的选择——在那里，数据是安全的，并且被第三方隐藏起来。如果二号玩家可以看到一号玩家的选择，整个游戏就会分崩离析。</p><p id="97e7" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">当这个过程链上移动，它变得有点麻烦。我们必须对玩家的选择保密，直到两个选择都锁定。</p><h2 id="d298" class="jg jh ht bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">提交-显示</h2><p id="068d" class="pw-post-body-paragraph ke kf ht kg b kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky hm dt translated">通过散列函数发送选择将是不够的，因为选择将总是产生相同的散列；因此，玩家二可以在做出选择之前看到玩家一的选择。</p><p id="da3c" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">我们需要一个秘密，所以每个玩家都有自己的选择，以及一个独特的<em class="le"> Salt </em>。然后<em class="le"> Salt </em>将被用于允许每个玩家透露他们的选择。当他们重新提交他们的<code class="eh lf lg lh li b">choice + salt</code>时，他们的选择可以与之前的散列进行核对。这将释放他们的实际选择的游戏，然后价值可以检查赢家。</p><p id="ba92" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">因此，我们将<em class="le">提交</em>一个散列，而<em class="le">揭示</em>的选择，当它是安全的。</p><h2 id="afc3" class="jg jh ht bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">石头、纸张、剪刀</h2><blockquote class="lj lk ll"><p id="8043" class="ke kf le kg b kh kz kj kk kl la kn ko lm lb kq kr ln lc kt ku lo ld kw kx ky hm dt translated">这个例子的代码使用了一个<a class="ae jf" href="https://github.com/nathan-websculpt/reactsolidity_frontend/blob/master/src/components/RPSETH_v2.js" rel="noopener ugc nofollow" target="_blank">reaction Component</a>，这个组件的代码可以帮助你轻松地交换钱包地址，并作为两个玩家进行测试。</p></blockquote><p id="1c0b" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">整个过程是一号玩家<em class="le">开始</em>游戏，二号玩家<em class="le">参与</em>一号玩家所创造的游戏。</p><p id="4494" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">玩家选择和Salt变成了一个散列，智能合约将保存到游戏中。</p><figure class="lq lr ls lt fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lp"><img src="../Images/3877f5d7dd069935518c4b9400e65d04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Bgr4ORHJwpMJ94YgIzbhA.png"/></div></div></figure><p id="9c15" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">在两个玩家都将自己的杂凑<em class="le">提交</em>后，玩家将<em class="le">显示</em>自己的选择。您可以使用<em class="le">查看游戏</em>按钮查看一个<code class="eh lf lg lh li b">console.log</code>的整个游戏过程。点击<em class="le">结束游戏</em>，确定赢家。</p><figure class="lq lr ls lt fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lu"><img src="../Images/f2aa384503df2999028092dad077bb95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWNXkqfPNHVxXtBOEWJ6BQ.jpeg"/></div></div></figure></div><div class="ab cl lv lw hb lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hm hn ho hp hq"><h1 id="de09" class="mc jh ht bd ji md me mf jm mg mh mi jq mj mk ml ju mm mn mo jy mp mq mr kc ms dt translated">进入代码</h1><ul class=""><li id="1908" class="mt mu ht kg b kh ki kl km jr mv jv mw jz mx ky my mz na nb dt translated"><a class="ae jf" href="https://github.com/nathan-websculpt/reactsolidity_frontend" rel="noopener ugc nofollow" target="_blank">Github项目</a></li><li id="887c" class="mt mu ht kg b kh nc kl nd jr ne jv nf jz ng ky my mz na nb dt translated"><a class="ae jf" href="https://github.com/nathan-websculpt/reactsolidity_frontend/blob/master/contracts/RPSv2.sol" rel="noopener ugc nofollow" target="_blank">实体文件</a></li><li id="6123" class="mt mu ht kg b kh nc kl nd jr ne jv nf jz ng ky my mz na nb dt translated"><a class="ae jf" href="https://github.com/nathan-websculpt/reactsolidity_frontend/blob/master/src/components/RPSETH_v2.js" rel="noopener ugc nofollow" target="_blank">反应部件</a></li><li id="2118" class="mt mu ht kg b kh nc kl nd jr ne jv nf jz ng ky my mz na nb dt translated">用途<a class="ae jf" href="https://www.trufflesuite.com/ganache" rel="noopener ugc nofollow" target="_blank">加纳切&amp;松露</a></li><li id="7196" class="mt mu ht kg b kh nc kl nd jr ne jv nf jz ng ky my mz na nb dt translated">用途<a class="ae jf" href="https://github.com/NoahZinsmeister/web3-react" rel="noopener ugc nofollow" target="_blank"> web3-react </a></li><li id="e4fa" class="mt mu ht kg b kh nc kl nd jr ne jv nf jz ng ky my mz na nb dt translated">React应用程序<a class="ae jf" href="https://nervous-tereshkova-aa8032.netlify.app/" rel="noopener ugc nofollow" target="_blank">在live应用程序上构建注释</a></li></ul><p id="e90e" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">如果你不知道如何使用松露或加纳切，请查看第2部分。</p><div class="nh ni fm fo nj nk"><a rel="noopener follow" target="_blank" href="/@websculpt/rock-paper-scissors-in-solidity-part-2-web3-and-the-browser-79df179e8cd"><div class="nl ab ej"><div class="nm ab nn cl cj no"><h2 class="bd hu fv z el np eo ep nq er et hs dt translated">安全中的石头、剪子、布|第二部分| Web3和浏览器</h2><div class="nr l"><h3 class="bd b fv z el np eo ep nq er et ek translated">查看如何使用Web3、Truffle和Ganache在浏览器中与Solidity Smart Contract进行交互。</h3></div><div class="ns l"><p class="bd b gc z el np eo ep nq er et ek translated">medium.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny iz nk"/></div></div></a></div></div><div class="ab cl lv lw hb lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hm hn ho hp hq"><h1 id="924a" class="mc jh ht bd ji md me mf jm mg mh mi jq mj mk ml ju mm mn mo jy mp mq mr kc ms dt translated">这段代码是如何工作的。</h1><p id="60e2" class="pw-post-body-paragraph ke kf ht kg b kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky hm dt translated">盐将会是每个玩家的秘密。您当然可以使它比这更复杂，但这实际上是您产生可以链上复制的散列(在浏览器上)所需的一切。</p><p id="c175" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">*注意:这是web3-react，所以<code class="eh lf lg lh li b">library</code>提供对web3的访问。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="4693" class="jg jh ht li b fv od oe l of og"><strong class="li hu">The Salt</strong>: library.utils.sha3(“” + Math.random());</span><span id="1e49" class="jg jh ht li b fv oh oe l of og"><strong class="li hu">ABI Encoded Params: </strong>library.eth.abi.encodeParameters(['uint256', 'bytes32'],[gameChoice, salt]);</span><span id="4911" class="jg jh ht li b fv oh oe l of og"><strong class="li hu">The Hash: </strong>library.utils.sha3(encoded, {encoding: 'hex'});</span></pre><p id="d3b2" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">产生的散列足以让玩家进入游戏，而无需将他们的选择(以纯文本形式)发送到合同中。</p><figure class="lq lr ls lt fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff oi"><img src="../Images/2c6f0c494898ba8031bede7247389c1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fM6NxO0yEXbLFDuMaptKvg.jpeg"/></div></div></figure><h2 id="c9fe" class="jg jh ht bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">开始游戏</h2><p id="b2a2" class="pw-post-body-paragraph ke kf ht kg b kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky hm dt translated">使用文本框输入玩家2的地址，然后单击石头、布或剪刀。</p><figure class="lq lr ls lt fq iu fe ff paragraph-image"><div class="fe ff oj"><img src="../Images/68362194e07e8d4f7ca72c620386e922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*cPmhJNIeRhBHvAQqV6LLqA.jpeg"/></div></figure><p id="8586" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">这个javascript将把<em class="le">散列</em>、玩家二的地址和游戏赌注(硬编码为1 Ether)发送给合同。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="d5e2" class="jg jh ht li b fv od oe l of og">await contractInstance.methods.<br/>startGame(hash, playerTwoAddress, bet).<br/>send({ from: account }).then(function(receipt){</span><span id="6c17" class="jg jh ht li b fv oh oe l of og">   ....</span><span id="c008" class="jg jh ht li b fv oh oe l of og">}).catch(err =&gt; console.log(err));</span></pre><p id="94bf" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">这将把一个游戏添加到契约上的游戏列表中，玩家一将拥有用于以后更新游戏的地址。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="447f" class="jg jh ht li b fv od oe l of og">mapping (address =&gt; Game) public games;</span></pre><p id="de50" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">这是游戏结构。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="3f8d" class="jg jh ht li b fv od oe l of og">struct Game {<br/>   address playerOne;<br/>   address playerTwo;<br/>   uint stake;<br/>   uint  playerOneChoice;<br/>   uint  playerTwoChoice;<br/>   bytes32 playerOneHash;<br/>   bytes32 playerTwoHash;<br/>   GameStatus  status;<br/>   GameOutcome outcome;<br/>}</span></pre><p id="43eb" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">然后，玩家二通过发送玩家一的地址以及他们自己的散列来进入游戏。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="405c" class="jg jh ht li b fv od oe l of og">await contractInstance.methods.<br/>participateGame(hash, playerOneAddress).<br/>send({ from: account }).<br/>then(function(receipt){</span><span id="8be9" class="jg jh ht li b fv oh oe l of og">   ....</span><span id="8291" class="jg jh ht li b fv oh oe l of og">}).catch(err =&gt; console.log(err));</span></pre><p id="6073" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">当一号玩家开始游戏时，他们的选择还没有确定——契约只有一个散列。这样，没有盐参与人2就不知道参与人1的选择。打败这个游戏的方法是了解玩家一的盐。</p><p id="759d" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">玩家选择的值直到揭示该游戏的时候才被发送到区块链。当<code class="eh lf lg lh li b">choice + salt</code>被散列时——提交时的散列将与显示时的散列相同。</p><p id="7e46" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">理想情况下，每个玩家在之后发送敏感数据<em class="le">是安全的。他们也在确认自己做了某个选择(看到对方玩家的选择后无法改变主意)。</em></p><p id="eb58" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">玩家必须透露他们的选择，而且必须是他们最初的选择。</p><figure class="lq lr ls lt fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ok"><img src="../Images/cd0e792de89dee2388c81932833139f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e60S-n0par4Hvn_0gQ4Bdw.jpeg"/></div></div></figure><p id="bd81" class="pw-post-body-paragraph ke kf ht kg b kh kz kj kk kl la kn ko jr lb kq kr jv lc kt ku jz ld kw kx ky hm dt translated">on-chain reveal使用内部函数来重新创建散列。</p><pre class="lq lr ls lt fq nz li oa ob aw oc dt"><span id="5bf2" class="jg jh ht li b fv od oe l of og">function getSaltedHash(<br/>   uint answer, <br/>   bytes32 salt) <br/>     internal pure returns (bytes32) {</span><span id="b973" class="jg jh ht li b fv oh oe l of og">        return keccak256(abi.encodePacked(answer, salt));</span><span id="6968" class="jg jh ht li b fv oh oe l of og">}</span></pre><h1 id="2dc1" class="mc jh ht bd ji md ol mf jm mg om mi jq mj on ml ju mm oo mo jy mp op mr kc ms dt translated">这是合同</h1><figure class="lq lr ls lt fq iu"><div class="bz el l di"><div class="oq or l"/></div></figure></div><div class="ab cl lv lw hb lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hm hn ho hp hq"><h1 id="343d" class="mc jh ht bd ji md me mf jm mg mh mi jq mj mk ml ju mm mn mo jy mp mq mr kc ms dt translated">如何支持更多这样的帖子</h1><p id="889a" class="pw-post-body-paragraph ke kf ht kg b kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky hm dt translated">如果你想看更多这方面的内容，请在这里捐赠ETH或ERC-20代币:0xd 6355 a6b 745985342 ebf 168 E1 EC 965 DC 612704 b 1</p></div></div>    
</body>
</html>