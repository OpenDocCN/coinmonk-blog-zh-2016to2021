<html>
<head>
<title>Develop a Marketplace Contract with Token Payment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开发代币支付的市场合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/developing-a-marketplace-contract-with-token-payment-d865323ea88c?source=collection_archive---------0-----------------------#2019-05-19">https://medium.com/coinmonks/developing-a-marketplace-contract-with-token-payment-d865323ea88c?source=collection_archive---------0-----------------------#2019-05-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><h1 id="b22b" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">介绍</h1><p id="41f0" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在我之前的文章(<a class="ae km" rel="noopener" href="/@kctheservant/use-dapp-tools-for-ethereum-contract-development-2775d8b2ba0"> link </a>)中，我已经展示了dapps.tools在Ethereum契约开发中的使用，并了解了如何使用dapp和seth通过测试集执行契约代码的单元测试，并在本地测试网中部署我的契约代码。</p><p id="d84b" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">在本文中，我首先创建了另一个模拟市场的合同。和部署，我将添加一个令牌作为市场中项目的付款。我使用的令牌来自ds-token包，这是一个可铸造的ERC20令牌。最后，我们将演示契约函数的执行，并看看我的契约如何与令牌契约交互。</p><h1 id="8c6b" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">应用程序概述</h1><p id="21dc" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">该应用程序是一个模拟市场运作的智能合约。它将某人(卖家)列出的物品按价格标签保存，另一个人(买家)可以通过向卖家支付该价格来购买该物品。它还带有一些检查功能，以查看该商品是否存在或已经售出。同时，买方可以从市场移除该物品，只要该物品还没有被出售给任何人。</p><p id="6efe" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">在第一阶段，我们将完成这些功能。在第2阶段，我们将实施ERC20令牌作为该市场中的(唯一)支付方式。</p><p id="8f9f" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">这个应用程序本身绝不是一个完整的生产应用程序，在它成为一个完整的功能之前，还有许多工作要做。然而，这满足了我的目的，即展示如何使用dapp.tools构建有趣的东西，并使用ds-token包添加令牌。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff ks"><img src="../Images/ca21e3ff17ebf68b94707e435d6a0de1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEWBRomvxmOZfAUf-Y8E4A.png"/></div></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">A marketplace application with token payment</figcaption></figure><h1 id="d9d6" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">阶段1:没有代币支付的市场</h1><p id="f85d" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">为此合同创建工作区。我们将工作区命名为emarket(目录名)。使用dapp.tools，我们将拥有一个预定义的合同名称<strong class="jq hu"> Emarket.sol </strong>和相关的测试合同<strong class="jq hu"> Emarket.t.sol </strong>。</p><p id="2685" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们会调查这两份合同文件。然后开始在testnet上测试和部署契约。最后，我们将在这个已部署的契约上模拟一些活动。</p><h2 id="041f" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">合同:Emarket.sol</h2><p id="21a7" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">这是我在这个演示中使用的契约代码。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="9bc0" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">数据结构<em class="ly">条目</em>保存了emarket中发布的每个条目的详细信息。它包含一个描述、卖家和买家、价格和一个该商品是否售出的布尔值。注意，价格在这个阶段只是一个数字，稍后在我们实现第二阶段的令牌后，它将是一个令牌的数量。</p><p id="f3ae" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated"><em class="ly">项</em>是从索引到数据结构项的映射。我们简单地维护一个计数器<em class="ly"> itemCount </em>来计算索引。</p><p id="2d5b" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">本合同不需要施工方。本合同中定义了六项功能。</p><p id="4331" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated"><em class="ly"> addItem(description，price) </em>在卖家在emarket中列出一个商品时被调用。我们需要的只是那个项目的描述和价格。这将被记录为索引为itemCount+1的新项目。</p><p id="fa3f" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">当任何人希望显示一个项目的细节时，就会调用getItem(index) 。我们将取回描述和价格。</p><p id="d730" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">当任何人希望知道一个项目是否存在时，就会调用checkedItemExisting(index) 。</p><p id="a66c" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated"><em class="ly"> checkedItemSold(index) </em>当任何人想知道一件商品是否已经售出时，就会调用这个函数。</p><p id="033e" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated"><em class="ly"> removedItem(index) </em>只能由之前列出物品的卖家调用。</p><p id="dc8f" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated"><em class="ly"> buyItem(index) </em>被买家调用。买家只能购买尚未售出的物品。目前，该逻辑只是更新买方地址并标记已售标志。</p><h2 id="0430" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">测试合同:Emarket.t.sol</h2><p id="1ded" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我们已经为我的emarket合同定义了四个测试用例。它们是不言自明的，所以这里我们不提供细节。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="lw lx l"/></div></figure><h2 id="0eee" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">设置工作空间</h2><p id="3d32" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我们将设置我们的工作区emarket，如前一篇文章所示。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="42b4" class="li ir ht ma b fv me mf l mg mh">mkdir emarket<br/>cd emarket</span><span id="2574" class="li ir ht ma b fv mi mf l mg mh">dapp init</span></pre><p id="4d9d" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">在我们粘贴我们的合同<strong class="jq hu"> Emarket.sol </strong>和测试合同<strong class="jq hu"> Emarket.t.sol </strong>之后，我们可以使用<code class="eh mj mk ml ma b">dapp test</code>来执行单元测试。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff mm"><img src="../Images/7d72df7c1ce5424d8513fd8fe5d37357.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*TLVuVdilQPdoOwea"/></div></figure><p id="328b" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">从结果中我们知道所有的测试用例都通过了。</p><h2 id="8026" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">运行Testnet并部署契约</h2><p id="434a" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">和以前一样，我们使用<code class="eh mj mk ml ma b">dapp testnet</code>打开另一个终端来运行testnet。为了得到更多的两个地址进行演示，我们可以指定<code class="eh mj mk ml ma b">option -- account</code>。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff mm"><img src="../Images/b773d7c566e55f1a746b097c97a67531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*pC0d5bVp87diOP7L"/></div></figure><p id="83de" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">出于演示目的，我们将创建环境变量。我们使用ETH_FROM的第一个帐户是coinbase帐户。如果我们没有指定任何东西，这是默认帐户。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="a58d" class="li ir ht ma b fv me mf l mg mh">export ETH_KEYSTORE=~/.dapp/testnet/8545/keystore<br/>export ETH_GAS=2000000<br/>export ETH_FROM=0x60c5d2e21151275b752627d000428431dde3db07<br/>export ALICE=0x56c01aa43dbf31100b7335d9c247adb55d2eeceb<br/>export BOB=0x31ba7173a223db36b9d51220ea046a99ea8ae8d4</span></pre><p id="08c4" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们使用<code class="eh mj mk ml ma b">dapp create</code>部署合同。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff mm"><img src="../Images/086ef8b4d1a27bc57d9e4f22b1136ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*vZ85K69Zf_M6OYJY"/></div></figure><p id="e329" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在我们有了合约地址0x7e2d…d237。作为一个好的实践，我们使用一个环境变量来保存这个地址。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="ca1d" class="li ir ht ma b fv me mf l mg mh">export EMARKET=0x7e2daacd18aeda6f8220e542137bff36a40ed237</span></pre><h2 id="3736" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">与合同互动</h2><p id="99ca" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在这个演示中，我们模拟了一个真实的例子。这包括以下步骤。</p><ol class=""><li id="8ca6" class="mn mo ht jq b jr kn jv ko jz mp kd mq kh mr kl ms mt mu mv dt translated">检查目前市场上还没有任何项目。</li><li id="4566" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">Alice列出了一个项目“一支笔”,并将价格标为100。检查商品是否在市场中。</li><li id="9aa8" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">鲍勃买了这件物品。检查该商品是否售出，Bob的地址是否记录正确。</li><li id="43b9" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">Alice试图移除此物品，但是失败了，因为此物品已经售出。</li></ol><p id="8a1d" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第一步:首先让我们看看当前的<em class="ly">项目计数</em>。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="0a61" class="li ir ht ma b fv me mf l mg mh">seth call $EMARKET “itemCount()”</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/03ea7666613c36cca7d045b6856f76fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/0*yNVmIZfBcma9S0zC"/></div></figure><p id="9b87" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第二步:爱丽丝列出一个项目。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="6046" class="li ir ht ma b fv me mf l mg mh">seth send $EMARKET “addItem(string memory, uint)” $(seth —-from-ascii “a pen”) $(seth —-to-uint256 100) --from=$ALICE</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/d0d8e37a680581b3fb6f8e5cbd730dd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*wX0ToAdkZpMWJ11Z"/></div></figure><p id="7ced" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">然后查看物品计数和物品#1的详细信息。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="c8fd" class="li ir ht ma b fv me mf l mg mh">seth call $EMARKET “itemCount()”<br/>seth call $EMARKET “items(uint)(string memory,address,address,uint,bool)” $(seth —-to-uint256 1)</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/d347d76ceb9f57aa4a3753f02a4cc886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*YDzYbvrlpIIvu3po"/></div></figure><p id="1e35" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们可以看到有一个项目，我们看到的描述(“一支笔”在ascii)，卖方爱丽丝，这个项目还没有出售。</p><p id="016d" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第三步:现在鲍勃买了这件物品(物品#1)。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="5b1e" class="li ir ht ma b fv me mf l mg mh">seth send $EMARKET “buyItem(uint)” $(seth —-to-uint256 1) — from=$BOB</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/2320b36e31aa5ec7a6b5dfb26a2eceb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/0*fOh_hqOB_mAXzYzr"/></div></figure><p id="4f1a" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">然后我们再次检查第一项。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="c50e" class="li ir ht ma b fv me mf l mg mh">seth call $EMARKET “items(uint)(string memory,address,address,uint,bool)” $(seth —-to-uint256 1)</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/a16aa86ed35b0da42ac2446b48543a29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*2ww6Ui46TJoQMXpn"/></div></figure><p id="ee23" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在我们看到买家地址(Bob的)被记录，这件物品被标记为真(已售出)。</p><p id="98af" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第四步:爱丽丝试图删除这个项目。她不能，因为这件物品已经售出。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="d60e" class="li ir ht ma b fv me mf l mg mh">seth send $EMARKET “removeItem(uint)” $(seth —-to-uint256 1) —-from=$ALICE</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/daca7bd16a76db640ee3ab40b2aaf1a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*AmDYkurSxdyoDVsK"/></div></figure><h1 id="3bf5" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">阶段2:以代币作为支付方式的市场</h1><h2 id="432b" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">创建新的工作区</h2><p id="de63" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">随着marketplace的基本功能就绪，我们现在将包括一个ERC20令牌作为该marketplace的定价和支付方法。</p><p id="4f5e" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">为了保持整洁，我们在这里创建了另一个工作区，即emarketwithcoin</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="7753" class="li ir ht ma b fv me mf l mg mh">mkdir emarketwithcoin<br/>cd emarketwithcoin</span><span id="c35e" class="li ir ht ma b fv mi mf l mg mh">dapp init</span></pre><p id="2073" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们正在使用<code class="eh mj mk ml ma b">dapp.tools</code>中提供的<code class="eh mj mk ml ma b">ds-token</code>包。<code class="eh mj mk ml ma b">ds-token</code>是一个标准ERC20实现包，加上一些额外的功能，如<em class="ly"> mint() </em>和<em class="ly"> burn() </em>。有一些先进的功能与其他软件包一起工作，但基本的ERC20和mint/burn对我们的演示来说已经足够好了。</p><p id="60e0" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们将首先安装软件包。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="b612" class="li ir ht ma b fv me mf l mg mh">dapp install ds-token</span></pre><p id="e7f7" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">安装了所有必需的软件包。该软件包安装在lib/ds-token下。</p><p id="e963" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">如果我们检查lib/ds-token/src/base.sol和lib/ds-token/src/token.sol中的令牌契约，我们可能会看到一个ERC20令牌的实现，以及一些附加的函数。同时，每一个都带有一个单元测试契约，当契约被部署时，测试正在运行。</p><h2 id="8009" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">修改我们的合同代码</h2><p id="eb80" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">为了简单起见，我们只关注契约代码，将测试契约代码放在一边(我们在早期的会议中看到它是如何工作的)。这不是最佳实践，因为我们应该总是使用测试合同进行单元测试。然而，我们假设我们代码适合于演示。</p><p id="4f97" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">这是Emarketwithcoin的合同代码。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="ce99" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">在这里，我只强调了上一个例子的附加部分。</p><p id="41d4" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">1.从<code class="eh mj mk ml ma b">ds-token</code>包中导入合同。这里我们导入token.sol。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="b68a" class="li ir ht ma b fv me mf l mg mh">import “ds-token/token.sol”;</span></pre><p id="7c67" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">如果我们看一下代码，token.sol进一步导入base.sol，token.sol提供了我们将在后面使用的类DSToken。注意缺省的数据存储没有固定的供应量，十进制精度为18。出于演示目的，我们将保持这一点，不考虑实际精度。</p><p id="5916" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">2.指定令牌协定的位置。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="1681" class="li ir ht ma b fv me mf l mg mh">ERC20 public emark;</span><span id="1161" class="li ir ht ma b fv mi mf l mg mh">constructor (address _emark) public {<br/>    emark = ERC20(_emark);<br/>}</span></pre><p id="9dff" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">这里我们定义了一个对象emark，它保存了部署的令牌契约。因此，在我们的部署中，我们首先部署一个令牌契约，所部署契约的契约ID通过构造函数传递给该契约。稍后我们将看到它是如何工作的。</p><p id="d57c" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">3.购买物品时转让代币。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="dabd" class="li ir ht ma b fv me mf l mg mh">function buyItem(uint _index) public {<br/>    Item storage i = items[_index];<br/>    require(i.seller != address(0), “no such item”); // not exists<br/>    require(!i.sold, “item sold already”);<br/>    require(i.price &lt;= emark.balanceOf(msg.sender), “not enough tokens”);<br/>    i.buyer = msg.sender;<br/>    i.sold = true;<br/>    emark.transferFrom(msg.sender, i.seller, i.price);<br/>}</span></pre><p id="2d66" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">这里我们补充两个逻辑。首先，我们将检查买家购买列表项目时的余额。如果余额不足，交易失败。我们还将使用<em class="ly"> transferFrom </em>将代币从购买此物品的人转移到此物品的卖家。由于是Emarketwithcoin合同执行从的<em class="ly">转移，买方需要批准用于转移的Emarketwithcoin合同。稍后我们将看到它是如何工作的。</em></p><p id="a98b" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">4.更新测试契约(在Emarketwithcoin.t.sol内部)。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="e5fa" class="li ir ht ma b fv me mf l mg mh">function setUp() public {<br/>    emarketwithcoin = new Emarketwithcoin(address(0x123));<br/>}</span></pre><p id="9d39" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">因为我们已经包含了构造函数并且需要一个地址，所以我们需要用一个伪地址来修改Emarketwithcoin.t.sol，以便通过测试。同样，我们没有定义任何测试用例，因此测试地址在这种情况下没有意义。</p><h2 id="aee5" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">在Testnet中部署合同</h2><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nd"><img src="../Images/beeee2261eb6114e42a7c7e9e3bc73e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*Zovwhpm0B-8Fg5TEJgULRQ.png"/></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">Token contract is deployed first as Marketplace requires the Token Contract ID</figcaption></figure><p id="c145" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">和以前一样，我们使用<code class="eh mj mk ml ma b">dapp testnet</code>打开另一个终端来运行testnet。我们还需要两个地址来演示。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff ne"><img src="../Images/bfed7ad7feef845116941529c11b93c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/0*WjLkZNy8bj30eriG"/></div></figure><p id="48f5" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">出于演示目的，我们将创建环境变量。我们使用ETH_FROM的第一个帐户是coinbase帐户。如果我们没有指定任何东西，这是默认帐户。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="f2d1" class="li ir ht ma b fv me mf l mg mh">export ETH_KEYSTORE=~/.dapp/testnet/8545/keystore<br/>export ETH_GAS=3000000<br/>export ETH_FROM=0x631911a584ae91af67efce2adb3d20b5e29b3be5<br/>export ALICE=0x2963cb08f690a072b718addbc6478641305f5e69<br/>export BOB=0x486e85148d38402bd72a30fea6dcbc7a5cb5f3d8</span></pre><p id="136f" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在，我们首先部署令牌契约。我们传递给新契约的符号是emark。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="b469" class="li ir ht ma b fv me mf l mg mh">dapp create DSToken $(seth —-to-bytes32 $(seth —-from-ascii emark))</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff mm"><img src="../Images/67d3ebf2489e6f9c2c405175f9b6670e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*JY00v8WfSSlmpoxC"/></div></div></figure><p id="8508" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在我们有了令牌合同ID(或合同地址)。我们将使用环境变量EMK来保存这个地址。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="116e" class="li ir ht ma b fv me mf l mg mh">export EMK=0xce13f923964091acb55c4c8fcf5b6f2a3261dda6</span></pre><p id="2603" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">这样，我们就可以部署Emarketwithcoin契约了。我们按照构造函数中的要求指定令牌协定ID。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="624c" class="li ir ht ma b fv me mf l mg mh">dapp create eMarketwithcoin $EMK</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff ne"><img src="../Images/60c3b4f2b884f40c3c82d3555b15eb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/0*PES6PEbM24tsVsIv"/></div></figure><p id="4e35" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在我们有了另一个合同ID。我们将在环境多变的市场中把握这一点。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="f0e5" class="li ir ht ma b fv me mf l mg mh">export MARKET=0xda99912a9c7a370cd24621f0147f4b13e1d0f830</span></pre><p id="b7b6" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">现在我们已经部署了两个合同。</p><h2 id="80b9" class="li ir ht bd is lj lk ll iw lm ln lo ja jz lp lq je kd lr ls ji kh lt lu jm lv dt translated">与合同互动</h2><p id="9909" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我们对这些已部署契约的演示流程很简单。</p><ol class=""><li id="9469" class="mn mo ht jq b jr kn jv ko jz mp kd mq kh mr kl ms mt mu mv dt translated">检查Alice和Bob的电子马克余额，发现开始时没有余额。</li><li id="a1c4" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">薄荷鲍勃100马克。它将用于购买Alice列出的商品。</li><li id="1bdb" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">Alice列出了一个价格设置为80马克的商品。</li><li id="bbf6" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">鲍勃买了这件物品。</li><li id="0868" class="mn mo ht jq b jr mw jv mx jz my kd mz kh na kl ms mt mu mv dt translated">检查Alice和Bob的电子邮件余额，我们看到有80封电子邮件转给了Alice。</li></ol><p id="ccab" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">永远记住我们有两个合同:EMK的令牌，市场的市场。它们是两个独立的契约，唯一的联系是当有人购买物品时，市场契约会调用EMK。</p><p id="60ba" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">步骤1:我们从象征性契约开始。检查总EMK供应的余额，以及爱丽丝和鲍勃的余额。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="1009" class="li ir ht ma b fv me mf l mg mh">seth call $EMK “totalSupply()”<br/>seth call $EMK “balanceOf(address)” $ALICE<br/>seth call $EMK “balanceOf(address)” $BOB</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff mm"><img src="../Images/3e2dbe4fafdcd4ee9e69172610796099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*M5nd0qtR-XnuWqq6"/></div></figure><p id="0e28" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">最初都是零。还没有电子标记。</p><p id="cda0" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第二步:我们给鲍勃制造了100封电子邮件。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="4655" class="li ir ht ma b fv me mf l mg mh">seth send $EMK “mint(address,uint)” $BOB $(seth —-to-uint256 100)</span></pre><p id="891f" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">并检查余额。Bob有100个电子标记(0x64 ),总的电子标记供应量也是100。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nf"><img src="../Images/24590f08a4a4c7fe6f1ff629c7c03926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/0*c9S9cRfOH4ypp-KC"/></div></figure><p id="ef23" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">在营销人员可以从Bob帐户转移代币之前，Bob需要批准营销该金额。假设鲍勃同意80封电子邮件。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="25dc" class="li ir ht ma b fv me mf l mg mh">seth send $EMK “approve(address,uint)” $MARKET $(seth —-to-uint256 80) —-from=$BOB</span></pre><p id="2ba6" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第三步:我们走向市场。爱丽丝列出了一个项目“一支笔”，价格是80马克。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="ca01" class="li ir ht ma b fv me mf l mg mh">seth send $MARKET “addItem(string memory, uint)” $(seth —-from-ascii “a pen”) $(seth —-to-uint256 80) —-from=$ALICE</span></pre><p id="e55c" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们将看到记录的第一项。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="be27" class="li ir ht ma b fv me mf l mg mh">seth call $MARKET “items(uint)(string memory,address,address,uint,bool)” $(seth —-to-uint256 1)</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff ng"><img src="../Images/bbcef463607411a2cded1340fe5d9af0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/0*O9fNcr5edKEmbmbu"/></div></figure><p id="2590" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">物品由爱丽丝列出，现在已经售出。</p><p id="cf5a" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">第四步:鲍勃正在购买这件物品。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="0e1c" class="li ir ht ma b fv me mf l mg mh">seth send $MARKET “buyItem(uint)” $(seth —-to-uint256 1) —-from=$BOB</span></pre><p id="dead" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们再次检查第一项。</p><pre class="kt ku kv kw fq lz ma mb mc aw md dt"><span id="89f5" class="li ir ht ma b fv me mf l mg mh">seth call $MARKET “items(uint)(string memory,address,address,uint,bool)” $(seth —-to-uint256 1)</span></pre><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/1e9982018ef26e155736451e1651be7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/0*nTuwggz31cyTU_9f"/></div></figure><p id="b0d7" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">物品卖给了鲍勃。</p><p id="0781" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">步骤5:最后，我们再次检查爱丽丝和鲍勃的EMK总供应量和余额。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff nb"><img src="../Images/4cd698aeacdf83049eddb7fc198c77bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/0*sH3eloQCzhN7UsJn"/></div></div></figure><p id="d391" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">我们看到80封电子邮件从Bob转给了Alice，因为Bob用80封电子邮件购买了Alice的物品。总供应量仍然是100马克。</p><h1 id="4bab" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">关闭</h1><p id="c616" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我们展示了一个样本市场契约(同样，不是优化的，也不是用于生产的)。我们看到了如何使用测试契约来实现一些功能上的单元测试。在testnet上部署之后，我们演示了如何执行市场中定义的功能。然后，我们使用相同的市场合同，并添加令牌作为定价和支付方法。使用ds-token包并稍加修改，市场契约可以在进行购买时执行令牌传输。</p><p id="b04e" class="pw-post-body-paragraph jo jp ht jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hm dt translated">希望你能看到dapp.tools的使用，以及在以太坊平台上开发contract时的便利。dapp.tools还有一些其他的包，你会从中找到更多的乐趣。</p><blockquote class="nh"><p id="6c42" class="ni nj ht bd nk nl nm nn no np nq kl ek translated"><a class="ae km" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="ns nt nu nv nw kx fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nr"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>