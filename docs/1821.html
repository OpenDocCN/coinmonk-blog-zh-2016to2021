<html>
<head>
<title>Express Quantstamp contracts as javascript — Audit completed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Quantstamp合同表示为javascript —审计已完成</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/express-quantstamp-contracts-as-javascript-audit-completed-c53930cf7ed3?source=collection_archive---------2-----------------------#2018-11-23">https://medium.com/coinmonks/express-quantstamp-contracts-as-javascript-audit-completed-c53930cf7ed3?source=collection_archive---------2-----------------------#2018-11-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="5cff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Quantstamp是一个智能合同安全审计系统，具有可扩展性和成本效益。为了更好地理解，我将Quantstamp契约表示为Javascript。更多信息请参考<a class="ae jo" href="https://crushcrypto.com/wp-content/uploads/2017/10/QSP-Whitepaper.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a>或<a class="ae jo" rel="noopener" href="/quantstamp/securing-smart-contracts-on-the-blockchain-a-technical-overview-of-the-quantstamp-betanet-protocol-f13dab2daa51">官方博客</a>。</p><p id="5b70" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">GitHub:<a class="ae jo" href="https://github.com/tak1827/quantstamp-contracts-js/tree/audit-completed" rel="noopener ugc nofollow" target="_blank">quant stamp-contracts-js</a></p></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="07ce" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">Quantstamp简介</h2><p id="f1ad" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">智能合约安全性对于防止类似DAO的安全事件至关重要。不幸的是，当前的智能合同验证过程需要人工专家，因此成本高昂且容易出错。Quantstamp通过在以太网上构建审计系统解决了这个问题。</p><figure class="kx ky kz la fq lb fe ff paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="fe ff kw"><img src="../Images/2676e527b3216fa1b49efb22b43819a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aSMZS6tg1LS5MGd2Vnwieg.png"/></div></div></figure><p id="8c0a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">首先，开发者通过与QST令牌的Quantstamp合同提交他的代码，验证者将这些令牌作为奖励。验证器(由Quantstamp认证)接收提交的请求并执行安全检查。该检查是离线活动，由安全审计引擎完成。</p><figure class="kx ky kz la fq lb fe ff paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="fe ff li"><img src="../Images/1835edbc5df41c2e3b9a2d04c466a01c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D1c6jRVmj15zsTT5SzLUUg.png"/></div></div></figure><p id="cb42" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个引擎由几个组件组成，如安全库。该库不断发展以应对新漏洞。作为诽谤输出，引擎生成一个报告。验证器将报告添加到下一个以太坊块中。这种报告可以是公开的，也可以是秘密的。公共报告以人类可读的形式对每个人可见。私人报告是加密的。</p></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="d1ef" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">QST状态转换</h2><figure class="kx ky kz la fq lb fe ff paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="fe ff lj"><img src="../Images/379ed8d43de714187bf1ef345ed38b2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2N_by6w5Psrac8bAk0J7g.png"/></div></div></figure><p id="3c9c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在审计过程中，有几种可能的状态，如上图所示。这次集中在红线过渡上。这个过渡是一个成功的过程，没有任何错误。让我们分成3个步骤</p><ol class=""><li id="e860" class="lk ll ht is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls dt translated"><em class="lt">开发者请求审核</em></li><li id="046f" class="lk ll ht is b it lu ix lv jb lw jf lx jj ly jn lp lq lr ls dt translated"><em class="lt">验证器获取审计请求</em></li><li id="c548" class="lk ll ht is b it lu ix lv jb lw jf lx jj ly jn lp lq lr ls dt translated"><em class="lt">验证器提交报告</em></li></ol></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="8e63" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">1.开发者请求审计</h2><p id="523c" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">一个开发者通过调用QuantstampAudit.sol的‘request audit’函数提交支付10 QST的‘Samp’契约进行验证，这个契约包含了审计过程的所有逻辑。</p><p id="5f25" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">查看requestAudit函数的“requestId”。这是一个唯一的id。</p><p id="bd52" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">顺便说一下，请求存储在另一个名为“QuantstampAudit.sol”的契约中。这是一份仓储合同。</p><pre class="kx ky kz la fq lz ma mb mc aw md dt"><span id="ee2a" class="jw jx ht ma b fv me mf l mg mh">developer.run(function() {</span><span id="5689" class="jw jx ht ma b fv mi mf l mg mh">  // Create a contract to be audit<br/>  Samp = new Sample();</span><span id="5f5e" class="jw jx ht ma b fv mi mf l mg mh">  // Cost of verification<br/>  const cost = 10;</span><span id="b16a" class="jw jx ht ma b fv mi mf l mg mh">  ...</span><span id="6d41" class="jw jx ht ma b fv mi mf l mg mh">  // Request audit<br/>  requestId = QSTAudit.requestAudit(Samp.address, cost);</span><span id="fff6" class="jw jx ht ma b fv mi mf l mg mh">});</span><span id="ea00" class="jw jx ht ma b fv mi mf l mg mh">/********** QuantstampAudit.sol **********/</span><span id="3caa" class="jw jx ht ma b fv mi mf l mg mh">requestAudit(contractUri, price) {</span><span id="7ae0" class="jw jx ht ma b fv mi mf l mg mh">  ...</span><span id="f738" class="jw jx ht ma b fv mi mf l mg mh">  const requestId = this.auditData.addAuditRequest(<br/>    from, contractUri, price);</span><span id="010e" class="jw jx ht ma b fv mi mf l mg mh">  // Add request to queue<br/>  this.queueAuditRequest(requestId);</span><span id="f5f8" class="jw jx ht ma b fv mi mf l mg mh">  return requestId;<br/>}</span></pre><p id="854a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请求的结构如下。</p><pre class="kx ky kz la fq lz ma mb mc aw md dt"><span id="a7b0" class="jw jx ht ma b fv me mf l mg mh">class Audit {<br/>  ...<br/>  {<br/>    this.requestor = requestor;<br/>    this.contractUri = contractUri;<br/>    this.price = price;<br/>    this.requestBlockNumber = requestBlockNumber;<br/>    this.state = state;<br/>    this.auditor = auditor;<br/>    this.assignBlockNumber = assignBlockNumber;<br/>    this.reportHash = reportHash;<br/>    this.reportBlockNumber = reportBlockNumber;<br/>    this.registrar = registrar;<br/>  }<br/>}</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="38d2" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">2.验证程序获取审计请求</h2><p id="800a" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">验证程序调用“getNextAuditRequest”函数。然后，从队列中挑选一个审计。</p><p id="51d0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请注意，获得的审计价格高于最低价格(对每个验证者都是唯一的)。</p><pre class="kx ky kz la fq lz ma mb mc aw md dt"><span id="f667" class="jw jx ht ma b fv me mf l mg mh">validator.run(function() {</span><span id="daf5" class="jw jx ht ma b fv mi mf l mg mh">  // Get audit request<br/>  QSTAudit.getNextAuditRequest();</span><span id="54f2" class="jw jx ht ma b fv mi mf l mg mh">});</span><span id="0eef" class="jw jx ht ma b fv mi mf l mg mh">/********** QuantstampAudit.sol **********/</span><span id="fe25" class="jw jx ht ma b fv mi mf l mg mh">getNextAuditRequest() {<br/> ...</span><span id="5fa4" class="jw jx ht ma b fv mi mf l mg mh">  // there are no audits in the queue with a price high enough <br/>  // for the audit node<br/>  const minPrice = this.auditData.getMinAuditPrice(msg.sender);<br/>  const requestId = this.dequeueAuditRequest(minPrice);<br/>  if (requestId === 0) return;</span><span id="5e75" class="jw jx ht ma b fv mi mf l mg mh">  // Update storage contract<br/>  this.auditData.setAuditState(requestId, AuditState.Assigned);<br/>  this.auditData.setAuditAuditor(requestId, from);<br/>  this.auditData.setAuditAssignBlockNumber(requestId, block.number);<br/>  <br/>  ...</span><span id="9c5f" class="jw jx ht ma b fv mi mf l mg mh">  // push to the tail<br/>  this.assignedAudits.push(requestId);<br/>}</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="133a" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">3.验证程序提交报告</h2><p id="e899" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">验证程序向合同提交一个报告，并附上一个报告散列。请注意，验证程序必须在审计超时期间提交报告。</p><p id="8e51" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最后，验证者获得QST令牌作为奖励，由开发者创建的契约被验证是安全的。</p><pre class="kx ky kz la fq lz ma mb mc aw md dt"><span id="c010" class="jw jx ht ma b fv me mf l mg mh">validator.run(function() {</span><span id="6032" class="jw jx ht ma b fv mi mf l mg mh">  // Report hash -&gt; Following creation is not real<br/>  const reportHash = CryptoJS.RIPEMD160(<br/>    CryptoJS.SHA256(JSON.stringify(Samp))).toString();</span><span id="e425" class="jw jx ht ma b fv mi mf l mg mh">  // Submit report<br/>  QSTAudit.submitReport(<br/>    requestId, AuditState.Completed, reportHash);</span><span id="8217" class="jw jx ht ma b fv mi mf l mg mh">});</span><span id="efbd" class="jw jx ht ma b fv mi mf l mg mh">/********** QuantstampAudit.sol **********/</span><span id="ede7" class="jw jx ht ma b fv mi mf l mg mh">submitReport(requestId, auditResult, reportHash) {<br/>  ...<br/>  <br/><br/>  const allowanceBlockNumber = <br/>    this.auditData.getAuditAssignBlockNumber(requestId) +<br/>    this.auditData.auditTimeoutInBlocks;<br/>  <br/>  // auditor should not send a report after its allowed period<br/>  if (allowanceBlockNumber &lt; block.number) {<br/>    // update assigned to expired state<br/>    this.auditData.setAuditState(requestId, Expired);<br/>    return;<br/>  }</span><span id="ead6" class="jw jx ht ma b fv mi mf l mg mh">  // update the audit information held in this contract<br/>  this.auditData.setAuditState(requestId, auditResult);<br/>  this.auditData.setAuditReportHash(requestId, reportHash);<br/>  this.auditData.setAuditReportBlockNumber(requestId, block.number);</span><span id="0dfb" class="jw jx ht ma b fv mi mf l mg mh">  ...<br/>  <br/>  // Validator get QST token as reward<br/>  this.auditData.token.transfer(from, auditPrice);<br/>  <br/>}</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="732c" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">未来研究</h2><p id="0b3a" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">这次，我只关注正常的状态转换。关于其他转换，请检查<a class="ae jo" href="https://etherscan.io/address/0xb04aedd62775fe736be7d4b25289b3baed57258e#code" rel="noopener ugc nofollow" target="_blank">实际智能合同</a>。</p><p id="d8a5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，Quantstamp在以太坊主网上直播<a class="ae jo" href="https://betanet.quantstamp.com/start" rel="noopener ugc nofollow" target="_blank">。所以我们实际上可以请求审计。请也检查一下这个。</a></p><blockquote class="mj"><p id="3a99" class="mk ml ht bd mm mn mo mp mq mr ms jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mu mv mw mx my lb fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mt"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>