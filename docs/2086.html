<html>
<head>
<title>Upgradeability may (not) be a Bug</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可升级性可能(不)是一个缺陷</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/upgradeability-may-not-be-a-bug-96ff3cb6e41f?source=collection_archive---------2-----------------------#2019-02-19">https://medium.com/coinmonks/upgradeability-may-not-be-a-bug-96ff3cb6e41f?source=collection_archive---------2-----------------------#2019-02-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="a53c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">受<a class="ae jo" rel="noopener" href="/consensys-diligence/upgradeability-is-a-bug-dba0203152ce">可升级性的启发，是一个Bug </a>和一个<strong class="is hu">真实的ERC-20令牌故事。</strong></p><p id="e9f8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我基本同意史蒂文斯的文章。<br/>但是，如果你公司的主要产品之一应该是运行在以太坊区块链上的不可阻挡的代码，并与智能合约进行交互，该怎么办呢？</p><ul class=""><li id="a7c6" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">不符合标准的接口；</li><li id="6491" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">不可预测的业务逻辑/接口实现？</li></ul><p id="d60b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将所有东西混合在一起:</p><ul class=""><li id="dc6e" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">整个以太坊环境的(不那么)早期阶段；</li><li id="277a" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">初创企业的热潮瞄准了一个“当蓝宝”的ICO</li><li id="8849" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">相信只要一点点“复制和粘贴”就足以创建一个ERC-20令牌智能合约</li></ul><p id="205b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您将最终设计出一个可升级的智能合约。</p><p id="bb2d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是我们面临的挑战之一。<br/>我们的混合分散式交易所解决方案的一部分是为用户提供一个智能合约，又名<em class="kd"> TradingWallet </em>，用于ERC-20令牌管理。</p><p id="df8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从架构的角度来看，我们将<em class="kd"> TradingWallet </em>设计为三个智能合约的组合:</p><ul class=""><li id="5df0" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated"><strong class="is hu"> <em class="kd">钱包</em> </strong>智能<strong class="is hu"> </strong>契约:跟踪状态变量，定义<em class="kd"> TradingWallet </em>功能接口；</li><li id="41f6" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated"><strong class="is hu"><em class="kd">walletlogicv 1/2/3…</em></strong><em class="kd"/>智能合约<em class="kd"> : </em>实现上述接口的业务逻辑；</li><li id="f837" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated"><strong class="is hu"><em class="kd">Wallet connector</em></strong>智能合约:连接<em class="kd">钱包</em> SC和<em class="kd"> WalletLogicVx </em> SC。</li></ul><p id="08e6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基本上<em class="kd">钱包</em>智能契约是使用<em class="kd">将一个函数调用重定向到<em class="kd">WalletLogicVx</em><strong class="is hu"><em class="kd"/></strong>底层正确的函数实现。delegatecall()。</em></p><figure class="ke kf kg kh fq ki"><div class="bz el l di"><div class="kj kk l"/></div></figure><blockquote class="kl"><p id="4039" class="km kn ht bd ko kp kq kr ks kt ku jn ek translated">因此，如果TradingWallet业务逻辑可以在幕后改变，那么可升级的智能合约怎么可能是不可变的和可信的呢？</p><p id="bbe4" class="km kn ht bd ko kp kv kw kx ky kz jn ek translated">放弃权力以支持其用户，即合同所有者。</p></blockquote><p id="f643" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">每次自动部署新的<em class="kd">交易平台</em>时，它将连接到特定用户，更具体地说，连接到用户的<em class="kd">外部拥有的账户</em>。<br/>因此合同业主可以:</p><ul class=""><li id="882a" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx dt translated">同意使用当前公共WalletLogicVx创建他/她的<em class="kd"> TradingWallet。</em></li><li id="01d9" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">管理他/她的资产；</li><li id="03ac" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx dt translated">然后可能同意他/她的<em class="kd"> TradingWallet </em>的<em class="kd"> current WalletLogicVx </em>的更新，可能会修复一些bug。</li></ul><p id="df61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可以想象，<em class="kd"> TradingWallet </em>的目的是管理ETH和令牌进行交易。<br/>ERC-20令牌是由通用接口定义的智能合约:</p><figure class="ke kf kg kh fq ki"><div class="bz el l di"><div class="kj kk l"/></div><figcaption class="lf lg fg fe ff lh li bd b be z ek"><a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-solidity" rel="noopener ugc nofollow" target="_blank">https://github.com/OpenZeppelin/openzeppelin-solidity</a></figcaption></figure><p id="043a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">不幸的是，有许多令牌不满足上面的接口。<br/>事实上，对于像<em class="kd">转移</em>或<em class="kd">转移自</em>函数<em class="kd">这样的关键函数来说，有很多令牌<strong class="is hu">不返回任何值</strong>。</em></p><p id="2b6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">很难理解用户<em class="kd">trading wallet</em><strong class="is hu">deposit</strong>函数调用是否真正成功。<br/>在更改任何其他EVM状态之前，确保转移成功的最常用方法是:</p><p id="c386" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="kd">要求(IERC20(_tokenAddress)。transferFrom(msg.sender，this，_amount)，…)；</em></p><p id="dd9f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是由于最近添加的<a class="ae jo" href="https://www.ethervm.io/#3D" rel="noopener ugc nofollow" target="_blank"><em class="kd">RETURNDATASIZE</em></a><em class="kd"/>操作码<em class="kd"> </em>和返回的数据大小比预期的短的坏令牌，上述<strong class="is hu"> <em class="kd">要求</em> </strong> <em class="kd"> </em>回复EVM状态转换，即使传输实际上会成功。</p><figure class="ke kf kg kh fq ki fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/20e315098e4437b75e880b5b584b1f99.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*YuT09GftwwkI-HVV3rzagQ.jpeg"/></div></figure><blockquote class="kl"><p id="1094" class="km kn ht bd ko kp kq kr ks kt ku jn ek translated">那么，我们如何在不中断服务的情况下处理这个问题呢？</p><p id="7e45" class="km kn ht bd ko kp kv kw kx ky kz jn ek translated">编写一些汇编，向我们的用户解释和建议TradingWallet的升级。</p></blockquote></div><div class="ab cl lm ln hb lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hm hn ho hp hq"><p id="a20b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你喜欢这篇文章，点击下面的 <strong class="is hu"> <em class="kd">推荐</em> </strong> <em class="kd">按钮会很棒，这意味着会有更多的人看到它。你也可以在</em> <a class="ae jo" href="https://twitter.com/andreafspeziale" rel="noopener ugc nofollow" target="_blank"> <em class="kd">推特</em> </a> <em class="kd">上找到我。谢谢！</em></p><blockquote class="kl"><p id="af4c" class="km kn ht bd ko kp kv kw kx ky kz jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="lu lv lw lx ly ki fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lt"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>