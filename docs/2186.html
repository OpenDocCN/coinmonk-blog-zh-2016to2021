<html>
<head>
<title>Coding Upgradable Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可升级智能合同编码</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/writing-upgradable-smartcontracts-883b3a3d29a3?source=collection_archive---------1-----------------------#2019-04-27">https://medium.com/coinmonks/writing-upgradable-smartcontracts-883b3a3d29a3?source=collection_archive---------1-----------------------#2019-04-27</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/3224b15e1a9ceb95e54929c402007962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b_Q_ioASgdfm-o3beLQGig.jpeg"/></div></div></figure><h2 id="1380" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">升级智能合同意味着什么？</h2><p id="33b1" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">作为开发人员，我们一直想升级我们的代码，引入新的特性，同时修复错误。谈到区块链，写在区块链身上的任何东西都是不可改变的。即使是智能合同，一旦在区块链网络上部署，我们也不能更改或修改它。在过去的几年里，我们已经看到了许多攻击，比如<strong class="kb hu"> DAO，再进入攻击，平价钱包黑客</strong>仅仅因为智能合同中的小漏洞就造成了数百万以太网的损失。<strong class="kb hu"> </strong>所以在部署之前对智能合同进行几十次测试对于避免这些漏洞非常重要。如果我们想为已部署的智能合同引入新功能呢？因为它甚至不可能与区块链，对不对？但不知何故，有一种方法可以升级我们的合同。怎么了？"一种没有实际升级的升级方式."似乎很有趣？是的，等我一下，你可能已经知道你的智能手机中的<strong class="kb hu">呼叫转移</strong>功能了，一旦你的移动号码和你的首选新号码的呼叫转移被激活，每个打到你的移动号码的呼叫都会被转移到你的首选移动号码。同样，可升级的合同也是有效的。您的旧合同处理数据，并将到达您的旧合同地址的每个函数调用重定向到新部署的合同ie..升级版的。</p><p id="cd8a" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">有充分的理由，gochain为升级合同提供了CLI协议。那你还在等什么？我们走吧。</p><p id="9ad8" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">在演示中，我将把简单的迎宾合同从v1升级到v2。在v1版本中，没有getter方法来返回问候语。在v2中，getter方法是作为bug修复或新特性添加的，无论您称其为什么。代码可用<a class="ae kz" href="https://github.com/Salmandabbakuti/Smartcontract-Upgrades" rel="noopener ugc nofollow" target="_blank">此处为</a>。</p><h2 id="7c9e" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">环境</h2><p id="9a0f" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">Ubuntu桌面，带有gochain web3库。</p><h2 id="012e" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">先决条件</h2><p id="88f3" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">1.gochain Web3库</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="7d6d" class="jb jc ht lf b fv lj lk l ll lm">curl -LSs https://raw.githubusercontent.com/gochain-io/web3/master/install.sh | sh</span></pre><p id="d3f2" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">2.Gochain钱包和一些GO-token。</p><p id="da1b" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">去<a class="ae kz" href="https://explorer.gochain.io/wallet/create" rel="noopener ugc nofollow" target="_blank">https://explorer.gochain.io/wallet/create</a>把你的私人钥匙存放在其他安全的地方。</p><p id="74cf" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">要在网络上进行任何操作，您都需要令牌。所以为了得到testnet令牌，加入他们的官方电报频道<a class="ae kz" href="https://t.me/gochain_testnet" rel="noopener ugc nofollow" target="_blank">https://t.me/gochain_testnet</a>并要求他们通过粘贴你之前创建的钱包地址**来提供一些testnet令牌</p><h1 id="c5f8" class="ln jc ht bd jd lo lp lq jh lr ls lt jl lu lv lw jp lx ly lz jt ma mb mc jx md dt translated">步伐</h1><h2 id="f15f" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">1.环境设置</h2><p id="41b7" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">a)。将私钥导出到您的Env。变量(需要根用户权限)</p><p id="44df" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><code class="eh me mf mg lf b">sudo -s</code></p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="b3a9" class="jb jc ht lf b fv lj lk l ll lm">export WEB3_PRIVATE_KEY=0x...</span></pre><p id="1811" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">通过这个命令检查您的私钥是否正确<code class="eh me mf mg lf b">$ web3 myaddress</code>如果这个命令返回您在先决条件中创建的钱包地址，那么您就可以开始了。</p><p id="fe83" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">b)。使用Go-Chain testnet</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="99f1" class="jb jc ht lf b fv lj lk l ll lm">$ export WEB3_NETWORK=testnet</span></pre><h2 id="d4ac" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">2.部署可升级合同</h2><p id="9801" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">a)。编制合同</p><p id="8226" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">将greeter.sol文件复制到您的目录中，然后</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="575d" class="jb jc ht lf b fv lj lk l ll lm">web3 contract build greeter.sol</span></pre><p id="c480" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">b)。部署合同</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="7a98" class="jb jc ht lf b fv lj lk l ll lm">web3 contract deploy --upgradeable greeter.bin</span></pre><p id="b155" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">部署后，您将获得合同地址，将该地址添加到env。变量</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="cf58" class="jb jc ht lf b fv lj lk l ll lm">export WEB3_ADDRESS=0x...</span></pre><p id="3681" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">部署可升级合同实际上部署了两个合同。原始迎宾合同和代理合同，将呼叫重定向到升级的合同。用这个命令检查我们代理契约重定向调用和存储的位置</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="587b" class="jb jc ht lf b fv lj lk l ll lm">web3 contract target</span></pre><p id="972b" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">c)。书写交易(问候语)</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="0f55" class="jb jc ht lf b fv lj lk l ll lm">web3 contract call --abi greeter.abi --function greet "Hi Guys, This is from Old Contract"</span></pre><p id="0a34" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">交易完成后，我们成功地在区块链上添加了问候语。但是，仍然没有返回附加问候的选项。这就是为什么我们试图用新代码升级合同。</p><h2 id="21be" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">3.升级合同</h2><p id="93cf" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">将greeterv2.sol复制到您的目录中，</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="1982" class="jb jc ht lf b fv lj lk l ll lm">web3 contract build greeterv2.sol<br/>web3 contract deploy greeter.bin</span></pre><p id="bbcf" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">一旦部署，它将返回新部署的合同地址。使用这个地址我们可以升级我们的旧合同<code class="eh me mf mg lf b">greeter</code>到<code class="eh me mf mg lf b">greeterv2.</code>运行下面的命令来完成最后一步</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="506e" class="jb jc ht lf b fv lj lk l ll lm">web3 contract upgrade --to 0x.... //add your newly deployed contract address here</span></pre><p id="6ead" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">现在，您可以使用相同的地址调用新合同。在旧契约中，变量没有getter函数，在新契约中，我们增加了getter函数<code class="eh me mf mg lf b">getGreeting</code>。现在您可以使用这个命令调用它。</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="2bfb" class="jb jc ht lf b fv lj lk l ll lm">web3 contract call --abi greeter.abi --function getGreeting</span><span id="e7ea" class="jb jc ht lf b fv mh lk l ll lm">&gt;Hi Guys, This is from Old Contract</span></pre><h2 id="2ad2" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">4.暂停和恢复合同</h2><p id="8dff" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">可升级合同还包括暂停和恢复执行的能力。如果您在契约中发现了任何bug，您可以使用这些命令简单地暂停(或稍后恢复)契约</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="1a34" class="jb jc ht lf b fv lj lk l ll lm">web3 contract pause<br/>web3 contract resume</span></pre><p id="d535" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">一旦暂停，如果你调用这个函数，你将得到<code class="eh me mf mg lf b">unmarshalling empty output</code>字符串，直到你恢复合同。</p><p id="3570" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">嘣…</p><blockquote class="mi"><p id="feaa" class="mj mk ht bd ml mm mn mo mp mq mr kt ek translated"><a class="ae kz" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mt mu mv mw mx iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ms"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>