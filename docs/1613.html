<html>
<head>
<title>Simplified code of Bitcoin Lightning Network — Spend Revocable Delivery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">比特币闪电网的简化代码——消费可撤销交付</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5?source=collection_archive---------6-----------------------#2018-10-06">https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5?source=collection_archive---------6-----------------------#2018-10-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="3cee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">雷电网络的基本概念很简单。为了进一步理解，参考<a class="ae jo" href="https://lightning.network/lightning-network-paper.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a>，将lightning网络交易流程表示为javascript代码。</p><p id="8f6d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我在一篇博文中解释所有的交易流程，会很难读懂。所以我分成几篇博文。这篇博文的目标是花费可撤销的交付，这对应于白皮书的图5。</p><p id="f16b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Github上的代码:<a class="ae jo" href="https://github.com/tak1827/lightning-network-tx-flow/tree/spend-RD" rel="noopener ugc nofollow" target="_blank">闪电网tx流</a></p><p id="aed7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下一篇:<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-part2-spend-breach-remedy-997de8a21f29">比特币闪电网络简化代码之二——消费违约补救</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/ff1c4918796d64220c5c207db29cc0ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R0M3JtLWrabw-HpdGoQusQ.png"/></div></div></figure></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="56e4" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">简化的块和交易结构</h2><p id="356d" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">真实的比特币很复杂，所以我尽量简化了。定义的块和事务结构如下。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="9c6a" class="ki kj ht lj b fv ln lo l lp lq">class Block {<br/>  constructor(hashPrev, txs) {<br/>    this.hashPrev = hashPrev;<br/>    this.txs = txs;<br/>  }<br/>}</span><span id="6606" class="ki kj ht lj b fv lr lo l lp lq">class Transaction {<br/>  constructor(txIns, txOuts) {<br/>    this.txIns = txIns;<br/>    this.txOuts = txOuts;<br/>  }<br/>}</span><span id="7eda" class="ki kj ht lj b fv lr lo l lp lq">class TxIn {<br/>  constructor(txPrev, index, scriptSig) {<br/>    this.txPrev = txPrev;<br/>    this.index = index;<br/>    this.scriptSig = scriptSig;<br/>  }<br/>}</span><span id="dd65" class="ki kj ht lj b fv lr lo l lp lq">class TxOut {<br/>  constructor(value, scriptPubKey) {<br/>    this.value = value;<br/>    this.scriptPubKey = scriptPubKey;<br/>  }<br/>}</span></pre><p id="937c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">块只包含以前散列和事务。同样，交易只包含输入和输出。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="72f8" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">花费可撤销交付的6个步骤</h2><p id="6c4b" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">我把可撤销交付的所有过程分为如下6个步骤。请注意，C1a或C1b等写在上面的图像。</p><ol class=""><li id="06ff" class="ls lt ht is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma dt translated"><em class="mb">多签名资助</em></li><li id="d7fe" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">建立C1a和C1b(无标志)</em></li><li id="40fd" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">构建RD1a和RD1b </em></li><li id="f5aa" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">C1a和C1b交换签名</em></li><li id="044f" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">花C1b </em></li><li id="5de4" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">花掉D1b </em></li><li id="1cd0" class="ls lt ht is b it mc ix md jb me jf mf jj mg jn lx ly lz ma dt translated"><em class="mb">花掉RD1b </em></li></ol></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="96fc" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">1.<em class="mh">多方签名资助</em></h2><p id="48e5" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">首先，Alice和Bob创建了2to2多重签名。这是不准确的，只是简化了一个。请参考<a class="ae jo" rel="noopener" href="/@t.tak/understand-how-bitcoin-multi-signature-work-by-javascript-18ed10f35941">我之前的博文</a>进一步了解。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="c4dd" class="ki kj ht lj b fv ln lo l lp lq">const redeemScript = { <br/>  n: 2, <br/>  m: 2, <br/>  pubKeyHashs: [ <br/>    getPubKeyHash(AliceKeys[1]), // Alice pubKeyHash<br/>    getPubKeyHash(BobKeys[1]) // Bob pubKeyHash<br/>  ]<br/>}</span><span id="248b" class="ki kj ht lj b fv lr lo l lp lq">const redeemScriptHash = CryptoJS.RIPEMD160(CryptoJS.SHA256(<br/>  JSON.stringify(redeemScript)<br/>)).toString();</span></pre><p id="a116" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">爱丽丝基金比特币到这个‘救赎脚本哈希’(这就像一个地址)。</p><p id="f7b2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">爱丽丝和鲍勃已经分别存入0.5比特币作为创世纪区块。于是，爱丽丝把这0.5个比特币用来资助mulisig。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="d93f" class="ki kj ht lj b fv ln lo l lp lq">// Create blockchain<br/>let Blocks = [genesis];</span><span id="1933" class="ki kj ht lj b fv lr lo l lp lq">const gTxH = calculateTxHash(Blocks[0].txs[0]);</span><span id="ceca" class="ki kj ht lj b fv lr lo l lp lq">// Create unsingned transaction<br/>let fundingTxAlice = new Transaction(<br/>  [<br/>    new TxIn(<br/>      gTxH,<br/>      0, <br/>      { <br/>        type: 'SINGLE', <br/>        sig: getPubKeyHash(AliceKeys[0]) // Place pubKeyHash for signing instead.<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'NORMAL', <br/>        pubKeyHash: redeemScriptHash <br/>      }<br/>    )<br/>  ]<br/>);</span><span id="eabd" class="ki kj ht lj b fv lr lo l lp lq">// Sign transaction by Alice wallet<br/>fundingTxAlice = signTx(fundingTxAlice, AliceKeys[0]);</span><span id="0f36" class="ki kj ht lj b fv lr lo l lp lq">// Create new Block as adding transactions<br/>const newBlock = createNewBlock(<br/>  [fundingTxAlice, fundingTxBob], <br/>  Blocks<br/>)</span><span id="4469" class="ki kj ht lj b fv lr lo l lp lq">// Mine block <br/>Blocks = mineBlock(Blocks, newBlock);</span></pre><p id="d833" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我不能运行比特币的操作码，所以我将scriptSig和scriptPubKey定义为json格式。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="2e1c" class="ki kj ht lj b fv ln lo l lp lq">scriptSig = { <br/>  type: 'SINGLE', <br/>  sig: {<br/>   signature: signature,<br/>   pubKey: pubKey<br/>  }<br/>}</span><span id="24e6" class="ki kj ht lj b fv lr lo l lp lq">scriptPubKey = { <br/>  type: 'NORMAL', <br/>  pubKeyHash: pubKeyHash<br/>}</span></pre><p id="246d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以同样的方式，鲍勃为multisig提供资金，因此multisig现在持有1个比特币</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="ef17" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="mh"> 2。建造C1a和C1b(无标志)</em></h2><p id="35c5" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">使用Alice和Bob之前创建的两个事务，Alice构建C1a。请注意，C1a开关类型的第一个输出是“RSMS”。确切的名称是可撤销序列到期合同。这需要2个签名才能消费。由此，可撤销交付将被创建。另一个输出是通常的输出。</p><p id="5e6b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这时，鲍勃不签字了。如果Bob签字，Alice可以立即花费这笔交易。在爱丽丝是恶意的且爱丽丝不签RD1a的情况下，鲍勃永远失去0.5个比特币，这样鲍勃就不应该签。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="7f6d" class="ki kj ht lj b fv ln lo l lp lq">const fTxAH = calculateTxHash(fundingTxAlice);<br/>const fTxBH = calculateTxHash(fundingTxBob);</span><span id="6615" class="ki kj ht lj b fv lr lo l lp lq">let C1a = new Transaction(<br/>  [<br/>    new TxIn(<br/>      fTxAH, <br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    ),<br/>    new TxIn(<br/>      fTxBH,<br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'RSMS',<br/>        pubKeyHash: [ <br/>          getPubKeyHash(AliceKeys[2]), <br/>          getPubKeyHash(BobKeys[2]) <br/>        ]<br/>      }<br/>    ),<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(BobKeys[2])<br/>      }<br/>    )<br/>  ]<br/>)</span></pre><p id="3b08" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Json formate scriptSig和scriptPubKey如下。请注意，我将赎回脚本包含在scriptSig中，以使用multisig基金。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="379e" class="ki kj ht lj b fv ln lo l lp lq">scriptSig =  { <br/>  type: 'MULTI',<br/>  sig: [ <br/>     {<br/>      signature: signature,<br/>      pubKey: pubKey1 <br/>     },<br/>     {<br/>      signature: signature,<br/>      pubKey: pubKey2<br/>     }     <br/>  ],<br/>  redeemScript: redeemScript<br/>}</span><span id="1cd5" class="ki kj ht lj b fv lr lo l lp lq">scriptPubKey = { <br/>  type: 'RSMS',<br/>  pubKeyHash: [ <br/>    pubKeyHash1,<br/>    pubKeyHash2,<br/>  ]<br/>}</span></pre><p id="659d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">用同样的方法，Bob构建C1b。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="fd91" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="mh"> 3。建造RD1a和RD1b </em></h2><p id="4221" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">RD1a有时间锁定。如果爱丽丝花了C1a，爱丽丝不能收到0.5比特币，直到时间锁定期结束。我将时间锁定指定为3，这样Alice需要等待3个块确认。另一方面鲍勃可以立即收到0.5个比特币，因为D1a没有时间锁。</p><p id="1f72" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">顺便说一下，时间锁在实际用例中可能是1000。</p><p id="caa8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请不要忘记TxIn中的前一笔交易是空的。因为C1a还没有消费，所以不可能计算交易散列。为了实现这一点，lightning开发团队倡导新的操作码为<code class="eh mi mj mk lj b">SIGHASH_NOINPUT</code></p><p id="ff4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请不要忘记RD1a是由鲍勃签署的。Alice需要将RD1a交给Bob并让他签字，这样RD1a就需要Bob签字才能消费。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="dfe7" class="ki kj ht lj b fv ln lo l lp lq">let RD1a = new Transaction(<br/>  [<br/>    new TxIn(<br/>      '', // Keep empty because C1a have not yet spent<br/>      0, <br/>      { <br/>        type: 'RD',<br/>        sig: [ <br/>          getPubKeyHash(AliceKeys[2]), <br/>          getPubKeyHash(BobKeys[2]) <br/>        ],<br/>        sequence: 3<br/>      }<br/>    ),<br/>  ],<br/>  [<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(AliceKeys[3])<br/>      }<br/>    )<br/>  ]<br/>);</span><span id="2182" class="ki kj ht lj b fv lr lo l lp lq">// Hand over RD1a to Bob and let him sign<br/>RD1a = signTx(RD1a, BobKeys[2]);</span></pre><p id="0c79" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Json formate RD scriptSig如下。这包含时间锁定。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="9af1" class="ki kj ht lj b fv ln lo l lp lq">scriptSig = { <br/>  type: 'RD',<br/>  sig: [ <br/>    {<br/>    signature: signature,<br/>    pubKey: pubKey1 <br/>   },<br/>   {<br/>    signature: signature,<br/>    pubKey: pubKey2<br/>   }<br/>  ],<br/>  sequence: 3<br/>}</span></pre><p id="cff6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">用同样的方法，Bob构建RD1b。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="3ff6" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">4.C1a和C1b的交换签名</h2><p id="e573" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">Alice收到Bob签名的RD1a，因此是时候交换C1a的签名了。爱丽丝把C1a交给鲍勃，让他签字。现在，爱丽丝可以随时消费C1a。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="230a" class="ki kj ht lj b fv ln lo l lp lq">C1a = signTx(C1a, BobKeys[1]);</span></pre><p id="53fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">同样的，鲍勃让爱丽丝签C1b。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="5abb" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">5.花费C1b</h2><p id="095d" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">让我们来考虑一下Bob spend C1b的案例。鲍勃自己签C1b。验证后，Bob转移C1b并添加到区块链。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="cdb9" class="ki kj ht lj b fv ln lo l lp lq">// Sign by himself(Bob)<br/>C1b = signTx(C1b, BobKeys[1]);</span><span id="a584" class="ki kj ht lj b fv lr lo l lp lq">// Validate transaction<br/>validateTx(C1b, Blocks);</span><span id="6956" class="ki kj ht lj b fv lr lo l lp lq">// Mine block as adding transactions<br/>Blocks = mineBlock(Blocks, createNewBlock([C1b], Blocks));</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="6eee" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">6.花费D1b</h2><p id="fbc7" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">爱丽丝可以在没有任何时间锁定的情况下花费D1b，因为multisig资助的比特币被鲍勃作为C1b交易花费。如果Bob是恶意的，不与Alice合作，Bob可能会在没有Alice同意的情况下消费C1b。在这种情况下，鲍勃承担时间锁。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="0f2e" class="ki kj ht lj b fv ln lo l lp lq">const hashC1b = calculateTxHash(C1b);</span><span id="cd70" class="ki kj ht lj b fv lr lo l lp lq">let D1b = new Transaction(<br/>  [<br/>    new TxIn(<br/>      hashC1b, <br/>      0, <br/>      { <br/>        type: 'SINGLE',<br/>        sig: [ getPubKeyHash(AliceKeys[2]) ],<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      50000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(AliceKeys[3])<br/>      }<br/>    )<br/>  ]<br/>)</span><span id="67ff" class="ki kj ht lj b fv lr lo l lp lq">D1b = signTx(D1b, AliceKeys[2]);</span><span id="bac0" class="ki kj ht lj b fv lr lo l lp lq">validateTx(D1b, Blocks);</span><span id="bac1" class="ki kj ht lj b fv lr lo l lp lq">Blocks = mineBlock(Blocks, createNewBlock([D1b], Blocks));</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="052e" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">7.花费10亿元人民币</h2><p id="d313" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">起初，Bob试图立即花掉RD1b。但结果是失败的，因为时间锁定。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="e05f" class="ki kj ht lj b fv ln lo l lp lq">// Set previous transaction hash to txIn<br/>RD1b.txIns[0].txPrev = calculateTxHash(C1b);</span><span id="d171" class="ki kj ht lj b fv lr lo l lp lq">RD1b = signTx(RD1b, BobKeys[2]);</span><span id="1d09" class="ki kj ht lj b fv lr lo l lp lq">validateTx(RD1b, Blocks); // =&gt; Fail, because of block time lock</span></pre><p id="b254" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">添加2块后，Bob可以成功使用RD1b，因为时间锁已经过期。</p><pre class="jq jr js jt fq li lj lk ll aw lm dt"><span id="9418" class="ki kj ht lj b fv ln lo l lp lq">// Set previous transaction hash to txIn<br/>RD1b.txIns[0].txPrev = calculateTxHash(C1b);</span><span id="7c77" class="ki kj ht lj b fv lr lo l lp lq">RD1b = signTx(RD1b, BobKeys[2]);</span><span id="5195" class="ki kj ht lj b fv lr lo l lp lq">// Add 2 blocks for time lock<br/>Blocks = mineBlock(Blocks, createNewBlock([], Blocks));<br/>Blocks = mineBlock(Blocks, createNewBlock([], Blocks));</span><span id="9abb" class="ki kj ht lj b fv lr lo l lp lq">validateTx(RD1b, Blocks); // =&gt; Success, because time lock expire</span><span id="7f0c" class="ki kj ht lj b fv lr lo l lp lq">Blocks = mineBlock(Blocks, createNewBlock([RD1b], Blocks));</span></pre><blockquote class="ml"><p id="acda" class="mm mn ht bd mo mp mq mr ms mt mu jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="mw mx my mz na ju fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mv"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>