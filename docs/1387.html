<html>
<head>
<title>Ethernaut Lvl 8 Vault Walkthrough — How to read “private” variables in contract storage (with Truffle)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 8 Vault演练—如何读取契约存储中的“私有”变量(使用Truffle)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f?source=collection_archive---------2-----------------------#2018-08-24">https://medium.com/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f?source=collection_archive---------2-----------------------#2018-08-24</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一个围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank">齐柏林</a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>的<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在这一关，我们学习用松露控制台读取契约存储，用“私人”存储的密码打开保险库。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="e27d" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">以太坊存储的工作原理</h1><p id="d67c" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">在以太坊中，编程可以有两种不同的含义:</p><ol class=""><li id="bad8" class="ln lo ht jl b jm jn jp jq js lp jw lq ka lr ke ls lt lu lv dt translated">以太坊如何在区块链上存储合同数据，以及</li><li id="27d5" class="ln lo ht jl b jm lw jp lx js ly jw lz ka ma ke ls lt lu lv dt translated">Solidity如何存储全局和局部变量。</li></ol><p id="56b6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在本帖中，我们将深入探讨以太坊如何在区块链上存储数据。</p><blockquote class="mb"><p id="40b5" class="mc md ht bd me mf mg mh mi mj mk ke ek translated"><strong class="ak">以太坊区块链上的存储</strong>为2个⁵⁶槽，每个槽为32字节。</p></blockquote><p id="03af" class="pw-post-body-paragraph jj jk ht jl b jm ml iu jo jp mm ix jr js mn ju jv jw mo jy jz ka mp kc kd ke hm dt translated">每个智能合约都有自己的存储来反映合约的状态。存储中的值在不同的函数调用中保持不变。每个存储都绑定到智能合约的地址。</p><h2 id="79f2" class="mq kn ht bd ko mr ms mt ks mu mv mw kw js mx my ky jw mz na la ka nb nc lc nd dt translated">数据的物理存储方式</h2><p id="9ee9" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">数据按照声明的顺序存储在这些槽中。</p><p id="d097" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">存储经过优化以节省字节空间。因此，如果顺序变量适合一个32字节的槽，它们将共享同一个槽，从最低有效位开始索引(从右边开始)。</p><p id="d543" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">以太坊储物和空间优化的形象化展示:</p><figure class="nf ng nh ni fq nj fe ff paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="fe ff ne"><img src="../Images/74e628c6b6d38d6b0b8bed2e5a32e553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wY8Si-mt_QZWqg0jnEDw8A.jpeg"/></div></div><figcaption class="nq nr fg fe ff ns nt bd b be z ek">Notice that bool and uint16 share slot 0, indicating this contract also costs less gas to instantiate!</figcaption></figure><h2 id="d393" class="mq kn ht bd ko mr ms mt ks mu mv mw kw js mx my ky jw mz na la ka nb nc lc nd dt translated">访问存储</h2><p id="d787" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">方便地，<a class="ae ji" href="https://github.com/ethereum/web3.js/" rel="noopener ugc nofollow" target="_blank"> Web3 </a>允许您通过<code class="eh lj lk ll lm b">web3.eth.getStorageAt(contractAddress, slotNumber)</code>进入合同仓库</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">详细演练</h1><figure class="nf ng nh ni fq nj fe ff paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="fe ff nu"><img src="../Images/f2222c69a58013659d5fc9c836297165.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CnKAXaI5WL1bA40MCvtsYg.png"/></div></div></figure><h2 id="1d59" class="mq kn ht bd ko mr ms mt ks mu mv mw kw js mx my ky jw mz na la ka nb nc lc nd dt translated"><strong class="ak">等级设置</strong></h2><ol class=""><li id="0529" class="ln lo ht jl b jm le jp lf js nv jw nw ka nx ke ls lt lu lv dt translated">请注意，您不能使用实时合同单步调试Remix调试器。所以让我们使用一个更强大的工具来与这个契约进行交互。遵循这个<a class="ae ji" rel="noopener" href="/coinmonks/5-minute-guide-to-deploying-smart-contracts-with-truffle-and-ropsten-b3e30d5ee1e"> 8分钟Truffle &amp; Ropsten教程</a>来熟悉使用Truffle框架与合同交互。</li></ol><h2 id="ecd2" class="mq kn ht bd ko mr ms mt ks mu mv mw kw js mx my ky jw mz na la ka nb nc lc nd dt translated">解决办法</h2><p id="e069" class="pw-post-body-paragraph jj jk ht jl b jm le iu jo jp lf ix jr js lg ju jv jw lh jy jz ka li kc kd ke hm dt translated">2.编译你的<code class="eh lj lk ll lm b">Vault.sol</code>合同，获得当地的ABI。你可以只部署到本地网络——只要确保<a class="ae ji" href="https://truffleframework.com/ganache" rel="noopener ugc nofollow" target="_blank"> Ganache </a>是打开的:</p><pre class="nf ng nh ni fq ny lm nz oa aw ob dt"><span id="fd7e" class="mq kn ht lm b fv oc od l oe of">truffle deploy   // auto compiles and deploys to local network</span></pre><p id="63a6" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">EVM会将编译后的契约保存在/build中。</p><p id="44c1" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.打开truffle控制台，进行Ropsten:</p><pre class="nf ng nh ni fq ny lm nz oa aw ob dt"><span id="63f8" class="mq kn ht lm b fv oc od l oe of">truffle console --network Ropsten</span></pre><p id="6aae" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.注意“私人”密码存储在<code class="eh lj lk ll lm b">index 1</code>的<code class="eh lj lk ll lm b">slot 2</code>中</p><p id="4670" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">通过以下方式访问索引1处属于合同实例(由Ethernaut部署)的存储槽:</p><pre class="nf ng nh ni fq ny lm nz oa aw ob dt"><span id="0a2d" class="mq kn ht lm b fv oc od l oe of">web3.eth.getStorageAt(instance.address, 1, (err,res)=&gt;{console.log(res)});</span></pre><blockquote class="og oh oi"><p id="dfaa" class="jj jk oj jl b jm jn iu jo jp jq ix jr ok jt ju jv ol jx jy jz om kb kc kd ke hm dt translated">N <!-- -->注:getStorageAt返回一个承诺。</p></blockquote><p id="a260" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">5.使用十六进制到字符串的转换器，或者<code class="eh lj lk ll lm b">web3.utils.hexToAscii</code>辅助函数将bytes32变量转换成人类可读的文本，这显示了<code class="eh lj lk ll lm b">“A very strong secret password :)”</code></p><p id="b77e" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">6.<code class="eh lj lk ll lm b">unlock()</code>你与<code class="eh lj lk ll lm b">bytes32 private password</code>的合同</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">关键安全要点</h1><ul class=""><li id="4c7e" class="ln lo ht jl b jm le jp lf js nv jw nw ka nx ke on lt lu lv dt translated">所有的存储在区块链上都是公开可见的，甚至是你的<code class="eh lj lk ll lm b">private</code>变量！</li><li id="3fb1" class="ln lo ht jl b jm lw jp lx js ly jw lz ka ma ke on lt lu lv dt translated">不要在没有散列的情况下存储密码和私钥</li><li id="b45f" class="ln lo ht jl b jm lw jp lx js ly jw lz ka ma ke on lt lu lv dt translated">当使用带有存储变量的契约的<a class="ae ji" rel="noopener" href="/coinmonks/ethernaut-lvl-7-walkthrough-how-to-selfdestruct-and-create-an-ether-blackhole-eb5bb72d2c57"> delegatecall </a>时，要小心数据损坏。</li></ul><h1 id="fd2d" class="km kn ht bd ko kp oo kr ks kt op kv kw iz oq ja ky jc or jd la jf os jg lc ld dt translated">更多级别</h1><div class="ot ou fm fo ov ow"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-7-walkthrough-how-to-selfdestruct-and-create-an-ether-blackhole-eb5bb72d2c57"><div class="ox ab ej"><div class="oy ab oz cl cj pa"><h2 class="bd hu fv z el pb eo ep pc er et hs dt translated">以太吕7部队演练-如何自毁和创造一个以太黑洞</h2><div class="pd l"><h3 class="bd b fv z el pb eo ep pc er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pe l"><p class="bd b gc z el pb eo ep pc er et ek translated">medium.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk no ow"/></div></div></a></div><div class="ot ou fm fo ov ow"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-9-king-walkthrough-how-bad-contracts-can-abuse-withdrawals-db12754f359b"><div class="ox ab ej"><div class="oy ab oz cl cj pa"><h2 class="bd hu fv z el pb eo ep pc er et hs dt translated">以太者Lvl 9国王演练:如何糟糕的合同可以滥用提款</h2><div class="pd l"><h3 class="bd b fv z el pb eo ep pc er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pe l"><p class="bd b gc z el pb eo ep pc er et ek translated">medium.com</p></div></div><div class="pf l"><div class="pl l ph pi pj pf pk no ow"/></div></div></a></div><blockquote class="mb"><p id="f7e8" class="mc md ht bd me mf pm pn po pp pq ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="ps pt pu pv pw nj fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff pr"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>