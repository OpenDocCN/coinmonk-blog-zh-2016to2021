<html>
<head>
<title>React Web Dapp with MetaMask Web3 — SoTP Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用MetaMask Web3反应Web Dapp—SoTP第4部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/react-web-dapp-with-metamask-web3-sotp-part-4-f252ebe8d07f?source=collection_archive---------0-----------------------#2018-05-24">https://medium.com/coinmonks/react-web-dapp-with-metamask-web3-sotp-part-4-f252ebe8d07f?source=collection_archive---------0-----------------------#2018-05-24</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/6e5fdf44dbde393d53f1103aa5be1aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vy7xy94cN5weOsBMqeO0_A.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek"><a class="ae jf" href="http://34.210.217.34/" rel="noopener ugc nofollow" target="_blank">Dapp demo</a></figcaption></figure><p id="7d2c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">到目前为止，我们<a class="ae jf" rel="noopener" href="/@jozhe/learn-solidity-shark-of-the-pool-part-1-ac0f733eecdd">创建了可靠性合同</a> , <a class="ae jf" rel="noopener" href="/@jozhe/testing-solidity-dapp-sotp-part-2-9685b3375aaf">测试了合同</a>,<a class="ae jf" rel="noopener" href="/@jozhe/node-js-backend-service-for-ethereum-dapp-sotp-part-3-2d3aa5ec50e9">创建了后端来支持我们的Dapp </a>。在这一部分中，我们将在此基础上使用<a class="ae jf" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu"> React </strong> </a>和<a class="ae jf" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu"> Redux </strong> </a>库创建一个Web应用程序。</p><p id="0c67" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">关于<strong class="ji hu">如何反应</strong>和<strong class="ji hu"> Redux </strong>如何工作，我就不赘述了。相反，我将把重点放在Web应用程序的区块链特定部分。然而所有的源代码都可以在Github库中找到。</p><h2 id="6802" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">TL；速度三角形定位法(dead reckoning)</h2><p id="b65a" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">在<a class="ae jf" href="http://34.210.217.34/" rel="noopener ugc nofollow" target="_blank">这个链接</a>上查看<strong class="ji hu"> Ropsten网络</strong>上的Dapp演示。而源代码在<a class="ae jf" href="https://github.com/joze144/pool-shark-web" rel="noopener ugc nofollow" target="_blank">这个Github库</a>里。</p><p id="6c6e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">重要提示:</strong>演示正在<strong class="ji hu"> Ropsten </strong>网络上运行，因此请确保在<a class="ae jf" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu">元掩码</strong> </a>中选择<strong class="ji hu"> Ropsten </strong>网络。在主网络上进行交易可能会导致<strong class="ji hu">ETH丢失！</strong></p><p id="7c89" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">加入我们:<a class="ae jf" href="https://solidity_devs.select.id/bjxx" rel="noopener ugc nofollow" target="_blank"> Solidity开发社区，了解更多信息</a></p><h1 id="3552" class="le kf ht bd kg lf lg lh kk li lj lk ko ll lm ln kr lo lp lq ku lr ls lt kx lu dt translated">Web应用程序的目标</h1><p id="b763" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">我们希望用户能够轻松地与我们的合同互动。用户必须能够创建池，发送以太网到池中，转移奖励点，看看谁是鲨鱼和其他令牌持有者。</p><p id="9fbf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们还想从<a class="ae jf" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu">元掩码</strong> </a>扩展中检测帐户，并只呈现用户特定的数据。</p><p id="d22e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">与用户交互相比，区块链速度较慢，我们不希望用户坐着等待确认。这意味着实现事务队列并使用户能够在Web应用程序中或使用类似<a class="ae jf" href="https://etherscan.io/" rel="noopener ugc nofollow" target="_blank"> Etherscan </a>的工具查看事务状态至关重要。</p><h1 id="e2b2" class="le kf ht bd kg lf lg lh kk li lj lk ko ll lm ln kr lo lp lq ku lr ls lt kx lu dt translated">所需工具</h1><p id="8495" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">我们需要很多技术来实现这一点:</p><ul class=""><li id="c4cb" class="lv lw ht ji b jj jk jn jo jr lx jv ly jz lz kd ma mb mc md dt translated"><strong class="ji hu"> React和Redux </strong> —构建Web应用的流行Javascript库</li><li id="1a7d" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><strong class="ji hu">web pack</strong>——负责模块、依赖和构建过程</li><li id="c157" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><strong class="ji hu"> MetaMask </strong> — <strong class="ji hu"> web3 </strong>交易签约提供方及扩展</li></ul><p id="2dbf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">向帮助我构建这个Dapp的一些存储库大声呼喊:</p><ul class=""><li id="b678" class="lv lw ht ji b jj jk jn jo jr lx jv ly jz lz kd ma mb mc md dt translated"><a class="ae jf" href="https://github.com/drminnaar/react-redux-starter" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu"> React、Redux和Webpack入门库。</strong></a></li><li id="a1e6" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" href="https://github.com/coopermaruyama/react-web3" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu"> Web3检测和好看的svg图片库</strong> </a> <strong class="ji hu">。</strong>我已经在Redux 中加入了状态操作，但这是一个很好的起点(而且我真的很喜欢这个图形)。</li></ul><h1 id="4726" class="le kf ht bd kg lf lg lh kk li lj lk ko ll lm ln kr lo lp lq ku lr ls lt kx lu dt translated">Web3库</h1><p id="79f1" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">你想要做的是依靠用户提供一个外部的<strong class="ji hu"> web3 </strong>提供者。<strong class="ji hu"> package.json </strong>中没有<strong class="ji hu"> web3 </strong>依赖关系。在我的例子中，我强制用户安装<strong class="ji hu">元掩码</strong>，它负责<strong class="ji hu"> web3 </strong>注入、签署事务和连接到正确的节点。我要做的是监控它是否连接到正确的网络，并解析用户的公共地址以进行用户管理。</p><h2 id="e2df" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">检查web3状态</h2><p id="3b11" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">我们需要<strong class="ji hu"> web3 </strong>状态、连接的区块链网络以及应用程序中几乎所有地方的用户地址。我已经创建了定期获取帐户和网络的组件。并且<strong class="ji hu"> Redux </strong>使得将状态映射到需要检查它的组件变得容易。</p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="1b18" class="ke kf ht mo b fv ms mt l mu mv"><strong class="mo hu">const </strong>ONE_SECOND = 1000;<br/><strong class="mo hu">const </strong>ONE_MINUTE = ONE_SECOND * 60;<br/><strong class="mo hu">class </strong>Web3Provider <strong class="mo hu">extends </strong>Component {<br/>  constructor(props) {<br/>    <strong class="mo hu">super</strong>(props);<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchAccounts</strong>();<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchNetwork</strong>();<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">interval </strong>= <strong class="mo hu">null</strong>;<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">networkInterval </strong>= <strong class="mo hu">null</strong>;<br/>  }<br/><br/>  <em class="mw">/**<br/>   * Start polling accounts, &amp; network. We poll indefinitely so that we can<br/>   * react to the user changing accounts or networks.<br/>   */<br/>  </em>componentDidMount() {<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchAccounts</strong>();<br/>    <strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchNetwork</strong>();<br/>    <strong class="mo hu">this</strong>.initPoll();<br/>    <strong class="mo hu">this</strong>.initNetworkPoll();<br/>  }<br/><br/>  <em class="mw">/**<br/>   * Init Web3/account polling, and prevent duplicate interval.<br/>   * </em><strong class="mo hu"><em class="mw">@return </em></strong><em class="mw">{void}<br/>   */<br/>  </em>initPoll() {<br/>    <strong class="mo hu">if </strong>(!<strong class="mo hu">this</strong>.<strong class="mo hu">interval</strong>) {<br/>      <strong class="mo hu">this</strong>.<strong class="mo hu">interval </strong>= setInterval(<strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchAccounts</strong>, ONE_SECOND);<br/>    }<br/>  }<br/><br/>  <em class="mw">/**<br/>   * Init network polling, and prevent duplicate intervals.<br/>   * </em><strong class="mo hu"><em class="mw">@return </em></strong><em class="mw">{void}<br/>   */<br/>  </em>initNetworkPoll() {<br/>    <strong class="mo hu">if </strong>(!<strong class="mo hu">this</strong>.<strong class="mo hu">networkInterval</strong>) {<br/>      <strong class="mo hu">this</strong>.<strong class="mo hu">networkInterval </strong>= setInterval(<strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">fetchNetwork</strong>, ONE_MINUTE);<br/>    }<br/>  }<br/><br/>  render() {<br/>    <strong class="mo hu">return null</strong>;<br/>  }<br/>}</span><span id="67ce" class="ke kf ht mo b fv mx mt l mu mv"><strong class="mo hu">const </strong><em class="mw">mapStateToProps </em>= state =&gt; {<br/>  <strong class="mo hu">const </strong>{ accounts_fetched, account_exists, account_selected, accounts } = state.<strong class="mo hu">accounts</strong>;<br/>  <strong class="mo hu">const </strong>{ network_fetched, network_id } = state.<strong class="mo hu">network</strong>;<br/><br/>  <strong class="mo hu">return </strong>{ accounts_fetched, account_exists, accounts, account_selected, network_fetched, network_id };<br/>};<br/><br/><strong class="mo hu">const </strong><em class="mw">mapDispatchToProps </em>= dispatch =&gt; (<br/>  <em class="mw">bindActionCreators</em>({ <em class="mw">fetchAccounts</em>, <em class="mw">fetchNetwork </em>}, dispatch)<br/>);<br/><br/><strong class="mo hu">const </strong>hoc = <strong class="mo hu">connect</strong>(<em class="mw">mapStateToProps</em>, <em class="mw">mapDispatchToProps</em>)(Web3Provider);<br/><br/><em class="mw">// EXPORT COMPONENT<br/><br/></em><strong class="mo hu">export </strong>{ hoc as Web3Provider };</span></pre><p id="657c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们调用了两个函数，<strong class="ji hu"> fetchAccounts() </strong>和<strong class="ji hu"> fetchNetwork() </strong>。它们通过<strong class="ji hu"> Redux </strong>更新全局状态，在需要地址和网络信息的组件中很容易使用。你只需要在其他组件的<strong class="ji hu"> mapStateToProps() </strong>函数<strong class="ji hu"> </strong>函数中添加<strong class="ji hu"> state.accounts </strong>和<strong class="ji hu"> state.network </strong>即可。</p><p id="d040" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> fetchAccounts() </strong>和<strong class="ji hu"> fetchNetwork()的实现。</strong></p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="5ffb" class="ke kf ht mo b fv ms mt l mu mv"><strong class="mo hu">import </strong>isEmpty <strong class="mo hu">from 'lodash/isEmpty'</strong>;<br/><br/><strong class="mo hu">export const </strong><em class="mw">fetchNetwork </em>= () =&gt; {<br/>  <strong class="mo hu">return new </strong>Promise((resolve, reject) =&gt; {<br/>    <strong class="mo hu">const </strong>{ web3 } = <strong class="mo hu">window</strong>;<br/><br/>    web3 &amp;&amp; web3.<strong class="mo hu">version </strong>&amp;&amp; web3.<strong class="mo hu">version</strong>.getNetwork((err, netId) =&gt; {<br/>      <strong class="mo hu">if </strong>(err) {<br/>        reject(err);<br/>      } <strong class="mo hu">else </strong>{<br/>        resolve(netId);<br/>      }<br/>    });<br/>  });<br/>};<br/><br/><strong class="mo hu">export const </strong><em class="mw">fetchAccounts </em>= () =&gt; {<br/>  <strong class="mo hu">return new </strong>Promise((resolve, reject) =&gt; {<br/>    <strong class="mo hu">const </strong>{ web3 } = <strong class="mo hu">window</strong>;<br/>    <strong class="mo hu">const </strong>ethAccounts = <em class="mw">getAccounts</em>();<br/><br/>    <strong class="mo hu">if </strong>(isEmpty(ethAccounts)) {<br/>      web3 &amp;&amp; web3.<strong class="mo hu">eth </strong>&amp;&amp; web3.<strong class="mo hu">eth</strong>.getAccounts((err, accounts) =&gt; {<br/>        <strong class="mo hu">if </strong>(err) {<br/>          reject(err);<br/>        } <strong class="mo hu">else </strong>{<br/>          resolve(accounts);<br/>        }<br/>      });<br/>    } <strong class="mo hu">else </strong>{<br/>      resolve(ethAccounts);<br/>    }<br/>  });<br/>};<br/><br/><strong class="mo hu">function </strong><em class="mw">getAccounts</em>() {<br/>  <strong class="mo hu">try </strong>{<br/>    <strong class="mo hu">const </strong>{ web3 } = <strong class="mo hu">window</strong>;<br/>    <em class="mw">// throws if no account selected<br/>    </em><strong class="mo hu">return </strong>web3.<strong class="mo hu">eth</strong>.<strong class="mo hu">accounts</strong>;<br/>  } <strong class="mo hu">catch </strong>(e) {<br/>    <strong class="mo hu">return </strong>[];<br/>  }</span></pre><p id="e0a7" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu"> Web3 </strong>依赖从<strong class="ji hu">元掩码</strong>注入，可以通过<strong class="ji hu"> window.web3 </strong>访问。您可以使用<strong class="ji hu">web 3 . current provider . is meta mask</strong>实际检查提供者是否确实是<strong class="ji hu">元掩码</strong>。我目前在创建交易时会检查这一点。然而，还有其他提供者，如奇偶校验提供者，将来也应该支持它们。除此之外，代码非常简单，就像使用自己的<strong class="ji hu"> web3 </strong>提供者一样。</p><p id="f5ad" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了让它与<strong class="ji hu"> Redux </strong>一起工作，你需要创建<strong class="ji hu"> Redux </strong>存储和减速器，但这是<strong class="ji hu"> Redux </strong>存储操作的标准。</p><p id="8361" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">检查另一个组件中的Web3 状态现在变得超级简单。</p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="bc68" class="ke kf ht mo b fv ms mt l mu mv"><strong class="mo hu">if </strong>(isEmpty(<strong class="mo hu">this</strong>.<strong class="mo hu">props</strong>.<strong class="mo hu">accounts</strong>)) {<br/>  failed = <strong class="mo hu">true</strong>;<br/>  error = &lt;<strong class="mo hu">AccountUnavailable</strong>/&gt;;<br/>}<br/><br/><strong class="mo hu">return </strong>(<br/>  &lt;<strong class="mo hu">div</strong>&gt;<br/>      {<br/>        failed &amp;&amp; error<br/>      }<br/>  &lt;/<strong class="mo hu">div</strong>&gt;<br/>)</span></pre><p id="7715" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果没有帐户映射到组件的<strong class="ji hu">属性</strong>，这将导致<strong class="ji hu">帐户不可用</strong>组件。我还会检查连接的网络是否不正确，<strong class="ji hu"> web3 </strong>提供程序是否不受支持，或者是否没有<strong class="ji hu"> web3 </strong>提供程序。</p><h2 id="31c4" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated"><strong class="ak">公钥地址解析</strong></h2><p id="28db" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">用户正在使用的钱包中的公钥可作为注入的<strong class="ji hu"> web3 </strong>中的<strong class="ji hu"> accounts </strong>数组中的第一个元素，或者作为<strong class="ji hu"> account_selected </strong>变量中的第一个元素。您可以在整个应用程序中使用它来识别用户并向他显示与用户相关的内容。</p><p id="9bb8" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">提供的公钥总是小写。我觉得这一点很重要，因为从事件数据中解析的地址不是，这可能是你对后端的请求失败的原因。我通过在Mongo Db 中需要的列上添加<a class="ae jf" href="https://docs.mongodb.com/manual/core/index-case-insensitive/" rel="noopener ugc nofollow" target="_blank">排序索引解决了这个问题。</a></p><p id="d584" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">向区块链进行交易时，地址不区分大小写。这意味着你可以通过存储和匹配所有的小写或大写字母来逃脱。但我认为，如果用户界面上显示的地址保持不变，看起来会更好、更专业。</p><h2 id="6883" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">使用元掩码发送事务</h2><p id="dc6f" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">使用元掩码发送事务类似于使用自己的web3依赖项。这里可以看到<strong class="ji hu">depositopool()</strong>函数的实现</p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="a4db" class="ke kf ht mo b fv ms mt l mu mv"><strong class="mo hu">export const </strong><em class="mw">depositToPool </em>= (pool, ethAmount) =&gt; {<br/>  <strong class="mo hu">return new </strong>Promise((resolve, reject) =&gt; {<br/>    <strong class="mo hu">const </strong>web3 = <strong class="mo hu">window</strong>.web3;<br/>    <strong class="mo hu">const </strong>poolAddress = pool;<br/>    <strong class="mo hu">const </strong>amountWei = web3.toWei(ethAmount, <strong class="mo hu">'ether'</strong>);<br/><br/>    <strong class="mo hu">if </strong>(!web3 || !web3.isConnected() || !web3.currentProvider.isMetaMask) {<br/>      reject(<strong class="mo hu">'No web3!'</strong>);<br/>    }<br/>    <strong class="mo hu">const </strong>account = web3.<strong class="mo hu">eth</strong>.<strong class="mo hu">accounts</strong>[0];<br/>    <strong class="mo hu">if </strong>(!account) {<br/>      reject(<strong class="mo hu">'No account!'</strong>);<br/>    }<br/><br/>    web3.<strong class="mo hu">eth</strong>.getTransactionCount(account, (error, txCount) =&gt; {<br/>      <strong class="mo hu">if </strong>(error) {<br/>        reject(error);<br/>      }<br/>      web3.<strong class="mo hu">eth</strong>.sendTransaction({<br/>        <strong class="mo hu">nonce</strong>: txCount,<br/>        <strong class="mo hu">from</strong>: account,<br/>        <strong class="mo hu">to</strong>: poolAddress,<br/>        <strong class="mo hu">value</strong>: amountWei<br/>      }, (err, transactionId) =&gt; {<br/>        <strong class="mo hu">if </strong>(err) {<br/>          reject(error);<br/>        } <strong class="mo hu">else </strong>{<br/>          axios.post(<strong class="mo hu">api_service_url </strong>+ <strong class="mo hu">'/transaction/create'</strong>, {<br/>            <strong class="mo hu">address</strong>: account,<br/>            <strong class="mo hu">transaction_id</strong>: transactionId,<br/>            <strong class="mo hu">transaction_type</strong>: <strong class="mo hu">'Deposit'<br/>          </strong>}).then(() =&gt; {<br/>            resolve(transactionId);<br/>          }).catch((err) =&gt; {<br/>            reject(err);<br/>          });<br/>        }<br/>      });<br/>    });<br/>  });<br/>};</span></pre><p id="28e4" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我现在只允许<strong class="ji hu">元掩码</strong>提供程序。<strong class="ji hu">元掩码</strong>只允许对区块链的异步调用。也就是说，如果你不在被调用函数的末尾提供回调方法，它就不起作用。你不能用<strong class="ji hu">。然后()</strong>要么，这对我来说有点奇怪，但我想这就是他们如何执行的。更多信息请参见他们的<a class="ae jf" href="https://github.com/MetaMask/faq/blob/master/DEVELOPERS.md" rel="noopener ugc nofollow" target="_blank">开发者指南</a>。</p><p id="90db" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">和一个创建池的调用</p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="ed3a" class="ke kf ht mo b fv ms mt l mu mv"><strong class="mo hu">export const </strong><em class="mw">createPool </em>= (pool) =&gt; {<br/>  <strong class="mo hu">return new </strong>Promise((resolve, reject) =&gt; {<br/>    <strong class="mo hu">const </strong>web3 = <strong class="mo hu">window</strong>.web3;<br/>    <strong class="mo hu">if</strong>(!web3 || !web3.isConnected() || !web3.currentProvider.isMetaMask) {<br/>      reject(<strong class="mo hu">'No web3!'</strong>);<br/>    }<br/><br/>    <strong class="mo hu">const </strong>appContract = web3.<strong class="mo hu">eth</strong>.contract(appContractAbi).<strong class="mo hu">at</strong>(<strong class="mo hu">app_contract_address</strong>);<br/>    <strong class="mo hu">const </strong>account = web3.<strong class="mo hu">eth</strong>.<strong class="mo hu">accounts</strong>[0];<br/>    <strong class="mo hu">if</strong>(!account) {<br/>      reject(<strong class="mo hu">'No account!'</strong>);<br/>    }<br/><br/>    web3.<strong class="mo hu">eth</strong>.getTransactionCount(account, (error, txCount) =&gt; {<br/>      <strong class="mo hu">if</strong>(error) {<br/>        reject(error);<br/>      }<br/>      appContract.<strong class="mo hu">createPool</strong>(pool.<strong class="mo hu">name</strong>, Number(pool.<strong class="mo hu">rate</strong>), Number(pool.<strong class="mo hu">deadline</strong>), {<br/>        <strong class="mo hu">nonce</strong>: txCount,<br/>        <strong class="mo hu">from</strong>: account<br/>      }, (err, transactionId) =&gt; {<br/>        <strong class="mo hu">if</strong>(err) {<br/>          reject(error);<br/>        } <strong class="mo hu">else </strong>{<br/>          axios.post(<strong class="mo hu">api_service_url </strong>+ <strong class="mo hu">'/transaction/create'</strong>, {<br/>            <strong class="mo hu">address</strong>: account,<br/>            <strong class="mo hu">transaction_id</strong>: transactionId,<br/>            <strong class="mo hu">transaction_type</strong>: <strong class="mo hu">'CreatePool'<br/>          </strong>}).then(response =&gt; {<br/>            resolve(transactionId);<br/>          }).catch((err) =&gt; {<br/>            reject(err);<br/>          });<br/>        }<br/>      });<br/>    });<br/>  });<br/>};</span></pre><h2 id="53ce" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">事务队列管理</h2><p id="be43" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">如果你仔细检查代码，你会发现一个小漏洞。我将事务数据发送到后端服务器，存储在那里，并等待关于它被放入块中的信息。通过这样做，我为区块链事务创建了一个队列。</p><p id="5eed" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您可以在前端实现相同的队列，事实上已经有库为您实现了。推荐看一下<a class="ae jf" href="http://truffleframework.com/docs/drizzle/getting-started" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hu">毛毛雨</strong> </a>。但是要使用<strong class="ji hu">毛毛雨</strong>你需要Web socket，我认为独自设置和维护是一件痛苦的事情。我在这个Dapp中使用的RPC provider Infura 并不正式支持web sockets。</p><p id="4364" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我的解决方案有明显的缺点。如果用户在我们的Web应用程序之外创建事务，我不会跟踪它的状态。然而，我仍然在合同上处理<strong class="ji hu">事件</strong>，所以这不是一个大问题。</p><h1 id="e872" class="le kf ht bd kg lf lg lh kk li lj lk ko ll lm ln kr lo lp lq ku lr ls lt kx lu dt translated">结论</h1><p id="520c" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">我们创建了一个全功能的分散式Web应用程序。通过使用<strong class="ji hu">元掩码</strong> <strong class="ji hu"> Web3 </strong>提供者，在区块链上直接处理交易。为了呈现数据，我们使用定制的后端服务，这使得用户界面更加流畅，开发更加容易。</p><p id="d142" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我花了很长时间来设置Web应用程序，并在后端提供所有需要的API调用。我在这里将它部署到了<a class="ae jf" href="http://34.210.217.34/" rel="noopener ugc nofollow" target="_blank"> AWS实例中，我鼓励您去看看。你得用<strong class="ji hu"> Ropsten网络！</strong></a></p><p id="e498" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">源代码可以在<a class="ae jf" href="https://github.com/joze144/pool-shark-web" rel="noopener ugc nofollow" target="_blank">这个Github库</a>中找到。</p><h2 id="671e" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">该系列的部分内容:</h2><ul class=""><li id="f0c2" class="lv lw ht ji b jj kz jn la jr my jv mz jz na kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/@jozhe/learn-solidity-shark-of-the-pool-part-1-ac0f733eecdd">第1部分——可靠性智能合同</a></li><li id="6351" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/@jozhe/testing-solidity-dapp-sotp-part-2-9685b3375aaf">第2部分—测试坚固性Dapp </a></li><li id="af72" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">第三部分——节点。Solidity Dapp的JS后端服务</li><li id="1e42" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><strong class="ji hu">第4部分—使用MetaMask Web3对Web应用程序做出反应</strong></li></ul><blockquote class="nb"><p id="cdaf" class="nc nd ht bd ne nf ng nh ni nj nk kd ek translated">加入Coinmonks <a class="ae jf" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jf" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>获取每日<a class="ae jf" href="http://coincodecap.com/" rel="noopener ugc nofollow" target="_blank">加密新闻</a></p></blockquote><h2 id="15d6" class="ke kf ht bd kg kh nl kj kk kl nm kn ko jr nn kq kr jv no kt ku jz np kw kx ky dt translated">另外，阅读</h2><ul class=""><li id="20fb" class="lv lw ht ji b jj kz jn la jr my jv mz jz na kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a> | <a class="ae jf" rel="noopener" href="/coinmonks/crypto-tax-software-ed4b4810e338">加密税务软件</a></li><li id="723e" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">网格交易</a> | <a class="ae jf" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069">加密硬件钱包</a></li><li id="874f" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" href="http://Top 4 Telegram Channels for Crypto Traders" rel="noopener ugc nofollow" target="_blank">密码电报信号</a> | <a class="ae jf" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="f33b" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/crypto-exchange-dd2f9d6f3769">最佳加密交易所</a> | <a class="ae jf" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度最佳加密交易所</a></li><li id="47a8" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">开发人员的最佳加密API</li><li id="b359" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated">最佳<a class="ae jf" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">密码借贷平台</a></li><li id="3c98" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/free-crypto-signals-48b25e61a8da">免费加密信号</a> | <a class="ae jf" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a></li><li id="9487" class="lv lw ht ji b jj me jn mf jr mg jv mh jz mi kd ma mb mc md dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/leveraged-token-3f5257808b22">杠杆代币的终极指南</a></li></ul></div></div>    
</body>
</html>