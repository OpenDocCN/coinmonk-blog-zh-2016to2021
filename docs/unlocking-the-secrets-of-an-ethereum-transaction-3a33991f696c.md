# 解开以太坊交易的秘密(第二部分)

> 原文：<https://medium.com/coinmonks/unlocking-the-secrets-of-an-ethereum-transaction-3a33991f696c?source=collection_archive---------0----------------------->

## 用 Python 解码事务日志

在本系列的第 1 部分[中，我们使用 Python 来解码事务*输入数据*。输入数据对于理解交易的广泛范围具有关键的洞察力。在本文中，我们主要关注事务日志。日志允许我们更深入地研究事务期间发生的单个运行时事件。我们将探讨什么是事务日志，为什么它们很重要，以及如何解码它们。](/coinmonks/discovering-the-secrets-of-an-ethereum-transaction-64febb00935c)

![](img/e14eccd638bc90b478aa8c5873ed9754.png)

## 什么是事务日志？

以太坊交易日志可以比作传统 app 开发中的日志记录。传统应用程序的程序员使用日志来调试、检测特定事件，或者通知日志查看者发生了一些事情。以太坊虚拟机(EVM)上的日志服务于非常相似的目的，因为它们用于描述在智能合约的运行时执行中发生的事件。这些事件可以由 dapps 或任何连接到以太坊节点的想要监听这些事件的设备订阅。日志中的事件也可以编入索引，以便在区块链上搜索事件历史。

事务日志有两个主要组成部分— *主题*和*数据*。以这个[事务日志](https://etherscan.io/tx/0xac80bab0940f061e184b0dda380d994e6fc14ab5d0c6f689035631c81bfe220b)为例。此事件日志描述了两个地址之间的 ETH 传输，这是更广泛事务的一部分。

Transaction log example

让我们细分*话题*。主题可以描述为*事件*的索引参数数组。`topics[0]`总是指事件名称和输入参数类型的 Keccak-256 哈希的十六进制值。在我们的例子中，`topics[0]`等于`Transfer(address,address,unit256)`。`topics[1:]`最多 3 个索引参数。在我们的例子中，`topics[1]`和`topics[2]`是用于执行事件的`Transfer()`方法的地址。

*数据*部分可以描述为事件所需的*附加数据。在我们的示例中，地址间传输的 ETH 量以十六进制格式包含在数据段中。智能合约的程序员可能以这种方式编程，因为写入日志的主题数组需要 gas，而写入数据不需要。也可以查询主题，但不能查询数据。没有人会去搜索一个有特定数量的 ETH 转移的事件，所以把这个数量放在数据部分是有意义的，这样可以节省油费。*

现在我们对事务日志的结构有了更多的了解，让我们深入代码。

## 解码交易

我们将使用 Web3 库与以太坊节点进行交互。有关安装和入门要求，请参见 [Web3 文档](https://web3py.readthedocs.io/en/stable/quickstart.html)。

我们的第一步是拿到交易收据。我们可以通过向 Web3 的`get_transaction_receipt()`方法传递一个事务散列来做到这一点。这将返回一个字典，其中包含有关事务的高级信息，包括日志。

该事务包含四个日志，但在本教程中，我们将重点关注第一个日志对象。我们分离出想要解码的日志以及事件发起地址的智能契约。

接下来，我们需要获取启动事件的智能合约的 ABI。我们可以用 Etherscan 的 API 做到这一点。你需要一个 API 密匙，可以从[开发者页面](https://etherscan.io/myapikey)免费获得。

接下来，我们创建契约对象，它允许我们通过 Python 代码与智能契约进行交互。

这里我们分离出日志中的`event signature`。它总是主题数组的第一项。我们将使用它来识别在此事件中调用了哪个智能合约函数。

接下来，我们可以使用契约的 ABI 来查找所有具有`event`类型的元素。这有助于我们缩小在事件期间使用的函数的搜索范围，因为函数必须有事件类型。

最后，我们可以遍历契约的事件，找出哪个事件与日志的事件签名相匹配。我们通过提取函数名和参数来组装事件对象的签名。我们使用`join`函数和`f-strings`来组装函数签名。然后，我们可以对集合的签名进行哈希运算，以将其与日志中的签名进行比较。当我们找到这两个签名之间的匹配时，我们知道我们找到了事件中使用的函数。最后，我们可以通过调用`processReceipt`方法使用我们的契约对象来解码事务日志。

## 结论

在我们的例子中，父事务是 SushiSwap 上的一个简单的令牌交换。解码事务日志使我们能够了解幕后发生了什么，以确保该事务成功完成。本教程只解码了 1/4 的事件，所以为了获得完整的图片，我们的应用程序需要解码所有四个事件。

这项基本技能可应用于许多应用，包括区块链智能、区块链数据分析等。我的下一篇文章将是关于基质框架以及它是如何改变区块链的发展方式的。点击跟随按钮，这样你就不会错过它。

如果你觉得这篇文章有帮助，如果你能留下评论并鼓掌，我们将不胜感激。谢谢大家！

## 另外，阅读

[](https://blog.coincodecap.com/ewasm-ethereum-webassembly) [## Ewasm -以太坊 WebAssembly

### 在我们上一篇关于信标链和分片的文章中，我们探讨了以太坊将如何实现 PoS 以及交易如何…

blog.coincodecap.com](https://blog.coincodecap.com/ewasm-ethereum-webassembly)