<html>
<head>
<title>Push a Transaction with delay on EOS blockchain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在EOS区块链上推送延迟交易</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/push-a-transaction-with-delay-on-eos-blockchain-11be0d0cffb5?source=collection_archive---------1-----------------------#2018-10-16">https://medium.com/coinmonks/push-a-transaction-with-delay-on-eos-blockchain-11be0d0cffb5?source=collection_archive---------1-----------------------#2018-10-16</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/b958baeda9f33fed14fc0fbb98e3b801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZNGgHai8726Smi6UTBK2A.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">source : eosio</figcaption></figure><p id="7a24" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">区块链技术有一个交易的概念来存储数据，并使其不可改变。EOS还处理区块链上的数据，但EOS中有两种类型的交易，在线交易和延迟交易。内联事务是那些当您将它们推入区块链并由生产者验证它们时被执行的事务，而具有延迟的事务可以被安排在特定的延迟之后被执行，之后生产者验证它并将它们添加到块中。</p><p id="97a6" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">在本文中，我们将学习如何在EOS区块链上创建延迟交易。</p><h2 id="3bf4" class="kd ke ht bd kf kg kh ki kj kk kl km kn jq ko kp kq ju kr ks kt jy ku kv kw kx dt translated">智能合同</h2><p id="0f62" class="pw-post-body-paragraph jf jg ht jh b ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy lc ka kb kc hm dt translated">我们将编写一个智能契约，其中包含一个表来存储帐户持有人的姓名和给定数字的总和，我们在这里的重点是不要编写复杂的动作，所以我选择简单的加法动作，以便我们可以更专注于交易。</p><p id="a011" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">我假设你知道公钥和私钥的概念，如果你不知道，请参考这里的<a class="ae ld" href="https://www.blockchain-council.org/blockchain/how-does-blockchain-use-public-key-cryptography/" rel="noopener ugc nofollow" target="_blank">和这里的</a><a class="ae ld" href="https://eosio.stackexchange.com/questions/1511/what-is-the-difference-between-wallets-and-accounts-in-eos/1513" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="5b4a" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">在这个契约中，我们有两个动作，一个是<strong class="jh hu"> transfertxn </strong>，它在给定的延迟后调用主<strong class="jh hu">加法</strong>函数。我们的加法操作看起来像:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="e854" class="kd ke ht lj b fv ln lo l lp lq">//this action add two number a and b, save the sum in a table ttabs<br/>//@param user account_name of person who sets the contract<br/>//@param memo sender_id of transaction which will not be greater than 14 chars <br/>//@param delay number of seconds by which you want to delay you transaction<br/>//@param a integer number<br/>//@param b integer number</span><span id="04c1" class="kd ke ht lj b fv lr lo l lp lq">void addition(account_name user,std::string memo,uint64_t a  , uint64_t b)<br/>  {<br/>    _table ttabs(_self,_self);<br/>    uint64_t sum = a+b;<br/>    auto iter=ttabs.find(user);<br/>    if(iter==ttabs.end()){<br/>    print("now the sum is inserted _________________\t"); <br/>    ttabs.emplace(_self,[&amp;](auto&amp; sumtable){<br/>          sumtable.account = user;<br/>          sumtable.additionsum = sum;<br/>            });<br/>    }<br/>    else<br/>    {  ttabs.erase(iter);<br/>       print("\n");<br/>     }<br/>  }</span></pre><p id="efd1" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，我们需要创建一个表结构来存储数据。表格结构看起来像:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="18a2" class="kd ke ht lj b fv ln lo l lp lq">//this is a table structure that have two fields ,account and additionsum</span><span id="285c" class="kd ke ht lj b fv lr lo l lp lq">struct sumtable<br/>  {<br/>     account_name account;<br/>     uint64_t additionsum;<br/>     uint64_t primary_key() const {return account;}</span><span id="39e7" class="kd ke ht lj b fv lr lo l lp lq">     EOSLIB_SERIALIZE(sumtable,(account)(additionsum))<br/>   };</span></pre><p id="91d3" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">上表存储帐户和两个数字的相加，主键为“帐户”。现在我们的<strong class="jh hu"> transfertxn </strong>动作看起来像:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="6def" class="kd ke ht lj b fv ln lo l lp lq">//transfertxn executes the transaction after the given delay<br/>//@param from account_name of the person who set the contract //@param a integer number<br/>//@param b integer number<br/>//@param memo string sender_id what will you in future to cancel the transaction before given delay time<br/>//@param delay, number of seconds(integer)</span><span id="4ed4" class="kd ke ht lj b fv lr lo l lp lq">void transfertxn(account_name from, uint64_t a, uint64_t b ,string memo, uint64_t delay)<br/>    {   <br/>        eosio::transaction txn{};<br/>        txn.actions.emplace_back(<br/>            eosio::permission_level(from, N(active)),<br/>            N(testaccount),<br/>            N(addition),<br/>            std::make_tuple(from,memo,delay,a,b));<br/>        txn.delay_sec = delay;<br/>        txn.send(eosio::string_to_name(memo.c_str()), from);<br/>        print("the transfertxn has been executed ___________\n");<br/>    }</span></pre><p id="9f25" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">那么我们来了解一下transfertxn动作。</p><h2 id="9298" class="kd ke ht bd kf kg kh ki kj kk kl km kn jq ko kp kq ju kr ks kt jy ku kv kw kx dt translated">交易结构</h2><p id="0b83" class="pw-post-body-paragraph jf jg ht jh b ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy lc ka kb kc hm dt translated">现在，我们需要为eosiolib/transaction.hpp中定义的<strong class="jh hu">事务</strong>创建一个<strong class="jh hu"> txn </strong>对象，在这个对象中，我们添加了带有适当参数的操作，并设置了延迟，如您在上面的代码中所见。现在，让我们一个一个地了解动作参数。</p><ol class=""><li id="184a" class="ls lt ht jh b ji jj jm jn jq lu ju lv jy lw kc lx ly lz ma dt translated">eosio::permission_level(from，N(active)):我们设置你要通过其推送该交易的账户的权限。这是`中的`<em class="mb"/></li><li id="9a04" class="ls lt ht jh b ji mc jm md jq me ju mf jy mg kc lx ly lz ma dt translated">N(testaccount):用于部署合同的帐户</li><li id="df9a" class="ls lt ht jh b ji mc jm md jq me ju mf jy mg kc lx ly lz ma dt translated">n(添加):要调用的操作</li><li id="6694" class="ls lt ht jh b ji mc jm md jq me ju mf jy mg kc lx ly lz ma dt translated">std::make_tuple(from，memo，delay，a，b)):将参数传递给加法操作</li></ol><p id="49b7" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">最后，我们的<strong class="jh hu"> tbsample.cpp </strong>文件看起来像这样:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="8cb6" class="kd ke ht lj b fv ln lo l lp lq">#include &lt;eosiolib/eosio.hpp&gt;<br/>#include &lt;eosiolib/print.hpp&gt;<br/>#include &lt;eosiolib/transaction.hpp<br/>#include &lt;eosiolib/print.hpp<br/>#include &lt;string&gt;</span><span id="e18f" class="kd ke ht lj b fv lr lo l lp lq">using namespace std;<br/>using namespace eosio;</span><span id="6447" class="kd ke ht lj b fv lr lo l lp lq">class benjamin: public eosio::contract<br/>{<br/>public:<br/>  using contract::contract;<br/> /// @abi table sumtable i64<br/>struct sumtable<br/>{<br/>  account_name account;<br/>  uint64_t additionsum;<br/>  uint64_t primary_key() const { return account;<br/>  }<br/>  EOSLIB_SERIALIZE(sumtable, (account)(additionsum))<br/>};</span><span id="d6cf" class="kd ke ht lj b fv lr lo l lp lq">typedef multi_index&lt;N(sumtable), sumtable&gt; _table;</span><span id="0f71" class="kd ke ht lj b fv lr lo l lp lq">/// @abi action<br/>void addition(account_name user, std::string memo, uint64_t delay, uint64_t a, uint64_t b)<br/>{<br/>   _table ttabs(_self, _self);<br/>    uint64_t sum = a + b;<br/>    auto iter = ttabs.find(user);<br/>    if (iter == ttabs.end())<br/>     {<br/>       print("now the sum is inserted _________\t");                                           ttabs.emplace(_self, [&amp;](auto &amp;sumtable) {<br/>      sumtable.account = user;<br/>      sumtable.additionsum = sum;<br/>});<br/>}else<br/> {<br/>    ttabs.erase(iter);<br/>    print("\n");<br/> }<br/>}</span><span id="2c84" class="kd ke ht lj b fv lr lo l lp lq">/// @abi action<br/>void transfertxn(account_name from, uint64_t a, uint64_t b, string memo, uint64_t delay)<br/>{<br/>    eosio::transaction txn{};<br/>    txn.actions.emplace_back(<br/>      eosio::permission_level(from, N(active)),<br/>      N(testaccount),<br/>      N(addition),<br/>    std::make_tuple(from, memo, delay, a, b));<br/>    txn.delay_sec = delay;<br/>    txn.send(eosio::string_to_name(memo.c_str()), from);</span><span id="9370" class="kd ke ht lj b fv lr lo l lp lq">    print("the transaction has been executed _________________\n");</span><span id="c90e" class="kd ke ht lj b fv lr lo l lp lq">}<br/>};<br/>EOSIO_ABI(benjamin, (addition)(transfertxn))</span></pre><p id="c3fe" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">您可以在单独的。hpp文件(头文件)也是。现在，让我们部署并测试它。</p><p id="d78d" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">首先，运行nodeos，下面是启动nodeos的命令</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="fb16" class="kd ke ht lj b fv ln lo l lp lq"># nodeos -e -p eosio --plugin eosio::wallet_api_plugin --plugin eosio::chain_api_plugin contracts-console</span></pre><p id="ed37" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，为这个契约编译wast和abi文件。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="9d13" class="kd ke ht lj b fv ln lo l lp lq"># eosiocpp -o tbsample.wast tbsample.cpp<br/># eosiocpp -g tbsample.abi tbsample.cpp</span></pre><p id="a29e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">使用account_name testaccount(我的帐户名称)设置合同，在设置我们的合同之前，我们的钱包必须解锁。所以我们来定合同吧。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="4010" class="kd ke ht lj b fv ln lo l lp lq"># cleos set contract testaccount  tbsample ./tbsample/tbsample.wast ./tbsample/tbsample.abi</span></pre><p id="7f04" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">订立合同后，现在是时候将我们的行动推进到区块链节点了。为了测试，我通过了20秒的延迟。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="aa87" class="kd ke ht lj b fv ln lo l lp lq"># cleos push action testaccount transfertxn '["testaccount",10,20,"himessage",20]' -p testaccount</span></pre><p id="a9c8" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">执行该命令后，您会收到类似如下的消息。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="5837" class="kd ke ht lj b fv ln lo l lp lq">executed transaction: 44203ea245cc95ffdb74e96643588b93c4df9b2a3ac08e222e5d38edb85d01df  184 bytes  1553 us<br/>#   testaccount &lt;= testaccount::transfertxn     {"from":"testaccount","a":10,"b":20,"memo":"himessage","delay":20}<br/>&gt;&gt; the transfer has been executed ____________________________________________________<br/>warning: transaction executed locally, but may not be confirmed by the network yet</span></pre><p id="0c9c" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">忽略警告(如果有),现在让我们回到我们的合同，我们已经将我们的操作推入本地区块链，如果您转到nodeos终端，您可以看到您的事务是这样运行的。</p><figure class="le lf lg lh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mh"><img src="../Images/6ee7019b52c67230bf99b2c86d6c026a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0BhhQKNPyY4bmAmzp2Lj0g.png"/></div></div></figure><p id="714f" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因为我们在transfertxn操作中给出了20秒的延迟，所以20秒后我们将这两个数字相加并放入表中。因此，20秒钟后，您的<strong class="jh hu"> <em class="mb">添加操作</em> </strong>将会触发，如果工作正常，我们的nodeos窗口看起来就像这样。</p><figure class="le lf lg lh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mi"><img src="../Images/10c6217da4719cde0efada655c0c069a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZg7H7yZfFzM45S-S1ML_Q.png"/></div></div></figure><p id="ed23" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">为了获得表格数据，</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="eb59" class="kd ke ht lj b fv ln lo l lp lq"># cleos get table testaccount testaccount sumtable</span></pre><p id="7752" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">这就是交易的运作方式。我们还有一个取消延迟交易的功能，详情请参考这个<a class="ae ld" href="https://eosio.stackexchange.com/questions/1800/how-can-i-cancel-the-deferred-transaction-in-eos-after-we-push-the-deferred-tran" rel="noopener ugc nofollow" target="_blank">网址</a>。</p><p id="4cb7" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">如果您在让应用程序工作时遇到任何问题，请随时在这个<a class="ae ld" href="https://github.com/nirdesh27/Sample_EOS_code" rel="noopener ugc nofollow" target="_blank">库</a>上发表评论或提出问题。你可以在这里获得<strong class="jh hu">完整代码</strong> <a class="ae ld" href="https://github.com/nirdesh27/Sample_EOS_code" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="8eb2" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">资源和参考资料</p><ol class=""><li id="6a6a" class="ls lt ht jh b ji jj jm jn jq lu ju lv jy lw kc lx ly lz ma dt translated">EOS <a class="ae ld" href="https://developers.eos.io/" rel="noopener ugc nofollow" target="_blank">开发者</a></li><li id="7b5a" class="ls lt ht jh b ji mc jm md jq me ju mf jy mg kc lx ly lz ma dt translated">EOS <a class="ae ld" href="https://eosio.stackexchange.com/questions/" rel="noopener ugc nofollow" target="_blank">堆栈交换</a></li></ol><p id="02ce" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">原文发表于</strong> <a class="ae ld" href="https://www.innoplexus.com/blog/push-a-transaction-with-delay-on-eos-blockchain/" rel="noopener ugc nofollow" target="_blank"> <strong class="jh hu">此处</strong> </a> <strong class="jh hu">。Innoplexus AG保留所有权利。</strong></p><blockquote class="mj"><p id="9ea0" class="mk ml ht bd mm mn mo mp mq mr ms kc ek translated"><a class="ae ld" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mu mv mw mx my iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mt"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>