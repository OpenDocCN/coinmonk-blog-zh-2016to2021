<html>
<head>
<title>MoneyBox</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">钱箱</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/moneybox-790c8aaaab31?source=collection_archive---------1-----------------------#2018-02-09">https://medium.com/coinmonks/moneybox-790c8aaaab31?source=collection_archive---------1-----------------------#2018-02-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="7db9" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">将钱箱合同部署到Rinkeby Testnet的描述</h2></div><h2 id="7c63" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">步骤1:设计/合同要求</h2><p id="4d9c" class="pw-post-body-paragraph kg kh ht ki b kj kk iu kl km kn ix ko jt kp kq kr jx ks kt ku kb kv kw kx ky hm dt translated">给定以下需求规格，我们设计一个合同。<br/> —用户可以将钱存入钱箱<br/> —用户可以在一定时间内取款</p><p id="ff02" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">合同草案如下:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="e0dc" class="ji jj ht lj b fv ln lo l lp lq">pragma solidity ^ 0.4.0;</span><span id="ef5c" class="ji jj ht lj b fv lr lo l lp lq">contract PayDay {</span><span id="455f" class="ji jj ht lj b fv lr lo l lp lq">address private owner;<br/>  uint public bday;<br/>  uint public payday;<br/>  modifier onlyOwner {<br/>    require(msg.sender == owner);<br/>    _;<br/>  }<br/>  /*constructor*/<br/>  function PayDay() public  {<br/>    owner = msg.sender;<br/>    bday = now;<br/>    payday = ( bday + 5 minutes );<br/>  }<br/>  /* Default function */<br/>  function() public payable {<br/>  }</span><span id="405c" class="ji jj ht lj b fv lr lo l lp lq">function withdraw() public onlyOwner {<br/>       require (block.timestamp &gt; payday);<br/>       msg.sender.transfer(this.balance);<br/>   }</span><span id="0945" class="ji jj ht lj b fv lr lo l lp lq">function getbDay() view public returns (uint256){<br/>      return bday;<br/>  }</span><span id="2b27" class="ji jj ht lj b fv lr lo l lp lq">function getOwner() view public returns (address){<br/>      return owner;<br/>  }</span><span id="32a9" class="ji jj ht lj b fv lr lo l lp lq">function getPayDay() view public returns (uint256){<br/>      return payday;<br/>  }<br/>  <br/>}</span></pre><h2 id="37d2" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">步骤2 : TestRPC</h2><p id="a754" class="pw-post-body-paragraph kg kh ht ki b kj kk iu kl km kn ix ko jt kp kq kr jx ks kt ku kb kv kw kx ky hm dt translated">我们将使用块菌和TestRPC。为此，我们首先需要Node.js。在Mac上，要安装，我们首先要确保我们有Node、npm，然后安装truffle和ethereumjs-testrpc:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="7d9b" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ brew install node<br/>Computer:~ home$ node -v</span><span id="5d8c" class="ji jj ht lj b fv lr lo l lp lq">v9.5.0</span><span id="3915" class="ji jj ht lj b fv lr lo l lp lq">$ npm -v</span><span id="bdd1" class="ji jj ht lj b fv lr lo l lp lq">5.6.0</span><span id="16c2" class="ji jj ht lj b fv lr lo l lp lq">Computer:~ home$ npm install -g truffle<br/>Computer:~ home$ truffle</span><span id="02f7" class="ji jj ht lj b fv lr lo l lp lq">Truffle v4.0.6 - a development framework for Ethereum</span><span id="8d18" class="ji jj ht lj b fv lr lo l lp lq">...<br/>Computer:~ home$ npm install -g ethereumjs-testrpc</span></pre><p id="1826" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">让我们用命令<code class="eh ls lt lu lj b">testrpc</code>在一个新的终端窗口上启动testrpc，稍后我们将回到这个问题:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="3db3" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ testrpc<br/>EthereumJS TestRPC v6.0.3 (ganache-core: 2.0.2)</span><span id="fe83" class="ji jj ht lj b fv lr lo l lp lq">Available Accounts<br/>==================<br/>(0) 0x3c1252e4e1214f3ba87b19172577bb8a512ff56d<br/>(1) 0x7c30fe1e4156438bac5f5483190ef185aca6cb69<br/>(2) 0x7524bbc15a15b64195025d09914b4fbe9b66dcff<br/>(3) 0xf073afc660db0e21e14909ef9c3372494e0ccbdf<br/>(4) 0xd304a82c1fc33cac135a1bbe1685ec65a3494a5f<br/>(5) 0x180d101faf2bd1ea365b2d817902b6e875fad28c<br/>(6) 0x68a7610df65ddc36ea7f9f578e46627c0ea6049a<br/>(7) 0x750f8a9d06644df7048a90981ca08849003485fa<br/>(8) 0x9da74b992316a4c33614d18c011f50b87a16cbf5<br/>(9) 0x5d6ca4e4fcea28957cd497059e94e967044d15b7</span><span id="015f" class="ji jj ht lj b fv lr lo l lp lq">Private Keys<br/>==================<br/>(0) f2b81dc30d919faed32e7f7e8127118b4ceb0c82d944670ae4006bb01bf6e99b<br/>(1) 0520f5d80bb0e3ce546fd4a4078f6b33d00041c96b1466eac74335b8c2b07c71<br/>(2) c9af451c2853fc00684e214c028af41b9249585f1893065d095f6bc8d2cce5e9<br/>(3) 198407335d65850a1625fb185af18ba438d64027a72548f459fb2373602bd9e3<br/>(4) f8549dc4f8af7cc82e3f045178369a371959ea2a07c3d9dc8f61b11f49580079<br/>(5) 41c75fe0b537e55fca7e60b9827890043c7f3bd7d756ef7b773cd4209c3da039<br/>(6) 8b0f9eb8d5d85f9dbda711a2a07bf94c4708ea65c1068fa98c08410c00d04698<br/>(7) ddb20569abe274cf6b8a552d7d621e8e4e837586eef2c965eeba268142ca6afe<br/>(8) 70120309eca622d414c7352f16f78d559022cf3b76b96df3b3f3feed9956f63a<br/>(9) bbb330d1ee71c2b93b466d854edfad758cd53e4667843e52699f889a209d7d6b</span><span id="48f8" class="ji jj ht lj b fv lr lo l lp lq">HD Wallet<br/>==================<br/>Mnemonic:      artefact cable broccoli glance palm table tattoo garden trumpet round orient danger<br/>Base HD Path:  m/44'/60'/0'/0/{account_index}</span><span id="3f73" class="ji jj ht lj b fv lr lo l lp lq">Listening on localhost:8545</span></pre><p id="4fe5" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们稍后将仔细研究这一点，但现在，在前面的终端窗口中，我们将创建一个新目录，我们将在其中启动Truffle:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="8ef9" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ mkdir payday2<br/>Computer:~ home$ cd payday2<br/>Computer:payday2 home$ ls<br/>Computer:payday2 home$ truffle init<br/>Downloading...<br/>Unpacking...<br/>Setting up...<br/>Unbox successful. Sweet!</span><span id="f58a" class="ji jj ht lj b fv lr lo l lp lq">Commands:</span><span id="4f87" class="ji jj ht lj b fv lr lo l lp lq">Compile:        truffle compile<br/>  Migrate:        truffle migrate<br/>  Test contracts: truffle test<br/>Computer:payday2 home$ truffle test<br/>Compiling ./contracts/Migrations.sol...</span><span id="b196" class="ji jj ht lj b fv lr lo l lp lq">0 passing (0ms)</span><span id="941f" class="ji jj ht lj b fv lr lo l lp lq">Computer:payday2 home$ truffle create contract PayDay<br/>Computer:payday2 home$ nano contracts/PayDay.sol</span></pre><p id="371b" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">让我们回顾一下其中的一些命令:<br/> <code class="eh ls lt lu lj b">truffle init</code>将创建以下内容:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="69af" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ tree<br/>.<br/>├── build<br/>│   └── contracts<br/>│       ├── Migrations.json<br/>├── contracts<br/>│   ├── Migrations.sol<br/>│   └── PayDay.sol<br/>├── migrations<br/>│   └── 1_initial_migration.js<br/>├── test<br/>├── truffle-config.js<br/>└── truffle.js</span><span id="76f8" class="ji jj ht lj b fv lr lo l lp lq">5 directories, 6 files</span></pre><p id="b757" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">然后，<code class="eh ls lt lu lj b">truffle create contract PayDay</code>在contracts目录下创建一个名为PayDay.sol的文件。默认情况下，它看起来像这样:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="e817" class="ji jj ht lj b fv ln lo l lp lq">pragma solidity ^0.4.4;</span><span id="19eb" class="ji jj ht lj b fv lr lo l lp lq">contract PayDay {<br/>  function PayDay() {<br/>    // constructor<br/>  }<br/>}</span></pre><p id="6004" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">然后，我们用帖子开头显示的草稿替换合同上的内容。让我们继续。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="ff8e" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ truffle create migration deploy_pay_day<br/>Computer:payday2 home$ ls migrations<br/>1518110703_deploy_pay_day.js 1_initial_migration.js<br/>Computer:payday2 home$ nano migrations/1518110703_deploy_pay_day.js<br/>Computer:payday2 home$ nano truffle.js</span></pre><p id="047e" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们用<code class="eh ls lt lu lj b">truffle create migration</code>文件创建了一个迁移文件。它在迁移目录下创建一个名为<code class="eh ls lt lu lj b">1518110703_deploy_pay_day.js</code>的文件。该文件如下所示:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="29ab" class="ji jj ht lj b fv ln lo l lp lq">module.exports = function(deployer) {<br/>// Use deployer to state migration tasks.<br/>};</span></pre><p id="bf68" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们把它编辑成这样:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="4ba7" class="ji jj ht lj b fv ln lo l lp lq">const PayDay = artifacts.require('PayDay')</span><span id="2a6a" class="ji jj ht lj b fv lr lo l lp lq">module.exports = function(deployer) {<br/>  deployer.deploy(PayDay)<br/>}</span></pre><p id="dbe6" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如您所见，我们还编辑了我们的<code class="eh ls lt lu lj b">truffle.js</code>文件，使其看起来像这样:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="0c70" class="ji jj ht lj b fv ln lo l lp lq">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "localhost",<br/>      port: 8545,<br/>      network_id: "*" // Match any network id<br/>    }<br/>  }<br/>};</span></pre><p id="b5c1" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">然后，回到终端，我们运行<code class="eh ls lt lu lj b">truffle migrate —-reset</code>命令。这样做的目的是利用来自合同目录和迁移目录的信息来编译和部署合同。[还记得我们在另一个终端窗口上运行testrpc吗]</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="9c48" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ truffle migrate --reset<br/>Compiling ./contracts/Migrations.sol...<br/>Compiling ./contracts/PayDay.sol...<br/>Writing artifacts to ./build/contracts</span><span id="ff5c" class="ji jj ht lj b fv lr lo l lp lq">Using network 'development'.</span><span id="3b57" class="ji jj ht lj b fv lr lo l lp lq">Running migration: 1_initial_migration.js<br/>  Deploying Migrations...<br/>  ... 0x6e47333a9a0e5ebeee4a8498f719f50d43c02d3ef1256ea8bb7e8c8e47090bdf<br/>  Migrations: 0x0147d5175635b03539d53972289a7fee17c63c81<br/>Saving successful migration to network...<br/>  ... 0xef26a75bd1e810a55fbefb6c10a8290883eaedb40779ad418f96c9031ced10ce<br/>Saving artifacts...<br/>Running migration: 1518110703_deploy_pay_day.js<br/>  Deploying PayDay...<br/>  ... 0xb58876a44ab0d24f1ec397164753683f8d64dda941f9fc1380ea7489769b7fe5<br/>  PayDay: 0xb4af81138e1189f95fd988a70ba2262ef0c4817c<br/>Saving successful migration to network...<br/>  ... 0x8173065627f0636972086606a7deb54f7ef569770bdf6539c2d33a9a9b2548de<br/>Saving artifacts...</span></pre><p id="48e4" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如果您看一下另一个终端窗口，在那里我们运行testrpc，您将看到类似这样的内容:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="cbff" class="ji jj ht lj b fv ln lo l lp lq">net_version<br/>eth_accounts<br/>eth_accounts<br/>net_version<br/>net_version<br/>eth_sendTransaction</span><span id="3927" class="ji jj ht lj b fv lr lo l lp lq">Transaction: 0xd3f6c60137b897d46b6f8b5b55f220248fef636577cc9101c3476327f26eae9a<br/>  Contract created: 0x1ba49c9b8832273e3d55cdcda46c338135496435<br/>  Gas usage: 269607<br/>  Block Number: 1<br/>  Block Time: Thu Feb 08 2018 17:28:22 GMT+0300 (MSK)</span><span id="f061" class="ji jj ht lj b fv lr lo l lp lq">eth_newBlockFilter</span></pre><p id="05e6" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在，让我们与已部署的合同进行一点互动。为此，在我们使用truffle的前一个终端窗口中，让我们用<code class="eh ls lt lu lj b">truffle console</code>命令跳转到控制台:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="55e0" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ truffle console<br/>truffle(development)&gt; PayDay.deployed().then(function(instance){return instance.address;}).then(function(value){return value});<br/>'0xb4af81138e1189f95fd988a70ba2262ef0c4817c'<br/>truffle(development)&gt; web3.eth.sendTransaction({from:web3.eth.accounts[2], to:'0xb4af81138e1189f95fd988a70ba2262ef0c4817c', value: 1000000000000000000})<br/>'0x032cc08d7b53cd968d7354d938af6b779b1c0ae7794609ecb9a2e1972a6154c1'<br/>truffle(development)&gt; cto = '0xb4af81138e1189f95fd988a70ba2262ef0c4817c'<br/>'0xb4af81138e1189f95fd988a70ba2262ef0c4817c'<br/>truffle(development)&gt; web3.eth.getBalance(cto)<br/>BigNumber { s: 1, e: 18, c: [ 10000 ] }<br/>truffle(development)&gt; PayDay.deployed().then(function(instance){return instance.withdraw();});<br/>Error: VM Exception while processing transaction: revert<br/>    at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:509:1)<br/>    at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:354:1)<br/>    at XMLHttpRequestEventTarget.dispatchEvent (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:64:1)<br/>    at XMLHttpRequest.request.onreadystatechange (/usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/httpprovider.js:128:1)<br/>    at /usr/local/lib/node_modules/truffle/build/webpack:/~/truffle-provider/wrapper.js:134:1<br/>    at /usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/requestmanager.js:86:1<br/>    at Object.InvalidResponse (/usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/errors.js:38:1)<br/>truffle(development)&gt; web3.eth.getBalance(cto)<br/>BigNumber { s: 1, e: 18, c: [ 10000 ] }<br/>truffle(development)&gt; PayDay.deployed().then(function(instance) {meta = instance;return meta.getbDay.call();}).then(function(balance) {console.log(balance);}) <br/>BigNumber { s: 1, e: 9, c: [ 1518110826 ] }<br/>undefined<br/>truffle(development)&gt; PayDay.deployed().then(function(instance) {meta = instance;return meta.getOwner.call();}).then(function(balance) {console.log(balance);})<br/>0x3c1252e4e1214f3ba87b19172577bb8a512ff56d<br/>undefined</span></pre><p id="4bc2" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">让我们来看看一些命令:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="467e" class="ji jj ht lj b fv ln lo l lp lq">PayDay.deployed().then(function(instance){return instance.address;}).then(function(value){return value});<br/>'0xb4af81138e1189f95fd988a70ba2262ef0c4817c'<br/>truffle(development)&gt; cto = '0xb4af81138e1189f95fd988a70ba2262ef0c4817c'</span></pre><p id="a96f" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">这为我们提供了已部署契约的地址。我们需要地址，因为我们想发送一些以太到它，看看它是否允许我们撤回它(为了方便使用，我们还将合同地址保存为<code class="eh ls lt lu lj b">cto</code>)。请记住，我们将合同设置为创建后5分钟内不允许撤销。然后，我们从testrpc帐户之一向契约发送一些以太网:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="5529" class="ji jj ht lj b fv ln lo l lp lq">web3.eth.sendTransaction({from:web3.eth.accounts[2], to:'0xb4af81138e1189f95fd988a70ba2262ef0c4817c', value: 1000000000000000000})</span></pre><p id="06a2" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在让我们检查一下合同的余额:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="db52" class="ji jj ht lj b fv ln lo l lp lq">truffle(development)&gt; web3.eth.getBalance(cto)<br/>BigNumber { s: 1, e: 18, c: [ 10000 ] }</span></pre><p id="fee8" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在让我们试着退出:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="f30c" class="ji jj ht lj b fv ln lo l lp lq">truffle(development)&gt; PayDay.deployed().then(function(instance){return instance.withdraw();});</span></pre><p id="d076" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们看到以下回报:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="fdd7" class="ji jj ht lj b fv ln lo l lp lq">Error: VM Exception while processing transaction: revert<br/>    at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:509:1)<br/>    at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:354:1)<br/>    at XMLHttpRequestEventTarget.dispatchEvent (/usr/local/lib/node_modules/truffle/build/webpack:/~/xhr2/lib/xhr2.js:64:1)<br/>    at XMLHttpRequest.request.onreadystatechange (/usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/httpprovider.js:128:1)<br/>    at /usr/local/lib/node_modules/truffle/build/webpack:/~/truffle-provider/wrapper.js:134:1<br/>    at /usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/requestmanager.js:86:1<br/>    at Object.InvalidResponse (/usr/local/lib/node_modules/truffle/build/webpack:/~/web3/lib/web3/errors.js:38:1)</span></pre><p id="789d" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">不管它是什么，它是一个错误。这很好。5分钟还没有过去，所以应该不可能撤回。让我们看看合同中的其他一些电话。我们将调用<code class="eh ls lt lu lj b">getbDay()</code>函数和<code class="eh ls lt lu lj b">getOwner()</code>函数。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="6172" class="ji jj ht lj b fv ln lo l lp lq">truffle(development)&gt; PayDay.deployed().then(function(instance) {meta = instance;return meta.getbDay.call();}).then(function(balance) {console.log(balance);}) <br/>BigNumber { s: 1, e: 9, c: [ 1518110826 ] }<br/>undefined<br/>truffle(development)&gt; PayDay.deployed().then(function(instance) {meta = instance;return meta.getOwner.call();}).then(function(balance) {console.log(balance);})<br/>0x3c1252e4e1214f3ba87b19172577bb8a512ff56d<br/>undefined</span></pre><p id="7c7c" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如您所见，我们返回了时间戳格式的合同的生日<code class="eh ls lt lu lj b">1518110826</code>和所有者的地址。<code class="eh ls lt lu lj b">getPayDay()</code>函数也是可用的，它返回合同何时允许我们撤回。</p><p id="6e27" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在，5分钟过去了，我们试着撤退:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="5304" class="ji jj ht lj b fv ln lo l lp lq">truffle(development)&gt; PayDay.deployed().then(function(instance){return instance.withdraw();});<br/>{ tx: '0xb83d3459588e3d85242af040738ad13338fad099948137548ffd3809d94e95ce',<br/>  receipt: <br/>   { transactionHash: '0xb83d3459588e3d85242af040738ad13338fad099948137548ffd3809d94e95ce',<br/>     transactionIndex: 0,<br/>     blockHash: '0xf962124146242f5a8ba14de4bfcfb11f461c95647492fb1f3b99546b1b96f095',<br/>     blockNumber: 10,<br/>     gasUsed: 23129,<br/>     cumulativeGasUsed: 23129,<br/>     contractAddress: null,<br/>     logs: [],<br/>     status: 1 },<br/>  logs: [] }</span></pre><p id="765c" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">正如您所看到的，这个交易成功地进行了，如果我们检查合同的余额，我们可以验证它现在是0，之前在合同中的金额现在已经添加到合同的所有者(在这个例子中是<code class="eh ls lt lu lj b">web3.eth.account[0]</code>或者testrpc中的第一个测试帐户)。</p><p id="ef81" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">在研究了合同之后，我们检查了不同账户的存款——这是允许的——并确保取款功能只将资金发送给合同的所有者。现在让我们部署到Rinkeby。</p><h2 id="9a8b" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">第三步:Geth &amp; Rinkeby</h2><p id="b110" class="pw-post-body-paragraph kg kh ht ki b kj kk iu kl km kn ix ko jt kp kq kr jx ks kt ku kb kv kw kx ky hm dt translated">现在，我们将把合同部署到Rinkeby Testnet。确保您已经下载了geth。</p><p id="778e" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们将在两个不同的终端窗口上工作，这两个窗口与我们之前工作的不同。在其中一个服务器上，我们将运行geth节点，在另一个服务器上，我们将运行geth控制台。</p><p id="2631" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">首先，我们需要为自己创建一个帐户。为此，我们启动geth控制台。然后我们看到我们没有帐户，我们用命令<code class="eh ls lt lu lj b">personal.newAccount("password")</code>(用您自己的密码)添加了一个新帐户。我们可以看到这个地址的余额为零。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="fcf1" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ geth --datadir=$HOME/.rinkeby attach ipc:$HOME/Library/Ethereum/rinkeby/geth.ipc console<br/>Welcome to the Geth JavaScript console!</span><span id="c7c1" class="ji jj ht lj b fv lr lo l lp lq">instance: Geth/v1.7.3-stable-4bb3c89d/darwin-amd64/go1.9.2<br/> modules: admin:1.0 clique:1.0 debug:1.0 eth:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0</span><span id="6826" class="ji jj ht lj b fv lr lo l lp lq">&gt; eth.accounts<br/>[]<br/>&gt; personal.newAccount("password")<br/>"0xbcec0503ac99f28d009797fe320cff2f9ec7b836"<br/>&gt; eth.coinbase<br/>"0xbcec0503ac99f28d009797fe320cff2f9ec7b836"<br/>&gt; eth.getBalance(eth.coinbase)<br/>0<br/>&gt; eth.accounts<br/>["0xbcec0503ac99f28d009797fe320cff2f9ec7b836"]</span></pre><p id="3751" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如果为了将合同部署到林克比，我们将需要汽油，由于我们的账户没有汽油，我们可以从林克比水龙头<a class="ae lv" href="https://www.rinkeby.io/#faucet" rel="noopener ugc nofollow" target="_blank">https://www.rinkeby.io/#faucet</a>那里要一些(你需要在社交媒体网站上发布你的地址，以证明你是人类)。</p><p id="574c" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在，我们需要使用geth打开Rinkeby的端点，因此在不同的终端上我们执行以下操作(这是一个命令，unlock参数下的地址是我们在上一步中获得的地址):</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="742c" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ geth --rinkeby --rpc --rpcapi db,eth,net,web3,personal --unlock="0xbcec0503ac99f28d009797fe320cff2f9ec7b836"</span></pre><p id="019c" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">它会要求我们输入密码。您会看到类似这样的内容:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="829f" class="ji jj ht lj b fv ln lo l lp lq">Computer:~ home$ geth --rinkeby --rpc --rpcapi db,eth,net,web3,personal --unlock="0xbcec0503ac99f28d009797fe320cff2f9ec7b836"<br/>INFO [02-08|20:46:49] Starting peer-to-peer node               instance=Geth/v1.7.3-stable-4bb3c89d/darwin-amd64/go1.9.2<br/>INFO [02-08|20:46:49] Allocated cache and file handles         database=/Users/juanbernardotobar/Library/Ethereum/rinkeby/geth/chaindata cache=128 handles=1024<br/>INFO [02-08|20:46:49] Initialised chain configuration          config="{ChainID: 4 Homestead: 1 DAO: &lt;nil&gt; DAOSupport: true EIP150: 2 EIP155: 3 EIP158: 3 Byzantium: 1035301 Engine: clique}"<br/>INFO [02-08|20:46:49] Initialising Ethereum protocol           versions="[63 62]" network=4<br/>INFO [02-08|20:46:49] Loaded most recent local header          number=1736134 hash=7094e2…23b319 td=3235361<br/>INFO [02-08|20:46:49] Loaded most recent local full block      number=1736134 hash=7094e2…23b319 td=3235361<br/>INFO [02-08|20:46:49] Loaded most recent local fast block      number=1736134 hash=7094e2…23b319 td=3235361<br/>INFO [02-08|20:46:49] Loaded local transaction journal         transactions=0 dropped=0<br/>INFO [02-08|20:46:49] Regenerated local transaction journal    transactions=0 accounts=0<br/>WARN [02-08|20:46:49] Blockchain not empty, fast sync disabled <br/>INFO [02-08|20:46:49] Starting P2P networking <br/>INFO [02-08|20:46:52] UDP listener up                          self=enode://df91740b5c7f74a54c6a2922f25a694f0c0e4ddd35402d90ba4984d296659e7eb05d3e64e582e6ebfcebbea37db0b76966c136b9c4cc6e20891c8f2faffb42f3@[::]:30303<br/>INFO [02-08|20:46:52] RLPx listener up                         self=enode://df91740b5c7f74a54c6a2922f25a694f0c0e4ddd35402d90ba4984d296659e7eb05d3e64e582e6ebfcebbea37db0b76966c136b9c4cc6e20891c8f2faffb42f3@[::]:30303<br/>INFO [02-08|20:46:52] IPC endpoint opened: /Users/juanbernardotobar/Library/Ethereum/rinkeby/geth.ipc <br/>INFO [02-08|20:46:52] HTTP endpoint opened: <a class="ae lv" href="http://127.0.0.1:8545" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8545</a> <br/>Unlocking account 0xbcec0503ac99f28d009797fe320cff2f9ec7b836 | Attempt 1/3<br/>Passphrase: <br/>INFO [02-08|20:47:05] Unlocked account                         address=0xbcec0503ac99F28D009797FE320cff2f9eC7b836<br/>INFO [02-08|20:47:22] Block synchronisation started <br/>INFO [02-08|20:47:22] Imported new chain segment               blocks=2 txs=3 mgas=1.384 elapsed=10.568ms mgasps=130.935 number=1736136 hash=1d33b0…b7d586</span></pre><p id="4168" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">您可以看到块同步已经开始。如果这是你第一次这样做，可能需要一段时间。我们可以返回运行geth控制台的另一个终端窗口，查看我们是否与区块链同步:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="8fa7" class="ji jj ht lj b fv ln lo l lp lq">&gt; eth.getBalance(eth.coinbase)<br/>0<br/>&gt; eth.syncing<br/>{<br/>  currentBlock: 1735202,<br/>  highestBlock: 1735328,<br/>  knownStates: 4498825,<br/>  pulledStates: 4496052,<br/>  startingBlock: 0<br/>}<br/>&gt; eth.syncing<br/>false<br/>&gt; eth.getBalance(eth.coinbase)<br/>3000000000000000000</span></pre><p id="c4e8" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">你可能会担心，当你做<code class="eh ls lt lu lj b">eth.getBalance()</code>时，你仍然得到0，即使你已经成功地从水龙头请求乙醚。这是因为您尚未与区块链同步。正如你在上面看到的，如果当前块还在同步，命令<code class="eh ls lt lu lj b">eth.syncing</code>将返回当前块所在的位置，如果已经同步，它将返回<code class="eh ls lt lu lj b">false</code>。一旦它被同步，我们可以检查我们的平衡，看到我们有3个以太网。有了这个，我们现在可以将我们的合同部署到Rinkeby。</p><p id="aa45" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">现在，让我们回到部署合同的终端窗口，到<code class="eh ls lt lu lj b">payday2</code>目录。因为现在我们不打算部署到testrpc区块链，我们将需要改变我们的<code class="eh ls lt lu lj b">truffle.js</code>文件。让我们继续这样做吧:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="ed31" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ nano truffle.js</span></pre><p id="6e68" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">我们对其进行编辑，使其看起来像这样:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="de49" class="ji jj ht lj b fv ln lo l lp lq">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "localhost",<br/>      port: 8545,<br/>      network_id: "*" // Match any network id<br/>    },<br/>    rinkeby: {<br/>      host: "localhost", // Connect to geth on the specified<br/>      port: 8545,<br/>      from: "0xbcec0503ac99f28d009797fe320cff2f9ec7b836", // default address to use for any transaction Truffle makes during migrations<br/>      network_id: 4,<br/>      gas: 4612388 // Gas limit used for deploys<br/>    }<br/>  }<br/>};</span></pre><p id="b798" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">确保<code class="eh ls lt lu lj b">from</code>地址是您之前解锁的地址，这是将用于部署到Rinkeby的地址。你需要在这个地址有气才能展开。</p><p id="bd6a" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">让我们运行迁移:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="1ec6" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ truffle migrate --network rinkeby<br/>Using network 'rinkeby'.</span><span id="fec2" class="ji jj ht lj b fv lr lo l lp lq">Running migration: 1_initial_migration.js<br/>  Deploying Migrations...<br/>  ... 0xae1e9a5cd0f571cfea11504a71f65fb662a38ce8b25c54fe35bc0a9fccdaf205<br/>  Migrations: 0x33a968626c43dfdd963575c75d86b59cc2681286<br/>Saving successful migration to network...<br/>  ... 0xb07f7a4273dc33bd457af0104bc19a5e38d22ec4d3eca892a5db08f7e8322c1d<br/>Saving artifacts...<br/>Running migration: 1518110703_deploy_pay_day.js<br/>  Deploying PayDay...<br/>  ... 0x7b652a3325b32700f78f7c27a3aa5b5e2252f5d76f99353df20cc922581b0865<br/>  PayDay: 0x884a56a07e949ad561acbe5c1dbef2b77a9ad1da<br/>Saving successful migration to network...<br/>  ... 0x94619cc9703e8f5ae6f6b3c572cf0e5cd32897a0771029dd0d5b15e44e0f6f2f<br/>Saving artifacts...</span></pre><p id="c694" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">成功！</p><p id="a6ee" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如果您看一下底部，在<code class="eh ls lt lu lj b">PayDay:</code>之后，您将看到已部署合同的地址。你可以去https://www.rinkeby.io/#explorer<a class="ae lv" href="https://www.rinkeby.io/#explorer" rel="noopener ugc nofollow" target="_blank">输入地址，看看合同在那里。</a></p><p id="20db" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">如果我们去我们的松露控制台，我们可以看看合同的一些细节:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="bb2e" class="ji jj ht lj b fv ln lo l lp lq">Computer:payday2 home$ truffle console<br/>truffle(development)&gt; var instance = PayDay.at("0x884a56a07e949ad561acbe5c1dbef2b77a9ad1da");<br/>truffle(development)&gt; instance<br/>TruffleContract {<br/>constructor:<br/>...</span></pre><p id="6b4d" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">使用命令<code class="eh ls lt lu lj b">PayDay.at()</code>和契约的地址，我们将其保存为变量<code class="eh ls lt lu lj b">instance</code>。然后，我们输入<code class="eh ls lt lu lj b">instance</code>，我们将得到一个很长的输出，包含所有的合同细节，包括abi、字节码、地址、可用功能、使用的天然气价格等。</p><p id="60ef" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">就是这样！合同已成功部署在Rinkeby Testnet中，请在位于<a class="ae lv" href="https://www.rinkeby.io/#explorer" rel="noopener ugc nofollow" target="_blank">https://www.rinkeby.io/#explorer</a>的浏览器中键入合同地址:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="fc74" class="ji jj ht lj b fv ln lo l lp lq">0x884a56a07e949ad561acbe5c1dbef2b77a9ad1da</span></pre><p id="2eca" class="pw-post-body-paragraph kg kh ht ki b kj kz iu kl km la ix ko jt lb kq kr jx lc kt ku kb ld kw kx ky hm dt translated">您将能够查看交易、源代码和阅读合同。</p><h1 id="dab2" class="lw jj ht bd jk lx ly lz jo ma mb mc js iz md ja jw jc me jd ka jf mf jg ke mg dt translated">感谢阅读！</h1><blockquote class="mh"><p id="ba87" class="mi mj ht bd mk ml mm mn mo mp mq ky ek translated"><a class="ae lv" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="ms mt mu mv mw mx fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mr"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>