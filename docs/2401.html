<html>
<head>
<title>Advanced EOS Series — Part 9 — Payable Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级EOS系列—第9部分—应付行动</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/advanced-eos-series-part-9-payable-actions-42bf878bee36?source=collection_archive---------2-----------------------#2019-09-11">https://medium.com/coinmonks/advanced-eos-series-part-9-payable-actions-42bf878bee36?source=collection_archive---------2-----------------------#2019-09-11</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/449524b9cc8d13375b0e26acca9a6f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6NRjwS8UAP77fq8wXYeuA.jpeg"/></div></div></figure><p id="0a31" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">本系列的目的是将您需要完成的作为EOSIO区块链分布式应用程序开发人员的技能的缺失部分汇集在一起。每篇文章都是按照难度排序的，所以如果你刚刚无意中来到这里并感到迷失，我建议你从第1部分开始，一路向上。这些例子的完整代码可以在GitHub 上找到<a class="ae jz" href="https://github.com/MitchPierias/advanced-eos-examples/tree/master/09_Payable-Actions" rel="noopener ugc nofollow" target="_blank">。</a></p><div class="ka kb fm fo kc kd"><a href="https://github.com/MitchPierias/advanced-eos-examples" rel="noopener  ugc nofollow" target="_blank"><div class="ke ab ej"><div class="kf ab kg cl cj kh"><h2 class="bd hu fv z el ki eo ep kj er et hs dt translated">MitchPierias/高级-EOS-示例</h2><div class="kk l"><h3 class="bd b fv z el ki eo ep kj er et ek translated">高级EOS合同示例集。所有合同现已更新，以符合最新的…</h3></div><div class="kl l"><p class="bd b gc z el ki eo ep kj er et ek translated">github.com</p></div></div><div class="km l"><div class="kn l ko kp kq km kr iz kd"/></div></div></a></div><p id="5821" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">到目前为止，您已经成功实现了智能合同的所有功能，但是您仍然缺少一个基本部分，即接收和转移价值…</p><h2 id="36c9" class="ks kt ht bd ku kv kw kx ky kz la lb lc jm ld le lf jq lg lh li ju lj lk ll lm dt translated">让我们得到报酬</h2><p id="d81e" class="pw-post-body-paragraph jb jc ht jd b je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju lr jw jx jy hm dt translated">EOSIO网络上的情况有所不同……付款是支付给<code class="eh ls lt lu lv b">eosio.token</code>合同，而不是像其他区块链那样直接支付给合同的行为。这意味着我们需要监听对合同的支付，并提供适当的操作。别担心，这比听起来简单！我们将监听由<code class="eh ls lt lu lv b">eosio.token</code>合同发出的<code class="eh ls lt lu lv b">eosio.token::transfer</code>通知。通过用<code class="eh ls lt lu lv b">[[eosio.token::on_notify(“eosio.token::transfer”)]]</code>替换常规的<code class="eh ls lt lu lv b">[[eosio::action]</code>定义来定义我们的处理程序方法。当发生涉及您的合同帐户的令牌转移时，会发送此通知。让我们分解完整的传输通知处理程序。</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="d5e0" class="ks kt ht lv b fv me mf l mg mh">[[eosio::on_notify("eosio.token::transfer")]] <em class="mi">void </em>purchase(name user, name receiver, asset value, string memo) {</span><span id="588c" class="ks kt ht lv b fv mj mf l mg mh">   if (receiver != get_self() || caller == get_self()) return;<br/>   <br/>   eosio::symbol token_symbol("SYM", 0);<br/>   eosio::check(value.amount &gt; 0, "Insufficient value");<br/>   eosio::check(value.symbol == token_symbol, "Illegal asset symbol");<br/>   <br/>   wallet_table balances(get_self(), get_self().value);<br/>   <em class="mi">auto</em> wallet = balances.find(caller.value);<br/>   <br/>   if (wallet != balances.end()) {<br/>     balances.modify(wallet, get_self(), [&amp;](<em class="mi">auto</em> &amp;<em class="mi">row</em>) {<br/>       row.balance += value.amount;<br/>     });<br/>   } else {<br/>     balances.emplace(get_self(), [&amp;](<em class="mi">auto</em> &amp;<em class="mi">row</em>) {<br/>       row.account = caller;<br/>       row.balance = value.amount;<br/>     });<br/>   }<br/>}</span></pre><p id="cea1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">你会注意到我们的方法看起来非常类似于一个常规的动作，那是因为它是一个动作！不同之处在于，这个动作是由<code class="eh ls lt lu lv b">eosio.token</code>契约调用的<code class="eh ls lt lu lv b">INLINE_ACTION</code>调用的，而不是由公共帐户直接调用的。</p><h2 id="52ef" class="ks kt ht bd ku kv kw kx ky kz la lb lc jm ld le lf jq lg lh li ju lj lk ll lm dt translated">分解它</h2><p id="d4cd" class="pw-post-body-paragraph jb jc ht jd b je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju lr jw jx jy hm dt translated">让我们拆开每一行，看看它在做什么。方法定义包括我们对<code class="eh ls lt lu lv b">eosio.token::transfer</code>通知的订阅。我们需要处理通知中传递的所有参数。</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="04c9" class="ks kt ht lv b fv me mf l mg mh">[[eosio::on_notify("eosio.token::transfer")]] <em class="mi">void </em>purchase(name user, name receiver, asset value, string memo) {<br/>  ... contract code ...<br/>}</span></pre><p id="c876" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">第一个参数是传输发送方的<code class="eh ls lt lu lv b">eosio::name</code>值，第二个是接收方的eosio::name值。这应该是您在接收资金时的合同帐户名称，我们将在下一部分对此进行验证。最后，我们将转移值作为一个<code class="eh ls lt lu lv b">eosio::asset</code>和一个备忘录<code class="eh ls lt lu lv b">std::string</code>。</p><p id="ec35" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">好了，现在在我们做任何事情之前，我们首先需要验证发送和接收参与者是我们所期望的。是时候验证了！</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="c3c4" class="ks kt ht lv b fv me mf l mg mh">if (receiver != get_self() || caller == get_self()) return;</span></pre><p id="d66f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这一行是我们的理智检查，首先确保我们的契约<code class="eh ls lt lu lv b">get_self()</code>是预期的接收者，其次，我们的契约本身没有调用这个传输。</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="5903" class="ks kt ht lv b fv me mf l mg mh">eosio::symbol token_symbol("SYM", 0);<br/>eosio::check(value.amount &gt; 0, "Insufficient value");<br/>eosio::check(value.symbol == token_symbol, "Illegal asset symbol");</span></pre><p id="146f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们将继续验证转移的资产，首先定义令牌<code class="eh ls lt lu lv b">symbol</code>，然后检查大于零的发送值，它的<code class="eh ls lt lu lv b">symbol</code>与我们期望的相匹配。你应该在这里做你喜欢的任何其他类型的验证。您可能希望检查当前时间是否在您的资助期内，或者呼叫者是否是注册的活跃用户。</p><p id="880e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们已经验证了我们的论点，我们可以执行我们想要采取的行动。</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="44e5" class="ks kt ht lv b fv me mf l mg mh">wallet_table balances(get_self(), get_self().value);<br/><em class="mi">auto</em> wallet = balances.find(caller.value);</span></pre><p id="9664" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">首先，我们将分配我们的<code class="eh ls lt lu lv b">wallet_table</code>并搜索我们的<code class="eh ls lt lu lv b">caller</code>。这一分配现在看起来类似于<code class="eh ls lt lu lv b">multi_index</code>表上的前几节。</p><pre class="lw lx ly lz fq ma lv mb mc aw md dt"><span id="c3bc" class="ks kt ht lv b fv me mf l mg mh">if (wallet != balances.end()) {<br/>  balances.modify(wallet, get_self(), [&amp;](<em class="mi">auto</em> &amp;<em class="mi">row</em>) {<br/>    row.balance += value.amount;<br/>  });<br/>} else {<br/>  balances.emplace(get_self(), [&amp;](<em class="mi">auto</em> &amp;<em class="mi">row</em>) {<br/>    row.account = caller;<br/>    row.balance = value.amount;<br/>  });<br/>}</span></pre><p id="60df" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">最后一段代码只是检查是否找到了钱包(用户之前的转账)，然后创建一个新条目或更新现有余额。</p><p id="9c3b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">就是这样！如果您要部署到本地区块链，您还需要部署<code class="eh ls lt lu lv b">eosio.token</code>合同，然后创建和发放令牌，然后才能执行向您的帐户转账。如果您需要与<code class="eh ls lt lu lv b">eosio.token</code>合同交互的分步指南，请遵循<a class="ae jz" href="https://developers.eos.io/eosio-home/docs/token-contract" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><h2 id="ea8c" class="ks kt ht bd ku kv kw kx ky kz la lb lc jm ld le lf jq lg lh li ju lj lk ll lm dt translated">排除故障</h2><p id="ef12" class="pw-post-body-paragraph jb jc ht jd b je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju lr jw jx jy hm dt translated">在处理转账和资产时，您可能会遇到令人讨厌的错误。我无意中遇到了<code class="eh ls lt lu lv b">symbol precision mismatch</code>错误，当您试图使用不同于创建时指定的精度来发行或转移资产时，就会抛出这个错误。因此，如果我用<code class="eh ls lt lu lv b">10000.00 SYS</code>创建我的资产，那么我需要使用两个十进制精度(如<code class="eh ls lt lu lv b">12.00 SYS</code>而不是<code class="eh ls lt lu lv b">12 SYS</code>)来发布和转移。</p><h2 id="be02" class="ks kt ht bd ku kv kw kx ky kz la lb lc jm ld le lf jq lg lh li ju lj lk ll lm dt translated">下一步是什么？</h2><p id="245b" class="pw-post-body-paragraph jb jc ht jd b je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju lr jw jx jy hm dt translated">如果您希望在我分享本系列中的更多示例时得到通知，请务必单击<em class="mi"> follow </em>按钮。或者关注我的GitHub个人资料，不要忘记鼓掌并开始表示感谢。</p><div class="ka kb fm fo kc kd"><a href="https://github.com/MitchPierias/advanced-eos-examples" rel="noopener  ugc nofollow" target="_blank"><div class="ke ab ej"><div class="kf ab kg cl cj kh"><h2 class="bd hu fv z el ki eo ep kj er et hs dt translated">MitchPierias/高级-EOS-示例</h2><div class="kk l"><h3 class="bd b fv z el ki eo ep kj er et ek translated">高级EOS合同示例集。所有合同现已更新，以符合最新的…</h3></div><div class="kl l"><p class="bd b gc z el ki eo ep kj er et ek translated">github.com</p></div></div><div class="km l"><div class="mk l ko kp kq km kr iz kd"/></div></div></a></div><blockquote class="ml"><p id="b92f" class="mm mn ht bd mo mp mq mr ms mt mu jy ek translated"><a class="ae jz" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mw mx my mz na iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mv"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>