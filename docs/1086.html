<html>
<head>
<title>The call is coming from inside the house — DNS rebinding in EOSIO keosd wallet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">电话是从房子里面打来的EOSIO keosd钱包中的DNS重新绑定</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/the-call-is-coming-from-inside-the-house-dns-rebinding-in-eosio-keosd-wallet-e11deae05974?source=collection_archive---------4-----------------------#2018-07-19">https://medium.com/coinmonks/the-call-is-coming-from-inside-the-house-dns-rebinding-in-eosio-keosd-wallet-e11deae05974?source=collection_archive---------4-----------------------#2018-07-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="a028" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jo">(在我开始之前——这个bug已经被负责任地披露，并已经在EOSIO软件的</em><a class="ae jp" href="https://github.com/EOSIO/eos/releases/tag/v1.0.9" rel="noopener ugc nofollow" target="_blank"><em class="jo">1 . 0 . 9</em></a><em class="jo">及更高版本中修复，所以我强烈建议您更新)</em></p><p id="6bff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">到现在为止，我已经<a class="ae jp" href="https://www.linkedin.com/in/francoisp/" rel="noopener ugc nofollow" target="_blank">全职从事应用程序安全工作大约5年了</a>，在bug赏金成为“一件事”之前，我一直是bug赏金责任披露故事的热心读者，但不知何故，我从未参与公开的bug赏金。所以这对我来说是第一次，我很兴奋地讨论我使用<a class="ae jp" href="https://hackerone.com/eosio" rel="noopener ugc nofollow" target="_blank"> HackerOne支持的EOSIO程序</a>的经历。</p><p id="96ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在过去的几个月里，我一直在为一个了不起的团队提供InfoSec和AppSec的指导，是他们让我对EOSIO和区块链技术产生了兴趣。以前，我对加密货币(尤其是比特币)一直不太感兴趣，但当我第一次听说智能合约以及股权证明(相对于工作证明——我认为这简直是不可扩展的，是对能源的巨大浪费)时，我的AppSec蜘蛛感觉到了刺痛。盲目执行不受信任的任意代码(这些代码在点对点网络上传播)的想法非常可怕，但也非常令人兴奋，因为现代区块链提供了去中心化和共识算法的承诺。</p><p id="e67a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一个多月前，我正在编写一个脚本来自动化各种任务(比如用<a class="ae jp" href="https://developers.eos.io/eosio-nodeos/docs/accounts-and-permissions#section-multi-sig-account-custom-permissions" rel="noopener ugc nofollow" target="_blank">多签名权限</a>设置一个EOSIO账户)，我注意到连续调用<code class="eh jq jr js jt b">cleos</code>不会在每次调用时提示输入钱包密码。我可以看到<code class="eh jq jr js jt b">cleos</code>正在生成一个分离的<code class="eh jq jr js jt b">keosd</code>进程，这样它将在密码提示后保持活动15分钟(<a class="ae jp" href="https://developers.eos.io/eosio-nodeos/docs/keosd-overview" rel="noopener ugc nofollow" target="_blank">这是默认的记录行为</a>——可以在您的<code class="eh jq jr js jt b">config.ini</code>中更改)。</p><p id="75f1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">正如我所说的，我经常在<a class="ae jp" href="https://www.reddit.com/r/netsec/" rel="noopener ugc nofollow" target="_blank"> /r/netsec </a>上梳理每日安全新闻和bug赏金文章来开始我的一天，那天我在<a class="ae jp" rel="noopener" href="/@brannondorsey/attacking-private-networks-from-the-internet-with-dns-rebinding-ea7098a2d325">看到了一篇关于IOT设备</a>中DNS重新绑定的文章。这让我想起了两位Akamai安全研究人员的<a class="ae jp" href="https://www.nsec.io/schedule/#session-201865" rel="noopener ugc nofollow" target="_blank"> NorthSec 2018演讲</a>。在那次谈话中，他们<a class="ae jp" href="https://github.com/allanlw/dns-rebinding-server" rel="noopener ugc nofollow" target="_blank">讨论了他们开发的一个新工具</a>，该工具显著提高了DNS重新绑定攻击的性能和可用性。大约十年前我就听说过DNS重新绑定，但直到<a class="ju jv gr" href="https://medium.com/u/a82703d95ec2?source=post_page-----e11deae05974--------------------------------" rel="noopener" target="_blank">塔维斯·奥曼迪</a>在推特上发布了关于<a class="ae jp" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1471&amp;can=1&amp;q=dns%20rebinding&amp;colspec=ID%20Status%20Restrict%20Reported%20Vendor%20Product%20Finder%20Summary&amp;desc=3" rel="noopener ugc nofollow" target="_blank">暴雪守护进程</a>中的一个错误，以及后来关于许多<a class="ae jp" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1524&amp;can=1&amp;q=dns%20rebinding&amp;colspec=ID%20Status%20Restrict%20Reported%20Vendor%20Product%20Finder%20Summary" rel="noopener ugc nofollow" target="_blank">洪流</a> <a class="ae jp" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1447&amp;can=1&amp;q=dns%20rebinding&amp;colspec=ID%20Status%20Restrict%20Reported%20Vendor%20Product%20Finder%20Summary" rel="noopener ugc nofollow" target="_blank">客户端</a>中的相同问题，这个古老的(<a class="ae jp" href="http://sip.cs.princeton.edu/pub/oakland-paper-96.pdf" rel="noopener ugc nofollow" target="_blank">大约在1996年</a>)漏洞类别才再次成为<a class="ae jp" href="https://ret2got.wordpress.com/2018/01/19/how-your-ethereum-can-be-stolen-using-dns-rebinding/" rel="noopener ugc nofollow" target="_blank">热门</a>。</p><p id="7151" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">那天早上，我没花多长时间就把这些都加起来了……如果<code class="eh jq jr js jt b">keosd</code>容易受到DNS重新绑定的攻击，并且在密码提示后15分钟内接受EOS签名交易，那将是一个可信的远程攻击，威胁参与者可以对whales实施攻击。同一天下午，我通过使用Wireshark嗅探明文HTTP请求来测试一些基本假设，以查看请求是如何构造的，并注意到当<code class="eh jq jr js jt b">cleos</code>发送HTTP请求<code class="eh jq jr js jt b">Host</code>报头时，它不符合<a class="ae jp" href="https://tools.ietf.org/html/rfc7230#section-5.4" rel="noopener ugc nofollow" target="_blank"> RFC7230第5.4节</a>(即<code class="eh jq jr js jt b">keosd</code>监听端口<code class="eh jq jr js jt b">8900</code>未指定)…</p><figure class="jx jy jz ka fq kb fe ff paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="fe ff jw"><img src="../Images/f60ab4f8f79b171c89cb728b1f8c1a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3DnuQZpSf-rEBmko6E6aOw.png"/></div></div><figcaption class="ki kj fg fe ff kk kl bd b be z ek">Wireshark packet capture of loopback interface showing HTTP request between `cleos` and `keosd`</figcaption></figure><p id="2808" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我很快为<code class="eh jq jr js jt b">127.0.0.1 example.com</code>添加了一个<code class="eh jq jr js jt b">/etc/hosts</code>文件条目，这样我就可以使用<code class="eh jq jr js jt b">curl</code>来验证我的假设。当我输入<code class="eh jq jr js jt b">curl -X POST <a class="ae jp" href="http://example.com:8900/v1/wallet/get_public_keys" rel="noopener ugc nofollow" target="_blank">http://example.com:8900/v1/wallet/get_public_keys</a></code>并看到我的测试钱包的公钥时，我的手一定有点出汗了！一切都表明它是可以开发的。</p><pre class="jx jy jz ka fq km jt kn ko aw kp dt"><span id="2f1c" class="kq kr ht jt b fv ks kt l ku kv">$ curl -X POST <a class="ae jp" href="http://example.com:8900/v1/wallet/get_public_keys" rel="noopener ugc nofollow" target="_blank">http://example.com:8900/v1/wallet/get_public_keys</a><br/>["EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV"]</span></pre><p id="3b83" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后我考虑尝试Akamai的新工具，但是我很懒，他们的公共服务似乎没有启动。就在那时，我在GitHub 上发现了<code class="eh jq jr js jt b">whonow</code>工具<a class="ae jp" href="https://github.com/brannondorsey/whonow" rel="noopener ugc nofollow" target="_blank">，它本质上提供了相同的功能，但不需要提前部署任何特殊的东西就可以使用(</a><a class="ae jp" href="http://rebind.network" rel="noopener ugc nofollow" target="_blank">)。</a></p><p id="bd36" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我很快用一个静态公共IP启动了一个Google云计算实例，并用神奇的主机名精心制作了URL，它将首先具有可配置的和确定的DNS解析行为</p><pre class="jx jy jz ka fq km jt kn ko aw kp dt"><span id="7ed8" class="kq kr ht jt b fv ks kt l ku kv"><a class="ae jp" href="http://a.35.203.53.123.1time.127.0.0.1.20time.repeat.rebind.network:8900/" rel="noopener ugc nofollow" target="_blank">http://a.35.23.3.13.1time.127.0.0.1.5time.repeat.rebind.network:8900</a></span></pre><p id="6c03" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第一部分指定它应该解析到<code class="eh jq jr js jt b">35.23.3.13</code>一次，然后解析到<code class="eh jq jr js jt b">127.0.0.1</code>(回送，其中<code class="eh jq jr js jt b">keosd</code>在端口<code class="eh jq jr js jt b">8900</code>上等待)并在循环中重复。基本上，该工具/服务充当区域<code class="eh jq jr js jt b">rebind.network</code>的权威DNS服务器，并通过遵循域令牌中的指定算法进行解析。</p><p id="8e7d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后，我开始用<code class="eh jq jr js jt b">nginx</code>设置一个虚拟主机来监听端口<code class="eh jq jr js jt b">8900</code>，并为POC拼凑了一些难看的HTML和Javascript。</p><pre class="jx jy jz ka fq km jt kn ko aw kp dt"><span id="8fad" class="kq kr ht jt b fv ks kt l ku kv">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;script&gt;<br/>console.log("Loaded from 35.203.35.123:8900");<br/>setTimeout(function() {<br/>  fetch("/v1/wallet/get_public_keys", { method: "POST" })<br/>    .then(function(r) {<br/>      return r.json();<br/>    })<br/>    .then(function(json) {<br/>      alert(json);<br/>    });<br/>}, 30000); // Wait 30 seconds <br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="26bf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后我运行<code class="eh jq jr js jt b">cleos wallet unlock</code>15分钟解锁<code class="eh jq jr js jt b">keosd</code>钱包，并打开Chrome进行测试。</p><h1 id="cd11" class="kw kr ht bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls dt translated">万岁！</h1><figure class="jx jy jz ka fq kb fe ff paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="fe ff lt"><img src="../Images/126846dd5db19b2740419004cef98bdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3O_WXonz_WpYIqNi4JUhYw.png"/></div></div><figcaption class="ki kj fg fe ff kk kl bd b be z ek">POC screenshot showing `keosd` accepting requests (right) and a successful DNS rebinding in Chrome (left).</figcaption></figure></div><div class="ab cl lu lv hb lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hm hn ho hp hq"><h1 id="7366" class="kw kr ht bd kx ky mb la lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls dt translated">威胁建模概述</h1><figure class="jx jy jz ka fq kb fe ff paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="fe ff mg"><img src="../Images/91be0ca7af1060b5f406ac6671c92f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Aw-dNykuQeNWOEhd6BNCiA.jpeg"/></div></div></figure><p id="bb2c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们做一个餐巾纸威胁模型，首先，我们的EOS私钥位于用户机器上的磁盘上，使用从用户的密码短语导出的密钥进行加密。每当用户使用<code class="eh jq jr js jt b">cleos</code>并输入密码短语时，它会获得15分钟的宽限期来连续执行多个操作。假设这些是独立的进程，它们碰巧使用环回接口上的TCP套接字进行通信(默认情况下是端口<code class="eh jq jr js jt b">8900</code>)。如果我们考虑到信任边界是用户的机器，并且它是完全修补的，零开放端口，等等，这一切都很好。那么我们的用户是一个精明的EOS社区成员，他定期访问流行的博客，那里有来自我们的威胁参与者的恶意广告活动(或简单的博客帖子)。Javascript悄悄打开一个<code class="eh jq jr js jt b">&lt;iframe&gt;</code>，指示用户的浏览器对一个域执行DNS解析，该域的<code class="eh jq jr js jt b">SOA</code> / <code class="eh jq jr js jt b">NS</code>设置为一个神奇的DNS服务器，该服务器首先返回威胁参与者的Web服务器的IP。浏览器继续加载一些HTML和Javascript。几秒钟后，已加载且现在与威胁参与者的<code class="eh jq jr js jt b">Origin</code>相关联的同一Javascript将执行<code class="eh jq jr js jt b">fetch</code>，这将触发<strong class="is hu">第二次</strong> DNS解析(因为首先返回的<code class="eh jq jr js jt b">A</code>记录的<code class="eh jq jr js jt b">TTL</code>已经<em class="jo">过期</em>)。这一次，DNS服务器将返回<code class="eh jq jr js jt b">127.0.0.1</code>作为<code class="eh jq jr js jt b">A</code>记录。浏览器会将这个新IP“重新绑定”到当前访问的来源和Bob的你叔叔…在这一点上，威胁演员可以使用受害者机器上的活动钱包发出任意EOS交易。</p><figure class="jx jy jz ka fq kb fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/b2d27f86c164586bcd66b5291698848d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*IpRRyV0DH5AYb67kQKd3Rg.png"/></div></figure><h1 id="eba5" class="kw kr ht bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls dt translated">根本原因</h1><p id="1a15" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">那么，bug的根本原因是什么。为什么这不同于一个行为良好的守护进程监听环回？为什么这个可以被利用？正如我所说的，这仅仅是因为它没有遵循RFC7230第5.4节的<a class="ae jp" href="https://tools.ietf.org/html/rfc7230#section-5.4" rel="noopener ugc nofollow" target="_blank">——如果它至少确保处理HTTP请求并只为白名单中的<code class="eh jq jr js jt b">Host</code>返回<code class="eh jq jr js jt b">200</code>响应(例如。<code class="eh jq jr js jt b">localhost:8900</code>或<code class="eh jq jr js jt b">127.0.0.1:8900</code>……)一切都会好的。这就是在<code class="eh jq jr js jt b">1.0.9</code>中解决漏洞的基本方法(可能还有其他选择，比如进程间的相互认证，等等)。).</a></p><h1 id="e592" class="kw kr ht bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls dt translated">昆虫赏金</h1><p id="a2fc" class="pw-post-body-paragraph iq ir ht is b it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn hm dt translated">正如我所说的，这是我第一次参与公开的昆虫赏金，我对Block One给予记者的关注程度感到惊喜。我报告了这个错误，他们确认可以在不到24小时内重现我的概念证明。我们就他们计划如何解决这个问题以及应该包含在哪个版本中交换了一两次意见。</p><p id="b68d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Block One在这个bug奖金方面相当慷慨，我认为这对他们和EOS社区来说是一个很好的投资回报，因为它吸引了优秀的安全研究人员在早期解决最关键的安全bug。</p><p id="fc6c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">干杯，</p><figure class="jx jy jz ka fq kb fe ff paragraph-image"><a href="http://bit.ly/2G71Sp7"><div class="fe ff mn"><img src="../Images/449450761cd76f44f9ae574333f9e9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKX2mtg7p1lOs7JmosPLsA.png"/></div></a></figure></div></div>    
</body>
</html>