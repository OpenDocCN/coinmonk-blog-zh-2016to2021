<html>
<head>
<title>Migration from Kafka to RAFT in Hyperledegr Fabric 1.4.3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Kafka到Hyperledegr面料的RAFT迁移1.4.3</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/migration-from-kafka-to-raft-in-hyperledegr-fabric-1-4-3-6a7b893da4c8?source=collection_archive---------1-----------------------#2019-12-09">https://medium.com/coinmonks/migration-from-kafka-to-raft-in-hyperledegr-fabric-1-4-3-6a7b893da4c8?source=collection_archive---------1-----------------------#2019-12-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="288c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">点击下载<a class="ae jo" href="https://github.com/hyperledger/fabric-samples" rel="noopener ugc nofollow" target="_blank">的面料样品。请访问[安装说明]( </a><a class="ae jo" href="http://hyperledger-fabric.readthedocs.io/en/latest/install.html" rel="noopener ugc nofollow" target="_blank">链接</a>)以确保您安装了正确的先决条件。</p><p id="780e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">使用1.4.3下载最新的二进制文件和Docker映像。所有安装说明都将使用`<code class="eh jp jq jr js b">scripts/bootstrap.sh</code> ` <br/>。如果您没有找到任何<code class="eh jp jq jr js b">script/bootstrap.sh</code>`文件，请使用以下命令从fabric存储库中获取bootstrap.sh</p><p id="aed7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">curl-sS<a class="ae jo" href="https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap.sh" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/hyperledger/fabric/master/scripts/bootstrap . sh</a>-o ./scripts/bootstrap . sh</p><p id="f5da" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">#将文件模式更改为可执行文件<br/>chmod+x ./scripts/bootstrap . sh</p><p id="f830" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从结构示例目录执行以下命令。</p><p id="d1f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">。/脚本/bootstrap.sh</p><p id="b81d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">默认情况下，它将下载最新的二进制文件和最新的docker映像。如果您想下载特定的，请执行以下命令，给出特定的版本</p><p id="a4cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">。/scripts/bootstrap . sh[版本] [ca版本][第三方版本]。</p><p id="1c49" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可以看到所有的二进制文件都下载到了<code class="eh jp jq jr js b">/bin</code>文件夹。</p><p id="7897" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">转到第一个网络文件夹<code class="eh jp jq jr js b">cd first-network</code></p><p id="ad37" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在创建证书之前，请在<code class="eh jp jq jr js b">crypto-config.yaml the the </code>文件中进行以下更改，注释EnableNodeOUs: true并添加CA，如下所示(粗体)。对于版本1.4.3，cryptogen tool正在生成节点组织单元(ou ),作为订购方的客户端，对于对等方，它正在按预期创建正确的节点组织单元(作为管理员的节点OU)。</p><blockquote class="jt"><p id="f7f9" class="ju jv ht bd jw jx jy jz ka kb kc jn ek translated"><a class="ae jo" href="https://coincodecap.com" rel="noopener ugc nofollow" target="_blank">发现并回顾最佳区块链软件</a></p></blockquote><pre class="kd ke kf kg kh ki js kj kk aw kl dt"><span id="788e" class="km kn ht js b fv ko kp l kq kr">OrdererOrgs:</span><span id="1659" class="km kn ht js b fv ks kp l kq kr"># ---------------------------------------------------------------------------</span><span id="cae8" class="km kn ht js b fv ks kp l kq kr"># Orderer</span><span id="78c2" class="km kn ht js b fv ks kp l kq kr"># ---------------------------------------------------------------------------</span><span id="1dde" class="km kn ht js b fv ks kp l kq kr">- Name: Orderer</span><span id="1b18" class="km kn ht js b fv ks kp l kq kr">Domain: example.com</span><span id="d337" class="km kn ht js b fv ks kp l kq kr"># EnableNodeOUs: true</span><span id="3ed5" class="km kn ht js b fv ks kp l kq kr"><strong class="js hu">CA:</strong></span><span id="f2cf" class="km kn ht js b fv ks kp l kq kr"><strong class="js hu">OrganizationalUnit: admin</strong></span><span id="4a7c" class="km kn ht js b fv ks kp l kq kr"># ---------------------------------------------------------------------------</span><span id="8b52" class="km kn ht js b fv ks kp l kq kr"># "Specs" - See PeerOrgs below for complete description</span><span id="49a7" class="km kn ht js b fv ks kp l kq kr"># ---------------------------------------------------------------------------</span><span id="4d58" class="km kn ht js b fv ks kp l kq kr">Specs:</span><span id="e734" class="km kn ht js b fv ks kp l kq kr">- Hostname: orderer</span><span id="320e" class="km kn ht js b fv ks kp l kq kr">- Hostname: orderer2</span><span id="7548" class="km kn ht js b fv ks kp l kq kr">- Hostname: orderer3</span><span id="c21e" class="km kn ht js b fv ks kp l kq kr">- Hostname: orderer4</span><span id="155f" class="km kn ht js b fv ks kp l kq kr">- Hostname: orderer5</span><span id="a767" class="km kn ht js b fv ks kp l kq kr">Users:</span><span id="e3c0" class="km kn ht js b fv ks kp l kq kr">Count: 1</span></pre><p id="4ac2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">使用以下命令生成证书(默认使用cryptogen工具)</p><p id="bc0f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">。/byfn generate -o卡夫卡</p><p id="d169" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下一步是使用以下命令启动网络。这里我们使用状态数据库作为沙发数据库，使用Kafka zookeeper订购服务节点。</p><p id="0bea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">。/byfn.sh up -o卡夫卡-s couchdb</p><p id="9f7a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦网络启动，您将能够看到以下成功消息。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/b2b2cf2a3583b355c99e0500aea0af6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0866ZiwXsA5CpupOiBZ_A.png"/></div></div></figure><p id="3388" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过执行命令，您可以看到所有容器都在运行</p><p id="75c3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">` docker ps `或docker容器列表</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lf"><img src="../Images/4b4e6c950e512cded6bd6d3a0a312c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DP4qCnkLm6wU3sKlE3YWXg.png"/></div></div></figure></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><p id="9c80" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于任何类型的配置块更改，我们遵循以下相同的步骤。</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff ln"><img src="../Images/b16e4f2642c017428eaa699f8ecb91a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Q7HBpz951tUd3_BuN9Q5A.png"/></div></div></figure><p id="e3a0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们需要遵循以下三个步骤将Kafka迁移到RAFT</p><p id="54a2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">. 1)打开维护模式<br/> 2)将共识类型更改为etcdraft <br/> 3)关闭维护模式</p></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><p id="4272" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第一步</p><p id="10a6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">打开维护模式<br/>登录cli容器</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="66ad" class="km kn ht js b fv ko kp l kq kr">docker exec -ti cli bash</span></pre><p id="90a9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我们从v1.3升级到v1.4.3，我们需要将系统通道名设置为<code class="eh jp jq jr js b">testchainid</code>:</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="4131" class="km kn ht js b fv ko kp l kq kr">CHANNEL_NAME=testchainid</span></pre><p id="993e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我们从v1.4.1升级到v1.4.3，我们需要将系统通道名设置为<code class="eh jp jq jr js b">byfn-sys-channel</code>:</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="d73a" class="km kn ht js b fv ko kp l kq kr">CHANNEL_NAME=byfn-sys-channel</span></pre><p id="80ca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">注意:确保正确使用系统通道名</p><p id="ff79" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对mychannel执行以下命令</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="8c9c" class="km kn ht js b fv ko kp l kq kr"># export all needed env vars</span><span id="83bc" class="km kn ht js b fv ks kp l kq kr">export ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</span><span id="532b" class="km kn ht js b fv ks kp l kq kr">export CHANNEL_NAME=mychannel # make sure channel name is correct</span><span id="c07f" class="km kn ht js b fv ks kp l kq kr"># change work directories</span><span id="7ea6" class="km kn ht js b fv ks kp l kq kr">mkdir maintenance_on_$CHANNEL_NAME &amp;&amp; cd maintenance_on_$CHANNEL_NAME</span><span id="8ff1" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="e59d" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="9c7e" class="km kn ht js b fv ks kp l kq kr"># decode fetched channel config</span><span id="7b1f" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="b231" class="km kn ht js b fv ks kp l kq kr"># save old config, to calculate delta in the future</span><span id="e8d7" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span><span id="78f7" class="km kn ht js b fv ks kp l kq kr"># set maintenance mode in configs</span><span id="566c" class="km kn ht js b fv ks kp l kq kr">sed -i 's/NORMAL/MAINTENANCE/g' config_mod.json</span><span id="8c68" class="km kn ht js b fv ks kp l kq kr"># encode old config to protopuf</span><span id="993d" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="7fb9" class="km kn ht js b fv ks kp l kq kr"># encode new config to protopuf</span><span id="094f" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="96b0" class="km kn ht js b fv ks kp l kq kr"># compute delta between configs</span><span id="a9f8" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="30c2" class="km kn ht js b fv ks kp l kq kr"># decode delta config</span><span id="5d77" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="5dc8" class="km kn ht js b fv ks kp l kq kr"># wrap delta config with a header</span><span id="3552" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="5b94" class="km kn ht js b fv ks kp l kq kr"># encode wrapped config to protopuf</span><span id="9160" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="f220" class="km kn ht js b fv ks kp l kq kr"># export all needed env vars<br/>export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="ed96" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="60b2" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="f290" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="f72d" class="km kn ht js b fv ks kp l kq kr"># submit new channel config<br/>peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="8091" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">预期产出:</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="a9ea" class="km kn ht js b fv ko kp l kq kr">2019-11-26 07:15:08.563 UTC [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><span id="af07" class="km kn ht js b fv ks kp l kq kr">2019-11-26 07:15:08.711 UTC [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span></pre><p id="51be" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对系统通道也执行相同的过程。</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="6111" class="km kn ht js b fv ko kp l kq kr"># export all needed env vars</span><span id="72e2" class="km kn ht js b fv ks kp l kq kr">export CHANNEL_NAME=byfn-sys-channel</span><span id="b284" class="km kn ht js b fv ks kp l kq kr"># change work directories</span><span id="5963" class="km kn ht js b fv ks kp l kq kr">cd ..</span><span id="a702" class="km kn ht js b fv ks kp l kq kr">mkdir maintenance_on_$CHANNEL_NAME &amp;&amp; cd maintenance_on_$CHANNEL_NAME</span><span id="8515" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="e52a" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="0bee" class="km kn ht js b fv ks kp l kq kr"># decode fetched channel config</span><span id="b06a" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="3e40" class="km kn ht js b fv ks kp l kq kr"># save old config, to calculate delta in the future</span><span id="56a9" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span><span id="38b0" class="km kn ht js b fv ks kp l kq kr"># set maintenance mode in configs</span><span id="35c1" class="km kn ht js b fv ks kp l kq kr">sed -i 's/NORMAL/MAINTENANCE/g' config_mod.json</span><span id="5265" class="km kn ht js b fv ks kp l kq kr"># encode old config to protopuf</span><span id="ebd8" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="bca4" class="km kn ht js b fv ks kp l kq kr"># encode new config to protopuf</span><span id="b6e3" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="a67f" class="km kn ht js b fv ks kp l kq kr"># compute delta between configs</span><span id="4eef" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="dd5d" class="km kn ht js b fv ks kp l kq kr"># decode delta config</span><span id="0747" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="37ef" class="km kn ht js b fv ks kp l kq kr"># wrap delta config with a header</span><span id="5ff1" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"byfn-sys-channel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="238c" class="km kn ht js b fv ks kp l kq kr"># encode wrapped config to protopuf</span><span id="c271" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="1df9" class="km kn ht js b fv ks kp l kq kr"># sign channel update config</span><span id="dccf" class="km kn ht js b fv ks kp l kq kr">#peer channel signconfigtx -f config_update_in_envelope.pb</span><span id="7903" class="km kn ht js b fv ks kp l kq kr"># export all needed env vars</span><span id="a337" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="6ae2" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="997c" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="bb79" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="bf4c" class="km kn ht js b fv ks kp l kq kr"># submit new channel config</span><span id="9d10" class="km kn ht js b fv ks kp l kq kr">peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="b332" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">预期产出</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="bad4" class="km kn ht js b fv ko kp l kq kr">2019-11-26 07:22:58.069 UTC [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><span id="9272" class="km kn ht js b fv ks kp l kq kr">2019-11-26 07:22:58.221 UTC [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span></pre><p id="b7bb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">通过运行以下命令重新启动所有必需的容器</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="1271" class="km kn ht js b fv ko kp l kq kr">docker restart $(docker ps -a | grep "hyperledger/fabric" | awk '{print $1}')</span></pre><p id="42b3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">步骤2 <br/>更改配置块中的共识类型</p><p id="6a13" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">登录到cli容器</p><p id="93f8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh jp jq jr js b">docker exec -it cli bash</code></p><p id="cfdb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">执行以下命令</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="6fd4" class="km kn ht js b fv ko kp l kq kr"># export all needed env vars</span><span id="8542" class="km kn ht js b fv ks kp l kq kr">export ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</span><span id="1c2a" class="km kn ht js b fv ks kp l kq kr">export CHANNEL_NAME=mychannel</span><span id="17a6" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="2b5f" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="72c2" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="c55d" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="7e3b" class="km kn ht js b fv ks kp l kq kr"># change work directories</span><span id="18dd" class="km kn ht js b fv ks kp l kq kr">mkdir switch_to_raft_${CHANNEL_NAME} &amp;&amp; cd switch_to_raft_${CHANNEL_NAME}</span><span id="daa1" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="aea6" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="8cea" class="km kn ht js b fv ks kp l kq kr"># decode fetched channel config</span><span id="ff02" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="ea68" class="km kn ht js b fv ks kp l kq kr"># save old config, to calculate delta in the future</span><span id="64ed" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span></pre><p id="7d38" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">打开<strong class="is hu"> Config_mod.json </strong>在这个文件中做如下更新。该文件应该位于位置workdir/switch _ to _ raft _ my channel中</p><p id="5e78" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">替换config_mod.json文件中的以下块</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="0be5" class="km kn ht js b fv ko kp l kq kr">"ConsensusType": {</span><span id="cfa4" class="km kn ht js b fv ks kp l kq kr">"mod_policy": "Admins",</span><span id="3bfd" class="km kn ht js b fv ks kp l kq kr">"value": {</span><span id="2577" class="km kn ht js b fv ks kp l kq kr">"metadata": {</span><span id="9b2d" class="km kn ht js b fv ks kp l kq kr">"consenters": [</span><span id="1692" class="km kn ht js b fv ks kp l kq kr">{</span><span id="ae91" class="km kn ht js b fv ks kp l kq kr">"client_tls_cert": "LS0tLS1&lt;…&gt;LS0tLQo=",</span><span id="b98a" class="km kn ht js b fv ks kp l kq kr">"host": "orderer.example.com",</span><span id="6bdd" class="km kn ht js b fv ks kp l kq kr">"port": 7050,</span><span id="52d8" class="km kn ht js b fv ks kp l kq kr">"server_tls_cert": "LS0tLS1&lt;...&gt;tLQo="</span><span id="a6fd" class="km kn ht js b fv ks kp l kq kr">}</span><span id="fd8f" class="km kn ht js b fv ks kp l kq kr">],</span><span id="6a12" class="km kn ht js b fv ks kp l kq kr">"options": {</span><span id="8686" class="km kn ht js b fv ks kp l kq kr">"election_tick": 10,</span><span id="129c" class="km kn ht js b fv ks kp l kq kr">"heartbeat_tick": 1,</span><span id="ae9c" class="km kn ht js b fv ks kp l kq kr">"max_inflight_blocks": 5,</span><span id="0e74" class="km kn ht js b fv ks kp l kq kr">"snapshot_interval_size": 20971520,</span><span id="36b5" class="km kn ht js b fv ks kp l kq kr">"tick_interval": "500ms"</span><span id="4b11" class="km kn ht js b fv ks kp l kq kr">}</span><span id="2a09" class="km kn ht js b fv ks kp l kq kr">},</span><span id="ee9c" class="km kn ht js b fv ks kp l kq kr">"state": "STATE_MAINTENANCE",</span><span id="4e4c" class="km kn ht js b fv ks kp l kq kr">"type": "etcdraft"</span><span id="19b2" class="km kn ht js b fv ks kp l kq kr">},</span><span id="062b" class="km kn ht js b fv ks kp l kq kr">"version": "1"</span><span id="7589" class="km kn ht js b fv ks kp l kq kr">}</span></pre><p id="53ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">client_tls_cert和server_tls_cert字段实际上是相等的，并且应该包含base64编码的订购者服务证书。您可以通过在我们已经打开的CLI容器中执行以下命令来获得该值。</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="c0ac" class="km kn ht js b fv ko kp l kq kr">base64 /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt -w0 &amp;&amp; echo ""</span><span id="cc2d" class="km kn ht js b fv ks kp l kq kr"># encode old config to protopuf</span><span id="2db5" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="1d3e" class="km kn ht js b fv ks kp l kq kr"># encode new config to protopuf</span><span id="567e" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="f9ea" class="km kn ht js b fv ks kp l kq kr"># compute delta between configs</span><span id="208d" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="2cfd" class="km kn ht js b fv ks kp l kq kr"># decode delta config</span><span id="5544" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="3d76" class="km kn ht js b fv ks kp l kq kr"># wrap delta config with a header</span><span id="fc18" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="40dd" class="km kn ht js b fv ks kp l kq kr"># encode wrapped config to protobuf</span><span id="d707" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="9d29" class="km kn ht js b fv ks kp l kq kr"># sign channel update config</span><span id="3004" class="km kn ht js b fv ks kp l kq kr"># peer channel signconfigtx -f config_update_in_envelope.pb</span><span id="db4c" class="km kn ht js b fv ks kp l kq kr"># export all needed env vars</span><span id="59e4" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="b29e" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="ff5d" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="b56a" class="km kn ht js b fv ks kp l kq kr"># submit new channel config</span><span id="dfde" class="km kn ht js b fv ks kp l kq kr">peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="a291" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">预期产出</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="d0ba" class="km kn ht js b fv ko kp l kq kr">2019-11-26 07:55:38.417 UTC [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><span id="439f" class="km kn ht js b fv ks kp l kq kr">2019-11-26 07:55:38.572 UTC [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span></pre><p id="a460" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对系统通道执行上述相同的步骤</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="cabe" class="km kn ht js b fv ko kp l kq kr">export CHANNEL_NAME=byfn-sys-channel</span><span id="6993" class="km kn ht js b fv ks kp l kq kr">cd ..</span><span id="21da" class="km kn ht js b fv ks kp l kq kr"># change work directories</span><span id="90be" class="km kn ht js b fv ks kp l kq kr">mkdir switch_to_raft_${CHANNEL_NAME} &amp;&amp; cd switch_to_raft_${CHANNEL_NAME}</span><span id="7525" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="b62a" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="604a" class="km kn ht js b fv ks kp l kq kr"># decode fetched channel config</span><span id="2ea2" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="4323" class="km kn ht js b fv ks kp l kq kr"># save old config, to calculate delta in the future</span><span id="430c" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span></pre><p id="0bbb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">打开<strong class="is hu"> Config_mod.json </strong>在这个文件中做如下更新。文件应该在位置workdir/switch _ to _ raft _ byfn-sys-channel中可用</p><p id="abf1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">替换config_mod.json文件中的以下块</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="d3cf" class="km kn ht js b fv ko kp l kq kr">"ConsensusType": {</span><span id="6b5f" class="km kn ht js b fv ks kp l kq kr">"mod_policy": "Admins",</span><span id="e77a" class="km kn ht js b fv ks kp l kq kr">"value": {</span><span id="a479" class="km kn ht js b fv ks kp l kq kr">"metadata": {</span><span id="de89" class="km kn ht js b fv ks kp l kq kr">"consenters": [</span><span id="48f0" class="km kn ht js b fv ks kp l kq kr">{</span><span id="480e" class="km kn ht js b fv ks kp l kq kr">"client_tls_cert": "LS0tLS1&lt;…&gt;LS0tLQo=",</span><span id="5ce9" class="km kn ht js b fv ks kp l kq kr">"host": "orderer.example.com",</span><span id="e725" class="km kn ht js b fv ks kp l kq kr">"port": 7050,</span><span id="062a" class="km kn ht js b fv ks kp l kq kr">"server_tls_cert": "LS0tLS1&lt;...&gt;tLQo="</span><span id="f907" class="km kn ht js b fv ks kp l kq kr">}</span><span id="2d41" class="km kn ht js b fv ks kp l kq kr">],</span><span id="3828" class="km kn ht js b fv ks kp l kq kr">"options": {</span><span id="9341" class="km kn ht js b fv ks kp l kq kr">"election_tick": 10,</span><span id="53e6" class="km kn ht js b fv ks kp l kq kr">"heartbeat_tick": 1,</span><span id="df6f" class="km kn ht js b fv ks kp l kq kr">"max_inflight_blocks": 5,</span><span id="fad0" class="km kn ht js b fv ks kp l kq kr">"snapshot_interval_size": 20971520,</span><span id="0674" class="km kn ht js b fv ks kp l kq kr">"tick_interval": "500ms"</span><span id="0bf8" class="km kn ht js b fv ks kp l kq kr">}</span><span id="f279" class="km kn ht js b fv ks kp l kq kr">},</span><span id="6900" class="km kn ht js b fv ks kp l kq kr">"state": "STATE_MAINTENANCE",</span><span id="8a03" class="km kn ht js b fv ks kp l kq kr">"type": "etcdraft"</span><span id="e2f3" class="km kn ht js b fv ks kp l kq kr">},</span><span id="0577" class="km kn ht js b fv ks kp l kq kr">"version": "1"</span><span id="57ae" class="km kn ht js b fv ks kp l kq kr">}</span></pre><p id="4919" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">client_tls_cert和server_tls_cert字段实际上是相等的，并且应该包含base64编码的订购者服务证书。您可以通过在我们已经打开的CLI容器中执行以下命令来获得该值。</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="bac2" class="km kn ht js b fv ko kp l kq kr">base64 /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt -w0 &amp;&amp; echo ""</span></pre><p id="5456" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在CLI上执行以下命令</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="e67e" class="km kn ht js b fv ko kp l kq kr"># encode old config to protopuf</span><span id="883a" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="ee9b" class="km kn ht js b fv ks kp l kq kr"># encode new config to protopuf</span><span id="d974" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="214d" class="km kn ht js b fv ks kp l kq kr"># compute delta between configs</span><span id="2f1b" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="7d68" class="km kn ht js b fv ks kp l kq kr"># decode delta config</span><span id="61f5" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="dc0c" class="km kn ht js b fv ks kp l kq kr"># wrap delta config with a header</span><span id="b2a8" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"byfn-sys-channel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="4d44" class="km kn ht js b fv ks kp l kq kr"># encode wrapped config to protopuf</span><span id="07a5" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="24ad" class="km kn ht js b fv ks kp l kq kr"># sign channel update config</span><span id="3c8b" class="km kn ht js b fv ks kp l kq kr"># peer channel signconfigtx -f config_update_in_envelope.pb</span><span id="e5bf" class="km kn ht js b fv ks kp l kq kr"># export all needed env vars</span><span id="96b6" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="8f74" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="f5d7" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="6ef8" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="b0dc" class="km kn ht js b fv ks kp l kq kr"># submit new channel config</span><span id="2133" class="km kn ht js b fv ks kp l kq kr">peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="0ba0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">预期产出</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="e808" class="km kn ht js b fv ko kp l kq kr">2019-11-26 07:55:38.417 UTC [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><span id="9c0c" class="km kn ht js b fv ks kp l kq kr">2019-11-26 07:55:38.572 UTC [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span></pre><p id="f9b3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">退出CLI并重新启动所有与fabric相关的</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="9f8c" class="km kn ht js b fv ko kp l kq kr">docker restart $(docker ps -a | grep "hyperledger/fabric" | awk '{print $1}')</span></pre><p id="eb00" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">20秒后，检查订购者日志，它应该显示如下</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff lo"><img src="../Images/99f575c79050113275cdd9803f8afa3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-aDL5mpwkjsySN2J"/></div></div></figure><p id="b210" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可以搜索“etcdraft迁移检测”，你将能够看到raft订购服务的日志。</p><p id="1e9d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">步骤3 <br/>关闭维护模式</p><p id="746b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们已经更新了必要的配置，我们需要将两个通道(mychannel和sys-channel)的维护模式禁用为正常模式</p><p id="31c4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">登录到CLIcontainer</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="e149" class="km kn ht js b fv ko kp l kq kr">docker exec -it cli bash</span></pre><p id="4ce0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在CLI中运行以下代码</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="256c" class="km kn ht js b fv ko kp l kq kr"># export all needed env vars</span><span id="8617" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="1295" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="5193" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="b399" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="afc7" class="km kn ht js b fv ks kp l kq kr">export ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</span><span id="b7d6" class="km kn ht js b fv ks kp l kq kr">export CHANNEL_NAME=mychannel</span><span id="0c91" class="km kn ht js b fv ks kp l kq kr"># change working directory</span><span id="df4a" class="km kn ht js b fv ks kp l kq kr">mkdir maintenance_off_$CHANNEL_NAME &amp;&amp; cd maintenance_off_$CHANNEL_NAME</span><span id="95d4" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="397a" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="070f" class="km kn ht js b fv ks kp l kq kr"># decode current config</span><span id="7f9b" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="7c6a" class="km kn ht js b fv ks kp l kq kr"># save to perform changes in the configuration</span><span id="a051" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span><span id="5a48" class="km kn ht js b fv ks kp l kq kr"># modify new config file</span><span id="04ed" class="km kn ht js b fv ks kp l kq kr">sed -i 's/MAINTENANCE/NORMAL/g' config_mod.json</span><span id="f0c3" class="km kn ht js b fv ks kp l kq kr"># encode old config to protopuf</span><span id="1577" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="1ff1" class="km kn ht js b fv ks kp l kq kr"># encode new config to protopuf</span><span id="5dbd" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="bee9" class="km kn ht js b fv ks kp l kq kr"># compute delta in configurations</span><span id="853e" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="c547" class="km kn ht js b fv ks kp l kq kr"># decode delta</span><span id="296f" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="e6e4" class="km kn ht js b fv ks kp l kq kr"># wrap delta with header</span><span id="b8e9" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="0bc3" class="km kn ht js b fv ks kp l kq kr"># encode delta config</span><span id="a4a4" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="3c0c" class="km kn ht js b fv ks kp l kq kr"># sign config update transaction</span><span id="3404" class="km kn ht js b fv ks kp l kq kr"># peer channel signconfigtx -f config_update_in_envelope.pb</span><span id="652f" class="km kn ht js b fv ks kp l kq kr"># export needed env vars</span><span id="69fa" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="250c" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="2081" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="0563" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="c18e" class="km kn ht js b fv ks kp l kq kr"># submit channel update</span><span id="6874" class="km kn ht js b fv ks kp l kq kr">peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="c646" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对系统通道重复同样的操作</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="7b67" class="km kn ht js b fv ko kp l kq kr">export CHANNEL_NAME=byfn-sys-channel</span><span id="ffcc" class="km kn ht js b fv ks kp l kq kr">cd ..</span><span id="6c61" class="km kn ht js b fv ks kp l kq kr"># change working directories</span><span id="9ded" class="km kn ht js b fv ks kp l kq kr">mkdir maintenance_on_$CHANNEL_NAME &amp;&amp; cd maintenance_on_$CHANNEL_NAME</span><span id="c47b" class="km kn ht js b fv ks kp l kq kr"># fetch current channel config</span><span id="1709" class="km kn ht js b fv ks kp l kq kr">peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CHANNEL_NAME --tls --cafile $ORDERER_CA</span><span id="cb5f" class="km kn ht js b fv ks kp l kq kr"># decode fetched config</span><span id="ecf1" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_block.pb --type common.Block | jq .data.data[0].payload.data.config &gt; config.json</span><span id="205b" class="km kn ht js b fv ks kp l kq kr"># save config for further modifications</span><span id="c20c" class="km kn ht js b fv ks kp l kq kr">cp config.json config_mod.json</span><span id="76aa" class="km kn ht js b fv ks kp l kq kr"># modify channel config</span><span id="3cc8" class="km kn ht js b fv ks kp l kq kr">sed -i 's/MAINTENANCE/NORMAL/g' config_mod.json</span><span id="39b2" class="km kn ht js b fv ks kp l kq kr"># encode old channel config</span><span id="610e" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config.json --type common.Config --output config.pb</span><span id="1987" class="km kn ht js b fv ks kp l kq kr"># encode new channel config</span><span id="c72c" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_mod.json --type common.Config --output modified_config.pb</span><span id="1a0a" class="km kn ht js b fv ks kp l kq kr"># compute delta between configuration</span><span id="72e6" class="km kn ht js b fv ks kp l kq kr">configtxlator compute_update --channel_id $CHANNEL_NAME --original config.pb --updated modified_config.pb --output config_update.pb</span><span id="e711" class="km kn ht js b fv ks kp l kq kr"># decode delta</span><span id="db73" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate | jq . &gt; config_update.json</span><span id="771c" class="km kn ht js b fv ks kp l kq kr"># wrap delta with header</span><span id="a933" class="km kn ht js b fv ks kp l kq kr">echo '{"payload":{"header":{"channel_header":{"channel_id":"byfn-sys-channel", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . &gt; config_update_envelope.json</span><span id="2372" class="km kn ht js b fv ks kp l kq kr"># encode wrapped delta</span><span id="4836" class="km kn ht js b fv ks kp l kq kr">configtxlator proto_encode --input config_update_envelope.json --type common.Envelope --output config_update_in_envelope.pb</span><span id="a8ba" class="km kn ht js b fv ks kp l kq kr"># sign peer channel update</span><span id="a978" class="km kn ht js b fv ks kp l kq kr"># peer channel signconfigtx -f config_update_in_envelope.pb</span><span id="a706" class="km kn ht js b fv ks kp l kq kr"># export all needed env vars</span><span id="fde7" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_LOCALMSPID="OrdererMSP"</span><span id="8a02" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt</span><span id="5d5a" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp/</span><span id="db85" class="km kn ht js b fv ks kp l kq kr">export CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><span id="0343" class="km kn ht js b fv ks kp l kq kr"># submit new channel config</span><span id="4c67" class="km kn ht js b fv ks kp l kq kr">peer channel update -f config_update_in_envelope.pb -c $CHANNEL_NAME -o orderer.example.com:7050 --tls --cafile $ORDERER_CA</span></pre><p id="f353" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">退出CLI容器，并使用以下命令重新启动所有容器</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="816c" class="km kn ht js b fv ko kp l kq kr">docker restart $(docker ps -a | grep "hyperledger/fabric" | awk '{print $1}')</span></pre><p id="1ad8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">用于检查数据持久性和调用登录到</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="b730" class="km kn ht js b fv ko kp l kq kr">docker exec -ti cli bash</span></pre><p id="9f1a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">使用以下命令调用和查询链码</p><pre class="ku kv kw kx fq ki js kj kk aw kl dt"><span id="b855" class="km kn ht js b fv ko kp l kq kr"># export env vars</span><span id="891d" class="km kn ht js b fv ks kp l kq kr">export ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</span><span id="e888" class="km kn ht js b fv ks kp l kq kr">export CHANNEL_NAME=mychannel</span><span id="68f0" class="km kn ht js b fv ks kp l kq kr">export PEER0_ORG1_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span><span id="149d" class="km kn ht js b fv ks kp l kq kr">export PEER0_ORG2_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt</span><span id="aa2d" class="km kn ht js b fv ks kp l kq kr"># invoke chaincode</span><span id="c326" class="km kn ht js b fv ks kp l kq kr">peer chaincode invoke -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles $PEER0_ORG1_CA --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles $PEER0_ORG2_CA -c '{"Args":["invoke","a","b","10"]}' --tls --cafile $ORDERER_CA</span><span id="4b7b" class="km kn ht js b fv ks kp l kq kr"># query chaincode</span><span id="5f06" class="km kn ht js b fv ks kp l kq kr">peer chaincode invoke -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles $PEER0_ORG1_CA --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles $PEER0_ORG2_CA -c '{"Args":["query","a"]}' --tls --cafile $ORDERER_CA</span></pre><blockquote class="jt"><p id="40a9" class="ju jv ht bd jw jx lp lq lr ls lt jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="kd ke kf kg kh ky fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff lu"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>