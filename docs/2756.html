<html>
<head>
<title>Effective Smart Contract Testing: Developer Revert Comments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有效的智能合约测试:开发者回复评论</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/effective-smart-contract-testing-developer-revert-comments-c7a6f250df0f?source=collection_archive---------3-----------------------#2020-02-19">https://medium.com/coinmonks/effective-smart-contract-testing-developer-revert-comments-c7a6f250df0f?source=collection_archive---------3-----------------------#2020-02-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="0f58" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">气体效率，有针对性的恢复测试？如何让你的<a class="ae ji" href="https://github.com/iamdefinitelyahuman/brownie" rel="noopener ugc nofollow" target="_blank">布朗尼</a>也能吃下去！</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff jj"><img src="../Images/03654e2db806e11459a75e25b3726ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/0*fjSHZwZ7I-aa0zQQ.png"/></div></figure><p id="0568" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">测试智能契约的一个好方法是为函数的每个分支编写一个测试。考虑下面的例子:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="1f1c" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">测试<code class="eh kp kq kr ks b">adminTransfer</code>时要考虑四个分支:</p><ol class=""><li id="7c32" class="kt ku ht jt b ju jv jx jy ka kv ke kw ki kx km ky kz la lb dt translated">成功转移，核实余额已正确调整。</li><li id="fd46" class="kt ku ht jt b ju lc jx ld ka le ke lf ki lg km ky kz la lb dt translated">因为呼叫者不是所有者而失败的转移。</li><li id="8aae" class="kt ku ht jt b ju lc jx ld ka le ke lf ki lg km ky kz la lb dt translated">由于接收方不被允许而失败的一种传输。</li><li id="49aa" class="kt ku ht jt b ju lc jx ld ka le ke lf ki lg km ky kz la lb dt translated">因汇款人余额不足而失败的转账。</li></ol><p id="a5fc" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">对于给定的代码，对失败路径的测试效果有限。例如，考虑以下测试:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="c10c" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">测试通过了，但是我们不能确定由于余额不足而发生了回复。有可能<code class="eh kp kq kr ks b">accounts[2]</code>不被允许接收令牌，我们有一个错误行为产生正确结果的例子。现在，假设我们后来对契约执行了重构，并且意外地删除了对足够余额的检查。因为我们实际上并没有测试我们认为正在测试的东西，所以这个测试仍然通过了，并且我们在代码中留下了一个相当大的未被发现的bug。</p><h1 id="5ea8" class="li lj ht bd lk ll lm ln lo lp lq lr ls iz lt ja lu jc lv jd lw jf lx jg ly lz dt translated">恢复字符串救援！</h1><p id="f32a" class="pw-post-body-paragraph jr js ht jt b ju ma iu jw jx mb ix jz ka mc kc kd ke md kg kh ki me kk kl km hm dt translated">幸运的是，有一个解决方案:我们可以在require语句中添加错误字符串，并将它们包含在测试中。以下是我们更新后的代码:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="71e8" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">现在，我们更新我们的测试，专门针对预期的错误字符串:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="37ea" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">现在，我们测试通过的唯一方法是，如果对<code class="eh kp kq kr ks b">adminTransfer</code>的调用返回“余额不足”错误字符串。重构吧，朋友们，我们的测试用例是可靠的。</p><p id="40d7" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">不幸的是，使用错误字符串是有代价的。<strong class="jt hu">每一个错误字符串都会给合同部署成本</strong>增加至少20，000 gas，并且在执行该功能时会增加交易成本。由于<a class="ae ji" href="https://github.com/ethereum/EIPs/issues/170" rel="noopener ugc nofollow" target="_blank">契约大小的限制</a>，为每个<code class="eh kp kq kr ks b">require</code>和<code class="eh kp kq kr ks b">revert</code>语句包含一个错误字符串通常是不切实际的，有时甚至是不可能的。</p><p id="2839" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">所以我们面临一个艰难的决定。更好的测试用例，还是更高效的代码？</p><h1 id="b031" class="li lj ht bd lk ll lm ln lo lp lq lr ls iz lt ja lu jc lv jd lw jf lx jg ly lz dt translated">开发者回复评论拯救世界！</h1><p id="3249" class="pw-post-body-paragraph jr js ht jt b ju ma iu jw jx mb ix jz ka mc kc kd ke md kg kh ki me kk kl km hm dt translated">好消息是:我们实际上不需要做这个决定😄<a class="ae ji" href="https://github.com/iamdefinitelyahuman/brownie" rel="noopener ugc nofollow" target="_blank"> Brownie </a>允许我们将恢复字符串作为源代码注释！这些错误字符串不包含在编译的字节码中，但是在运行测试时仍然可以访问。这是两全其美的方法— <strong class="jt hu">您可以编写针对特定</strong> <code class="eh kp kq kr ks b"><strong class="jt hu">require</strong></code> <strong class="jt hu">或</strong> <code class="eh kp kq kr ks b"><strong class="jt hu">revert</strong></code> <strong class="jt hu">语句的测试，而不会影响您的契约</strong>的效率。</p><p id="9402" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">查看我们的示例代码，更新后可以利用开发人员回复注释:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="d10c" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">和更新的测试用例:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="kn ko l"/></div></figure><p id="49de" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">使用开发人员回复注释很简单。在包含潜在恢复的一行代码的末尾，添加一个以Solidity中的<code class="eh kp kq kr ks b">// dev:</code>或Vyper中的<code class="eh kp kq kr ks b"># dev:</code>开头的注释。布朗尼检测到这些评论，然后自动完成剩下的<em class="lh"/>。就这么简单！</p><h1 id="2544" class="li lj ht bd lk ll lm ln lo lp lq lr ls iz lt ja lu jc lv jd lw jf lx jg ly lz dt translated">要了解更多信息…</h1><p id="99a9" class="pw-post-body-paragraph jr js ht jt b ju ma iu jw jx mb ix jz ka mc kc kd ke md kg kh ki me kk kl km hm dt translated">查看Brownie <a class="ae ji" href="https://eth-brownie.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>以了解更多关于<a class="ae ji" href="https://eth-brownie.readthedocs.io/en/stable/tests-pytest-intro.html#developer-revert-comments" rel="noopener ugc nofollow" target="_blank">developer revert comments</a>的信息，或者更一般的关于<a class="ae ji" href="https://eth-brownie.readthedocs.io/en/stable/tests-pytest-intro.html" rel="noopener ugc nofollow" target="_blank">在Python中测试智能合约</a>的信息。</p><p id="9603" class="pw-post-body-paragraph jr js ht jt b ju jv iu jw jx jy ix jz ka kb kc kd ke kf kg kh ki kj kk kl km hm dt translated">你也可以加入Brownie Gitter频道，向其他使用Brownie进行测试的开发者提问或交流。并且，一如既往，随时可以通过<a class="ae ji" href="mailto:ben@hauser.id" rel="noopener ugc nofollow" target="_blank">电子邮件</a>或<a class="ae ji" href="https://t.me/iamdefinitelyahuman" rel="noopener ugc nofollow" target="_blank">电报</a>直接联系我。我很想收到你的来信。</p><blockquote class="mf"><p id="2302" class="mg mh ht bd mi mj mk ml mm mn mo km ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="mq mr ms mt mu jo fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff mp"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><a href="https://coincodecap.com"><div class="fe ff mv"><img src="../Images/e9dbce386c4f90837b5db529a4c87766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5fZu_SfnNF6m_BGbXlsl-A@2x.png"/></div></a></figure></div></div>    
</body>
</html>