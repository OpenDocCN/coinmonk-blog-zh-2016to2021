<html>
<head>
<title>Implementing unused variable elimination and undefined variable detection for the Solang compiler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Solang编译器实现未用变量消除和未定义变量检测</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/implementing-unused-variable-elimination-and-undefined-variable-detection-for-the-solang-compiler-73f59a626921?source=collection_archive---------11-----------------------#2021-12-06">https://medium.com/coinmonks/implementing-unused-variable-elimination-and-undefined-variable-detection-for-the-solang-compiler-73f59a626921?source=collection_archive---------11-----------------------#2021-12-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/b40fff45c110aecd40eac6f2238001ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pFzAhU7XHWEoNoWf"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@clintadair?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Clint Adair</a> on <a class="ae jf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5997" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">2021年6月，我通过Linux基金会申请了一个导师，并被接受为<a class="ae jf" href="https://github.com/hyperledger-labs/solang" rel="noopener ugc nofollow" target="_blank"> Solang编译器</a>做出贡献，并实现了未使用变量消除、未定义变量检测和公共子表达式消除。在本文中，我将解释我的未使用变量消除和未定义变量检测技术。</p><p id="c21c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Solang是一个针对Solana、Substrate和ewasm的Solidty编译器。它是用Rust编写的，使用LLVM作为后端。它允许我们在调用LLVM之前为Solidity语言编写许多优化。Solang还处于早期阶段，但是已经有了一些编译器基础设施，比如解析树、抽象语法树(AST)和控制流图的中间表示(CFG)。它也有一些优化，如不断折叠和强度减少。</p><p id="9b6e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">目前还没有未使用变量消除和未定义变量检测的实现，所以实现这一点是我作为学员的工作。第一个目标是检测未使用的变量。每个局部变量都放在一个符号表中(参见Github要点)，这样我们可以在整个代码中跟踪它的引用。</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="f15b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">反过来，存储变量在每个合同中使用变量向量来处理:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="0ec3" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在Solang的语义分析过程中，我们遍历解析树并构建抽象语法树。每当我们到达一个表达式节点时，我们可以检测到表达式中引用的任何变量。对于表达式节点，我指的是表示基本表达式的节点，如加法、减法、布尔AND等。对于表达式中的变量名，我们在符号表中查找变量名的索引，并创建一个引用变量索引的AST节点。同样，存储变量AST节点包含它在契约变量vector中的索引。</p><p id="5e10" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这些变量索引允许我们检索对这些实体的引用，这样我们就可以发出信号，表明变量已经在Solidity代码中被读取。使用上述相同的推理，我们可以在解析树遍历期间识别赋值，并利用变量节点将变量标记为已赋值。</p><p id="64a8" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">用于识别未使用变量的逻辑也可用于检测从未发出的事件定义。这里的主要区别在于事件是在<em class="kk">名称空间</em>中的事件向量中被跟踪的，如下所示。</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="f533" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在语义分析之后，我们遍历符号表、契约的变量向量和名称空间的事件向量，以识别未使用的变量和事件，并发出编译警告。</p><p id="7398" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">重要的是要提到这里有一个边缘案例。我们不能将公共契约变量标记为未使用，因为它们可以通过生成的访问函数直接访问，我们可以在区块链事务中调用该函数，即使它们在Solidity代码中没有被引用。</p><p id="8259" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在确切地知道哪些变量从未被使用过之后，我们可以实现未使用变量消除。我们的代码允许Solang从中间表示中删除以下情况:</p><ul class=""><li id="0fe6" class="kl km ht ji b jj jk jn jo jr kn jv ko jz kp kd kq kr ks kt dt translated">从未被读取或赋值的变量。</li><li id="ea57" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated">已经赋值但从未读取的变量。</li><li id="168f" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated">未使用变量的赋值，包括析构函数。</li><li id="42ec" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated">表达式中未使用变量的赋值(如<code class="eh kz la lb lc b">a = b + (c=1)</code>)</li></ul><p id="dc4e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为此，我们在代码生成期间利用了Solang的AST遍历。Solang利用这一步骤创建了控制流图(CFG)。每当我们到达一个变量声明时，我们检查符号表或契约的变量向量，以检查该声明是否应该从CFG中删除，如下要点所示:</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="5f8f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">同样，当我们到达一个赋值节点时，我们检查赋值左边的实体是否是一个从未使用过的变量。如果是这样，我们可以忽略这个任务，继续构建CFG。当表达式中存在赋值时，就会出现复杂情况(例如，<em class="kk"> a = b + (c=1) </em>)。Solang已经区分了赋值语句和赋值表达式。前者是独立的赋值命令(如<em class="kk"> a = b+1 </em>)，后者是表达式内部的赋值。这样，我们可以处理这种特殊情况，而不用担心独立的赋值。</p><p id="4d63" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果表达式中的赋值可以被删除，我们忽略它，只把右边的赋值加到CFG中。右手边和它包含的表情交织在一起。下面的代码片段显示了我们在处理赋值表达式时返回给CFG的表达式。</p><figure class="ke kf kg kh fq iu"><div class="bz el l di"><div class="ki kj l"/></div></figure><p id="3143" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">值得一提的是，并不是所有的变量都可以去掉。函数参数和返回变量不应该被删除，因为它们是契约结构的重要组成部分。公共契约变量也不应该被删除，因为我们可以通过区块链事务中的访问函数直接访问它们。</p><p id="00b9" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Solang已经有了一个可及的定义实现，用来补充一些特定于Solidity的优化。我们可以利用它来识别未定义的变量。如果一个变量已经被声明，它就是未定义的，但是没有初始化，这个未初始化的值到达一个指令，在那里变量被读取。</p><p id="92c5" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了找到未定义的变量用法，我们遍历CFG并检查哪些定义到达了我们正在分析的指令中引用的变量。如果任何引用是未定义的，我们抛出一个错误并停止编译。</p><p id="7909" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">未定义变量检测和未使用变量消除利用了Solang现有的基础设施。我导师生涯的第三个里程碑，公共子表达式消除是一个全新的编译器阶段，所以我将在另一篇文章中介绍它。</p><blockquote class="ld"><p id="3605" class="le lf ht bd lg lh li lj lk ll lm kd ek translated">加入Coinmonks <a class="ae jf" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jf" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h2 id="bd97" class="ln lo ht bd lp lq lr ls lt lu lv lw lx jr ly lz ma jv mb mc md jz me mf mg mh dt translated">另外，阅读</h2><ul class=""><li id="3621" class="kl km ht ji b jj mi jn mj jr mk jv ml jz mm kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a> | <a class="ae jf" href="https://blog.coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a> | <a class="ae jf" rel="noopener" href="/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba"> Coinrule评论</a></li><li id="4023" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694">莱杰vs n rave</a>|<a class="ae jf" rel="noopener" href="/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0">莱杰nano s vs x </a> | <a class="ae jf" rel="noopener" href="/coinmonks/binance-review-ee10d3bf3b6e">币安评论</a></li><li id="a108" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit Exchange审查</a> | <a class="ae jf" href="https://blog.coincodecap.com/bityard-reivew" rel="noopener ugc nofollow" target="_blank"> Bityard审查</a> | <a class="ae jf" href="https://blog.coincodecap.com/jet-bot-review" rel="noopener ugc nofollow" target="_blank"> Jet-Bot审查</a></li><li id="cfc6" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203">3 commas vs crypto hopper</a>|<a class="ae jf" rel="noopener" href="/coinmonks/earn-crypto-interest-b10b810fdda3">赚取秘密利息</a></li><li id="51e2" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated">最好的比特币<a class="ae jf" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae jf" rel="noopener" href="/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29"> BitBox02回顾</a></li><li id="2fe9" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630">block fi vs Celsius</a>|<a class="ae jf" rel="noopener" href="/coinmonks/hodlnaut-review-best-way-to-hodl-is-to-earn-interest-on-your-bitcoin-6658a8c19edf">Hodlnaut审核</a> | <a class="ae jf" href="https://blog.coincodecap.com/kucoin-review" rel="noopener ugc nofollow" target="_blank"> KuCoin审核</a></li><li id="1dc3" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/bitsgap-review-a-crypto-trading-bot-that-makes-easy-money-a5d88a336df2"> Bitsgap评审</a> | <a class="ae jf" rel="noopener" href="/coinmonks/quadency-review-a-crypto-trading-automation-platform-3068eaa374e1"> Quadency评审</a> | <a class="ae jf" rel="noopener" href="/coinmonks/bitbns-review-38256a07e161"> Bitbns评审</a></li><li id="4268" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">加密复制交易平台</a> | <a class="ae jf" rel="noopener" href="/coinmonks/coinmama-review-ace5641bde6e"> Coinmama审核</a></li><li id="3eb6" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度的加密交易所</a> | <a class="ae jf" rel="noopener" href="/coinmonks/bitcoin-savings-account-e65b13f92451">比特币储蓄账户</a></li><li id="a043" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" href="https://blog.coincodecap.com/okex-kucoin" rel="noopener ugc nofollow" target="_blank"> OKEx vs KuCoin </a> | <a class="ae jf" href="https://blog.coincodecap.com/celsius-alternatives" rel="noopener ugc nofollow" target="_blank">摄氏替代品</a> | <a class="ae jf" href="https://blog.coincodecap.com/buy-vechain" rel="noopener ugc nofollow" target="_blank">如何购买VeChain </a></li><li id="0c30" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" href="https://blog.coincodecap.com/binance-futures-trading" rel="noopener ugc nofollow" target="_blank">币安期货交易</a>|<a class="ae jf" href="https://blog.coincodecap.com/mudrex-3commas-etoro" rel="noopener ugc nofollow" target="_blank">3 comas vs Mudrex vs eToro</a></li><li id="8a14" class="kl km ht ji b jj ku jn kv jr kw jv kx jz ky kd kq kr ks kt dt translated"><a class="ae jf" href="https://blog.coincodecap.com/buy-monero" rel="noopener ugc nofollow" target="_blank">如何购买Monero </a> | <a class="ae jf" href="https://blog.coincodecap.com/idex-review" rel="noopener ugc nofollow" target="_blank"> IDEX评论</a> | <a class="ae jf" href="https://blog.coincodecap.com/bitkan-trading-bot" rel="noopener ugc nofollow" target="_blank"> BitKan交易机器人</a></li></ul></div></div>    
</body>
</html>