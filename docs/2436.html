<html>
<head>
<title>Store data in Ethereum by logging to reduce gas cost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过测井将数据存储在以太坊中以减少气体成本</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/store-data-in-ethereum-by-logging-to-reduce-gas-cost-b70a13884485?source=collection_archive---------0-----------------------#2019-10-06">https://medium.com/coinmonks/store-data-in-ethereum-by-logging-to-reduce-gas-cost-b70a13884485?source=collection_archive---------0-----------------------#2019-10-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="8769" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">我提出了一个现实的解决方案，使用以太坊作为公共账本</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/01e9f8bce4bdc52b08e4fdd48602b149.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nr8LVrFUMUXgE6IhTBXcMA.jpeg"/></div></div></figure></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h1 id="5924" class="kb kc ht bd kd ke kf kg kh ki kj kk kl iz km ja kn jc ko jd kp jf kq jg kr ks dt translated">问题是天然气成本和容量</h1><p id="d7fc" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">使用以太坊作为公共账本，我们将面临两个问题。第一个是燃气成本。将数据存储到存储器是最昂贵的操作。(见<a class="ae lp" href="https://github.com/crytic/evm-opcodes" rel="noopener ugc nofollow" target="_blank">s储气成本</a>)另一个是产能。事件可靠性似乎<a class="ae lp" href="https://www.reddit.com/r/ethereum/comments/3kgxlx/in_solidity_does_bytes_have_a_maximum_length/" rel="noopener ugc nofollow" target="_blank">没有任何数据大小限制</a>，我们受到气体限制。</p><p id="9a47" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">因此，目前的以太坊不适合大数据或频繁存储。</p></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h1 id="90a9" class="kb kc ht bd kd ke kf kg kh ki kj kk kl iz km ja kn jc ko jd kp jf kq jg kr ks dt translated">以太坊是参照物，IPFS是存储</h1><p id="3399" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">在分布式存储上存储数据，比如IPFS。IPFS没有任何数据大小限制。然后，为了数据完整性，将散列存储到以太坊。IPFS哈希真的很小，所以这有助于节省天然气成本。这是最有可能采取的解决方案。以太网的著名项目，像<a class="ae lp" href="https://github.com/OriginProtocol/origin/blob/master/packages/contracts/contracts/marketplace/V01_Marketplace.sol" rel="noopener ugc nofollow" target="_blank"> Origin Protocol </a>或者<a class="ae lp" href="https://media.consensys.net/introducing-openlaw-7a2ea410138b" rel="noopener ugc nofollow" target="_blank"> Openlaw </a>都在做。</p><p id="8fcf" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">为了进一步降低天然气成本，我们建议按事件排放存储数据。除非您从智能合约中删除数据或操作数据，否则记录就足够了。</p></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h1 id="cc25" class="kb kc ht bd kd ke kf kg kh ki kj kk kl iz km ja kn jc ko jd kp jf kq jg kr ks dt translated">你是如何实现的？</h1><p id="e467" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">我们定义下列事件。</p><pre class="jj jk jl jm fq lv lw lx ly aw lz dt"><span id="2684" class="ma kc ht lw b fv mb mc l md me">event Recorded (bytes4 indexed eventSig, uint256 indexed createdAt, bytes32 ipfsHash);</span></pre><p id="da5b" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">“eventSig”类似于事件名称。指定任意长度的字符串都没有关系。虽然最好指定固定长度的短字母以节省汽油费用。我们将“evetSig”定义为事件名称的Keccak256哈希的前4个字节。这个规则类似于'<a class="ae lp" href="https://solidity.readthedocs.io/en/v0.5.12/abi-spec.html#function-selector" rel="noopener ugc nofollow" target="_blank">功能选择器</a></p><p id="d515" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">createdAt是自我解释的。发出此事件的数据时间。</p><p id="d4f4" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">放置“ipfsHash”来指定IPFS哈希。请注意参数类型不是“字符串”。参见下面的例子，IPFS散列的长度固定为46。</p><pre class="jj jk jl jm fq lv lw lx ly aw lz dt"><span id="f4e9" class="ma kc ht lw b fv mb mc l md me">QmXbTtSAPJ545YRnLt7n7ngMa4ZTmizmznshZZjXDRhYih</span></pre><p id="960a" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated"><a class="ae lp" href="https://solidity.readthedocs.io/en/v0.5.12/abi-spec.html#types" rel="noopener ugc nofollow" target="_blank">根据solidity specific，</a>字符串数据编码为utf8，因此IPFS哈希为46字节大小。</p><p id="6da6" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated"><a class="ae lp" href="https://solidity.readthedocs.io/en/v0.5.12/abi-spec.html#formal-specification-of-the-encoding" rel="noopener ugc nofollow" target="_blank">根据solidity specific </a>，该字符串数据消耗64个字节的存储空间，因为18个字节用尾随零字节填充到32个字节的长度。然后我们用base58解码IPFS哈希。(<a class="ae lp" href="https://ethereum.stackexchange.com/questions/44506/ipfs-hash-algorithm" rel="noopener ugc nofollow" target="_blank">最初，IPFS散列串是base58编码的</a>)base58解码的IPFS散列是32字节大小，因此我们实现了减少32字节。这有助于节省燃气成本。</p></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h1 id="293d" class="kb kc ht bd kd ke kf kg kh ki kj kk kl iz km ja kn jc ko jd kp jf kq jg kr ks dt translated">示例实现</h1><p id="51df" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">这是实现示例。</p><p id="66e7" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">不应存储不必要的日志，以便只有被允许的人才能发出“记录的”事件。因此，我们设置了“onlyWhitelistAdmin”修饰符。</p><pre class="jj jk jl jm fq lv lw lx ly aw lz dt"><span id="63c4" class="ma kc ht lw b fv mb mc l md me">import 'openzeppelin-solidity/contracts/access/roles/WhitelistAdminRole.sol';<br/><br/>event Recorded (bytes4 indexed eventSig, uint256 indexed createdAt, bytes32 ipfsHash);<br/><br/>/**<br/> * @dev Write ipfsHash as log<br/> */<br/>function writeHash(bytes4 _eventSig, bytes32 _ipfsHash) public onlyWhitelistAdmin {<br/>    emit Recorded(_eventSig, uint256(now), _ipfsHash);<br/>}</span></pre></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h1 id="c0fc" class="kb kc ht bd kd ke kf kg kh ki kj kk kl iz km ja kn jc ko jd kp jf kq jg kr ks dt translated">用例</h1><p id="2ed8" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">我们可以存储各种数据。</p><h2 id="4250" class="ma kc ht bd kd mf mg mh kh mi mj mk kl lc ml mm kn lg mn mo kp lk mp mq kr mr dt translated">案例1。证书</h2><p id="2bd2" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">存储在以太坊上的认证哈希永远不会被更改，因此我们可以验证认证的完整性。只要认证发布者运行IPFS节点，它就可以随时公开使用。</p><h2 id="5b26" class="ma kc ht bd kd mf mg mh kh mi mj mk kl lc ml mm kn lg mn mo kp lk mp mq kr mr dt translated">案例2。版权</h2><p id="972d" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">同样，我们可以公开验证版权的完整性。</p><h2 id="9926" class="ma kc ht bd kd mf mg mh kh mi mj mk kl lc ml mm kn lg mn mo kp lk mp mq kr mr dt translated">案例3。代币</h2><p id="317b" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">我们可以在此基础上发明类似ERC20的令牌协议。例如，我们将“eventSig”定义为标记名和函数的连接</p><pre class="jj jk jl jm fq lv lw lx ly aw lz dt"><span id="34c9" class="ma kc ht lw b fv mb mc l md me">eventSig =&gt; First 4 bytes of Keccak256(“token_name:transferFrom”)</span></pre><p id="46e0" class="pw-post-body-paragraph kt ku ht kv b kw lq iu ky kz lr ix lb lc ls le lf lg lt li lj lk lu lm ln lo hm dt translated">然后，我们把其他信息(从，到，价值)给IPFS</p><pre class="jj jk jl jm fq lv lw lx ly aw lz dt"><span id="98c4" class="ma kc ht lw b fv mb mc l md me">{<br/> from: 0x825bBB7fdD9292ba18913c1E784D839DbEF82BbB,<br/> to: 0x49Cb60853D1a527995F6CB784e9641bb408dBb51,<br/> value: 10000000<br/>}</span></pre></div><div class="ab cl ju jv hb jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hm hn ho hp hq"><h2 id="0f6a" class="ma kc ht bd kd mf mg mh kh mi mj mk kl lc ml mm kn lg mn mo kp lk mp mq kr mr dt translated">讨论</h2><p id="86a5" class="pw-post-body-paragraph kt ku ht kv b kw kx iu ky kz la ix lb lc ld le lf lg lh li lj lk ll lm ln lo hm dt translated">请在这里告诉我你的看法，<a class="ae lp" href="https://github.com/ethereum/EIPs/issues/2307" rel="noopener ugc nofollow" target="_blank"> ERC 2307 </a>。</p><blockquote class="ms"><p id="ebb0" class="mt mu ht bd mv mw mx my mz na nb lo ek translated"><a class="ae lp" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获得最佳软件交易</a></p></blockquote><figure class="nd ne nf ng nh jn fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nc"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>