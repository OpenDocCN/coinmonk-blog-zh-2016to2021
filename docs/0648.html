<html>
<head>
<title>Lightning Network: Import the topology to the Neo4j Graph database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">闪电网络:将拓扑导入Neo4j图形数据库</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/lightning-network-import-the-topology-to-the-neo4j-graph-database-7c38a6e93a50?source=collection_archive---------1-----------------------#2018-05-30">https://medium.com/coinmonks/lightning-network-import-the-topology-to-the-neo4j-graph-database-7c38a6e93a50?source=collection_archive---------1-----------------------#2018-05-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="a873" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt jo translated"><span class="l jp jq jr bm js jt ju jv jw di">E</span>Lightning网络中的每个节点都使用信道发现来创建和维护网络拓扑的本地视图，以便它可以发现到所需目的地的路由。使用源路由是为了让节点完全控制它们在网络中的支付路径。基于总累积费用和其他标准来选择路线。路由选择算法是一个活跃的研究领域。</p><p id="a22f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">图数据库被优化以表示通过关系彼此连接的一组节点，并用于横跨图的查询，即从特定节点(组)开始并搜索图中的模式，特别是找到两个节点之间的路径，即用于路线计算。Neo4j是著名的开源图形数据库之一。参见<a class="ae jx" href="https://neo4j.com/developer/graph-database" rel="noopener ugc nofollow" target="_blank">什么是图形数据库？</a>和<a class="ae jx" href="https://neo4j.com/developer/graph-db-vs-rdbms" rel="noopener ugc nofollow" target="_blank">从Relational到Neo4j </a>了解更多详情。</p><p id="cbef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里我们描述如何将网络拓扑的节点本地视图导出到Neo4j数据库。使用闪电网络守护程序(<a class="ae jx" href="https://github.com/lightningnetwork/lnd" rel="noopener ugc nofollow" target="_blank"> LND </a>)实现。该分支目前在<a class="ae jx" href="https://github.com/bluetegu/lnd/tree/neo4j" rel="noopener ugc nofollow" target="_blank">这里</a>可用，包括三个组件:</p><ol class=""><li id="6d6c" class="jy jz ht is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg dt translated">命令行工具<strong class="is hu"> lncli </strong>中添加了一个新命令，用于创建通道数据库的快照(网络拓扑的节点本地视图)</li><li id="9762" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg dt translated">新的命令行工具<strong class="is hu"> lnneo4j </strong>用于将快照导入neo4j数据库</li><li id="e8fa" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg dt translated">可以在Neo4j浏览器上加载的LN指南教程，用于研究闪电网络快照。</li></ol><p id="d8b6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是一项正在进行的工作，希望其中的一些内容足够有用，可以合并到主要的LND代码中。欢迎评论、更正和投稿。</p><h1 id="7875" class="km kn ht bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">例子</h1><p id="25a5" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">以下示例摘自Neo4j浏览器的LN指南(上述第3项)。</p><p id="953b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">图形数据库使用Cypher查询语言(类似于关系数据库中的SQL)。<a class="ae jx" href="https://neo4j.com/docs/developer-manual/current/cypher/" rel="noopener ugc nofollow" target="_blank"> Cypher </a>是一种声明式图形查询语言，允许表达性和高效地查询和更新图形存储。第一个示例使用以下查询:</p><p id="02a5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh lp lq lr ls b">MATCH p = (s:LNNode)-[*1..3]-(n:LNNode) WHERE s.alias = “FederalReserve” AND ALL (c IN relationships(p) WHERE c.capacity &gt; 10000000) RETURN DISTINCT n, s LIMIT 20</code></p><p id="4dea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">该查询寻找连接到具有容量大于0.1BTC的“胖”信道的“<strong class="is hu">联邦储备</strong>节点的所有节点，直到3跳远。它选择从该节点到3跳的所有路径，并过滤那些没有足够容量的路径。Neo4j浏览器以图形方式显示了下面的结果。</p><figure class="lu lv lw lx fq ly fe ff paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="fe ff lt"><img src="../Images/5c485e9097b02b36f86137e0a03138fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VIvX05rhL8wjeGGEcxIFIg.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">Nodes connected to FederalReserve with ‘fat’ channels</figcaption></figure><p id="008d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">浏览器允许您修改查询并重新提交它，这对于实验来说是理想的。<a class="ae jx" href="https://neo4j.com/docs/cypher-refcard/current/" rel="noopener ugc nofollow" target="_blank"> Neo4j Cypher Refcard </a>可能对此有用。</p><p id="7ba9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第二个示例使用内置的最短路径查询来计算节点<strong class="is hu"> LN之间的所有最短路径。BLUETEGU.CC </strong>和<strong class="is hu">块流存储</strong>节点。使用的查询是:</p><p id="87d5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh lp lq lr ls b">MATCH (s:LNNode { alias: ‘SLEEPYARK-6–11–21–2612-gf083a699’ }),(t:LNNode { alias: ‘LN.BLUETEGU.CC’ }), p = allShortestPaths((s)-[:CHANNEL*]-(t))<br/> WHERE ALL (c IN relationships(p) WHERE c.disabled = false)<br/> RETURN p</code></p><p id="a862" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">最终的图形(经过一些手动拉伸)如下所示:</p><figure class="lu lv lw lx fq ly fe ff paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="fe ff lt"><img src="../Images/8e6ecc5d34480c41dd1d94cf7c828ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3UQasq5CAgpqX-pOXUInPw.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">Shortest path between two nodes</figcaption></figure><p id="ad73" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">注意，浏览器有局限性；呈现有许多节点和关系的图很慢，因此总是建议添加一个<strong class="is hu">限制</strong>子句。它对检索的节点数量有一个内置的限制，为了呈现图形，它“补充”查询以获得关于节点之间关系的信息，即使您没有在<strong class="is hu"> RETURN </strong>子句中包含这些信息。</p><h1 id="e278" class="km kn ht bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">你自己试试吧</h1><p id="2c6f" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">安装Neo4j非常简单，因此应该不难跨越一个实例，获取channels数据库的快照并将其导入Neo4j，然后通过浏览器运行该指南。但至少在一段有限的时间内，您可以通过将下面的url复制到您的浏览器，在我的服务器上试用该浏览器:</p><pre class="lu lv lw lx fq mj ls mk ml aw mm dt"><span id="38fb" class="mn kn ht ls b fv mo mp l mq mr"><a class="ae jx" href="http://ln.bluetegu.cc:7474/browser/" rel="noopener ugc nofollow" target="_blank">http://ln.bluetegu.cc:7474/browser</a></span></pre><p id="cc62" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">并使用用户“guest”和密码“guest”。不幸的是，Neo4j的开源版本不允许控制每个用户的访问，因此访客用户也可以修改或删除数据，所以请小心行事，并理解服务器可能会停机或变慢。下面是登录屏幕。</p><figure class="lu lv lw lx fq ly fe ff paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="fe ff lt"><img src="../Images/f340d0b16d43f6a3aecd2b29d813d991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GDKFEh-z_PM0w3dHrn2NbA.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">Neo4j browser login screen</figcaption></figure><p id="bc53" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦进入，你有几个指南可以运行。如果你按“跳转到代码”，你会看到两个指南。您可以运行“电影图表”指南，引导您了解Cypher基础知识。不需要执行“创建”命令，因为数据库可能已经填充了电影图形节点。同样，不需要在结束时执行“Drop”命令。以下是可用指南的屏幕截图。</p><figure class="lu lv lw lx fq ly fe ff paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="fe ff lt"><img src="../Images/1bbb0fa07357d3d74b92af9519b5ac02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhIgxV-HH7YuqmFWrULpDw.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">Run the Movie Graph tutorial</figcaption></figure><p id="b1ea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您可以运行Lightning Network guide，方法是输入以下play命令并按run(像浏览器上的任何其他命令一样):</p><p id="7e38" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh lp lq lr ls b">:play <a class="ae jx" href="http://ln.bluetegu.cc:80/html/ln.html`" rel="noopener ugc nofollow" target="_blank">http://ln.bluetegu.cc:80/html/ln.html</a></code></p><p id="5e82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">启动闪电网络指南。指南的第一页如下所示:</p><figure class="lu lv lw lx fq ly fe ff paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="fe ff lt"><img src="../Images/2de62fb694f369207b168c35f2652ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0sx1nvH8BPT9urs5V4p-zw.png"/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">First page of the Lightning Networks tutorial</figcaption></figure><h1 id="701e" class="km kn ht bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">技术细节</h1><h2 id="cb8a" class="mn kn ht bd ko ms mt mu ks mv mw mx kw jb my mz la jf na nb le jj nc nd li ne dt translated">创建快照</h2><p id="1264" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">创建频道数据库快照的命令是:</p><p id="67d9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><code class="eh lp lq lr ls b">$ lncli snapshotchannels</code></p><p id="b159" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">它在<code class="eh lp lq lr ls b">[lnddir]/snapshot/graph/[network]/channel.db</code>创建或覆盖频道数据库的先前快照。例如，在Linux中使用比特币mainnet网络时的<code class="eh lp lq lr ls b">~/.lnd/snapshot/graph/mainnet/channel.db</code>。</p><h2 id="5b65" class="mn kn ht bd ko ms mt mu ks mv mw mx kw jb my mz la jf na nb le jj nc nd li ne dt translated">导入到Neo4j</h2><p id="e8cf" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">Neo4j命令行工具首先从以前的快照清空Neo4j数据库，然后将节点和通道导入Neo4j数据库。该工具具有以下配置选项:</p><pre class="lu lv lw lx fq mj ls mk ml aw mm dt"><span id="1d01" class="mn kn ht ls b fv mo mp l mq mr">ubuntu@ln:~$ lnneo4j — help<br/>NAME:<br/> lnneo4j — import a snapshot of your channel databse to neo4j</span><span id="f9de" class="mn kn ht ls b fv nf mp l mq mr">USAGE:<br/> lnneo4j [global options] command [command options] [arguments…]<br/> <br/>VERSION:<br/> 0.1.1 commit=<br/> <br/>COMMANDS:<br/> help, h Shows a list of commands or help for one command</span><span id="ca81" class="mn kn ht ls b fv nf mp l mq mr">GLOBAL OPTIONS:<br/> — lnddir value path to lnd’s base directory (default: “/home/ubuntu/.lnd”)<br/> — network value either mainnet, testnet, simnet, regtest, etc. (default: “mainnet”)<br/> — neouser value neo4j user for authentication (default: “neo4j”)<br/> — neopass value neo4j password for authentication. Required unless neo4j authentication is disabled, e.g. dbms.security.auth_enabled=false is set in neo4j.conf<br/> — neohost value neo4j hostname (default: “localhost”)<br/> — neoport value neo4j port number (default: “7687”)<br/> — help, -h show help<br/> — version, -v print the version</span></pre><p id="8c63" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">运行时，它提供以下输出。请注意，导入过程需要一段时间才能完成:</p><pre class="lu lv lw lx fq mj ls mk ml aw mm dt"><span id="bb43" class="mn kn ht ls b fv mo mp l mq mr">ubuntu@ln:~$ lnneo4j -neopass &lt;password&gt;<br/>[lnneo4j] 15615 nodes and channels deleted.<br/>[lnneo4j] Added 2313 detailed nodes and 6 nodes known only by public key.<br/>[lnneo4j] Added 6541 bi-directional channels, 314 uni-directional channels and 0 channels without edges dropped.<br/>ubuntu@ln:~$</span></pre><p id="a80a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">节点被分配了<strong class="is hu"> LNNode </strong>标签。收到通知的节点也标有<strong class="is hu">详细</strong>标签。每个详细节点都模拟了以下属性:</p><ul class=""><li id="31dd" class="jy jz ht is b it iu ix iy jb ka jf kb jj kc jn ng ke kf kg dt translated">公共密钥</li><li id="75af" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">别名</li><li id="9467" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">地址</li><li id="41c5" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">颜色</li><li id="2b2b" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">上次更新</li></ul><p id="ceef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">数据库中仅包含开放渠道(非待定或等待关闭渠道)。通道被建模为具有以下属性的<strong class="is hu">通道</strong>关系:</p><ul class=""><li id="95cb" class="jy jz ht is b it iu ix iy jb ka jf kb jj kc jn ng ke kf kg dt translated">channelID</li><li id="ac61" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">容量</li><li id="e89b" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">上次更新</li><li id="2300" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">有缺陷的</li><li id="ed49" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">闵TLC</li><li id="0d0d" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">feeBaseMsat</li><li id="86e0" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">timeLockDelta</li><li id="4c7f" class="jy jz ht is b it kh ix ki jb kj jf kk jj kl jn ng ke kf kg dt translated">feeRateMilliMsat</li></ul><h2 id="aff9" class="mn kn ht bd ko ms mt mu ks mv mw mx kw jb my mz la jf na nb le jj nc nd li ne dt translated">Neo4j指南</h2><p id="00bf" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">该指南是根据<a class="ae jx" href="https://neo4j.com/developer/guide-create-neo4j-browser-guide" rel="noopener ugc nofollow" target="_blank">创建自定义Neo4j浏览器指南</a>编写的。特别是，该指南是以adoc格式编写的，并被编译成html格式。从<a class="ae jx" href="https://github.com/neo4j-contrib/neo4j-guides" rel="noopener ugc nofollow" target="_blank"> neo4j-guides库</a>中编译指南所需的最小文件集被复制到项目中。在<code class="eh lp lq lr ls b">/lnd/cmd/lnneo4j/guide/readme.adoc</code>的<code class="eh lp lq lr ls b">readme.doc</code>包括如何编辑、编译和主持指南的所有细节。</p><h2 id="b195" class="mn kn ht bd ko ms mt mu ks mv mw mx kw jb my mz la jf na nb le jj nc nd li ne dt translated">安装</h2><p id="e716" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">要安装这个版本，请遵循LND项目的说明，但是使用我的存储库中的neo4j分支。我这里的详细安装说明<a class="ae jx" href="https://steemit.com/lightning/@bluetegu/lightning-network-get-your-sticker-a-detailed-howto" rel="noopener ugc nofollow" target="_blank">可能会有帮助。</a></p><pre class="lu lv lw lx fq mj ls mk ml aw mm dt"><span id="bfba" class="mn kn ht ls b fv mo mp l mq mr">ubuntu@x:~$ git clone <a class="ae jx" href="https://github.com/bluetegu/lnd" rel="noopener ugc nofollow" target="_blank">https://github.com/bluetegu/lnd</a> $GOPATH/src/github.com/lightningnetwork/lnd<br/>ubuntu@x:~$ cd $GOPATH/src/github.com/lightningnetwork/lnd<br/>ubuntu@x:~/go/src/github.com/lightningnetwork/lnd$ git checkout neo4j<br/>Branch neo4j set up to track remote branch neo4j from origin.<br/>Switched to a new branch ‘neo4j’<br/>ubuntu@x:~/go/src/github.com/lightningnetwork/lnd$ <br/>ubuntu@x:~/go/src/github.com/lightningnetwork/lnd$ dep ensure<br/>ubuntu@x:~/go/src/github.com/lightningnetwork/lnd$ go install . ./cmd/...<br/>ubuntu@x:~/go/src/github.com/lightningnetwork/lnd$</span></pre></div></div>    
</body>
</html>