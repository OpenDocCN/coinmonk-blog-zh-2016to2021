<html>
<head>
<title>Ethernaut Lvl 12 Privacy Walkthrough: How Ethereum optimizes storage to save space and be less gassy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太坊如何优化存储以节省空间和减少气体排放</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-12-privacy-walkthrough-how-ethereum-optimizes-storage-to-save-space-and-be-less-c9b01ec6adb6?source=collection_archive---------0-----------------------#2018-08-30">https://medium.com/coinmonks/ethernaut-lvl-12-privacy-walkthrough-how-ethereum-optimizes-storage-to-save-space-and-be-less-c9b01ec6adb6?source=collection_archive---------0-----------------------#2018-08-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一个围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank"> Zeppelin </a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>的<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">为了解决这个问题，让我们更深入地了解以太坊如何优化数据存储。但首先，确保您知道如何读取区块链上的存储，即在前面的<a class="ae ji" rel="noopener" href="/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f">示例</a>中。</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff kf"><img src="../Images/74e628c6b6d38d6b0b8bed2e5a32e553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wY8Si-mt_QZWqg0jnEDw8A.jpeg"/></div></div><figcaption class="kr ks fg fe ff kt ku bd b be z ek">If you’re doing Ethernaut out of order, first check out <a class="ae ji" rel="noopener" href="/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f">how to read Ethereum private variables</a></figcaption></figure><h1 id="1949" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">以太坊如何优化数据存储</h1><p id="d500" class="pw-post-body-paragraph jj jk ht jl b jm ln iu jo jp lo ix jr js lp ju jv jw lq jy jz ka lr kc kd ke hm dt translated">从Solidity <a class="ae ji" href="https://solidity.readthedocs.io/en/v0.4.24/miscellaneous.html" rel="noopener ugc nofollow" target="_blank"> docs </a>中，我们得到这个定义:</p><blockquote class="ls"><p id="3486" class="lt lu ht bd lv lw lx ly lz ma mb ke ek translated">静态大小的变量(除了映射和动态大小的数组类型之外的所有变量)从位置<code class="eh mc md me mf b">0</code>开始连续地放置在存储中。根据以下规则，如果可能，需要少于32字节的多个项目被打包到单个存储槽中</p></blockquote><h2 id="53cd" class="mg kw ht bd kx mh mi mj lb mk ml mm lf js mn mo lh jw mp mq lj ka mr ms ll mt dt translated">让我们来分析一下</h2><p id="4cfe" class="pw-post-body-paragraph jj jk ht jl b jm ln iu jo jp lo ix jr js lp ju jv jw lq jy jz ka lr kc kd ke hm dt translated">这是一个低效存储使用的示例。请注意，像<code class="eh mc md me mf b">boolVar</code>和<code class="eh mc md me mf b">bytes4Var</code>这样较小的变量没有按顺序初始化，当它们可以被打包在一起时，使用<em class="mu">新的槽0和2 </em>:</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff mv"><img src="../Images/a970810c1bf7250624e3f123eee4cc96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g3odw8DHxmw0YPrhqDf3oA.jpeg"/></div></div></figure><p id="1cbc" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">一个更有效的存储方法是<strong class="jl hu">顺序地</strong>声明<code class="eh mc md me mf b">bool</code> (1字节大小)和<code class="eh mc md me mf b">bytes4</code> (4字节大小)变量。然后，EVM将这两个有效地打包到一个存储插槽中。</p><p id="c3b9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">同样，在<code class="eh mc md me mf b">Object</code> <code class="eh mc md me mf b">struct</code>中，更有效的方法是将两个<code class="eh mc md me mf b">uint8</code>打包在一起，占用1个槽。这样，Object的所有未来实例只需要2个槽来存储，而不是3个。存储优化在结构中尤其重要，因为存储可能会快速增长:</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff mv"><img src="../Images/a6d6ad4ea5fcafc0c6f660657c0ce18a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zl3EkleTiPQEssEsu44MuA.jpeg"/></div></div></figure><p id="09f9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><strong class="jl hu">注意:</strong>插槽从右到左索引为0。<code class="eh mc md me mf b">Bytes4Var</code>是在boolVar之后初始化的，所以它存储在boolVar的左边，距离boolVar正好1个字节。</p><h2 id="e6c7" class="mg kw ht bd kx mh mw mj lb mk mx mm lf js my mo lh jw mz mq lj ka na ms ll mt dt translated">例外情况:</h2><p id="974c" class="pw-post-body-paragraph jj jk ht jl b jm ln iu jo jp lo ix jr js lp ju jv jw lq jy jz ka lr kc kd ke hm dt translated">1.<strong class="jl hu"> </strong> <code class="eh mc md me mf b"><strong class="jl hu">constants</strong></code>不存放在仓库里。根据以太坊<a class="ae ji" href="https://solidity.readthedocs.io/en/latest/contracts.html#constants" rel="noopener ugc nofollow" target="_blank">文档</a>，编译器没有为<code class="eh mc md me mf b">constant</code>变量预留存储槽。这意味着您不会在任何存储插槽中找到以下内容:</p><pre class="kg kh ki kj fq nb mf nc nd aw ne dt"><span id="fe48" class="mg kw ht mf b fv nf ng l nh ni">contract A {<br/>    uint public constant number = ...; //not stored in storage<br/>}</span></pre><p id="f755" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.<code class="eh mc md me mf b"><strong class="jl hu">Mappings</strong></code>和<code class="eh mc md me mf b"><strong class="jl hu">dynamically-sized arrays</strong></code>并不拘泥于这些惯例。<em class="mu">以后会有更多关于这方面的内容。</em></p><p id="e98e" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">你现在有能力解决这一关！继续滚动查看详细的演练:</p></div><div class="ab cl nj nk hb nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="kv kw ht bd kx ky nq la lb lc nr le lf iz ns ja lh jc nt jd lj jf nu jg ll lm dt translated">详细演练</h1><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff nv"><img src="../Images/96820fe70e334b603c9b318271fda31d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*boll4C-1oxLXGl2y3esS1A.png"/></div></div></figure><p id="2de3" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">为了解决这个问题，你必须找出<code class="eh mc md me mf b">data[2]</code>中存储了什么，将其转换成一个<code class="eh mc md me mf b">bytes16</code>变量，并将其作为密钥提交给<code class="eh mc md me mf b">unlock()</code> Privacy.sol</p><p id="eee1" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated"><strong class="jl hu">先决条件</strong> : <a class="ae ji" rel="noopener" href="/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f">如何读取区块链存储</a>(甚至私有变量)。</p><p id="e8b9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">0.注意<code class="eh mc md me mf b">Privacy.sol</code>中的以下变量声明。让我们数一数这些占用的存储插槽:</p><figure class="kg kh ki kj fq kk"><div class="bz el l di"><div class="nw nx l"/></div></figure><p id="faa9" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">你应该预料到<code class="eh mc md me mf b">locked</code>、<code class="eh mc md me mf b">flattening</code>和<code class="eh mc md me mf b">denomination</code>，总共5个字节，<strong class="jl hu">只共享1个存储槽</strong>(有27个字节的空闲存储空间备用)。</p><p id="5240" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">您应该期望<code class="eh mc md me mf b">data</code>数组占用剩余的3个插槽，每个<code class="eh mc md me mf b">data[index]</code>一个插槽。</p><ol class=""><li id="23cc" class="ny nz ht jl b jm jn jp jq js oa jw ob ka oc ke od oe of og dt translated">要获取数据[2]，请读取插槽4中的存储:</li></ol><p id="c768" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在<code class="eh mc md me mf b">truffle console — network Ropsten</code>中，访问你的level实例，调用<code class="eh mc md me mf b">getStorageAt(…, 3)</code>获取数据【2】。</p><p id="484a" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.使用Remix，将<code class="eh mc md me mf b">bytes32</code>结果转换为<code class="eh mc md me mf b">bytes16</code>值。</p><p id="00a3" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.使用Remix，用bytes16值调用<code class="eh mc md me mf b">unlock()</code>来解锁这个关卡！</p></div><div class="ab cl nj nk hb nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="kv kw ht bd kx ky nq la lb lc nr le lf iz ns ja lh jc nt jd lj jf nu jg ll lm dt translated">关键安全要点</h1><ul class=""><li id="1e23" class="ny nz ht jl b jm ln jp lo js oh jw oi ka oj ke ok oe of og dt translated">一般来说，过多地使用插槽会浪费时间，尤其是当你声明的结构会产生许多实例时。记得优化储物空间以节省汽油！</li><li id="b2cf" class="ny nz ht jl b jm ol jp om js on jw oo ka op ke ok oe of og dt translated">如果不需要保持智能合约状态，将变量保存到<code class="eh mc md me mf b">memory</code>。SSTORE &lt; &gt; SLOAD是非常气体密集型的操作码。</li><li id="21bb" class="ny nz ht jl b jm ol jp om js on jw oo ka op ke ok oe of og dt translated">所有的存储在区块链上都是公开可见的，甚至是你的<code class="eh mc md me mf b">private</code>变量！</li><li id="3fb1" class="ny nz ht jl b jm ol jp om js on jw oo ka op ke ok oe of og dt translated">不要在没有散列的情况下存储密码和私钥</li></ul><h1 id="5396" class="kv kw ht bd kx ky kz la lb lc ld le lf iz lg ja lh jc li jd lj jf lk jg ll lm dt translated">更多级别</h1><div class="oq or fm fo os ot"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-11-elevator-walkthrough-how-to-abuse-solidity-interfaces-and-function-state-41005470121d"><div class="ou ab ej"><div class="ov ab ow cl cj ox"><h2 class="bd hu fv z el oy eo ep oz er et hs dt translated">Ethernaut Lvl 11电梯演练:如何滥用Solidity接口和功能状态…</h2><div class="pa l"><h3 class="bd b fv z el oy eo ep oz er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pb l"><p class="bd b gc z el oy eo ep oz er et ek translated">medium.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph kp ot"/></div></div></a></div><div class="oq or fm fo os ot"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-13-gatekeeper-1-walkthrough-how-to-calculate-smart-contract-gas-consumption-and-eb4b042d3009"><div class="ou ab ej"><div class="ov ab ow cl cj ox"><h2 class="bd hu fv z el oy eo ep oz er et hs dt translated">Ethernaut Lvl 13看门人1演练:如何计算智能合同用气量(和…</h2><div class="pa l"><h3 class="bd b fv z el oy eo ep oz er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="pb l"><p class="bd b gc z el oy eo ep oz er et ek translated">medium.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph kp ot"/></div></div></a></div><blockquote class="ls"><p id="3de7" class="lt lu ht bd lv lw pj pk pl pm pn ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="pp pq pr ps pt kk fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff po"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>