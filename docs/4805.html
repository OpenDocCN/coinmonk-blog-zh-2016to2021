<html>
<head>
<title>Solidity revert with custom error explained with example !!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用实例解释自定义错误的可靠性恢复！！</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/solidity-revert-with-custom-error-explained-with-example-d9dff8937ef4?source=collection_archive---------1-----------------------#2021-06-20">https://medium.com/coinmonks/solidity-revert-with-custom-error-explained-with-example-d9dff8937ef4?source=collection_archive---------1-----------------------#2021-06-20</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="64d3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从v0.8.4开始，Solidity引入了一种额外的方式来恢复事务。新方法允许用户定义自定义错误，并在恢复事务时传递该错误。</p><h2 id="4762" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">自定义错误</h2><p id="897a" class="pw-post-body-paragraph iq ir ht is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hm dt translated">自定义错误是使用类似于事件的语法中的<code class="eh ko kp kq kr b">error</code>语句定义的。</p><pre class="ks kt ku kv fq kw kr kx ky aw kz dt"><span id="6e69" class="jo jp ht kr b fv la lb l lc ld">error CustomErrorName(<strong class="kr hu">arg1</strong>, <strong class="kr hu">arg2</strong>);</span></pre><p id="15ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可以在合同级别或文件级别定义自定义错误。还可以在方法中使用它来恢复事务，如下所示:</p><pre class="ks kt ku kv fq kw kr kx ky aw kz dt"><span id="d1e9" class="jo jp ht kr b fv la lb l lc ld">revert CustomError(<strong class="kr hu">arg1, arg2</strong>);</span></pre><p id="6a65" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">使用<code class="eh ko kp kq kr b">revert</code>的旧方法，如<strong class="is hu"> revert() </strong>和<strong class="is hu"> revert("description") </strong>仍然有效，但带有自定义错误的revert有助于传递带有错误的动态数据，并且对于契约部署来说成本更低。</p><p id="d05d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">还可以添加Natspec文档来解释合同中的自定义错误。</p><p id="32f8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">示例</strong></p><p id="a200" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们用一个简单的例子来理解一下。如果交易中发送的值小于预设的金额，此合同将回复自定义错误。</p><pre class="ks kt ku kv fq kw kr kx ky aw kz dt"><span id="cb51" class="jo jp ht kr b fv la lb l lc ld">// SPDX-License-Identifier: GPL-3.0<br/>pragma solidity ^0.8.4;</span><span id="3315" class="jo jp ht kr b fv le lb l lc ld">/// Invalid balance to transfer. Needed `minRequired` but sent `amount`<br/>/// <a class="ae lf" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> sent sent amount.<br/>/// <a class="ae lf" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> minRequired minimum amount to send.<br/>error InvalidAmount (uint256 sent, uint256 minRequired);</span><span id="c097" class="jo jp ht kr b fv le lb l lc ld">contract TestToken {<br/>    mapping(address =&gt; uint) balances;<br/>    uint minRequired;<br/>    <br/>    constructor (uint256 _minRequired) {<br/>        minRequired = _minRequired;<br/>    }<br/>    <br/>    function list() public payable {<br/>        uint256 amount = msg.value;<br/>        if (amount &lt; minRequired) {<br/>            revert InvalidAmount({<br/>                sent: amount,<br/>                minRequired: minRequired<br/>            });<br/>        }<br/>        balances[msg.sender] += amount;<br/>    }<br/>}</span></pre><h2 id="f588" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated">使用混音进行演示</h2><p id="6a5f" class="pw-post-body-paragraph iq ir ht is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hm dt translated"><a class="ae lf" href="https://remix.ethereum.org/#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEdQTC0zLjAKcHJhZ21hIHNvbGlkaXR5IF4wLjguNDsKLy8vIEludmFsaWQgYmFsYW5jZSB0byB0cmFuc2Zlci4gTmVlZGVkIGBtaW5SZXF1aXJlZGAgYnV0IHNlbnQgYGFtb3VudGAKLy8vIEBwYXJhbSBzZW50IHNlbnQgYW1vdW50LgovLy8gQHBhcmFtIG1pblJlcXVpcmVkIG1pbmltdW0gYW1vdW50IHRvIHNlbmQuCmVycm9yIEludmFsaWRBbW91bnQgKHVpbnQyNTYgc2VudCwgdWludDI1NiBtaW5SZXF1aXJlZCk7CmNvbnRyYWN0IFRlc3RUb2tlbiB7CiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gdWludCkgYmFsYW5jZXM7CiAgICB1aW50IG1pblJlcXVpcmVkOwogICAgCiAgICBjb25zdHJ1Y3RvciAodWludDI1NiBfbWluUmVxdWlyZWQpIHsKICAgICAgICBtaW5SZXF1aXJlZCA9IF9taW5SZXF1aXJlZDsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gbGlzdCgpIHB1YmxpYyBwYXlhYmxlIHsKICAgICAgICB1aW50MjU2IGFtb3VudCA9IG1zZy52YWx1ZTsKICAgICAgICBpZiAoYW1vdW50IDwgbWluUmVxdWlyZWQpIHsKICAgICAgICAgICAgcmV2ZXJ0IEludmFsaWRBbW91bnQoewogICAgICAgICAgICAgICAgc2VudDogYW1vdW50LAogICAgICAgICAgICAgICAgbWluUmVxdWlyZWQ6IG1pblJlcXVpcmVkCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBiYWxhbmNlc1ttc2cuc2VuZGVyXSArPSBhbW91bnQ7CiAgICB9Cn0=" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">点击此处</strong> </a>将上述契约加载到Remix IDE中，以获得自定义错误的演示。</p><p id="5314" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">部署合同，运行值小于<code class="eh ko kp kq kr b">minRequired</code>的<code class="eh ko kp kq kr b">test</code>，Remix终端会出现自定义错误信息。</p><figure class="ks kt ku kv fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lg"><img src="../Images/3f025e9b7342f5ca61683096b9013546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mpes5e82283yCdAOWcr3zg.png"/></div></div></figure><h2 id="7b69" class="jo jp ht bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki dt translated"><strong class="ak">使用安全帽进行演示</strong></h2><p id="362e" class="pw-post-body-paragraph iq ir ht is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hm dt translated">将以上代码放在hardhat项目的<code class="eh ko kp kq kr b">contracts</code>目录下，编译。在<code class="eh ko kp kq kr b">scripts</code>目录中编写一个脚本，如下所示:</p><p id="c3c4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> deployAndRun.js </strong></p><pre class="ks kt ku kv fq kw kr kx ky aw kz dt"><span id="36e6" class="jo jp ht kr b fv la lb l lc ld">const hre = require("hardhat");</span><span id="47fd" class="jo jp ht kr b fv le lb l lc ld">async function main() {</span><span id="37ac" class="jo jp ht kr b fv le lb l lc ld">  // We get the contract to deploy</span><span id="175b" class="jo jp ht kr b fv le lb l lc ld">  const CError = await hre.ethers.getContractFactory("CustomError");</span><span id="3510" class="jo jp ht kr b fv le lb l lc ld">  const cerr = await CError.deploy(20);</span><span id="06e4" class="jo jp ht kr b fv le lb l lc ld">  await cerr.deployed();</span><span id="0f85" class="jo jp ht kr b fv le lb l lc ld">  console.log("CustomError deployed to:", cerr.address);</span><span id="4b6f" class="jo jp ht kr b fv le lb l lc ld">  await cerr.list({value: 16});</span><span id="5f35" class="jo jp ht kr b fv le lb l lc ld">}</span><span id="31e9" class="jo jp ht kr b fv le lb l lc ld">main()</span><span id="4d36" class="jo jp ht kr b fv le lb l lc ld">.then(() =&gt; process.exit(0))</span><span id="2ce8" class="jo jp ht kr b fv le lb l lc ld">.catch(error =&gt; {</span><span id="9b80" class="jo jp ht kr b fv le lb l lc ld">console.error(error);</span><span id="131c" class="jo jp ht kr b fv le lb l lc ld">process.exit(1);</span><span id="e59b" class="jo jp ht kr b fv le lb l lc ld">});</span></pre><p id="1618" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">运行hardhat节点并执行脚本，它显示自定义错误详细信息如下:</p><pre class="ks kt ku kv fq kw kr kx ky aw kz dt"><span id="718a" class="jo jp ht kr b fv la lb l lc ld">% npx hardhat run --network localhost scripts/deployAndRun.js</span><span id="35d6" class="jo jp ht kr b fv le lb l lc ld">CustomError deployed to: 0x5FbDB2315678afecb367f032d93F642f64180aa3</span><span id="02dd" class="jo jp ht kr b fv le lb l lc ld">ProviderError: Error: VM Exception while processing transaction: reverted with custom error 'InvalidAmount(16, 20)'</span></pre><p id="b924" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">你知道:</strong>你还可以使用Remix IDE编译和部署合同到hardhat。阅读关于<strong class="is hu"> </strong> <a class="ae lf" rel="noopener" href="/remix-ide/hardhat-integration-with-remix-eb8c30196ab1"> <strong class="is hu"> Remix IDE安全帽集成</strong> </a>。</p><p id="ce47" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">感谢阅读！！！</p><p id="af38" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">参考文献:</strong></p><ul class=""><li id="4f9c" class="lo lp ht is b it iu ix iy jb lq jf lr jj ls jn lt lu lv lw dt translated"><a class="ae lf" href="https://docs.soliditylang.org/en/v0.8.5/" rel="noopener ugc nofollow" target="_blank">https://docs.soliditylang.org/en/v0.8.5/</a></li><li id="3f62" class="lo lp ht is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw dt translated"><a class="ae lf" href="https://blog.soliditylang.org/2021/04/21/custom-errors/" rel="noopener ugc nofollow" target="_blank">https://blog.soliditylang.org/2021/04/21/custom-errors/</a></li></ul></div></div>    
</body>
</html>