<html>
<head>
<title>Ethernaut Lvl 9 King Walkthrough: How bad contracts can abuse withdrawals</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太者Lvl 9国王演练:如何糟糕的合同可以滥用提款</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-lvl-9-king-walkthrough-how-bad-contracts-can-abuse-withdrawals-db12754f359b?source=collection_archive---------0-----------------------#2018-08-26">https://medium.com/coinmonks/ethernaut-lvl-9-king-walkthrough-how-bad-contracts-can-abuse-withdrawals-db12754f359b?source=collection_archive---------0-----------------------#2018-08-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="e203" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">这是一部<a class="ae ji" rel="noopener" href="/@nicolezhu">深度系列</a>围绕<a class="ae ji" href="https://openzeppelin.org/" rel="noopener ugc nofollow" target="_blank">齐柏林</a>团队的<a class="ae ji" href="https://ethernaut.zeppelin.solutions/" rel="noopener ugc nofollow" target="_blank">智能合约安全拼图</a>。我们学习关键的可靠性概念，以便100%靠自己解决难题。</h2></div><p id="47d0" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">这个关卡需要你阻止关卡重新获得王权。</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><p id="2680" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">在之前的深入探讨中，我们<a class="ae ji" href="https://hackernoon.com/ethernaut-lvl-1-walkthrough-how-to-abuse-the-fallback-function-118057b68b56" rel="noopener ugc nofollow" target="_blank">讨论了回退功能</a>。</p><p id="6bc7" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">具体来说，每个智能合约都可以有一个简单的回退功能，以便从其他合约和钱包接收以太网。</p><p id="79a2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">每次你的契约向另一个契约发送Ethers，<strong class="jl hu">你都依赖于另一个契约的代码来处理事务并决定事务的成功</strong>。</p><blockquote class="km"><p id="7385" class="kn ko ht bd kp kq kr ks kt ku kv ke ek translated">这意味着你的<strong class="ak">有效</strong>交易可以<strong class="ak">任意失效</strong>。</p></blockquote><p id="69c5" class="pw-post-body-paragraph jj jk ht jl b jm kw iu jo jp kx ix jr js ky ju jv jw kz jy jz ka la kc kd ke hm dt translated">作为交易发送者，您总是容易受到以下情况的影响:</p><ul class=""><li id="b390" class="lb lc ht jl b jm jn jp jq js ld jw le ka lf ke lg lh li lj dt translated"><strong class="jl hu">漏洞1 </strong>:接收合同没有应付回退功能，不能接收以太网，在应付请求时会抛出错误。</li><li id="5b5b" class="lb lc ht jl b jm lk jp ll js lm jw ln ka lo ke lg lh li lj dt translated"><strong class="jl hu">漏洞二</strong>:收款合同有恶意应付款回退功能，抛出异常，使有效交易失败。</li><li id="fa93" class="lb lc ht jl b jm lk jp ll js lm jw ln ka lo ke lg lh li lj dt translated"><strong class="jl hu">漏洞三</strong>:收货合同有恶意应付功能，消耗大量燃气，使您的交易失败或超额消耗您的燃气限额。</li></ul></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="2426" class="lp lq ht bd lr ls lt lu lv lw lx ly lz iz ma ja mb jc mc jd md jf me jg mf mg dt translated">详细演练</h1><figure class="mi mj mk ml fq mm fe ff paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="fe ff mh"><img src="../Images/63ae9ebd0f37a7eefc2df3f844243ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z5_o1KyUNcMh8PqlXw4qGQ.png"/></div></div></figure><p id="eee1" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">当你将这个<code class="eh mt mu mv mw b">King.sol</code>实例提交回level时，Ethernaut会调用这个fallback函数来重新获得王权。关键是保证Ethernaut的交易失败，你才能继续称王。</p><p id="dd64" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">注意在这个回退函数内部，有一个<code class="eh mt mu mv mw b">king.transfer()</code>，如果当前王者是恶意契约，拒绝退出，这个函数就会失效。</p><figure class="mi mj mk ml fq mm"><div class="bz el l di"><div class="mx my l"/></div></figure><p id="afd2" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">为了快速解决这个问题，你可以在新合同中省略回退功能(L1)或者实现恶意回退功能(L2)。让我们实现恶意回退函数，这样我们还可以包含一个嘲讽消息。</p><blockquote class="mz na nb"><p id="0567" class="jj jk nc jl b jm jn iu jo jp jq ix jr nd jt ju jv ne jx jy jz nf kb kc kd ke hm dt translated">注意:如果你在这个级别使用混音，请给出完整的导入路径:</p><p id="328d" class="jj jk nc jl b jm jn iu jo jp jq ix jr nd jt ju jv ne jx jy jz nf kb kc kd ke hm dt translated"><code class="eh mt mu mv mw b">import ‘github.com/OpenZeppelin/zeppelin-solidity/contracts/ownership/Ownable.sol’;</code></p></blockquote><ol class=""><li id="81f3" class="lb lc ht jl b jm jn jp jq js ld jw le ka lf ke ng lh li lj dt translated">创建一个恶意契约，并在构造函数中至少植入<code class="eh mt mu mv mw b">1 Ether</code>:</li></ol><pre class="mi mj mk ml fq nh mw ni nj aw nk dt"><span id="1436" class="nl lq ht mw b fv nm nn l no np">contract BadKing {<br/>    functionBadKing() public payable {<br/>    }<br/>}</span></pre><p id="5a71" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">2.创建一个函数，让这个坏蛋成为<code class="eh mt mu mv mw b">King.sol</code>中公认的国王，确保发送至少1个以太超过当前奖励。</p><pre class="mi mj mk ml fq nh mw ni nj aw nk dt"><span id="a9fd" class="nl lq ht mw b fv nm nn l no np">function becomeKing() public {<br/>    address(king).call.value(1000000000000000000).gas(4000000)();<br/>}</span></pre><p id="c0a8" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">3.实施可立即恢复交易的应付回退功能。给它一个错误消息(可选)。</p><p id="4451" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">您的最终合同应该是这样的:</p><figure class="mi mj mk ml fq mm"><div class="bz el l di"><div class="mx my l"/></div></figure><p id="a692" class="pw-post-body-paragraph jj jk ht jl b jm jn iu jo jp jq ix jr js jt ju jv jw jx jy jz ka kb kc kd ke hm dt translated">4.最后，只需将您的<code class="eh mt mu mv mw b">King.sol</code>契约实例提交回该级别，然后等待事务失败！</p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="c35c" class="lp lq ht bd lr ls lt lu lv lw lx ly lz iz ma ja mb jc mc jd md jf me jg mf mg dt translated">关键安全要点</h1><ul class=""><li id="1e23" class="lb lc ht jl b jm nq jp nr js ns jw nt ka nu ke lg lh li lj dt translated">永远不要假设外部合同的交易会成功</li><li id="a2b6" class="lb lc ht jl b jm lk jp ll js lm jw ln ka lo ke lg lh li lj dt translated">如果您确实需要依赖事务成功来执行其他核心逻辑，请确保在客户端处理失败的事务</li></ul><h1 id="5396" class="lp lq ht bd lr ls nv lu lv lw nw ly lz iz nx ja mb jc ny jd md jf nz jg mf mg dt translated">更多级别</h1><div class="oa ob fm fo oc od"><a rel="noopener follow" target="_blank" href="/coinmonks/how-to-read-private-variables-in-contract-storage-with-truffle-ethernaut-lvl-8-walkthrough-b2382741da9f"><div class="oe ab ej"><div class="of ab og cl cj oh"><h2 class="bd hu fv z el oi eo ep oj er et hs dt translated">Ethernaut Lvl 8 Vault演练—如何读取契约存储中的“私有”变量(使用…</h2><div class="ok l"><h3 class="bd b fv z el oi eo ep oj er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="ol l"><p class="bd b gc z el oi eo ep oj er et ek translated">medium.com</p></div></div><div class="om l"><div class="on l oo op oq om or mr od"/></div></div></a></div><div class="oa ob fm fo oc od"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-lvl-10-re-entrancy-walkthrough-how-to-abuse-execution-ordering-and-reproduce-the-dao-7ec88b912c14"><div class="oe ab ej"><div class="of ab og cl cj oh"><h2 class="bd hu fv z el oi eo ep oj er et hs dt translated">以太网Lvl 10重入演练:如何滥用执行顺序和再现道…</h2><div class="ok l"><h3 class="bd b fv z el oi eo ep oj er et ek translated">这是一个围绕齐柏林团队的智能合同安全难题的深入系列。我们学习关键的可靠性概念…</h3></div><div class="ol l"><p class="bd b gc z el oi eo ep oj er et ek translated">medium.com</p></div></div><div class="om l"><div class="os l oo op oq om or mr od"/></div></div></a></div><blockquote class="km"><p id="2ea6" class="kn ko ht bd kp kq ot ou ov ow ox ke ek translated"><a class="ae ji" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="oz pa pb pc pd mm fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff oy"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>