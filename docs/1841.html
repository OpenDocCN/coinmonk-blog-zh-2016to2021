<html>
<head>
<title>Integrating Zeppelin OS with Truffle</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将齐柏林飞艇操作系统与松露相结合</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/integrating-zeppelin-os-with-truffle-841e89fa34b3?source=collection_archive---------6-----------------------#2018-11-30">https://medium.com/coinmonks/integrating-zeppelin-os-with-truffle-841e89fa34b3?source=collection_archive---------6-----------------------#2018-11-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/f5dfd3eb68684f6e23bbcc7d6006d1bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vs585rjxYEBMRVfPE9B4Lg.jpeg"/></div></div></figure><p id="7246" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="jz">tldr；使用迁移模式和齐柏林操作系统到松露的合并命令，轻松地将齐柏林操作系统集成到现有的基于松露的项目中。您可以在</em> <a class="ae ka" href="https://github.com/asselstine/zos-truffle-migrations-tutorial" rel="noopener ugc nofollow" target="_blank"> <em class="jz"> Github </em> </a>上找到教程和示例代码的镜像</p><p id="5155" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae ka" href="https://zeppelinos.org/" rel="noopener ugc nofollow" target="_blank">齐柏林飞艇操作系统</a>是一个管理合同部署、升级和打包的工具。它甚至聪明地检测并警告可升级合同中的内存结构变化。只需很少的努力，您就可以使您的所有合同都可以升级，并享受一个易于使用的命令行工具来管理它们。这很重要。</p><p id="b785" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">ZOS旨在与<a class="ae ka" href="https://truffleframework.com/" rel="noopener ugc nofollow" target="_blank">松露</a>融合；一套备受推崇的工具，允许人们轻松迁移、部署和测试智能合同。</p><h1 id="2449" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">迁移</h1><p id="015d" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">ZOS负责合同升级，但没有直接支持松露迁移。迁移很有价值，因为它们以离散的版本化步骤捕获部署逻辑。开发人员可以添加新的迁移并增量迁移他们的环境。</p><p id="d863" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">要将块菌迁移与齐柏林飞艇操作系统集成，我们需要解决两个主要问题:</p><ol class=""><li id="ef69" class="le lf ht jd b je jf ji jj jm lg jq lh ju li jy lj lk ll lm dt translated">必须由单独的“管理员”帐户使用齐柏林操作系统实例化合同。齐柏林操作系统将合同“管理员”和合同“用户”的角色分开:管理员是创建和升级目标合同的人，用户是调用原始合同功能的任何人。齐柏林飞艇称之为<a class="ae ka" href="https://blog.zeppelinos.org/the-transparent-proxy-pattern/" rel="noopener ugc nofollow" target="_blank">透明代理模式</a>。</li><li id="dc65" class="le lf ht jd b je ln ji lo jm lp jq lq ju lr jy lj lk ll lm dt translated">块菌迁移依赖于部署的迁移合同中存储的版本。如果重新创建构建工件，我们需要将<code class="eh ls lt lu lv b">zos.*.json</code>文件中的地址合并到块菌工件中。</li></ol><p id="2612" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们来完成这两个步骤。</p><h1 id="594e" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">项目设置</h1><p id="eb0c" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">完整的代码在<a class="ae ka" href="https://github.com/asselstine/zos-truffle-migrations-tutorial" rel="noopener ugc nofollow" target="_blank"> Github </a>上，但是如果你想跟着做，你可以运行这些命令来设置你的项目:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="0361" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在单独的终端启动ganache-cli:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="a5f0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在你可以跟着文章走了。</p><h1 id="6c91" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">将合同创建与特权交互分离开来</h1><p id="6f21" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">许多合同将特殊地址定义为“所有者”。合同的所有者能够使用特权管理功能:例如ERC20合同上的<code class="eh ls lt lu lv b">mint</code>。ZOS不允许代理管理员与合同进行交互，因此所有者不能部署合同。我们需要调整我们的迁移，以便单独的“代理管理员”帐户实际部署合同。</p><p id="b0c9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">拥有多个交易签名账户带来了一个额外的问题:我们现在需要在Truffle网络配置中‘解锁’多个账户。对于我们本地的<code class="eh ls lt lu lv b">ganache-cli</code>来说，这不成问题，因为前十个帐户在ganache-cli中是解锁的，但是对于Ropsten这样的测试网络，我们需要手动解锁它们。</p><h1 id="7049" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">Truffle网络配置</h1><p id="a23a" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated"><a class="ae ka" href="https://github.com/trufflesuite/truffle-hdwallet-provider" rel="noopener ugc nofollow" target="_blank">truffle-HD wallet-provider</a>允许使用一个偏移量来解锁多个地址，并将其作为第三和第四个参数:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="faaf" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们已经解锁了<code class="eh ls lt lu lv b">address[0]</code>和<code class="eh ls lt lu lv b">address[1]</code>。因为Truffle使用第一个地址来更新迁移版本，所以让我们使用第二个地址作为代理管理员。</p><h1 id="b9ab" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">迁移. sol</h1><p id="c424" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">我们要更新的第一个迁移将是每个块菌项目附带的<code class="eh ls lt lu lv b">1_initial_migration.js</code>。它部署了Truffle进行迁移版本控制所依赖的迁移契约。<code class="eh ls lt lu lv b">Migrations.sol</code>合同需要更新以与ZOS兼容。注意，我们正在使用来自<code class="eh ls lt lu lv b"><a class="ae ka" href="https://github.com/OpenZeppelin/openzeppelin-eth" rel="noopener ugc nofollow" target="_blank">openzeppelin-eth</a></code>模块的<code class="eh ls lt lu lv b">Ownable.sol</code>，它是与ZOS集成的OpenZeppelin库的一个特殊分支。</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="f4b8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来我们需要更新<code class="eh ls lt lu lv b">1_initial_migration.js</code>脚本来使用ZOS。我更喜欢使用shell命令，但是ZOS确实提供了JavaScript API。</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="5ba6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">请注意，我们使用带有<code class="eh ls lt lu lv b">accounts[0]</code>的继承函数<code class="eh ls lt lu lv b">initialize(address _owner)</code>来初始化契约。</p><h1 id="7eeb" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">CallMeMaybe.sol</h1><p id="58bf" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">为了使画面完整，让我们在迁移中需要调用函数的地方添加一个任意契约:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="1983" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们为<code class="eh ls lt lu lv b">CallMeMaybe</code>添加两个迁移，第一个创建它，第二个设置它(任意示例)。</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="344e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这演示了与Truffle的集成:我们可以像平常一样简单地引入契约构件并调用它们。</p><p id="27be" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">合同和迁移都完成了！现在让我们运行它们。</p><h1 id="61f7" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">运行迁移</h1><p id="0076" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">假设<code class="eh ls lt lu lv b">accounts[0]</code>(所有者)是<strong class="jd hu">0x 2c 1e 88 eeb 8 a1 aa 907 dcaa 141 f8a 930565637 ff 57</strong>并且<code class="eh ls lt lu lv b">accounts[1]</code>(代理管理员)是<strong class="jd hu">0x 81 ff 0179 eeb 3545 e 7d 9 A0 e 80672 ea 9 ba 88d 68817</strong>现在让我们部署我们的合同:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="4cfe" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用Truffle控制台检查名称:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><h1 id="4131" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">将地址合并回块菌工件:zos-块菌-合并</h1><p id="9f30" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">当松露建造神器被破坏并重新创建时，它们会丢失来自齐柏林飞船的所有地址信息。要将地址信息合并回文件中，你可以使用一个我写的名为<a class="ae ka" href="https://github.com/MedXProtocol/zos-truffle-merge" rel="noopener ugc nofollow" target="_blank"> zos-truffle-merge </a>的便利工具。</p><p id="2b8f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">要将Ropsten中的ZOS地址合并回工件:</p><figure class="lw lx ly lz fq iu"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="fc1b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这将把在<code class="eh ls lt lu lv b">zos.ropsten.json</code>中定义的已部署的契约地址合并到<code class="eh ls lt lu lv b">build/contracts</code>中用于网络id <code class="eh ls lt lu lv b">3</code>的块菌工件中。</p><p id="7973" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Zeppelin OS已经将该功能添加到他们的<a class="ae ka" href="https://github.com/zeppelinos/zos/issues/420" rel="noopener ugc nofollow" target="_blank"> backlog </a>中，因此该命令最终可能会被内置功能所取代。</p><h1 id="adaf" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">摘要</h1><p id="64f1" class="pw-post-body-paragraph jb jc ht jd b je kz jg jh ji la jk jl jm lb jo jp jq lc js jt ju ld jw jx jy hm dt translated">我非常喜欢与Zeppelin OS和Truffle一起工作；这两个工具是一个强大的组合。如果你是一个松露用户，我希望这篇文章能帮助你过渡到使用Zeppelin OS，因为我认为人们可以从中受益匪浅。</p></div><div class="ab cl mc md hb me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hm hn ho hp hq"><p id="a2f8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">中:<a class="mj mk gr" href="https://medium.com/u/450060e6b469?source=post_page-----841e89fa34b3--------------------------------" rel="noopener" target="_blank">布伦丹·阿塞尔斯汀</a></p><p id="24b2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">github:<a class="ae ka" href="https://github.com/asselstine" rel="noopener ugc nofollow" target="_blank">https://github.com/asselstine</a></p><p id="0a99" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">推特:<a class="ae ka" href="https://twitter.com/b_asselstine" rel="noopener ugc nofollow" target="_blank"> @b_asselstine </a></p><figure class="lw lx ly lz fq iu fe ff paragraph-image"><a href="http://bit.ly/2G71Sp7"><div class="fe ff ml"><img src="../Images/449450761cd76f44f9ae574333f9e9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKX2mtg7p1lOs7JmosPLsA.png"/></div></a><figcaption class="mm mn fg fe ff mo mp bd b be z ek"><a class="ae ka" href="http://bit.ly/2G71Sp7" rel="noopener ugc nofollow" target="_blank"><strong class="bd mq">Click to read today’s top story</strong></a></figcaption></figure></div></div>    
</body>
</html>