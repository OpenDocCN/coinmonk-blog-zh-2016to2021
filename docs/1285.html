<html>
<head>
<title>To be a winner of Ethereum gambling game, All For One, by breaking PRNG (CVE-2018–12056)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">成为以太坊赌博游戏的赢家，为所有人，通过打破PRNG(CVE-2018–12056)</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/to-be-a-winner-of-ethereum-gambling-game-all-for-one-by-breaking-prng-1ab011163d40?source=collection_archive---------4-----------------------#2018-08-10">https://medium.com/coinmonks/to-be-a-winner-of-ethereum-gambling-game-all-for-one-by-breaking-prng-1ab011163d40?source=collection_archive---------4-----------------------#2018-08-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><h1 id="2312" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">摘要</h1><p id="faeb" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我在一个以太坊赌博游戏'<a class="ae km" href="https://all-for-one.club" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hu"> All For One </strong> </a>'的智能合约中发现了一个漏洞。该游戏使用带有4个参数的<code class="eh kn ko kp kq b">keccak256()</code>函数生成随机数，例如私有变量<code class="eh kn ko kp kq b">_seed</code>、<code class="eh kn ko kp kq b">blockhash(block.number-1)</code>、<code class="eh kn ko kp kq b">block.coinbase</code>和<code class="eh kn ko kp kq b">block.difficulty</code>。它们对任何人都是公开可读的，因此攻击者可以通过预测随机数来获得奖励。</p><h1 id="6eef" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">细节</h1><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff kr"><img src="../Images/23999a5b018a47ff570eb2cfd492b0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5WHUgugwX0a9AcJ690ZHw.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">Figure 1. play() function</figcaption></figure><p id="caa3" class="pw-post-body-paragraph jo jp ht jq b jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated"><strong class="jq hu">众人为一</strong>是一款以太坊赌博游戏。如果你想参与这个游戏，你首先通过<code class="eh kn ko kp kq b">play()</code>功能在这个合约上下注0.1以太(见图1)。下注智能合约的玩家被推入数组。一段时间后，由<code class="eh kn ko kp kq b">draw()</code>功能决定谁是赢家。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff lm"><img src="../Images/26d969100774d2a9a4592fe863f4c99e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j8weSudfmp57z5wgunfzpw.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">Figure 2. draw() function. A winner is decided by a random value.</figcaption></figure><p id="d08d" class="pw-post-body-paragraph jo jp ht jq b jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated">在<code class="eh kn ko kp kq b">draw()</code>功能中，一个获胜者由一个随机数决定。图2中的红框<code class="eh kn ko kp kq b">produceRandom()</code>函数生成一个随机数并返回它。随机数是玩家数组的索引。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff ln"><img src="../Images/be2455fbced105e8e1fe4a1f0edffbb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wjxYmwn5LvJYBHCkWvUm7Q.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">Figure 3. maxRandom() function generates a random value using keccak256() function with 4 parameters.</figcaption></figure><p id="3dd4" class="pw-post-body-paragraph jo jp ht jq b jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated"><code class="eh kn ko kp kq b">produceRandom()</code>函数在第80行调用<code class="eh kn ko kp kq b">random()</code> <em class="lo"> </em>函数，所以最后<code class="eh kn ko kp kq b">maxRandom()</code>函数被调用(见图3)。在<code class="eh kn ko kp kq b">maxRandom()</code>函数中，使用带4个参数的<code class="eh kn ko kp kq b">keccak256()</code>函数生成随机数。然而，所有4个参数对任何人都是公开可读的。因此，攻击者可以预测随机数，成为赢家。</p><h1 id="28e5" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">剥削</h1><p id="a521" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在我以前的文章中，我已经多次解释了如何利用这些漏洞。如果你想知道利用它的方法，我推荐阅读我的文章，尤其是“<a class="ae km" rel="noopener" href="/@jonghyk.song/attack-on-pseudo-random-number-generator-prng-used-in-1000-guess-an-ethereum-lottery-game-7b76655f953d">攻击以太坊彩票游戏《1000 Guess》中使用的伪随机数发生器(PRNG)</a>”。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff lp"><img src="../Images/b9859d4d868b26f79a9a1ebece40a7df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j3wLkqAyDC3fF2yiM6tw7A.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">Figure 4. exploit contract</figcaption></figure><p id="3edd" class="pw-post-body-paragraph jo jp ht jq b jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated">图4显示了漏洞利用合同。攻击者为一个站点下注0.1以太网，然后可以通过使用漏洞利用合同成为赢家。</p><h1 id="f31b" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">报告</h1><p id="8afd" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">我向管理员报告了这个问题，他们给它打了补丁。他们将<code class="eh kn ko kp kq b">draw()</code>函数改为<code class="eh kn ko kp kq b">private</code>，并使用<a class="ae km" href="https://docs.oraclize.it/#ethereum" rel="noopener ugc nofollow" target="_blank">或</a>库生成随机数。</p><h1 id="4f08" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">结论</h1><p id="46a5" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在智能协定中生成随机数时，不得使用私有变量以及过去和当前块的变量。</p></div></div>    
</body>
</html>