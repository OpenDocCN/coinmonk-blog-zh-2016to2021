<html>
<head>
<title>Using Truffle framework in an advanced way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以先进的方式使用Truffle框架</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/using-truffle-framework-in-an-advanced-way-7e32c11c97a9?source=collection_archive---------7-----------------------#2018-06-26">https://medium.com/coinmonks/using-truffle-framework-in-an-advanced-way-7e32c11c97a9?source=collection_archive---------7-----------------------#2018-06-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="fe ff iq"><img src="../Images/28372af5d95fe34eeb2bb15f8fe4b501.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*P-T7USHsmPYOSBorXAqXYA.png"/></div></figure><p id="4225" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">如果你是一名区块链开发者或者正在成为一名开发者，那么你可能听说过以太坊-瑞士刀框架，叫做<a class="ae jv" href="https://truffleframework.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hu">松露</strong> </a>。以太坊还处于早期阶段，不像常规的web开发那样有很多高级工具。然而，使用Truffle，你可以更容易、更快地做事情，因为它提供了自动化的契约测试，这几乎是开发过程中的一个需求(更像是必需品)。此外，它是唯一具有某种调试功能的工具。</p><p id="2d25" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">这里有一些我们在开发过程中需要的东西，它们非常方便。如果你是一个初学者，第一次使用松露，然后再回到这里，你可能会需要这个。</p></div><div class="ab cl jw jx hb jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hm hn ho hp hq"><h1 id="300a" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated"><strong class="ak">自动部署时链接并初始化合同</strong></h1><p id="78b4" class="pw-post-body-paragraph ix iy ht iz b ja lb jc jd je lc jg jh ji ld jk jl jm le jo jp jq lf js jt ju hm dt translated">首先，您应该熟悉<a class="ae jv" href="https://truffleframework.com/docs/getting_started/migrations" rel="noopener ugc nofollow" target="_blank"> truffle migrate </a>命令，该命令不仅可以帮助您部署合同，还可以升级和重新部署已更改的合同。</p><p id="af60" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">但是那些依赖于您正在部署的其他契约的契约呢？应该使用新部署的地址更新依赖关系的合同。您可以在生产过程中手动完成这项工作，但是测试呢？让我们深入研究解决方案。</p><p id="06b8" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">例如，我们有一个名为“应用程序”的智能合同，它与存储智能合同进行交互。目标是同时部署它们，并使用存储合同的地址更新应用程序合同。</p><p id="f518" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">这里是我们的<em class="lg"> Application.sol </em>文件:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Example of Application smart contract</figcaption></figure><p id="5f17" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">我们的迁移文件:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Deployment of Application and Storage smart contracts</figcaption></figure><p id="3d12" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">上面的代码创建了4个事务:</p><ol class=""><li id="2571" class="lr ls ht iz b ja jb je jf ji lt jm lu jq lv ju lw lx ly lz dt translated">应用合同的部署</li><li id="1fbb" class="lr ls ht iz b ja ma je mb ji mc jm md jq me ju lw lx ly lz dt translated">存储合同的部署</li><li id="88b9" class="lr ls ht iz b ja ma je mb ji mc jm md jq me ju lw lx ly lz dt translated">更新应用合同中的存储地址</li><li id="a7cd" class="lr ls ht iz b ja ma je mb ji mc jm md jq me ju lw lx ly lz dt translated">更新Truffle的迁移合同，跟踪链上的迁移</li></ol><p id="3ed8" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">为了节省一些时间，您可以向应用程序契约添加构造函数，它将接受存储契约的地址作为函数参数。那么我们的例子应该是这样的:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Upgraded Application smart contract</figcaption></figure><p id="7910" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><em class="lg">存储</em>合同的迁移:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Simple deployment of Storage smart contract</figcaption></figure><p id="379a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><em class="lg">应用</em>合同的迁移:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Simple deployment of Application smart contract</figcaption></figure><p id="f6b4" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">这样，我们将比以前少做一笔交易，从而节省一些汽油。</p></div><div class="ab cl jw jx hb jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hm hn ho hp hq"><h1 id="6817" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated"><strong class="ak">测试基于时间的功能</strong></h1><p id="9adb" class="pw-post-body-paragraph ix iy ht iz b ja lb jc jd je lc jg jh ji ld jk jl jm le jo jp jq lf js jt ju hm dt translated">你经常会发现自己在编写依赖于时间的代码，比如在取款/存款之前检查是否已经过了一段时间。如果你用的是<a class="ae jv" href="https://github.com/trufflesuite/ganache-cli" rel="noopener ugc nofollow" target="_blank"> <em class="lg"> ganache-cli </em> </a>(例如。testrpc)用于本地网络和测试，那么你可以在你的测试中使用特殊的rpc函数<em class="lg"> evm_increasetime </em>。</p><p id="943a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">下面是它的使用方法:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Helper function to increase network timestamp</figcaption></figure><p id="498c" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">要在测试期间等待24小时，您可以调用它:</p><blockquote class="mf mg mh"><p id="22fa" class="ix iy lg iz b ja jb jc jd je jf jg jh mi jj jk jl mj jn jo jp mk jr js jt ju hm dt translated">await utils . increase time(24 * 60 * 60)；</p></blockquote></div><div class="ab cl jw jx hb jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hm hn ho hp hq"><h1 id="f97e" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dt translated"><strong class="ak">摩卡多记者</strong></h1><p id="c341" class="pw-post-body-paragraph ix iy ht iz b ja lb jc jd je lc jg jh ji ld jk jl jm le jo jp jq lf js jt ju hm dt translated">如果你像我们一样使用某种CI(持续集成)，比如<a class="ae jv" href="https://circleci.com/" rel="noopener ugc nofollow" target="_blank"> CircleCi </a>，你可能希望你的测试结果是某种通用的格式。大多数CI工具需要JUnit XML格式的测试结果。</p><p id="4c3a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">默认情况下，Truffle使用<em class="lg"> spec </em> reporter将测试结果很好地格式化到控制台窗口上。您可以很容易地将其更改为<em class="lg"> mocha-junit-reporter </em>，只需运行"<em class="lg">NPM install mocha-JUnit-reporter "</em>并在您的<em class="lg"> truffle.js </em>文件中添加以下mocha配置条目:</p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Added parameter for mocha in truffle.js file</figcaption></figure><p id="18a2" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">这种解决方案对于CI来说是不错的，但是对于在本地运行测试，然后检查xml文件以获得测试结果来说，这种解决方案不是很用户友好。幸好有个东西叫<a class="ae jv" href="https://github.com/stanleyhlng/mocha-multi-reporters" rel="noopener ugc nofollow" target="_blank"> <em class="lg">摩卡——多记者</em> </a> <em class="lg">。</em></p><p id="ee84" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">要配置多个报表程序，首先安装依赖关系:</p><ul class=""><li id="00a2" class="lr ls ht iz b ja jb je jf ji lt jm lu jq lv ju ml lx ly lz dt translated"><em class="lg">NPM install--save-dev mocha-multi-reporters mocha-JUnit-reporter</em></li></ul><p id="940b" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">将下面的摩卡配置添加到你的<em class="lg"> truffle.js: </em></p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Upgraded parameter for mocha in truffle.js file</figcaption></figure><p id="eda3" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">你可能已经注意到我们正在使用<em class="lg">mocha-reporter-config . JSON .</em>使用这个文件，我们可以配置multi reporter来使用<em class="lg"> spec </em>和<em class="lg"> mocha-junit-reporter。</em></p><figure class="lh li lj lk fq iu"><div class="bz el l di"><div class="ll lm l"/></div><figcaption class="ln lo fg fe ff lp lq bd b be z ek">Example of mocha-reporter-config.json file</figcaption></figure><p id="4cfd" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">正如您可能注意到的，您甚至可以决定您希望您的测试结果存储在哪里。</p></div><div class="ab cl jw jx hb jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hm hn ho hp hq"><p id="5a91" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">在以太坊上开发dApps需要复杂的设置，需要一大堆框架和工具。由于这些原因，我们创建了<a class="ae jv" href="https://github.com/NodeFactoryIo/solidity-node-docker-starter" rel="noopener ugc nofollow" target="_blank"> starter repository </a>，它拥有为您配置的所有工具和框架，以便您使用Node开发智能合约。Js作为后端服务器。所有的东西都使用<a class="ae jv" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker </a>放在容器中，因此只需一个命令，你就可以启动你的私有网络、部署合同、运行(数据库)迁移、运行web服务器、测试以及你喜欢的任何事情。</p><p id="15b9" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">如果你想试试，你可以在这里看看:</p><div class="mm mn fm fo mo mp"><a href="https://github.com/NodeFactoryIo/solidity-node-docker-starter" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab ej"><div class="mr ab ms cl cj mt"><h2 class="bd hu fv z el mu eo ep mv er et hs dt translated">节点工厂/实体-节点-停靠-启动</h2><div class="mw l"><h3 class="bd b fv z el mu eo ep mv er et ek translated">这个项目用于开发solidity智能合同，NodeJs作为后端服务器</h3></div><div class="mx l"><p class="bd b gc z el mu eo ep mv er et ek translated">github.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd iv mp"/></div></div></a></div><p id="1623" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">你可以让我们知道，如果你想在这个回购更多的功能，或随时贡献！</p></div></div>    
</body>
</html>