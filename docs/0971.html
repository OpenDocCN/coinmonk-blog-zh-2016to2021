<html>
<head>
<title>Building My Own Telemetry System for F1 2017 (Game) Using Golang, InfluxDB and Grafana.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Golang、InfluxDB和Grafana为F1 2017(游戏)构建自己的遥测系统。</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/building-my-own-telemetry-system-for-f1-2017-game-using-golang-influxdb-and-grafana-48dedbd2cdc1?source=collection_archive---------2-----------------------#2018-07-08">https://medium.com/coinmonks/building-my-own-telemetry-system-for-f1-2017-game-using-golang-influxdb-and-grafana-48dedbd2cdc1?source=collection_archive---------2-----------------------#2018-07-08</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><h1 id="5cdf" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">介绍</h1><p id="e9a8" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">前几天，我在我的F1 2017游戏(PS4)中发现了一个功能，在菜单中导航时，我播下了一个名为UDP遥测设置的选项，其中包含许多网络配置，如下所示。</p><div class="km kn ko kp fq ab cb"><figure class="kq kr ks kt ku kv kw paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/2572b00e7405bfda7190418b3735573e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*OEl_0qQ8EhdQGBumTYdbYQ.jpeg"/></div></figure><figure class="kq kr ks kt ku kv kw paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/3876a3ec78f7fa27c59fcf3c8bc766e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*B8zae6egfAWKvp_xHLgXbQ.jpeg"/></div><figcaption class="ld le fg fe ff lf lg bd b be z ek lh di li lj">UDP Telemetry Settings in F1 2017</figcaption></figure></div><p id="1200" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">之后，我在谷歌上搜索了一下，我在Codemasters博客上找到了一篇关于UDP包的规范的博文。是的，这是一个很好的糟糕文档的例子，只有一个错误信息的结构方案在帖子下面的评论中被修复了。该结构如下所示。</p><pre class="km kn ko kp fq lq lr ls lt aw lu dt"><span id="36fb" class="lv ir ht lr b fv lw lx l ly lz">// Packet size – <strong class="lr hu">1289 </strong>bytes</span><span id="9c03" class="lv ir ht lr b fv ma lx l ly lz"><strong class="lr hu">struct UDPPacket</strong></span><span id="3b11" class="lv ir ht lr b fv ma lx l ly lz">{</span><span id="39cf" class="lv ir ht lr b fv ma lx l ly lz">float m_time;</span><span id="520e" class="lv ir ht lr b fv ma lx l ly lz">float m_lapTime;</span><span id="9490" class="lv ir ht lr b fv ma lx l ly lz">float m_lapDistance;</span><span id="b91c" class="lv ir ht lr b fv ma lx l ly lz">float m_totalDistance;</span><span id="d83c" class="lv ir ht lr b fv ma lx l ly lz">float m_x; // World space position</span><span id="3649" class="lv ir ht lr b fv ma lx l ly lz">float m_y; // World space position</span><span id="8c65" class="lv ir ht lr b fv ma lx l ly lz">float m_z; // World space position</span><span id="e8b1" class="lv ir ht lr b fv ma lx l ly lz">float m_speed; // Speed of car in MPH //First mistake, the speed is measured in m/s</span><span id="37b6" class="lv ir ht lr b fv ma lx l ly lz">.........</span><span id="1e6d" class="lv ir ht lr b fv ma lx l ly lz">See the full struct at the blog post : <a class="ae lp" href="http://forums.codemasters.com/discussion/53139/f1-2017-d-box-and-udp-output-specification" rel="noopener ugc nofollow" target="_blank">http://forums.codemasters.com/discussion/53139/f1-2017-d-box-and-udp-output-specification</a></span></pre><p id="ae06" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">在我知道如何使用这个功能后，我创建了一个简单的go程序来读取包装和打印汽车的速度。在我的程序中，我必须从UDP有效载荷Obs中读取一些字节:所有的Floats字段有4个字节，Int的值有一个字节。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="2b81" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">是的，只看到速度在一个终端是没有用的，我需要找到一个好的方法来看到这些信息的，我认为在一个好的工具用于监控服务器和应用程序，如果你认为Grafana你是对的。</p><p id="964f" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">Grafana可以制作带有大量图表的漂亮仪表板，它可以处理数据，非常适合实时监控软件应用程序等事物，但现在a将使用一级方程式赛车进行测试；).</p><figure class="km kn ko kp fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff md"><img src="../Images/e53c3f0a251d835dfb535d729c6297ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EgH8I3ehfgEZaeBt"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek"><a class="ae lp" href="https://github.com/grafana/grafana" rel="noopener ugc nofollow" target="_blank">Grafana Dashboard (at Github project)</a></figcaption></figure><p id="1e09" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">我做的第一件事是了解如何向Grafana发送数据。在我的搜索中，我发现了许多数据源，但只有10个官方数据源，在这些数据源中，我选择了InfluxDB，因为它快速、简单，并且我不需要使用收集器来将我的数据发送到DB。</p><p id="eaf3" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">用这三个工具，我做了自己的遥测系统。</p><figure class="km kn ko kp fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff me"><img src="../Images/ffde8513c230ba1a297d70584b010e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kRsjSmHYy4si8EE1vn_f1g.png"/></div></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">F1 Dashboard</figcaption></figure></div><div class="ab cl mf mg hb mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hm hn ho hp hq"><h1 id="c3c9" class="iq ir ht bd is it mm iv iw ix mn iz ja jb mo jd je jf mp jh ji jj mq jl jm jn dt translated">第一步:制作一个收集器</h1><p id="fc97" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">首先，我需要写一个收集器，谁将收集UDP包中的数据，然后将发送到InfluxDB，这很容易说话，但我发现建立相同的问题。</p><p id="b4c3" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">我们需要解决的第一个问题是如何读取UDP包，这在Go中很简单，我们可以使用package net，在这个包中有函数ListUDP，它打开一个UDP连接，然后我们需要建立一个循环并使用连接的read函数来读取UDP有效载荷的字节。Obs:我创建了一个1289字节的缓冲区，因为这是F1文档中描述的大小。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="6dbd" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">读完UDP包后，我们需要转换成一个描述赛车或比赛信息的结构，所以下一步是写结构，我们有两个结构，第一个描述你，第二个描述其他玩家。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="9dcc" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在有了完整的结构，我们需要解码TelemetryPack中的二进制包，这也很容易。我们可以使用Go的‘编码/二进制’包。在中有一个名为Read的函数，它转换结构中的二进制文件。我们可以在telemetry.go文件中编写一个新函数。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="3604" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">之后，我们需要编写一个简单的客户端来发送InfluxDB中的结构，相信这也很容易。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="b455" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">我需要给出一些关于该代码的解释，首先我创建了一个UDPClient，它将把数据发送到InfluxDB，在我用channel初始化了一个循环并创建了一个BatchPoints之后，BatchPoints是一个接口，它连接到一组要一起写入InfluxDB的点，但是在这个例子中，我们将一个一个地编写，因为我们需要在图形视图中有更快的速度。</p><p id="f33c" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">在创建了一个批处理点之后，我创建了一个代表单个数据点的点，最后我用写函数将批处理点发送到服务器。</p><p id="0573" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">此时，我们有收集器的三个不同部分，一个UDP接收器、Struct和一个InfluxDB客户端。现在我们需要让它们一起工作，首先我们将让接收器将UDP包转换为TelemetryPack，并说明这一点。</p><p id="2f55" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">为此，我们需要将结构转换成字符串映射，为此我用reflect包写了一个特殊的函数。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="1653" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在忽略简单的事情，我们需要在客户端调用那个函数。新点</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">influxdb.go complete</figcaption></figure><p id="9499" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">最后，我们需要为我们的客户端发送结构，为此我用influxDBSender初始化了5个go例程，并在循环中创建了一个Point结构并发送给channel。</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="3a63" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">要查看所有代码，请前往<a class="ae lp" href="https://github.com/rafaelreinert/F1/" rel="noopener ugc nofollow" target="_blank">我的github项目</a>。</p><h1 id="c57c" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">第二步:安装InfluxDB</h1><p id="8db5" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">现在我们需要在一个主机上安装一个InfluxDB服务器，在这篇文章中，我用了一个Raspberry pi 3 b+作为我的Grafana和InfluxDB的主机。安装Raspbian非常容易，我们需要在apt添加InfluxData存储库，在运行apt-get之后，我们可以使用以下命令来完成此操作:</p><figure class="km kn ko kp fq kr"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="2255" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">如果你想了解更多，请访问<a class="ae lp" href="https://docs.influxdata.com/influxdb/v1.5/introduction/installation/" rel="noopener ugc nofollow" target="_blank">的官方文档https://docs . influx data . com/influx db/v 1.5/introduction/installation</a>。</p><p id="4323" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">之后，我们有一个InfluxDB服务器在我们的主机上运行，但它还不允许UDP包，为了进行配置，我们需要在influxdb.conf中进行一些更改，只更改为true启用的UDP，取消对bind-address的注释，并将数据库行与我们的数据库的名称(“f1”)放在一起。</p><pre class="km kn ko kp fq lq lr ls lt aw lu dt"><span id="324f" class="lv ir ht lr b fv lw lx l ly lz">[[udp]]<br/>   enabled = true<br/>   bind-address = ":8089"<br/>   database = "f1"<br/>.........</span></pre><p id="6c8a" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在，用这些命令重新启动服务器并创建f1数据库。</p><pre class="km kn ko kp fq lq lr ls lt aw lu dt"><span id="e972" class="lv ir ht lr b fv lw lx l ly lz">influx<br/><strong class="lr hu">&gt;&gt; CREATE</strong> <strong class="lr hu">DATABASE f1<br/>&gt;&gt; exit</strong></span></pre><h1 id="3645" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">第三步:安装Grafana</h1><p id="198d" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">简单，跟着http://docs.grafana.org/installation/debian/那页<a class="ae lp" href="http://docs.grafana.org/installation/debian/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3e0a" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">我用这些命令安装:</p><pre class="km kn ko kp fq lq lr ls lt aw lu dt"><span id="cf46" class="lv ir ht lr b fv lw lx l ly lz">wget <a class="ae lp" href="https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_5.2.1_armhf.deb" rel="noopener ugc nofollow" target="_blank">https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_5.2.1_armhf.deb</a> <br/>sudo dpkg -i grafana_5.2.1_armhf.deb<br/>sudo service grafana-server start</span></pre><p id="3d4c" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">是吗，如果你试着用用户admin/admin访问端口3000，你可以访问Grafana。</p><p id="d289" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">首先要做的是配置数据源。</p><figure class="km kn ko kp fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff mr"><img src="../Images/ac47e630afd1eb725d6c41831344ca30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*41dlEzep9i1Xr0xK80cPkg.png"/></div></div></figure><h1 id="c322" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">第四步:配置我们的第一个仪表板</h1><p id="a0f2" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">InfluxDB只在收到第一条消息后创建模式，我们需要为此尝试所有，玩F1游戏并运行我们的Golang程序。</p><p id="ba20" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在我们已经完成了我们的第一个dashbord。</p><p id="7593" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">很简单，在创建新仪表板-&gt;添加面板-&gt;图形-&gt;编辑中点击，之后只需添加配置即可:</p><figure class="km kn ko kp fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff ms"><img src="../Images/3818825551daa0cdc0a04c29cf606ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HjTfbqQCdSfM16A3M6bvWw.png"/></div></div></figure><p id="cfda" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在，我们有了第一个速度图表。好好享受吧。</p><figure class="km kn ko kp fq kr fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff mt"><img src="../Images/ae5e9a07f41ff6489d83f9e5dadd3401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XZgcfZ_kkp87nEfCg2Ceqw.png"/></div></div></figure><p id="bf5f" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">现在只需研究Grafana，让你dashboad。</p><h1 id="7e26" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn dt translated">最后的</h1><p id="6923" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在那篇文章中，我向你展示了我如何制作自己的遥测系统，这是最基本的，如果你想了解更多，请看我的github repo。</p><p id="65cc" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated"><a class="ae lp" href="https://github.com/rafaelreinert/F1" rel="noopener ugc nofollow" target="_blank">https://github.com/rafaelreinert/F1</a></p><p id="452e" class="pw-post-body-paragraph jo jp ht jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl hm dt translated">如果你觉得没用。你是正确的。但是我提高了我的英语写作水平，我了解了Grafana和Influxdb，这是我第一次使用UDP并在Go中反映。所有这些都在一个很酷的项目中(对我来说)。</p></div></div>    
</body>
</html>