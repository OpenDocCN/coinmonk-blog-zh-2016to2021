<html>
<head>
<title>Writing a Bitcoin ticker with Cloudflare Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Cloudflare Workers编写比特币行情</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/writing-a-bitcoin-ticker-with-cloudflare-workers-6ae01fd85fd8?source=collection_archive---------6-----------------------#2021-02-08">https://medium.com/coinmonks/writing-a-bitcoin-ticker-with-cloudflare-workers-6ae01fd85fd8?source=collection_archive---------6-----------------------#2021-02-08</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/76e1dff13eb4eeb46b05913df55ae235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUB1x7m-sq5AhoU8tmbAQQ.png"/></div></div></figure><p id="4fc1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我对<a class="ae jz" href="https://discord.gg/cloudflaredev" rel="noopener ugc nofollow" target="_blank"> Cloudflare Workers Discord </a>感到不寒而栗，一个用户询问关于获取加密价格并显示它们的时间间隔。有些人可能知道，我自己是一个大密码迷，所以，这听起来像一个有趣的事情。因此，我决定制作它，我想，嘿，让我们制作一个关于它的教程吧！(如果你想跳到结尾代码，在这里——https://pastebin.com/EKVNpNd5<a class="ae jz" href="https://pastebin.com/EKVNpNd5" rel="noopener ugc nofollow" target="_blank"/>)</p><p id="5ae5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">对于那些不知道的人来说，<a class="ae jz" href="https://workers.dev" rel="noopener ugc nofollow" target="_blank"> Cloudflare Workers </a>是在遍布全球的Cloudflare边缘服务器上运行的小段代码(Cloudflare有超过200个边缘节点！点击这里查看它们。它们是Cloudflare版本的AWS Lambda和Azure函数，但价格更低，并具有Cloudflare的优势！在Cloudflare的免费计划中，每天有100，000个请求，足以满足我们的需求。</p><p id="5058" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">目标很简单:</p><ul class=""><li id="5b25" class="ka kb ht jd b je jf ji jj jm kc jq kd ju ke jy kf kg kh ki dt translated">获取最新的BTC价格(以及交易量等信息)</li><li id="60cb" class="ka kb ht jd b je kj ji kk jm kl jq km ju kn jy kf kg kh ki dt translated">请求时以JSON格式显示</li></ul><p id="8286" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们可以用“<a class="ae jz" href="https://developers.cloudflare.com/workers/platform/cron-triggers" rel="noopener ugc nofollow" target="_blank"> Cron触发器</a>”和“<a class="ae jz" href="https://developers.cloudflare.com/workers/runtime-apis/kv" rel="noopener ugc nofollow" target="_blank"> KV </a>”(键值)来做到这一点。Cron触发器可以让一些代码每X次运行一次，然后KV是一个键值存储，也位于Cloudflare边缘。关于KV的快速说明:它最终是一致的，这意味着它将花费长达60秒的时间传播到世界各地的每个边缘节点。它不会立即更新。</p><blockquote class="ko kp kq"><p id="2578" class="jb jc kr jd b je jf jg jh ji jj jk jl ks jn jo jp kt jr js jt ku jv jw jx jy hm dt translated">在我们开始之前，我只想说:我想开始写更多的博客文章，所以如果你想了解它们，请在Twitter上关注我。如果你有反馈，请发微博或发短信给我！我想提到docs，并允许人们编写自己的实现，同时也展示我所做的。因此，我没有在文本中提供大部分代码，而是链接到文档。告诉我你喜不喜欢这个。</p></blockquote></div><div class="ab cl kv kw hb kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hm hn ho hp hq"><p id="930d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">那么，我们开始吧。为此，我们将只使用在线编辑器，因此除了拥有一个Cloudflare帐户之外，不需要任何设置。让我们创建一个工人，转到仪表板的工人部分，然后单击“创建工人”</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lc"><img src="../Images/6a5bd6abd0f13dc6f3748e4bcd37cc85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5AxXSuUgfE4nUrgd18nMg.png"/></div></div></figure><p id="0630" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，我们有了一些框架代码</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div class="fe ff lh"><img src="../Images/f3146a322efe1b5f5b14b8ac69fc64c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*4gLdZnPbR9P4r-9qnvi0Dw.png"/></div></figure><p id="13e4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，让我们快速设置一个cronjob，因为跨边缘节点部署它可能需要几分钟时间，而且尽早完成它也没有坏处。我们可以进入Worker并转到“Triggers”选项卡，以便创建一个cron触发器。如果你不知道cron job的语法是简单的<code class="eh li lj lk ll b">* * * * *</code> ( <a class="ae jz" href="https://developers.cloudflare.com/workers/platform/cron-triggers" rel="noopener ugc nofollow" target="_blank">你可以在这里阅读cron语法</a>)我们将让这种情况每分钟发生一次。你可以在“预计即将发生的事件”中看到它将在何时启动的估计。</p><blockquote class="ko kp kq"><p id="67ed" class="jb jc kr jd b je jf jg jh ji jj jk jl ks jn jo jp kt jr js jt ku jv jw jx jy hm dt translated">注意:每个cron触发器都将计入您的每日请求配额。</p></blockquote><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lm"><img src="../Images/70e9c811ede081fdb7bdad12bd4fe29e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*koWIx0Diz0kSveN875w4VQ.png"/></div></div></figure><p id="1864" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们编写<a class="ae jz" href="https://developers.cloudflare.com/workers/platform/cron-triggers" rel="noopener ugc nofollow" target="_blank"> Cron触发器</a>部分，这样我们就可以知道我们想要处理什么信息，所以，回到编辑器！根据<a class="ae jz" href="https://developers.cloudflare.com/workers/platform/cron-triggers" rel="noopener ugc nofollow" target="_blank"> Cron Triggers docs </a>，我们想要添加一个类型为“scheduled”的事件监听器(<a class="ae jz" href="https://developers.cloudflare.com/workers/runtime-apis/scheduled-event" rel="noopener ugc nofollow" target="_blank">Read docs on scheduled event</a>)。我们想调用一个返回承诺的方法，并执行一个<code class="eh li lj lk ll b">event.waitUntil</code>来确保承诺完成。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div class="fe ff ln"><img src="../Images/8ffbce160624b4888506923b2b048f6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*InXvhnWhGDgurjv_NCvSIw.png"/></div></figure><p id="89ce" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，我们需要从预定函数中获取比特币价格和其他股票信息。为此，我将使用北海巨妖的公共API来提供这些信息(<a class="ae jz" href="https://www.kraken.com/en-gb/features/api" rel="noopener ugc nofollow" target="_blank"> Docs </a>)。为了获取信息，我们需要使用ticker info端点，因为我想要用美元表示，所以我们将使用一对<code class="eh li lj lk ll b">BTCUSD</code>，所以我们的<code class="eh li lj lk ll b">fetch</code>将做一个<code class="eh li lj lk ll b">GET</code>到<code class="eh li lj lk ll b">https://api.kraken.com/0/public/Ticker?pair=BTCUSD</code></p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lo"><img src="../Images/667d44ad9a8b838e5ade92ab1fba93bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ox9LNRU4cFuZ0XxNaGbDw.png"/></div></div></figure><p id="eac1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们来测试一下，把<code class="eh li lj lk ll b">await handleCronTrigger</code>放到<code class="eh li lj lk ll b">handleRequest</code>函数里。然后单击右侧预览中的“Send ”,我们现在可以看到它正在输出数据！</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lp"><img src="../Images/6b79f3d5bfd7f6b898146a6e3d33a4c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdvORbS4nujTPPPWIkK-Gw.png"/></div></div></figure><p id="c6b4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，让我们将这些信息放入KV名称空间，以便我们可以根据请求获取它们。我们需要创建一个KV名称空间，并将其绑定到一个变量，这样我们就可以在代码中使用它。为此，我们只需转到Workers中的“KV”部分，输入一个名称并单击“Add”</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lq"><img src="../Images/e6f15fe152ddb0343b2cffb861fa968b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPNuO2PXSE6BiLWUdI3F4g.png"/></div></div></figure><p id="b487" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们需要将它绑定到一个变量，我们将它绑定到“KV ”,这意味着我们可以做<code class="eh li lj lk ll b">KV.put('example', 123);</code>将“123”放入“example”键下的KV存储中。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lr"><img src="../Images/5242c4103274905f7f882d46c2f3d5d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuAxpecRi1N0pIxpW4152g.png"/></div></div></figure><p id="d78b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">点击“保存”,现在我们可以使用它了！</p><p id="f6bd" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们把一些来自北海巨妖的信息放入KV！</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ls"><img src="../Images/19c0833a26f988dbad0a8de58bc60ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pTSUc6jCbpK2JlKnw0wrpw.png"/></div></div></figure><p id="9009" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们确保它输入了正确的信息，现在让我们发送一个请求并查看KV。我们可以从web UI中查看存储了哪些数据，只需进入名称空间，然后嘣！</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lt"><img src="../Images/b97b3da0731d623ba0195a145e3fc9b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yi16hsywnLnV4MWxI0O8Fg.png"/></div></div></figure><p id="927f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们的数据在那里！完美！现在剩下的就是当我们请求worker时显示这些信息。如果我们看一下KV文档，我们可以做一个<code class="eh li lj lk ll b">KV.get('info');</code>来获得JSON数据。我们可以做<code class="eh li lj lk ll b">KV.get('info', 'json');</code>来获得JSON编码的对象<strong class="jd hu">然而</strong>，我们需要为<code class="eh li lj lk ll b">Response</code>进行字符串化。因此，更简单的方法是将它作为一个字符串，直接传递给响应。</p><p id="7602" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">所以，最后一步:获取KV数据并用数据作出新的响应，并将<code class="eh li lj lk ll b">Content-Type</code>头设置为<code class="eh li lj lk ll b">application/json</code>，然后嘣！我们完了！</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/b635b58062647031bfe4f57e86fe44f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*CDRdzaapiQZvQvIm6vzabw.png"/></div></figure><p id="6726" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在右边的浏览器预览中点击“发送”,你会看到我们生成的JSON！</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lv"><img src="../Images/e1ccdf409e68fdf6f6468d3bce3083d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJkmMI8rkJD3hZVktbqS_g.png"/></div></div></figure><p id="ca58" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">干得好！！现在，您可以给它一个合适的名称，并将其链接到一个域。</p></div><div class="ab cl kv kw hb kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hm hn ho hp hq"><p id="dfdb" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">结果代码可以在这里找到:<a class="ae jz" href="https://pastebin.com/EKVNpNd5" rel="noopener ugc nofollow" target="_blank">https://pastebin.com/EKVNpNd5</a></p><p id="de7c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这是一个有趣的项目，也是我第一次使用Cloudflare Workers的cron触发器。如果你在工作中需要帮助，我建议你去找官方的不和谐:<a class="ae jz" href="https://discord.gg/cloudflaredev" rel="noopener ugc nofollow" target="_blank">https://discord.gg/cloudflaredev</a>那里有很多乐于助人的人，包括我！</p><p id="dca3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我仍然是写博客的新手，所以我希望我写的容易理解。如果你有任何反馈，你可以在Twitter @ WalshyDev(<a class="ae jz" href="https://twitter.com/WalshyDev" rel="noopener ugc nofollow" target="_blank">https://twitter.com/WalshyDev</a>)上给我发推文或DM</p><p id="f0e0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">感谢阅读，并与工人快乐黑客！:)</p></div><div class="ab cl kv kw hb kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hm hn ho hp hq"><ul class=""><li id="6c7d" class="ka kb ht jd b je jf ji jj jm kc jq kd ju ke jy kf kg kh ki dt translated">https://twitter.com/WalshyDev</li><li id="c385" class="ka kb ht jd b je kj ji kk jm kl jq km ju kn jy kf kg kh ki dt translated">GitHub:<a class="ae jz" href="https://github.com/WalshyDev" rel="noopener ugc nofollow" target="_blank">https://github.com/WalshyDev</a></li><li id="514a" class="ka kb ht jd b je kj ji kk jm kl jq km ju kn jy kf kg kh ki dt translated">GitHub赞助商:<a class="ae jz" href="https://github.com/sponsors/WalshyDev" rel="noopener ugc nofollow" target="_blank">https://github.com/sponsors/WalshyDev</a></li></ul></div></div>    
</body>
</html>