<html>
<head>
<title>Simplified code of Bitcoin Lightning Network part4 — Spend HTLC Breach Remedy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">比特币闪电网络的简化代码第四部分——消费HTLC违约补救</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-part4-spend-htlc-breach-remedy-61ebc5587fc4?source=collection_archive---------7-----------------------#2018-10-07">https://medium.com/coinmonks/simplified-code-of-bitcoin-lightning-network-part4-spend-htlc-breach-remedy-61ebc5587fc4?source=collection_archive---------7-----------------------#2018-10-07</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="d1f2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">雷电网络的基本概念很简单。为了进一步理解，参考<a class="ae jo" href="https://lightning.network/lightning-network-paper.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a>，将lightning网络交易流程表示为javascript代码。</p><p id="8f6d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我在一篇博文中解释所有的交易流程，会很难读懂。所以我分成几篇博文。这是最后一个帖子。</p><p id="c9aa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这篇博文的目标是花费HTLC违约补救措施，这对应于白皮书的图13 + 14。</p><p id="f16b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Github上的代码:<a class="ae jo" href="https://github.com/tak1827/lightning-network-tx-flow/tree/spend-HBR" rel="noopener ugc nofollow" target="_blank">闪电网tx流</a></p><p id="aed7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">前置:<a class="ae jo" rel="noopener" href="/coinmonks/simplified-code-of-bitcoin-lightning-network-part3-spend-htlc-execution-revocable-delivery-49991e3cfe34">比特币闪电网络简化代码part 3——花HTLC执行可撤销交割</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/630ee9d13fa8cea73bdeee8b91ebd6be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jdj4iERIwXrnuyXw1NSZcQ.png"/></div></div></figure></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="59df" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">花费HTLC违约补救的19个步骤</h2><p id="e326" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">由于重复的解释，我跳过了第11步。所以想了解请参考<a class="ae jo" rel="noopener" href="/coinmonks/simplified-code-of-bitcoin-lightning-network-part3-spend-htlc-execution-revocable-delivery-49991e3cfe34">之前的博文</a>。</p><ol class=""><li id="9a21" class="li lj ht is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq dt translated"><em class="lr">多签名资助</em></li><li id="d7fe" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建C1a和C1b(无标志)</em></li><li id="40fd" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建RD1a和RD1b </em></li><li id="f5aa" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">C1a和C1b交换签名</em></li><li id="044f" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建立C2a和C2b(无标志)</em></li><li id="5de4" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建RD2a和RD2b </em></li><li id="1cd0" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">打造HTD1b </em></li><li id="2423" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造HE1b </em></li><li id="c54d" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">打造HERD1b </em></li><li id="bdeb" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">C2a和C2b的交换签名</em></li><li id="0c55" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造BR1a和BR1b </em></li><li id="5cae" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建C3a和C3b(无标志)</em></li><li id="a17a" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">构建RD3a和RD3b </em></li><li id="371f" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">交换C3a和C3b的签名</em></li><li id="81d3" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">公开私钥</em></li><li id="cf96" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">花C2b </em></li><li id="e47a" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造和花费D2b </em></li><li id="9662" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造和花费BR2b </em></li><li id="89ef" class="li lj ht is b it ls ix lt jb lu jf lv jj lw jn ln lo lp lq dt translated"><em class="lr">建造和花费HBR1b </em></li></ol></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="31a0" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 12。构建C3a和C3b(无标志)</em></h2><p id="e017" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">现在，Alice和Bob想要关闭HTLC，以便构建C3a和C3b来更新Lightning网络状态。请注意产量平衡。鲍勃比爱丽丝多收到0.1 BTC。这一次，爱丽丝不要求鲍勃回答前像r。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="7a27" class="ki kj ht lz b fv md me l mf mg">let C3a = new Transaction(<br/>  [<br/>    new TxIn(<br/>      fTxAH, <br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    ),<br/>    new TxIn(<br/>      fTxBH,<br/>      0, <br/>      { <br/>        type: 'MULTI',<br/>        sig: [ <br/>          redeemScript.pubKeyHashs[0], <br/>          redeemScript.pubKeyHashs[1] <br/>        ],<br/>        redeemScript<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      40000000, <br/>      { <br/>        type: 'RSMS',<br/>        pubKeyHash: [ <br/>          getPubKeyHash(AliceKeys[7]), <br/>          getPubKeyHash(BobKeys[7]) <br/>        ]<br/>      }<br/>    ),<br/>    new TxOut(<br/>      60000000, // Bob receive 0.1 BTC more than Alice<br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(BobKeys[7])<br/>      }<br/>    )<br/>  ]<br/>)</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="588b" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 13。构建RD3a和RD3b </em></h2><p id="3a45" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">跳过重复解释。请参考<a class="ae jo" rel="noopener" href="/@t.tak/simplified-code-of-bitcoin-lightning-network-spend-revocable-delivery-90e50f0256d5">上一篇</a>中的“<em class="lr">构建RD1a和RD1b </em>”部分。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="bba6" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated"><em class="lx"> 14。C3a和C3b的交换签名</em></h2><p id="d105" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">爱丽丝让鲍勃签C3a。现在，爱丽丝可以随时广播这个交易。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="26ff" class="ki kj ht lz b fv md me l mf mg">// Alice hand over C3a to Bob, and let him sign<br/>C3a = signTx(C2a, BobKeys[1]);</span></pre><p id="8c99" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">同样的，鲍勃让爱丽丝签了C3b。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="6950" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">15.公开私钥</h2><p id="f048" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">Alice和Bob分别公开了他们的私钥来撤销C2a和C2b输出。如果爱丽丝意外广播了C2a，她会丢失所有BTC，因此爱丽丝可以安全地撤销C2a。</p><p id="72fc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">起初，爱丽丝透露了<code class="eh mh mi mj lz b">AliceKeys[4]</code>。使用这把钥匙，鲍勃可以自己建造并花费BR2a和HBR1a来获得爱丽丝的BTC。</p><p id="3c35" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">其次，爱丽丝披露<code class="eh mh mi mj lz b">AliceKey[5]</code>。使用这个密钥，Bob可以自己构建HEBR1a。</p><p id="0c1e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">同样，鲍勃向爱丽丝透露了<code class="eh mh mi mj lz b">BobKey[4]</code>和<code class="eh mh mi mj lz b">BobKey[5]</code>。</p></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="3bd9" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">16.消费C2b</h2><p id="8a2e" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">鲍勃出人意料地播出了C2b。不幸的是，由于他的违约，他失去了整个BTC。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="6498" class="ki kj ht lz b fv md me l mf mg">// Sign by himself(Bob)<br/>C2b = signTx(C2b, BobKeys[1]);</span><span id="6881" class="ki kj ht lz b fv mk me l mf mg">validateTx(C2b, Blocks);</span><span id="8b4b" class="ki kj ht lz b fv mk me l mf mg">// Mine block as adding transactions<br/>Blocks = mineBlock(Blocks, createNewBlock([C2b], Blocks));</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="eece" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">17.构建和花费D2b</h2><p id="ffb7" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">爱丽丝花D2b女巫输出本来是属于爱丽丝的。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="fa04" class="ki kj ht lz b fv md me l mf mg">const hashC2b = calculateTxHash(C2b);</span><span id="f078" class="ki kj ht lz b fv mk me l mf mg">let D2b = new Transaction(<br/>  [<br/>    new TxIn(<br/>      hashC2b, <br/>      0, <br/>      { <br/>        type: 'SINGLE',<br/>        sig: [ <br/>          getPubKeyHash(AliceKeys[4]) <br/>        ],<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      40000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(AliceKeys[8])<br/>      }<br/>    )<br/>  ]<br/>)</span><span id="b84d" class="ki kj ht lz b fv mk me l mf mg">D2b = signTx(D2b, AliceKeys[4]);</span><span id="9ac1" class="ki kj ht lz b fv mk me l mf mg">validateTx(D2b, Blocks);</span><span id="a59c" class="ki kj ht lz b fv mk me l mf mg">Blocks = mineBlock(Blocks, createNewBlock([D2b], Blocks));</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="6de9" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">18.构建和花费BR2b</h2><p id="b764" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">Alice可以使用公开的Bob的私钥签署BR2b。她立即收到了鲍勃BTC奖。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="e1a8" class="ki kj ht lz b fv md me l mf mg">const c2bHash = calculateTxHash(C2b);</span><span id="f385" class="ki kj ht lz b fv mk me l mf mg">let BR2b = new Transaction(<br/>  [<br/>    new TxIn(<br/>      c2bHash,<br/>      1, <br/>      { <br/>        type: 'BR',<br/>        sig: [ <br/>          getPubKeyHash(AliceKeys[4]), <br/>          getPubKeyHash(BobKeys[4]) <br/>        ],<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      40000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(AliceKeys[8]) // For Alice<br/>      }<br/>    )<br/>  ]<br/>)</span><span id="53bd" class="ki kj ht lz b fv mk me l mf mg">// Alice can sign, because she know Bob's private key.<br/>BR2b = signTx(BR2b, BobKeys[4]);</span><span id="2272" class="ki kj ht lz b fv mk me l mf mg">// Inherently, this BTC is for Bob, but now belong to Alice.<br/>// Bob lose for his breach.<br/>BR2b = signTx(BR2b, AliceKeys[4]);</span><span id="524e" class="ki kj ht lz b fv mk me l mf mg">validateTx(BR2b, Blocks);</span><span id="1219" class="ki kj ht lz b fv mk me l mf mg">Blocks.push( createNewBlock([BR2b], Blocks) );</span></pre></div><div class="ab cl kb kc hb kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hm hn ho hp hq"><h2 id="f65f" class="ki kj ht bd kk kl km kn ko kp kq kr ks jb kt ku kv jf kw kx ky jj kz la lb lc dt translated">19.构建和花费HBR1b</h2><p id="3508" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">同样，Alice可以使用公开的Bob的私钥签署HBR1b。她立即收到了鲍勃BTC奖。</p><pre class="jq jr js jt fq ly lz ma mb aw mc dt"><span id="0522" class="ki kj ht lz b fv md me l mf mg">let HBR1b = new Transaction(<br/>  [<br/>    new TxIn(<br/>      c2bHash,<br/>      2, <br/>      { <br/>        type: 'BR',<br/>        sig: [ <br/>          getPubKeyHash(AliceKeys[4]), <br/>          getPubKeyHash(BobKeys[4]) <br/>        ],<br/>      }<br/>    )<br/>  ],<br/>  [<br/>    new TxOut(<br/>      10000000, <br/>      { <br/>        type: 'NORMAL',<br/>        pubKeyHash: getPubKeyHash(AliceKeys[8]) // For Alice<br/>      }<br/>    )<br/>  ]<br/>)</span><span id="9772" class="ki kj ht lz b fv mk me l mf mg">// Alice can sign, because she know Bob's private key.<br/>HBR1b = signTx(HBR1b, BobKeys[4]);</span><span id="fdee" class="ki kj ht lz b fv mk me l mf mg">// Inherently, this BTC is for Bob, but now belong to Alice.<br/>// Bob lose for his breach.<br/>HBR1b = signTx(HBR1b, AliceKeys[4]);</span><span id="b9ad" class="ki kj ht lz b fv mk me l mf mg">validateTx(HBR1b, Blocks);</span><span id="0124" class="ki kj ht lz b fv mk me l mf mg">Blocks.push( createNewBlock([HBR1b], Blocks) );</span></pre></div></div>    
</body>
</html>