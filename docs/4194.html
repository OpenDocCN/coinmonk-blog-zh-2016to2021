<html>
<head>
<title>How a bug in the Uniswap/Sushiswap Router can protect you against rug pulls?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap/Sushiswap路由器中的一个bug如何保护您免受恶意攻击？</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-a-bug-in-the-uniswap-sushiswap-router-can-protect-you-against-rug-pulls-322aff590d56?source=collection_archive---------2-----------------------#2021-03-13">https://medium.com/coinmonks/how-a-bug-in-the-uniswap-sushiswap-router-can-protect-you-against-rug-pulls-322aff590d56?source=collection_archive---------2-----------------------#2021-03-13</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="f4d3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">TLDR:使用“许可+做某事”模式时要小心</p><p id="a8dc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我将使用uniswap进行解释，但对于sushiswap或任何其他uniswap分支也是如此。</p><p id="ba61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当清除流动性时，uniswap前端使用<a class="ae jo" href="https://uniswap.org/docs/v2/smart-contracts/router02#removeliquiditywithpermit" rel="noopener ugc nofollow" target="_blank"><em class="jp">removeliquitywithpree</em></a><em class="jp">或</em><a class="ae jo" href="https://uniswap.org/docs/v2/smart-contracts/router02#removeliquidityethwithpermit" rel="noopener ugc nofollow" target="_blank"><em class="jp">removeliquityethwithpree</em></a><em class="jp"/>方法。</p><ol class=""><li id="e53a" class="jq jr ht is b it iu ix iy jb js jf jt jj ju jn jv jw jx jy dt translated">这意味着用户首先签署对路由器契约的许可，以使用他们遵循<a class="ae jo" href="https://github.com/ethereum/EIPs/blob/8a34d644aacf0f9f8f00815307fd7dd5da07655f/EIPS/eip-2612.md" rel="noopener ugc nofollow" target="_blank"> EIP-2612标准</a>的Uniswap V2 LP令牌，然后使用前端<em class="jp">调用路由器契约上的<em class="jp">removeliquiditywithprance或removeliquidityethwithprance</em>方法。</em></li><li id="2c46" class="jq jr ht is b it jz ix ka jb kb jf kc jj kd jn jv jw jx jy dt translated">路由器合同获取签名并将其提交给uni WAP V2 LP令牌合同(参见此处的<a class="ae jo" href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L153" rel="noopener ugc nofollow" target="_blank">和</a>)，这允许它使用用户的uni WAP V2 LP令牌。</li><li id="edd9" class="jq jr ht is b it jz ix ka jb kb jf kc jj kd jn jv jw jx jy dt translated">既然路由器契约具有来自用户的许可，它将令牌从用户转移到它自己，移除流动性并将相应对的令牌给予用户。</li></ol><p id="598f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">事情是这样的。还记得用户在步骤2中签署的允许路由器使用令牌的签名吗？该签名不必仅由路由器合同提交给uni WAP V2 LP令牌合同。任何人都可以提交。这就是EIP 2612的意义所在。</p><p id="3bad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里可能发生的情况是，假设有人正在通过移除货币对的所有流动性来欺骗你。您可以做的是，当移除流动性的交易在mempool中时，您可以在rug puller的交易进入之前，获取rug puller在<a class="ae jo" href="https://uniswap.org/docs/v2/smart-contracts/router02#removeliquiditywithpermit" rel="noopener ugc nofollow" target="_blank"><em class="jp">removeliquiditywithproperty</em></a><em class="jp">或</em><a class="ae jo" href="https://uniswap.org/docs/v2/smart-contracts/router02#removeliquidityethwithpermit" rel="noopener ugc nofollow" target="_blank"><em class="jp">removeliquidityethwithproperty</em></a><em class="jp"/>参数中提交的签名，并将其提交给<em class="jp"> </em> Uniswap V2 LP令牌合同。这将导致地毯拉料器的交易失败。</p><h1 id="c6f3" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">这怎么可能呢？</h1><p id="e403" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">因为在步骤2，路由器契约提交的签名变得无效，因为您已经使用了具有相同nonce的签名。</p><figure class="li lj lk ll fq lm fe ff paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="fe ff lh"><img src="../Images/eaa613127961889d4dde84b4840e0429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O7XrrFVHmLL3h-QD5xJgTA.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">Failed transaction when removing liquidity</figcaption></figure><p id="bbc5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在你可以在拉地毯的人再次尝试之前做你的交易，因为第二次你不能做任何其他事情来阻止他们拿走流动性。</p><p id="eb86" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我做了一个通用的机器人，它为所有试图在Ropsten testnet上移除流动性的人做了同样的事情。进入<a class="ae jo" href="https://app.uniswap.org/#/pool" rel="noopener ugc nofollow" target="_blank"> uniswap.exchange </a>，将网络切换到ropsten并尝试移除流动性(你必须先给任何一对添加一些流动性)来亲眼看看。</p><p id="1faa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">交易示例:<br/>地毯拉头:<a class="ae jo" href="https://ropsten.etherscan.io/tx/0xc167f4182d0bdd8c49a3bb32ba4ff3a165e9eb6730e9af92e7ee9a0b717c3302" rel="noopener ugc nofollow" target="_blank">https://ropsten . ethers can . io/tx/0xc 167 f 4182d 0 BDD 8 c 49 a 3 bb 32 ba 4 ff 3a 165 e 9 EB 6730 e 9 af 92 e 7 ee 9 a 0 b 717 c 3302<br/></a>You:<br/><a class="ae jo" href="https://ropsten.etherscan.io/tx/0xdeeca23e0704ae764180a82c2ebbb97df32941c509a7eff3a6ebb3b98594f404" rel="noopener ugc nofollow" target="_blank">https://ropsten . ethers can . io/tx/0x deeca 23 e 0704 AE 764180 a 82 e BBB 97 df 3</a></p><h1 id="ae00" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">一个简单的解决方法:</h1><p id="97a3" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">在路由器合同<a class="ae jo" href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L153" rel="noopener ugc nofollow" target="_blank">中添加此处</a>和<a class="ae jo" href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L167" rel="noopener ugc nofollow" target="_blank">处</a>解决了这个问题:</p><pre class="li lj lk ll fq lx ly lz ma aw mb dt"><span id="e203" class="mc kf ht ly b fv md me l mf mg">if (IUniswapV2Pair(pair).allowance(msg.sender,address(this)) != value) {<br/>   UniswapV2Pair(pair).permit(msg.sender, address(this), value,            deadline, v, r, s);<br/>}</span></pre><p id="6fea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">(我向Uniswap团队提交了报告，等了6个月才发表，所以可以肯定地说，uniswap团队不认为这是一个bug。)</p></div></div>    
</body>
</html>