<html>
<head>
<title>Blockchain + IoT = ❤️</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">❤️+物联网=区块链</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/blockchain-iot-waves-bf732e5f60df?source=collection_archive---------1-----------------------#2018-04-16">https://medium.com/coinmonks/blockchain-iot-waves-bf732e5f60df?source=collection_archive---------1-----------------------#2018-04-16</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="fe7f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">区块链是一项伟大的技术，它可以改变我们的日常生活，并可以帮助改善很多其他技术。自从Satoshi的论文发表以来，我们多次听到比特币可以取代货币，但事实并非如此。比特币和以太坊的交易费用和支付时间存在很多问题。2016年有一篇论文叫做比特币-NG:一种可扩展的区块链协议，它展示了一种如何解决大量区块链问题的方法，并使其更快更可靠。Waves是少数几个已经实现NG协议的区块链之一。Waves-NG 提供了很多机会，其中之一是<strong class="is hu">快速支付，这导致了另一个优势——廉价支付。</strong></p><p id="8ca8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">快速和廉价的支付可以用在很多方面，但在波我们喜欢糖果。<a class="ae jo" href="http://github.com/Tolsi" rel="noopener ugc nofollow" target="_blank">Waves的开发者之一Sergey Tolmachev </a>决定为接受Waves加密货币的糖果机做概念验证。这种概念验证可以用于任何稍加改进和修正的自动售货机。</p><h1 id="7fd1" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">主要零件</h1><p id="8024" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">我们发现手动旋转扭转糖果机如下图所示:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff ks"><img src="../Images/ace9007861f897d8b864f405ba0e6057.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*Wk2Dc7ZBNyKxtw5X.jpg"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">Manual Rotation Torsion Candy Machine</figcaption></figure><p id="a7ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">它的价格大约是3美元，而且很容易找到。它在玻璃球下也有放置硬币的空间。我们可以在那里安装步进电机，使其自动旋转，而不是手动旋转。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff le"><img src="../Images/8d6b4d2e0c4d0cedd5c7880ffc27f8ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*IQWU1BZmVyay4b5g.jpg"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">28BYJ-48 Stepper Motor</figcaption></figure><p id="2e82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">其中最便宜，但最好的选择是<a class="ae jo" href="https://ru.aliexpress.com/item/New-Style-5V-Stepper-Motor-28BYJ-48-ULN2003-Driver-Test-Module-for-Arduino/32820485530.html?spm=a2g0v.search0104.3.16.5a1e70f8YFnNMy&amp;ws_ab_test=searchweb0_0,searchweb201602_5_10152_5722813_10151_10065_10344_10068_10342_5722613_10343_5722913_10340_10341_10698_10697_10696_10084_10083_5722713_10618_10307_10301_10059_5723015_10534_308_100031_10103_441_10624_10623_10622_10621_10620_5722513,searchweb201603_25,ppcSwitch_7&amp;algo_expid=cc732c4e-7eb4-4e1c-a98a-db8c7dd9634c-2&amp;algo_pvid=cc732c4e-7eb4-4e1c-a98a-db8c7dd9634c&amp;transAbTest=ae803_1&amp;priceBeautifyAB=0" rel="noopener ugc nofollow" target="_blank"> 28BYJ-48步进电机</a>。28BYJ-48是一个小型5伏齿轮传动单极步进电机。</p><p id="8709" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们将使用<a class="ae jo" href="https://ru.aliexpress.com/item/Breadboard-Power-Supply-Module-3-3V-5V-MB102-Solderless-Bread-Board-DIY-2012-New-3PCS/708949986.html?spm=a2g0v.search0104.3.9.33fb72c4IvNLX5&amp;ws_ab_test=searchweb0_0,searchweb201602_5_10152_5722813_10151_10065_10344_10068_10342_5722613_10343_5722913_10340_10341_10698_10697_10696_10084_10083_5722713_10618_10307_10301_10059_5723015_10534_308_100031_10103_441_10624_10623_10622_10621_10620_5722513,searchweb201603_25,ppcSwitch_7&amp;algo_expid=38677a45-a8a8-40b5-9eb8-316ef6c37552-1&amp;algo_pvid=38677a45-a8a8-40b5-9eb8-316ef6c37552&amp;transAbTest=ae803_1&amp;priceBeautifyAB=0" rel="noopener ugc nofollow" target="_blank"> ESP8266WiFi 12e Witty </a>来监听区块链的交易，并决定何时必须分发糖果。ESP-12模块是ESP系列中最完整的模块之一，因为它允许您使用所有模块中数量最多的引脚。可以对该模块进行编程，使其与Arduino IDE或LUA节点MCU一起独立工作。这个小芯片有很多优点，但对我们来说最重要的是WiFi。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff ks"><img src="../Images/b312f5dd83c37e948da05da320311b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*YCcB1WLLrtKP-h5KJmafcQ.jpeg"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">ESP8266WiFi 12e Witty</figcaption></figure><p id="ae6f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">作为电源我们决定选择<a class="ae jo" href="https://ru.aliexpress.com/item/Breadboard-Power-Supply-Module-3-3V-5V-MB102-Solderless-Bread-Board-DIY-2012-New-3PCS/708949986.html?spm=a2g0v.search0104.3.9.33fb72c4IvNLX5&amp;ws_ab_test=searchweb0_0,searchweb201602_5_10152_5722813_10151_10065_10344_10068_10342_5722613_10343_5722913_10340_10341_10698_10697_10696_10084_10083_5722713_10618_10307_10301_10059_5723015_10534_308_100031_10103_441_10624_10623_10622_10621_10620_5722513,searchweb201603_25,ppcSwitch_7&amp;algo_expid=38677a45-a8a8-40b5-9eb8-316ef6c37552-1&amp;algo_pvid=38677a45-a8a8-40b5-9eb8-316ef6c37552&amp;transAbTest=ae803_1&amp;priceBeautifyAB=0" rel="noopener ugc nofollow" target="_blank"> YwRobot试验板电源MB-V2 </a>，它也很便宜和简单，然而，同时，它可以通过USB供电。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff lf"><img src="../Images/50132d0260d53c60624bd719608f957e.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/0*BMB0_oeuTrKqaz7b.jpg"/></div><figcaption class="la lb fg fe ff lc ld bd b be z ek">YwRobot Breadboard Power Supply MB-V2</figcaption></figure><p id="9290" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">该模式如下所示:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="fe ff lg"><img src="../Images/5688efca3d05454cebb77d379c76acf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FXkUv8ctwl8qjwRK.png"/></div></div></figure><p id="81fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">另一件重要的事情是将步进电机放入糖果机，没有简单的方法——只有锯切和胶合，工作结果如下:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="fe ff ll"><img src="../Images/22f0381ef1998c9b76729f2e8719bdd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*q87Q4JKV2D_xP7CB.jpg"/></div></div></figure><h1 id="d317" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">跳入代码中</h1><p id="4c35" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">在我们能把所有部件组装在一起之前，我们必须写一些代码。我们用Arduino IDE吧。有几件重要的事情需要意识到:</p><ol class=""><li id="bfb9" class="lm ln ht is b it iu ix iy jb lo jf lp jj lq jn lr ls lt lu dt translated">我们要导入ESP8266WiFi，比如我们可以用<a class="ae jo" href="https://github.com/ekstrand/ESP8266wifi" rel="noopener ugc nofollow" target="_blank">这个库</a></li><li id="fe53" class="lm ln ht is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu dt translated">我们将使用一个小芯片解析JSON，所以可能会很慢——我们的代码应该是高效的。</li></ol><p id="5f5f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们从inclides和全局设置变量开始:</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="1c5a" class="mf jq ht mb b fv mg mh l mi mj">#include &lt;ESP8266WiFi.h&gt;<br/>// Determines the type used to store integer values in JsonVariant.<br/>// 0 - Long<br/>// 1 - Long Long<br/>#define ARDUINOJSON_USE_LONG_LONG 1<br/><br/>#include &lt;ArduinoJson.h&gt;<br/><br/>#include&lt;AccelStepper.h&gt;</span></pre><p id="15e7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们必须创建AccelStepper对象，向构造函数传递4个参数，就像单极步进电机一样，由4个晶体管控制。</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="06be" class="mf jq ht mb b fv mg mh l mi mj">AccelStepper myStepper(8, 13, 14, 12, 16);<br/><br/>// Steps per revolution for our motor<br/><strong class="mb hu">const int </strong>stepsPerRevolution = 4076;</span></pre><p id="a6d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们还需要为我们的Arduino芯片提供WiFi凭证:</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="09bd" class="mf jq ht mb b fv mg mh l mi mj">// Wi-Fi settings<br/><strong class="mb hu">const char </strong>*ssid = "";<br/><strong class="mb hu">const char </strong>*password = "";</span></pre><p id="b803" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以及一些关于使用的Waves节点、JSON字段和地址的常量，我们希望对它们进行监控。如果你有你的Waves Full节点，你可以使用它的URI，而不是公共的。</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="c6fa" class="mf jq ht mb b fv mg mh l mi mj"><strong class="mb hu">const char </strong>*balanceJsonField = "balance";<br/><br/>// Waves public node URI<br/><strong class="mb hu">const char </strong>*host = "nodes.wavesnodes.com";<br/><strong class="mb hu">const int </strong>port = 80;<br/><strong class="mb hu">const </strong>String address = "3P7CHn3nndASs6UqgUf9atBEgue7C4cANdY";<br/><br/>// Price of one candy<br/><strong class="mb hu">const unsigned long long </strong>price = 100000000;</span></pre><p id="1294" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在主逻辑с之前，我们需要设置步进机和WiFi的几个选项，例如，以位/秒为单位的数据速率、以步/秒为单位的所需恒定速度、连接到WiFi。</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="6384" class="mf jq ht mb b fv mg mh l mi mj"><strong class="mb hu">void </strong>setup() {<br/>    // Sets the data rate in bits per second (baud) for serial data transmission.<br/>    // For communicating with the computer we can use 115200<br/>    Serial.begin(115200);<br/>    Serial.println();<br/><br/>    // The desired constant speed in steps per second. Positive is clockwise.<br/>    // Speeds of more than 1000 steps per second are unreliable.<br/>    myStepper.setMaxSpeed(700.0);<br/>    myStepper.setAcceleration(700.0);<br/>    myStepper.setSpeed(700);<br/>    myStepper.moveTo(myStepper.currentPosition() - stepsPerRevolution / 2);<br/><br/>    <strong class="mb hu">if </strong>(ssid == ""){<br/>        Serial.println("WiFi ssid is empty.");<br/>    }<br/><br/>    connectToWiFi();<br/>}</span></pre><p id="d71d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们的逻辑将每N秒检查一次地址，并试图找到对应于预定义地址的事务。如果它发现交易和金额涵盖糖果的价格步进旋转和糖果挂出来。</p><p id="78b5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于重复的HTTP请求，我们将使用<a class="ae jo" href="https://docs.wavesplatform.com/application-development-and-api/node-api-overview.html" rel="noopener ugc nofollow" target="_blank"> Waves节点REST API </a>。普通JSON中的响应如下:</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="c873" class="mf jq ht mb b fv mg mh l mi mj">{<br/>  "address": "3PAQT8mofh7EYhvgtXfAgWkdW1b6ptNgXMJ",<br/>  "confirmations": 0,<br/>  "balance": 0<br/>}</span></pre><p id="bc13" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">循环函数看起来很庞大，但是大部分代码调试信息。</p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="c583" class="mf jq ht mb b fv mg mh l mi mj"><strong class="mb hu">void </strong>loop() {<br/><br/>    // Check WiFi connection and reconnect if needed<br/>    <strong class="mb hu">if </strong>(WiFi.status() != WL_CONNECTED){<br/>        WiFi.disconnect();<br/>        connectToWiFi();<br/>    }<br/><br/>    <strong class="mb hu">if </strong>(candiesToGive &gt; 0) {<br/>        <strong class="mb hu">if </strong>(myStepper.distanceToGo() == 0) {<br/>            candiesToGive--;<br/>            Serial.printf("[Candy was given, %d left]\n", candiesToGive);<br/>            myStepper.moveTo(myStepper.currentPosition() - stepsPerRevolution / 2);<br/>        }<br/>        myStepper.run();<br/>    } <strong class="mb hu">else </strong>{<br/>        // Client will make HTTP requests and get JSON response<br/>        WiFiClient client;<br/><br/>        Serial.printf("\n[Connecting to %s ... ", host);<br/>        <strong class="mb hu">if </strong>(client.connect(host, port)) {<br/>            Serial.println("connected]");<br/><br/>            Serial.println("[Sending a request]");<br/>            client.print(String("GET /addresses/balance/" + address) + " HTTP/1.1\r\n" +<br/>                         "Host: " + host + "\r\n" +<br/>                         "Connection: close\r\n" +<br/>                         "\r\n"<br/>            );<br/><br/>            Serial.println("[Response:]");<br/>            <strong class="mb hu">while </strong>(client.connected()) {<br/>                <strong class="mb hu">if </strong>(client.available()) {<br/>                    // Parse JSON<br/>                    JsonObject &amp;root = jsonBuffer.parse(client);<br/>                    <strong class="mb hu">if </strong>(root.containsKey(balanceJsonField)) {<br/>                        root.printTo(Serial);<br/>                        <strong class="mb hu">const unsigned long long </strong>newBalance = root[balanceJsonField];<br/>                        Serial.print("\nUpdated balance: ");<br/>                        printLLNumber(newBalance, 10);<br/>                        <strong class="mb hu">if </strong>(balance != -1) {<br/>                            <strong class="mb hu">int </strong>candies = (newBalance - balance) / price;<br/>                            candiesToGive += candies;<br/>                        }<br/>                        balance = newBalance;<br/>                    }<br/>                }<br/>            }<br/>            client.stop();<br/>            Serial.println("\n[Disconnected]");<br/>        } <strong class="mb hu">else </strong>{<br/>            Serial.println("connection failed!]");<br/>            client.stop();<br/>        }<br/>        // Wait for the 5 sec. before next check<br/>        delay(5000);<br/>    }<br/>}</span></pre><p id="1e98" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有两个函数，我们还没有定义，但它们被称为— <strong class="is hu"> <em class="mk">连接到WiFi </em> </strong>和<strong class="is hu"> <em class="mk">打印号码。</em> </strong> <em class="mk">第一个如果需要，每500 ms尝试连接到WiFi，第二个打印long long数字(默认不支持)。这里就不展示</em><strong class="is hu"><em class="mk">printl number</em></strong><em class="mk">函数的代码了，因为它脱离了我们的业务逻辑。</em></p><pre class="kt ku kv kw fq ma mb mc md aw me dt"><span id="0b05" class="mf jq ht mb b fv mg mh l mi mj"><strong class="mb hu">void </strong>connectToWiFi(){<br/>    Serial.printf("Connecting to %s ", ssid);<br/>    WiFi.begin(ssid, password);<br/><br/>    <strong class="mb hu">while </strong>(WiFi.status() != WL_CONNECTED) {<br/>        delay(500);<br/>        Serial.print(".");<br/>    }<br/>    Serial.println(" connected");<br/>}</span></pre><p id="6b02" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">完整的代码可以在Github上找到:</p><div class="ml mm fm fo mn mo"><a href="https://github.com/Tolsi/waves-arduino-candy-toy" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab ej"><div class="mq ab mr cl cj ms"><h2 class="bd hu fv z el mt eo ep mu er et hs dt translated">tolsi/waves-arduino-糖果-玩具</h2><div class="mv l"><h3 class="bd b fv z el mt eo ep mu er et ek translated">waves-arduino-candy-toy -在ESP8266 12e上使用waves区块链支付的arduino糖果玩具的源代码</h3></div><div class="mw l"><p class="bd b gc z el mt eo ep mu er et ek translated">github.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc ky mo"/></div></div></a></div><h2 id="bffc" class="mf jq ht bd jr nd ne nf jv ng nh ni jz jb nj nk kd jf nl nm kh jj nn no kl np dt translated">一起</h2><p id="724c" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">我们有工作代码和对模式的理解，让我们把它们放在Waves Blockchain和IoT之间的一个伟大的爱件中。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="fe ff nq"><img src="../Images/4f6dceac972b903b19b6d08d8217c900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zwp_kdNUr_BqqcUpztlZuQ.jpeg"/></div></div></figure><p id="f1ba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">唯一要补充的重要的东西——带地址的二维码。用户应该把他们的电波发送到那个地址。最后的观点是:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="fe ff ll"><img src="../Images/a31c379f482472b622d1d92fc821bd73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ug5H4CI9QfvhJWMk9tirHg.jpeg"/></div></div></figure><p id="54da" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">仅此而已！它工作，接受加密货币，并使用物联网来监控区块链和加工糖果。</p><p id="09a4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是它如何工作的演示:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="nr ns l"/></div></figure><h1 id="3fd5" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">结论</h1><p id="ea1c" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">区块链能给我们的生活带来巨大的改变，甚至像这样的小例子也能证明这一点。使用区块链作为支付方式，你可以在世界任何地方购买任何东西，不需要卡和现金，不需要货币兑换等等。</p><p id="605f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我认为在我们这个时代，随处都能买到糖果是非常重要的。</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="nt ns l"/></div></figure></div></div>    
</body>
</html>