<html>
<head>
<title>Deciphering Upgradeable Contracts: Understanding Upgradeable Smart Contracts from a Developer’s Perspective</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解密可升级合约:从开发人员的角度理解可升级智能合约</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/understanding-upgradeable-smart-contracts-from-a-developers-perspective-9469ce09680b?source=collection_archive---------0-----------------------#2020-10-15">https://medium.com/coinmonks/understanding-upgradeable-smart-contracts-from-a-developers-perspective-9469ce09680b?source=collection_archive---------0-----------------------#2020-10-15</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/d76e384311138a7f18ac5d3dd85cf5d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yEdiZWc0K1szXfnQ.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Source: Indorse</figcaption></figure><p id="7c49" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt kd translated">没有人能否认这样一个事实:有一些真正必要的特性使得智能合约非常可靠。</p><blockquote class="km"><p id="99e6" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">其中一个至关重要的特征就是它的<strong class="ak">不变性</strong>。</p></blockquote><p id="9edf" class="pw-post-body-paragraph jf jg ht jh b ji kw jk jl jm kx jo jp jq ky js jt ju kz jw jx jy la ka kb kc hm dt translated">一旦部署，没有人可以添加、修改或删除智能合同的任何部分，这一事实使得它非常安全和值得信赖。</p><p id="2038" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">虽然智能合约的这种不可改变的性质看起来是一种好处，但它也存在一些不容忽视的黑暗面。</p><h1 id="e17d" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">永恒性的丑恶嘴脸</h1><p id="da46" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">软件开发的世界强烈依赖于其升级代码的能力，从而在每个新版本中增强软件的性能。</p><p id="7685" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">嗯，一个典型的<strong class="jh hu">智能合同从不允许升级其代码</strong>。</p><p id="130b" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">这正是我们开始观察不可变智能合约的阴暗面的地方。</p><p id="a339" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因为不可否认的事实是，开发一个完全无Bug的代码是一个非常麻烦的任务，Smart contract的不可改变的本质使得它更糟糕，因为它不允许纠正错误。</p><blockquote class="me mf mg"><p id="b9dc" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu">对DeFi部门的最严重影响</strong> <br/>说实话，由于合同中无法纠正的小漏洞，加密世界已经见证了价值数百万的巨大损失。</p></blockquote><p id="6e1f" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">例如，2016年6月17日的<strong class="jh hu"/>见证了加密社区历史上最大的黑客攻击之一，即<strong class="jh hu">DAO Hack</strong>。<br/>总计<strong class="jh hu">360万乙醚(<em class="mh">【5000万美元</em> ) </strong>被黑客盗取。</p><h2 id="031f" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">这种攻击背后的原因是一个简单的<strong class="ak">重入</strong>错误，如果智能合同是可升级的，这个错误就可以解决。</h2><p id="5aed" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">因此，尽管智能合约的不可变性质使其可靠，但升级智能合约的能力也确保了最大的安全性。</p><p id="2416" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">这正是<strong class="jh hu">可升级智能合约</strong>的用武之地。</p><h1 id="6728" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">可升级合同到底是什么意思？</h1><p id="6bc5" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">现在很明显，智能合约是相当严格的。</p><p id="09b5" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">一旦部署，就没有办法改变智能协定，即使修改增强了代码。</p><p id="5fb3" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，这正是可升级智能合约要解决的问题。</p><blockquote class="km"><p id="7c70" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated"><strong class="ak"> <em class="mz">简单来说，可升级智能合约是在保留原始合约的状态、地址以及余额的同时，有效升级(修改)智能合约的过程。</em>T25】</strong></p></blockquote><p id="c433" class="pw-post-body-paragraph jf jg ht jh b ji kw jk jl jm kx jo jp jq ky js jt ju kz jw jx jy la ka kb kc hm dt translated">虽然这听起来很容易，但是开发可升级的合同是一个非常复杂的过程。</p><h2 id="a1e9" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">撰写可升级合同时的主要障碍</h2><p id="5bd9" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">一个典型的可升级契约无疑会在其开发过程中包含巨大的复杂性。</p><p id="0e8d" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">例如，即使是基本的可升级合同开发也需要:</p><ul class=""><li id="3862" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><strong class="jh hu">重新创建&amp;部署</strong>带有修改代码的现有合同的新版本。</li><li id="9845" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu">状态的手动迁移:</strong>开发人员必须手动将所有命令性状态从旧契约迁移到新契约。</li><li id="fad7" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu">处理未保存的合同地址:</strong>部署新合同将完全改变之前用于合同交互的合同地址。</li></ul><p id="9b93" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，这使整个场景变得非常复杂，因为我们需要更新所有的契约地址，以便使用新的契约来代替旧的契约。</p><p id="ba16" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">无可否认，上述程序根本不是一个有效的程序。</p><p id="43b4" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，社区已经见证了许多开发可升级智能合同的方法，如:</p><ul class=""><li id="3b39" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">分离逻辑和数据</em> </strong></li><li id="ea76" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">主从契约</em> </strong></li><li id="08be" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">可部分升级的智能合同系统。</em> </strong></li><li id="0d40" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">永久保管契约等。</em> </strong></li></ul><p id="8b46" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">然而，其中最有效的是<strong class="jh hu">代理合同方法</strong>。</p><h1 id="35ff" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">代理合同方法论的深入分析</h1><p id="c08e" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">在使用这种方法时，我们考虑了3个主要因素:</p><ul class=""><li id="39c2" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><strong class="jh hu">逻辑实现契约</strong> — <em class="mh">该契约负责所有的逻辑和工作机制。</em></li><li id="5d9a" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu">代理契约</strong> — <em class="mh">包含委托调用</em> <br/> <em class="mh">的功能，其主要功能是将调用委托给逻辑契约。</em></li><li id="956d" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu">密钥存储契约</strong> — <em class="mh">包含共享状态。最重要的是，这个契约必须由双方逻辑继承&amp;代理契约。</em></li></ul><h1 id="38a6" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">但是……什么是委托通话？</h1><p id="c046" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">委托调用实际上是代理契约方法的核心，因此是一个非常重要的概念。</p><blockquote class="me mf mg"><p id="f39b" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">委托调用是EVM提供的一个重要操作码，<strong class="jh hu"> <em class="ht">使我们能够在目标契约地址，但在调用契约的上下文中执行代码。</em> </strong></p></blockquote><p id="1699" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">让我们明白这一点。</p><h1 id="f3c9" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">用简单呼叫理解委托呼叫</h1><p id="3f1f" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated"><strong class="jh hu">在简单调用的情况下</strong></p><ul class=""><li id="2ba8" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated">当契约A( <em class="mh">调用方契约</em>)对B( <em class="mh">目标契约</em>)，<strong class="jh hu"> <em class="mh">进行简单调用时，代码实际上在B. </em> </strong>的上下文中执行</li></ul><h2 id="1692" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">这意味着使用了B的存储。</h2><ul class=""><li id="c4a9" class="na nb ht jh b ji lz jm ma jq no ju np jy nq kc nf ng nh ni dt translated">此外，契约B假设实际的调用者是契约A，而不是外部所有者帐户(<em class="mh">，尽管这根本不是真的</em>)。</li></ul><p id="e076" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">因此，简单调用不能保存消息发送者或消息值</strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nr"><img src="../Images/77f0add912f7ea40cdd5844bfc50ca55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xVPESJWyGRPNFkON.png"/></div></div></figure><p id="9d39" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">代表呼叫时</strong></p><ul class=""><li id="9fc1" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated">与简单调用不同，委托调用修改得更多，也更有效。</li><li id="d8a6" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated">当合同A委托呼叫联系人B时，<strong class="jh hu">T3代码在合同A(呼叫合同)而不是合同B(目标合同)的上下文中执行。 </strong></li></ul><h2 id="be51" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">这意味着使用了A的存储。</h2><ul class=""><li id="4d45" class="na nb ht jh b ji lz jm ma jq no ju np jy nq kc nf ng nh ni dt translated">此外，在委托调用中，msg.sender和msg.value被保留。</li><li id="4e3d" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated">例如，<em class="mh">在委托调用期间，契约B(目标契约)知道实际的调用方不是契约A(调用方契约)，而是外部拥有的帐户(msg.sender)。</em></li></ul><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nr"><img src="../Images/425b78c53992fde5cfc240381b414035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ALUrSTqw0DbPgiWB.png"/></div></div></figure><h1 id="b9db" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">工作机制一瞥</h1><p id="5ac2" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">也就是说，是时候探索代理契约方法如何使用委托调用并帮助我们开发可升级的智能契约了。</p><blockquote class="km"><p id="a59c" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">这种方法的有效性背后的一个最重要的原因是这样一个事实，即<strong class="ak"> <em class="mz">最终用户只需要与代理契约</em> </strong>进行交互。</p></blockquote><p id="3a05" class="pw-post-body-paragraph jf jg ht jh b ji kw jk jl jm kx jo jp jq ky js jt ju kz jw jx jy la ka kb kc hm dt translated">因为我们已经分离了逻辑契约，所以我们可以更改逻辑，同时为用户保持代理契约不变。</p><p id="59e7" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，<strong class="jh hu"> <em class="mh">此过程中的代理契约充当不可变存储，而逻辑契约将包括所有功能。</em>T15】</strong></p><p id="7fab" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，为了升级契约的逻辑，<strong class="jh hu">我们只需要让代理契约知道新委托契约的地址。</strong>因此，每当我们调用代理契约中的特定函数时，它只是委托调用逻辑契约(其中包含函数逻辑)。</p><h2 id="5dca" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">因此，每当我们调用代理契约中的特定函数时，它只是委托调用逻辑契约(包含函数逻辑)。</h2><p id="77ba" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">因此，使我们能够在与相同的旧代理契约交互时使用修改后的代码，同时完全保留契约的状态和地址。</p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nw"><img src="../Images/f1ef03ac7283ed0c31475f52a230d8a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GZoXWaqjtt7K1vDL.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Source: openzeppelin</figcaption></figure><blockquote class="km"><p id="3a6d" class="kn ko ht bd kp kq nx ny nz oa ob kc ek translated"><strong class="ak"> <em class="mz">代理契约和逻辑契约的存储结构，即状态变量的顺序必须相似。</em> </strong></p><p id="6cfe" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">这是代表电话最充分发挥作用的最迫切要求之一。</p></blockquote><p id="2109" class="pw-post-body-paragraph jf jg ht jh b ji kw jk jl jm kx jo jp jq ky js jt ju kz jw jx jy la ka kb kc hm dt translated">仔细观察可能会让我们认识到，即使我们选择了代理契约方法，开发可升级的智能契约也是一个非常麻烦的过程。</p><p id="52c5" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因为在开发可升级契约时有大量的细节需要考虑，所以每次从头开始编写契约无疑会导致我们不希望的结果。</p><p id="cc67" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><em class="mh">因此，非常需要为智能合约提供健壮、易用和有效的升级机制的工具或库。</em></p><p id="81d3" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">幸运的是，这些正是Openzeppelin升级CLI有效解决的问题。</p><h1 id="68fa" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">进入开放齐柏林飞船</h1><p id="66be" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">Openzepplin升级CLI已经完全消除了开发可升级合约所涉及的复杂性。</p><p id="ec20" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">让我们用openzepplin CLI写一个可升级的契约来理解它到底是如何工作的。</p><blockquote class="me mf mg"><p id="adf1" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="ht">注</em></strong><em class="ht">:</em>Openzeppelin CLI需求<strong class="jh hu"> Node.js </strong>进行开发。确保你已经预装了<em class="ht">。</em></p></blockquote><h1 id="d422" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">启动项目</h1><ol class=""><li id="9f00" class="na nb ht jh b ji lz jm ma jq no ju np jy nq kc oc ng nh ni dt translated">让我们从创建一个单独的文件夹开始。</li></ol><blockquote class="me mf mg"><p id="3323" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">$ <strong class="jh hu"> mkdir测试-可升级-合同&amp; &amp; cd测试-可升级-合同</strong></p></blockquote><p id="4145" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">进入文件夹后，创建一个npm包</p><blockquote class="me mf mg"><p id="5e34" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npm初始化-y </strong></p></blockquote><p id="6878" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，让我们安装Openzepplin CLI</p><blockquote class="me mf mg"><p id="9e6c" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">$<strong class="jh hu">NPM I @ open zeppelin/CLI</strong></p></blockquote><p id="43b5" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">由于整个过程将涉及创建、编译和部署智能合同，我们必须安装一个本地区块链。</p><p id="8caa" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">运行以下命令来安装它。</p><blockquote class="me mf mg"><p id="47b1" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">npm安装ganache-cli </p></blockquote><p id="c183" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">太好了！</p><p id="16ec" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在我们已经完成了安装，让我们启动一个CLI项目。<br/>运行以下命令。</p><blockquote class="me mf mg"><p id="69a0" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npx盎司初始</strong></p></blockquote><p id="e685" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">成功执行该命令后，您将:</p><p id="7cd3" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu"> network.js文件</strong></p><ul class=""><li id="4b44" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated">这是CLI存储网络配置的地方。</li></ul><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="656a" class="ml lc ht oe b fv oi oj l ok ol">module.exports = {<br/>  networks: {<br/>    development: {<br/>      protocol: 'http',<br/>      host: 'localhost',<br/>      port: 8545,<br/>      gas: 5000000,<br/>      gasPrice: 5e9,<br/>      networkId: '*',<br/>    },<br/>  },<br/>};</span></pre><p id="a9ab" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">。openzeppelin目录</strong></p><ul class=""><li id="7f3a" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated">这里存储了每个项目的相关细节。</li></ul><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="8769" class="ml lc ht oe b fv oi oj l ok ol">{<br/>  "manifestVersion": "2.2",<br/>  "contracts": {},<br/>  "dependencies": {},<br/>  "name": "test_upgrades",<br/>  "version": "1.0.0",<br/>  "compiler": {<br/>    "compilerSettings": {<br/>      "optimizer": {}<br/>    },<br/>    "typechain": {<br/>      "enabled": false<br/>    }<br/>  }<br/>}</span></pre><h1 id="bccd" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated"><strong class="ak">撰写和部署合同</strong></h1><p id="8476" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">现在我们已经准备好了工具，让我们写一个基本的契约。</p><p id="4f63" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">转到合同目录并创建一个实体文件。</p><blockquote class="me mf mg"><p id="938b" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"><em class="ht"/>美元cd合约</strong></p><p id="919a" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ touch Invest.sol </strong></p></blockquote><p id="6107" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">理解合同</strong> <br/>用更简单的话来说，这个合同允许用户在合同中投资ETH，并在他们希望的任何时候撤回它们。</p><p id="9e0e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">合同中的功能如下:</p><ul class=""><li id="659c" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><em class="mh">存储每个用户地址投资额的映射。</em></li><li id="4c03" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><em class="mh">一个</em> <strong class="jh hu"> <em class="mh">投资</em> </strong> <em class="mh">功能，让用户在合同中投资ETH。</em></li><li id="7ece" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">撤回</em> </strong> <em class="mh">允许特定用户撤回已投资的ETH并更新合同状态的功能。</em></li><li id="56bf" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"><em class="mh">getcontractballance</em></strong><em class="mh">返回合同的余额。</em></li><li id="e8a0" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"><em class="mh">【getuser balance】</em></strong><em class="mh">返回特定用户的余额。</em></li></ul><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="29a0" class="ml lc ht oe b fv oi oj l ok ol">pragma solidity ^0.5.0;</span><span id="24cb" class="ml lc ht oe b fv om oj l ok ol">contract Invest{</span><span id="ce97" class="ml lc ht oe b fv om oj l ok ol">  mapping (address =&gt; uint) public userBalances;</span><span id="8cd5" class="ml lc ht oe b fv om oj l ok ol">  function invest() public payable{<br/>    userBalances[msg.sender] = msg.value;<br/>  }</span><span id="1884" class="ml lc ht oe b fv om oj l ok ol">  function withdraw() public{<br/>    require (userBalances[msg.sender] != 0, "User doesn't have any balance");<br/>    address payable rec = msg.sender;<br/>    rec.transfer(userBalances[msg.sender]);<br/>    userBalances[msg.sender] = 0; <br/>  }<br/>  <br/>  function getContractBalance() public view returns(uint256){<br/>      return address(this).balance;<br/>  }</span><span id="0005" class="ml lc ht oe b fv om oj l ok ol">  function  getUserBalance(address _user) public view returns(uint256){<br/>    return _user.balance;<br/>  }<br/> }</span><span id="8744" class="ml lc ht oe b fv om oj l ok ol">}</span></pre><h2 id="a47f" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">部署合同</h2><p id="a8b2" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">在部署合同之前，我们必须确保本地区块链(<em class="mh"> Ganache-CLI </em>)正常运行。</p><p id="faf9" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">启动Ganache CLI </p><p id="78b1" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><em class="mh">转到一个新的终端，运行</em><strong class="jh hu"><em class="mh">ganache-CLI</em></strong><em class="mh">启动本地区块链</em></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff on"><img src="../Images/1aa285e59e43bf7f21e436854bf30d92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DAjDqE_686sL4Gh-.png"/></div></div></figure><h2 id="8599" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">现在Ganache正在监听<strong class="ak">端口8545 </strong>。</h2><p id="3957" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">一旦Openzeppelin CLI与ganache连接，我们就可以使用以下命令访问这10个帐户:</p><blockquote class="me mf mg"><p id="4f61" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npx盎司账户</strong></p></blockquote><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff oo"><img src="../Images/c7f188c49f4cecdbf1288904d96530bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4ZPLaMQMI_PgRdOG.png"/></div></div></figure></div><div class="ab cl op oq hb or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="hm hn ho hp hq"><p id="b82e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">让我们开始部署我们的合同吧。</strong></p><p id="ca82" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">为了部署计数器契约，请运行以下命令:</p><blockquote class="me mf mg"><p id="5c22" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npx盎司部署</strong></p></blockquote><p id="5892" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><em class="mh">这为您提供了几个选项来选择您想要的部署类型。</em></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ow"><img src="../Images/e2b94c507cca5bc8e3f51211e7d22981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Xh9Dr1652w9JRlJX.png"/></div></div></figure><p id="dbcb" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因为我们想要一份可升级的合同，所以选择<strong class="jh hu">可升级</strong>选项。</p><p id="231b" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">选择后，您的合同将被部署到本地区块链。</p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ox"><img src="../Images/f60b5c6aa103ebb737cabe6dfbcbab55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u75qR25Y3OCmzxTc.png"/></div></div></figure><p id="6788" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">该合同现已成功部署。</p><blockquote class="km"><p id="d677" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated"><em class="mz">合同地址</em>0x5a 35 a 10974d 37 b 63 CFC 01 F3 de 24785 ddbdd 10 a 10</p></blockquote><p id="2f17" class="pw-post-body-paragraph jf jg ht jh b ji kw jk jl jm kx jo jp jq ky js jt ju kz jw jx jy la ka kb kc hm dt translated">现在让我们与我们的合同进行交互。<br/> Openzeppelin让我们与合同的互动变得异常简单。</p><p id="4844" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">事实上，为了简化整个过程，他们把它分成两个必要的部分。</p><ul class=""><li id="3346" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">发送交易</em> </strong></li><li id="2809" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><strong class="jh hu"> <em class="mh">调用特定的组件来检查更新的变更</em> </strong></li></ul><blockquote class="me mf mg"><p id="9903" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="ht">注意:</em>为了与我们的合同进行交互，我们必须确保本地区块链已经在端口8545运行</strong></p></blockquote><p id="2862" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">合同初始状态</strong> <br/>在投资合同之前，我们先检查一下我们的合同初始状态。</p><p id="57f5" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="mh">用户余额</em> </strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff oy"><img src="../Images/ab986c0f01dc47d115686dbc2a4f9aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZquwmWiy7ES28RKX.png"/></div></div></figure><p id="e710" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">我们调用了<strong class="jh hu"> getUserBalance </strong>函数，<strong class="jh hu">显示用户有94 ETH。</strong></p><blockquote class="me mf mg"><p id="4e68" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">我们的所有10个帐户中，我们使用的第一个测试帐户的地址是<strong class="jh hu">0xa 463 ff 6 cc 6d 54 e a4 F3 B1 e 7 a5 C5 fa 58 c 52 f 3603</strong></p></blockquote><p id="c0dc" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">合同余额</strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff oz"><img src="../Images/f0c5f3b75de6df351e2c793c61c6e5bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Psev7Ki85psO6YSX.png"/></div></div></figure><p id="1ba4" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">由于还没有投资ETH，<strong class="jh hu">合同余额为0。</strong></p><p id="1412" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">让我们在合同中预付一些定金吧。</p><p id="720e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">发送事务</strong> <br/>为了发送事务，我们需要运行:</p><blockquote class="me mf mg"><p id="673f" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npx oz发送-发送</strong></p></blockquote><p id="4193" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">在我们的例子中，我们有两个主要功能:</p><ul class=""><li id="9d31" class="na nb ht jh b ji jj jm jn jq nc ju nd jy ne kc nf ng nh ni dt translated"><em class="mh">投资</em></li><li id="68a9" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><em class="mh">撤回</em></li></ul><p id="3dec" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">让我们先在合同中投入一些钱。</p><p id="0823" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">注意:</strong> <em class="mh">用Openzepplin CLI向契约发送Ether最初可能看起来有点复杂，但一旦理解就相当简单了。</em></p><p id="d35c" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">为了在契约中传递一些以太，我们需要运行命令:</p><blockquote class="me mf mg"><p id="f875" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu">$ npx oz send-tx—value&lt;value&gt;</strong></p><p id="5d08" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">这里的<strong class="jh hu">值</strong>是<strong class="jh hu">尾</strong>中将要转入合同的金额。</p></blockquote><p id="359e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在让我们调用<strong class="jh hu"> invest </strong>函数在契约中存放一些eth。</p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pa"><img src="../Images/4d5c95415d3fc90b01614b6c3860a05b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Doa8mMIGSgtJskGE.png"/></div></div></figure><p id="b580" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">于是我们用ganache的第一个测试账号调用了<strong class="jh hu"> <em class="mh"> 50000000000000魏</em> </strong>的意思是<strong class="jh hu"> <em class="mh"> 5乙醚</em> </strong>。</p><p id="60e1" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">一旦交易成功，我们就会收到交易散列。</p><p id="0f76" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">我们现在可以进一步检查ETH是否存在于合同中。</p><p id="872e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">检查合同余额</strong> <br/>为了检查余额，我们只需通过运行以下命令调用<strong class="jh hu"> getContractBalance </strong>函数:</p><blockquote class="me mf mg"><p id="0800" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="ht"> $ npx oz调用</em> </strong></p></blockquote><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pb"><img src="../Images/cee937690883dc5673f49e68676533b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6uZcP8PgBL-1_Igc.png"/></div></div></figure><p id="f203" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="mh">这样，我们就有5份乙醚存放在契约中。</em>T12】</strong></p><p id="a9f2" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">此外，用户余额也应该被扣除。让我们通过调用<strong class="jh hu"> getUserBalance来检查余额。</strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pc"><img src="../Images/4364d04fb17e0434ef2f8a1dde0cbd57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zQi0btK-URLVMFEP.png"/></div></div></figure><p id="01d8" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在的余额是94–5 = 89 ETH。</p><p id="b24c" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">撤销ETH </strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pd"><img src="../Images/19390b02bd8846349de096cfb4484ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*86Rz3ATq0HFkulVU.png"/></div></div></figure><p id="47d9" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">我们可以看到，一旦我们调用<strong class="jh hu">取款</strong>函数，<em class="mh">存入的eth被发送回用户的地址，合同余额回到0。</em></p><h1 id="e82d" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">让我们升级</h1><p id="e652" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">让我们通过修改或添加一些提款功能的规则来升级我们的合同。</p><p id="717e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">根据修改后的取款功能，<strong class="jh hu"> <em class="mh">用户只能在特定时间段后提取存入的ETH。</em> </strong></p><p id="fed8" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">让我们相应地修改合同。</p><p id="af4e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">修改后的合同</strong></p><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="bb95" class="ml lc ht oe b fv oi oj l ok ol">pragma solidity ^0.5.0;</span><span id="4900" class="ml lc ht oe b fv om oj l ok ol">contract Invest{</span><span id="397e" class="ml lc ht oe b fv om oj l ok ol">  mapping (address =&gt; uint) public userBalances;<br/>  mapping(address =&gt; uint) public lockTime;</span><span id="0b23" class="ml lc ht oe b fv om oj l ok ol">  function invest() public payable{<br/>    userBalances[msg.sender] = msg.value;<br/>    lockTime[msg.sender] = now + 1 weeks;<br/>  }<br/>  <br/>  <br/>  function withdraw() public{<br/>    require (now &gt; lockTime[msg.sender], "Deadline is not over yet");<br/>    require (userBalances[msg.sender] != 0, "User Doesn't have any balance");<br/>    address payable rec = msg.sender;<br/>    rec.transfer(userBalances[msg.sender]);<br/>    userBalances[msg.sender] = 0; <br/>  }<br/>  <br/>  function getContractBalance() public view returns(uint256){<br/>      return address(this).balance;<br/>  }</span><span id="4dbb" class="ml lc ht oe b fv om oj l ok ol">  function  getBalance(address _user) public view returns(uint256){<br/>    return _user.balance;<br/>  }<br/>  <br/> }</span><span id="b87d" class="ml lc ht oe b fv om oj l ok ol">}</span></pre><blockquote class="me mf mg"><p id="2bc5" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated">注意:上面的代码只是作为一个例子。</p><p id="d56b" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu">该代码不得用于生产</strong></p></blockquote><p id="a132" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">根据修改后的更改，我们添加了一个名为<strong class="jh hu"> lockTime的新映射。</strong></p><p id="6cc9" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu"> <em class="mh">该映射存储每个用户地址的截止日期，在该日期之后，用户将能够提取他们的余额。</em> </strong></p><p id="46d8" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">为了升级我们的合同，我们运行以下命令:</p><blockquote class="me mf mg"><p id="9e52" class="jf jg mh jh b ji jj jk jl jm jn jo jp mi jr js jt mj jv jw jx mk jz ka kb kc hm dt translated"><strong class="jh hu"> $ npx oz升级</strong></p></blockquote><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pe"><img src="../Images/85d983691c3af8e6b8f8a86aca9c15b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v9iKyjj35p7OBbzE.png"/></div></div></figure><p id="6d34" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">我们的合同经过所有必要的更改，现已成功升级。</p><p id="b215" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">必须注意的最重要的部分之一是,<strong class="jh hu"> <em class="mh">契约地址保持不变。</em> </strong></p><blockquote class="km"><p id="c1b0" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated"><em class="mz">升级后的合同地址:</em><strong class="ak"><em class="mz">0x5a 35 a 10974d 37 b 63 CFC 01 F3 de 24785 ddbdd 10 a 10</em></strong></p></blockquote><h1 id="1090" class="lb lc ht bd ld le lf lg lh li lj lk ll lm pf lo lp lq pg ls lt lu ph lw lx ly dt translated"><strong class="ak">测试升级后的合同</strong></h1><p id="9ff1" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">既然合约现在已经成功升级了，那我们就来看看它是否如预期的那样工作。</p><p id="3f3a" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">在合同中存款</strong></p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pi"><img src="../Images/8aa85848f9da4d9ccacda649e1bc7194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oOF3lfraTy5hp5hy.png"/></div></div></figure><p id="1e35" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">一旦交易被正确执行，我们可以看到5以太再次按照预期存入合同。</p><p id="c35c" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，让我们试着取出存款。</p><p id="f647" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">收回乙醚</strong> <br/>由于我们已经更新了<strong class="jh hu">收回</strong>功能，该功能不会像以前一样工作。</p><p id="0131" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">根据最新变更，<strong class="jh hu"> <em class="mh">存款金额只能在1周后提取。</em> </strong></p><p id="b58d" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，让我们检查一下该功能是否已经升级，并且按照我们的预期工作。</p><figure class="ns nt nu nv fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff pj"><img src="../Images/afdb7b4acaea8cd7c32c5e2e855e0de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YZji12zKVftOmIpu.png"/></div></div></figure><p id="e402" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">一旦我们在<strong class="jh hu">撤回</strong>功能上运行命令<strong class="jh hu"> npx oz send-tx </strong>，我们发现该功能执行失败(<em class="mh">如预期</em>)。</p><p id="27f2" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><em class="mh">因此，错误消息</em> <strong class="jh hu"> <em class="mh">“截止日期尚未结束”</em> </strong> <em class="mh">清楚地表明，我们已经成功地升级了我们的合同，进行了所需的更改，同时有效地保留了先前合同的状态和地址。</em></p><h1 id="fbe6" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">必须注意的必要细节</h1><p id="53db" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">尽管Openzepplin CLI简化了编写可升级智能合约的过程，但仍有一些不可忽视的关键细节。</p><p id="2982" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">虽然这些细节可能看起来是Openzepplin工具的局限性，但它们存在的实际原因在于以太坊虚拟机的内部工作机制。</p><h2 id="117c" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">可升级协定中没有构造函数</h2><p id="5ec6" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated"><em class="mh">可升级合同不能有</em> <strong class="jh hu">构造函数。</strong></p><p id="7237" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">然而，由于构造函数至关重要，openzeppelin可升级工具为我们提供了一个名为<strong class="jh hu"> Initializable </strong>的基础契约。</p><p id="ecfa" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu"><em class="mh"/></strong></p><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="b0a2" class="ml lc ht oe b fv oi oj l ok ol">pragma solidity &gt;=0.4.24 &lt;0.7.0;<br/>contract Initializable {<br/>  bool private initialized;<br/>  bool private initializing;</span><span id="ee6f" class="ml lc ht oe b fv om oj l ok ol">  modifier initializer() {<br/>    require(initializing || isConstructor() || !initialized, "Contract instance has already been initialized");</span><span id="824f" class="ml lc ht oe b fv om oj l ok ol">    bool isTopLevelCall = !initializing;<br/>    if (isTopLevelCall) {<br/>      initializing = true;<br/>      initialized = true;<br/>    }</span><span id="e28b" class="ml lc ht oe b fv om oj l ok ol">    _;</span><span id="05ac" class="ml lc ht oe b fv om oj l ok ol">    if (isTopLevelCall) {<br/>      initializing = false;<br/>    }<br/>  }</span><span id="770c" class="ml lc ht oe b fv om oj l ok ol">    address self = address(this);<br/>    uint256 cs;<br/>    assembly { cs := extcodesize(self) }<br/>    return cs == 0;<br/>  }<br/>  uint256[50] private ______gap;<br/>}</span></pre><p id="f707" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">可初始化的基契约有效地解决了这个构造函数问题。</p><p id="0daf" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">代替构造函数，我们只需要写一个<strong class="jh hu">初始化</strong>函数，它将作为构造函数(继承Initializable.sol契约后的<em class="mh">)。</em></p><p id="32d2" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">在部署可升级契约时，Openzepplin CLI将自动提示我们执行初始化函数。它还允许我们将参数(<em class="mh">如果有的话</em>)传递给<strong class="jh hu">初始化函数</strong>。</p><blockquote class="km"><p id="3ac3" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">使用构造函数时，必须确保构造函数只被调用一次。</p><p id="c1d1" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">因此，在这种情况下,“initializer()”修饰符会处理这个问题。确保构造函数在可升级契约中只被调用一次。</p></blockquote><h1 id="ff42" class="lb lc ht bd ld le lf lg lh li lj lk ll lm pf lo lp lq pg ls lt lu ph lw lx ly dt translated">用值初始化变量</h1><p id="4e5d" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">虽然Solidity允许我们用固定值初始化变量，但在可升级契约中不允许这样的任务。</p><p id="1065" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">例如:</p><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="1330" class="ml lc ht oe b fv oi oj l ok ol">pragma solidity ^0.5.0;</span><span id="b4f6" class="ml lc ht oe b fv om oj l ok ol">contract Counter {<br/>    //Such initializations aren't possible in Upgradable contracts.<br/>    uint256 public value = 1000;<br/></span><span id="a4f3" class="ml lc ht oe b fv om oj l ok ol">    function increase() public {<br/>      value += 1;<br/>    }<br/>}</span></pre><p id="9283" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">解决方案</strong> <br/>然而，对此的一个有效解决方案是初始化契约的<strong class="jh hu"> initialize()函数</strong> ( <em class="mh">构造函数</em>)内部的值。</p><pre class="ns nt nu nv fq od oe of og aw oh dt"><span id="8ff1" class="ml lc ht oe b fv oi oj l ok ol">pragma solidity ^0.5.0;</span><span id="63a5" class="ml lc ht oe b fv om oj l ok ol">import "@openzeppelin/upgrades/contracts/Initializable.sol";</span><span id="fefd" class="ml lc ht oe b fv om oj l ok ol">contract Counter {</span><span id="bddd" class="ml lc ht oe b fv om oj l ok ol">    uint256 public value;</span><span id="9e11" class="ml lc ht oe b fv om oj l ok ol">    function initialize() initializer public {<br/>       value = 1000;<br/>    }</span><span id="6bdb" class="ml lc ht oe b fv om oj l ok ol">    function increase() public {<br/>      value += 1;<br/>    }<br/>}</span></pre><h1 id="c695" class="lb lc ht bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">存储布局至关重要</h1><p id="47e7" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">如前所述，<strong class="jh hu"> <em class="mh">只有当我们确保两个合同具有相似的存储布局时，合同之间的委托调用才会有效。</em>T44】</strong></p><p id="419e" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，可升级合同的一个非常重要的事实是，在升级旧合同时，我们不允许对其存储布局进行任何细微的更改。</p><p id="11c9" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">这仅仅意味着在升级合同时，我们不能删除以前声明的状态变量或改变其类型。</p><p id="2b87" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated"><strong class="jh hu">如果我们想添加新的状态变量呢？</strong> <br/>根据规则，我们不能在旧的状态变量之前添加新的状态变量。</p><p id="f846" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">所有新的状态变量必须添加在先前声明的变量之后，以便<strong class="jh hu">存储布局</strong>不受干扰。</p><blockquote class="km"><p id="a5d7" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">因此，牢记这些必要的细节无疑会帮助我们写出更好、更有效的可升级智能合同。</p></blockquote></div><div class="ab cl op oq hb or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="hm hn ho hp hq"><h1 id="2be3" class="lb lc ht bd ld le pk lg lh li pl lk ll lm pm lo lp lq pn ls lt lu po lw lx ly dt translated">关于我自己</h1><h2 id="8287" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">我是谁？🙋🏻‍♂️</h2><p id="062c" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated">𝙃𝙞, 𝙄 𝙖𝙢 𝙕𝙖𝙧𝙮𝙖𝙗 👋🏻我是一名精通区块链和智能合同的工程师，我的愿景是用Web3去中心化和保护传统Web。主要从事智能合约工作，在开发和智能合约安全方面都有丰富的经验。</p><h2 id="3554" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">我做什么🧑🏼‍💻</h2><ul class=""><li id="08d2" class="na nb ht jh b ji lz jm ma jq no ju np jy nq kc nf ng nh ni dt translated">我撰写安全和优化的智能合同</li><li id="d014" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated">我对智能合同进行安全审计，并提高EVM连锁店智能合同的整体安全性</li><li id="14a8" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated">我撰写和谈论Web3和智能合约&amp;为扩展Web3的边界贡献我的一份力量。</li></ul><h2 id="8ffa" class="ml lc ht bd ld mm mn mo lh mp mq mr ll jq ms mt lp ju mu mv lt jy mw mx lx my dt translated">打声招呼，保持联系🤝</h2><p id="66b6" class="pw-post-body-paragraph jf jg ht jh b ji lz jk jl jm ma jo jp jq mb js jt ju mc jw jx jy md ka kb kc hm dt translated"><a class="ae pp" href="https://www.linkedin.com/in/zaryab-afser-97085b157/" rel="noopener ugc nofollow" target="_blank">领英</a>。| <a class="ae pp" href="https://twitter.com/zaryab_eth" rel="noopener ugc nofollow" target="_blank">推特</a>。| <a class="ae pp" href="https://github.com/zaryab2000" rel="noopener ugc nofollow" target="_blank"> Github </a>。| <a class="ae pp" href="https://zaryab2000.notion.site/Invite-me-to-your-Next-Web3-Event-78bcd204b866426687e1afbcdc61c5c7" rel="noopener ugc nofollow" target="_blank">邀请我参加Web3活动</a></p><blockquote class="km"><p id="da0a" class="kn ko ht bd kp kq kr ks kt ku kv kc ek translated">加入Coinmonks <a class="ae pp" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae pp" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="9922" class="lb lc ht bd ld le lf lg lh li lj lk ll lm pf lo lp lq pg ls lt lu ph lw lx ly dt translated">另外，阅读</h1><ul class=""><li id="bbbc" class="na nb ht jh b ji lz jm ma jq no ju np jy nq kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/what-are-decentralized-exchanges" rel="noopener ugc nofollow" target="_blank">分散交易所</a> | <a class="ae pp" href="https://coincodecap.com/bitbns-fip" rel="noopener ugc nofollow" target="_blank">比特FIP </a> | <a class="ae pp" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a></li><li id="bbe7" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/buy-crypto-with-credit-card" rel="noopener ugc nofollow" target="_blank">用信用卡购买密码的10个最佳地点</a></li><li id="591c" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/best-cardano-wallets" rel="noopener ugc nofollow" target="_blank">最好的卡达诺钱包</a> | <a class="ae pp" href="https://coincodecap.com/bingbon-copy-trading" rel="noopener ugc nofollow" target="_blank">冰棒副本交易</a></li><li id="a3b7" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/p2p-crypto-exchanges-in-india" rel="noopener ugc nofollow" target="_blank">印度最佳P2P加密交易所</a> | <a class="ae pp" href="https://coincodecap.com/baby-shiba-inu-wallets" rel="noopener ugc nofollow" target="_blank">柴犬钱包</a></li><li id="2e5f" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/crypto-affiliate-programs" rel="noopener ugc nofollow" target="_blank">8大加密联盟项目</a> | <a class="ae pp" href="https://coincodecap.com/etoro-vs-coinbase" rel="noopener ugc nofollow" target="_blank"> eToro vs比特币基地</a></li><li id="ada7" class="na nb ht jh b ji nj jm nk jq nl ju nm jy nn kc nf ng nh ni dt translated"><a class="ae pp" href="https://coincodecap.com/best-ethereum-wallets" rel="noopener ugc nofollow" target="_blank">最佳以太坊钱包</a> | <a class="ae pp" href="https://coincodecap.com/telegram-crypto-bots" rel="noopener ugc nofollow" target="_blank">电报上的加密货币机器人</a></li></ul></div></div>    
</body>
</html>