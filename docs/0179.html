<html>
<head>
<title>Maximizing CPU Resource Utilization on Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">最大化服务器上的CPU资源利用率</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/maximizing-cpu-resource-utilization-on-servers-fcbbb7908e1c?source=collection_archive---------2-----------------------#2018-03-22">https://medium.com/coinmonks/maximizing-cpu-resource-utilization-on-servers-fcbbb7908e1c?source=collection_archive---------2-----------------------#2018-03-22</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="7b08" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated"><em class="ji">通过使用主机托管技术，阿里巴巴将CPU资源利用率提高了30% </em></h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/20df58ba17588ea331f73b20a04badbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z9clVRCdyne4QAUqtx_neg.png"/></div></div></figure><p id="191d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">计算资源对于在线服务和离线批处理作业都至关重要。但是，在任何给定的时间里，都有数量惊人的资源处于闲置状态。根据Geithner和McKinsey的说法，全球服务器只使用了其CPU的6%到12%。对于阿里巴巴的在线服务，平均每天的利用率只有大约10%，直到技术团队推出了他们的主机托管解决方案来解决这个问题。</p><p id="5dd4" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">通过主机托管技术，阿里巴巴可以有效地利用那些以前未被充分利用的资源。这是通过利用在线服务和批处理作业的不同属性实现的。通过在其服务器上采用主机托管，阿里巴巴将其CPU利用率从10%提高到了40%，增幅高达30%。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff kr"><img src="../Images/2a622f25198dab5e3faab098f9cdb164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmwDcyqwYjAu0VR-wvMCRw.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Colocation boosts cluster resource usage by 30 percent</em></figcaption></figure><p id="6332" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">阿里巴巴在2014年首次开始研究在电子商务中大规模使用的主机托管技术。第一次大规模使用发生在2017年，当时双11全球购物节期间有20%的流量是使用该技术处理的。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff kw"><img src="../Images/1873b99bdd04669d8af2665aa7046cf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7NGUaXH-0dipqm8w8l3xyg.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Alibaba’s colocation technology: from research to implementation</em></figcaption></figure><h1 id="465c" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">通过主机托管提高CPU利用率</h1><p id="c841" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">主机代管通过将不同的任务类型调度到相同的物理资源来工作。这意味着组合集群并使用调度和资源隔离等控制方法来充分利用资源能力。阿里巴巴的主机托管技术在保护系统景观优化(SLO)的同时做到了这一点。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lu"><img src="../Images/ea2cbdb3dddae2dfa641be5b500fcf08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xkko49gnwJIpJ7SeS2NMLw.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Colocation technology and CPU resources</em></figcaption></figure><p id="5eb4" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">要符合托管资格，任务必须:</p><p id="a539" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">能够按优先级划分<br/> </strong>拥有不同的优先级很重要，这样高优先级任务就可以在必要的时候接管低优先级任务的资源。</p><p id="2a14" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">有互补的资源分配<br/> </strong>这意味着不同的任务类型在不同的时间需要不同数量的资源。</p><h1 id="09d0" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">适用于在线服务和批处理作业的托管</h1><p id="b054" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">通过利用在线服务和离线批处理作业各自不同的计算需求，可以有效地将主机托管应用于在线服务和离线批处理作业。</p><p id="a8af" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">“在线服务”</strong>泛指任何一种基于互联网的服务。对于阿里巴巴集团来说，这包括Alibaba.com、全球速卖通和天猫等在线平台，以及这些平台的在线活动，如促销活动。</p><p id="7728" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">在线服务在高峰时段需要大量资源——例如在阿里巴巴的双11全球购物节期间——但在这些时段之外需要的资源要少得多。这意味着在高峰期之外，大量资源可能会闲置。全局服务器只使用了其CPU的6%到12%。在线服务的使用在白天比在凌晨更高，并且在线服务必须不间断地继续。</p><p id="bf0b" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">“批处理作业”</strong>是数据分析等需要计算资源，但对延迟敏感度要求相对较低的任务。</p><p id="39b9" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">批处理作业会占用大量资源，尤其是CPU时间。批量作业的高峰时间是凌晨。</p><p id="3e66" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">因此，在线服务和批处理作业符合托管的资格标准:</p><p id="cc1b" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">在线服务的优先级高于批处理作业，因为它们必须不间断地持续运行。批处理作业优先级较低，因为它们对延迟不太敏感。</p><p id="9846" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">批处理作业的高峰时间是凌晨，而在线服务更有可能在一天中达到高峰，这使它们成为互补。</p><p id="00d0" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">理解主机托管如何更好地利用CPU资源进行在线服务和批处理作业的一个有用方法是使用沙子和石头的比喻。</p><p id="f051" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">在线服务资源需求可以比作装在容器中的石头。在高峰时间之外，在线服务只需要使用容器内的石头资源，而不需要使用石头之间的间隙。</p><p id="4b73" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">批处理作业需求可以比作填充容器中石头之间空隙的沙子。由于在线服务通常不需要使用这个空间，批处理作业可以填充这个空间。但是，当对在线服务的需求增加时，批处理作业将离开容器，因此在线服务可以使用额外的资源。这样，更高优先级的任务类型(在本例中为在线服务)可以不间断地继续。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lv"><img src="../Images/a94cdcbba2b42b6a943ce47a1ffafa38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZXW9i3KzqaMjmSsANqD1vA.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">When demand for online services is high, online services use more resources. The green “stones” represent online services while the blue “sand” represents batch jobs</em></figcaption></figure><h1 id="7787" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">计算主机托管的优势</h1><p id="0c00" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">主机托管节省的资源量是根据一个简单的公式计算的。</p><p id="a5cb" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">假设一个数据中心有“N”台服务器，利用率(“R”)从R1到R2递增。在不考虑任何其他限制的情况下，可以节省的服务器数量(“X”)计算如下:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lw"><img src="../Images/c776d9db1209ee7a7d569ed7576ea7a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ly-H_rE2nvF_o5mtDsxwgA.png"/></div></div></figure><p id="c8d9" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">因此，如果您有10万台服务器，并且您的资源使用率从28%增加到40%，您可以节省3万台服务器。换句话说，主机托管可以节省高达30%的资源。</p><p id="926d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">这一点在谷歌2015年发表的一篇题为“谷歌与博格的大规模集群管理”的论文中得到佐证。在本文中，谷歌描述了一个使用与阿里巴巴开发的主机托管解决方案类似的技术的解决方案，并指出他们使用该解决方案能够节省20%至30%的计算资源。</p><h1 id="daa1" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">协同定位调度架构</h1><p id="5651" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">下图显示了阿里巴巴的主机托管调度解决方案的架构。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff lx"><img src="../Images/441de4d452539b404d22d20af7214acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4vUik44V4TMcc1WdtTg-FA.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Colocation scheduling architecture</em></figcaption></figure><p id="bc6c" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">该解决方案的三个关键方面是两个自主运行的调度集群，以及在它们之间进行协调的Level0机制:</p><p id="940f" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">适马</strong>管理在线服务容器的调度。</p><p id="b049" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">福喜</strong>管理数据处理和批处理作业。</p><p id="22fa" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">第0级机制由第0级数据、第0级代理和第0级控制器组成，使SigmaMaster和FuxiMaster调度器能够协同工作。</p><h2 id="4caf" class="ly ky ht bd kz lz ma mb ld mc md me lh ke mf mg lj ki mh mi ll km mj mk ln ml dt translated">希腊字母表中第十八个字母</h2><p id="a9d1" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">适马管理在线服务容器的调度。它:</p><p id="484e" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">与Kubernetes API兼容。</p><p id="8bc6" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">使用阿里袋容器，符合OCI标准。</p><p id="8f1d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">已经被阿里巴巴大规模使用了好几年。阿里巴巴双11全球购物节期间也一直在使用。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mm"><img src="../Images/8fffcbb503e56decb7de9fe3f206c577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4BPvqDpRoN0FeCKspXdACQ.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Sigma architecture</em></figcaption></figure><h2 id="5778" class="ly ky ht bd kz lz ma mb ld mc md me lh ke mf mg lj ki mh mi ll km mj mk ln ml dt translated">伏羲</h2><p id="0f0e" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">福喜管理批量作业。它是:</p><p id="70ed" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">用于大量数据处理和复杂的大规模计算类型的应用。</p><p id="93b2" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">提供数据驱动的多级流水线并行计算框架，兼容MapReduce、Map-Reduce-Merge、Cascading、FlumeJava等编程模式。</p><p id="cda0" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">高度可扩展。它支持几十万级并行任务调度，并能根据数据分布优化网络开销。它自动检测故障和系统热点，重新启动失败的任务，并确保稳定可靠地完成操作。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mn"><img src="../Images/3ffd9253324ffec0ae397a972597d71a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WeaOW7Jt-pzGeZ3Z4WK_tA.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Fuxi architecture</em></figcaption></figure><h2 id="fb54" class="ly ky ht bd kz lz ma mb ld mc md me lh ke mf mg lj ki mh mi ll km mj mk ln ml dt translated">0级机制</h2><p id="d72e" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">下图所示的第0级机制协调和管理集群，以实现平稳运行。该机制管理:</p><p id="8514" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">共存集群</p><p id="b7cd" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">每个调度租户之间的资源匹配</p><p id="ccc5" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">日常使用和大规模促销期间使用的策略</p><p id="533d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">异常检测和处理</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mo"><img src="../Images/e54b871067e885d6fe4fd450b49744ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6S3O_A8m_3Br9WvxMM0Uzw.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Level0 mechanism</em></figcaption></figure><h1 id="b359" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">托管资源隔离</h1><p id="52a6" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">为了使主机托管有效工作，正确执行资源隔离是至关重要的。如果资源隔离不能有效进行，那么对资源的竞争就不能有效解决。</p><p id="a1f2" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">这可能会导致在线服务出现问题。在最好的情况下，这会损害用户体验的质量。在最坏的情况下，这可能意味着无法提供在线服务。</p><p id="4a58" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">可以采用以下两种方法来避免资源竞争问题:</p><p id="d030" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> 1。</strong> <strong class="jx hu">调度</strong></p><p id="b24d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> 2。</strong> <strong class="jx hu">内核隔离</strong></p><h2 id="1acc" class="ly ky ht bd kz lz ma mb ld mc md me lh ke mf mg lj ki mh mi ll km mj mk ln ml dt translated">行程安排</h2><p id="fd56" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">调度使用资源表示技术在资源竞争出现之前预测和计划资源需求。调度的目的是降低资源竞争发生的概率。调度可以不断优化。</p><p id="8e34" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">可以根据以下方法和注意事项来优化调度:</p><p id="6170" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">每日时分复用</strong></p><p id="b98d" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">推广时分复用</strong></p><p id="8486" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">无损降级</strong></p><p id="4dde" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">批处理作业</strong> <strong class="jx hu">选择</strong></p><p id="a8ac" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">动态记忆</strong></p><p id="c313" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">电脑存储分离</strong></p><p id="eaac" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">每日时分复用</strong></p><p id="50bc" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">对于在线服务和批处理作业，资源需求的高峰和低谷出现在一天的不同时间。因此，每天都可以使用时分复用来提高资源利用率。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mp"><img src="../Images/5c5ad85f4b55875d9676008b8174a1f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwzqKzzgXjjnqQ2m_Qoy4Q.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Peaks and troughs for online services and offline batch jobs</em></figcaption></figure><p id="e318" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">推广时分复用</strong></p><p id="6be6" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">电子商务业务涉及巨大的在线促销活动，如双11全球购物节。在大规模促销或压力测试期间，资源压力将比正常运营期间高出数倍。如果到那时，我们减少用于计算任务的资源，并将所有这些资源用于在线服务，那么我们就可以非常有效地应对短期的资源需求激增。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mq"><img src="../Images/ad59fb8021e925d4bf71c355c5d2a07a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QG-9fYbx_xW2BqTLRZ_EYw.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Allocation of colocation resources according to demand</em></figcaption></figure><p id="6c32" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">无损降级</strong></p><p id="f775" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">降级批处理作业时，应尽可能降低影响。对于无损降级，要注意降级方案。</p><p id="dfd4" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">因为在线服务通常不使用很多资源，所以添加70%的计算任务资源只需不到三分钟。这意味着在降级后的前五分钟，批处理作业对在线服务的影响不应太大。</p><p id="9d32" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">另一个问题是分钟级恢复。如果成功实现逐分钟恢复，那么只有在真正的峰值点才会有影响。由于峰值点周期很短，这种影响将被最小化。</p><blockquote class="mr"><p id="1ff8" class="ms mt ht bd mu mv mw mx my mz na kq ek translated"><a class="ae nb" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nd ne nf ng nh jo fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff nc"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure><p id="17b1" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">批量作业选择</strong></p><p id="f6cc" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">之前我们用沙子这个比喻来描述批处理作业。但是即使是沙粒的大小也不一样。为了确保资源的间隙被利用而不溢出，我们需要过滤和选择沙子。这可能意味着:</p><p id="9072" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">制作任务或工作的资源表示，并分析需要消耗的资源数量。</p><p id="6627" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">使用Level0获得主机的精确剩余计算资源容量。</p><p id="aee9" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">选择最符合条件且将减少资源竞争的任务或工作。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ni"><img src="../Images/02a3572e286e8d09385bba3bc02f9b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVBinqSeD3UzZqm-mwjAuA.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Computing task selection process</em></figcaption></figure><p id="fac8" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">动态记忆</strong></p><p id="11cb" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">由于以前的内存资源没有考虑托管，内存和CPU都是匹配在线服务的原始需求，没有任何多余的内存。</p><p id="935e" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">由于不断增长的需求，内存达到了一个瓶颈，静态分配内存不再足够。为了解决这个问题，引入了内部存储器的动态分配。这可能意味着:</p><p id="e9d8" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">计算任务使用的内存量的动态调整。</p><p id="f406" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">当在线服务压力增加时，通过迁移或终止任务自动调整批处理作业的内存使用。</p><p id="d255" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">如果整个单元内存不足(OOM ),则首先终止优先级较低的计算任务。</p><p id="4d85" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">电脑存储分离</strong></p><p id="c233" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">不同的存储解决方案用于在线服务和批处理作业:</p><p id="358e" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">在线服务优先考虑每秒输入/输出(IOPS)，但不使用大存储容量，因此使用小型SSD驱动器进行存储。</p><p id="3252" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">批处理作业优先考虑存储，而不是IOPS，因此大型硬盘驱动器用于存储。</p><p id="40f7" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">使用主机代管时，如果本地驱动器仍用于处理数据，但批处理作业混合在一起，那么调度就会变得非常复杂。为了解决这个问题，我们需要从本地驱动器中创建一个虚拟内存池。</p><p id="7c9e" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">这样我们就可以通过远程访问，根据需求访问不同的存储设备。</p><p id="2b4b" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">阿里巴巴也开始大规模建设25G网络容量。这将提高整体网络能力。它还将使远程访问变得和本地访问一样快。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nj"><img src="../Images/2d333e410d0b4c232fb1eea2cd6ff973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TJWy-N-07ubSqY5dZZsKHg.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">Computing and storage scheduling</em></figcaption></figure><h2 id="a651" class="ly ky ht bd kz lz ma mb ld mc md me lh ke mf mg lj ki mh mi ll km mj mk ln ml dt translated">内核隔离</h2><p id="92ac" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">如果发生资源竞争，可以使用任务优先级来决定如何防止对高优先级任务的影响，并最小化对低优先级任务的影响。这是在极端情况下采取的最后手段。</p><p id="4223" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">内核隔离可以根据以下方法和注意事项来实现:</p><p id="ea9f" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> CPU调度优化</strong></p><p id="ac02" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">记忆保护</strong></p><p id="ba36" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> IO等级约束</strong></p><p id="43c5" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">网络流量控制</strong></p><p id="8de7" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> CPU调度优化</strong></p><p id="3e95" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">这是最重要的内核隔离项。当CPU在线服务的压力增加时，批处理作业必须在毫秒内撤回。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nk"><img src="../Images/4f5c367b3c3d533bb6830468628694f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMWimN171s6k5CMYfgamqw.png"/></div></div><figcaption class="ks kt fg fe ff ku kv bd b be z ek"><em class="ji">As the red arrows show, when online services need more resources,</em> <em class="ji">batch jobs must immediately use less resources</em></figcaption></figure><p id="da29" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">CPU调度优化包括:</p><blockquote class="nl nm nn"><p id="75b1" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht"> </em> <strong class="jx hu"> <em class="ht"> CPU资源占用</em> </strong></p><p id="b97a" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht">这意味着根据CGroup分配优先级。高优先级任务可以占用低优先级任务的时隙。</em></p><p id="3b45" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht"> </em> <strong class="jx hu"> <em class="ht">【避免HT(噪点清除)</em> </strong></p><p id="26e2" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht">这意味着避免离线任务被调度到与在线任务相邻的HTs，并确保被调度到与在线任务相邻的HTs的离线任务在被唤醒后被移动。</em></p><p id="7e01" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht"> </em> <strong class="jx hu"> <em class="ht"> L3缓存隔离</em> </strong></p><p id="fd77" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht">使用BDW CPU特性的CAT进行缓存访问流量控制。通过这种方式，可以限制低优先级任务对CPU的使用。</em></p><p id="86dd" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht"> </em> <strong class="jx hu"> <em class="ht">内存带宽隔离</em> </strong></p><p id="696a" class="jv jw no jx b jy jz iu ka kb kc ix kd np kf kg kh nq kj kk kl nr kn ko kp kq hm dt translated"><em class="ht">内存带宽包括根据实时监控实施策略化调整，以及通过调整批处理作业的操作时隙长度来控制CFS带宽。给任务一个较短的时隙允许高优先级的批处理作业使用更多的CPU资源。</em></p></blockquote><p id="db07" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">记忆保护</strong></p><p id="68eb" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">试图通过内存恢复隔离来避免联机任务受到内存恢复的影响。</p><p id="a6c4" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">根据不同的组分配优先级，增加组内恢复机制，并根据优先级确定内存恢复的重要性。</p><p id="97a8" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">如果一个单位是OOM，从最低优先级开始杀死任务。</p><p id="e9f9" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu"> IO等级约束</strong></p><p id="a6bf" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">为文件级io带宽隔离(上层)添加了blkio控制器以及IOPS和每秒位数(BPS)限制。一旦超过低带宽阈值，文件级低带宽阈值(较低级别)允许使用剩余的可用带宽。元数据限制限制了特定的元数据操作，例如一次删除大量小文件。</p><p id="97cb" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated"><strong class="jx hu">网络流量控制</strong></p><p id="cd78" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">网络流量控制包括带宽隔离，带宽隔离包括本地带宽隔离和邮袋容器之间的带宽隔离。</p><p id="b653" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">它还包括带宽共享，分为黄金级、白银级和青铜级。共享带宽可以离线存在，带宽可以按优先级取。</p><h1 id="0214" class="kx ky ht bd kz la lb lc ld le lf lg lh iz li ja lj jc lk jd ll jf lm jg ln lo dt translated">结论</h1><p id="1370" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">经过四年的发展，2017年，colocation管理了阿里巴巴双11全球购物节20%的流量。在接下来的一年里，主机托管将继续发展。</p><p id="a0f3" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">协同定位将能够用于更多样化的应用，如实时计算、GPU或FPGA。从规模上看，托管也将增加。对于资源表示能力，将使用深度学习来提高预测准确率和利用率。</p><p id="8ab1" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt translated">优先级系统的优化将进一步提高调度能力。然后，将按优先级执行调度，而不是通过在线服务和批处理作业。将来，协同定位可以成为调度系统的通用功能。</p><p id="cd6b" class="pw-post-body-paragraph jv jw ht jx b jy jz iu ka kb kc ix kd ke kf kg kh ki kj kk kl km kn ko kp kq hm dt">(Original article by Lv Qi吕奇)</p></div><div class="ab cl ns nt hb nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="hm hn ho hp hq"><h1 id="f54a" class="kx ky ht bd kz la nz lc ld le oa lg lh iz ob ja lj jc oc jd ll jf od jg ln lo dt translated">阿里巴巴科技</h1><p id="01dc" class="pw-post-body-paragraph jv jw ht jx b jy lp iu ka kb lq ix kd ke lr kg kh ki ls kk kl km lt ko kp kq hm dt translated">关于阿里巴巴最新技术的第一手深入信息→在<strong class="jx hu">脸书</strong>上搜索<a class="ae nb" href="http://www.facebook.com/AlibabaTechnology" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hu">【阿里巴巴科技】</strong> </a></p></div></div>    
</body>
</html>