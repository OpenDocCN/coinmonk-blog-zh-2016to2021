<html>
<head>
<title>Making a URL shortener on Ethereum Blockchain ⛓</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在⛓区块链以太坊制作一个网址缩短器</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/making-a-url-shortener-on-ethereum-blockchain-5947e52fd3a3?source=collection_archive---------4-----------------------#2018-12-02">https://medium.com/coinmonks/making-a-url-shortener-on-ethereum-blockchain-5947e52fd3a3?source=collection_archive---------4-----------------------#2018-12-02</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="ff56" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">永远保存区块链的链接</h2></div><h2 id="51a4" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">该产品</h2><figure class="kg kh ki kj fq kk"><div class="bz el l di"><div class="kl km l"/></div></figure><h1 id="7d30" class="kn jj ht bd jk ko kp kq jo kr ks kt js iz ku ja jw jc kv jd ka jf kw jg ke kx dt translated">它是如何工作的</h1><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div class="fe ff ky"><img src="../Images/d0755379a713a54f9a10750aefffc28d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/1*e6uPKHACWbRzuaci0bxpXQ.gif"/></div></figure><p id="7883" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">部署在<a class="ae lu" href="https://0x.now.sh" rel="noopener ugc nofollow" target="_blank"> 0x.now.sh </a>的web app与部署在<a class="ae lu" href="https://ropsten.etherscan.io/address/0x4b8241f24537d2539d0b310bc074fd68a782e182" rel="noopener ugc nofollow" target="_blank">以太坊Ropsten testnet </a>上的智能合约进行交互。在testnet上意味着你可以用自由醚与它互动。点击获取您的<a class="ae lu" href="https://faucet.metamask.io" rel="noopener ugc nofollow" target="_blank">免费乙醚。</a></p><h2 id="f892" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">该过程</h2><ul class=""><li id="a828" class="lv lw ht ld b le lx lh ly jt lz jx ma kb mb lt mc md me mf dt translated">用户进行交易，请求区块链存储URL字符串。</li><li id="2b59" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">由于这是一项改变区块链现状的交易，因此需要附带一定数量的乙醚，以便矿工将其开采到区块链。</li><li id="445d" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">费用(也称为<a class="ae lu" href="https://www.cryptocompare.com/coins/guides/what-is-the-gas-in-ethereum/" rel="noopener ugc nofollow" target="_blank">气体</a>)的数量由Metamask chrome扩展决定，并显示在提示框中。</li><li id="cc2c" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">交易确认需要等待一段时间(5-10秒),具体取决于区块链的繁忙程度。</li><li id="50be" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">生成了缩短的URL。https://0x.now.sh/s?id=23</li><li id="b345" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">当用户点击缩短的URL时，进行另一个事务，请求区块链哪个URL字符串位于所提供的引用处(在这种情况下是23)</li><li id="b254" class="lv lw ht ld b le mg lh mh jt mi jx mj kb mk lt mc md me mf dt translated">因为这个交易没有改变区块链的状态，所以这次我们不需要支付任何ETH，用户被无缝地重定向到长URL。</li></ul><h2 id="0ddb" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">dApp</h2><p id="bdfd" class="pw-post-body-paragraph lb lc ht ld b le lx iu lg lh ly ix lj jt ml ll lm jx mm lo lp kb mn lr ls lt hm dt translated">作为一个分散的应用程序意味着这个web应用程序不需要任何集中的数据库来运行。它仅与部署在区块链上的智能合约进行交互。</p><h2 id="14c8" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">智能合同📃</h2><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="57c1" class="ji jj ht mp b fv mt mu l mv mw">pragma solidity ^0.4.24;</span><span id="23d7" class="ji jj ht mp b fv mx mu l mv mw">contract e0x {<br/> event Log(string message);<br/> event LinkAdded(uint linkId, string url);<br/> <br/> struct LinkTemplate {<br/>  address userAddress;<br/>  string url;<br/> }<br/> <br/> uint lastLinkId;<br/> mapping (uint =&gt; LinkTemplate) public linkMapping;<br/> <br/> constructor() public {<br/>  lastLinkId = 0;<br/> }<br/> <br/> <br/> function createNewLink(string url) public returns (uint) {<br/>     lastLinkId++;<br/>  linkMapping[lastLinkId] = LinkTemplate(msg.sender, url);<br/>  emit LinkAdded(lastLinkId, url);<br/>  return lastLinkId;<br/> }<br/> <br/> modifier linkExists(uint linkId) {<br/>     //link with the given hash does not exist<br/>  if(linkMapping[linkId].userAddress == 0x0000000000000000000000000000000000000000) {<br/>   revert();<br/>  }<br/>  _;<br/> }<br/> <br/> function getLink(uint linkId) linkExists(linkId) public constant<br/>  returns(<br/>   address,<br/>   string<br/>  ) {<br/>      LinkTemplate memory link = linkMapping[linkId];<br/>   return(<br/>    link.userAddress,<br/>       link.url<br/>   );<br/>  }</span><span id="923a" class="ji jj ht mp b fv mx mu l mv mw">}</span></pre></div><div class="ab cl my mz hb na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hm hn ho hp hq"><h1 id="0837" class="kn jj ht bd jk ko nf kq jo kr ng kt js iz nh ja jw jc ni jd ka jf nj jg ke kx dt translated">技术挑战</h1><h2 id="84c6" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">与智能合同交互</h2><p id="27c0" class="pw-post-body-paragraph lb lc ht ld b le lx iu lg lh ly ix lj jt ml ll lm jx mm lo lp kb mn lr ls lt hm dt translated">EthersJS库用于与区块链对话</p><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="e5e5" class="ji jj ht mp b fv mt mu l mv mw">// provider picks up the Metamask injected web3 object from browser <br/>let provider = new ethers.providers.Web3Provider(web3.currentProvider);<br/>let address = "ADDRESS_OF_DEPLOYED_SMART_CONTRACT";<br/>let abi = [...] //defines JSON interface for the smart contract</span></pre><h2 id="d796" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">在区块链上存储数据</h2><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="59c6" class="ji jj ht mp b fv mt mu l mv mw">// calling the createNewLink function defined in the smart contract<br/>tx = await contract.createNewLink(url);<br/>console.log(tx.hash);</span></pre><h2 id="53c1" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">收听区块链事件</h2><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="a0a6" class="ji jj ht mp b fv mt mu l mv mw">contract.on("LinkAdded", (linkId, linkUrl) =&gt; {<br/>        <br/>        var shortUrl = '{0}/s?id={1}'.f(window.location.origin, linkId.toNumber())<br/>        $("#info").prepend( "Short URL: &lt;a href='{0}'&gt;{0}&lt;/a&gt;&lt;br&gt;".f(shortUrl) );<br/>        <br/>    });</span></pre><h2 id="93de" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">正在生成最近缩短的URL列表</h2><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="fe ff nk"><img src="../Images/968c35c71a9238e315386d48fd02a198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uNfUXj3_USvLnvUAQjbrhQ.png"/></div></div></figure><p id="4c9e" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">EthersJS不支持事件批量监听，所以我必须使用web3js的allEvents()函数调用</p><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="34a1" class="ji jj ht mp b fv mt mu l mv mw">MyContract = web3.eth.contract(abi);<br/>    myContractInstance = MyContract.at(address);<br/>    events = myContractInstance.allEvents({event: 'LinkAdded', fromBlock: 0, toBlock: 'latest'});<br/>    events.watch(function(error, result){<br/>      console.log(result.args.url, result.args.linkId.toNumber());<br/>      ...<br/>});</span></pre><h2 id="58a2" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">使得缩短的URL在所有浏览器中都是可访问的</h2><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="fe ff np"><img src="../Images/e2a149f2ee564b8e8ece02147db383a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4E9XthrjTPB5oB_3360eUA.png"/></div></div></figure><p id="2d8b" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">这相当棘手，因为与区块链交互需要浏览器支持web3，并安装一些钱包(元掩码或类似的)。目前，web3和钱包支持仅适用于桌面版的Chrome和Firefox。</p><p id="0782" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">为了解决这个问题，我不得不创建一个钱包，如下所示</p><pre class="kg kh ki kj fq mo mp mq mr aw ms dt"><span id="193b" class="ji jj ht mp b fv mt mu l mv mw">provider = ethers.getDefaultProvider('ropsten');<br/>wallet = ethers.Wallet.createRandom();<br/>wallet = wallet.connect(provider);</span></pre><p id="5a72" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">向令人敬畏的<a class="ae lu" href="https://github.com/ethers-io/ethers.js/" rel="noopener ugc nofollow" target="_blank"> ethersJS库</a>大声疾呼，感谢它对此的支持。</p><h2 id="2234" class="ji jj ht bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">统计URL访问量</h2><p id="9903" class="pw-post-body-paragraph lb lc ht ld b le lx iu lg lh ly ix lj jt ml ll lm jx mm lo lp kb mn lr ls lt hm dt translated">使用这种浏览器的灵活性是有代价的。每次用户点击缩短的网址没有改变区块链的状态，因此不可能确定每个链接被点击了多少次。这个问题仍然没有解决。</p><p id="8ba8" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">该项目的完整源代码在<a class="ae lu" href="https://github.com/sauravtom/ethereum-url-shortener" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p><p id="8d91" class="pw-post-body-paragraph lb lc ht ld b le lf iu lg lh li ix lj jt lk ll lm jx ln lo lp kb lq lr ls lt hm dt translated">欢迎提取请求😁</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><a href="http://bit.ly/2G71Sp7"><div class="fe ff nq"><img src="../Images/449450761cd76f44f9ae574333f9e9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKX2mtg7p1lOs7JmosPLsA.png"/></div></a><figcaption class="nr ns fg fe ff nt nu bd b be z ek"><a class="ae lu" href="http://bit.ly/2G71Sp7" rel="noopener ugc nofollow" target="_blank"><strong class="bd nv">Click to read today’s top story</strong></a></figcaption></figure></div></div>    
</body>
</html>