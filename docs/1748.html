<html>
<head>
<title>Express Plasma MVP as Javascript — Simple Withdrawal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将血浆MVP表示为Javascript —简单撤回</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/express-plasma-mvp-as-javascript-simple-withdrawal-53f59bcced3?source=collection_archive---------2-----------------------#2018-11-02">https://medium.com/coinmonks/express-plasma-mvp-as-javascript-simple-withdrawal-53f59bcced3?source=collection_archive---------2-----------------------#2018-11-02</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="41cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了更好地理解我的研究，我将血浆MVP表示为Javascript。MVP是最小可行血浆，最初由Vbuterin 提出，旨在以非常简化的方式提供血浆的基本安全属性。</p><p id="7d67" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基于这一提议，<a class="ae jo" href="https://github.com/omisego/plasma-mvp" rel="noopener ugc nofollow" target="_blank"> OmiseGo实施了MVP </a>，用于旨在未来使用等离子体的研究。我主要以这个实现作为参考。实际上，等离子提案的<a class="ae jo" href="https://plasma.io/plasma.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a>仍然是高度概述，还没有提到具体实施。我还参考了弗罗施的youtube视频。这是一个很好的了解等离子概述的视频。如果你还没看，我强烈推荐你看。</p><p id="f565" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">GitHub:<a class="ae jo" href="https://github.com/tak1827/plasma-tx-flow/tree/simple-withdrawal" rel="noopener ugc nofollow" target="_blank">tak 1827/plasma-tx-flow</a></p><p id="4aef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请注意，OmiseGo-MVP与我的实现有2个不同之处。首先，出于简化的原因，我没有在子链中使用令牌。第二，某子连锁经营者以交易费作为激励。</p></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="590f" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">分成5个步骤</h2><p id="29fd" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hm dt translated">我把整个过程分成几个步骤。</p><ol class=""><li id="d387" class="kw kx ht is b it iu ix iy jb ky jf kz jj la jn lb lc ld le dt translated"><em class="lf">部署根链</em></li><li id="b18c" class="kw kx ht is b it lg ix lh jb li jf lj jj lk jn lb lc ld le dt translated"><em class="lf">操作创建子链</em></li><li id="b1c5" class="kw kx ht is b it lg ix lh jb li jf lj jj lk jn lb lc ld le dt translated"><em class="lf">将乙醚沉积到根链上</em></li><li id="0dac" class="kw kx ht is b it lg ix lh jb li jf lj jj lk jn lb lc ld le dt translated"><em class="lf">花费UTXO </em></li><li id="ea8c" class="kw kx ht is b it lg ix lh jb li jf lj jj lk jn lb lc ld le dt translated"><em class="lf">撤回UTXO </em></li></ol></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="cc61" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">1.部署根链</h2><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff ll"><img src="../Images/f719b3bfa822d4eb6e6a3835e31a7259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFsaEY4d3oA_tJfUFdsqyQ.png"/></div></div></figure><p id="fb85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">根chin是一个智能合同，因此它被部署到以太网。根链有5个主要功能。其中4个由Vbuterin定义为血浆的最小实现。请从<a class="ae jo" href="https://ethresear.ch/t/minimal-viable-plasma/426" rel="noopener ugc nofollow" target="_blank">这里的</a>检查各个功能的作用。(即使没有定义“finalizeExits ”,撤回资金也很重要)</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="0ca3" class="jw jx ht ly b fv mc md l me mf">operator.run(function() {</span><span id="04a8" class="jw jx ht ly b fv mg md l me mf">  // Rootchain<br/>  // This is smart contract deployed to Ether main net.<br/>  rootChain = new RootChain();<br/>});</span><span id="dbf0" class="jw jx ht ly b fv mg md l me mf">class RootChain {</span><span id="71b1" class="jw jx ht ly b fv mg md l me mf">  constructor() {<br/>    this.plasmaBlockHeaders = {}; // Child chain's block header.<br/>    this.exits = {}; // List of withdraw tx<br/>    this.value = 0; // Deposited ether<br/>    ...<br/>  }</span><span id="c990" class="jw jx ht ly b fv mg md l me mf">  submitBlock(root) { ... }</span><span id="4b70" class="jw jx ht ly b fv mg md l me mf">  deposit() { ... }</span><span id="609b" class="jw jx ht ly b fv mg md l me mf">  startExit(utxoPos, txBytes, proof, sigs) { ... }</span><span id="5987" class="jw jx ht ly b fv mg md l me mf">  challengeExit(<br/>    exitId, plasmaBlockNum, txindex, <br/>    oindex, tx, proof, confirmSig<br/>  ) { ... }</span><span id="f80c" class="jw jx ht ly b fv mg md l me mf">  finalizeExits() { ... }<br/>}</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="14b8" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">2.操作创建子链</h2><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mh"><img src="../Images/9ba7d30786b7006709418faba12a9e05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r65kZix3AtbxEZt7W9f-IA.png"/></div></div></figure><p id="86c1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">操作员创建仅由该操作员操作的子链，因此该链是授权证明(POA)链。此链信任操作员的参与者。</p><p id="2b55" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当然，如果经营者进行任何恶意行为，每个参与者都可以提取他们存放的资金，经营者将受到惩罚。</p><p id="dc3f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">根链有一个主要功能，即“添加块”。该函数将块添加到子链中。运营商的操作只是在这篇博文中添加了一个区块。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="f30e" class="jw jx ht ly b fv mc md l me mf">operator.run(function() {</span><span id="5894" class="jw jx ht ly b fv mg md l me mf">  // Create child chain specifying operator as myself<br/>  childChain = new ChildChain(this.address, rootChain);<br/>});</span><span id="ac07" class="jw jx ht ly b fv mg md l me mf">class ChildChain {</span><span id="2676" class="jw jx ht ly b fv mg md l me mf"> constructor(operator, rootChain) {<br/>    this.operator = operator;<br/>    this.rootChain = rootChain;<br/>    this.blocks = {}; // All blocks consisting child chain<br/>    ...<br/>  }</span><span id="6c78" class="jw jx ht ly b fv mg md l me mf">  addBlock(number, block, isDeposit) { ... }<br/>}</span></pre><p id="99ef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">本质上，血浆子链是一个树状结构。由于这种结构，等离子体链实现了极大的可扩展性。等离子可以非常快速和便宜地处理成千上万笔交易。但是树结构非常复杂，所以我将child chain描述为没有分支的单链。</p><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mi"><img src="../Images/927edaa10c532ece87f29ff15381873d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cp-IW8NmcN6Yoti88ziOYg.png"/></div></div></figure></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="c574" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">3.将乙醚沉积到根链上</h2><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mh"><img src="../Images/543eb3be609b3fdb8c9f58a272a75198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L92SHG_BjsMhm7Ory259RA.png"/></div></div></figure><p id="fa6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">首先，Sam构建了一个输出属于他自己的事务。数量为5乙醚。请注意，此事务将包含在子链中，以便Sam不会将此事务发送到根链。</p><p id="9e2c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">出于可伸缩性的原因，根链只保存子链的头。标题包含两个项目，它们是块内事务的merkle根和时间戳。</p><p id="cc48" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在存款情况下，包括一个事务，因此merkle根等于事务散列。</p><p id="03c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在Plasma中，像Ether这样的基金资产被存储为UTXO模型(未用事务输出模型)。这不同于以太坊主网络，在以太坊主网络中，资产被存储为状态模型。UTXO模型和比特币的闪电网一样。</p><p id="6570" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">UTXO表示为以下格式。</p><blockquote class="mj mk ml"><p id="120d" class="iq ir lf is b it iu iv iw ix iy iz ja mm jc jd je mn jg jh ji mo jk jl jm jn hm dt translated">块数* 1000000000 +交易指数* 10000 +产出指数</p></blockquote><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="dd49" class="jw jx ht ly b fv mc md l me mf">// Create transaction for child chain<br/>sam.withdraw(5);<br/>const tx1 = new Transaction(<br/>  0, 0, 0, // No input<br/>  0, 0, 0, // No input<br/>  sam.address, 5, // Send 5Ether to himself<br/>  0, 0,<br/>  null, null,// No signature<br/>  0.1 // Fee<br/>);</span><span id="e9dd" class="jw jx ht ly b fv mg md l me mf">sam.run(function() {<br/>  msg.value = tx1.amount1;</span><span id="6fbb" class="jw jx ht ly b fv mg md l me mf">  // Confirm deposite target block<br/>  const depositBlock = rootChain.deposit();</span><span id="d39a" class="jw jx ht ly b fv mg md l me mf">  // Utxo for sam<br/>  sam.utxos.push(encodeUtxoPos(depositBlock, 0, 0));<br/>});<br/></span><span id="27d1" class="jw jx ht ly b fv mg md l me mf">/************ Root Chian ************/</span><span id="5135" class="jw jx ht ly b fv mg md l me mf">deposit() {<br/>  ...</span><span id="d871" class="jw jx ht ly b fv mg md l me mf">  const tx = new Transaction(<br/>    ... msg.sender, msg.value, ...);</span><span id="f8ca" class="jw jx ht ly b fv mg md l me mf">  const root = tx.hash().toString('hex');<br/>  const timestamp = Math.floor((new Date()).getTime()/1000);<br/>  const depositBlock = this.getDepositBlock();</span><span id="1778" class="jw jx ht ly b fv mg md l me mf">  this.plasmaBlockHeaders[depositBlock.toString()] = <br/>    new PlasmaBlockHeader(root,timestamp);</span><span id="d5ab" class="jw jx ht ly b fv mg md l me mf">  ...</span><span id="992e" class="jw jx ht ly b fv mg md l me mf">  return depositBlock;<br/>}</span><span id="7be4" class="jw jx ht ly b fv mg md l me mf">class PlasmaBlockHeader {<br/>  constructor(root, timestamp) {<br/>    this.root = root;<br/>    this.timestamp = timestamp;<br/>  }<br/>}</span></pre><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mp"><img src="../Images/1a50a89d62a14895c3ac1a0f467a60cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NrpcGSbe35G1wELjRw7RqQ.png"/></div></div></figure><p id="52d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，子链的操作者立即创建一个块来反映来自Sam的存放乙醚。运营商在加块过程中收取费用作为奖励。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="42ff" class="jw jx ht ly b fv mc md l me mf">operator.run(function() {</span><span id="0ed1" class="jw jx ht ly b fv mg md l me mf">  // Tx1 is included this block<br/>  let block = new Block([tx1]);</span><span id="dc03" class="jw jx ht ly b fv mg md l me mf">  block.sign(operator.privateKey);<br/> <br/>  childChain.addBlock(childChain.getDepositBlock(), block, true);<br/>});<br/></span><span id="b520" class="jw jx ht ly b fv mg md l me mf">/************ Child Chian ************/</span><span id="81d9" class="jw jx ht ly b fv mg md l me mf">addBlock(number, block, isDeposit) {<br/>  ...</span><span id="caa2" class="jw jx ht ly b fv mg md l me mf">  // Collect fee as incentive for operator<br/>  this.accumulatedFee += this.collectFee(block.txs);</span><span id="289f" class="jw jx ht ly b fv mg md l me mf">  this.blocks[number] = block;<br/>  ...<br/>}</span><span id="1903" class="jw jx ht ly b fv mg md l me mf">class Block {<br/>  constructor(txs) {<br/>    this.txs = txs;<br/>    this.sig = null;<br/>  }<br/>}</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="199f" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">4.消费UTXO</h2><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mq"><img src="../Images/72d2d1c3ffded74b5f1e0373b444c671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GFQSRt68EpmqAU5_SGjoig.png"/></div></div></figure><p id="2c4e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Sam构建了一个输出属于Alice的事务。请注意，这个事务输入是Sam的UTXO。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="5291" class="jw jx ht ly b fv mc md l me mf">// Use utxo of sam as transaction input<br/>const sutxo = decodeUtxoPos(sam.utxos[0]);<br/>sam.utxos.shift();</span><span id="3cab" class="jw jx ht ly b fv mg md l me mf">let tx2 = new Transaction(<br/>  sutxo.blknum, sutxo.txindex, sutxo.oindex,<br/>  0, 0, 0,<br/>  alice.address, // To alice<br/>  tx1.amount1-tx1.fee, // Decrement amount by fee<br/>  0, 0,<br/>  null, null,<br/>  1<br/>);</span><span id="254d" class="jw jx ht ly b fv mg md l me mf">tx2.sign1(sam.privateKey);</span></pre><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mr"><img src="../Images/e1e38e3047b4c0fcf0b85d762a88356c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ypKHE6QmdDDh5OQKldnKZA.png"/></div></div></figure><p id="3f29" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，操作员将包含Sam事务的块添加到子链中。</p><p id="66ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">此时，Alice不能使用该事务的输出。因为这个事务还没有包含到根链中。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="6c93" class="jw jx ht ly b fv mc md l me mf">operator.run(function() {</span><span id="7bf9" class="jw jx ht ly b fv mg md l me mf">  sblock = new Block([tx2]); </span><span id="02f8" class="jw jx ht ly b fv mg md l me mf">  sblock.sign(operator.privateKey);</span><span id="5222" class="jw jx ht ly b fv mg md l me mf">  childChain.addBlock(childChain.nextChildBlock, sblock, false);<br/> <br/>});</span></pre><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff ms"><img src="../Images/8ce252d41970e833c4a5c5deeb5aedc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30aC5FxbN9xN9akLrNZAnw.png"/></div></div></figure><p id="b4fb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">操作员将块提交给根链。根哈希是根据块内部的事务计算的。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="f0e1" class="jw jx ht ly b fv mc md l me mf">// Merkle root<br/>const tx2root = sblock.merkle()[0][0];</span><span id="0cc7" class="jw jx ht ly b fv mg md l me mf">// Operator submit block to root chain<br/>operator.run(function() {<br/>  tx2blknum = rootChain.submitBlock(tx2root);<br/>});</span></pre><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mh"><img src="../Images/62a93edce9f7264fd842148b4d455545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktUI1l0VnV8Ff0szxSCO5g.png"/></div></div></figure><p id="ae20" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Sam注意到该事务包含在根链中。然后，他给爱丽丝发送确认签名。从现在起，爱丽丝可以使用收到的UTXO。需要这份确认签字来提取她资金。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="f8f0" class="jw jx ht ly b fv mc md l me mf">// Sam create confirmation sig<br/>// And send to Alice<br/>const confirmSigs = confirm(<br/>  tx2.hash().toString('hex'), <br/>  tx2root,<br/>  [sam.privateKey]<br/>);</span><span id="b6b3" class="jw jx ht ly b fv mg md l me mf">// Utxo for alice<br/>const tx2Index = 0;<br/>const tx2Pos = encodeUtxoPos(tx2blknum, tx2Index, 0);<br/>alice.utxos.push(tx2Pos);</span></pre></div><div class="ab cl jp jq hb jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hm hn ho hp hq"><h2 id="0f46" class="jw jx ht bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq dt translated">5.撤回UTXO</h2><figure class="lm ln lo lp fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff mt"><img src="../Images/53dbbc00479c84d6679394b3b2f0458c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tz608YWmMKnOFmbYsHtG2g.png"/></div></div></figure><p id="e6cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Alice构建“sig”来证明“utxoIncludedTx”由包含来自Sam的确认签名的发送者确认。她构建“证据”来证明“utxoIncludedTx”包含在根链中。</p><p id="58fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">她向根链发送退出事务。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="e950" class="jw jx ht ly b fv mc md l me mf">alice.run(function() {</span><span id="9b7f" class="jw jx ht ly b fv mg md l me mf">  // Build sigs to attest that tx is confirmed by sender<br/>  const sigs = { <br/>    sig1: tx2.sig1,<br/>    sig2: tx2.sig2,<br/>    confirmSig1: confirmSigs[0],// Confirm sig from Sam<br/>    confirmSig2: typeof confirmSigs[1] !== 'undefined' <br/>      ? confirmSigs[1] <br/>      : null<br/>  };</span><span id="430c" class="jw jx ht ly b fv mg md l me mf">  // Build proof to attest that tx is included in root chain<br/>  const levels = childChain.getBlock(tx2blknum).merkle();<br/>  const proof = createMembershipProof(levels, tx2Index);</span><span id="e395" class="jw jx ht ly b fv mg md l me mf">  // This transaction contain utxo for Alice<br/>  const utxoIncludedTx = tx2.encoded();</span><span id="621a" class="jw jx ht ly b fv mg md l me mf">  this.utxos.shift();<br/> <br/>  rootChain.startExit(tx2Pos, utxoIncludedTx, proof, sigs);</span><span id="a705" class="jw jx ht ly b fv mg md l me mf">});</span><span id="4d9e" class="jw jx ht ly b fv mg md l me mf">/************ Root Chian ************/</span><span id="9742" class="jw jx ht ly b fv mg md l me mf">startExit(utxoPos, txBytes, proof, sigs) {<br/>  ...</span><span id="989d" class="jw jx ht ly b fv mg md l me mf">  Assert(this.checkSigs(txHash, root, hasSig2, sigs), <br/>    "Signatures must match.");</span><span id="f6c9" class="jw jx ht ly b fv mg md l me mf">  Assert(checkMembership(root, txHash.toString('hex'), proof),<br/>    "Transaction Merkle proof is invalid.");<br/>  ...</span><span id="49b4" class="jw jx ht ly b fv mg md l me mf">  this.addExitToQueue(utxoPos, msg.sender, <br/>    amount1 + amount2 - fee, createdAt);<br/>}</span></pre><p id="bf81" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这种情况下，Alice不接收退出的UTXO。这个退出请求至少会被关注两周。在这2周内，有人会挑战这个出口。如果爱丽丝是恶意的，这个退出是欺诈，挑战者赢了，爱丽丝输了这个UTXO。</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="f72d" class="jw jx ht ly b fv mc md l me mf">addExitToQueue(utxoPos, exitor, amount, createdAt) {<br/>  ...</span><span id="0db8" class="jw jx ht ly b fv mg md l me mf">  // Exit request is locked at least for 2 week.<br/>  const exitableAt = Math.max(createdAt + w2, now + w1);</span><span id="6715" class="jw jx ht ly b fv mg md l me mf">  this.exits[utxoPos] = new Exit(exitor, amount, exitableAt);<br/>}</span></pre><p id="3095" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在退出时间锁定到期之后，如果Alice向根链发送退出完成事务，则她最终接收到UTXO。</p><p id="d098" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Alice收到3份乙醚(5份来自Sam，2份给操作员)</p><pre class="lm ln lo lp fq lx ly lz ma aw mb dt"><span id="03da" class="jw jx ht ly b fv mc md l me mf">alice.run(function() {<br/>   rootChain.finalizeExits();<br/>});</span><span id="548f" class="jw jx ht ly b fv mg md l me mf">/************ Root Chian ************/</span><span id="29e7" class="jw jx ht ly b fv mg md l me mf">finalizeExits() {<br/>  ...</span><span id="b1fa" class="jw jx ht ly b fv mg md l me mf">  // Alice receive Ether  <br/>  user.transfer(Number(this.exits[nexKey].amount));</span><span id="9395" class="jw jx ht ly b fv mg md l me mf">  // Decliment deposited ether<br/>  this.value -= exitAmount;<br/>  ...<br/>}</span></pre><blockquote class="mu"><p id="0efd" class="mv mw ht bd mx my mz na nb nc nd jn ek translated"><a class="ae jo" href="https://coincodecap.com/?utm_source=coinmonks" rel="noopener ugc nofollow" target="_blank">在您的收件箱中直接获得最佳软件交易</a></p></blockquote><figure class="nf ng nh ni nj lq fe ff paragraph-image"><a href="https://coincodecap.com/?utm_source=coinmonks"><div class="fe ff ne"><img src="../Images/7c0b3dfdcbfea594cc0ae7d4f9bf6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*OJ-qb5G6i863msBB.png"/></div></a></figure></div></div>    
</body>
</html>